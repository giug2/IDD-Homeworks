<!DOCTYPE html>
<html lang="en">
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<title>The Compressor-Retriever Architecture for Language Model OS</title>
<!--Generated on Mon Sep  2 23:25:23 2024 by LaTeXML (version 0.8.8) http://dlmf.nist.gov/LaTeXML/.-->
<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
<link href="/static/browse/0.3.4/css/ar5iv.0.7.9.min.css" rel="stylesheet" type="text/css"/>
<link href="/static/browse/0.3.4/css/ar5iv-fonts.0.7.9.min.css" rel="stylesheet" type="text/css"/>
<link href="/static/browse/0.3.4/css/latexml_styles.css" rel="stylesheet" type="text/css"/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.3/html2canvas.min.js"></script>
<script src="/static/browse/0.3.4/js/addons_new.js"></script>
<script src="/static/browse/0.3.4/js/feedbackOverlay.js"></script>
<base href="/html/2409.01495v1/"/></head>
<body>
<nav class="ltx_page_navbar">
<nav class="ltx_TOC">
<ol class="ltx_toclist">
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S1" title="In The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">1 </span>Introduction</span></a></li>
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S2" title="In The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">2 </span>Related Work</span></a></li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S3" title="In The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">3 </span>Method</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S3.SS1" title="In 3 Method ‣ The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">3.1 </span>Compressor</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S3.SS2" title="In 3 Method ‣ The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">3.2 </span>Retriever</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S4" title="In The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4 </span>Training, Inference, and Performance</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S4.SS1" title="In 4 Training, Inference, and Performance ‣ The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.1 </span>Training</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S4.SS2" title="In 4 Training, Inference, and Performance ‣ The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.2 </span>Inference</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S5" title="In The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5 </span>Experiments</span></a></li>
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S6" title="In The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">6 </span>Conclusion</span></a></li>
</ol></nav>
</nav>
<div class="ltx_page_main">
<div class="ltx_page_content">
<article class="ltx_document ltx_authors_1line">
<h1 class="ltx_title ltx_title_document">The Compressor-Retriever Architecture for Language Model OS</h1>
<div class="ltx_authors">
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname">Yuan Yang<sup class="ltx_sup" id="id1.1.id1">1,*</sup>, Siheng Xiong<sup class="ltx_sup" id="id2.2.id2">1</sup>, Ehsan Shareghi<sup class="ltx_sup" id="id3.3.id3">2</sup> &amp; Faramarz Fekri<sup class="ltx_sup" id="id4.4.id4">1</sup>
<br class="ltx_break"/><sup class="ltx_sup" id="id5.5.id5">1</sup>Georgia Institute of Technology,
<sup class="ltx_sup" id="id6.6.id6">2</sup>Monash University 
<br class="ltx_break"/><sup class="ltx_sup" id="id7.7.id7">*</sup><span class="ltx_text ltx_font_typewriter" id="id8.8.id8">mblackout@hotmail.com</span>
<br class="ltx_break"/><span class="ltx_text ltx_font_typewriter" id="id9.9.id9">{sxiong45@,faramarz.fekri@ece.}gatech.edu</span>
<br class="ltx_break"/><span class="ltx_text ltx_font_typewriter" id="id10.10.id10">ehsan.shareghi@monash.edu</span>
</span></span>
</div>
<div class="ltx_abstract">
<h6 class="ltx_title ltx_title_abstract">Abstract</h6>
<p class="ltx_p" id="id11.id1">Recent advancements in large language models (LLMs) have significantly enhanced their capacity to aggregate and process information across multiple modalities, enabling them to perform a wide range of tasks such as multimodal data querying, tool usage, web interactions, and handling long documents.
These capabilities pave the way for transforming LLMs from mere chatbots into general-purpose agents capable of interacting with the real world.
This paper explores the concept of using a language model as the core component of an operating system (OS), effectively acting as a CPU that processes data stored in a context window, which functions as RAM.
A key challenge in realizing such an LM OS is managing the life-long context and ensuring statefulness across sessions, a feature limited by the current session-based interaction paradigm due to context window size limit.
To address this, we introduce compressor-retriever, a model-agnostic architecture designed for life-long context management.
Unlike other long-context solutions such as retrieval-augmented generation, our approach exclusively uses the base model’s forward function to compress and retrieve context, ensuring end-to-end differentiability.
Preliminary experiments demonstrate the effectiveness of this architecture in in-context learning tasks, marking a step towards the development of a fully stateful LLM OS.
Project repo available at:
<a class="ltx_ref ltx_href" href="https://github.com/gblackout/LM-OS" title="">https://github.com/gblackout/LM-OS</a></p>
</div>
<section class="ltx_section" id="S1">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">1 </span>Introduction</h2>
<div class="ltx_para ltx_noindent" id="S1.p1">
<p class="ltx_p" id="S1.p1.1">LLMs demonstrate a strong capability as a central model that aggregates and processes information from different sources and modalities in a unified manner.
For example, it can answer questions over multimodal data <cite class="ltx_cite ltx_citemacro_citep">(Liu et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib15" title="">2024</a>; Li et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib14" title="">2023</a>)</cite>,
use tools <cite class="ltx_cite ltx_citemacro_citep">(Yang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib20" title="">2024</a>; Schick et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib19" title="">2024</a>; Yao et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib21" title="">2022</a>)</cite>,
use desktop apps and web <cite class="ltx_cite ltx_citemacro_citep">(Kapoor et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib13" title="">2024</a>; He et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib12" title="">2024</a>)</cite>,
answer questions over long documents <cite class="ltx_cite ltx_citemacro_citep">(Zhao et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib23" title="">2024</a>)</cite>.
These efforts have contributed to fundamentally transforming LLMs from merely a chatbot into a general-purpose agent that can interact with the real world and
helps users in different ways.</p>
</div>
<div class="ltx_para ltx_noindent" id="S1.p2">
<p class="ltx_p" id="S1.p2.1">Recently, these advances give rise to the idea<span class="ltx_note ltx_role_footnote" id="footnote1"><sup class="ltx_note_mark">1</sup><span class="ltx_note_outer"><span class="ltx_note_content"><sup class="ltx_note_mark">1</sup><span class="ltx_tag ltx_tag_note">1</span><a class="ltx_ref ltx_href" href="https://www.youtube.com/watch?v=zjkBMFhNj_g" title="">link</a></span></span></span> of making LLM an operating system (OS), where one uses the LLM as a CPU of the OS that digests data from RAM which is the context window, and calls functions which are the external tools.
However, to accomplish such goal, one needs to address several key challenges.
<span class="ltx_text ltx_font_bold" id="S1.p2.1.1">One of the most important features of an OS is that it is forever stateful</span>.
If permitted, it could store all data, software, and run logs, and can retrieve them when completing future tasks.
In comparison, so far, most of our interaction with LLMs is session-based and the LLMs are largely stateless across different sessions.</p>
</div>
<div class="ltx_para ltx_noindent" id="S1.p3">
<p class="ltx_p" id="S1.p3.1">This <span class="ltx_text ltx_font_italic" id="S1.p3.1.1">session-based paradigm</span> of interaction with LLMs results from several factors and one of them is the context window limit.
Recent LLMs are typically pre-trained with around 4K window size <cite class="ltx_cite ltx_citemacro_citep">(Dubey et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib7" title="">2024</a>)</cite> (or higher for some proprietary models), with potentially long context fine-tuning up to 32K or more.
In inference time, some can scale to millions of input tokens such as Gemini<span class="ltx_note ltx_role_footnote" id="footnote2"><sup class="ltx_note_mark">2</sup><span class="ltx_note_outer"><span class="ltx_note_content"><sup class="ltx_note_mark">2</sup><span class="ltx_tag ltx_tag_note">2</span>https://gemini.google.com/app</span></span></span>.
As large as it seems, it is still far from enough to digest context that could be fed to an OS for it to be meaningfully stateful:
A single HD image can take more than 1K tokens to represent;
one web search could return 10 web pages each with a few thousand tokens;
and a repo-level code can easily go up to thousands of lines.
While the session-based paradigm can already solve many problems, many daily tasks still require accessing long context.
To develop an LM OS that can assist with real-world tasks and stay stateful throughout the process, one must manage the context information in a life-long manner (Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S1.F1" title="Figure 1 ‣ 1 Introduction ‣ The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_tag">1</span></a>).
<span class="ltx_text ltx_font_bold" id="S1.p3.1.2">We believe the lack of a principled architecture for managing the life cycle of context is one of the main obstacles to shifting from the session-based paradigm to the OS paradigm</span>.</p>
</div>
<figure class="ltx_figure ltx_figure_panel ltx_align_center" id="S1.F1"><img alt="Refer to caption" class="ltx_graphics ltx_figure_panel ltx_img_landscape" height="319" id="S1.1.g1" src="x1.png" width="568"/>
<figcaption class="ltx_caption"><span class="ltx_tag ltx_tag_figure">Figure 1: </span>Building an LM OS requires a principled architecture to manage the life cycle of context.</figcaption>
</figure>
<div class="ltx_para ltx_noindent" id="S1.p4">
<p class="ltx_p" id="S1.p4.1">In this preliminary work, we propose a novel architecture for managing the life-long context, namely the compressor-retriever architecture.
We design this architecture so that it stays model-agnositic and imposes minimal changes to the base model structure.
And, different from existing solutions such as retrieval-augmented generation (RAG), this architecture does not introduce standalone modules and relies only on the base model’s forward function to compress and retrieve context, making the whole process end-to-end differentiable.
Specifically, the compressor builds a <span class="ltx_text ltx_font_italic" id="S1.p4.1.1">hierachical database</span> to store the chunked past context, where each chunk is represented by a coarse-to-fine memory hierarchy;
the retriever searches for relevant context with <span class="ltx_text ltx_font_italic" id="S1.p4.1.2">top-down sparse retrieval</span>, where it dynamically gathers context of different granularities with pure self-attention mechanism.
In our preliminary experiments, we validate this design in an in-context learning (ICL) reasoning task, where our model shows promising performance compared to the ideal setting.</p>
</div>
</section>
<section class="ltx_section" id="S2">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">2 </span>Related Work</h2>
<div class="ltx_para ltx_noindent" id="S2.p1">
<p class="ltx_p" id="S2.p1.1">While we draw our motivations from the LM OS, our work is also related to the long-context LLMs, where many efforts have been made to address the long-context challenge.
We categorize these works into two categories:</p>
</div>
<div class="ltx_para ltx_noindent" id="S2.p2">
<p class="ltx_p" id="S2.p2.1"><span class="ltx_text ltx_font_bold" id="S2.p2.1.1">Context compression</span>.
Context compression seeks to compress the context to reduce its size.
Some works focus on compressing the text explicitly into a condensed text; this includes Prompt-SAW <cite class="ltx_cite ltx_citemacro_citep">(Ali et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib1" title="">2024</a>)</cite>, LLMLingua <cite class="ltx_cite ltx_citemacro_citep">(Pan et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib16" title="">2024</a>)</cite>.
Other works involve compressing the context in latent space, and this typically involves introducing a recurrent processing scheme, where the LLM processes the segments by reusing the compressed embedding from the last forward. This includes Transformer-XL <cite class="ltx_cite ltx_citemacro_citep">(Dai et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib5" title="">2019</a>)</cite>, AutoCompressor <cite class="ltx_cite ltx_citemacro_citep">(Chevalier et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib3" title="">2023</a>)</cite>, ICAE <cite class="ltx_cite ltx_citemacro_citep">(Ge et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib9" title="">2023</a>)</cite>, and recurrent memory transformer <cite class="ltx_cite ltx_citemacro_citep">(Bulatov et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib2" title="">2022</a>)</cite>.
Our work is closely related to the latter, from which we draw the inspiration for our compressor module.
However, these works are designed to digest the long context of a single session, and they lack a principled way to manage the context and agent states across sessions in a life-long manner.</p>
</div>
<div class="ltx_para ltx_noindent" id="S2.p3">
<p class="ltx_p" id="S2.p3.1"><span class="ltx_text ltx_font_bold" id="S2.p3.1.1">Retrieval-augmented generation</span>.
RAG is a widely used alternative for long context inference: rather than altering the base LLMs, it introduces a small standalone model (that is the <span class="ltx_text ltx_font_italic" id="S2.p3.1.2">indexer</span>) that splits the long context, e.g., a set of documents, into chunks and generates a vector index for them. During inference, the indexer retrieves the context by matching the current context with those chunks in the database.
RAG provides a straightforward way to manage the context, where one can directly add, delete, or change documents.
However, the performance is bounded by the capacity of the indexer model which is typically small and cannot be optimized together with the base model.
More importantly, it does not provide a state-dependent way to compress and retrieve context in different granularities.</p>
</div>
</section>
<section class="ltx_section" id="S3">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">3 </span>Method</h2>
<div class="ltx_para ltx_noindent" id="S3.p1">
<p class="ltx_p" id="S3.p1.1">We propose a novel architecture that manages the life cycle of context in a principled manner.
A desired design should have the following properties:
(1) Handling infinite-length context;
(2) State- and task-dependent compression retrieval;
(3) End-to-end trainable without additional standalone modules.
The compressor-retriever architecture achieves the above by introducing two modules: compressor and retriever. Instead of introducing standalone adapters, we design modules to make extensive use of the base model’s forward as the building blocks.
The idea behind is that we believe the base models, through massive pertaining, have already acquired the capability of compressing and reconstructing information, which can be elicited with supervised fine-tuning on the base model.
The other benefit is that since we only use the forward function, our architecture can be readily applied to all decoder-only transformer models.
</p>
</div>
<figure class="ltx_figure ltx_figure_panel ltx_align_center" id="S3.F2"><img alt="Refer to caption" class="ltx_graphics ltx_figure_panel ltx_img_landscape" height="270" id="S3.1.g1" src="x2.png" width="598"/>
<figcaption class="ltx_caption"><span class="ltx_tag ltx_tag_figure">Figure 2: </span>Overview of compressor-retriever architecture.</figcaption>
</figure>
<section class="ltx_subsection" id="S3.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">3.1 </span>Compressor</h3>
<div class="ltx_para ltx_noindent" id="S3.SS1.p1">
<p class="ltx_p" id="S3.SS1.p1.7">Let <math alttext="f_{\text{llm}}" class="ltx_Math" display="inline" id="S3.SS1.p1.1.m1.1"><semantics id="S3.SS1.p1.1.m1.1a"><msub id="S3.SS1.p1.1.m1.1.1" xref="S3.SS1.p1.1.m1.1.1.cmml"><mi id="S3.SS1.p1.1.m1.1.1.2" xref="S3.SS1.p1.1.m1.1.1.2.cmml">f</mi><mtext id="S3.SS1.p1.1.m1.1.1.3" xref="S3.SS1.p1.1.m1.1.1.3a.cmml">llm</mtext></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.1.m1.1b"><apply id="S3.SS1.p1.1.m1.1.1.cmml" xref="S3.SS1.p1.1.m1.1.1"><csymbol cd="ambiguous" id="S3.SS1.p1.1.m1.1.1.1.cmml" xref="S3.SS1.p1.1.m1.1.1">subscript</csymbol><ci id="S3.SS1.p1.1.m1.1.1.2.cmml" xref="S3.SS1.p1.1.m1.1.1.2">𝑓</ci><ci id="S3.SS1.p1.1.m1.1.1.3a.cmml" xref="S3.SS1.p1.1.m1.1.1.3"><mtext id="S3.SS1.p1.1.m1.1.1.3.cmml" mathsize="70%" xref="S3.SS1.p1.1.m1.1.1.3">llm</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.1.m1.1c">f_{\text{llm}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.1.m1.1d">italic_f start_POSTSUBSCRIPT llm end_POSTSUBSCRIPT</annotation></semantics></math> be the base LLM model.
The forward function <math alttext="f_{\text{llm}}({\bm{x}})" class="ltx_Math" display="inline" id="S3.SS1.p1.2.m2.1"><semantics id="S3.SS1.p1.2.m2.1a"><mrow id="S3.SS1.p1.2.m2.1.2" xref="S3.SS1.p1.2.m2.1.2.cmml"><msub id="S3.SS1.p1.2.m2.1.2.2" xref="S3.SS1.p1.2.m2.1.2.2.cmml"><mi id="S3.SS1.p1.2.m2.1.2.2.2" xref="S3.SS1.p1.2.m2.1.2.2.2.cmml">f</mi><mtext id="S3.SS1.p1.2.m2.1.2.2.3" xref="S3.SS1.p1.2.m2.1.2.2.3a.cmml">llm</mtext></msub><mo id="S3.SS1.p1.2.m2.1.2.1" xref="S3.SS1.p1.2.m2.1.2.1.cmml">⁢</mo><mrow id="S3.SS1.p1.2.m2.1.2.3.2" xref="S3.SS1.p1.2.m2.1.2.cmml"><mo id="S3.SS1.p1.2.m2.1.2.3.2.1" stretchy="false" xref="S3.SS1.p1.2.m2.1.2.cmml">(</mo><mi id="S3.SS1.p1.2.m2.1.1" xref="S3.SS1.p1.2.m2.1.1.cmml">𝒙</mi><mo id="S3.SS1.p1.2.m2.1.2.3.2.2" stretchy="false" xref="S3.SS1.p1.2.m2.1.2.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.2.m2.1b"><apply id="S3.SS1.p1.2.m2.1.2.cmml" xref="S3.SS1.p1.2.m2.1.2"><times id="S3.SS1.p1.2.m2.1.2.1.cmml" xref="S3.SS1.p1.2.m2.1.2.1"></times><apply id="S3.SS1.p1.2.m2.1.2.2.cmml" xref="S3.SS1.p1.2.m2.1.2.2"><csymbol cd="ambiguous" id="S3.SS1.p1.2.m2.1.2.2.1.cmml" xref="S3.SS1.p1.2.m2.1.2.2">subscript</csymbol><ci id="S3.SS1.p1.2.m2.1.2.2.2.cmml" xref="S3.SS1.p1.2.m2.1.2.2.2">𝑓</ci><ci id="S3.SS1.p1.2.m2.1.2.2.3a.cmml" xref="S3.SS1.p1.2.m2.1.2.2.3"><mtext id="S3.SS1.p1.2.m2.1.2.2.3.cmml" mathsize="70%" xref="S3.SS1.p1.2.m2.1.2.2.3">llm</mtext></ci></apply><ci id="S3.SS1.p1.2.m2.1.1.cmml" xref="S3.SS1.p1.2.m2.1.1">𝒙</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.2.m2.1c">f_{\text{llm}}({\bm{x}})</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.2.m2.1d">italic_f start_POSTSUBSCRIPT llm end_POSTSUBSCRIPT ( bold_italic_x )</annotation></semantics></math> maps an input embedding sequence <math alttext="{\bm{x}}\in{\mathbb{R}}^{n\times d}" class="ltx_Math" display="inline" id="S3.SS1.p1.3.m3.1"><semantics id="S3.SS1.p1.3.m3.1a"><mrow id="S3.SS1.p1.3.m3.1.1" xref="S3.SS1.p1.3.m3.1.1.cmml"><mi id="S3.SS1.p1.3.m3.1.1.2" xref="S3.SS1.p1.3.m3.1.1.2.cmml">𝒙</mi><mo id="S3.SS1.p1.3.m3.1.1.1" xref="S3.SS1.p1.3.m3.1.1.1.cmml">∈</mo><msup id="S3.SS1.p1.3.m3.1.1.3" xref="S3.SS1.p1.3.m3.1.1.3.cmml"><mi id="S3.SS1.p1.3.m3.1.1.3.2" xref="S3.SS1.p1.3.m3.1.1.3.2.cmml">ℝ</mi><mrow id="S3.SS1.p1.3.m3.1.1.3.3" xref="S3.SS1.p1.3.m3.1.1.3.3.cmml"><mi id="S3.SS1.p1.3.m3.1.1.3.3.2" xref="S3.SS1.p1.3.m3.1.1.3.3.2.cmml">n</mi><mo id="S3.SS1.p1.3.m3.1.1.3.3.1" lspace="0.222em" rspace="0.222em" xref="S3.SS1.p1.3.m3.1.1.3.3.1.cmml">×</mo><mi id="S3.SS1.p1.3.m3.1.1.3.3.3" xref="S3.SS1.p1.3.m3.1.1.3.3.3.cmml">d</mi></mrow></msup></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.3.m3.1b"><apply id="S3.SS1.p1.3.m3.1.1.cmml" xref="S3.SS1.p1.3.m3.1.1"><in id="S3.SS1.p1.3.m3.1.1.1.cmml" xref="S3.SS1.p1.3.m3.1.1.1"></in><ci id="S3.SS1.p1.3.m3.1.1.2.cmml" xref="S3.SS1.p1.3.m3.1.1.2">𝒙</ci><apply id="S3.SS1.p1.3.m3.1.1.3.cmml" xref="S3.SS1.p1.3.m3.1.1.3"><csymbol cd="ambiguous" id="S3.SS1.p1.3.m3.1.1.3.1.cmml" xref="S3.SS1.p1.3.m3.1.1.3">superscript</csymbol><ci id="S3.SS1.p1.3.m3.1.1.3.2.cmml" xref="S3.SS1.p1.3.m3.1.1.3.2">ℝ</ci><apply id="S3.SS1.p1.3.m3.1.1.3.3.cmml" xref="S3.SS1.p1.3.m3.1.1.3.3"><times id="S3.SS1.p1.3.m3.1.1.3.3.1.cmml" xref="S3.SS1.p1.3.m3.1.1.3.3.1"></times><ci id="S3.SS1.p1.3.m3.1.1.3.3.2.cmml" xref="S3.SS1.p1.3.m3.1.1.3.3.2">𝑛</ci><ci id="S3.SS1.p1.3.m3.1.1.3.3.3.cmml" xref="S3.SS1.p1.3.m3.1.1.3.3.3">𝑑</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.3.m3.1c">{\bm{x}}\in{\mathbb{R}}^{n\times d}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.3.m3.1d">bold_italic_x ∈ blackboard_R start_POSTSUPERSCRIPT italic_n × italic_d end_POSTSUPERSCRIPT</annotation></semantics></math> (<math alttext="n" class="ltx_Math" display="inline" id="S3.SS1.p1.4.m4.1"><semantics id="S3.SS1.p1.4.m4.1a"><mi id="S3.SS1.p1.4.m4.1.1" xref="S3.SS1.p1.4.m4.1.1.cmml">n</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.4.m4.1b"><ci id="S3.SS1.p1.4.m4.1.1.cmml" xref="S3.SS1.p1.4.m4.1.1">𝑛</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.4.m4.1c">n</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.4.m4.1d">italic_n</annotation></semantics></math> tokens, latent dimension of <math alttext="d" class="ltx_Math" display="inline" id="S3.SS1.p1.5.m5.1"><semantics id="S3.SS1.p1.5.m5.1a"><mi id="S3.SS1.p1.5.m5.1.1" xref="S3.SS1.p1.5.m5.1.1.cmml">d</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.5.m5.1b"><ci id="S3.SS1.p1.5.m5.1.1.cmml" xref="S3.SS1.p1.5.m5.1.1">𝑑</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.5.m5.1c">d</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.5.m5.1d">italic_d</annotation></semantics></math>) to the output embedding of the same size <math alttext="{\bm{h}}\in{\mathbb{R}}^{n\times d}" class="ltx_Math" display="inline" id="S3.SS1.p1.6.m6.1"><semantics id="S3.SS1.p1.6.m6.1a"><mrow id="S3.SS1.p1.6.m6.1.1" xref="S3.SS1.p1.6.m6.1.1.cmml"><mi id="S3.SS1.p1.6.m6.1.1.2" xref="S3.SS1.p1.6.m6.1.1.2.cmml">𝒉</mi><mo id="S3.SS1.p1.6.m6.1.1.1" xref="S3.SS1.p1.6.m6.1.1.1.cmml">∈</mo><msup id="S3.SS1.p1.6.m6.1.1.3" xref="S3.SS1.p1.6.m6.1.1.3.cmml"><mi id="S3.SS1.p1.6.m6.1.1.3.2" xref="S3.SS1.p1.6.m6.1.1.3.2.cmml">ℝ</mi><mrow id="S3.SS1.p1.6.m6.1.1.3.3" xref="S3.SS1.p1.6.m6.1.1.3.3.cmml"><mi id="S3.SS1.p1.6.m6.1.1.3.3.2" xref="S3.SS1.p1.6.m6.1.1.3.3.2.cmml">n</mi><mo id="S3.SS1.p1.6.m6.1.1.3.3.1" lspace="0.222em" rspace="0.222em" xref="S3.SS1.p1.6.m6.1.1.3.3.1.cmml">×</mo><mi id="S3.SS1.p1.6.m6.1.1.3.3.3" xref="S3.SS1.p1.6.m6.1.1.3.3.3.cmml">d</mi></mrow></msup></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.6.m6.1b"><apply id="S3.SS1.p1.6.m6.1.1.cmml" xref="S3.SS1.p1.6.m6.1.1"><in id="S3.SS1.p1.6.m6.1.1.1.cmml" xref="S3.SS1.p1.6.m6.1.1.1"></in><ci id="S3.SS1.p1.6.m6.1.1.2.cmml" xref="S3.SS1.p1.6.m6.1.1.2">𝒉</ci><apply id="S3.SS1.p1.6.m6.1.1.3.cmml" xref="S3.SS1.p1.6.m6.1.1.3"><csymbol cd="ambiguous" id="S3.SS1.p1.6.m6.1.1.3.1.cmml" xref="S3.SS1.p1.6.m6.1.1.3">superscript</csymbol><ci id="S3.SS1.p1.6.m6.1.1.3.2.cmml" xref="S3.SS1.p1.6.m6.1.1.3.2">ℝ</ci><apply id="S3.SS1.p1.6.m6.1.1.3.3.cmml" xref="S3.SS1.p1.6.m6.1.1.3.3"><times id="S3.SS1.p1.6.m6.1.1.3.3.1.cmml" xref="S3.SS1.p1.6.m6.1.1.3.3.1"></times><ci id="S3.SS1.p1.6.m6.1.1.3.3.2.cmml" xref="S3.SS1.p1.6.m6.1.1.3.3.2">𝑛</ci><ci id="S3.SS1.p1.6.m6.1.1.3.3.3.cmml" xref="S3.SS1.p1.6.m6.1.1.3.3.3">𝑑</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.6.m6.1c">{\bm{h}}\in{\mathbb{R}}^{n\times d}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.6.m6.1d">bold_italic_h ∈ blackboard_R start_POSTSUPERSCRIPT italic_n × italic_d end_POSTSUPERSCRIPT</annotation></semantics></math>, where <math alttext="{\bm{h}}" class="ltx_Math" display="inline" id="S3.SS1.p1.7.m7.1"><semantics id="S3.SS1.p1.7.m7.1a"><mi id="S3.SS1.p1.7.m7.1.1" xref="S3.SS1.p1.7.m7.1.1.cmml">𝒉</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.7.m7.1b"><ci id="S3.SS1.p1.7.m7.1.1.cmml" xref="S3.SS1.p1.7.m7.1.1">𝒉</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.7.m7.1c">{\bm{h}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.7.m7.1d">bold_italic_h</annotation></semantics></math> is the last hidden states.</p>
</div>
<div class="ltx_para ltx_noindent" id="S3.SS1.p2">
<p class="ltx_p" id="S3.SS1.p2.1">The compressor module compresses the given context into a set of latent embeddings by appending the special <math alttext="m=``\texttt{&lt;mem&gt;}\text{''}" class="ltx_Math" display="inline" id="S3.SS1.p2.1.m1.1"><semantics id="S3.SS1.p2.1.m1.1a"><mrow id="S3.SS1.p2.1.m1.1.1" xref="S3.SS1.p2.1.m1.1.1.cmml"><mi id="S3.SS1.p2.1.m1.1.1.2" xref="S3.SS1.p2.1.m1.1.1.2.cmml">m</mi><mo id="S3.SS1.p2.1.m1.1.1.1" xref="S3.SS1.p2.1.m1.1.1.1.cmml">=</mo><mrow id="S3.SS1.p2.1.m1.1.1.3" xref="S3.SS1.p2.1.m1.1.1.3.cmml"><mi id="S3.SS1.p2.1.m1.1.1.3.2" mathvariant="normal" xref="S3.SS1.p2.1.m1.1.1.3.2.cmml">`</mi><mo id="S3.SS1.p2.1.m1.1.1.3.1" xref="S3.SS1.p2.1.m1.1.1.3.1.cmml">⁢</mo><mi id="S3.SS1.p2.1.m1.1.1.3.3" mathvariant="normal" xref="S3.SS1.p2.1.m1.1.1.3.3.cmml">`</mi><mo id="S3.SS1.p2.1.m1.1.1.3.1a" xref="S3.SS1.p2.1.m1.1.1.3.1.cmml">⁢</mo><mrow id="S3.SS1.p2.1.m1.1.1.3.4" xref="S3.SS1.p2.1.m1.1.1.3.4c.cmml"><mtext class="ltx_mathvariant_monospace" id="S3.SS1.p2.1.m1.1.1.3.4a" xref="S3.SS1.p2.1.m1.1.1.3.4c.cmml">&lt;mem&gt;</mtext><mtext id="S3.SS1.p2.1.m1.1.1.3.4b" xref="S3.SS1.p2.1.m1.1.1.3.4c.cmml">”</mtext></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.1.m1.1b"><apply id="S3.SS1.p2.1.m1.1.1.cmml" xref="S3.SS1.p2.1.m1.1.1"><eq id="S3.SS1.p2.1.m1.1.1.1.cmml" xref="S3.SS1.p2.1.m1.1.1.1"></eq><ci id="S3.SS1.p2.1.m1.1.1.2.cmml" xref="S3.SS1.p2.1.m1.1.1.2">𝑚</ci><apply id="S3.SS1.p2.1.m1.1.1.3.cmml" xref="S3.SS1.p2.1.m1.1.1.3"><times id="S3.SS1.p2.1.m1.1.1.3.1.cmml" xref="S3.SS1.p2.1.m1.1.1.3.1"></times><ci id="S3.SS1.p2.1.m1.1.1.3.2.cmml" xref="S3.SS1.p2.1.m1.1.1.3.2">`</ci><ci id="S3.SS1.p2.1.m1.1.1.3.3.cmml" xref="S3.SS1.p2.1.m1.1.1.3.3">`</ci><ci id="S3.SS1.p2.1.m1.1.1.3.4c.cmml" xref="S3.SS1.p2.1.m1.1.1.3.4"><mrow id="S3.SS1.p2.1.m1.1.1.3.4.cmml" xref="S3.SS1.p2.1.m1.1.1.3.4"><mtext class="ltx_mathvariant_monospace" id="S3.SS1.p2.1.m1.1.1.3.4a.cmml" xref="S3.SS1.p2.1.m1.1.1.3.4">&lt;mem&gt;</mtext><mtext id="S3.SS1.p2.1.m1.1.1.3.4b.cmml" xref="S3.SS1.p2.1.m1.1.1.3.4">”</mtext></mrow></ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.1.m1.1c">m=``\texttt{&lt;mem&gt;}\text{''}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.1.m1.1d">italic_m = ` ` typewriter_&lt;mem&gt; ”</annotation></semantics></math> token to the context and obtaining the corresponding hidden states after a forward pass:</p>
<table class="ltx_equation ltx_eqn_table" id="S3.Ex1">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="[\ \_\ ,\tilde{{\bm{m}}}]\leftarrow f_{\text{llm}}([{\bm{x}},{\bm{m}}],M)." class="ltx_Math" display="block" id="S3.Ex1.m1.6"><semantics id="S3.Ex1.m1.6a"><mrow id="S3.Ex1.m1.6.6.1" xref="S3.Ex1.m1.6.6.1.1.cmml"><mrow id="S3.Ex1.m1.6.6.1.1" xref="S3.Ex1.m1.6.6.1.1.cmml"><mrow id="S3.Ex1.m1.6.6.1.1.3.2" xref="S3.Ex1.m1.6.6.1.1.3.1.cmml"><mo id="S3.Ex1.m1.6.6.1.1.3.2.1" rspace="0.500em" stretchy="false" xref="S3.Ex1.m1.6.6.1.1.3.1.cmml">[</mo><mi id="S3.Ex1.m1.1.1" mathvariant="normal" xref="S3.Ex1.m1.1.1.cmml">_</mi><mo id="S3.Ex1.m1.6.6.1.1.3.2.2" lspace="0.500em" xref="S3.Ex1.m1.6.6.1.1.3.1.cmml">,</mo><mover accent="true" id="S3.Ex1.m1.2.2" xref="S3.Ex1.m1.2.2.cmml"><mi id="S3.Ex1.m1.2.2.2" xref="S3.Ex1.m1.2.2.2.cmml">𝒎</mi><mo id="S3.Ex1.m1.2.2.1" xref="S3.Ex1.m1.2.2.1.cmml">~</mo></mover><mo id="S3.Ex1.m1.6.6.1.1.3.2.3" stretchy="false" xref="S3.Ex1.m1.6.6.1.1.3.1.cmml">]</mo></mrow><mo id="S3.Ex1.m1.6.6.1.1.2" stretchy="false" xref="S3.Ex1.m1.6.6.1.1.2.cmml">←</mo><mrow id="S3.Ex1.m1.6.6.1.1.1" xref="S3.Ex1.m1.6.6.1.1.1.cmml"><msub id="S3.Ex1.m1.6.6.1.1.1.3" xref="S3.Ex1.m1.6.6.1.1.1.3.cmml"><mi id="S3.Ex1.m1.6.6.1.1.1.3.2" xref="S3.Ex1.m1.6.6.1.1.1.3.2.cmml">f</mi><mtext id="S3.Ex1.m1.6.6.1.1.1.3.3" xref="S3.Ex1.m1.6.6.1.1.1.3.3a.cmml">llm</mtext></msub><mo id="S3.Ex1.m1.6.6.1.1.1.2" xref="S3.Ex1.m1.6.6.1.1.1.2.cmml">⁢</mo><mrow id="S3.Ex1.m1.6.6.1.1.1.1.1" xref="S3.Ex1.m1.6.6.1.1.1.1.2.cmml"><mo id="S3.Ex1.m1.6.6.1.1.1.1.1.2" stretchy="false" xref="S3.Ex1.m1.6.6.1.1.1.1.2.cmml">(</mo><mrow id="S3.Ex1.m1.6.6.1.1.1.1.1.1.2" xref="S3.Ex1.m1.6.6.1.1.1.1.1.1.1.cmml"><mo id="S3.Ex1.m1.6.6.1.1.1.1.1.1.2.1" stretchy="false" xref="S3.Ex1.m1.6.6.1.1.1.1.1.1.1.cmml">[</mo><mi id="S3.Ex1.m1.3.3" xref="S3.Ex1.m1.3.3.cmml">𝒙</mi><mo id="S3.Ex1.m1.6.6.1.1.1.1.1.1.2.2" xref="S3.Ex1.m1.6.6.1.1.1.1.1.1.1.cmml">,</mo><mi id="S3.Ex1.m1.4.4" xref="S3.Ex1.m1.4.4.cmml">𝒎</mi><mo id="S3.Ex1.m1.6.6.1.1.1.1.1.1.2.3" stretchy="false" xref="S3.Ex1.m1.6.6.1.1.1.1.1.1.1.cmml">]</mo></mrow><mo id="S3.Ex1.m1.6.6.1.1.1.1.1.3" xref="S3.Ex1.m1.6.6.1.1.1.1.2.cmml">,</mo><mi id="S3.Ex1.m1.5.5" xref="S3.Ex1.m1.5.5.cmml">M</mi><mo id="S3.Ex1.m1.6.6.1.1.1.1.1.4" stretchy="false" xref="S3.Ex1.m1.6.6.1.1.1.1.2.cmml">)</mo></mrow></mrow></mrow><mo id="S3.Ex1.m1.6.6.1.2" lspace="0em" xref="S3.Ex1.m1.6.6.1.1.cmml">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.Ex1.m1.6b"><apply id="S3.Ex1.m1.6.6.1.1.cmml" xref="S3.Ex1.m1.6.6.1"><ci id="S3.Ex1.m1.6.6.1.1.2.cmml" xref="S3.Ex1.m1.6.6.1.1.2">←</ci><interval closure="closed" id="S3.Ex1.m1.6.6.1.1.3.1.cmml" xref="S3.Ex1.m1.6.6.1.1.3.2"><ci id="S3.Ex1.m1.1.1.cmml" xref="S3.Ex1.m1.1.1">_</ci><apply id="S3.Ex1.m1.2.2.cmml" xref="S3.Ex1.m1.2.2"><ci id="S3.Ex1.m1.2.2.1.cmml" xref="S3.Ex1.m1.2.2.1">~</ci><ci id="S3.Ex1.m1.2.2.2.cmml" xref="S3.Ex1.m1.2.2.2">𝒎</ci></apply></interval><apply id="S3.Ex1.m1.6.6.1.1.1.cmml" xref="S3.Ex1.m1.6.6.1.1.1"><times id="S3.Ex1.m1.6.6.1.1.1.2.cmml" xref="S3.Ex1.m1.6.6.1.1.1.2"></times><apply id="S3.Ex1.m1.6.6.1.1.1.3.cmml" xref="S3.Ex1.m1.6.6.1.1.1.3"><csymbol cd="ambiguous" id="S3.Ex1.m1.6.6.1.1.1.3.1.cmml" xref="S3.Ex1.m1.6.6.1.1.1.3">subscript</csymbol><ci id="S3.Ex1.m1.6.6.1.1.1.3.2.cmml" xref="S3.Ex1.m1.6.6.1.1.1.3.2">𝑓</ci><ci id="S3.Ex1.m1.6.6.1.1.1.3.3a.cmml" xref="S3.Ex1.m1.6.6.1.1.1.3.3"><mtext id="S3.Ex1.m1.6.6.1.1.1.3.3.cmml" mathsize="70%" xref="S3.Ex1.m1.6.6.1.1.1.3.3">llm</mtext></ci></apply><interval closure="open" id="S3.Ex1.m1.6.6.1.1.1.1.2.cmml" xref="S3.Ex1.m1.6.6.1.1.1.1.1"><interval closure="closed" id="S3.Ex1.m1.6.6.1.1.1.1.1.1.1.cmml" xref="S3.Ex1.m1.6.6.1.1.1.1.1.1.2"><ci id="S3.Ex1.m1.3.3.cmml" xref="S3.Ex1.m1.3.3">𝒙</ci><ci id="S3.Ex1.m1.4.4.cmml" xref="S3.Ex1.m1.4.4">𝒎</ci></interval><ci id="S3.Ex1.m1.5.5.cmml" xref="S3.Ex1.m1.5.5">𝑀</ci></interval></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.Ex1.m1.6c">[\ \_\ ,\tilde{{\bm{m}}}]\leftarrow f_{\text{llm}}([{\bm{x}},{\bm{m}}],M).</annotation><annotation encoding="application/x-llamapun" id="S3.Ex1.m1.6d">[ _ , over~ start_ARG bold_italic_m end_ARG ] ← italic_f start_POSTSUBSCRIPT llm end_POSTSUBSCRIPT ( [ bold_italic_x , bold_italic_m ] , italic_M ) .</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S3.SS1.p2.9">Let <math alttext="k" class="ltx_Math" display="inline" id="S3.SS1.p2.2.m1.1"><semantics id="S3.SS1.p2.2.m1.1a"><mi id="S3.SS1.p2.2.m1.1.1" xref="S3.SS1.p2.2.m1.1.1.cmml">k</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.2.m1.1b"><ci id="S3.SS1.p2.2.m1.1.1.cmml" xref="S3.SS1.p2.2.m1.1.1">𝑘</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.2.m1.1c">k</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.2.m1.1d">italic_k</annotation></semantics></math> be the compression factor,
<math alttext="{\bm{m}}=[m_{1},m_{2},...]" class="ltx_Math" display="inline" id="S3.SS1.p2.3.m2.3"><semantics id="S3.SS1.p2.3.m2.3a"><mrow id="S3.SS1.p2.3.m2.3.3" xref="S3.SS1.p2.3.m2.3.3.cmml"><mi id="S3.SS1.p2.3.m2.3.3.4" xref="S3.SS1.p2.3.m2.3.3.4.cmml">𝒎</mi><mo id="S3.SS1.p2.3.m2.3.3.3" xref="S3.SS1.p2.3.m2.3.3.3.cmml">=</mo><mrow id="S3.SS1.p2.3.m2.3.3.2.2" xref="S3.SS1.p2.3.m2.3.3.2.3.cmml"><mo id="S3.SS1.p2.3.m2.3.3.2.2.3" stretchy="false" xref="S3.SS1.p2.3.m2.3.3.2.3.cmml">[</mo><msub id="S3.SS1.p2.3.m2.2.2.1.1.1" xref="S3.SS1.p2.3.m2.2.2.1.1.1.cmml"><mi id="S3.SS1.p2.3.m2.2.2.1.1.1.2" xref="S3.SS1.p2.3.m2.2.2.1.1.1.2.cmml">m</mi><mn id="S3.SS1.p2.3.m2.2.2.1.1.1.3" xref="S3.SS1.p2.3.m2.2.2.1.1.1.3.cmml">1</mn></msub><mo id="S3.SS1.p2.3.m2.3.3.2.2.4" xref="S3.SS1.p2.3.m2.3.3.2.3.cmml">,</mo><msub id="S3.SS1.p2.3.m2.3.3.2.2.2" xref="S3.SS1.p2.3.m2.3.3.2.2.2.cmml"><mi id="S3.SS1.p2.3.m2.3.3.2.2.2.2" xref="S3.SS1.p2.3.m2.3.3.2.2.2.2.cmml">m</mi><mn id="S3.SS1.p2.3.m2.3.3.2.2.2.3" xref="S3.SS1.p2.3.m2.3.3.2.2.2.3.cmml">2</mn></msub><mo id="S3.SS1.p2.3.m2.3.3.2.2.5" xref="S3.SS1.p2.3.m2.3.3.2.3.cmml">,</mo><mi id="S3.SS1.p2.3.m2.1.1" mathvariant="normal" xref="S3.SS1.p2.3.m2.1.1.cmml">…</mi><mo id="S3.SS1.p2.3.m2.3.3.2.2.6" stretchy="false" xref="S3.SS1.p2.3.m2.3.3.2.3.cmml">]</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.3.m2.3b"><apply id="S3.SS1.p2.3.m2.3.3.cmml" xref="S3.SS1.p2.3.m2.3.3"><eq id="S3.SS1.p2.3.m2.3.3.3.cmml" xref="S3.SS1.p2.3.m2.3.3.3"></eq><ci id="S3.SS1.p2.3.m2.3.3.4.cmml" xref="S3.SS1.p2.3.m2.3.3.4">𝒎</ci><list id="S3.SS1.p2.3.m2.3.3.2.3.cmml" xref="S3.SS1.p2.3.m2.3.3.2.2"><apply id="S3.SS1.p2.3.m2.2.2.1.1.1.cmml" xref="S3.SS1.p2.3.m2.2.2.1.1.1"><csymbol cd="ambiguous" id="S3.SS1.p2.3.m2.2.2.1.1.1.1.cmml" xref="S3.SS1.p2.3.m2.2.2.1.1.1">subscript</csymbol><ci id="S3.SS1.p2.3.m2.2.2.1.1.1.2.cmml" xref="S3.SS1.p2.3.m2.2.2.1.1.1.2">𝑚</ci><cn id="S3.SS1.p2.3.m2.2.2.1.1.1.3.cmml" type="integer" xref="S3.SS1.p2.3.m2.2.2.1.1.1.3">1</cn></apply><apply id="S3.SS1.p2.3.m2.3.3.2.2.2.cmml" xref="S3.SS1.p2.3.m2.3.3.2.2.2"><csymbol cd="ambiguous" id="S3.SS1.p2.3.m2.3.3.2.2.2.1.cmml" xref="S3.SS1.p2.3.m2.3.3.2.2.2">subscript</csymbol><ci id="S3.SS1.p2.3.m2.3.3.2.2.2.2.cmml" xref="S3.SS1.p2.3.m2.3.3.2.2.2.2">𝑚</ci><cn id="S3.SS1.p2.3.m2.3.3.2.2.2.3.cmml" type="integer" xref="S3.SS1.p2.3.m2.3.3.2.2.2.3">2</cn></apply><ci id="S3.SS1.p2.3.m2.1.1.cmml" xref="S3.SS1.p2.3.m2.1.1">…</ci></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.3.m2.3c">{\bm{m}}=[m_{1},m_{2},...]</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.3.m2.3d">bold_italic_m = [ italic_m start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , italic_m start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT , … ]</annotation></semantics></math> is the sequence of <span class="ltx_text ltx_font_typewriter" id="S3.SS1.p2.9.1">&lt;mem&gt;</span> tokens of size <math alttext="n/k" class="ltx_Math" display="inline" id="S3.SS1.p2.4.m3.1"><semantics id="S3.SS1.p2.4.m3.1a"><mrow id="S3.SS1.p2.4.m3.1.1" xref="S3.SS1.p2.4.m3.1.1.cmml"><mi id="S3.SS1.p2.4.m3.1.1.2" xref="S3.SS1.p2.4.m3.1.1.2.cmml">n</mi><mo id="S3.SS1.p2.4.m3.1.1.1" xref="S3.SS1.p2.4.m3.1.1.1.cmml">/</mo><mi id="S3.SS1.p2.4.m3.1.1.3" xref="S3.SS1.p2.4.m3.1.1.3.cmml">k</mi></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.4.m3.1b"><apply id="S3.SS1.p2.4.m3.1.1.cmml" xref="S3.SS1.p2.4.m3.1.1"><divide id="S3.SS1.p2.4.m3.1.1.1.cmml" xref="S3.SS1.p2.4.m3.1.1.1"></divide><ci id="S3.SS1.p2.4.m3.1.1.2.cmml" xref="S3.SS1.p2.4.m3.1.1.2">𝑛</ci><ci id="S3.SS1.p2.4.m3.1.1.3.cmml" xref="S3.SS1.p2.4.m3.1.1.3">𝑘</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.4.m3.1c">n/k</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.4.m3.1d">italic_n / italic_k</annotation></semantics></math>,
<math alttext="\tilde{{\bm{m}}}\in{\mathbb{R}}^{(n/k)\times d}" class="ltx_Math" display="inline" id="S3.SS1.p2.5.m4.1"><semantics id="S3.SS1.p2.5.m4.1a"><mrow id="S3.SS1.p2.5.m4.1.2" xref="S3.SS1.p2.5.m4.1.2.cmml"><mover accent="true" id="S3.SS1.p2.5.m4.1.2.2" xref="S3.SS1.p2.5.m4.1.2.2.cmml"><mi id="S3.SS1.p2.5.m4.1.2.2.2" xref="S3.SS1.p2.5.m4.1.2.2.2.cmml">𝒎</mi><mo id="S3.SS1.p2.5.m4.1.2.2.1" xref="S3.SS1.p2.5.m4.1.2.2.1.cmml">~</mo></mover><mo id="S3.SS1.p2.5.m4.1.2.1" xref="S3.SS1.p2.5.m4.1.2.1.cmml">∈</mo><msup id="S3.SS1.p2.5.m4.1.2.3" xref="S3.SS1.p2.5.m4.1.2.3.cmml"><mi id="S3.SS1.p2.5.m4.1.2.3.2" xref="S3.SS1.p2.5.m4.1.2.3.2.cmml">ℝ</mi><mrow id="S3.SS1.p2.5.m4.1.1.1" xref="S3.SS1.p2.5.m4.1.1.1.cmml"><mrow id="S3.SS1.p2.5.m4.1.1.1.1.1" xref="S3.SS1.p2.5.m4.1.1.1.1.1.1.cmml"><mo id="S3.SS1.p2.5.m4.1.1.1.1.1.2" stretchy="false" xref="S3.SS1.p2.5.m4.1.1.1.1.1.1.cmml">(</mo><mrow id="S3.SS1.p2.5.m4.1.1.1.1.1.1" xref="S3.SS1.p2.5.m4.1.1.1.1.1.1.cmml"><mi id="S3.SS1.p2.5.m4.1.1.1.1.1.1.2" xref="S3.SS1.p2.5.m4.1.1.1.1.1.1.2.cmml">n</mi><mo id="S3.SS1.p2.5.m4.1.1.1.1.1.1.1" xref="S3.SS1.p2.5.m4.1.1.1.1.1.1.1.cmml">/</mo><mi id="S3.SS1.p2.5.m4.1.1.1.1.1.1.3" xref="S3.SS1.p2.5.m4.1.1.1.1.1.1.3.cmml">k</mi></mrow><mo id="S3.SS1.p2.5.m4.1.1.1.1.1.3" rspace="0.055em" stretchy="false" xref="S3.SS1.p2.5.m4.1.1.1.1.1.1.cmml">)</mo></mrow><mo id="S3.SS1.p2.5.m4.1.1.1.2" rspace="0.222em" xref="S3.SS1.p2.5.m4.1.1.1.2.cmml">×</mo><mi id="S3.SS1.p2.5.m4.1.1.1.3" xref="S3.SS1.p2.5.m4.1.1.1.3.cmml">d</mi></mrow></msup></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.5.m4.1b"><apply id="S3.SS1.p2.5.m4.1.2.cmml" xref="S3.SS1.p2.5.m4.1.2"><in id="S3.SS1.p2.5.m4.1.2.1.cmml" xref="S3.SS1.p2.5.m4.1.2.1"></in><apply id="S3.SS1.p2.5.m4.1.2.2.cmml" xref="S3.SS1.p2.5.m4.1.2.2"><ci id="S3.SS1.p2.5.m4.1.2.2.1.cmml" xref="S3.SS1.p2.5.m4.1.2.2.1">~</ci><ci id="S3.SS1.p2.5.m4.1.2.2.2.cmml" xref="S3.SS1.p2.5.m4.1.2.2.2">𝒎</ci></apply><apply id="S3.SS1.p2.5.m4.1.2.3.cmml" xref="S3.SS1.p2.5.m4.1.2.3"><csymbol cd="ambiguous" id="S3.SS1.p2.5.m4.1.2.3.1.cmml" xref="S3.SS1.p2.5.m4.1.2.3">superscript</csymbol><ci id="S3.SS1.p2.5.m4.1.2.3.2.cmml" xref="S3.SS1.p2.5.m4.1.2.3.2">ℝ</ci><apply id="S3.SS1.p2.5.m4.1.1.1.cmml" xref="S3.SS1.p2.5.m4.1.1.1"><times id="S3.SS1.p2.5.m4.1.1.1.2.cmml" xref="S3.SS1.p2.5.m4.1.1.1.2"></times><apply id="S3.SS1.p2.5.m4.1.1.1.1.1.1.cmml" xref="S3.SS1.p2.5.m4.1.1.1.1.1"><divide id="S3.SS1.p2.5.m4.1.1.1.1.1.1.1.cmml" xref="S3.SS1.p2.5.m4.1.1.1.1.1.1.1"></divide><ci id="S3.SS1.p2.5.m4.1.1.1.1.1.1.2.cmml" xref="S3.SS1.p2.5.m4.1.1.1.1.1.1.2">𝑛</ci><ci id="S3.SS1.p2.5.m4.1.1.1.1.1.1.3.cmml" xref="S3.SS1.p2.5.m4.1.1.1.1.1.1.3">𝑘</ci></apply><ci id="S3.SS1.p2.5.m4.1.1.1.3.cmml" xref="S3.SS1.p2.5.m4.1.1.1.3">𝑑</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.5.m4.1c">\tilde{{\bm{m}}}\in{\mathbb{R}}^{(n/k)\times d}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.5.m4.1d">over~ start_ARG bold_italic_m end_ARG ∈ blackboard_R start_POSTSUPERSCRIPT ( italic_n / italic_k ) × italic_d end_POSTSUPERSCRIPT</annotation></semantics></math> is the corresponding output hidden embeddings that encode the compressed information of <math alttext="{\bm{x}}" class="ltx_Math" display="inline" id="S3.SS1.p2.6.m5.1"><semantics id="S3.SS1.p2.6.m5.1a"><mi id="S3.SS1.p2.6.m5.1.1" xref="S3.SS1.p2.6.m5.1.1.cmml">𝒙</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.6.m5.1b"><ci id="S3.SS1.p2.6.m5.1.1.cmml" xref="S3.SS1.p2.6.m5.1.1">𝒙</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.6.m5.1c">{\bm{x}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.6.m5.1d">bold_italic_x</annotation></semantics></math>,
and <math alttext="\_" class="ltx_Math" display="inline" id="S3.SS1.p2.7.m6.1"><semantics id="S3.SS1.p2.7.m6.1a"><mi id="S3.SS1.p2.7.m6.1.1" mathvariant="normal" xref="S3.SS1.p2.7.m6.1.1.cmml">_</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.7.m6.1b"><ci id="S3.SS1.p2.7.m6.1.1.cmml" xref="S3.SS1.p2.7.m6.1.1">_</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.7.m6.1c">\_</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.7.m6.1d">_</annotation></semantics></math> corresponds to the output of the sequence <math alttext="{\bm{x}}" class="ltx_Math" display="inline" id="S3.SS1.p2.8.m7.1"><semantics id="S3.SS1.p2.8.m7.1a"><mi id="S3.SS1.p2.8.m7.1.1" xref="S3.SS1.p2.8.m7.1.1.cmml">𝒙</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.8.m7.1b"><ci id="S3.SS1.p2.8.m7.1.1.cmml" xref="S3.SS1.p2.8.m7.1.1">𝒙</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.8.m7.1c">{\bm{x}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.8.m7.1d">bold_italic_x</annotation></semantics></math>, which we ignore.
<math alttext="M" class="ltx_Math" display="inline" id="S3.SS1.p2.9.m8.1"><semantics id="S3.SS1.p2.9.m8.1a"><mi id="S3.SS1.p2.9.m8.1.1" xref="S3.SS1.p2.9.m8.1.1.cmml">M</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.9.m8.1b"><ci id="S3.SS1.p2.9.m8.1.1.cmml" xref="S3.SS1.p2.9.m8.1.1">𝑀</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.9.m8.1c">M</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.9.m8.1d">italic_M</annotation></semantics></math> is the special attention mask that we will introduce below.</p>
</div>
<div class="ltx_para ltx_noindent" id="S3.SS1.p3">
<p class="ltx_p" id="S3.SS1.p3.1"><span class="ltx_text ltx_font_bold" id="S3.SS1.p3.1.1">Retrieval-oriented compression</span>.
So far, the compressor resembles those compression techniques proposed in prior work such as AutoCompressor <cite class="ltx_cite ltx_citemacro_citep">(Chevalier et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib3" title="">2023</a>)</cite> and ICAE <cite class="ltx_cite ltx_citemacro_citep">(Ge et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib9" title="">2023</a>)</cite>.
However, we introduce two important features to enable a more flexible and life-long management of context information.</p>
</div>
<div class="ltx_para ltx_noindent" id="S3.SS1.p4">
<p class="ltx_p" id="S3.SS1.p4.1">Instead of compressing and reusing the context only within a single session, we seek to build a <span class="ltx_text ltx_font_bold" id="S3.SS1.p4.1.1">hierarchical database</span> that stores all external and past context, such as pages retrieved by web searches, the entire past chat history, logs generated by past tool usages, and so on.
Such a dataset should be built in a way where context can be retrieved efficiently and at different levels of granularity.</p>
</div>
<div class="ltx_para ltx_noindent" id="S3.SS1.p5">
<p class="ltx_p" id="S3.SS1.p5.1">To this end, we build the hierarchical database by iteratively compressing the context to form an embedding hierarchy that encodes coarse-to-fine information.
Formally, given a segment <math alttext="{\bm{x}}" class="ltx_Math" display="inline" id="S3.SS1.p5.1.m1.1"><semantics id="S3.SS1.p5.1.m1.1a"><mi id="S3.SS1.p5.1.m1.1.1" xref="S3.SS1.p5.1.m1.1.1.cmml">𝒙</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p5.1.m1.1b"><ci id="S3.SS1.p5.1.m1.1.1.cmml" xref="S3.SS1.p5.1.m1.1.1">𝒙</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p5.1.m1.1c">{\bm{x}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p5.1.m1.1d">bold_italic_x</annotation></semantics></math>, we have:</p>
<table class="ltx_equationgroup ltx_eqn_align ltx_eqn_table" id="S6.EGx1">
<tbody id="S3.Ex2"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle\tilde{{\bm{m}}}_{0}\leftarrow{\bm{x}}," class="ltx_Math" display="inline" id="S3.Ex2.m1.1"><semantics id="S3.Ex2.m1.1a"><mrow id="S3.Ex2.m1.1.1.1" xref="S3.Ex2.m1.1.1.1.1.cmml"><mrow id="S3.Ex2.m1.1.1.1.1" xref="S3.Ex2.m1.1.1.1.1.cmml"><msub id="S3.Ex2.m1.1.1.1.1.2" xref="S3.Ex2.m1.1.1.1.1.2.cmml"><mover accent="true" id="S3.Ex2.m1.1.1.1.1.2.2" xref="S3.Ex2.m1.1.1.1.1.2.2.cmml"><mi id="S3.Ex2.m1.1.1.1.1.2.2.2" xref="S3.Ex2.m1.1.1.1.1.2.2.2.cmml">𝒎</mi><mo id="S3.Ex2.m1.1.1.1.1.2.2.1" xref="S3.Ex2.m1.1.1.1.1.2.2.1.cmml">~</mo></mover><mn id="S3.Ex2.m1.1.1.1.1.2.3" xref="S3.Ex2.m1.1.1.1.1.2.3.cmml">0</mn></msub><mo id="S3.Ex2.m1.1.1.1.1.1" stretchy="false" xref="S3.Ex2.m1.1.1.1.1.1.cmml">←</mo><mi id="S3.Ex2.m1.1.1.1.1.3" xref="S3.Ex2.m1.1.1.1.1.3.cmml">𝒙</mi></mrow><mo id="S3.Ex2.m1.1.1.1.2" xref="S3.Ex2.m1.1.1.1.1.cmml">,</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.Ex2.m1.1b"><apply id="S3.Ex2.m1.1.1.1.1.cmml" xref="S3.Ex2.m1.1.1.1"><ci id="S3.Ex2.m1.1.1.1.1.1.cmml" xref="S3.Ex2.m1.1.1.1.1.1">←</ci><apply id="S3.Ex2.m1.1.1.1.1.2.cmml" xref="S3.Ex2.m1.1.1.1.1.2"><csymbol cd="ambiguous" id="S3.Ex2.m1.1.1.1.1.2.1.cmml" xref="S3.Ex2.m1.1.1.1.1.2">subscript</csymbol><apply id="S3.Ex2.m1.1.1.1.1.2.2.cmml" xref="S3.Ex2.m1.1.1.1.1.2.2"><ci id="S3.Ex2.m1.1.1.1.1.2.2.1.cmml" xref="S3.Ex2.m1.1.1.1.1.2.2.1">~</ci><ci id="S3.Ex2.m1.1.1.1.1.2.2.2.cmml" xref="S3.Ex2.m1.1.1.1.1.2.2.2">𝒎</ci></apply><cn id="S3.Ex2.m1.1.1.1.1.2.3.cmml" type="integer" xref="S3.Ex2.m1.1.1.1.1.2.3">0</cn></apply><ci id="S3.Ex2.m1.1.1.1.1.3.cmml" xref="S3.Ex2.m1.1.1.1.1.3">𝒙</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.Ex2.m1.1c">\displaystyle\tilde{{\bm{m}}}_{0}\leftarrow{\bm{x}},</annotation><annotation encoding="application/x-llamapun" id="S3.Ex2.m1.1d">over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT 0 end_POSTSUBSCRIPT ← bold_italic_x ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
<tbody id="S3.Ex3"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle[\ \_\ ,\tilde{{\bm{m}}}_{i+1}]\leftarrow f_{\text{llm}}([\tilde{%
{\bm{m}}}_{i},{\bm{m}}_{i+1}],M_{i}),\ \ i=0,1,..." class="ltx_Math" display="inline" id="S3.Ex3.m1.6"><semantics id="S3.Ex3.m1.6a"><mrow id="S3.Ex3.m1.6.6.2" xref="S3.Ex3.m1.6.6.3.cmml"><mrow id="S3.Ex3.m1.5.5.1.1" xref="S3.Ex3.m1.5.5.1.1.cmml"><mrow id="S3.Ex3.m1.5.5.1.1.1.1" xref="S3.Ex3.m1.5.5.1.1.1.2.cmml"><mo id="S3.Ex3.m1.5.5.1.1.1.1.2" rspace="0.500em" stretchy="false" xref="S3.Ex3.m1.5.5.1.1.1.2.cmml">[</mo><mi id="S3.Ex3.m1.1.1" mathvariant="normal" xref="S3.Ex3.m1.1.1.cmml">_</mi><mo id="S3.Ex3.m1.5.5.1.1.1.1.3" lspace="0.500em" xref="S3.Ex3.m1.5.5.1.1.1.2.cmml">,</mo><msub id="S3.Ex3.m1.5.5.1.1.1.1.1" xref="S3.Ex3.m1.5.5.1.1.1.1.1.cmml"><mover accent="true" id="S3.Ex3.m1.5.5.1.1.1.1.1.2" xref="S3.Ex3.m1.5.5.1.1.1.1.1.2.cmml"><mi id="S3.Ex3.m1.5.5.1.1.1.1.1.2.2" xref="S3.Ex3.m1.5.5.1.1.1.1.1.2.2.cmml">𝒎</mi><mo id="S3.Ex3.m1.5.5.1.1.1.1.1.2.1" xref="S3.Ex3.m1.5.5.1.1.1.1.1.2.1.cmml">~</mo></mover><mrow id="S3.Ex3.m1.5.5.1.1.1.1.1.3" xref="S3.Ex3.m1.5.5.1.1.1.1.1.3.cmml"><mi id="S3.Ex3.m1.5.5.1.1.1.1.1.3.2" xref="S3.Ex3.m1.5.5.1.1.1.1.1.3.2.cmml">i</mi><mo id="S3.Ex3.m1.5.5.1.1.1.1.1.3.1" xref="S3.Ex3.m1.5.5.1.1.1.1.1.3.1.cmml">+</mo><mn id="S3.Ex3.m1.5.5.1.1.1.1.1.3.3" xref="S3.Ex3.m1.5.5.1.1.1.1.1.3.3.cmml">1</mn></mrow></msub><mo id="S3.Ex3.m1.5.5.1.1.1.1.4" stretchy="false" xref="S3.Ex3.m1.5.5.1.1.1.2.cmml">]</mo></mrow><mo id="S3.Ex3.m1.5.5.1.1.4" stretchy="false" xref="S3.Ex3.m1.5.5.1.1.4.cmml">←</mo><mrow id="S3.Ex3.m1.5.5.1.1.3" xref="S3.Ex3.m1.5.5.1.1.3.cmml"><msub id="S3.Ex3.m1.5.5.1.1.3.4" xref="S3.Ex3.m1.5.5.1.1.3.4.cmml"><mi id="S3.Ex3.m1.5.5.1.1.3.4.2" xref="S3.Ex3.m1.5.5.1.1.3.4.2.cmml">f</mi><mtext id="S3.Ex3.m1.5.5.1.1.3.4.3" xref="S3.Ex3.m1.5.5.1.1.3.4.3a.cmml">llm</mtext></msub><mo id="S3.Ex3.m1.5.5.1.1.3.3" xref="S3.Ex3.m1.5.5.1.1.3.3.cmml">⁢</mo><mrow id="S3.Ex3.m1.5.5.1.1.3.2.2" xref="S3.Ex3.m1.5.5.1.1.3.2.3.cmml"><mo id="S3.Ex3.m1.5.5.1.1.3.2.2.3" stretchy="false" xref="S3.Ex3.m1.5.5.1.1.3.2.3.cmml">(</mo><mrow id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.3.cmml"><mo id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.3" stretchy="false" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.3.cmml">[</mo><msub id="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.cmml"><mover accent="true" id="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.2" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.2.cmml"><mi id="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.2.2" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.2.2.cmml">𝒎</mi><mo id="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.2.1" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.2.1.cmml">~</mo></mover><mi id="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.3" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.3.cmml">i</mi></msub><mo id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.4" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.3.cmml">,</mo><msub id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.cmml"><mi id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.2" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.2.cmml">𝒎</mi><mrow id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.cmml"><mi id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.2" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.2.cmml">i</mi><mo id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.1" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.1.cmml">+</mo><mn id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.3" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.3.cmml">1</mn></mrow></msub><mo id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.5" stretchy="false" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.3.cmml">]</mo></mrow><mo id="S3.Ex3.m1.5.5.1.1.3.2.2.4" xref="S3.Ex3.m1.5.5.1.1.3.2.3.cmml">,</mo><msub id="S3.Ex3.m1.5.5.1.1.3.2.2.2" xref="S3.Ex3.m1.5.5.1.1.3.2.2.2.cmml"><mi id="S3.Ex3.m1.5.5.1.1.3.2.2.2.2" xref="S3.Ex3.m1.5.5.1.1.3.2.2.2.2.cmml">M</mi><mi id="S3.Ex3.m1.5.5.1.1.3.2.2.2.3" xref="S3.Ex3.m1.5.5.1.1.3.2.2.2.3.cmml">i</mi></msub><mo id="S3.Ex3.m1.5.5.1.1.3.2.2.5" stretchy="false" xref="S3.Ex3.m1.5.5.1.1.3.2.3.cmml">)</mo></mrow></mrow></mrow><mo id="S3.Ex3.m1.6.6.2.3" rspace="1.167em" xref="S3.Ex3.m1.6.6.3a.cmml">,</mo><mrow id="S3.Ex3.m1.6.6.2.2" xref="S3.Ex3.m1.6.6.2.2.cmml"><mi id="S3.Ex3.m1.6.6.2.2.2" xref="S3.Ex3.m1.6.6.2.2.2.cmml">i</mi><mo id="S3.Ex3.m1.6.6.2.2.1" xref="S3.Ex3.m1.6.6.2.2.1.cmml">=</mo><mrow id="S3.Ex3.m1.6.6.2.2.3.2" xref="S3.Ex3.m1.6.6.2.2.3.1.cmml"><mn id="S3.Ex3.m1.2.2" xref="S3.Ex3.m1.2.2.cmml">0</mn><mo id="S3.Ex3.m1.6.6.2.2.3.2.1" xref="S3.Ex3.m1.6.6.2.2.3.1.cmml">,</mo><mn id="S3.Ex3.m1.3.3" xref="S3.Ex3.m1.3.3.cmml">1</mn><mo id="S3.Ex3.m1.6.6.2.2.3.2.2" xref="S3.Ex3.m1.6.6.2.2.3.1.cmml">,</mo><mi id="S3.Ex3.m1.4.4" mathvariant="normal" xref="S3.Ex3.m1.4.4.cmml">…</mi></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.Ex3.m1.6b"><apply id="S3.Ex3.m1.6.6.3.cmml" xref="S3.Ex3.m1.6.6.2"><csymbol cd="ambiguous" id="S3.Ex3.m1.6.6.3a.cmml" xref="S3.Ex3.m1.6.6.2.3">formulae-sequence</csymbol><apply id="S3.Ex3.m1.5.5.1.1.cmml" xref="S3.Ex3.m1.5.5.1.1"><ci id="S3.Ex3.m1.5.5.1.1.4.cmml" xref="S3.Ex3.m1.5.5.1.1.4">←</ci><interval closure="closed" id="S3.Ex3.m1.5.5.1.1.1.2.cmml" xref="S3.Ex3.m1.5.5.1.1.1.1"><ci id="S3.Ex3.m1.1.1.cmml" xref="S3.Ex3.m1.1.1">_</ci><apply id="S3.Ex3.m1.5.5.1.1.1.1.1.cmml" xref="S3.Ex3.m1.5.5.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.Ex3.m1.5.5.1.1.1.1.1.1.cmml" xref="S3.Ex3.m1.5.5.1.1.1.1.1">subscript</csymbol><apply id="S3.Ex3.m1.5.5.1.1.1.1.1.2.cmml" xref="S3.Ex3.m1.5.5.1.1.1.1.1.2"><ci id="S3.Ex3.m1.5.5.1.1.1.1.1.2.1.cmml" xref="S3.Ex3.m1.5.5.1.1.1.1.1.2.1">~</ci><ci id="S3.Ex3.m1.5.5.1.1.1.1.1.2.2.cmml" xref="S3.Ex3.m1.5.5.1.1.1.1.1.2.2">𝒎</ci></apply><apply id="S3.Ex3.m1.5.5.1.1.1.1.1.3.cmml" xref="S3.Ex3.m1.5.5.1.1.1.1.1.3"><plus id="S3.Ex3.m1.5.5.1.1.1.1.1.3.1.cmml" xref="S3.Ex3.m1.5.5.1.1.1.1.1.3.1"></plus><ci id="S3.Ex3.m1.5.5.1.1.1.1.1.3.2.cmml" xref="S3.Ex3.m1.5.5.1.1.1.1.1.3.2">𝑖</ci><cn id="S3.Ex3.m1.5.5.1.1.1.1.1.3.3.cmml" type="integer" xref="S3.Ex3.m1.5.5.1.1.1.1.1.3.3">1</cn></apply></apply></interval><apply id="S3.Ex3.m1.5.5.1.1.3.cmml" xref="S3.Ex3.m1.5.5.1.1.3"><times id="S3.Ex3.m1.5.5.1.1.3.3.cmml" xref="S3.Ex3.m1.5.5.1.1.3.3"></times><apply id="S3.Ex3.m1.5.5.1.1.3.4.cmml" xref="S3.Ex3.m1.5.5.1.1.3.4"><csymbol cd="ambiguous" id="S3.Ex3.m1.5.5.1.1.3.4.1.cmml" xref="S3.Ex3.m1.5.5.1.1.3.4">subscript</csymbol><ci id="S3.Ex3.m1.5.5.1.1.3.4.2.cmml" xref="S3.Ex3.m1.5.5.1.1.3.4.2">𝑓</ci><ci id="S3.Ex3.m1.5.5.1.1.3.4.3a.cmml" xref="S3.Ex3.m1.5.5.1.1.3.4.3"><mtext id="S3.Ex3.m1.5.5.1.1.3.4.3.cmml" mathsize="70%" xref="S3.Ex3.m1.5.5.1.1.3.4.3">llm</mtext></ci></apply><interval closure="open" id="S3.Ex3.m1.5.5.1.1.3.2.3.cmml" xref="S3.Ex3.m1.5.5.1.1.3.2.2"><interval closure="closed" id="S3.Ex3.m1.5.5.1.1.2.1.1.1.3.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2"><apply id="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.1.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1">subscript</csymbol><apply id="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.2.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.2"><ci id="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.2.1.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.2.1">~</ci><ci id="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.2.2.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.2.2">𝒎</ci></apply><ci id="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.3.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.1.1.3">𝑖</ci></apply><apply id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2"><csymbol cd="ambiguous" id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.1.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2">subscript</csymbol><ci id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.2.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.2">𝒎</ci><apply id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3"><plus id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.1.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.1"></plus><ci id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.2.cmml" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.2">𝑖</ci><cn id="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.3.cmml" type="integer" xref="S3.Ex3.m1.5.5.1.1.2.1.1.1.2.2.3.3">1</cn></apply></apply></interval><apply id="S3.Ex3.m1.5.5.1.1.3.2.2.2.cmml" xref="S3.Ex3.m1.5.5.1.1.3.2.2.2"><csymbol cd="ambiguous" id="S3.Ex3.m1.5.5.1.1.3.2.2.2.1.cmml" xref="S3.Ex3.m1.5.5.1.1.3.2.2.2">subscript</csymbol><ci id="S3.Ex3.m1.5.5.1.1.3.2.2.2.2.cmml" xref="S3.Ex3.m1.5.5.1.1.3.2.2.2.2">𝑀</ci><ci id="S3.Ex3.m1.5.5.1.1.3.2.2.2.3.cmml" xref="S3.Ex3.m1.5.5.1.1.3.2.2.2.3">𝑖</ci></apply></interval></apply></apply><apply id="S3.Ex3.m1.6.6.2.2.cmml" xref="S3.Ex3.m1.6.6.2.2"><eq id="S3.Ex3.m1.6.6.2.2.1.cmml" xref="S3.Ex3.m1.6.6.2.2.1"></eq><ci id="S3.Ex3.m1.6.6.2.2.2.cmml" xref="S3.Ex3.m1.6.6.2.2.2">𝑖</ci><list id="S3.Ex3.m1.6.6.2.2.3.1.cmml" xref="S3.Ex3.m1.6.6.2.2.3.2"><cn id="S3.Ex3.m1.2.2.cmml" type="integer" xref="S3.Ex3.m1.2.2">0</cn><cn id="S3.Ex3.m1.3.3.cmml" type="integer" xref="S3.Ex3.m1.3.3">1</cn><ci id="S3.Ex3.m1.4.4.cmml" xref="S3.Ex3.m1.4.4">…</ci></list></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.Ex3.m1.6c">\displaystyle[\ \_\ ,\tilde{{\bm{m}}}_{i+1}]\leftarrow f_{\text{llm}}([\tilde{%
{\bm{m}}}_{i},{\bm{m}}_{i+1}],M_{i}),\ \ i=0,1,...</annotation><annotation encoding="application/x-llamapun" id="S3.Ex3.m1.6d">[ _ , over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_i + 1 end_POSTSUBSCRIPT ] ← italic_f start_POSTSUBSCRIPT llm end_POSTSUBSCRIPT ( [ over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT , bold_italic_m start_POSTSUBSCRIPT italic_i + 1 end_POSTSUBSCRIPT ] , italic_M start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ) , italic_i = 0 , 1 , …</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S3.SS1.p5.5">For a fixed compression factor <math alttext="k" class="ltx_Math" display="inline" id="S3.SS1.p5.2.m1.1"><semantics id="S3.SS1.p5.2.m1.1a"><mi id="S3.SS1.p5.2.m1.1.1" xref="S3.SS1.p5.2.m1.1.1.cmml">k</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p5.2.m1.1b"><ci id="S3.SS1.p5.2.m1.1.1.cmml" xref="S3.SS1.p5.2.m1.1.1">𝑘</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p5.2.m1.1c">k</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p5.2.m1.1d">italic_k</annotation></semantics></math>, this forms a hierarchy
<math alttext="[\tilde{{\bm{m}}}_{0},\tilde{{\bm{m}}}_{1},...,\tilde{{\bm{m}}}_{L}]" class="ltx_Math" display="inline" id="S3.SS1.p5.3.m2.4"><semantics id="S3.SS1.p5.3.m2.4a"><mrow id="S3.SS1.p5.3.m2.4.4.3" xref="S3.SS1.p5.3.m2.4.4.4.cmml"><mo id="S3.SS1.p5.3.m2.4.4.3.4" stretchy="false" xref="S3.SS1.p5.3.m2.4.4.4.cmml">[</mo><msub id="S3.SS1.p5.3.m2.2.2.1.1" xref="S3.SS1.p5.3.m2.2.2.1.1.cmml"><mover accent="true" id="S3.SS1.p5.3.m2.2.2.1.1.2" xref="S3.SS1.p5.3.m2.2.2.1.1.2.cmml"><mi id="S3.SS1.p5.3.m2.2.2.1.1.2.2" xref="S3.SS1.p5.3.m2.2.2.1.1.2.2.cmml">𝒎</mi><mo id="S3.SS1.p5.3.m2.2.2.1.1.2.1" xref="S3.SS1.p5.3.m2.2.2.1.1.2.1.cmml">~</mo></mover><mn id="S3.SS1.p5.3.m2.2.2.1.1.3" xref="S3.SS1.p5.3.m2.2.2.1.1.3.cmml">0</mn></msub><mo id="S3.SS1.p5.3.m2.4.4.3.5" xref="S3.SS1.p5.3.m2.4.4.4.cmml">,</mo><msub id="S3.SS1.p5.3.m2.3.3.2.2" xref="S3.SS1.p5.3.m2.3.3.2.2.cmml"><mover accent="true" id="S3.SS1.p5.3.m2.3.3.2.2.2" xref="S3.SS1.p5.3.m2.3.3.2.2.2.cmml"><mi id="S3.SS1.p5.3.m2.3.3.2.2.2.2" xref="S3.SS1.p5.3.m2.3.3.2.2.2.2.cmml">𝒎</mi><mo id="S3.SS1.p5.3.m2.3.3.2.2.2.1" xref="S3.SS1.p5.3.m2.3.3.2.2.2.1.cmml">~</mo></mover><mn id="S3.SS1.p5.3.m2.3.3.2.2.3" xref="S3.SS1.p5.3.m2.3.3.2.2.3.cmml">1</mn></msub><mo id="S3.SS1.p5.3.m2.4.4.3.6" xref="S3.SS1.p5.3.m2.4.4.4.cmml">,</mo><mi id="S3.SS1.p5.3.m2.1.1" mathvariant="normal" xref="S3.SS1.p5.3.m2.1.1.cmml">…</mi><mo id="S3.SS1.p5.3.m2.4.4.3.7" xref="S3.SS1.p5.3.m2.4.4.4.cmml">,</mo><msub id="S3.SS1.p5.3.m2.4.4.3.3" xref="S3.SS1.p5.3.m2.4.4.3.3.cmml"><mover accent="true" id="S3.SS1.p5.3.m2.4.4.3.3.2" xref="S3.SS1.p5.3.m2.4.4.3.3.2.cmml"><mi id="S3.SS1.p5.3.m2.4.4.3.3.2.2" xref="S3.SS1.p5.3.m2.4.4.3.3.2.2.cmml">𝒎</mi><mo id="S3.SS1.p5.3.m2.4.4.3.3.2.1" xref="S3.SS1.p5.3.m2.4.4.3.3.2.1.cmml">~</mo></mover><mi id="S3.SS1.p5.3.m2.4.4.3.3.3" xref="S3.SS1.p5.3.m2.4.4.3.3.3.cmml">L</mi></msub><mo id="S3.SS1.p5.3.m2.4.4.3.8" stretchy="false" xref="S3.SS1.p5.3.m2.4.4.4.cmml">]</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p5.3.m2.4b"><list id="S3.SS1.p5.3.m2.4.4.4.cmml" xref="S3.SS1.p5.3.m2.4.4.3"><apply id="S3.SS1.p5.3.m2.2.2.1.1.cmml" xref="S3.SS1.p5.3.m2.2.2.1.1"><csymbol cd="ambiguous" id="S3.SS1.p5.3.m2.2.2.1.1.1.cmml" xref="S3.SS1.p5.3.m2.2.2.1.1">subscript</csymbol><apply id="S3.SS1.p5.3.m2.2.2.1.1.2.cmml" xref="S3.SS1.p5.3.m2.2.2.1.1.2"><ci id="S3.SS1.p5.3.m2.2.2.1.1.2.1.cmml" xref="S3.SS1.p5.3.m2.2.2.1.1.2.1">~</ci><ci id="S3.SS1.p5.3.m2.2.2.1.1.2.2.cmml" xref="S3.SS1.p5.3.m2.2.2.1.1.2.2">𝒎</ci></apply><cn id="S3.SS1.p5.3.m2.2.2.1.1.3.cmml" type="integer" xref="S3.SS1.p5.3.m2.2.2.1.1.3">0</cn></apply><apply id="S3.SS1.p5.3.m2.3.3.2.2.cmml" xref="S3.SS1.p5.3.m2.3.3.2.2"><csymbol cd="ambiguous" id="S3.SS1.p5.3.m2.3.3.2.2.1.cmml" xref="S3.SS1.p5.3.m2.3.3.2.2">subscript</csymbol><apply id="S3.SS1.p5.3.m2.3.3.2.2.2.cmml" xref="S3.SS1.p5.3.m2.3.3.2.2.2"><ci id="S3.SS1.p5.3.m2.3.3.2.2.2.1.cmml" xref="S3.SS1.p5.3.m2.3.3.2.2.2.1">~</ci><ci id="S3.SS1.p5.3.m2.3.3.2.2.2.2.cmml" xref="S3.SS1.p5.3.m2.3.3.2.2.2.2">𝒎</ci></apply><cn id="S3.SS1.p5.3.m2.3.3.2.2.3.cmml" type="integer" xref="S3.SS1.p5.3.m2.3.3.2.2.3">1</cn></apply><ci id="S3.SS1.p5.3.m2.1.1.cmml" xref="S3.SS1.p5.3.m2.1.1">…</ci><apply id="S3.SS1.p5.3.m2.4.4.3.3.cmml" xref="S3.SS1.p5.3.m2.4.4.3.3"><csymbol cd="ambiguous" id="S3.SS1.p5.3.m2.4.4.3.3.1.cmml" xref="S3.SS1.p5.3.m2.4.4.3.3">subscript</csymbol><apply id="S3.SS1.p5.3.m2.4.4.3.3.2.cmml" xref="S3.SS1.p5.3.m2.4.4.3.3.2"><ci id="S3.SS1.p5.3.m2.4.4.3.3.2.1.cmml" xref="S3.SS1.p5.3.m2.4.4.3.3.2.1">~</ci><ci id="S3.SS1.p5.3.m2.4.4.3.3.2.2.cmml" xref="S3.SS1.p5.3.m2.4.4.3.3.2.2">𝒎</ci></apply><ci id="S3.SS1.p5.3.m2.4.4.3.3.3.cmml" xref="S3.SS1.p5.3.m2.4.4.3.3.3">𝐿</ci></apply></list></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p5.3.m2.4c">[\tilde{{\bm{m}}}_{0},\tilde{{\bm{m}}}_{1},...,\tilde{{\bm{m}}}_{L}]</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p5.3.m2.4d">[ over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT 0 end_POSTSUBSCRIPT , over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , … , over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_L end_POSTSUBSCRIPT ]</annotation></semantics></math>, where <math alttext="L=\lceil\log_{k}n\rceil" class="ltx_Math" display="inline" id="S3.SS1.p5.4.m3.1"><semantics id="S3.SS1.p5.4.m3.1a"><mrow id="S3.SS1.p5.4.m3.1.1" xref="S3.SS1.p5.4.m3.1.1.cmml"><mi id="S3.SS1.p5.4.m3.1.1.3" xref="S3.SS1.p5.4.m3.1.1.3.cmml">L</mi><mo id="S3.SS1.p5.4.m3.1.1.2" xref="S3.SS1.p5.4.m3.1.1.2.cmml">=</mo><mrow id="S3.SS1.p5.4.m3.1.1.1.1" xref="S3.SS1.p5.4.m3.1.1.1.2.cmml"><mo id="S3.SS1.p5.4.m3.1.1.1.1.2" stretchy="false" xref="S3.SS1.p5.4.m3.1.1.1.2.1.cmml">⌈</mo><mrow id="S3.SS1.p5.4.m3.1.1.1.1.1" xref="S3.SS1.p5.4.m3.1.1.1.1.1.cmml"><msub id="S3.SS1.p5.4.m3.1.1.1.1.1.1" xref="S3.SS1.p5.4.m3.1.1.1.1.1.1.cmml"><mi id="S3.SS1.p5.4.m3.1.1.1.1.1.1.2" xref="S3.SS1.p5.4.m3.1.1.1.1.1.1.2.cmml">log</mi><mi id="S3.SS1.p5.4.m3.1.1.1.1.1.1.3" xref="S3.SS1.p5.4.m3.1.1.1.1.1.1.3.cmml">k</mi></msub><mo id="S3.SS1.p5.4.m3.1.1.1.1.1a" lspace="0.167em" xref="S3.SS1.p5.4.m3.1.1.1.1.1.cmml">⁡</mo><mi id="S3.SS1.p5.4.m3.1.1.1.1.1.2" xref="S3.SS1.p5.4.m3.1.1.1.1.1.2.cmml">n</mi></mrow><mo id="S3.SS1.p5.4.m3.1.1.1.1.3" stretchy="false" xref="S3.SS1.p5.4.m3.1.1.1.2.1.cmml">⌉</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p5.4.m3.1b"><apply id="S3.SS1.p5.4.m3.1.1.cmml" xref="S3.SS1.p5.4.m3.1.1"><eq id="S3.SS1.p5.4.m3.1.1.2.cmml" xref="S3.SS1.p5.4.m3.1.1.2"></eq><ci id="S3.SS1.p5.4.m3.1.1.3.cmml" xref="S3.SS1.p5.4.m3.1.1.3">𝐿</ci><apply id="S3.SS1.p5.4.m3.1.1.1.2.cmml" xref="S3.SS1.p5.4.m3.1.1.1.1"><ceiling id="S3.SS1.p5.4.m3.1.1.1.2.1.cmml" xref="S3.SS1.p5.4.m3.1.1.1.1.2"></ceiling><apply id="S3.SS1.p5.4.m3.1.1.1.1.1.cmml" xref="S3.SS1.p5.4.m3.1.1.1.1.1"><apply id="S3.SS1.p5.4.m3.1.1.1.1.1.1.cmml" xref="S3.SS1.p5.4.m3.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.SS1.p5.4.m3.1.1.1.1.1.1.1.cmml" xref="S3.SS1.p5.4.m3.1.1.1.1.1.1">subscript</csymbol><log id="S3.SS1.p5.4.m3.1.1.1.1.1.1.2.cmml" xref="S3.SS1.p5.4.m3.1.1.1.1.1.1.2"></log><ci id="S3.SS1.p5.4.m3.1.1.1.1.1.1.3.cmml" xref="S3.SS1.p5.4.m3.1.1.1.1.1.1.3">𝑘</ci></apply><ci id="S3.SS1.p5.4.m3.1.1.1.1.1.2.cmml" xref="S3.SS1.p5.4.m3.1.1.1.1.1.2">𝑛</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p5.4.m3.1c">L=\lceil\log_{k}n\rceil</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p5.4.m3.1d">italic_L = ⌈ roman_log start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT italic_n ⌉</annotation></semantics></math>.
Following this, one can build the database by processing the entire past context in the form of chunks <math alttext="{\bm{x}}_{0},{\bm{x}}_{1},..." class="ltx_Math" display="inline" id="S3.SS1.p5.5.m4.3"><semantics id="S3.SS1.p5.5.m4.3a"><mrow id="S3.SS1.p5.5.m4.3.3.2" xref="S3.SS1.p5.5.m4.3.3.3.cmml"><msub id="S3.SS1.p5.5.m4.2.2.1.1" xref="S3.SS1.p5.5.m4.2.2.1.1.cmml"><mi id="S3.SS1.p5.5.m4.2.2.1.1.2" xref="S3.SS1.p5.5.m4.2.2.1.1.2.cmml">𝒙</mi><mn id="S3.SS1.p5.5.m4.2.2.1.1.3" xref="S3.SS1.p5.5.m4.2.2.1.1.3.cmml">0</mn></msub><mo id="S3.SS1.p5.5.m4.3.3.2.3" xref="S3.SS1.p5.5.m4.3.3.3.cmml">,</mo><msub id="S3.SS1.p5.5.m4.3.3.2.2" xref="S3.SS1.p5.5.m4.3.3.2.2.cmml"><mi id="S3.SS1.p5.5.m4.3.3.2.2.2" xref="S3.SS1.p5.5.m4.3.3.2.2.2.cmml">𝒙</mi><mn id="S3.SS1.p5.5.m4.3.3.2.2.3" xref="S3.SS1.p5.5.m4.3.3.2.2.3.cmml">1</mn></msub><mo id="S3.SS1.p5.5.m4.3.3.2.4" xref="S3.SS1.p5.5.m4.3.3.3.cmml">,</mo><mi id="S3.SS1.p5.5.m4.1.1" mathvariant="normal" xref="S3.SS1.p5.5.m4.1.1.cmml">…</mi></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p5.5.m4.3b"><list id="S3.SS1.p5.5.m4.3.3.3.cmml" xref="S3.SS1.p5.5.m4.3.3.2"><apply id="S3.SS1.p5.5.m4.2.2.1.1.cmml" xref="S3.SS1.p5.5.m4.2.2.1.1"><csymbol cd="ambiguous" id="S3.SS1.p5.5.m4.2.2.1.1.1.cmml" xref="S3.SS1.p5.5.m4.2.2.1.1">subscript</csymbol><ci id="S3.SS1.p5.5.m4.2.2.1.1.2.cmml" xref="S3.SS1.p5.5.m4.2.2.1.1.2">𝒙</ci><cn id="S3.SS1.p5.5.m4.2.2.1.1.3.cmml" type="integer" xref="S3.SS1.p5.5.m4.2.2.1.1.3">0</cn></apply><apply id="S3.SS1.p5.5.m4.3.3.2.2.cmml" xref="S3.SS1.p5.5.m4.3.3.2.2"><csymbol cd="ambiguous" id="S3.SS1.p5.5.m4.3.3.2.2.1.cmml" xref="S3.SS1.p5.5.m4.3.3.2.2">subscript</csymbol><ci id="S3.SS1.p5.5.m4.3.3.2.2.2.cmml" xref="S3.SS1.p5.5.m4.3.3.2.2.2">𝒙</ci><cn id="S3.SS1.p5.5.m4.3.3.2.2.3.cmml" type="integer" xref="S3.SS1.p5.5.m4.3.3.2.2.3">1</cn></apply><ci id="S3.SS1.p5.5.m4.1.1.cmml" xref="S3.SS1.p5.5.m4.1.1">…</ci></list></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p5.5.m4.3c">{\bm{x}}_{0},{\bm{x}}_{1},...</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p5.5.m4.3d">bold_italic_x start_POSTSUBSCRIPT 0 end_POSTSUBSCRIPT , bold_italic_x start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , …</annotation></semantics></math>, and the produced hierarchies can be stored on disk for future retrieval use.</p>
</div>
<figure class="ltx_figure ltx_figure_panel ltx_align_center ltx_align_floatright" id="S3.F3"><img alt="Refer to caption" class="ltx_graphics ltx_figure_panel ltx_img_square" height="526" id="S3.SS1.1.g1" src="x3.png" width="598"/>
<figcaption class="ltx_caption"><span class="ltx_tag ltx_tag_figure">Figure 3: </span>Segmented attention mask.</figcaption>
</figure>
<div class="ltx_para ltx_noindent" id="S3.SS1.p6">
<p class="ltx_p" id="S3.SS1.p6.13"><span class="ltx_text ltx_font_bold" id="S3.SS1.p6.13.1">Segmented attention mask</span>.
During the retrieval phase, the model will conduct a top-down retrieval search to find the relevant context (details introduced later).
Therefore, it is necessary to compress the information in a <span class="ltx_text ltx_font_italic" id="S3.SS1.p6.13.2">structured</span> manner, so that the higher-level embeddings point to different parts of the lower-level embeddings.
To do so, we modify the standard causal attention mask to <span class="ltx_text ltx_font_italic" id="S3.SS1.p6.13.3">segmented attention mask</span>.
Specifically, let <math alttext="[{\bm{x}},{\bm{m}}]" class="ltx_Math" display="inline" id="S3.SS1.p6.1.m1.2"><semantics id="S3.SS1.p6.1.m1.2a"><mrow id="S3.SS1.p6.1.m1.2.3.2" xref="S3.SS1.p6.1.m1.2.3.1.cmml"><mo id="S3.SS1.p6.1.m1.2.3.2.1" stretchy="false" xref="S3.SS1.p6.1.m1.2.3.1.cmml">[</mo><mi id="S3.SS1.p6.1.m1.1.1" xref="S3.SS1.p6.1.m1.1.1.cmml">𝒙</mi><mo id="S3.SS1.p6.1.m1.2.3.2.2" xref="S3.SS1.p6.1.m1.2.3.1.cmml">,</mo><mi id="S3.SS1.p6.1.m1.2.2" xref="S3.SS1.p6.1.m1.2.2.cmml">𝒎</mi><mo id="S3.SS1.p6.1.m1.2.3.2.3" stretchy="false" xref="S3.SS1.p6.1.m1.2.3.1.cmml">]</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.1.m1.2b"><interval closure="closed" id="S3.SS1.p6.1.m1.2.3.1.cmml" xref="S3.SS1.p6.1.m1.2.3.2"><ci id="S3.SS1.p6.1.m1.1.1.cmml" xref="S3.SS1.p6.1.m1.1.1">𝒙</ci><ci id="S3.SS1.p6.1.m1.2.2.cmml" xref="S3.SS1.p6.1.m1.2.2">𝒎</ci></interval></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.1.m1.2c">[{\bm{x}},{\bm{m}}]</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.1.m1.2d">[ bold_italic_x , bold_italic_m ]</annotation></semantics></math> be the sequence to the compressed, and <math alttext="m_{j}" class="ltx_Math" display="inline" id="S3.SS1.p6.2.m2.1"><semantics id="S3.SS1.p6.2.m2.1a"><msub id="S3.SS1.p6.2.m2.1.1" xref="S3.SS1.p6.2.m2.1.1.cmml"><mi id="S3.SS1.p6.2.m2.1.1.2" xref="S3.SS1.p6.2.m2.1.1.2.cmml">m</mi><mi id="S3.SS1.p6.2.m2.1.1.3" xref="S3.SS1.p6.2.m2.1.1.3.cmml">j</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.2.m2.1b"><apply id="S3.SS1.p6.2.m2.1.1.cmml" xref="S3.SS1.p6.2.m2.1.1"><csymbol cd="ambiguous" id="S3.SS1.p6.2.m2.1.1.1.cmml" xref="S3.SS1.p6.2.m2.1.1">subscript</csymbol><ci id="S3.SS1.p6.2.m2.1.1.2.cmml" xref="S3.SS1.p6.2.m2.1.1.2">𝑚</ci><ci id="S3.SS1.p6.2.m2.1.1.3.cmml" xref="S3.SS1.p6.2.m2.1.1.3">𝑗</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.2.m2.1c">m_{j}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.2.m2.1d">italic_m start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT</annotation></semantics></math> be the <math alttext="j" class="ltx_Math" display="inline" id="S3.SS1.p6.3.m3.1"><semantics id="S3.SS1.p6.3.m3.1a"><mi id="S3.SS1.p6.3.m3.1.1" xref="S3.SS1.p6.3.m3.1.1.cmml">j</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.3.m3.1b"><ci id="S3.SS1.p6.3.m3.1.1.cmml" xref="S3.SS1.p6.3.m3.1.1">𝑗</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.3.m3.1c">j</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.3.m3.1d">italic_j</annotation></semantics></math>th <span class="ltx_text ltx_font_typewriter" id="S3.SS1.p6.13.4">&lt;mem&gt;</span> token of <math alttext="{\bm{m}}" class="ltx_Math" display="inline" id="S3.SS1.p6.4.m4.1"><semantics id="S3.SS1.p6.4.m4.1a"><mi id="S3.SS1.p6.4.m4.1.1" xref="S3.SS1.p6.4.m4.1.1.cmml">𝒎</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.4.m4.1b"><ci id="S3.SS1.p6.4.m4.1.1.cmml" xref="S3.SS1.p6.4.m4.1.1">𝒎</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.4.m4.1c">{\bm{m}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.4.m4.1d">bold_italic_m</annotation></semantics></math>.
The standard attention mask lets <math alttext="m_{j}" class="ltx_Math" display="inline" id="S3.SS1.p6.5.m5.1"><semantics id="S3.SS1.p6.5.m5.1a"><msub id="S3.SS1.p6.5.m5.1.1" xref="S3.SS1.p6.5.m5.1.1.cmml"><mi id="S3.SS1.p6.5.m5.1.1.2" xref="S3.SS1.p6.5.m5.1.1.2.cmml">m</mi><mi id="S3.SS1.p6.5.m5.1.1.3" xref="S3.SS1.p6.5.m5.1.1.3.cmml">j</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.5.m5.1b"><apply id="S3.SS1.p6.5.m5.1.1.cmml" xref="S3.SS1.p6.5.m5.1.1"><csymbol cd="ambiguous" id="S3.SS1.p6.5.m5.1.1.1.cmml" xref="S3.SS1.p6.5.m5.1.1">subscript</csymbol><ci id="S3.SS1.p6.5.m5.1.1.2.cmml" xref="S3.SS1.p6.5.m5.1.1.2">𝑚</ci><ci id="S3.SS1.p6.5.m5.1.1.3.cmml" xref="S3.SS1.p6.5.m5.1.1.3">𝑗</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.5.m5.1c">m_{j}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.5.m5.1d">italic_m start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT</annotation></semantics></math> attend to the full sequence <math alttext="{\bm{x}}" class="ltx_Math" display="inline" id="S3.SS1.p6.6.m6.1"><semantics id="S3.SS1.p6.6.m6.1a"><mi id="S3.SS1.p6.6.m6.1.1" xref="S3.SS1.p6.6.m6.1.1.cmml">𝒙</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.6.m6.1b"><ci id="S3.SS1.p6.6.m6.1.1.cmml" xref="S3.SS1.p6.6.m6.1.1">𝒙</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.6.m6.1c">{\bm{x}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.6.m6.1d">bold_italic_x</annotation></semantics></math>. However, if done this way, once <math alttext="m_{j}" class="ltx_Math" display="inline" id="S3.SS1.p6.7.m7.1"><semantics id="S3.SS1.p6.7.m7.1a"><msub id="S3.SS1.p6.7.m7.1.1" xref="S3.SS1.p6.7.m7.1.1.cmml"><mi id="S3.SS1.p6.7.m7.1.1.2" xref="S3.SS1.p6.7.m7.1.1.2.cmml">m</mi><mi id="S3.SS1.p6.7.m7.1.1.3" xref="S3.SS1.p6.7.m7.1.1.3.cmml">j</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.7.m7.1b"><apply id="S3.SS1.p6.7.m7.1.1.cmml" xref="S3.SS1.p6.7.m7.1.1"><csymbol cd="ambiguous" id="S3.SS1.p6.7.m7.1.1.1.cmml" xref="S3.SS1.p6.7.m7.1.1">subscript</csymbol><ci id="S3.SS1.p6.7.m7.1.1.2.cmml" xref="S3.SS1.p6.7.m7.1.1.2">𝑚</ci><ci id="S3.SS1.p6.7.m7.1.1.3.cmml" xref="S3.SS1.p6.7.m7.1.1.3">𝑗</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.7.m7.1c">m_{j}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.7.m7.1d">italic_m start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT</annotation></semantics></math> is picked in the retrieval phase, it is unclear which part it attends to, making it difficult to narrow down the parts to be retrieved.
Instead, we make <math alttext="m_{j}" class="ltx_Math" display="inline" id="S3.SS1.p6.8.m8.1"><semantics id="S3.SS1.p6.8.m8.1a"><msub id="S3.SS1.p6.8.m8.1.1" xref="S3.SS1.p6.8.m8.1.1.cmml"><mi id="S3.SS1.p6.8.m8.1.1.2" xref="S3.SS1.p6.8.m8.1.1.2.cmml">m</mi><mi id="S3.SS1.p6.8.m8.1.1.3" xref="S3.SS1.p6.8.m8.1.1.3.cmml">j</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.8.m8.1b"><apply id="S3.SS1.p6.8.m8.1.1.cmml" xref="S3.SS1.p6.8.m8.1.1"><csymbol cd="ambiguous" id="S3.SS1.p6.8.m8.1.1.1.cmml" xref="S3.SS1.p6.8.m8.1.1">subscript</csymbol><ci id="S3.SS1.p6.8.m8.1.1.2.cmml" xref="S3.SS1.p6.8.m8.1.1.2">𝑚</ci><ci id="S3.SS1.p6.8.m8.1.1.3.cmml" xref="S3.SS1.p6.8.m8.1.1.3">𝑗</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.8.m8.1c">m_{j}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.8.m8.1d">italic_m start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT</annotation></semantics></math> attend to a certain segment of <math alttext="{\bm{x}}" class="ltx_Math" display="inline" id="S3.SS1.p6.9.m9.1"><semantics id="S3.SS1.p6.9.m9.1a"><mi id="S3.SS1.p6.9.m9.1.1" xref="S3.SS1.p6.9.m9.1.1.cmml">𝒙</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.9.m9.1b"><ci id="S3.SS1.p6.9.m9.1.1.cmml" xref="S3.SS1.p6.9.m9.1.1">𝒙</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.9.m9.1c">{\bm{x}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.9.m9.1d">bold_italic_x</annotation></semantics></math>. There could be many ways to arrange the segmentation, and in this work, we first investigate a simple scheme, where <math alttext="{\bm{x}}" class="ltx_Math" display="inline" id="S3.SS1.p6.10.m10.1"><semantics id="S3.SS1.p6.10.m10.1a"><mi id="S3.SS1.p6.10.m10.1.1" xref="S3.SS1.p6.10.m10.1.1.cmml">𝒙</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.10.m10.1b"><ci id="S3.SS1.p6.10.m10.1.1.cmml" xref="S3.SS1.p6.10.m10.1.1">𝒙</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.10.m10.1c">{\bm{x}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.10.m10.1d">bold_italic_x</annotation></semantics></math> is split sequentially into segments of length <math alttext="k" class="ltx_Math" display="inline" id="S3.SS1.p6.11.m11.1"><semantics id="S3.SS1.p6.11.m11.1a"><mi id="S3.SS1.p6.11.m11.1.1" xref="S3.SS1.p6.11.m11.1.1.cmml">k</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.11.m11.1b"><ci id="S3.SS1.p6.11.m11.1.1.cmml" xref="S3.SS1.p6.11.m11.1.1">𝑘</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.11.m11.1c">k</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.11.m11.1d">italic_k</annotation></semantics></math>, and <math alttext="m_{j}" class="ltx_Math" display="inline" id="S3.SS1.p6.12.m12.1"><semantics id="S3.SS1.p6.12.m12.1a"><msub id="S3.SS1.p6.12.m12.1.1" xref="S3.SS1.p6.12.m12.1.1.cmml"><mi id="S3.SS1.p6.12.m12.1.1.2" xref="S3.SS1.p6.12.m12.1.1.2.cmml">m</mi><mi id="S3.SS1.p6.12.m12.1.1.3" xref="S3.SS1.p6.12.m12.1.1.3.cmml">j</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.12.m12.1b"><apply id="S3.SS1.p6.12.m12.1.1.cmml" xref="S3.SS1.p6.12.m12.1.1"><csymbol cd="ambiguous" id="S3.SS1.p6.12.m12.1.1.1.cmml" xref="S3.SS1.p6.12.m12.1.1">subscript</csymbol><ci id="S3.SS1.p6.12.m12.1.1.2.cmml" xref="S3.SS1.p6.12.m12.1.1.2">𝑚</ci><ci id="S3.SS1.p6.12.m12.1.1.3.cmml" xref="S3.SS1.p6.12.m12.1.1.3">𝑗</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.12.m12.1c">m_{j}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.12.m12.1d">italic_m start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT</annotation></semantics></math> attends to the segment <math alttext="[x_{k*(j-1)},...,x_{k*j}]" class="ltx_Math" display="inline" id="S3.SS1.p6.13.m13.4"><semantics id="S3.SS1.p6.13.m13.4a"><mrow id="S3.SS1.p6.13.m13.4.4.2" xref="S3.SS1.p6.13.m13.4.4.3.cmml"><mo id="S3.SS1.p6.13.m13.4.4.2.3" stretchy="false" xref="S3.SS1.p6.13.m13.4.4.3.cmml">[</mo><msub id="S3.SS1.p6.13.m13.3.3.1.1" xref="S3.SS1.p6.13.m13.3.3.1.1.cmml"><mi id="S3.SS1.p6.13.m13.3.3.1.1.2" xref="S3.SS1.p6.13.m13.3.3.1.1.2.cmml">x</mi><mrow id="S3.SS1.p6.13.m13.1.1.1" xref="S3.SS1.p6.13.m13.1.1.1.cmml"><mi id="S3.SS1.p6.13.m13.1.1.1.3" xref="S3.SS1.p6.13.m13.1.1.1.3.cmml">k</mi><mo id="S3.SS1.p6.13.m13.1.1.1.2" lspace="0.222em" rspace="0.222em" xref="S3.SS1.p6.13.m13.1.1.1.2.cmml">∗</mo><mrow id="S3.SS1.p6.13.m13.1.1.1.1.1" xref="S3.SS1.p6.13.m13.1.1.1.1.1.1.cmml"><mo id="S3.SS1.p6.13.m13.1.1.1.1.1.2" stretchy="false" xref="S3.SS1.p6.13.m13.1.1.1.1.1.1.cmml">(</mo><mrow id="S3.SS1.p6.13.m13.1.1.1.1.1.1" xref="S3.SS1.p6.13.m13.1.1.1.1.1.1.cmml"><mi id="S3.SS1.p6.13.m13.1.1.1.1.1.1.2" xref="S3.SS1.p6.13.m13.1.1.1.1.1.1.2.cmml">j</mi><mo id="S3.SS1.p6.13.m13.1.1.1.1.1.1.1" xref="S3.SS1.p6.13.m13.1.1.1.1.1.1.1.cmml">−</mo><mn id="S3.SS1.p6.13.m13.1.1.1.1.1.1.3" xref="S3.SS1.p6.13.m13.1.1.1.1.1.1.3.cmml">1</mn></mrow><mo id="S3.SS1.p6.13.m13.1.1.1.1.1.3" stretchy="false" xref="S3.SS1.p6.13.m13.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></msub><mo id="S3.SS1.p6.13.m13.4.4.2.4" xref="S3.SS1.p6.13.m13.4.4.3.cmml">,</mo><mi id="S3.SS1.p6.13.m13.2.2" mathvariant="normal" xref="S3.SS1.p6.13.m13.2.2.cmml">…</mi><mo id="S3.SS1.p6.13.m13.4.4.2.5" xref="S3.SS1.p6.13.m13.4.4.3.cmml">,</mo><msub id="S3.SS1.p6.13.m13.4.4.2.2" xref="S3.SS1.p6.13.m13.4.4.2.2.cmml"><mi id="S3.SS1.p6.13.m13.4.4.2.2.2" xref="S3.SS1.p6.13.m13.4.4.2.2.2.cmml">x</mi><mrow id="S3.SS1.p6.13.m13.4.4.2.2.3" xref="S3.SS1.p6.13.m13.4.4.2.2.3.cmml"><mi id="S3.SS1.p6.13.m13.4.4.2.2.3.2" xref="S3.SS1.p6.13.m13.4.4.2.2.3.2.cmml">k</mi><mo id="S3.SS1.p6.13.m13.4.4.2.2.3.1" lspace="0.222em" rspace="0.222em" xref="S3.SS1.p6.13.m13.4.4.2.2.3.1.cmml">∗</mo><mi id="S3.SS1.p6.13.m13.4.4.2.2.3.3" xref="S3.SS1.p6.13.m13.4.4.2.2.3.3.cmml">j</mi></mrow></msub><mo id="S3.SS1.p6.13.m13.4.4.2.6" stretchy="false" xref="S3.SS1.p6.13.m13.4.4.3.cmml">]</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p6.13.m13.4b"><list id="S3.SS1.p6.13.m13.4.4.3.cmml" xref="S3.SS1.p6.13.m13.4.4.2"><apply id="S3.SS1.p6.13.m13.3.3.1.1.cmml" xref="S3.SS1.p6.13.m13.3.3.1.1"><csymbol cd="ambiguous" id="S3.SS1.p6.13.m13.3.3.1.1.1.cmml" xref="S3.SS1.p6.13.m13.3.3.1.1">subscript</csymbol><ci id="S3.SS1.p6.13.m13.3.3.1.1.2.cmml" xref="S3.SS1.p6.13.m13.3.3.1.1.2">𝑥</ci><apply id="S3.SS1.p6.13.m13.1.1.1.cmml" xref="S3.SS1.p6.13.m13.1.1.1"><times id="S3.SS1.p6.13.m13.1.1.1.2.cmml" xref="S3.SS1.p6.13.m13.1.1.1.2"></times><ci id="S3.SS1.p6.13.m13.1.1.1.3.cmml" xref="S3.SS1.p6.13.m13.1.1.1.3">𝑘</ci><apply id="S3.SS1.p6.13.m13.1.1.1.1.1.1.cmml" xref="S3.SS1.p6.13.m13.1.1.1.1.1"><minus id="S3.SS1.p6.13.m13.1.1.1.1.1.1.1.cmml" xref="S3.SS1.p6.13.m13.1.1.1.1.1.1.1"></minus><ci id="S3.SS1.p6.13.m13.1.1.1.1.1.1.2.cmml" xref="S3.SS1.p6.13.m13.1.1.1.1.1.1.2">𝑗</ci><cn id="S3.SS1.p6.13.m13.1.1.1.1.1.1.3.cmml" type="integer" xref="S3.SS1.p6.13.m13.1.1.1.1.1.1.3">1</cn></apply></apply></apply><ci id="S3.SS1.p6.13.m13.2.2.cmml" xref="S3.SS1.p6.13.m13.2.2">…</ci><apply id="S3.SS1.p6.13.m13.4.4.2.2.cmml" xref="S3.SS1.p6.13.m13.4.4.2.2"><csymbol cd="ambiguous" id="S3.SS1.p6.13.m13.4.4.2.2.1.cmml" xref="S3.SS1.p6.13.m13.4.4.2.2">subscript</csymbol><ci id="S3.SS1.p6.13.m13.4.4.2.2.2.cmml" xref="S3.SS1.p6.13.m13.4.4.2.2.2">𝑥</ci><apply id="S3.SS1.p6.13.m13.4.4.2.2.3.cmml" xref="S3.SS1.p6.13.m13.4.4.2.2.3"><times id="S3.SS1.p6.13.m13.4.4.2.2.3.1.cmml" xref="S3.SS1.p6.13.m13.4.4.2.2.3.1"></times><ci id="S3.SS1.p6.13.m13.4.4.2.2.3.2.cmml" xref="S3.SS1.p6.13.m13.4.4.2.2.3.2">𝑘</ci><ci id="S3.SS1.p6.13.m13.4.4.2.2.3.3.cmml" xref="S3.SS1.p6.13.m13.4.4.2.2.3.3">𝑗</ci></apply></apply></list></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p6.13.m13.4c">[x_{k*(j-1)},...,x_{k*j}]</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p6.13.m13.4d">[ italic_x start_POSTSUBSCRIPT italic_k ∗ ( italic_j - 1 ) end_POSTSUBSCRIPT , … , italic_x start_POSTSUBSCRIPT italic_k ∗ italic_j end_POSTSUBSCRIPT ]</annotation></semantics></math>.
We find this scheme is effective and we leave investigation on more advanced schemes in future work.
We illustrate the corresponding attention mask in Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S3.F3" title="Figure 3 ‣ 3.1 Compressor ‣ 3 Method ‣ The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_tag">3</span></a>.</p>
</div>
</section>
<section class="ltx_subsection" id="S3.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">3.2 </span>Retriever</h3>
<div class="ltx_para ltx_noindent" id="S3.SS2.p1">
<p class="ltx_p" id="S3.SS2.p1.1">We now show how to retrieve the context from the hierarchical database.
Similar to the compressor, we exclusively use the base model and its forward function in this process.
This sets us apart from prior work such as retrieval-augmented generation (RAG), which relies on an external small model to index and retrieve the context.
We argue that such a design can fully exploit the capability of the base model and impose least changes to the model’s architecture, making it easy for fine-tuning.</p>
</div>
<div class="ltx_para ltx_noindent" id="S3.SS2.p2">
<p class="ltx_p" id="S3.SS2.p2.2">The retrieval process starts by encoding the current context into retrieval embeddings which will be used to hold the retrieved information.
Let <math alttext="{\bm{x}}" class="ltx_Math" display="inline" id="S3.SS2.p2.1.m1.1"><semantics id="S3.SS2.p2.1.m1.1a"><mi id="S3.SS2.p2.1.m1.1.1" xref="S3.SS2.p2.1.m1.1.1.cmml">𝒙</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p2.1.m1.1b"><ci id="S3.SS2.p2.1.m1.1.1.cmml" xref="S3.SS2.p2.1.m1.1.1">𝒙</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p2.1.m1.1c">{\bm{x}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p2.1.m1.1d">bold_italic_x</annotation></semantics></math> be the current context and <math alttext="r=``\texttt{&lt;ret&gt;}\text{''}" class="ltx_Math" display="inline" id="S3.SS2.p2.2.m2.1"><semantics id="S3.SS2.p2.2.m2.1a"><mrow id="S3.SS2.p2.2.m2.1.1" xref="S3.SS2.p2.2.m2.1.1.cmml"><mi id="S3.SS2.p2.2.m2.1.1.2" xref="S3.SS2.p2.2.m2.1.1.2.cmml">r</mi><mo id="S3.SS2.p2.2.m2.1.1.1" xref="S3.SS2.p2.2.m2.1.1.1.cmml">=</mo><mrow id="S3.SS2.p2.2.m2.1.1.3" xref="S3.SS2.p2.2.m2.1.1.3.cmml"><mi id="S3.SS2.p2.2.m2.1.1.3.2" mathvariant="normal" xref="S3.SS2.p2.2.m2.1.1.3.2.cmml">`</mi><mo id="S3.SS2.p2.2.m2.1.1.3.1" xref="S3.SS2.p2.2.m2.1.1.3.1.cmml">⁢</mo><mi id="S3.SS2.p2.2.m2.1.1.3.3" mathvariant="normal" xref="S3.SS2.p2.2.m2.1.1.3.3.cmml">`</mi><mo id="S3.SS2.p2.2.m2.1.1.3.1a" xref="S3.SS2.p2.2.m2.1.1.3.1.cmml">⁢</mo><mrow id="S3.SS2.p2.2.m2.1.1.3.4" xref="S3.SS2.p2.2.m2.1.1.3.4c.cmml"><mtext class="ltx_mathvariant_monospace" id="S3.SS2.p2.2.m2.1.1.3.4a" xref="S3.SS2.p2.2.m2.1.1.3.4c.cmml">&lt;ret&gt;</mtext><mtext id="S3.SS2.p2.2.m2.1.1.3.4b" xref="S3.SS2.p2.2.m2.1.1.3.4c.cmml">”</mtext></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p2.2.m2.1b"><apply id="S3.SS2.p2.2.m2.1.1.cmml" xref="S3.SS2.p2.2.m2.1.1"><eq id="S3.SS2.p2.2.m2.1.1.1.cmml" xref="S3.SS2.p2.2.m2.1.1.1"></eq><ci id="S3.SS2.p2.2.m2.1.1.2.cmml" xref="S3.SS2.p2.2.m2.1.1.2">𝑟</ci><apply id="S3.SS2.p2.2.m2.1.1.3.cmml" xref="S3.SS2.p2.2.m2.1.1.3"><times id="S3.SS2.p2.2.m2.1.1.3.1.cmml" xref="S3.SS2.p2.2.m2.1.1.3.1"></times><ci id="S3.SS2.p2.2.m2.1.1.3.2.cmml" xref="S3.SS2.p2.2.m2.1.1.3.2">`</ci><ci id="S3.SS2.p2.2.m2.1.1.3.3.cmml" xref="S3.SS2.p2.2.m2.1.1.3.3">`</ci><ci id="S3.SS2.p2.2.m2.1.1.3.4c.cmml" xref="S3.SS2.p2.2.m2.1.1.3.4"><mrow id="S3.SS2.p2.2.m2.1.1.3.4.cmml" xref="S3.SS2.p2.2.m2.1.1.3.4"><mtext class="ltx_mathvariant_monospace" id="S3.SS2.p2.2.m2.1.1.3.4a.cmml" xref="S3.SS2.p2.2.m2.1.1.3.4">&lt;ret&gt;</mtext><mtext id="S3.SS2.p2.2.m2.1.1.3.4b.cmml" xref="S3.SS2.p2.2.m2.1.1.3.4">”</mtext></mrow></ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p2.2.m2.1c">r=``\texttt{&lt;ret&gt;}\text{''}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p2.2.m2.1d">italic_r = ` ` typewriter_&lt;ret&gt; ”</annotation></semantics></math> be the special retrieval tokens, we have</p>
<table class="ltx_equation ltx_eqn_table" id="S3.Ex4">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="[\ \_\ ,\tilde{{\bm{r}}}]\leftarrow f_{\text{llm}}([{\bm{x}},{\bm{r}}])," class="ltx_Math" display="block" id="S3.Ex4.m1.5"><semantics id="S3.Ex4.m1.5a"><mrow id="S3.Ex4.m1.5.5.1" xref="S3.Ex4.m1.5.5.1.1.cmml"><mrow id="S3.Ex4.m1.5.5.1.1" xref="S3.Ex4.m1.5.5.1.1.cmml"><mrow id="S3.Ex4.m1.5.5.1.1.3.2" xref="S3.Ex4.m1.5.5.1.1.3.1.cmml"><mo id="S3.Ex4.m1.5.5.1.1.3.2.1" rspace="0.500em" stretchy="false" xref="S3.Ex4.m1.5.5.1.1.3.1.cmml">[</mo><mi id="S3.Ex4.m1.1.1" mathvariant="normal" xref="S3.Ex4.m1.1.1.cmml">_</mi><mo id="S3.Ex4.m1.5.5.1.1.3.2.2" lspace="0.500em" xref="S3.Ex4.m1.5.5.1.1.3.1.cmml">,</mo><mover accent="true" id="S3.Ex4.m1.2.2" xref="S3.Ex4.m1.2.2.cmml"><mi id="S3.Ex4.m1.2.2.2" xref="S3.Ex4.m1.2.2.2.cmml">𝒓</mi><mo id="S3.Ex4.m1.2.2.1" xref="S3.Ex4.m1.2.2.1.cmml">~</mo></mover><mo id="S3.Ex4.m1.5.5.1.1.3.2.3" stretchy="false" xref="S3.Ex4.m1.5.5.1.1.3.1.cmml">]</mo></mrow><mo id="S3.Ex4.m1.5.5.1.1.2" stretchy="false" xref="S3.Ex4.m1.5.5.1.1.2.cmml">←</mo><mrow id="S3.Ex4.m1.5.5.1.1.1" xref="S3.Ex4.m1.5.5.1.1.1.cmml"><msub id="S3.Ex4.m1.5.5.1.1.1.3" xref="S3.Ex4.m1.5.5.1.1.1.3.cmml"><mi id="S3.Ex4.m1.5.5.1.1.1.3.2" xref="S3.Ex4.m1.5.5.1.1.1.3.2.cmml">f</mi><mtext id="S3.Ex4.m1.5.5.1.1.1.3.3" xref="S3.Ex4.m1.5.5.1.1.1.3.3a.cmml">llm</mtext></msub><mo id="S3.Ex4.m1.5.5.1.1.1.2" xref="S3.Ex4.m1.5.5.1.1.1.2.cmml">⁢</mo><mrow id="S3.Ex4.m1.5.5.1.1.1.1.1" xref="S3.Ex4.m1.5.5.1.1.1.cmml"><mo id="S3.Ex4.m1.5.5.1.1.1.1.1.2" stretchy="false" xref="S3.Ex4.m1.5.5.1.1.1.cmml">(</mo><mrow id="S3.Ex4.m1.5.5.1.1.1.1.1.1.2" xref="S3.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml"><mo id="S3.Ex4.m1.5.5.1.1.1.1.1.1.2.1" stretchy="false" xref="S3.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml">[</mo><mi id="S3.Ex4.m1.3.3" xref="S3.Ex4.m1.3.3.cmml">𝒙</mi><mo id="S3.Ex4.m1.5.5.1.1.1.1.1.1.2.2" xref="S3.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml">,</mo><mi id="S3.Ex4.m1.4.4" xref="S3.Ex4.m1.4.4.cmml">𝒓</mi><mo id="S3.Ex4.m1.5.5.1.1.1.1.1.1.2.3" stretchy="false" xref="S3.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml">]</mo></mrow><mo id="S3.Ex4.m1.5.5.1.1.1.1.1.3" stretchy="false" xref="S3.Ex4.m1.5.5.1.1.1.cmml">)</mo></mrow></mrow></mrow><mo id="S3.Ex4.m1.5.5.1.2" xref="S3.Ex4.m1.5.5.1.1.cmml">,</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.Ex4.m1.5b"><apply id="S3.Ex4.m1.5.5.1.1.cmml" xref="S3.Ex4.m1.5.5.1"><ci id="S3.Ex4.m1.5.5.1.1.2.cmml" xref="S3.Ex4.m1.5.5.1.1.2">←</ci><interval closure="closed" id="S3.Ex4.m1.5.5.1.1.3.1.cmml" xref="S3.Ex4.m1.5.5.1.1.3.2"><ci id="S3.Ex4.m1.1.1.cmml" xref="S3.Ex4.m1.1.1">_</ci><apply id="S3.Ex4.m1.2.2.cmml" xref="S3.Ex4.m1.2.2"><ci id="S3.Ex4.m1.2.2.1.cmml" xref="S3.Ex4.m1.2.2.1">~</ci><ci id="S3.Ex4.m1.2.2.2.cmml" xref="S3.Ex4.m1.2.2.2">𝒓</ci></apply></interval><apply id="S3.Ex4.m1.5.5.1.1.1.cmml" xref="S3.Ex4.m1.5.5.1.1.1"><times id="S3.Ex4.m1.5.5.1.1.1.2.cmml" xref="S3.Ex4.m1.5.5.1.1.1.2"></times><apply id="S3.Ex4.m1.5.5.1.1.1.3.cmml" xref="S3.Ex4.m1.5.5.1.1.1.3"><csymbol cd="ambiguous" id="S3.Ex4.m1.5.5.1.1.1.3.1.cmml" xref="S3.Ex4.m1.5.5.1.1.1.3">subscript</csymbol><ci id="S3.Ex4.m1.5.5.1.1.1.3.2.cmml" xref="S3.Ex4.m1.5.5.1.1.1.3.2">𝑓</ci><ci id="S3.Ex4.m1.5.5.1.1.1.3.3a.cmml" xref="S3.Ex4.m1.5.5.1.1.1.3.3"><mtext id="S3.Ex4.m1.5.5.1.1.1.3.3.cmml" mathsize="70%" xref="S3.Ex4.m1.5.5.1.1.1.3.3">llm</mtext></ci></apply><interval closure="closed" id="S3.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml" xref="S3.Ex4.m1.5.5.1.1.1.1.1.1.2"><ci id="S3.Ex4.m1.3.3.cmml" xref="S3.Ex4.m1.3.3">𝒙</ci><ci id="S3.Ex4.m1.4.4.cmml" xref="S3.Ex4.m1.4.4">𝒓</ci></interval></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.Ex4.m1.5c">[\ \_\ ,\tilde{{\bm{r}}}]\leftarrow f_{\text{llm}}([{\bm{x}},{\bm{r}}]),</annotation><annotation encoding="application/x-llamapun" id="S3.Ex4.m1.5d">[ _ , over~ start_ARG bold_italic_r end_ARG ] ← italic_f start_POSTSUBSCRIPT llm end_POSTSUBSCRIPT ( [ bold_italic_x , bold_italic_r ] ) ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S3.SS2.p2.7">where
<math alttext="{\bm{r}}=[r_{1},r_{2},...]" class="ltx_Math" display="inline" id="S3.SS2.p2.3.m1.3"><semantics id="S3.SS2.p2.3.m1.3a"><mrow id="S3.SS2.p2.3.m1.3.3" xref="S3.SS2.p2.3.m1.3.3.cmml"><mi id="S3.SS2.p2.3.m1.3.3.4" xref="S3.SS2.p2.3.m1.3.3.4.cmml">𝒓</mi><mo id="S3.SS2.p2.3.m1.3.3.3" xref="S3.SS2.p2.3.m1.3.3.3.cmml">=</mo><mrow id="S3.SS2.p2.3.m1.3.3.2.2" xref="S3.SS2.p2.3.m1.3.3.2.3.cmml"><mo id="S3.SS2.p2.3.m1.3.3.2.2.3" stretchy="false" xref="S3.SS2.p2.3.m1.3.3.2.3.cmml">[</mo><msub id="S3.SS2.p2.3.m1.2.2.1.1.1" xref="S3.SS2.p2.3.m1.2.2.1.1.1.cmml"><mi id="S3.SS2.p2.3.m1.2.2.1.1.1.2" xref="S3.SS2.p2.3.m1.2.2.1.1.1.2.cmml">r</mi><mn id="S3.SS2.p2.3.m1.2.2.1.1.1.3" xref="S3.SS2.p2.3.m1.2.2.1.1.1.3.cmml">1</mn></msub><mo id="S3.SS2.p2.3.m1.3.3.2.2.4" xref="S3.SS2.p2.3.m1.3.3.2.3.cmml">,</mo><msub id="S3.SS2.p2.3.m1.3.3.2.2.2" xref="S3.SS2.p2.3.m1.3.3.2.2.2.cmml"><mi id="S3.SS2.p2.3.m1.3.3.2.2.2.2" xref="S3.SS2.p2.3.m1.3.3.2.2.2.2.cmml">r</mi><mn id="S3.SS2.p2.3.m1.3.3.2.2.2.3" xref="S3.SS2.p2.3.m1.3.3.2.2.2.3.cmml">2</mn></msub><mo id="S3.SS2.p2.3.m1.3.3.2.2.5" xref="S3.SS2.p2.3.m1.3.3.2.3.cmml">,</mo><mi id="S3.SS2.p2.3.m1.1.1" mathvariant="normal" xref="S3.SS2.p2.3.m1.1.1.cmml">…</mi><mo id="S3.SS2.p2.3.m1.3.3.2.2.6" stretchy="false" xref="S3.SS2.p2.3.m1.3.3.2.3.cmml">]</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p2.3.m1.3b"><apply id="S3.SS2.p2.3.m1.3.3.cmml" xref="S3.SS2.p2.3.m1.3.3"><eq id="S3.SS2.p2.3.m1.3.3.3.cmml" xref="S3.SS2.p2.3.m1.3.3.3"></eq><ci id="S3.SS2.p2.3.m1.3.3.4.cmml" xref="S3.SS2.p2.3.m1.3.3.4">𝒓</ci><list id="S3.SS2.p2.3.m1.3.3.2.3.cmml" xref="S3.SS2.p2.3.m1.3.3.2.2"><apply id="S3.SS2.p2.3.m1.2.2.1.1.1.cmml" xref="S3.SS2.p2.3.m1.2.2.1.1.1"><csymbol cd="ambiguous" id="S3.SS2.p2.3.m1.2.2.1.1.1.1.cmml" xref="S3.SS2.p2.3.m1.2.2.1.1.1">subscript</csymbol><ci id="S3.SS2.p2.3.m1.2.2.1.1.1.2.cmml" xref="S3.SS2.p2.3.m1.2.2.1.1.1.2">𝑟</ci><cn id="S3.SS2.p2.3.m1.2.2.1.1.1.3.cmml" type="integer" xref="S3.SS2.p2.3.m1.2.2.1.1.1.3">1</cn></apply><apply id="S3.SS2.p2.3.m1.3.3.2.2.2.cmml" xref="S3.SS2.p2.3.m1.3.3.2.2.2"><csymbol cd="ambiguous" id="S3.SS2.p2.3.m1.3.3.2.2.2.1.cmml" xref="S3.SS2.p2.3.m1.3.3.2.2.2">subscript</csymbol><ci id="S3.SS2.p2.3.m1.3.3.2.2.2.2.cmml" xref="S3.SS2.p2.3.m1.3.3.2.2.2.2">𝑟</ci><cn id="S3.SS2.p2.3.m1.3.3.2.2.2.3.cmml" type="integer" xref="S3.SS2.p2.3.m1.3.3.2.2.2.3">2</cn></apply><ci id="S3.SS2.p2.3.m1.1.1.cmml" xref="S3.SS2.p2.3.m1.1.1">…</ci></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p2.3.m1.3c">{\bm{r}}=[r_{1},r_{2},...]</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p2.3.m1.3d">bold_italic_r = [ italic_r start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , italic_r start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT , … ]</annotation></semantics></math> is the appended sequence of <span class="ltx_text ltx_font_typewriter" id="S3.SS2.p2.7.1">&lt;ret&gt;</span> tokens,
<math alttext="\tilde{{\bm{r}}}" class="ltx_Math" display="inline" id="S3.SS2.p2.4.m2.1"><semantics id="S3.SS2.p2.4.m2.1a"><mover accent="true" id="S3.SS2.p2.4.m2.1.1" xref="S3.SS2.p2.4.m2.1.1.cmml"><mi id="S3.SS2.p2.4.m2.1.1.2" xref="S3.SS2.p2.4.m2.1.1.2.cmml">𝒓</mi><mo id="S3.SS2.p2.4.m2.1.1.1" xref="S3.SS2.p2.4.m2.1.1.1.cmml">~</mo></mover><annotation-xml encoding="MathML-Content" id="S3.SS2.p2.4.m2.1b"><apply id="S3.SS2.p2.4.m2.1.1.cmml" xref="S3.SS2.p2.4.m2.1.1"><ci id="S3.SS2.p2.4.m2.1.1.1.cmml" xref="S3.SS2.p2.4.m2.1.1.1">~</ci><ci id="S3.SS2.p2.4.m2.1.1.2.cmml" xref="S3.SS2.p2.4.m2.1.1.2">𝒓</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p2.4.m2.1c">\tilde{{\bm{r}}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p2.4.m2.1d">over~ start_ARG bold_italic_r end_ARG</annotation></semantics></math> is the corresponding retrieval embeddings,
and <math alttext="\_" class="ltx_Math" display="inline" id="S3.SS2.p2.5.m3.1"><semantics id="S3.SS2.p2.5.m3.1a"><mi id="S3.SS2.p2.5.m3.1.1" mathvariant="normal" xref="S3.SS2.p2.5.m3.1.1.cmml">_</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p2.5.m3.1b"><ci id="S3.SS2.p2.5.m3.1.1.cmml" xref="S3.SS2.p2.5.m3.1.1">_</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p2.5.m3.1c">\_</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p2.5.m3.1d">_</annotation></semantics></math> is the output corresponds to the <math alttext="{\bm{x}}" class="ltx_Math" display="inline" id="S3.SS2.p2.6.m4.1"><semantics id="S3.SS2.p2.6.m4.1a"><mi id="S3.SS2.p2.6.m4.1.1" xref="S3.SS2.p2.6.m4.1.1.cmml">𝒙</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p2.6.m4.1b"><ci id="S3.SS2.p2.6.m4.1.1.cmml" xref="S3.SS2.p2.6.m4.1.1">𝒙</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p2.6.m4.1c">{\bm{x}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p2.6.m4.1d">bold_italic_x</annotation></semantics></math> sequence, which we ignore.
Unlike the compression case, the size of <math alttext="\tilde{{\bm{r}}}" class="ltx_Math" display="inline" id="S3.SS2.p2.7.m5.1"><semantics id="S3.SS2.p2.7.m5.1a"><mover accent="true" id="S3.SS2.p2.7.m5.1.1" xref="S3.SS2.p2.7.m5.1.1.cmml"><mi id="S3.SS2.p2.7.m5.1.1.2" xref="S3.SS2.p2.7.m5.1.1.2.cmml">𝒓</mi><mo id="S3.SS2.p2.7.m5.1.1.1" xref="S3.SS2.p2.7.m5.1.1.1.cmml">~</mo></mover><annotation-xml encoding="MathML-Content" id="S3.SS2.p2.7.m5.1b"><apply id="S3.SS2.p2.7.m5.1.1.cmml" xref="S3.SS2.p2.7.m5.1.1"><ci id="S3.SS2.p2.7.m5.1.1.1.cmml" xref="S3.SS2.p2.7.m5.1.1.1">~</ci><ci id="S3.SS2.p2.7.m5.1.1.2.cmml" xref="S3.SS2.p2.7.m5.1.1.2">𝒓</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p2.7.m5.1c">\tilde{{\bm{r}}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p2.7.m5.1d">over~ start_ARG bold_italic_r end_ARG</annotation></semantics></math> should be as large as possible so that more context could be retrieved, however, it should also be bounded by the context window size and leave space for next token generation.
For example, for a 4K window with 1K context, one could designate 1K for the retrieved context and the rest 2K for generation.
That said, retrieval embedding size is a hyperparameter that is largely dependent on the hardware resource and the nature of the task, which should be determined in a case-by-case manner.</p>
</div>
<div class="ltx_para ltx_noindent" id="S3.SS2.p3">
<p class="ltx_p" id="S3.SS2.p3.7"><span class="ltx_text ltx_font_bold" id="S3.SS2.p3.7.1">Top-down sparse retrieval</span>.
Now we retrieve the relevant context starting from <math alttext="\tilde{{\bm{r}}}" class="ltx_Math" display="inline" id="S3.SS2.p3.1.m1.1"><semantics id="S3.SS2.p3.1.m1.1a"><mover accent="true" id="S3.SS2.p3.1.m1.1.1" xref="S3.SS2.p3.1.m1.1.1.cmml"><mi id="S3.SS2.p3.1.m1.1.1.2" xref="S3.SS2.p3.1.m1.1.1.2.cmml">𝒓</mi><mo id="S3.SS2.p3.1.m1.1.1.1" xref="S3.SS2.p3.1.m1.1.1.1.cmml">~</mo></mover><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.1.m1.1b"><apply id="S3.SS2.p3.1.m1.1.1.cmml" xref="S3.SS2.p3.1.m1.1.1"><ci id="S3.SS2.p3.1.m1.1.1.1.cmml" xref="S3.SS2.p3.1.m1.1.1.1">~</ci><ci id="S3.SS2.p3.1.m1.1.1.2.cmml" xref="S3.SS2.p3.1.m1.1.1.2">𝒓</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.1.m1.1c">\tilde{{\bm{r}}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.1.m1.1d">over~ start_ARG bold_italic_r end_ARG</annotation></semantics></math>.
Recall that the database stores all the past context chunks <math alttext="{\bm{x}}_{0},{\bm{x}}_{1},..." class="ltx_Math" display="inline" id="S3.SS2.p3.2.m2.3"><semantics id="S3.SS2.p3.2.m2.3a"><mrow id="S3.SS2.p3.2.m2.3.3.2" xref="S3.SS2.p3.2.m2.3.3.3.cmml"><msub id="S3.SS2.p3.2.m2.2.2.1.1" xref="S3.SS2.p3.2.m2.2.2.1.1.cmml"><mi id="S3.SS2.p3.2.m2.2.2.1.1.2" xref="S3.SS2.p3.2.m2.2.2.1.1.2.cmml">𝒙</mi><mn id="S3.SS2.p3.2.m2.2.2.1.1.3" xref="S3.SS2.p3.2.m2.2.2.1.1.3.cmml">0</mn></msub><mo id="S3.SS2.p3.2.m2.3.3.2.3" xref="S3.SS2.p3.2.m2.3.3.3.cmml">,</mo><msub id="S3.SS2.p3.2.m2.3.3.2.2" xref="S3.SS2.p3.2.m2.3.3.2.2.cmml"><mi id="S3.SS2.p3.2.m2.3.3.2.2.2" xref="S3.SS2.p3.2.m2.3.3.2.2.2.cmml">𝒙</mi><mn id="S3.SS2.p3.2.m2.3.3.2.2.3" xref="S3.SS2.p3.2.m2.3.3.2.2.3.cmml">1</mn></msub><mo id="S3.SS2.p3.2.m2.3.3.2.4" xref="S3.SS2.p3.2.m2.3.3.3.cmml">,</mo><mi id="S3.SS2.p3.2.m2.1.1" mathvariant="normal" xref="S3.SS2.p3.2.m2.1.1.cmml">…</mi></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.2.m2.3b"><list id="S3.SS2.p3.2.m2.3.3.3.cmml" xref="S3.SS2.p3.2.m2.3.3.2"><apply id="S3.SS2.p3.2.m2.2.2.1.1.cmml" xref="S3.SS2.p3.2.m2.2.2.1.1"><csymbol cd="ambiguous" id="S3.SS2.p3.2.m2.2.2.1.1.1.cmml" xref="S3.SS2.p3.2.m2.2.2.1.1">subscript</csymbol><ci id="S3.SS2.p3.2.m2.2.2.1.1.2.cmml" xref="S3.SS2.p3.2.m2.2.2.1.1.2">𝒙</ci><cn id="S3.SS2.p3.2.m2.2.2.1.1.3.cmml" type="integer" xref="S3.SS2.p3.2.m2.2.2.1.1.3">0</cn></apply><apply id="S3.SS2.p3.2.m2.3.3.2.2.cmml" xref="S3.SS2.p3.2.m2.3.3.2.2"><csymbol cd="ambiguous" id="S3.SS2.p3.2.m2.3.3.2.2.1.cmml" xref="S3.SS2.p3.2.m2.3.3.2.2">subscript</csymbol><ci id="S3.SS2.p3.2.m2.3.3.2.2.2.cmml" xref="S3.SS2.p3.2.m2.3.3.2.2.2">𝒙</ci><cn id="S3.SS2.p3.2.m2.3.3.2.2.3.cmml" type="integer" xref="S3.SS2.p3.2.m2.3.3.2.2.3">1</cn></apply><ci id="S3.SS2.p3.2.m2.1.1.cmml" xref="S3.SS2.p3.2.m2.1.1">…</ci></list></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.2.m2.3c">{\bm{x}}_{0},{\bm{x}}_{1},...</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.2.m2.3d">bold_italic_x start_POSTSUBSCRIPT 0 end_POSTSUBSCRIPT , bold_italic_x start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , …</annotation></semantics></math>, with each chunk also represented by a memory hierarchy <math alttext="[\tilde{{\bm{m}}}_{0},\tilde{{\bm{m}}}_{1},...,\tilde{{\bm{m}}}_{L}]" class="ltx_Math" display="inline" id="S3.SS2.p3.3.m3.4"><semantics id="S3.SS2.p3.3.m3.4a"><mrow id="S3.SS2.p3.3.m3.4.4.3" xref="S3.SS2.p3.3.m3.4.4.4.cmml"><mo id="S3.SS2.p3.3.m3.4.4.3.4" stretchy="false" xref="S3.SS2.p3.3.m3.4.4.4.cmml">[</mo><msub id="S3.SS2.p3.3.m3.2.2.1.1" xref="S3.SS2.p3.3.m3.2.2.1.1.cmml"><mover accent="true" id="S3.SS2.p3.3.m3.2.2.1.1.2" xref="S3.SS2.p3.3.m3.2.2.1.1.2.cmml"><mi id="S3.SS2.p3.3.m3.2.2.1.1.2.2" xref="S3.SS2.p3.3.m3.2.2.1.1.2.2.cmml">𝒎</mi><mo id="S3.SS2.p3.3.m3.2.2.1.1.2.1" xref="S3.SS2.p3.3.m3.2.2.1.1.2.1.cmml">~</mo></mover><mn id="S3.SS2.p3.3.m3.2.2.1.1.3" xref="S3.SS2.p3.3.m3.2.2.1.1.3.cmml">0</mn></msub><mo id="S3.SS2.p3.3.m3.4.4.3.5" xref="S3.SS2.p3.3.m3.4.4.4.cmml">,</mo><msub id="S3.SS2.p3.3.m3.3.3.2.2" xref="S3.SS2.p3.3.m3.3.3.2.2.cmml"><mover accent="true" id="S3.SS2.p3.3.m3.3.3.2.2.2" xref="S3.SS2.p3.3.m3.3.3.2.2.2.cmml"><mi id="S3.SS2.p3.3.m3.3.3.2.2.2.2" xref="S3.SS2.p3.3.m3.3.3.2.2.2.2.cmml">𝒎</mi><mo id="S3.SS2.p3.3.m3.3.3.2.2.2.1" xref="S3.SS2.p3.3.m3.3.3.2.2.2.1.cmml">~</mo></mover><mn id="S3.SS2.p3.3.m3.3.3.2.2.3" xref="S3.SS2.p3.3.m3.3.3.2.2.3.cmml">1</mn></msub><mo id="S3.SS2.p3.3.m3.4.4.3.6" xref="S3.SS2.p3.3.m3.4.4.4.cmml">,</mo><mi id="S3.SS2.p3.3.m3.1.1" mathvariant="normal" xref="S3.SS2.p3.3.m3.1.1.cmml">…</mi><mo id="S3.SS2.p3.3.m3.4.4.3.7" xref="S3.SS2.p3.3.m3.4.4.4.cmml">,</mo><msub id="S3.SS2.p3.3.m3.4.4.3.3" xref="S3.SS2.p3.3.m3.4.4.3.3.cmml"><mover accent="true" id="S3.SS2.p3.3.m3.4.4.3.3.2" xref="S3.SS2.p3.3.m3.4.4.3.3.2.cmml"><mi id="S3.SS2.p3.3.m3.4.4.3.3.2.2" xref="S3.SS2.p3.3.m3.4.4.3.3.2.2.cmml">𝒎</mi><mo id="S3.SS2.p3.3.m3.4.4.3.3.2.1" xref="S3.SS2.p3.3.m3.4.4.3.3.2.1.cmml">~</mo></mover><mi id="S3.SS2.p3.3.m3.4.4.3.3.3" xref="S3.SS2.p3.3.m3.4.4.3.3.3.cmml">L</mi></msub><mo id="S3.SS2.p3.3.m3.4.4.3.8" stretchy="false" xref="S3.SS2.p3.3.m3.4.4.4.cmml">]</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.3.m3.4b"><list id="S3.SS2.p3.3.m3.4.4.4.cmml" xref="S3.SS2.p3.3.m3.4.4.3"><apply id="S3.SS2.p3.3.m3.2.2.1.1.cmml" xref="S3.SS2.p3.3.m3.2.2.1.1"><csymbol cd="ambiguous" id="S3.SS2.p3.3.m3.2.2.1.1.1.cmml" xref="S3.SS2.p3.3.m3.2.2.1.1">subscript</csymbol><apply id="S3.SS2.p3.3.m3.2.2.1.1.2.cmml" xref="S3.SS2.p3.3.m3.2.2.1.1.2"><ci id="S3.SS2.p3.3.m3.2.2.1.1.2.1.cmml" xref="S3.SS2.p3.3.m3.2.2.1.1.2.1">~</ci><ci id="S3.SS2.p3.3.m3.2.2.1.1.2.2.cmml" xref="S3.SS2.p3.3.m3.2.2.1.1.2.2">𝒎</ci></apply><cn id="S3.SS2.p3.3.m3.2.2.1.1.3.cmml" type="integer" xref="S3.SS2.p3.3.m3.2.2.1.1.3">0</cn></apply><apply id="S3.SS2.p3.3.m3.3.3.2.2.cmml" xref="S3.SS2.p3.3.m3.3.3.2.2"><csymbol cd="ambiguous" id="S3.SS2.p3.3.m3.3.3.2.2.1.cmml" xref="S3.SS2.p3.3.m3.3.3.2.2">subscript</csymbol><apply id="S3.SS2.p3.3.m3.3.3.2.2.2.cmml" xref="S3.SS2.p3.3.m3.3.3.2.2.2"><ci id="S3.SS2.p3.3.m3.3.3.2.2.2.1.cmml" xref="S3.SS2.p3.3.m3.3.3.2.2.2.1">~</ci><ci id="S3.SS2.p3.3.m3.3.3.2.2.2.2.cmml" xref="S3.SS2.p3.3.m3.3.3.2.2.2.2">𝒎</ci></apply><cn id="S3.SS2.p3.3.m3.3.3.2.2.3.cmml" type="integer" xref="S3.SS2.p3.3.m3.3.3.2.2.3">1</cn></apply><ci id="S3.SS2.p3.3.m3.1.1.cmml" xref="S3.SS2.p3.3.m3.1.1">…</ci><apply id="S3.SS2.p3.3.m3.4.4.3.3.cmml" xref="S3.SS2.p3.3.m3.4.4.3.3"><csymbol cd="ambiguous" id="S3.SS2.p3.3.m3.4.4.3.3.1.cmml" xref="S3.SS2.p3.3.m3.4.4.3.3">subscript</csymbol><apply id="S3.SS2.p3.3.m3.4.4.3.3.2.cmml" xref="S3.SS2.p3.3.m3.4.4.3.3.2"><ci id="S3.SS2.p3.3.m3.4.4.3.3.2.1.cmml" xref="S3.SS2.p3.3.m3.4.4.3.3.2.1">~</ci><ci id="S3.SS2.p3.3.m3.4.4.3.3.2.2.cmml" xref="S3.SS2.p3.3.m3.4.4.3.3.2.2">𝒎</ci></apply><ci id="S3.SS2.p3.3.m3.4.4.3.3.3.cmml" xref="S3.SS2.p3.3.m3.4.4.3.3.3">𝐿</ci></apply></list></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.3.m3.4c">[\tilde{{\bm{m}}}_{0},\tilde{{\bm{m}}}_{1},...,\tilde{{\bm{m}}}_{L}]</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.3.m3.4d">[ over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT 0 end_POSTSUBSCRIPT , over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , … , over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_L end_POSTSUBSCRIPT ]</annotation></semantics></math>.
Let <math alttext="\tilde{r}" class="ltx_Math" display="inline" id="S3.SS2.p3.4.m4.1"><semantics id="S3.SS2.p3.4.m4.1a"><mover accent="true" id="S3.SS2.p3.4.m4.1.1" xref="S3.SS2.p3.4.m4.1.1.cmml"><mi id="S3.SS2.p3.4.m4.1.1.2" xref="S3.SS2.p3.4.m4.1.1.2.cmml">r</mi><mo id="S3.SS2.p3.4.m4.1.1.1" xref="S3.SS2.p3.4.m4.1.1.1.cmml">~</mo></mover><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.4.m4.1b"><apply id="S3.SS2.p3.4.m4.1.1.cmml" xref="S3.SS2.p3.4.m4.1.1"><ci id="S3.SS2.p3.4.m4.1.1.1.cmml" xref="S3.SS2.p3.4.m4.1.1.1">~</ci><ci id="S3.SS2.p3.4.m4.1.1.2.cmml" xref="S3.SS2.p3.4.m4.1.1.2">𝑟</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.4.m4.1c">\tilde{r}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.4.m4.1d">over~ start_ARG italic_r end_ARG</annotation></semantics></math> be one of the retrieval embeddings, our core retrieval mechanism is to use <math alttext="f_{\text{llm}}" class="ltx_Math" display="inline" id="S3.SS2.p3.5.m5.1"><semantics id="S3.SS2.p3.5.m5.1a"><msub id="S3.SS2.p3.5.m5.1.1" xref="S3.SS2.p3.5.m5.1.1.cmml"><mi id="S3.SS2.p3.5.m5.1.1.2" xref="S3.SS2.p3.5.m5.1.1.2.cmml">f</mi><mtext id="S3.SS2.p3.5.m5.1.1.3" xref="S3.SS2.p3.5.m5.1.1.3a.cmml">llm</mtext></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.5.m5.1b"><apply id="S3.SS2.p3.5.m5.1.1.cmml" xref="S3.SS2.p3.5.m5.1.1"><csymbol cd="ambiguous" id="S3.SS2.p3.5.m5.1.1.1.cmml" xref="S3.SS2.p3.5.m5.1.1">subscript</csymbol><ci id="S3.SS2.p3.5.m5.1.1.2.cmml" xref="S3.SS2.p3.5.m5.1.1.2">𝑓</ci><ci id="S3.SS2.p3.5.m5.1.1.3a.cmml" xref="S3.SS2.p3.5.m5.1.1.3"><mtext id="S3.SS2.p3.5.m5.1.1.3.cmml" mathsize="70%" xref="S3.SS2.p3.5.m5.1.1.3">llm</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.5.m5.1c">f_{\text{llm}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.5.m5.1d">italic_f start_POSTSUBSCRIPT llm end_POSTSUBSCRIPT</annotation></semantics></math> to compute the attention scores of these memories with respect to <math alttext="\tilde{r}" class="ltx_Math" display="inline" id="S3.SS2.p3.6.m6.1"><semantics id="S3.SS2.p3.6.m6.1a"><mover accent="true" id="S3.SS2.p3.6.m6.1.1" xref="S3.SS2.p3.6.m6.1.1.cmml"><mi id="S3.SS2.p3.6.m6.1.1.2" xref="S3.SS2.p3.6.m6.1.1.2.cmml">r</mi><mo id="S3.SS2.p3.6.m6.1.1.1" xref="S3.SS2.p3.6.m6.1.1.1.cmml">~</mo></mover><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.6.m6.1b"><apply id="S3.SS2.p3.6.m6.1.1.cmml" xref="S3.SS2.p3.6.m6.1.1"><ci id="S3.SS2.p3.6.m6.1.1.1.cmml" xref="S3.SS2.p3.6.m6.1.1.1">~</ci><ci id="S3.SS2.p3.6.m6.1.1.2.cmml" xref="S3.SS2.p3.6.m6.1.1.2">𝑟</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.6.m6.1c">\tilde{r}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.6.m6.1d">over~ start_ARG italic_r end_ARG</annotation></semantics></math>, and then aggregate them into <math alttext="\tilde{r}" class="ltx_Math" display="inline" id="S3.SS2.p3.7.m7.1"><semantics id="S3.SS2.p3.7.m7.1a"><mover accent="true" id="S3.SS2.p3.7.m7.1.1" xref="S3.SS2.p3.7.m7.1.1.cmml"><mi id="S3.SS2.p3.7.m7.1.1.2" xref="S3.SS2.p3.7.m7.1.1.2.cmml">r</mi><mo id="S3.SS2.p3.7.m7.1.1.1" xref="S3.SS2.p3.7.m7.1.1.1.cmml">~</mo></mover><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.7.m7.1b"><apply id="S3.SS2.p3.7.m7.1.1.cmml" xref="S3.SS2.p3.7.m7.1.1"><ci id="S3.SS2.p3.7.m7.1.1.1.cmml" xref="S3.SS2.p3.7.m7.1.1.1">~</ci><ci id="S3.SS2.p3.7.m7.1.1.2.cmml" xref="S3.SS2.p3.7.m7.1.1.2">𝑟</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.7.m7.1c">\tilde{r}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.7.m7.1d">over~ start_ARG italic_r end_ARG</annotation></semantics></math> level by level, from top to bottom, that is</p>
<table class="ltx_equation ltx_eqn_table" id="S3.Ex5">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="{\bm{a}}_{l},[\ \_\ ,\tilde{r}_{l-1}]\leftarrow f_{\text{llm}}([\tilde{{\bm{m}%
}}_{l},\tilde{r}_{l}]),\ \ l=L,L-1,...,0," class="ltx_Math" display="block" id="S3.Ex5.m1.5"><semantics id="S3.Ex5.m1.5a"><mrow id="S3.Ex5.m1.5.5.1"><mrow id="S3.Ex5.m1.5.5.1.1.2" xref="S3.Ex5.m1.5.5.1.1.3.cmml"><mrow id="S3.Ex5.m1.5.5.1.1.1.1" xref="S3.Ex5.m1.5.5.1.1.1.1.cmml"><mrow id="S3.Ex5.m1.5.5.1.1.1.1.2.2" xref="S3.Ex5.m1.5.5.1.1.1.1.2.3.cmml"><msub id="S3.Ex5.m1.5.5.1.1.1.1.1.1.1" xref="S3.Ex5.m1.5.5.1.1.1.1.1.1.1.cmml"><mi id="S3.Ex5.m1.5.5.1.1.1.1.1.1.1.2" xref="S3.Ex5.m1.5.5.1.1.1.1.1.1.1.2.cmml">𝒂</mi><mi id="S3.Ex5.m1.5.5.1.1.1.1.1.1.1.3" xref="S3.Ex5.m1.5.5.1.1.1.1.1.1.1.3.cmml">l</mi></msub><mo id="S3.Ex5.m1.5.5.1.1.1.1.2.2.3" xref="S3.Ex5.m1.5.5.1.1.1.1.2.3.cmml">,</mo><mrow id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.2.cmml"><mo id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.2" rspace="0.500em" stretchy="false" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.2.cmml">[</mo><mi id="S3.Ex5.m1.1.1" mathvariant="normal" xref="S3.Ex5.m1.1.1.cmml">_</mi><mo id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.3" lspace="0.500em" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.2.cmml">,</mo><msub id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.cmml"><mover accent="true" id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.2" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.2.cmml"><mi id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.2.2" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.2.2.cmml">r</mi><mo id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.2.1" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.2.1.cmml">~</mo></mover><mrow id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.cmml"><mi id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.2" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.2.cmml">l</mi><mo id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.1" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.1.cmml">−</mo><mn id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.3" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.3.cmml">1</mn></mrow></msub><mo id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.4" stretchy="false" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.2.cmml">]</mo></mrow></mrow><mo id="S3.Ex5.m1.5.5.1.1.1.1.4" stretchy="false" xref="S3.Ex5.m1.5.5.1.1.1.1.4.cmml">←</mo><mrow id="S3.Ex5.m1.5.5.1.1.1.1.3" xref="S3.Ex5.m1.5.5.1.1.1.1.3.cmml"><msub id="S3.Ex5.m1.5.5.1.1.1.1.3.3" xref="S3.Ex5.m1.5.5.1.1.1.1.3.3.cmml"><mi id="S3.Ex5.m1.5.5.1.1.1.1.3.3.2" xref="S3.Ex5.m1.5.5.1.1.1.1.3.3.2.cmml">f</mi><mtext id="S3.Ex5.m1.5.5.1.1.1.1.3.3.3" xref="S3.Ex5.m1.5.5.1.1.1.1.3.3.3a.cmml">llm</mtext></msub><mo id="S3.Ex5.m1.5.5.1.1.1.1.3.2" xref="S3.Ex5.m1.5.5.1.1.1.1.3.2.cmml">⁢</mo><mrow id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1" xref="S3.Ex5.m1.5.5.1.1.1.1.3.cmml"><mo id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.2" stretchy="false" xref="S3.Ex5.m1.5.5.1.1.1.1.3.cmml">(</mo><mrow id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.3.cmml"><mo id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.3" stretchy="false" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.3.cmml">[</mo><msub id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.cmml"><mover accent="true" id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.2" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.2.cmml"><mi id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.2.2" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.2.2.cmml">𝒎</mi><mo id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.2.1" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.2.1.cmml">~</mo></mover><mi id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.3" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.3.cmml">l</mi></msub><mo id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.4" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.3.cmml">,</mo><msub id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.cmml"><mover accent="true" id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.2" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.2.cmml"><mi id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.2.2" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.2.2.cmml">r</mi><mo id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.2.1" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.2.1.cmml">~</mo></mover><mi id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.3" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.3.cmml">l</mi></msub><mo id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.5" stretchy="false" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.3.cmml">]</mo></mrow><mo id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.3" stretchy="false" xref="S3.Ex5.m1.5.5.1.1.1.1.3.cmml">)</mo></mrow></mrow></mrow><mo id="S3.Ex5.m1.5.5.1.1.2.3" rspace="1.167em" xref="S3.Ex5.m1.5.5.1.1.3a.cmml">,</mo><mrow id="S3.Ex5.m1.5.5.1.1.2.2" xref="S3.Ex5.m1.5.5.1.1.2.2.cmml"><mi id="S3.Ex5.m1.5.5.1.1.2.2.3" xref="S3.Ex5.m1.5.5.1.1.2.2.3.cmml">l</mi><mo id="S3.Ex5.m1.5.5.1.1.2.2.2" xref="S3.Ex5.m1.5.5.1.1.2.2.2.cmml">=</mo><mrow id="S3.Ex5.m1.5.5.1.1.2.2.1.1" xref="S3.Ex5.m1.5.5.1.1.2.2.1.2.cmml"><mi id="S3.Ex5.m1.2.2" xref="S3.Ex5.m1.2.2.cmml">L</mi><mo id="S3.Ex5.m1.5.5.1.1.2.2.1.1.2" xref="S3.Ex5.m1.5.5.1.1.2.2.1.2.cmml">,</mo><mrow id="S3.Ex5.m1.5.5.1.1.2.2.1.1.1" xref="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.cmml"><mi id="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.2" xref="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.2.cmml">L</mi><mo id="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.1" xref="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.1.cmml">−</mo><mn id="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.3" xref="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.3.cmml">1</mn></mrow><mo id="S3.Ex5.m1.5.5.1.1.2.2.1.1.3" xref="S3.Ex5.m1.5.5.1.1.2.2.1.2.cmml">,</mo><mi id="S3.Ex5.m1.3.3" mathvariant="normal" xref="S3.Ex5.m1.3.3.cmml">…</mi><mo id="S3.Ex5.m1.5.5.1.1.2.2.1.1.4" xref="S3.Ex5.m1.5.5.1.1.2.2.1.2.cmml">,</mo><mn id="S3.Ex5.m1.4.4" xref="S3.Ex5.m1.4.4.cmml">0</mn></mrow></mrow></mrow><mo id="S3.Ex5.m1.5.5.1.2">,</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.Ex5.m1.5b"><apply id="S3.Ex5.m1.5.5.1.1.3.cmml" xref="S3.Ex5.m1.5.5.1.1.2"><csymbol cd="ambiguous" id="S3.Ex5.m1.5.5.1.1.3a.cmml" xref="S3.Ex5.m1.5.5.1.1.2.3">formulae-sequence</csymbol><apply id="S3.Ex5.m1.5.5.1.1.1.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1"><ci id="S3.Ex5.m1.5.5.1.1.1.1.4.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.4">←</ci><list id="S3.Ex5.m1.5.5.1.1.1.1.2.3.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2"><apply id="S3.Ex5.m1.5.5.1.1.1.1.1.1.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.Ex5.m1.5.5.1.1.1.1.1.1.1.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.1.1.1">subscript</csymbol><ci id="S3.Ex5.m1.5.5.1.1.1.1.1.1.1.2.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.1.1.1.2">𝒂</ci><ci id="S3.Ex5.m1.5.5.1.1.1.1.1.1.1.3.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.1.1.1.3">𝑙</ci></apply><interval closure="closed" id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.2.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1"><ci id="S3.Ex5.m1.1.1.cmml" xref="S3.Ex5.m1.1.1">_</ci><apply id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1"><csymbol cd="ambiguous" id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1">subscript</csymbol><apply id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.2.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.2"><ci id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.2.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.2.1">~</ci><ci id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.2.2.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.2.2">𝑟</ci></apply><apply id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3"><minus id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.1"></minus><ci id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.2.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.2">𝑙</ci><cn id="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.3.cmml" type="integer" xref="S3.Ex5.m1.5.5.1.1.1.1.2.2.2.1.1.3.3">1</cn></apply></apply></interval></list><apply id="S3.Ex5.m1.5.5.1.1.1.1.3.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3"><times id="S3.Ex5.m1.5.5.1.1.1.1.3.2.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.2"></times><apply id="S3.Ex5.m1.5.5.1.1.1.1.3.3.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S3.Ex5.m1.5.5.1.1.1.1.3.3.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.3">subscript</csymbol><ci id="S3.Ex5.m1.5.5.1.1.1.1.3.3.2.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.3.2">𝑓</ci><ci id="S3.Ex5.m1.5.5.1.1.1.1.3.3.3a.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.3.3"><mtext id="S3.Ex5.m1.5.5.1.1.1.1.3.3.3.cmml" mathsize="70%" xref="S3.Ex5.m1.5.5.1.1.1.1.3.3.3">llm</mtext></ci></apply><interval closure="closed" id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.3.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2"><apply id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1">subscript</csymbol><apply id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.2.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.2"><ci id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.2.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.2.1">~</ci><ci id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.2.2.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.2.2">𝒎</ci></apply><ci id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.3.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.1.1.3">𝑙</ci></apply><apply id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2"><csymbol cd="ambiguous" id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2">subscript</csymbol><apply id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.2.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.2"><ci id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.2.1.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.2.1">~</ci><ci id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.2.2.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.2.2">𝑟</ci></apply><ci id="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.3.cmml" xref="S3.Ex5.m1.5.5.1.1.1.1.3.1.1.1.2.2.3">𝑙</ci></apply></interval></apply></apply><apply id="S3.Ex5.m1.5.5.1.1.2.2.cmml" xref="S3.Ex5.m1.5.5.1.1.2.2"><eq id="S3.Ex5.m1.5.5.1.1.2.2.2.cmml" xref="S3.Ex5.m1.5.5.1.1.2.2.2"></eq><ci id="S3.Ex5.m1.5.5.1.1.2.2.3.cmml" xref="S3.Ex5.m1.5.5.1.1.2.2.3">𝑙</ci><list id="S3.Ex5.m1.5.5.1.1.2.2.1.2.cmml" xref="S3.Ex5.m1.5.5.1.1.2.2.1.1"><ci id="S3.Ex5.m1.2.2.cmml" xref="S3.Ex5.m1.2.2">𝐿</ci><apply id="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.cmml" xref="S3.Ex5.m1.5.5.1.1.2.2.1.1.1"><minus id="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.1.cmml" xref="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.1"></minus><ci id="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.2.cmml" xref="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.2">𝐿</ci><cn id="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.3.cmml" type="integer" xref="S3.Ex5.m1.5.5.1.1.2.2.1.1.1.3">1</cn></apply><ci id="S3.Ex5.m1.3.3.cmml" xref="S3.Ex5.m1.3.3">…</ci><cn id="S3.Ex5.m1.4.4.cmml" type="integer" xref="S3.Ex5.m1.4.4">0</cn></list></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.Ex5.m1.5c">{\bm{a}}_{l},[\ \_\ ,\tilde{r}_{l-1}]\leftarrow f_{\text{llm}}([\tilde{{\bm{m}%
}}_{l},\tilde{r}_{l}]),\ \ l=L,L-1,...,0,</annotation><annotation encoding="application/x-llamapun" id="S3.Ex5.m1.5d">bold_italic_a start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT , [ _ , over~ start_ARG italic_r end_ARG start_POSTSUBSCRIPT italic_l - 1 end_POSTSUBSCRIPT ] ← italic_f start_POSTSUBSCRIPT llm end_POSTSUBSCRIPT ( [ over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT , over~ start_ARG italic_r end_ARG start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT ] ) , italic_l = italic_L , italic_L - 1 , … , 0 ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S3.SS2.p3.13">where <math alttext="{\bm{a}}_{l}" class="ltx_Math" display="inline" id="S3.SS2.p3.8.m1.1"><semantics id="S3.SS2.p3.8.m1.1a"><msub id="S3.SS2.p3.8.m1.1.1" xref="S3.SS2.p3.8.m1.1.1.cmml"><mi id="S3.SS2.p3.8.m1.1.1.2" xref="S3.SS2.p3.8.m1.1.1.2.cmml">𝒂</mi><mi id="S3.SS2.p3.8.m1.1.1.3" xref="S3.SS2.p3.8.m1.1.1.3.cmml">l</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.8.m1.1b"><apply id="S3.SS2.p3.8.m1.1.1.cmml" xref="S3.SS2.p3.8.m1.1.1"><csymbol cd="ambiguous" id="S3.SS2.p3.8.m1.1.1.1.cmml" xref="S3.SS2.p3.8.m1.1.1">subscript</csymbol><ci id="S3.SS2.p3.8.m1.1.1.2.cmml" xref="S3.SS2.p3.8.m1.1.1.2">𝒂</ci><ci id="S3.SS2.p3.8.m1.1.1.3.cmml" xref="S3.SS2.p3.8.m1.1.1.3">𝑙</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.8.m1.1c">{\bm{a}}_{l}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.8.m1.1d">bold_italic_a start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT</annotation></semantics></math> is the last layer attention vector of <math alttext="\tilde{{\bm{m}}}_{l}" class="ltx_Math" display="inline" id="S3.SS2.p3.9.m2.1"><semantics id="S3.SS2.p3.9.m2.1a"><msub id="S3.SS2.p3.9.m2.1.1" xref="S3.SS2.p3.9.m2.1.1.cmml"><mover accent="true" id="S3.SS2.p3.9.m2.1.1.2" xref="S3.SS2.p3.9.m2.1.1.2.cmml"><mi id="S3.SS2.p3.9.m2.1.1.2.2" xref="S3.SS2.p3.9.m2.1.1.2.2.cmml">𝒎</mi><mo id="S3.SS2.p3.9.m2.1.1.2.1" xref="S3.SS2.p3.9.m2.1.1.2.1.cmml">~</mo></mover><mi id="S3.SS2.p3.9.m2.1.1.3" xref="S3.SS2.p3.9.m2.1.1.3.cmml">l</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.9.m2.1b"><apply id="S3.SS2.p3.9.m2.1.1.cmml" xref="S3.SS2.p3.9.m2.1.1"><csymbol cd="ambiguous" id="S3.SS2.p3.9.m2.1.1.1.cmml" xref="S3.SS2.p3.9.m2.1.1">subscript</csymbol><apply id="S3.SS2.p3.9.m2.1.1.2.cmml" xref="S3.SS2.p3.9.m2.1.1.2"><ci id="S3.SS2.p3.9.m2.1.1.2.1.cmml" xref="S3.SS2.p3.9.m2.1.1.2.1">~</ci><ci id="S3.SS2.p3.9.m2.1.1.2.2.cmml" xref="S3.SS2.p3.9.m2.1.1.2.2">𝒎</ci></apply><ci id="S3.SS2.p3.9.m2.1.1.3.cmml" xref="S3.SS2.p3.9.m2.1.1.3">𝑙</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.9.m2.1c">\tilde{{\bm{m}}}_{l}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.9.m2.1d">over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT</annotation></semantics></math> with respect to <math alttext="\tilde{r}_{l}" class="ltx_Math" display="inline" id="S3.SS2.p3.10.m3.1"><semantics id="S3.SS2.p3.10.m3.1a"><msub id="S3.SS2.p3.10.m3.1.1" xref="S3.SS2.p3.10.m3.1.1.cmml"><mover accent="true" id="S3.SS2.p3.10.m3.1.1.2" xref="S3.SS2.p3.10.m3.1.1.2.cmml"><mi id="S3.SS2.p3.10.m3.1.1.2.2" xref="S3.SS2.p3.10.m3.1.1.2.2.cmml">r</mi><mo id="S3.SS2.p3.10.m3.1.1.2.1" xref="S3.SS2.p3.10.m3.1.1.2.1.cmml">~</mo></mover><mi id="S3.SS2.p3.10.m3.1.1.3" xref="S3.SS2.p3.10.m3.1.1.3.cmml">l</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.10.m3.1b"><apply id="S3.SS2.p3.10.m3.1.1.cmml" xref="S3.SS2.p3.10.m3.1.1"><csymbol cd="ambiguous" id="S3.SS2.p3.10.m3.1.1.1.cmml" xref="S3.SS2.p3.10.m3.1.1">subscript</csymbol><apply id="S3.SS2.p3.10.m3.1.1.2.cmml" xref="S3.SS2.p3.10.m3.1.1.2"><ci id="S3.SS2.p3.10.m3.1.1.2.1.cmml" xref="S3.SS2.p3.10.m3.1.1.2.1">~</ci><ci id="S3.SS2.p3.10.m3.1.1.2.2.cmml" xref="S3.SS2.p3.10.m3.1.1.2.2">𝑟</ci></apply><ci id="S3.SS2.p3.10.m3.1.1.3.cmml" xref="S3.SS2.p3.10.m3.1.1.3">𝑙</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.10.m3.1c">\tilde{r}_{l}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.10.m3.1d">over~ start_ARG italic_r end_ARG start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT</annotation></semantics></math>,
and <math alttext="\_" class="ltx_Math" display="inline" id="S3.SS2.p3.11.m4.1"><semantics id="S3.SS2.p3.11.m4.1a"><mi id="S3.SS2.p3.11.m4.1.1" mathvariant="normal" xref="S3.SS2.p3.11.m4.1.1.cmml">_</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.11.m4.1b"><ci id="S3.SS2.p3.11.m4.1.1.cmml" xref="S3.SS2.p3.11.m4.1.1">_</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.11.m4.1c">\_</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.11.m4.1d">_</annotation></semantics></math> is the output corresponds to <math alttext="\tilde{{\bm{m}}}_{l}" class="ltx_Math" display="inline" id="S3.SS2.p3.12.m5.1"><semantics id="S3.SS2.p3.12.m5.1a"><msub id="S3.SS2.p3.12.m5.1.1" xref="S3.SS2.p3.12.m5.1.1.cmml"><mover accent="true" id="S3.SS2.p3.12.m5.1.1.2" xref="S3.SS2.p3.12.m5.1.1.2.cmml"><mi id="S3.SS2.p3.12.m5.1.1.2.2" xref="S3.SS2.p3.12.m5.1.1.2.2.cmml">𝒎</mi><mo id="S3.SS2.p3.12.m5.1.1.2.1" xref="S3.SS2.p3.12.m5.1.1.2.1.cmml">~</mo></mover><mi id="S3.SS2.p3.12.m5.1.1.3" xref="S3.SS2.p3.12.m5.1.1.3.cmml">l</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.12.m5.1b"><apply id="S3.SS2.p3.12.m5.1.1.cmml" xref="S3.SS2.p3.12.m5.1.1"><csymbol cd="ambiguous" id="S3.SS2.p3.12.m5.1.1.1.cmml" xref="S3.SS2.p3.12.m5.1.1">subscript</csymbol><apply id="S3.SS2.p3.12.m5.1.1.2.cmml" xref="S3.SS2.p3.12.m5.1.1.2"><ci id="S3.SS2.p3.12.m5.1.1.2.1.cmml" xref="S3.SS2.p3.12.m5.1.1.2.1">~</ci><ci id="S3.SS2.p3.12.m5.1.1.2.2.cmml" xref="S3.SS2.p3.12.m5.1.1.2.2">𝒎</ci></apply><ci id="S3.SS2.p3.12.m5.1.1.3.cmml" xref="S3.SS2.p3.12.m5.1.1.3">𝑙</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.12.m5.1c">\tilde{{\bm{m}}}_{l}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.12.m5.1d">over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT</annotation></semantics></math>, which we ignore.
Note that (1) this essentially performs a self-attention with memories and <math alttext="\tilde{{\bm{r}}}" class="ltx_Math" display="inline" id="S3.SS2.p3.13.m6.1"><semantics id="S3.SS2.p3.13.m6.1a"><mover accent="true" id="S3.SS2.p3.13.m6.1.1" xref="S3.SS2.p3.13.m6.1.1.cmml"><mi id="S3.SS2.p3.13.m6.1.1.2" xref="S3.SS2.p3.13.m6.1.1.2.cmml">𝒓</mi><mo id="S3.SS2.p3.13.m6.1.1.1" xref="S3.SS2.p3.13.m6.1.1.1.cmml">~</mo></mover><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.13.m6.1b"><apply id="S3.SS2.p3.13.m6.1.1.cmml" xref="S3.SS2.p3.13.m6.1.1"><ci id="S3.SS2.p3.13.m6.1.1.1.cmml" xref="S3.SS2.p3.13.m6.1.1.1">~</ci><ci id="S3.SS2.p3.13.m6.1.1.2.cmml" xref="S3.SS2.p3.13.m6.1.1.2">𝒓</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.13.m6.1c">\tilde{{\bm{r}}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.13.m6.1d">over~ start_ARG bold_italic_r end_ARG</annotation></semantics></math>;
(2) this means rather than retrieving the “exact” context (as that in RAG), we allow the model to re-compute the memory during retrieval, making it more flexible;
(3) following this implication and recalling that higher-level embeddings are effectively the higher-level (or more compressed) memories of the original chunk, one could early stop the search if the context is only remotely relevant or the desired granularity has been met.</p>
</div>
<div class="ltx_para ltx_noindent" id="S3.SS2.p4">
<p class="ltx_p" id="S3.SS2.p4.14">With these observations in mind and that we know where the higher-level embedding attends to at its lower-level embeddings (thanks to the segmented attention mask), we further propose the <span class="ltx_text ltx_font_italic" id="S3.SS2.p4.14.1">sparse retrieval</span>:</p>
<table class="ltx_equationgroup ltx_eqn_align ltx_eqn_table" id="S6.EGx2">
<tbody id="S3.E1"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle\tilde{{\bm{m}}}_{l,C}\leftarrow\text{TopC}(\tilde{{\bm{m}}}_{l},%
\tilde{{\bm{m}}}_{l+1},{\bm{a}}_{l+1})" class="ltx_Math" display="inline" id="S3.E1.m1.5"><semantics id="S3.E1.m1.5a"><mrow id="S3.E1.m1.5.5" xref="S3.E1.m1.5.5.cmml"><msub id="S3.E1.m1.5.5.5" xref="S3.E1.m1.5.5.5.cmml"><mover accent="true" id="S3.E1.m1.5.5.5.2" xref="S3.E1.m1.5.5.5.2.cmml"><mi id="S3.E1.m1.5.5.5.2.2" xref="S3.E1.m1.5.5.5.2.2.cmml">𝒎</mi><mo id="S3.E1.m1.5.5.5.2.1" xref="S3.E1.m1.5.5.5.2.1.cmml">~</mo></mover><mrow id="S3.E1.m1.2.2.2.4" xref="S3.E1.m1.2.2.2.3.cmml"><mi id="S3.E1.m1.1.1.1.1" xref="S3.E1.m1.1.1.1.1.cmml">l</mi><mo id="S3.E1.m1.2.2.2.4.1" xref="S3.E1.m1.2.2.2.3.cmml">,</mo><mi id="S3.E1.m1.2.2.2.2" xref="S3.E1.m1.2.2.2.2.cmml">C</mi></mrow></msub><mo id="S3.E1.m1.5.5.4" stretchy="false" xref="S3.E1.m1.5.5.4.cmml">←</mo><mrow id="S3.E1.m1.5.5.3" xref="S3.E1.m1.5.5.3.cmml"><mtext id="S3.E1.m1.5.5.3.5" xref="S3.E1.m1.5.5.3.5a.cmml">TopC</mtext><mo id="S3.E1.m1.5.5.3.4" xref="S3.E1.m1.5.5.3.4.cmml">⁢</mo><mrow id="S3.E1.m1.5.5.3.3.3" xref="S3.E1.m1.5.5.3.3.4.cmml"><mo id="S3.E1.m1.5.5.3.3.3.4" stretchy="false" xref="S3.E1.m1.5.5.3.3.4.cmml">(</mo><msub id="S3.E1.m1.3.3.1.1.1.1" xref="S3.E1.m1.3.3.1.1.1.1.cmml"><mover accent="true" id="S3.E1.m1.3.3.1.1.1.1.2" xref="S3.E1.m1.3.3.1.1.1.1.2.cmml"><mi id="S3.E1.m1.3.3.1.1.1.1.2.2" xref="S3.E1.m1.3.3.1.1.1.1.2.2.cmml">𝒎</mi><mo id="S3.E1.m1.3.3.1.1.1.1.2.1" xref="S3.E1.m1.3.3.1.1.1.1.2.1.cmml">~</mo></mover><mi id="S3.E1.m1.3.3.1.1.1.1.3" xref="S3.E1.m1.3.3.1.1.1.1.3.cmml">l</mi></msub><mo id="S3.E1.m1.5.5.3.3.3.5" xref="S3.E1.m1.5.5.3.3.4.cmml">,</mo><msub id="S3.E1.m1.4.4.2.2.2.2" xref="S3.E1.m1.4.4.2.2.2.2.cmml"><mover accent="true" id="S3.E1.m1.4.4.2.2.2.2.2" xref="S3.E1.m1.4.4.2.2.2.2.2.cmml"><mi id="S3.E1.m1.4.4.2.2.2.2.2.2" xref="S3.E1.m1.4.4.2.2.2.2.2.2.cmml">𝒎</mi><mo id="S3.E1.m1.4.4.2.2.2.2.2.1" xref="S3.E1.m1.4.4.2.2.2.2.2.1.cmml">~</mo></mover><mrow id="S3.E1.m1.4.4.2.2.2.2.3" xref="S3.E1.m1.4.4.2.2.2.2.3.cmml"><mi id="S3.E1.m1.4.4.2.2.2.2.3.2" xref="S3.E1.m1.4.4.2.2.2.2.3.2.cmml">l</mi><mo id="S3.E1.m1.4.4.2.2.2.2.3.1" xref="S3.E1.m1.4.4.2.2.2.2.3.1.cmml">+</mo><mn id="S3.E1.m1.4.4.2.2.2.2.3.3" xref="S3.E1.m1.4.4.2.2.2.2.3.3.cmml">1</mn></mrow></msub><mo id="S3.E1.m1.5.5.3.3.3.6" xref="S3.E1.m1.5.5.3.3.4.cmml">,</mo><msub id="S3.E1.m1.5.5.3.3.3.3" xref="S3.E1.m1.5.5.3.3.3.3.cmml"><mi id="S3.E1.m1.5.5.3.3.3.3.2" xref="S3.E1.m1.5.5.3.3.3.3.2.cmml">𝒂</mi><mrow id="S3.E1.m1.5.5.3.3.3.3.3" xref="S3.E1.m1.5.5.3.3.3.3.3.cmml"><mi id="S3.E1.m1.5.5.3.3.3.3.3.2" xref="S3.E1.m1.5.5.3.3.3.3.3.2.cmml">l</mi><mo id="S3.E1.m1.5.5.3.3.3.3.3.1" xref="S3.E1.m1.5.5.3.3.3.3.3.1.cmml">+</mo><mn id="S3.E1.m1.5.5.3.3.3.3.3.3" xref="S3.E1.m1.5.5.3.3.3.3.3.3.cmml">1</mn></mrow></msub><mo id="S3.E1.m1.5.5.3.3.3.7" stretchy="false" xref="S3.E1.m1.5.5.3.3.4.cmml">)</mo></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.E1.m1.5b"><apply id="S3.E1.m1.5.5.cmml" xref="S3.E1.m1.5.5"><ci id="S3.E1.m1.5.5.4.cmml" xref="S3.E1.m1.5.5.4">←</ci><apply id="S3.E1.m1.5.5.5.cmml" xref="S3.E1.m1.5.5.5"><csymbol cd="ambiguous" id="S3.E1.m1.5.5.5.1.cmml" xref="S3.E1.m1.5.5.5">subscript</csymbol><apply id="S3.E1.m1.5.5.5.2.cmml" xref="S3.E1.m1.5.5.5.2"><ci id="S3.E1.m1.5.5.5.2.1.cmml" xref="S3.E1.m1.5.5.5.2.1">~</ci><ci id="S3.E1.m1.5.5.5.2.2.cmml" xref="S3.E1.m1.5.5.5.2.2">𝒎</ci></apply><list id="S3.E1.m1.2.2.2.3.cmml" xref="S3.E1.m1.2.2.2.4"><ci id="S3.E1.m1.1.1.1.1.cmml" xref="S3.E1.m1.1.1.1.1">𝑙</ci><ci id="S3.E1.m1.2.2.2.2.cmml" xref="S3.E1.m1.2.2.2.2">𝐶</ci></list></apply><apply id="S3.E1.m1.5.5.3.cmml" xref="S3.E1.m1.5.5.3"><times id="S3.E1.m1.5.5.3.4.cmml" xref="S3.E1.m1.5.5.3.4"></times><ci id="S3.E1.m1.5.5.3.5a.cmml" xref="S3.E1.m1.5.5.3.5"><mtext id="S3.E1.m1.5.5.3.5.cmml" xref="S3.E1.m1.5.5.3.5">TopC</mtext></ci><vector id="S3.E1.m1.5.5.3.3.4.cmml" xref="S3.E1.m1.5.5.3.3.3"><apply id="S3.E1.m1.3.3.1.1.1.1.cmml" xref="S3.E1.m1.3.3.1.1.1.1"><csymbol cd="ambiguous" id="S3.E1.m1.3.3.1.1.1.1.1.cmml" xref="S3.E1.m1.3.3.1.1.1.1">subscript</csymbol><apply id="S3.E1.m1.3.3.1.1.1.1.2.cmml" xref="S3.E1.m1.3.3.1.1.1.1.2"><ci id="S3.E1.m1.3.3.1.1.1.1.2.1.cmml" xref="S3.E1.m1.3.3.1.1.1.1.2.1">~</ci><ci id="S3.E1.m1.3.3.1.1.1.1.2.2.cmml" xref="S3.E1.m1.3.3.1.1.1.1.2.2">𝒎</ci></apply><ci id="S3.E1.m1.3.3.1.1.1.1.3.cmml" xref="S3.E1.m1.3.3.1.1.1.1.3">𝑙</ci></apply><apply id="S3.E1.m1.4.4.2.2.2.2.cmml" xref="S3.E1.m1.4.4.2.2.2.2"><csymbol cd="ambiguous" id="S3.E1.m1.4.4.2.2.2.2.1.cmml" xref="S3.E1.m1.4.4.2.2.2.2">subscript</csymbol><apply id="S3.E1.m1.4.4.2.2.2.2.2.cmml" xref="S3.E1.m1.4.4.2.2.2.2.2"><ci id="S3.E1.m1.4.4.2.2.2.2.2.1.cmml" xref="S3.E1.m1.4.4.2.2.2.2.2.1">~</ci><ci id="S3.E1.m1.4.4.2.2.2.2.2.2.cmml" xref="S3.E1.m1.4.4.2.2.2.2.2.2">𝒎</ci></apply><apply id="S3.E1.m1.4.4.2.2.2.2.3.cmml" xref="S3.E1.m1.4.4.2.2.2.2.3"><plus id="S3.E1.m1.4.4.2.2.2.2.3.1.cmml" xref="S3.E1.m1.4.4.2.2.2.2.3.1"></plus><ci id="S3.E1.m1.4.4.2.2.2.2.3.2.cmml" xref="S3.E1.m1.4.4.2.2.2.2.3.2">𝑙</ci><cn id="S3.E1.m1.4.4.2.2.2.2.3.3.cmml" type="integer" xref="S3.E1.m1.4.4.2.2.2.2.3.3">1</cn></apply></apply><apply id="S3.E1.m1.5.5.3.3.3.3.cmml" xref="S3.E1.m1.5.5.3.3.3.3"><csymbol cd="ambiguous" id="S3.E1.m1.5.5.3.3.3.3.1.cmml" xref="S3.E1.m1.5.5.3.3.3.3">subscript</csymbol><ci id="S3.E1.m1.5.5.3.3.3.3.2.cmml" xref="S3.E1.m1.5.5.3.3.3.3.2">𝒂</ci><apply id="S3.E1.m1.5.5.3.3.3.3.3.cmml" xref="S3.E1.m1.5.5.3.3.3.3.3"><plus id="S3.E1.m1.5.5.3.3.3.3.3.1.cmml" xref="S3.E1.m1.5.5.3.3.3.3.3.1"></plus><ci id="S3.E1.m1.5.5.3.3.3.3.3.2.cmml" xref="S3.E1.m1.5.5.3.3.3.3.3.2">𝑙</ci><cn id="S3.E1.m1.5.5.3.3.3.3.3.3.cmml" type="integer" xref="S3.E1.m1.5.5.3.3.3.3.3.3">1</cn></apply></apply></vector></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.E1.m1.5c">\displaystyle\tilde{{\bm{m}}}_{l,C}\leftarrow\text{TopC}(\tilde{{\bm{m}}}_{l},%
\tilde{{\bm{m}}}_{l+1},{\bm{a}}_{l+1})</annotation><annotation encoding="application/x-llamapun" id="S3.E1.m1.5d">over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_l , italic_C end_POSTSUBSCRIPT ← TopC ( over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT , over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_l + 1 end_POSTSUBSCRIPT , bold_italic_a start_POSTSUBSCRIPT italic_l + 1 end_POSTSUBSCRIPT )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(1)</span></td>
</tr></tbody>
<tbody id="S3.E2"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle{\bm{a}}_{l},[\ \_\ ,\tilde{r}_{l-1}]\leftarrow f_{\text{llm}}([%
\tilde{{\bm{m}}}_{l,C},\tilde{r}_{l}])" class="ltx_Math" display="inline" id="S3.E2.m1.6"><semantics id="S3.E2.m1.6a"><mrow id="S3.E2.m1.6.6" xref="S3.E2.m1.6.6.cmml"><mrow id="S3.E2.m1.5.5.2.2" xref="S3.E2.m1.5.5.2.3.cmml"><msub id="S3.E2.m1.4.4.1.1.1" xref="S3.E2.m1.4.4.1.1.1.cmml"><mi id="S3.E2.m1.4.4.1.1.1.2" xref="S3.E2.m1.4.4.1.1.1.2.cmml">𝒂</mi><mi id="S3.E2.m1.4.4.1.1.1.3" xref="S3.E2.m1.4.4.1.1.1.3.cmml">l</mi></msub><mo id="S3.E2.m1.5.5.2.2.3" xref="S3.E2.m1.5.5.2.3.cmml">,</mo><mrow id="S3.E2.m1.5.5.2.2.2.1" xref="S3.E2.m1.5.5.2.2.2.2.cmml"><mo id="S3.E2.m1.5.5.2.2.2.1.2" rspace="0.500em" stretchy="false" xref="S3.E2.m1.5.5.2.2.2.2.cmml">[</mo><mi id="S3.E2.m1.3.3" mathvariant="normal" xref="S3.E2.m1.3.3.cmml">_</mi><mo id="S3.E2.m1.5.5.2.2.2.1.3" lspace="0.500em" xref="S3.E2.m1.5.5.2.2.2.2.cmml">,</mo><msub id="S3.E2.m1.5.5.2.2.2.1.1" xref="S3.E2.m1.5.5.2.2.2.1.1.cmml"><mover accent="true" id="S3.E2.m1.5.5.2.2.2.1.1.2" xref="S3.E2.m1.5.5.2.2.2.1.1.2.cmml"><mi id="S3.E2.m1.5.5.2.2.2.1.1.2.2" xref="S3.E2.m1.5.5.2.2.2.1.1.2.2.cmml">r</mi><mo id="S3.E2.m1.5.5.2.2.2.1.1.2.1" xref="S3.E2.m1.5.5.2.2.2.1.1.2.1.cmml">~</mo></mover><mrow id="S3.E2.m1.5.5.2.2.2.1.1.3" xref="S3.E2.m1.5.5.2.2.2.1.1.3.cmml"><mi id="S3.E2.m1.5.5.2.2.2.1.1.3.2" xref="S3.E2.m1.5.5.2.2.2.1.1.3.2.cmml">l</mi><mo id="S3.E2.m1.5.5.2.2.2.1.1.3.1" xref="S3.E2.m1.5.5.2.2.2.1.1.3.1.cmml">−</mo><mn id="S3.E2.m1.5.5.2.2.2.1.1.3.3" xref="S3.E2.m1.5.5.2.2.2.1.1.3.3.cmml">1</mn></mrow></msub><mo id="S3.E2.m1.5.5.2.2.2.1.4" stretchy="false" xref="S3.E2.m1.5.5.2.2.2.2.cmml">]</mo></mrow></mrow><mo id="S3.E2.m1.6.6.4" stretchy="false" xref="S3.E2.m1.6.6.4.cmml">←</mo><mrow id="S3.E2.m1.6.6.3" xref="S3.E2.m1.6.6.3.cmml"><msub id="S3.E2.m1.6.6.3.3" xref="S3.E2.m1.6.6.3.3.cmml"><mi id="S3.E2.m1.6.6.3.3.2" xref="S3.E2.m1.6.6.3.3.2.cmml">f</mi><mtext id="S3.E2.m1.6.6.3.3.3" xref="S3.E2.m1.6.6.3.3.3a.cmml">llm</mtext></msub><mo id="S3.E2.m1.6.6.3.2" xref="S3.E2.m1.6.6.3.2.cmml">⁢</mo><mrow id="S3.E2.m1.6.6.3.1.1" xref="S3.E2.m1.6.6.3.cmml"><mo id="S3.E2.m1.6.6.3.1.1.2" stretchy="false" xref="S3.E2.m1.6.6.3.cmml">(</mo><mrow id="S3.E2.m1.6.6.3.1.1.1.2" xref="S3.E2.m1.6.6.3.1.1.1.3.cmml"><mo id="S3.E2.m1.6.6.3.1.1.1.2.3" stretchy="false" xref="S3.E2.m1.6.6.3.1.1.1.3.cmml">[</mo><msub id="S3.E2.m1.6.6.3.1.1.1.1.1" xref="S3.E2.m1.6.6.3.1.1.1.1.1.cmml"><mover accent="true" id="S3.E2.m1.6.6.3.1.1.1.1.1.2" xref="S3.E2.m1.6.6.3.1.1.1.1.1.2.cmml"><mi id="S3.E2.m1.6.6.3.1.1.1.1.1.2.2" xref="S3.E2.m1.6.6.3.1.1.1.1.1.2.2.cmml">𝒎</mi><mo id="S3.E2.m1.6.6.3.1.1.1.1.1.2.1" xref="S3.E2.m1.6.6.3.1.1.1.1.1.2.1.cmml">~</mo></mover><mrow id="S3.E2.m1.2.2.2.4" xref="S3.E2.m1.2.2.2.3.cmml"><mi id="S3.E2.m1.1.1.1.1" xref="S3.E2.m1.1.1.1.1.cmml">l</mi><mo id="S3.E2.m1.2.2.2.4.1" xref="S3.E2.m1.2.2.2.3.cmml">,</mo><mi id="S3.E2.m1.2.2.2.2" xref="S3.E2.m1.2.2.2.2.cmml">C</mi></mrow></msub><mo id="S3.E2.m1.6.6.3.1.1.1.2.4" xref="S3.E2.m1.6.6.3.1.1.1.3.cmml">,</mo><msub id="S3.E2.m1.6.6.3.1.1.1.2.2" xref="S3.E2.m1.6.6.3.1.1.1.2.2.cmml"><mover accent="true" id="S3.E2.m1.6.6.3.1.1.1.2.2.2" xref="S3.E2.m1.6.6.3.1.1.1.2.2.2.cmml"><mi id="S3.E2.m1.6.6.3.1.1.1.2.2.2.2" xref="S3.E2.m1.6.6.3.1.1.1.2.2.2.2.cmml">r</mi><mo id="S3.E2.m1.6.6.3.1.1.1.2.2.2.1" xref="S3.E2.m1.6.6.3.1.1.1.2.2.2.1.cmml">~</mo></mover><mi id="S3.E2.m1.6.6.3.1.1.1.2.2.3" xref="S3.E2.m1.6.6.3.1.1.1.2.2.3.cmml">l</mi></msub><mo id="S3.E2.m1.6.6.3.1.1.1.2.5" stretchy="false" xref="S3.E2.m1.6.6.3.1.1.1.3.cmml">]</mo></mrow><mo id="S3.E2.m1.6.6.3.1.1.3" stretchy="false" xref="S3.E2.m1.6.6.3.cmml">)</mo></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.E2.m1.6b"><apply id="S3.E2.m1.6.6.cmml" xref="S3.E2.m1.6.6"><ci id="S3.E2.m1.6.6.4.cmml" xref="S3.E2.m1.6.6.4">←</ci><list id="S3.E2.m1.5.5.2.3.cmml" xref="S3.E2.m1.5.5.2.2"><apply id="S3.E2.m1.4.4.1.1.1.cmml" xref="S3.E2.m1.4.4.1.1.1"><csymbol cd="ambiguous" id="S3.E2.m1.4.4.1.1.1.1.cmml" xref="S3.E2.m1.4.4.1.1.1">subscript</csymbol><ci id="S3.E2.m1.4.4.1.1.1.2.cmml" xref="S3.E2.m1.4.4.1.1.1.2">𝒂</ci><ci id="S3.E2.m1.4.4.1.1.1.3.cmml" xref="S3.E2.m1.4.4.1.1.1.3">𝑙</ci></apply><interval closure="closed" id="S3.E2.m1.5.5.2.2.2.2.cmml" xref="S3.E2.m1.5.5.2.2.2.1"><ci id="S3.E2.m1.3.3.cmml" xref="S3.E2.m1.3.3">_</ci><apply id="S3.E2.m1.5.5.2.2.2.1.1.cmml" xref="S3.E2.m1.5.5.2.2.2.1.1"><csymbol cd="ambiguous" id="S3.E2.m1.5.5.2.2.2.1.1.1.cmml" xref="S3.E2.m1.5.5.2.2.2.1.1">subscript</csymbol><apply id="S3.E2.m1.5.5.2.2.2.1.1.2.cmml" xref="S3.E2.m1.5.5.2.2.2.1.1.2"><ci id="S3.E2.m1.5.5.2.2.2.1.1.2.1.cmml" xref="S3.E2.m1.5.5.2.2.2.1.1.2.1">~</ci><ci id="S3.E2.m1.5.5.2.2.2.1.1.2.2.cmml" xref="S3.E2.m1.5.5.2.2.2.1.1.2.2">𝑟</ci></apply><apply id="S3.E2.m1.5.5.2.2.2.1.1.3.cmml" xref="S3.E2.m1.5.5.2.2.2.1.1.3"><minus id="S3.E2.m1.5.5.2.2.2.1.1.3.1.cmml" xref="S3.E2.m1.5.5.2.2.2.1.1.3.1"></minus><ci id="S3.E2.m1.5.5.2.2.2.1.1.3.2.cmml" xref="S3.E2.m1.5.5.2.2.2.1.1.3.2">𝑙</ci><cn id="S3.E2.m1.5.5.2.2.2.1.1.3.3.cmml" type="integer" xref="S3.E2.m1.5.5.2.2.2.1.1.3.3">1</cn></apply></apply></interval></list><apply id="S3.E2.m1.6.6.3.cmml" xref="S3.E2.m1.6.6.3"><times id="S3.E2.m1.6.6.3.2.cmml" xref="S3.E2.m1.6.6.3.2"></times><apply id="S3.E2.m1.6.6.3.3.cmml" xref="S3.E2.m1.6.6.3.3"><csymbol cd="ambiguous" id="S3.E2.m1.6.6.3.3.1.cmml" xref="S3.E2.m1.6.6.3.3">subscript</csymbol><ci id="S3.E2.m1.6.6.3.3.2.cmml" xref="S3.E2.m1.6.6.3.3.2">𝑓</ci><ci id="S3.E2.m1.6.6.3.3.3a.cmml" xref="S3.E2.m1.6.6.3.3.3"><mtext id="S3.E2.m1.6.6.3.3.3.cmml" mathsize="70%" xref="S3.E2.m1.6.6.3.3.3">llm</mtext></ci></apply><interval closure="closed" id="S3.E2.m1.6.6.3.1.1.1.3.cmml" xref="S3.E2.m1.6.6.3.1.1.1.2"><apply id="S3.E2.m1.6.6.3.1.1.1.1.1.cmml" xref="S3.E2.m1.6.6.3.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.E2.m1.6.6.3.1.1.1.1.1.1.cmml" xref="S3.E2.m1.6.6.3.1.1.1.1.1">subscript</csymbol><apply id="S3.E2.m1.6.6.3.1.1.1.1.1.2.cmml" xref="S3.E2.m1.6.6.3.1.1.1.1.1.2"><ci id="S3.E2.m1.6.6.3.1.1.1.1.1.2.1.cmml" xref="S3.E2.m1.6.6.3.1.1.1.1.1.2.1">~</ci><ci id="S3.E2.m1.6.6.3.1.1.1.1.1.2.2.cmml" xref="S3.E2.m1.6.6.3.1.1.1.1.1.2.2">𝒎</ci></apply><list id="S3.E2.m1.2.2.2.3.cmml" xref="S3.E2.m1.2.2.2.4"><ci id="S3.E2.m1.1.1.1.1.cmml" xref="S3.E2.m1.1.1.1.1">𝑙</ci><ci id="S3.E2.m1.2.2.2.2.cmml" xref="S3.E2.m1.2.2.2.2">𝐶</ci></list></apply><apply id="S3.E2.m1.6.6.3.1.1.1.2.2.cmml" xref="S3.E2.m1.6.6.3.1.1.1.2.2"><csymbol cd="ambiguous" id="S3.E2.m1.6.6.3.1.1.1.2.2.1.cmml" xref="S3.E2.m1.6.6.3.1.1.1.2.2">subscript</csymbol><apply id="S3.E2.m1.6.6.3.1.1.1.2.2.2.cmml" xref="S3.E2.m1.6.6.3.1.1.1.2.2.2"><ci id="S3.E2.m1.6.6.3.1.1.1.2.2.2.1.cmml" xref="S3.E2.m1.6.6.3.1.1.1.2.2.2.1">~</ci><ci id="S3.E2.m1.6.6.3.1.1.1.2.2.2.2.cmml" xref="S3.E2.m1.6.6.3.1.1.1.2.2.2.2">𝑟</ci></apply><ci id="S3.E2.m1.6.6.3.1.1.1.2.2.3.cmml" xref="S3.E2.m1.6.6.3.1.1.1.2.2.3">𝑙</ci></apply></interval></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.E2.m1.6c">\displaystyle{\bm{a}}_{l},[\ \_\ ,\tilde{r}_{l-1}]\leftarrow f_{\text{llm}}([%
\tilde{{\bm{m}}}_{l,C},\tilde{r}_{l}])</annotation><annotation encoding="application/x-llamapun" id="S3.E2.m1.6d">bold_italic_a start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT , [ _ , over~ start_ARG italic_r end_ARG start_POSTSUBSCRIPT italic_l - 1 end_POSTSUBSCRIPT ] ← italic_f start_POSTSUBSCRIPT llm end_POSTSUBSCRIPT ( [ over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_l , italic_C end_POSTSUBSCRIPT , over~ start_ARG italic_r end_ARG start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT ] )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(2)</span></td>
</tr></tbody>
<tbody id="S3.Ex6"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle l=L-1,\ ...\ ,0." class="ltx_Math" display="inline" id="S3.Ex6.m1.3"><semantics id="S3.Ex6.m1.3a"><mrow id="S3.Ex6.m1.3.3.1" xref="S3.Ex6.m1.3.3.1.1.cmml"><mrow id="S3.Ex6.m1.3.3.1.1" xref="S3.Ex6.m1.3.3.1.1.cmml"><mi id="S3.Ex6.m1.3.3.1.1.3" xref="S3.Ex6.m1.3.3.1.1.3.cmml">l</mi><mo id="S3.Ex6.m1.3.3.1.1.2" xref="S3.Ex6.m1.3.3.1.1.2.cmml">=</mo><mrow id="S3.Ex6.m1.3.3.1.1.1.1" xref="S3.Ex6.m1.3.3.1.1.1.2.cmml"><mrow id="S3.Ex6.m1.3.3.1.1.1.1.1" xref="S3.Ex6.m1.3.3.1.1.1.1.1.cmml"><mi id="S3.Ex6.m1.3.3.1.1.1.1.1.2" xref="S3.Ex6.m1.3.3.1.1.1.1.1.2.cmml">L</mi><mo id="S3.Ex6.m1.3.3.1.1.1.1.1.1" xref="S3.Ex6.m1.3.3.1.1.1.1.1.1.cmml">−</mo><mn id="S3.Ex6.m1.3.3.1.1.1.1.1.3" xref="S3.Ex6.m1.3.3.1.1.1.1.1.3.cmml">1</mn></mrow><mo id="S3.Ex6.m1.3.3.1.1.1.1.2" rspace="0.667em" xref="S3.Ex6.m1.3.3.1.1.1.2.cmml">,</mo><mi id="S3.Ex6.m1.1.1" mathvariant="normal" xref="S3.Ex6.m1.1.1.cmml">…</mi><mo id="S3.Ex6.m1.3.3.1.1.1.1.3" lspace="0.500em" xref="S3.Ex6.m1.3.3.1.1.1.2.cmml">,</mo><mn id="S3.Ex6.m1.2.2" xref="S3.Ex6.m1.2.2.cmml">0</mn></mrow></mrow><mo id="S3.Ex6.m1.3.3.1.2" lspace="0em" xref="S3.Ex6.m1.3.3.1.1.cmml">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.Ex6.m1.3b"><apply id="S3.Ex6.m1.3.3.1.1.cmml" xref="S3.Ex6.m1.3.3.1"><eq id="S3.Ex6.m1.3.3.1.1.2.cmml" xref="S3.Ex6.m1.3.3.1.1.2"></eq><ci id="S3.Ex6.m1.3.3.1.1.3.cmml" xref="S3.Ex6.m1.3.3.1.1.3">𝑙</ci><list id="S3.Ex6.m1.3.3.1.1.1.2.cmml" xref="S3.Ex6.m1.3.3.1.1.1.1"><apply id="S3.Ex6.m1.3.3.1.1.1.1.1.cmml" xref="S3.Ex6.m1.3.3.1.1.1.1.1"><minus id="S3.Ex6.m1.3.3.1.1.1.1.1.1.cmml" xref="S3.Ex6.m1.3.3.1.1.1.1.1.1"></minus><ci id="S3.Ex6.m1.3.3.1.1.1.1.1.2.cmml" xref="S3.Ex6.m1.3.3.1.1.1.1.1.2">𝐿</ci><cn id="S3.Ex6.m1.3.3.1.1.1.1.1.3.cmml" type="integer" xref="S3.Ex6.m1.3.3.1.1.1.1.1.3">1</cn></apply><ci id="S3.Ex6.m1.1.1.cmml" xref="S3.Ex6.m1.1.1">…</ci><cn id="S3.Ex6.m1.2.2.cmml" type="integer" xref="S3.Ex6.m1.2.2">0</cn></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.Ex6.m1.3c">\displaystyle l=L-1,\ ...\ ,0.</annotation><annotation encoding="application/x-llamapun" id="S3.Ex6.m1.3d">italic_l = italic_L - 1 , … , 0 .</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S3.SS2.p4.13"><math alttext="{\bm{a}}_{l+1}" class="ltx_Math" display="inline" id="S3.SS2.p4.1.m1.1"><semantics id="S3.SS2.p4.1.m1.1a"><msub id="S3.SS2.p4.1.m1.1.1" xref="S3.SS2.p4.1.m1.1.1.cmml"><mi id="S3.SS2.p4.1.m1.1.1.2" xref="S3.SS2.p4.1.m1.1.1.2.cmml">𝒂</mi><mrow id="S3.SS2.p4.1.m1.1.1.3" xref="S3.SS2.p4.1.m1.1.1.3.cmml"><mi id="S3.SS2.p4.1.m1.1.1.3.2" xref="S3.SS2.p4.1.m1.1.1.3.2.cmml">l</mi><mo id="S3.SS2.p4.1.m1.1.1.3.1" xref="S3.SS2.p4.1.m1.1.1.3.1.cmml">+</mo><mn id="S3.SS2.p4.1.m1.1.1.3.3" xref="S3.SS2.p4.1.m1.1.1.3.3.cmml">1</mn></mrow></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.1.m1.1b"><apply id="S3.SS2.p4.1.m1.1.1.cmml" xref="S3.SS2.p4.1.m1.1.1"><csymbol cd="ambiguous" id="S3.SS2.p4.1.m1.1.1.1.cmml" xref="S3.SS2.p4.1.m1.1.1">subscript</csymbol><ci id="S3.SS2.p4.1.m1.1.1.2.cmml" xref="S3.SS2.p4.1.m1.1.1.2">𝒂</ci><apply id="S3.SS2.p4.1.m1.1.1.3.cmml" xref="S3.SS2.p4.1.m1.1.1.3"><plus id="S3.SS2.p4.1.m1.1.1.3.1.cmml" xref="S3.SS2.p4.1.m1.1.1.3.1"></plus><ci id="S3.SS2.p4.1.m1.1.1.3.2.cmml" xref="S3.SS2.p4.1.m1.1.1.3.2">𝑙</ci><cn id="S3.SS2.p4.1.m1.1.1.3.3.cmml" type="integer" xref="S3.SS2.p4.1.m1.1.1.3.3">1</cn></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.1.m1.1c">{\bm{a}}_{l+1}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.1.m1.1d">bold_italic_a start_POSTSUBSCRIPT italic_l + 1 end_POSTSUBSCRIPT</annotation></semantics></math> is the attention of <math alttext="\tilde{r}_{l+1}" class="ltx_Math" display="inline" id="S3.SS2.p4.2.m2.1"><semantics id="S3.SS2.p4.2.m2.1a"><msub id="S3.SS2.p4.2.m2.1.1" xref="S3.SS2.p4.2.m2.1.1.cmml"><mover accent="true" id="S3.SS2.p4.2.m2.1.1.2" xref="S3.SS2.p4.2.m2.1.1.2.cmml"><mi id="S3.SS2.p4.2.m2.1.1.2.2" xref="S3.SS2.p4.2.m2.1.1.2.2.cmml">r</mi><mo id="S3.SS2.p4.2.m2.1.1.2.1" xref="S3.SS2.p4.2.m2.1.1.2.1.cmml">~</mo></mover><mrow id="S3.SS2.p4.2.m2.1.1.3" xref="S3.SS2.p4.2.m2.1.1.3.cmml"><mi id="S3.SS2.p4.2.m2.1.1.3.2" xref="S3.SS2.p4.2.m2.1.1.3.2.cmml">l</mi><mo id="S3.SS2.p4.2.m2.1.1.3.1" xref="S3.SS2.p4.2.m2.1.1.3.1.cmml">+</mo><mn id="S3.SS2.p4.2.m2.1.1.3.3" xref="S3.SS2.p4.2.m2.1.1.3.3.cmml">1</mn></mrow></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.2.m2.1b"><apply id="S3.SS2.p4.2.m2.1.1.cmml" xref="S3.SS2.p4.2.m2.1.1"><csymbol cd="ambiguous" id="S3.SS2.p4.2.m2.1.1.1.cmml" xref="S3.SS2.p4.2.m2.1.1">subscript</csymbol><apply id="S3.SS2.p4.2.m2.1.1.2.cmml" xref="S3.SS2.p4.2.m2.1.1.2"><ci id="S3.SS2.p4.2.m2.1.1.2.1.cmml" xref="S3.SS2.p4.2.m2.1.1.2.1">~</ci><ci id="S3.SS2.p4.2.m2.1.1.2.2.cmml" xref="S3.SS2.p4.2.m2.1.1.2.2">𝑟</ci></apply><apply id="S3.SS2.p4.2.m2.1.1.3.cmml" xref="S3.SS2.p4.2.m2.1.1.3"><plus id="S3.SS2.p4.2.m2.1.1.3.1.cmml" xref="S3.SS2.p4.2.m2.1.1.3.1"></plus><ci id="S3.SS2.p4.2.m2.1.1.3.2.cmml" xref="S3.SS2.p4.2.m2.1.1.3.2">𝑙</ci><cn id="S3.SS2.p4.2.m2.1.1.3.3.cmml" type="integer" xref="S3.SS2.p4.2.m2.1.1.3.3">1</cn></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.2.m2.1c">\tilde{r}_{l+1}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.2.m2.1d">over~ start_ARG italic_r end_ARG start_POSTSUBSCRIPT italic_l + 1 end_POSTSUBSCRIPT</annotation></semantics></math> on the embedding at level <math alttext="l+1" class="ltx_Math" display="inline" id="S3.SS2.p4.3.m3.1"><semantics id="S3.SS2.p4.3.m3.1a"><mrow id="S3.SS2.p4.3.m3.1.1" xref="S3.SS2.p4.3.m3.1.1.cmml"><mi id="S3.SS2.p4.3.m3.1.1.2" xref="S3.SS2.p4.3.m3.1.1.2.cmml">l</mi><mo id="S3.SS2.p4.3.m3.1.1.1" xref="S3.SS2.p4.3.m3.1.1.1.cmml">+</mo><mn id="S3.SS2.p4.3.m3.1.1.3" xref="S3.SS2.p4.3.m3.1.1.3.cmml">1</mn></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.3.m3.1b"><apply id="S3.SS2.p4.3.m3.1.1.cmml" xref="S3.SS2.p4.3.m3.1.1"><plus id="S3.SS2.p4.3.m3.1.1.1.cmml" xref="S3.SS2.p4.3.m3.1.1.1"></plus><ci id="S3.SS2.p4.3.m3.1.1.2.cmml" xref="S3.SS2.p4.3.m3.1.1.2">𝑙</ci><cn id="S3.SS2.p4.3.m3.1.1.3.cmml" type="integer" xref="S3.SS2.p4.3.m3.1.1.3">1</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.3.m3.1c">l+1</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.3.m3.1d">italic_l + 1</annotation></semantics></math>. We define the <math alttext="\text{TopC}(\cdot)" class="ltx_Math" display="inline" id="S3.SS2.p4.4.m4.1"><semantics id="S3.SS2.p4.4.m4.1a"><mrow id="S3.SS2.p4.4.m4.1.2" xref="S3.SS2.p4.4.m4.1.2.cmml"><mtext id="S3.SS2.p4.4.m4.1.2.2" xref="S3.SS2.p4.4.m4.1.2.2a.cmml">TopC</mtext><mo id="S3.SS2.p4.4.m4.1.2.1" xref="S3.SS2.p4.4.m4.1.2.1.cmml">⁢</mo><mrow id="S3.SS2.p4.4.m4.1.2.3.2" xref="S3.SS2.p4.4.m4.1.2.cmml"><mo id="S3.SS2.p4.4.m4.1.2.3.2.1" stretchy="false" xref="S3.SS2.p4.4.m4.1.2.cmml">(</mo><mo id="S3.SS2.p4.4.m4.1.1" lspace="0em" rspace="0em" xref="S3.SS2.p4.4.m4.1.1.cmml">⋅</mo><mo id="S3.SS2.p4.4.m4.1.2.3.2.2" stretchy="false" xref="S3.SS2.p4.4.m4.1.2.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.4.m4.1b"><apply id="S3.SS2.p4.4.m4.1.2.cmml" xref="S3.SS2.p4.4.m4.1.2"><times id="S3.SS2.p4.4.m4.1.2.1.cmml" xref="S3.SS2.p4.4.m4.1.2.1"></times><ci id="S3.SS2.p4.4.m4.1.2.2a.cmml" xref="S3.SS2.p4.4.m4.1.2.2"><mtext id="S3.SS2.p4.4.m4.1.2.2.cmml" xref="S3.SS2.p4.4.m4.1.2.2">TopC</mtext></ci><ci id="S3.SS2.p4.4.m4.1.1.cmml" xref="S3.SS2.p4.4.m4.1.1">⋅</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.4.m4.1c">\text{TopC}(\cdot)</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.4.m4.1d">TopC ( ⋅ )</annotation></semantics></math> function, which will
(1) gather the top <math alttext="C" class="ltx_Math" display="inline" id="S3.SS2.p4.5.m5.1"><semantics id="S3.SS2.p4.5.m5.1a"><mi id="S3.SS2.p4.5.m5.1.1" xref="S3.SS2.p4.5.m5.1.1.cmml">C</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.5.m5.1b"><ci id="S3.SS2.p4.5.m5.1.1.cmml" xref="S3.SS2.p4.5.m5.1.1">𝐶</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.5.m5.1c">C</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.5.m5.1d">italic_C</annotation></semantics></math> indices at level <math alttext="l+1" class="ltx_Math" display="inline" id="S3.SS2.p4.6.m6.1"><semantics id="S3.SS2.p4.6.m6.1a"><mrow id="S3.SS2.p4.6.m6.1.1" xref="S3.SS2.p4.6.m6.1.1.cmml"><mi id="S3.SS2.p4.6.m6.1.1.2" xref="S3.SS2.p4.6.m6.1.1.2.cmml">l</mi><mo id="S3.SS2.p4.6.m6.1.1.1" xref="S3.SS2.p4.6.m6.1.1.1.cmml">+</mo><mn id="S3.SS2.p4.6.m6.1.1.3" xref="S3.SS2.p4.6.m6.1.1.3.cmml">1</mn></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.6.m6.1b"><apply id="S3.SS2.p4.6.m6.1.1.cmml" xref="S3.SS2.p4.6.m6.1.1"><plus id="S3.SS2.p4.6.m6.1.1.1.cmml" xref="S3.SS2.p4.6.m6.1.1.1"></plus><ci id="S3.SS2.p4.6.m6.1.1.2.cmml" xref="S3.SS2.p4.6.m6.1.1.2">𝑙</ci><cn id="S3.SS2.p4.6.m6.1.1.3.cmml" type="integer" xref="S3.SS2.p4.6.m6.1.1.3">1</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.6.m6.1c">l+1</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.6.m6.1d">italic_l + 1</annotation></semantics></math> that has the highest attention score;
and (2) further gather the embeddings at level <math alttext="l" class="ltx_Math" display="inline" id="S3.SS2.p4.7.m7.1"><semantics id="S3.SS2.p4.7.m7.1a"><mi id="S3.SS2.p4.7.m7.1.1" xref="S3.SS2.p4.7.m7.1.1.cmml">l</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.7.m7.1b"><ci id="S3.SS2.p4.7.m7.1.1.cmml" xref="S3.SS2.p4.7.m7.1.1">𝑙</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.7.m7.1c">l</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.7.m7.1d">italic_l</annotation></semantics></math> that were attended by the embeddings indexed by the top <math alttext="C" class="ltx_Math" display="inline" id="S3.SS2.p4.8.m8.1"><semantics id="S3.SS2.p4.8.m8.1a"><mi id="S3.SS2.p4.8.m8.1.1" xref="S3.SS2.p4.8.m8.1.1.cmml">C</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.8.m8.1b"><ci id="S3.SS2.p4.8.m8.1.1.cmml" xref="S3.SS2.p4.8.m8.1.1">𝐶</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.8.m8.1c">C</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.8.m8.1d">italic_C</annotation></semantics></math> indices, making it <math alttext="\tilde{{\bm{m}}}_{l,C}" class="ltx_Math" display="inline" id="S3.SS2.p4.9.m9.2"><semantics id="S3.SS2.p4.9.m9.2a"><msub id="S3.SS2.p4.9.m9.2.3" xref="S3.SS2.p4.9.m9.2.3.cmml"><mover accent="true" id="S3.SS2.p4.9.m9.2.3.2" xref="S3.SS2.p4.9.m9.2.3.2.cmml"><mi id="S3.SS2.p4.9.m9.2.3.2.2" xref="S3.SS2.p4.9.m9.2.3.2.2.cmml">𝒎</mi><mo id="S3.SS2.p4.9.m9.2.3.2.1" xref="S3.SS2.p4.9.m9.2.3.2.1.cmml">~</mo></mover><mrow id="S3.SS2.p4.9.m9.2.2.2.4" xref="S3.SS2.p4.9.m9.2.2.2.3.cmml"><mi id="S3.SS2.p4.9.m9.1.1.1.1" xref="S3.SS2.p4.9.m9.1.1.1.1.cmml">l</mi><mo id="S3.SS2.p4.9.m9.2.2.2.4.1" xref="S3.SS2.p4.9.m9.2.2.2.3.cmml">,</mo><mi id="S3.SS2.p4.9.m9.2.2.2.2" xref="S3.SS2.p4.9.m9.2.2.2.2.cmml">C</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.9.m9.2b"><apply id="S3.SS2.p4.9.m9.2.3.cmml" xref="S3.SS2.p4.9.m9.2.3"><csymbol cd="ambiguous" id="S3.SS2.p4.9.m9.2.3.1.cmml" xref="S3.SS2.p4.9.m9.2.3">subscript</csymbol><apply id="S3.SS2.p4.9.m9.2.3.2.cmml" xref="S3.SS2.p4.9.m9.2.3.2"><ci id="S3.SS2.p4.9.m9.2.3.2.1.cmml" xref="S3.SS2.p4.9.m9.2.3.2.1">~</ci><ci id="S3.SS2.p4.9.m9.2.3.2.2.cmml" xref="S3.SS2.p4.9.m9.2.3.2.2">𝒎</ci></apply><list id="S3.SS2.p4.9.m9.2.2.2.3.cmml" xref="S3.SS2.p4.9.m9.2.2.2.4"><ci id="S3.SS2.p4.9.m9.1.1.1.1.cmml" xref="S3.SS2.p4.9.m9.1.1.1.1">𝑙</ci><ci id="S3.SS2.p4.9.m9.2.2.2.2.cmml" xref="S3.SS2.p4.9.m9.2.2.2.2">𝐶</ci></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.9.m9.2c">\tilde{{\bm{m}}}_{l,C}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.9.m9.2d">over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_l , italic_C end_POSTSUBSCRIPT</annotation></semantics></math>.
In Eq.(<a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S3.E2" title="In 3.2 Retriever ‣ 3 Method ‣ The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_tag">2</span></a>), the <math alttext="\tilde{{\bm{m}}}_{l,C}" class="ltx_Math" display="inline" id="S3.SS2.p4.10.m10.2"><semantics id="S3.SS2.p4.10.m10.2a"><msub id="S3.SS2.p4.10.m10.2.3" xref="S3.SS2.p4.10.m10.2.3.cmml"><mover accent="true" id="S3.SS2.p4.10.m10.2.3.2" xref="S3.SS2.p4.10.m10.2.3.2.cmml"><mi id="S3.SS2.p4.10.m10.2.3.2.2" xref="S3.SS2.p4.10.m10.2.3.2.2.cmml">𝒎</mi><mo id="S3.SS2.p4.10.m10.2.3.2.1" xref="S3.SS2.p4.10.m10.2.3.2.1.cmml">~</mo></mover><mrow id="S3.SS2.p4.10.m10.2.2.2.4" xref="S3.SS2.p4.10.m10.2.2.2.3.cmml"><mi id="S3.SS2.p4.10.m10.1.1.1.1" xref="S3.SS2.p4.10.m10.1.1.1.1.cmml">l</mi><mo id="S3.SS2.p4.10.m10.2.2.2.4.1" xref="S3.SS2.p4.10.m10.2.2.2.3.cmml">,</mo><mi id="S3.SS2.p4.10.m10.2.2.2.2" xref="S3.SS2.p4.10.m10.2.2.2.2.cmml">C</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.10.m10.2b"><apply id="S3.SS2.p4.10.m10.2.3.cmml" xref="S3.SS2.p4.10.m10.2.3"><csymbol cd="ambiguous" id="S3.SS2.p4.10.m10.2.3.1.cmml" xref="S3.SS2.p4.10.m10.2.3">subscript</csymbol><apply id="S3.SS2.p4.10.m10.2.3.2.cmml" xref="S3.SS2.p4.10.m10.2.3.2"><ci id="S3.SS2.p4.10.m10.2.3.2.1.cmml" xref="S3.SS2.p4.10.m10.2.3.2.1">~</ci><ci id="S3.SS2.p4.10.m10.2.3.2.2.cmml" xref="S3.SS2.p4.10.m10.2.3.2.2">𝒎</ci></apply><list id="S3.SS2.p4.10.m10.2.2.2.3.cmml" xref="S3.SS2.p4.10.m10.2.2.2.4"><ci id="S3.SS2.p4.10.m10.1.1.1.1.cmml" xref="S3.SS2.p4.10.m10.1.1.1.1">𝑙</ci><ci id="S3.SS2.p4.10.m10.2.2.2.2.cmml" xref="S3.SS2.p4.10.m10.2.2.2.2">𝐶</ci></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.10.m10.2c">\tilde{{\bm{m}}}_{l,C}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.10.m10.2d">over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT italic_l , italic_C end_POSTSUBSCRIPT</annotation></semantics></math> of length <math alttext="C*k" class="ltx_Math" display="inline" id="S3.SS2.p4.11.m11.1"><semantics id="S3.SS2.p4.11.m11.1a"><mrow id="S3.SS2.p4.11.m11.1.1" xref="S3.SS2.p4.11.m11.1.1.cmml"><mi id="S3.SS2.p4.11.m11.1.1.2" xref="S3.SS2.p4.11.m11.1.1.2.cmml">C</mi><mo id="S3.SS2.p4.11.m11.1.1.1" lspace="0.222em" rspace="0.222em" xref="S3.SS2.p4.11.m11.1.1.1.cmml">∗</mo><mi id="S3.SS2.p4.11.m11.1.1.3" xref="S3.SS2.p4.11.m11.1.1.3.cmml">k</mi></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.11.m11.1b"><apply id="S3.SS2.p4.11.m11.1.1.cmml" xref="S3.SS2.p4.11.m11.1.1"><times id="S3.SS2.p4.11.m11.1.1.1.cmml" xref="S3.SS2.p4.11.m11.1.1.1"></times><ci id="S3.SS2.p4.11.m11.1.1.2.cmml" xref="S3.SS2.p4.11.m11.1.1.2">𝐶</ci><ci id="S3.SS2.p4.11.m11.1.1.3.cmml" xref="S3.SS2.p4.11.m11.1.1.3">𝑘</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.11.m11.1c">C*k</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.11.m11.1d">italic_C ∗ italic_k</annotation></semantics></math> (recall that each embedding attends to <math alttext="k" class="ltx_Math" display="inline" id="S3.SS2.p4.12.m12.1"><semantics id="S3.SS2.p4.12.m12.1a"><mi id="S3.SS2.p4.12.m12.1.1" xref="S3.SS2.p4.12.m12.1.1.cmml">k</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.12.m12.1b"><ci id="S3.SS2.p4.12.m12.1.1.cmml" xref="S3.SS2.p4.12.m12.1.1">𝑘</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.12.m12.1c">k</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.12.m12.1d">italic_k</annotation></semantics></math> lower-level embeddings) becomes the input of lower-level self-attention together with the lower-level retrieval embedding <math alttext="\tilde{r}_{l}" class="ltx_Math" display="inline" id="S3.SS2.p4.13.m13.1"><semantics id="S3.SS2.p4.13.m13.1a"><msub id="S3.SS2.p4.13.m13.1.1" xref="S3.SS2.p4.13.m13.1.1.cmml"><mover accent="true" id="S3.SS2.p4.13.m13.1.1.2" xref="S3.SS2.p4.13.m13.1.1.2.cmml"><mi id="S3.SS2.p4.13.m13.1.1.2.2" xref="S3.SS2.p4.13.m13.1.1.2.2.cmml">r</mi><mo id="S3.SS2.p4.13.m13.1.1.2.1" xref="S3.SS2.p4.13.m13.1.1.2.1.cmml">~</mo></mover><mi id="S3.SS2.p4.13.m13.1.1.3" xref="S3.SS2.p4.13.m13.1.1.3.cmml">l</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p4.13.m13.1b"><apply id="S3.SS2.p4.13.m13.1.1.cmml" xref="S3.SS2.p4.13.m13.1.1"><csymbol cd="ambiguous" id="S3.SS2.p4.13.m13.1.1.1.cmml" xref="S3.SS2.p4.13.m13.1.1">subscript</csymbol><apply id="S3.SS2.p4.13.m13.1.1.2.cmml" xref="S3.SS2.p4.13.m13.1.1.2"><ci id="S3.SS2.p4.13.m13.1.1.2.1.cmml" xref="S3.SS2.p4.13.m13.1.1.2.1">~</ci><ci id="S3.SS2.p4.13.m13.1.1.2.2.cmml" xref="S3.SS2.p4.13.m13.1.1.2.2">𝑟</ci></apply><ci id="S3.SS2.p4.13.m13.1.1.3.cmml" xref="S3.SS2.p4.13.m13.1.1.3">𝑙</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p4.13.m13.1c">\tilde{r}_{l}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p4.13.m13.1d">over~ start_ARG italic_r end_ARG start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT</annotation></semantics></math>.</p>
</div>
<div class="ltx_para ltx_noindent" id="S3.SS2.p5">
<p class="ltx_p" id="S3.SS2.p5.3">Intuitively, through Eq.(<a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S3.E1" title="In 3.2 Retriever ‣ 3 Method ‣ The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_tag">1</span></a>) and Eq.(<a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S3.E2" title="In 3.2 Retriever ‣ 3 Method ‣ The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_tag">2</span></a>), <span class="ltx_text ltx_font_bold" id="S3.SS2.p5.3.1">we achieve a dynamic retrieval scheme that searches and aggregates context at different levels of granularities suiting the need of the current task with pure self-attention operations</span>.
At each level, we aggregate all context into <math alttext="\tilde{r}_{l}" class="ltx_Math" display="inline" id="S3.SS2.p5.1.m1.1"><semantics id="S3.SS2.p5.1.m1.1a"><msub id="S3.SS2.p5.1.m1.1.1" xref="S3.SS2.p5.1.m1.1.1.cmml"><mover accent="true" id="S3.SS2.p5.1.m1.1.1.2" xref="S3.SS2.p5.1.m1.1.1.2.cmml"><mi id="S3.SS2.p5.1.m1.1.1.2.2" xref="S3.SS2.p5.1.m1.1.1.2.2.cmml">r</mi><mo id="S3.SS2.p5.1.m1.1.1.2.1" xref="S3.SS2.p5.1.m1.1.1.2.1.cmml">~</mo></mover><mi id="S3.SS2.p5.1.m1.1.1.3" xref="S3.SS2.p5.1.m1.1.1.3.cmml">l</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p5.1.m1.1b"><apply id="S3.SS2.p5.1.m1.1.1.cmml" xref="S3.SS2.p5.1.m1.1.1"><csymbol cd="ambiguous" id="S3.SS2.p5.1.m1.1.1.1.cmml" xref="S3.SS2.p5.1.m1.1.1">subscript</csymbol><apply id="S3.SS2.p5.1.m1.1.1.2.cmml" xref="S3.SS2.p5.1.m1.1.1.2"><ci id="S3.SS2.p5.1.m1.1.1.2.1.cmml" xref="S3.SS2.p5.1.m1.1.1.2.1">~</ci><ci id="S3.SS2.p5.1.m1.1.1.2.2.cmml" xref="S3.SS2.p5.1.m1.1.1.2.2">𝑟</ci></apply><ci id="S3.SS2.p5.1.m1.1.1.3.cmml" xref="S3.SS2.p5.1.m1.1.1.3">𝑙</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p5.1.m1.1c">\tilde{r}_{l}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p5.1.m1.1d">over~ start_ARG italic_r end_ARG start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT</annotation></semantics></math> through self-attention, making sure all information at this level of granularity is gathered.
And then based on the attention <math alttext="{\bm{a}}_{l}" class="ltx_Math" display="inline" id="S3.SS2.p5.2.m2.1"><semantics id="S3.SS2.p5.2.m2.1a"><msub id="S3.SS2.p5.2.m2.1.1" xref="S3.SS2.p5.2.m2.1.1.cmml"><mi id="S3.SS2.p5.2.m2.1.1.2" xref="S3.SS2.p5.2.m2.1.1.2.cmml">𝒂</mi><mi id="S3.SS2.p5.2.m2.1.1.3" xref="S3.SS2.p5.2.m2.1.1.3.cmml">l</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p5.2.m2.1b"><apply id="S3.SS2.p5.2.m2.1.1.cmml" xref="S3.SS2.p5.2.m2.1.1"><csymbol cd="ambiguous" id="S3.SS2.p5.2.m2.1.1.1.cmml" xref="S3.SS2.p5.2.m2.1.1">subscript</csymbol><ci id="S3.SS2.p5.2.m2.1.1.2.cmml" xref="S3.SS2.p5.2.m2.1.1.2">𝒂</ci><ci id="S3.SS2.p5.2.m2.1.1.3.cmml" xref="S3.SS2.p5.2.m2.1.1.3">𝑙</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p5.2.m2.1c">{\bm{a}}_{l}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p5.2.m2.1d">bold_italic_a start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT</annotation></semantics></math>, we further identify the “parts” that the models are more interested in, which presumably are the context that are more relevant, and thus require more fine-grained information.
We collect the top <math alttext="C" class="ltx_Math" display="inline" id="S3.SS2.p5.3.m3.1"><semantics id="S3.SS2.p5.3.m3.1a"><mi id="S3.SS2.p5.3.m3.1.1" xref="S3.SS2.p5.3.m3.1.1.cmml">C</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p5.3.m3.1b"><ci id="S3.SS2.p5.3.m3.1.1.cmml" xref="S3.SS2.p5.3.m3.1.1">𝐶</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p5.3.m3.1c">C</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p5.3.m3.1d">italic_C</annotation></semantics></math> of those and their lower-level embeddings and proceed with a lower-level search until we hit the bottom.</p>
</div>
</section>
</section>
<section class="ltx_section" id="S4">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">4 </span>Training, Inference, and Performance</h2>
<section class="ltx_subsection" id="S4.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.1 </span>Training</h3>
<div class="ltx_para ltx_noindent" id="S4.SS1.p1">
<p class="ltx_p" id="S4.SS1.p1.1">The compressor-retriever architecture does not introduce additional standalone modules. While we believe the pre-trained LLMs have already acquired the necessary capabilities, it still requires fine-tuning to elicit such capabilities.
Setting up the training data and pipeline is nontrivial.
We will discuss the challenges and our proposed solutions in four aspects: parameters, training objectives, data, and performance considerations.</p>
</div>
<div class="ltx_para ltx_noindent" id="S4.SS1.p2">
<p class="ltx_p" id="S4.SS1.p2.1"><span class="ltx_text ltx_font_bold" id="S4.SS1.p2.1.1">Trainable parameters</span>.
The minimum parameters to train to run the architecture are the two embeddings for <span class="ltx_text ltx_font_typewriter" id="S4.SS1.p2.1.2">&lt;mem&gt;</span> and <span class="ltx_text ltx_font_typewriter" id="S4.SS1.p2.1.3">&lt;ret&gt;</span> tokens.
However, in experiments, we find the best performance is achieved by also fine-tuning the base LLM’s parameters. This observation is also confirmed in related work <cite class="ltx_cite ltx_citemacro_citep">(Chevalier et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib3" title="">2023</a>; Ge et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib9" title="">2023</a>)</cite>.
In our preliminary experiments, we find LoRA fine-tuning to be sufficient. However, one may as well do full parameter fine-tuning for optimal performance given enough hardware resources.
In summary, the trainable parameters are the LoRA adapters over all linear layers and the two embeddings.</p>
</div>
<div class="ltx_para ltx_noindent" id="S4.SS1.p3">
<p class="ltx_p" id="S4.SS1.p3.2"><span class="ltx_text ltx_font_bold" id="S4.SS1.p3.2.1">Training objectives</span>.
As the architecture is end-to-end differentiable, training the model to learn to compress and retrieve context becomes straightforward.
We use the standard autoregressive objective</p>
<table class="ltx_equation ltx_eqn_table" id="S4.Ex7">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="{\mathcal{L}}=-\frac{1}{n}\sum_{t=1}^{n}\log p(x_{t+1}|x_{t},...,x_{1},{\bm{M}%
})," class="ltx_Math" display="block" id="S4.Ex7.m1.3"><semantics id="S4.Ex7.m1.3a"><mrow id="S4.Ex7.m1.3.3.1" xref="S4.Ex7.m1.3.3.1.1.cmml"><mrow id="S4.Ex7.m1.3.3.1.1" xref="S4.Ex7.m1.3.3.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex7.m1.3.3.1.1.3" xref="S4.Ex7.m1.3.3.1.1.3.cmml">ℒ</mi><mo id="S4.Ex7.m1.3.3.1.1.2" xref="S4.Ex7.m1.3.3.1.1.2.cmml">=</mo><mrow id="S4.Ex7.m1.3.3.1.1.1" xref="S4.Ex7.m1.3.3.1.1.1.cmml"><mo id="S4.Ex7.m1.3.3.1.1.1a" xref="S4.Ex7.m1.3.3.1.1.1.cmml">−</mo><mrow id="S4.Ex7.m1.3.3.1.1.1.1" xref="S4.Ex7.m1.3.3.1.1.1.1.cmml"><mfrac id="S4.Ex7.m1.3.3.1.1.1.1.3" xref="S4.Ex7.m1.3.3.1.1.1.1.3.cmml"><mn id="S4.Ex7.m1.3.3.1.1.1.1.3.2" xref="S4.Ex7.m1.3.3.1.1.1.1.3.2.cmml">1</mn><mi id="S4.Ex7.m1.3.3.1.1.1.1.3.3" xref="S4.Ex7.m1.3.3.1.1.1.1.3.3.cmml">n</mi></mfrac><mo id="S4.Ex7.m1.3.3.1.1.1.1.2" xref="S4.Ex7.m1.3.3.1.1.1.1.2.cmml">⁢</mo><mrow id="S4.Ex7.m1.3.3.1.1.1.1.1" xref="S4.Ex7.m1.3.3.1.1.1.1.1.cmml"><munderover id="S4.Ex7.m1.3.3.1.1.1.1.1.2" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.cmml"><mo id="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.2" movablelimits="false" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.2.cmml">∑</mo><mrow id="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.cmml"><mi id="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.2" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.2.cmml">t</mi><mo id="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.1" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.1.cmml">=</mo><mn id="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.3" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.3.cmml">1</mn></mrow><mi id="S4.Ex7.m1.3.3.1.1.1.1.1.2.3" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.3.cmml">n</mi></munderover><mrow id="S4.Ex7.m1.3.3.1.1.1.1.1.1" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.cmml"><mrow id="S4.Ex7.m1.3.3.1.1.1.1.1.1.3" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.3.cmml"><mi id="S4.Ex7.m1.3.3.1.1.1.1.1.1.3.1" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.3.1.cmml">log</mi><mo id="S4.Ex7.m1.3.3.1.1.1.1.1.1.3a" lspace="0.167em" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.3.cmml">⁡</mo><mi id="S4.Ex7.m1.3.3.1.1.1.1.1.1.3.2" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.3.2.cmml">p</mi></mrow><mo id="S4.Ex7.m1.3.3.1.1.1.1.1.1.2" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.2.cmml">⁢</mo><mrow id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.cmml"><mo id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.2" stretchy="false" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.cmml">(</mo><mrow id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.cmml"><msub id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.cmml"><mi id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.2" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.2.cmml">x</mi><mrow id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.cmml"><mi id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.2" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.2.cmml">t</mi><mo id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.1" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.1.cmml">+</mo><mn id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.3" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.3.cmml">1</mn></mrow></msub><mo fence="false" id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.3" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.3.cmml">|</mo><mrow id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.3.cmml"><msub id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1.cmml"><mi id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1.2" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml">x</mi><mi id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1.3" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1.3.cmml">t</mi></msub><mo id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.3" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.3.cmml">,</mo><mi id="S4.Ex7.m1.1.1" mathvariant="normal" xref="S4.Ex7.m1.1.1.cmml">…</mi><mo id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.4" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.3.cmml">,</mo><msub id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2.cmml"><mi id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2.2" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2.2.cmml">x</mi><mn id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2.3" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2.3.cmml">1</mn></msub><mo id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.5" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.3.cmml">,</mo><mi id="S4.Ex7.m1.2.2" xref="S4.Ex7.m1.2.2.cmml">𝑴</mi></mrow></mrow><mo id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.3" stretchy="false" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow></mrow></mrow></mrow><mo id="S4.Ex7.m1.3.3.1.2" xref="S4.Ex7.m1.3.3.1.1.cmml">,</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.Ex7.m1.3b"><apply id="S4.Ex7.m1.3.3.1.1.cmml" xref="S4.Ex7.m1.3.3.1"><eq id="S4.Ex7.m1.3.3.1.1.2.cmml" xref="S4.Ex7.m1.3.3.1.1.2"></eq><ci id="S4.Ex7.m1.3.3.1.1.3.cmml" xref="S4.Ex7.m1.3.3.1.1.3">ℒ</ci><apply id="S4.Ex7.m1.3.3.1.1.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1"><minus id="S4.Ex7.m1.3.3.1.1.1.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1"></minus><apply id="S4.Ex7.m1.3.3.1.1.1.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1"><times id="S4.Ex7.m1.3.3.1.1.1.1.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.2"></times><apply id="S4.Ex7.m1.3.3.1.1.1.1.3.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.3"><divide id="S4.Ex7.m1.3.3.1.1.1.1.3.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.3"></divide><cn id="S4.Ex7.m1.3.3.1.1.1.1.3.2.cmml" type="integer" xref="S4.Ex7.m1.3.3.1.1.1.1.3.2">1</cn><ci id="S4.Ex7.m1.3.3.1.1.1.1.3.3.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.3.3">𝑛</ci></apply><apply id="S4.Ex7.m1.3.3.1.1.1.1.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1"><apply id="S4.Ex7.m1.3.3.1.1.1.1.1.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.Ex7.m1.3.3.1.1.1.1.1.2.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2">superscript</csymbol><apply id="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2">subscript</csymbol><sum id="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.2"></sum><apply id="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3"><eq id="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.1"></eq><ci id="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.2">𝑡</ci><cn id="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.3.cmml" type="integer" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.2.3.3">1</cn></apply></apply><ci id="S4.Ex7.m1.3.3.1.1.1.1.1.2.3.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.2.3">𝑛</ci></apply><apply id="S4.Ex7.m1.3.3.1.1.1.1.1.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1"><times id="S4.Ex7.m1.3.3.1.1.1.1.1.1.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.2"></times><apply id="S4.Ex7.m1.3.3.1.1.1.1.1.1.3.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.3"><log id="S4.Ex7.m1.3.3.1.1.1.1.1.1.3.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.3.1"></log><ci id="S4.Ex7.m1.3.3.1.1.1.1.1.1.3.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.3.2">𝑝</ci></apply><apply id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1"><csymbol cd="latexml" id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.3.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.3">conditional</csymbol><apply id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4"><csymbol cd="ambiguous" id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4">subscript</csymbol><ci id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.2">𝑥</ci><apply id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3"><plus id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.1"></plus><ci id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.2">𝑡</ci><cn id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.3.cmml" type="integer" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.4.3.3">1</cn></apply></apply><list id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.3.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2"><apply id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1">subscript</csymbol><ci id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1.2">𝑥</ci><ci id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1.3.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.1.1.1.3">𝑡</ci></apply><ci id="S4.Ex7.m1.1.1.cmml" xref="S4.Ex7.m1.1.1">…</ci><apply id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2"><csymbol cd="ambiguous" id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2.1.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2">subscript</csymbol><ci id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2.2.cmml" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2.2">𝑥</ci><cn id="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2.3.cmml" type="integer" xref="S4.Ex7.m1.3.3.1.1.1.1.1.1.1.1.1.2.2.2.3">1</cn></apply><ci id="S4.Ex7.m1.2.2.cmml" xref="S4.Ex7.m1.2.2">𝑴</ci></list></apply></apply></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.Ex7.m1.3c">{\mathcal{L}}=-\frac{1}{n}\sum_{t=1}^{n}\log p(x_{t+1}|x_{t},...,x_{1},{\bm{M}%
}),</annotation><annotation encoding="application/x-llamapun" id="S4.Ex7.m1.3d">caligraphic_L = - divide start_ARG 1 end_ARG start_ARG italic_n end_ARG ∑ start_POSTSUBSCRIPT italic_t = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_n end_POSTSUPERSCRIPT roman_log italic_p ( italic_x start_POSTSUBSCRIPT italic_t + 1 end_POSTSUBSCRIPT | italic_x start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT , … , italic_x start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , bold_italic_M ) ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS1.p3.1">where the model predicts the next token given the previous context and the hierarchical database <math alttext="{\bm{M}}=[\tilde{{\bm{m}}}_{0},\tilde{{\bm{m}}}_{1},...]" class="ltx_Math" display="inline" id="S4.SS1.p3.1.m1.3"><semantics id="S4.SS1.p3.1.m1.3a"><mrow id="S4.SS1.p3.1.m1.3.3" xref="S4.SS1.p3.1.m1.3.3.cmml"><mi id="S4.SS1.p3.1.m1.3.3.4" xref="S4.SS1.p3.1.m1.3.3.4.cmml">𝑴</mi><mo id="S4.SS1.p3.1.m1.3.3.3" xref="S4.SS1.p3.1.m1.3.3.3.cmml">=</mo><mrow id="S4.SS1.p3.1.m1.3.3.2.2" xref="S4.SS1.p3.1.m1.3.3.2.3.cmml"><mo id="S4.SS1.p3.1.m1.3.3.2.2.3" stretchy="false" xref="S4.SS1.p3.1.m1.3.3.2.3.cmml">[</mo><msub id="S4.SS1.p3.1.m1.2.2.1.1.1" xref="S4.SS1.p3.1.m1.2.2.1.1.1.cmml"><mover accent="true" id="S4.SS1.p3.1.m1.2.2.1.1.1.2" xref="S4.SS1.p3.1.m1.2.2.1.1.1.2.cmml"><mi id="S4.SS1.p3.1.m1.2.2.1.1.1.2.2" xref="S4.SS1.p3.1.m1.2.2.1.1.1.2.2.cmml">𝒎</mi><mo id="S4.SS1.p3.1.m1.2.2.1.1.1.2.1" xref="S4.SS1.p3.1.m1.2.2.1.1.1.2.1.cmml">~</mo></mover><mn id="S4.SS1.p3.1.m1.2.2.1.1.1.3" xref="S4.SS1.p3.1.m1.2.2.1.1.1.3.cmml">0</mn></msub><mo id="S4.SS1.p3.1.m1.3.3.2.2.4" xref="S4.SS1.p3.1.m1.3.3.2.3.cmml">,</mo><msub id="S4.SS1.p3.1.m1.3.3.2.2.2" xref="S4.SS1.p3.1.m1.3.3.2.2.2.cmml"><mover accent="true" id="S4.SS1.p3.1.m1.3.3.2.2.2.2" xref="S4.SS1.p3.1.m1.3.3.2.2.2.2.cmml"><mi id="S4.SS1.p3.1.m1.3.3.2.2.2.2.2" xref="S4.SS1.p3.1.m1.3.3.2.2.2.2.2.cmml">𝒎</mi><mo id="S4.SS1.p3.1.m1.3.3.2.2.2.2.1" xref="S4.SS1.p3.1.m1.3.3.2.2.2.2.1.cmml">~</mo></mover><mn id="S4.SS1.p3.1.m1.3.3.2.2.2.3" xref="S4.SS1.p3.1.m1.3.3.2.2.2.3.cmml">1</mn></msub><mo id="S4.SS1.p3.1.m1.3.3.2.2.5" xref="S4.SS1.p3.1.m1.3.3.2.3.cmml">,</mo><mi id="S4.SS1.p3.1.m1.1.1" mathvariant="normal" xref="S4.SS1.p3.1.m1.1.1.cmml">…</mi><mo id="S4.SS1.p3.1.m1.3.3.2.2.6" stretchy="false" xref="S4.SS1.p3.1.m1.3.3.2.3.cmml">]</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.SS1.p3.1.m1.3b"><apply id="S4.SS1.p3.1.m1.3.3.cmml" xref="S4.SS1.p3.1.m1.3.3"><eq id="S4.SS1.p3.1.m1.3.3.3.cmml" xref="S4.SS1.p3.1.m1.3.3.3"></eq><ci id="S4.SS1.p3.1.m1.3.3.4.cmml" xref="S4.SS1.p3.1.m1.3.3.4">𝑴</ci><list id="S4.SS1.p3.1.m1.3.3.2.3.cmml" xref="S4.SS1.p3.1.m1.3.3.2.2"><apply id="S4.SS1.p3.1.m1.2.2.1.1.1.cmml" xref="S4.SS1.p3.1.m1.2.2.1.1.1"><csymbol cd="ambiguous" id="S4.SS1.p3.1.m1.2.2.1.1.1.1.cmml" xref="S4.SS1.p3.1.m1.2.2.1.1.1">subscript</csymbol><apply id="S4.SS1.p3.1.m1.2.2.1.1.1.2.cmml" xref="S4.SS1.p3.1.m1.2.2.1.1.1.2"><ci id="S4.SS1.p3.1.m1.2.2.1.1.1.2.1.cmml" xref="S4.SS1.p3.1.m1.2.2.1.1.1.2.1">~</ci><ci id="S4.SS1.p3.1.m1.2.2.1.1.1.2.2.cmml" xref="S4.SS1.p3.1.m1.2.2.1.1.1.2.2">𝒎</ci></apply><cn id="S4.SS1.p3.1.m1.2.2.1.1.1.3.cmml" type="integer" xref="S4.SS1.p3.1.m1.2.2.1.1.1.3">0</cn></apply><apply id="S4.SS1.p3.1.m1.3.3.2.2.2.cmml" xref="S4.SS1.p3.1.m1.3.3.2.2.2"><csymbol cd="ambiguous" id="S4.SS1.p3.1.m1.3.3.2.2.2.1.cmml" xref="S4.SS1.p3.1.m1.3.3.2.2.2">subscript</csymbol><apply id="S4.SS1.p3.1.m1.3.3.2.2.2.2.cmml" xref="S4.SS1.p3.1.m1.3.3.2.2.2.2"><ci id="S4.SS1.p3.1.m1.3.3.2.2.2.2.1.cmml" xref="S4.SS1.p3.1.m1.3.3.2.2.2.2.1">~</ci><ci id="S4.SS1.p3.1.m1.3.3.2.2.2.2.2.cmml" xref="S4.SS1.p3.1.m1.3.3.2.2.2.2.2">𝒎</ci></apply><cn id="S4.SS1.p3.1.m1.3.3.2.2.2.3.cmml" type="integer" xref="S4.SS1.p3.1.m1.3.3.2.2.2.3">1</cn></apply><ci id="S4.SS1.p3.1.m1.1.1.cmml" xref="S4.SS1.p3.1.m1.1.1">…</ci></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p3.1.m1.3c">{\bm{M}}=[\tilde{{\bm{m}}}_{0},\tilde{{\bm{m}}}_{1},...]</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p3.1.m1.3d">bold_italic_M = [ over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT 0 end_POSTSUBSCRIPT , over~ start_ARG bold_italic_m end_ARG start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , … ]</annotation></semantics></math>.
Intuitively, to predict the next token, the model learns to retrieve the most relevant and predictive context from the database.
In experiments, we find this objective is sufficient, which aligns with the observations in prior work <cite class="ltx_cite ltx_citemacro_citep">(Chevalier et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib3" title="">2023</a>)</cite>.
We leave investigations of other objectives such as the reconstruction loss <cite class="ltx_cite ltx_citemacro_citep">Ge et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib9" title="">2023</a></cite> in future development.</p>
</div>
<div class="ltx_para ltx_noindent" id="S4.SS1.p4">
<p class="ltx_p" id="S4.SS1.p4.1"><span class="ltx_text ltx_font_bold" id="S4.SS1.p4.1.1">Data</span>.
Training the model to effectively use the compression and retrieval capability, requires careful curation of the training and inference dataset.
Unlike the standard pertaining where sequences are typically 4K long, one must collect high-quality long-context data. However, compared to those short-context pertaining data such as The Pile <cite class="ltx_cite ltx_citemacro_citep">(Gao et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib8" title="">2020</a>)</cite> and FineWeb <cite class="ltx_cite ltx_citemacro_citep">(Penedo et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib17" title="">2024</a>)</cite>, native long-context data are almost non-existent.
To this end, many works resort to either privately collected data or synthetic data <cite class="ltx_cite ltx_citemacro_citep">(Dubey et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib7" title="">2024</a>; DeepSeek-AI et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib6" title="">2024</a>)</cite>.
In our experiments, we sidestep this challenge by validating our architecture on a small-scale problem, and we leave this part in future development.</p>
</div>
<div class="ltx_para ltx_noindent" id="S4.SS1.p5">
<p class="ltx_p" id="S4.SS1.p5.1">Apart from the data enabling the capabilities, we also need to collect data to teach the model to manage the context during inference. This is similar to a <span class="ltx_text ltx_font_italic" id="S4.SS1.p5.1.1">instruction fine-tuning</span> dataset.
For example, during inference, the model needs to know when to initiate the retrieval.
We plan to address this by constructing fine-tune dataset with special retrieval tokens <span class="ltx_text ltx_font_typewriter" id="S4.SS1.p5.1.2">&lt;call_retrival&gt;</span> inserted, where the model learns to decode such a token to initiate the process. Such an approach is also used in the dataset construction of prior tool-using works <cite class="ltx_cite ltx_citemacro_citep">(Schick et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib19" title="">2024</a>; Hao et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib11" title="">2024</a>)</cite>.</p>
</div>
<div class="ltx_para ltx_noindent" id="S4.SS1.p6">
<p class="ltx_p" id="S4.SS1.p6.9"><span class="ltx_text ltx_font_bold" id="S4.SS1.p6.9.1">Performance considerations</span>.
Compared to the standard autoregressive training, our training is more expensive.
For a target sequence <math alttext="{\bm{x}}" class="ltx_Math" display="inline" id="S4.SS1.p6.1.m1.1"><semantics id="S4.SS1.p6.1.m1.1a"><mi id="S4.SS1.p6.1.m1.1.1" xref="S4.SS1.p6.1.m1.1.1.cmml">𝒙</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p6.1.m1.1b"><ci id="S4.SS1.p6.1.m1.1.1.cmml" xref="S4.SS1.p6.1.m1.1.1">𝒙</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p6.1.m1.1c">{\bm{x}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p6.1.m1.1d">bold_italic_x</annotation></semantics></math>, standard training performs forward only once with <math alttext="{\bm{x}}" class="ltx_Math" display="inline" id="S4.SS1.p6.2.m2.1"><semantics id="S4.SS1.p6.2.m2.1a"><mi id="S4.SS1.p6.2.m2.1.1" xref="S4.SS1.p6.2.m2.1.1.cmml">𝒙</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p6.2.m2.1b"><ci id="S4.SS1.p6.2.m2.1.1.cmml" xref="S4.SS1.p6.2.m2.1.1">𝒙</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p6.2.m2.1c">{\bm{x}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p6.2.m2.1d">bold_italic_x</annotation></semantics></math> as the input to get the predicted labels, and only intermediate activations of this forward will be saved for backward pass.
Our case is to some extent similar to recurrent models such as RNN, as the label prediction is dependent on the output of the previous forward.
Specifically, let <math alttext="{\bm{c}}" class="ltx_Math" display="inline" id="S4.SS1.p6.3.m3.1"><semantics id="S4.SS1.p6.3.m3.1a"><mi id="S4.SS1.p6.3.m3.1.1" xref="S4.SS1.p6.3.m3.1.1.cmml">𝒄</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p6.3.m3.1b"><ci id="S4.SS1.p6.3.m3.1.1.cmml" xref="S4.SS1.p6.3.m3.1.1">𝒄</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p6.3.m3.1c">{\bm{c}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p6.3.m3.1d">bold_italic_c</annotation></semantics></math> be the context of length <math alttext="n" class="ltx_Math" display="inline" id="S4.SS1.p6.4.m4.1"><semantics id="S4.SS1.p6.4.m4.1a"><mi id="S4.SS1.p6.4.m4.1.1" xref="S4.SS1.p6.4.m4.1.1.cmml">n</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p6.4.m4.1b"><ci id="S4.SS1.p6.4.m4.1.1.cmml" xref="S4.SS1.p6.4.m4.1.1">𝑛</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p6.4.m4.1c">n</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p6.4.m4.1d">italic_n</annotation></semantics></math> and <math alttext="k" class="ltx_Math" display="inline" id="S4.SS1.p6.5.m5.1"><semantics id="S4.SS1.p6.5.m5.1a"><mi id="S4.SS1.p6.5.m5.1.1" xref="S4.SS1.p6.5.m5.1.1.cmml">k</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p6.5.m5.1b"><ci id="S4.SS1.p6.5.m5.1.1.cmml" xref="S4.SS1.p6.5.m5.1.1">𝑘</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p6.5.m5.1c">k</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p6.5.m5.1d">italic_k</annotation></semantics></math> be the compression factor.
First, it takes <math alttext="L=\lceil\log_{k}n\rceil" class="ltx_Math" display="inline" id="S4.SS1.p6.6.m6.1"><semantics id="S4.SS1.p6.6.m6.1a"><mrow id="S4.SS1.p6.6.m6.1.1" xref="S4.SS1.p6.6.m6.1.1.cmml"><mi id="S4.SS1.p6.6.m6.1.1.3" xref="S4.SS1.p6.6.m6.1.1.3.cmml">L</mi><mo id="S4.SS1.p6.6.m6.1.1.2" xref="S4.SS1.p6.6.m6.1.1.2.cmml">=</mo><mrow id="S4.SS1.p6.6.m6.1.1.1.1" xref="S4.SS1.p6.6.m6.1.1.1.2.cmml"><mo id="S4.SS1.p6.6.m6.1.1.1.1.2" stretchy="false" xref="S4.SS1.p6.6.m6.1.1.1.2.1.cmml">⌈</mo><mrow id="S4.SS1.p6.6.m6.1.1.1.1.1" xref="S4.SS1.p6.6.m6.1.1.1.1.1.cmml"><msub id="S4.SS1.p6.6.m6.1.1.1.1.1.1" xref="S4.SS1.p6.6.m6.1.1.1.1.1.1.cmml"><mi id="S4.SS1.p6.6.m6.1.1.1.1.1.1.2" xref="S4.SS1.p6.6.m6.1.1.1.1.1.1.2.cmml">log</mi><mi id="S4.SS1.p6.6.m6.1.1.1.1.1.1.3" xref="S4.SS1.p6.6.m6.1.1.1.1.1.1.3.cmml">k</mi></msub><mo id="S4.SS1.p6.6.m6.1.1.1.1.1a" lspace="0.167em" xref="S4.SS1.p6.6.m6.1.1.1.1.1.cmml">⁡</mo><mi id="S4.SS1.p6.6.m6.1.1.1.1.1.2" xref="S4.SS1.p6.6.m6.1.1.1.1.1.2.cmml">n</mi></mrow><mo id="S4.SS1.p6.6.m6.1.1.1.1.3" stretchy="false" xref="S4.SS1.p6.6.m6.1.1.1.2.1.cmml">⌉</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.SS1.p6.6.m6.1b"><apply id="S4.SS1.p6.6.m6.1.1.cmml" xref="S4.SS1.p6.6.m6.1.1"><eq id="S4.SS1.p6.6.m6.1.1.2.cmml" xref="S4.SS1.p6.6.m6.1.1.2"></eq><ci id="S4.SS1.p6.6.m6.1.1.3.cmml" xref="S4.SS1.p6.6.m6.1.1.3">𝐿</ci><apply id="S4.SS1.p6.6.m6.1.1.1.2.cmml" xref="S4.SS1.p6.6.m6.1.1.1.1"><ceiling id="S4.SS1.p6.6.m6.1.1.1.2.1.cmml" xref="S4.SS1.p6.6.m6.1.1.1.1.2"></ceiling><apply id="S4.SS1.p6.6.m6.1.1.1.1.1.cmml" xref="S4.SS1.p6.6.m6.1.1.1.1.1"><apply id="S4.SS1.p6.6.m6.1.1.1.1.1.1.cmml" xref="S4.SS1.p6.6.m6.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.SS1.p6.6.m6.1.1.1.1.1.1.1.cmml" xref="S4.SS1.p6.6.m6.1.1.1.1.1.1">subscript</csymbol><log id="S4.SS1.p6.6.m6.1.1.1.1.1.1.2.cmml" xref="S4.SS1.p6.6.m6.1.1.1.1.1.1.2"></log><ci id="S4.SS1.p6.6.m6.1.1.1.1.1.1.3.cmml" xref="S4.SS1.p6.6.m6.1.1.1.1.1.1.3">𝑘</ci></apply><ci id="S4.SS1.p6.6.m6.1.1.1.1.1.2.cmml" xref="S4.SS1.p6.6.m6.1.1.1.1.1.2">𝑛</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p6.6.m6.1c">L=\lceil\log_{k}n\rceil</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p6.6.m6.1d">italic_L = ⌈ roman_log start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT italic_n ⌉</annotation></semantics></math> times of forwards to build the hierarchy.
Then, for retrieval, it takes another <math alttext="L+1" class="ltx_Math" display="inline" id="S4.SS1.p6.7.m7.1"><semantics id="S4.SS1.p6.7.m7.1a"><mrow id="S4.SS1.p6.7.m7.1.1" xref="S4.SS1.p6.7.m7.1.1.cmml"><mi id="S4.SS1.p6.7.m7.1.1.2" xref="S4.SS1.p6.7.m7.1.1.2.cmml">L</mi><mo id="S4.SS1.p6.7.m7.1.1.1" xref="S4.SS1.p6.7.m7.1.1.1.cmml">+</mo><mn id="S4.SS1.p6.7.m7.1.1.3" xref="S4.SS1.p6.7.m7.1.1.3.cmml">1</mn></mrow><annotation-xml encoding="MathML-Content" id="S4.SS1.p6.7.m7.1b"><apply id="S4.SS1.p6.7.m7.1.1.cmml" xref="S4.SS1.p6.7.m7.1.1"><plus id="S4.SS1.p6.7.m7.1.1.1.cmml" xref="S4.SS1.p6.7.m7.1.1.1"></plus><ci id="S4.SS1.p6.7.m7.1.1.2.cmml" xref="S4.SS1.p6.7.m7.1.1.2">𝐿</ci><cn id="S4.SS1.p6.7.m7.1.1.3.cmml" type="integer" xref="S4.SS1.p6.7.m7.1.1.3">1</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p6.7.m7.1c">L+1</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p6.7.m7.1d">italic_L + 1</annotation></semantics></math> times to generate the retrieval embedding and search to the bottom.
Finally, a last call of forward is made to predict the labels of <math alttext="{\bm{x}}" class="ltx_Math" display="inline" id="S4.SS1.p6.8.m8.1"><semantics id="S4.SS1.p6.8.m8.1a"><mi id="S4.SS1.p6.8.m8.1.1" xref="S4.SS1.p6.8.m8.1.1.cmml">𝒙</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p6.8.m8.1b"><ci id="S4.SS1.p6.8.m8.1.1.cmml" xref="S4.SS1.p6.8.m8.1.1">𝒙</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p6.8.m8.1c">{\bm{x}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p6.8.m8.1d">bold_italic_x</annotation></semantics></math>.
In total, one needs to perform <math alttext="2L+2" class="ltx_Math" display="inline" id="S4.SS1.p6.9.m9.1"><semantics id="S4.SS1.p6.9.m9.1a"><mrow id="S4.SS1.p6.9.m9.1.1" xref="S4.SS1.p6.9.m9.1.1.cmml"><mrow id="S4.SS1.p6.9.m9.1.1.2" xref="S4.SS1.p6.9.m9.1.1.2.cmml"><mn id="S4.SS1.p6.9.m9.1.1.2.2" xref="S4.SS1.p6.9.m9.1.1.2.2.cmml">2</mn><mo id="S4.SS1.p6.9.m9.1.1.2.1" xref="S4.SS1.p6.9.m9.1.1.2.1.cmml">⁢</mo><mi id="S4.SS1.p6.9.m9.1.1.2.3" xref="S4.SS1.p6.9.m9.1.1.2.3.cmml">L</mi></mrow><mo id="S4.SS1.p6.9.m9.1.1.1" xref="S4.SS1.p6.9.m9.1.1.1.cmml">+</mo><mn id="S4.SS1.p6.9.m9.1.1.3" xref="S4.SS1.p6.9.m9.1.1.3.cmml">2</mn></mrow><annotation-xml encoding="MathML-Content" id="S4.SS1.p6.9.m9.1b"><apply id="S4.SS1.p6.9.m9.1.1.cmml" xref="S4.SS1.p6.9.m9.1.1"><plus id="S4.SS1.p6.9.m9.1.1.1.cmml" xref="S4.SS1.p6.9.m9.1.1.1"></plus><apply id="S4.SS1.p6.9.m9.1.1.2.cmml" xref="S4.SS1.p6.9.m9.1.1.2"><times id="S4.SS1.p6.9.m9.1.1.2.1.cmml" xref="S4.SS1.p6.9.m9.1.1.2.1"></times><cn id="S4.SS1.p6.9.m9.1.1.2.2.cmml" type="integer" xref="S4.SS1.p6.9.m9.1.1.2.2">2</cn><ci id="S4.SS1.p6.9.m9.1.1.2.3.cmml" xref="S4.SS1.p6.9.m9.1.1.2.3">𝐿</ci></apply><cn id="S4.SS1.p6.9.m9.1.1.3.cmml" type="integer" xref="S4.SS1.p6.9.m9.1.1.3">2</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p6.9.m9.1c">2L+2</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p6.9.m9.1d">2 italic_L + 2</annotation></semantics></math> times of forwards before calling the backward.
Apart from the computation cost, this also leads to two other issues:</p>
</div>
<div class="ltx_para ltx_noindent" id="S4.SS1.p7">
<p class="ltx_p" id="S4.SS1.p7.3"><span class="ltx_text ltx_font_bold" id="S4.SS1.p7.3.1">1. Intermediate activations</span>:
PyTorch saves activations such as attentions and embeddings for the backward pass. Let <math alttext="T" class="ltx_Math" display="inline" id="S4.SS1.p7.1.m1.1"><semantics id="S4.SS1.p7.1.m1.1a"><mi id="S4.SS1.p7.1.m1.1.1" xref="S4.SS1.p7.1.m1.1.1.cmml">T</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p7.1.m1.1b"><ci id="S4.SS1.p7.1.m1.1.1.cmml" xref="S4.SS1.p7.1.m1.1.1">𝑇</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p7.1.m1.1c">T</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p7.1.m1.1d">italic_T</annotation></semantics></math> be the total number of forwards called before backward, the space complexity is
<math alttext="O(Tn^{2}+Tnd)" class="ltx_Math" display="inline" id="S4.SS1.p7.2.m2.1"><semantics id="S4.SS1.p7.2.m2.1a"><mrow id="S4.SS1.p7.2.m2.1.1" xref="S4.SS1.p7.2.m2.1.1.cmml"><mi id="S4.SS1.p7.2.m2.1.1.3" xref="S4.SS1.p7.2.m2.1.1.3.cmml">O</mi><mo id="S4.SS1.p7.2.m2.1.1.2" xref="S4.SS1.p7.2.m2.1.1.2.cmml">⁢</mo><mrow id="S4.SS1.p7.2.m2.1.1.1.1" xref="S4.SS1.p7.2.m2.1.1.1.1.1.cmml"><mo id="S4.SS1.p7.2.m2.1.1.1.1.2" stretchy="false" xref="S4.SS1.p7.2.m2.1.1.1.1.1.cmml">(</mo><mrow id="S4.SS1.p7.2.m2.1.1.1.1.1" xref="S4.SS1.p7.2.m2.1.1.1.1.1.cmml"><mrow id="S4.SS1.p7.2.m2.1.1.1.1.1.2" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2.cmml"><mi id="S4.SS1.p7.2.m2.1.1.1.1.1.2.2" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2.2.cmml">T</mi><mo id="S4.SS1.p7.2.m2.1.1.1.1.1.2.1" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2.1.cmml">⁢</mo><msup id="S4.SS1.p7.2.m2.1.1.1.1.1.2.3" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2.3.cmml"><mi id="S4.SS1.p7.2.m2.1.1.1.1.1.2.3.2" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2.3.2.cmml">n</mi><mn id="S4.SS1.p7.2.m2.1.1.1.1.1.2.3.3" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2.3.3.cmml">2</mn></msup></mrow><mo id="S4.SS1.p7.2.m2.1.1.1.1.1.1" xref="S4.SS1.p7.2.m2.1.1.1.1.1.1.cmml">+</mo><mrow id="S4.SS1.p7.2.m2.1.1.1.1.1.3" xref="S4.SS1.p7.2.m2.1.1.1.1.1.3.cmml"><mi id="S4.SS1.p7.2.m2.1.1.1.1.1.3.2" xref="S4.SS1.p7.2.m2.1.1.1.1.1.3.2.cmml">T</mi><mo id="S4.SS1.p7.2.m2.1.1.1.1.1.3.1" xref="S4.SS1.p7.2.m2.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.SS1.p7.2.m2.1.1.1.1.1.3.3" xref="S4.SS1.p7.2.m2.1.1.1.1.1.3.3.cmml">n</mi><mo id="S4.SS1.p7.2.m2.1.1.1.1.1.3.1a" xref="S4.SS1.p7.2.m2.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.SS1.p7.2.m2.1.1.1.1.1.3.4" xref="S4.SS1.p7.2.m2.1.1.1.1.1.3.4.cmml">d</mi></mrow></mrow><mo id="S4.SS1.p7.2.m2.1.1.1.1.3" stretchy="false" xref="S4.SS1.p7.2.m2.1.1.1.1.1.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.SS1.p7.2.m2.1b"><apply id="S4.SS1.p7.2.m2.1.1.cmml" xref="S4.SS1.p7.2.m2.1.1"><times id="S4.SS1.p7.2.m2.1.1.2.cmml" xref="S4.SS1.p7.2.m2.1.1.2"></times><ci id="S4.SS1.p7.2.m2.1.1.3.cmml" xref="S4.SS1.p7.2.m2.1.1.3">𝑂</ci><apply id="S4.SS1.p7.2.m2.1.1.1.1.1.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1"><plus id="S4.SS1.p7.2.m2.1.1.1.1.1.1.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1.1.1"></plus><apply id="S4.SS1.p7.2.m2.1.1.1.1.1.2.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2"><times id="S4.SS1.p7.2.m2.1.1.1.1.1.2.1.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2.1"></times><ci id="S4.SS1.p7.2.m2.1.1.1.1.1.2.2.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2.2">𝑇</ci><apply id="S4.SS1.p7.2.m2.1.1.1.1.1.2.3.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2.3"><csymbol cd="ambiguous" id="S4.SS1.p7.2.m2.1.1.1.1.1.2.3.1.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2.3">superscript</csymbol><ci id="S4.SS1.p7.2.m2.1.1.1.1.1.2.3.2.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2.3.2">𝑛</ci><cn id="S4.SS1.p7.2.m2.1.1.1.1.1.2.3.3.cmml" type="integer" xref="S4.SS1.p7.2.m2.1.1.1.1.1.2.3.3">2</cn></apply></apply><apply id="S4.SS1.p7.2.m2.1.1.1.1.1.3.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1.1.3"><times id="S4.SS1.p7.2.m2.1.1.1.1.1.3.1.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1.1.3.1"></times><ci id="S4.SS1.p7.2.m2.1.1.1.1.1.3.2.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1.1.3.2">𝑇</ci><ci id="S4.SS1.p7.2.m2.1.1.1.1.1.3.3.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1.1.3.3">𝑛</ci><ci id="S4.SS1.p7.2.m2.1.1.1.1.1.3.4.cmml" xref="S4.SS1.p7.2.m2.1.1.1.1.1.3.4">𝑑</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p7.2.m2.1c">O(Tn^{2}+Tnd)</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p7.2.m2.1d">italic_O ( italic_T italic_n start_POSTSUPERSCRIPT 2 end_POSTSUPERSCRIPT + italic_T italic_n italic_d )</annotation></semantics></math>.
In general, this cost is moderate compared to those long context training that goes up to 32K (e.g., <cite class="ltx_cite ltx_citemacro_citep">(Dubey et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib7" title="">2024</a>)</cite>), because it grows quadratically with the length of the context, and with our architecture, we can always limit the max length of every forward call to a small number (say, 4K or even smaller). Still, given that the total number of context chunks can be enormous (say, 10M tokens split into 5K chunks of length 2K),
it is impossible to store all activations in VRAM.
In our experiments, we use gradient checkpointing to alleviate this issue. We also investigate implementing custom <span class="ltx_text ltx_font_typewriter" id="S4.SS1.p7.3.2">pack</span> and <span class="ltx_text ltx_font_typewriter" id="S4.SS1.p7.3.3">unpack</span> functions to dump chunk activations to RAM and disk, and only load them when they are in the top <math alttext="C" class="ltx_Math" display="inline" id="S4.SS1.p7.3.m3.1"><semantics id="S4.SS1.p7.3.m3.1a"><mi id="S4.SS1.p7.3.m3.1.1" xref="S4.SS1.p7.3.m3.1.1.cmml">C</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p7.3.m3.1b"><ci id="S4.SS1.p7.3.m3.1.1.cmml" xref="S4.SS1.p7.3.m3.1.1">𝐶</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p7.3.m3.1c">C</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p7.3.m3.1d">italic_C</annotation></semantics></math> indices.</p>
</div>
<div class="ltx_para ltx_noindent" id="S4.SS1.p8">
<p class="ltx_p" id="S4.SS1.p8.1"><span class="ltx_text ltx_font_bold" id="S4.SS1.p8.1.1">2. Potential gradient instability</span>:
One of the main drawbacks of recurrent models is the gradient vanishing/explosion problem, as one needs to unfold the recurrent forward calls to compute the gradient, which is also referred to as <span class="ltx_text ltx_font_italic" id="S4.SS1.p8.1.2">backpropagation through time</span> (BPTT).
A widely used solution to this is the truncated BPTT, where one stops the gradient after certain times of unfolding. Such a technique is also used in prior work for transformer models <cite class="ltx_cite ltx_citemacro_citep">(Dai et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib5" title="">2019</a>; Chevalier et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib3" title="">2023</a>)</cite>.</p>
</div>
<div class="ltx_para ltx_noindent" id="S4.SS1.p9">
<p class="ltx_p" id="S4.SS1.p9.2">Unfortunately, it cannot be applied in our case. Unlike seq2seq training used in these works, where every recurrent call has two sources of gradients (one from the prediction loss of the current state, and the other from BPTT from later states), the compression and retrieval calls happen in latent space and thus have no groundtruth labels, so the only source of the gradient is from the final autoregressive loss. This means one has to perform the complete BPTT to get the loss signal for compression and retrieval.
As bad as it sounds, so far we haven’t encountered any gradient issues in our experiments. This is partially due to the depth <math alttext="L" class="ltx_Math" display="inline" id="S4.SS1.p9.1.m1.1"><semantics id="S4.SS1.p9.1.m1.1a"><mi id="S4.SS1.p9.1.m1.1.1" xref="S4.SS1.p9.1.m1.1.1.cmml">L</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p9.1.m1.1b"><ci id="S4.SS1.p9.1.m1.1.1.cmml" xref="S4.SS1.p9.1.m1.1.1">𝐿</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p9.1.m1.1c">L</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p9.1.m1.1d">italic_L</annotation></semantics></math> grows in log scale with respect to <math alttext="n" class="ltx_Math" display="inline" id="S4.SS1.p9.2.m2.1"><semantics id="S4.SS1.p9.2.m2.1a"><mi id="S4.SS1.p9.2.m2.1.1" xref="S4.SS1.p9.2.m2.1.1.cmml">n</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p9.2.m2.1b"><ci id="S4.SS1.p9.2.m2.1.1.cmml" xref="S4.SS1.p9.2.m2.1.1">𝑛</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p9.2.m2.1c">n</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p9.2.m2.1d">italic_n</annotation></semantics></math>—For example, a 4K chunk with factor 4 leads to only 6 levels. So the total number of recurrent steps in our case is typically small.
Nevertheless, we also investigate using intermediate losses (e.g., reconstruction loss from compression embeddings) to train the compression and retrieval process to avoid performing the complete BPTT.</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.2 </span>Inference</h3>
<div class="ltx_para ltx_noindent" id="S4.SS2.p1">
<p class="ltx_p" id="S4.SS2.p1.1">Inference with Compressor-Retriever architecture is straightforward.
A typical session begins with empty context or existing context similar to that in RAG use cases.
Given a context window size, we actively manage the window throughout the interaction.
For example, when the current context is about to exceed the window size, it automatically compresses the context and adds it to the database.
During the interaction with the user, the model can either be set to initiate retrieval whenever it is its turn to generate, or, after instruction fine-tuning, set to actively generate the <span class="ltx_text ltx_font_typewriter" id="S4.SS2.p1.1.1">&lt;call_retrival&gt;</span> token whenever it thinks appropriate.</p>
</div>
<div class="ltx_para ltx_noindent" id="S4.SS2.p2">
<p class="ltx_p" id="S4.SS2.p2.1"><span class="ltx_text ltx_font_bold" id="S4.SS2.p2.1.1">Asynchronous retrieval</span>.
In either case, the retrieval process can hang the generation process, leading to a certain latency. Different from the training phase, where compression and retrieval happen before and synchronously with the generation, one can set both processes to run in the background and asynchronously with the generation.
For example, when the model decodes <span class="ltx_text ltx_font_typewriter" id="S4.SS2.p2.1.2">&lt;call_retrival&gt;</span> token, it initiates the retrieval in a separate process and continues its current generation, and the results will be gradually added to the current context as the generation goes.</p>
</div>
</section>
</section>
<section class="ltx_section" id="S5">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">5 </span>Experiments</h2>
<div class="ltx_para ltx_noindent" id="S5.p1">
<p class="ltx_p" id="S5.p1.1">In this section, we validate the architecture in a small-scale preliminary experiment.</p>
</div>
<div class="ltx_para ltx_noindent" id="S5.p2">
<p class="ltx_p" id="S5.p2.5"><span class="ltx_text ltx_font_bold" id="S5.p2.5.1">Task</span>.
We evaluate our architecture on reasoning problems in an in-context learning (ICL) setting. Given a question <math alttext="q" class="ltx_Math" display="inline" id="S5.p2.1.m1.1"><semantics id="S5.p2.1.m1.1a"><mi id="S5.p2.1.m1.1.1" xref="S5.p2.1.m1.1.1.cmml">q</mi><annotation-xml encoding="MathML-Content" id="S5.p2.1.m1.1b"><ci id="S5.p2.1.m1.1.1.cmml" xref="S5.p2.1.m1.1.1">𝑞</ci></annotation-xml><annotation encoding="application/x-tex" id="S5.p2.1.m1.1c">q</annotation><annotation encoding="application/x-llamapun" id="S5.p2.1.m1.1d">italic_q</annotation></semantics></math> the model is tasked to predict the answer <math alttext="a" class="ltx_Math" display="inline" id="S5.p2.2.m2.1"><semantics id="S5.p2.2.m2.1a"><mi id="S5.p2.2.m2.1.1" xref="S5.p2.2.m2.1.1.cmml">a</mi><annotation-xml encoding="MathML-Content" id="S5.p2.2.m2.1b"><ci id="S5.p2.2.m2.1.1.cmml" xref="S5.p2.2.m2.1.1">𝑎</ci></annotation-xml><annotation encoding="application/x-tex" id="S5.p2.2.m2.1c">a</annotation><annotation encoding="application/x-llamapun" id="S5.p2.2.m2.1d">italic_a</annotation></semantics></math>. Together with the target question, several examples <math alttext="\langle q,a\rangle" class="ltx_Math" display="inline" id="S5.p2.3.m3.2"><semantics id="S5.p2.3.m3.2a"><mrow id="S5.p2.3.m3.2.3.2" xref="S5.p2.3.m3.2.3.1.cmml"><mo id="S5.p2.3.m3.2.3.2.1" stretchy="false" xref="S5.p2.3.m3.2.3.1.cmml">⟨</mo><mi id="S5.p2.3.m3.1.1" xref="S5.p2.3.m3.1.1.cmml">q</mi><mo id="S5.p2.3.m3.2.3.2.2" xref="S5.p2.3.m3.2.3.1.cmml">,</mo><mi id="S5.p2.3.m3.2.2" xref="S5.p2.3.m3.2.2.cmml">a</mi><mo id="S5.p2.3.m3.2.3.2.3" stretchy="false" xref="S5.p2.3.m3.2.3.1.cmml">⟩</mo></mrow><annotation-xml encoding="MathML-Content" id="S5.p2.3.m3.2b"><list id="S5.p2.3.m3.2.3.1.cmml" xref="S5.p2.3.m3.2.3.2"><ci id="S5.p2.3.m3.1.1.cmml" xref="S5.p2.3.m3.1.1">𝑞</ci><ci id="S5.p2.3.m3.2.2.cmml" xref="S5.p2.3.m3.2.2">𝑎</ci></list></annotation-xml><annotation encoding="application/x-tex" id="S5.p2.3.m3.2c">\langle q,a\rangle</annotation><annotation encoding="application/x-llamapun" id="S5.p2.3.m3.2d">⟨ italic_q , italic_a ⟩</annotation></semantics></math> are included as the few-shot examples.
In our context, we consider all ICL examples <math alttext="{\bm{c}}=\{\langle q,a\rangle_{1},\langle q,a\rangle_{2},...\}" class="ltx_Math" display="inline" id="S5.p2.4.m4.7"><semantics id="S5.p2.4.m4.7a"><mrow id="S5.p2.4.m4.7.7" xref="S5.p2.4.m4.7.7.cmml"><mi id="S5.p2.4.m4.7.7.4" xref="S5.p2.4.m4.7.7.4.cmml">𝒄</mi><mo id="S5.p2.4.m4.7.7.3" xref="S5.p2.4.m4.7.7.3.cmml">=</mo><mrow id="S5.p2.4.m4.7.7.2.2" xref="S5.p2.4.m4.7.7.2.3.cmml"><mo id="S5.p2.4.m4.7.7.2.2.3" stretchy="false" xref="S5.p2.4.m4.7.7.2.3.cmml">{</mo><msub id="S5.p2.4.m4.6.6.1.1.1" xref="S5.p2.4.m4.6.6.1.1.1.cmml"><mrow id="S5.p2.4.m4.6.6.1.1.1.2.2" xref="S5.p2.4.m4.6.6.1.1.1.2.1.cmml"><mo id="S5.p2.4.m4.6.6.1.1.1.2.2.1" stretchy="false" xref="S5.p2.4.m4.6.6.1.1.1.2.1.cmml">⟨</mo><mi id="S5.p2.4.m4.1.1" xref="S5.p2.4.m4.1.1.cmml">q</mi><mo id="S5.p2.4.m4.6.6.1.1.1.2.2.2" xref="S5.p2.4.m4.6.6.1.1.1.2.1.cmml">,</mo><mi id="S5.p2.4.m4.2.2" xref="S5.p2.4.m4.2.2.cmml">a</mi><mo id="S5.p2.4.m4.6.6.1.1.1.2.2.3" stretchy="false" xref="S5.p2.4.m4.6.6.1.1.1.2.1.cmml">⟩</mo></mrow><mn id="S5.p2.4.m4.6.6.1.1.1.3" xref="S5.p2.4.m4.6.6.1.1.1.3.cmml">1</mn></msub><mo id="S5.p2.4.m4.7.7.2.2.4" xref="S5.p2.4.m4.7.7.2.3.cmml">,</mo><msub id="S5.p2.4.m4.7.7.2.2.2" xref="S5.p2.4.m4.7.7.2.2.2.cmml"><mrow id="S5.p2.4.m4.7.7.2.2.2.2.2" xref="S5.p2.4.m4.7.7.2.2.2.2.1.cmml"><mo id="S5.p2.4.m4.7.7.2.2.2.2.2.1" stretchy="false" xref="S5.p2.4.m4.7.7.2.2.2.2.1.cmml">⟨</mo><mi id="S5.p2.4.m4.3.3" xref="S5.p2.4.m4.3.3.cmml">q</mi><mo id="S5.p2.4.m4.7.7.2.2.2.2.2.2" xref="S5.p2.4.m4.7.7.2.2.2.2.1.cmml">,</mo><mi id="S5.p2.4.m4.4.4" xref="S5.p2.4.m4.4.4.cmml">a</mi><mo id="S5.p2.4.m4.7.7.2.2.2.2.2.3" stretchy="false" xref="S5.p2.4.m4.7.7.2.2.2.2.1.cmml">⟩</mo></mrow><mn id="S5.p2.4.m4.7.7.2.2.2.3" xref="S5.p2.4.m4.7.7.2.2.2.3.cmml">2</mn></msub><mo id="S5.p2.4.m4.7.7.2.2.5" xref="S5.p2.4.m4.7.7.2.3.cmml">,</mo><mi id="S5.p2.4.m4.5.5" mathvariant="normal" xref="S5.p2.4.m4.5.5.cmml">…</mi><mo id="S5.p2.4.m4.7.7.2.2.6" stretchy="false" xref="S5.p2.4.m4.7.7.2.3.cmml">}</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S5.p2.4.m4.7b"><apply id="S5.p2.4.m4.7.7.cmml" xref="S5.p2.4.m4.7.7"><eq id="S5.p2.4.m4.7.7.3.cmml" xref="S5.p2.4.m4.7.7.3"></eq><ci id="S5.p2.4.m4.7.7.4.cmml" xref="S5.p2.4.m4.7.7.4">𝒄</ci><set id="S5.p2.4.m4.7.7.2.3.cmml" xref="S5.p2.4.m4.7.7.2.2"><apply id="S5.p2.4.m4.6.6.1.1.1.cmml" xref="S5.p2.4.m4.6.6.1.1.1"><csymbol cd="ambiguous" id="S5.p2.4.m4.6.6.1.1.1.1.cmml" xref="S5.p2.4.m4.6.6.1.1.1">subscript</csymbol><list id="S5.p2.4.m4.6.6.1.1.1.2.1.cmml" xref="S5.p2.4.m4.6.6.1.1.1.2.2"><ci id="S5.p2.4.m4.1.1.cmml" xref="S5.p2.4.m4.1.1">𝑞</ci><ci id="S5.p2.4.m4.2.2.cmml" xref="S5.p2.4.m4.2.2">𝑎</ci></list><cn id="S5.p2.4.m4.6.6.1.1.1.3.cmml" type="integer" xref="S5.p2.4.m4.6.6.1.1.1.3">1</cn></apply><apply id="S5.p2.4.m4.7.7.2.2.2.cmml" xref="S5.p2.4.m4.7.7.2.2.2"><csymbol cd="ambiguous" id="S5.p2.4.m4.7.7.2.2.2.1.cmml" xref="S5.p2.4.m4.7.7.2.2.2">subscript</csymbol><list id="S5.p2.4.m4.7.7.2.2.2.2.1.cmml" xref="S5.p2.4.m4.7.7.2.2.2.2.2"><ci id="S5.p2.4.m4.3.3.cmml" xref="S5.p2.4.m4.3.3">𝑞</ci><ci id="S5.p2.4.m4.4.4.cmml" xref="S5.p2.4.m4.4.4">𝑎</ci></list><cn id="S5.p2.4.m4.7.7.2.2.2.3.cmml" type="integer" xref="S5.p2.4.m4.7.7.2.2.2.3">2</cn></apply><ci id="S5.p2.4.m4.5.5.cmml" xref="S5.p2.4.m4.5.5">…</ci></set></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.p2.4.m4.7c">{\bm{c}}=\{\langle q,a\rangle_{1},\langle q,a\rangle_{2},...\}</annotation><annotation encoding="application/x-llamapun" id="S5.p2.4.m4.7d">bold_italic_c = { ⟨ italic_q , italic_a ⟩ start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , ⟨ italic_q , italic_a ⟩ start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT , … }</annotation></semantics></math> are the context, and the target question <math alttext="{\bm{x}}=q" class="ltx_Math" display="inline" id="S5.p2.5.m5.1"><semantics id="S5.p2.5.m5.1a"><mrow id="S5.p2.5.m5.1.1" xref="S5.p2.5.m5.1.1.cmml"><mi id="S5.p2.5.m5.1.1.2" xref="S5.p2.5.m5.1.1.2.cmml">𝒙</mi><mo id="S5.p2.5.m5.1.1.1" xref="S5.p2.5.m5.1.1.1.cmml">=</mo><mi id="S5.p2.5.m5.1.1.3" xref="S5.p2.5.m5.1.1.3.cmml">q</mi></mrow><annotation-xml encoding="MathML-Content" id="S5.p2.5.m5.1b"><apply id="S5.p2.5.m5.1.1.cmml" xref="S5.p2.5.m5.1.1"><eq id="S5.p2.5.m5.1.1.1.cmml" xref="S5.p2.5.m5.1.1.1"></eq><ci id="S5.p2.5.m5.1.1.2.cmml" xref="S5.p2.5.m5.1.1.2">𝒙</ci><ci id="S5.p2.5.m5.1.1.3.cmml" xref="S5.p2.5.m5.1.1.3">𝑞</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.p2.5.m5.1c">{\bm{x}}=q</annotation><annotation encoding="application/x-llamapun" id="S5.p2.5.m5.1d">bold_italic_x = italic_q</annotation></semantics></math> is the input sequence.</p>
</div>
<div class="ltx_para ltx_noindent" id="S5.p3">
<p class="ltx_p" id="S5.p3.1">If the model is never trained on the target dataset, having included ICL examples <math alttext="{\bm{c}}" class="ltx_Math" display="inline" id="S5.p3.1.m1.1"><semantics id="S5.p3.1.m1.1a"><mi id="S5.p3.1.m1.1.1" xref="S5.p3.1.m1.1.1.cmml">𝒄</mi><annotation-xml encoding="MathML-Content" id="S5.p3.1.m1.1b"><ci id="S5.p3.1.m1.1.1.cmml" xref="S5.p3.1.m1.1.1">𝒄</ci></annotation-xml><annotation encoding="application/x-tex" id="S5.p3.1.m1.1c">{\bm{c}}</annotation><annotation encoding="application/x-llamapun" id="S5.p3.1.m1.1d">bold_italic_c</annotation></semantics></math> will lead to a significant increase in performance compared to the zero-shot case.
Therefore, we can validate our architecture by testing if the model could effectively compress and retrieve the “right” ICL examples for solving the current task.
Specifically, we provide the model with ICL examples from both the same dataset as the target question and datasets of other reasoning tasks. In other words, some ICL examples are relevant, while others are irrelevant.
We then limit the window size so that the model can only pick a subset of the examples.
If the model can successfully retrieve the relevant ones, then its performance will be similar to that of the full-example case.</p>
</div>
<div class="ltx_para ltx_noindent" id="S5.p4">
<p class="ltx_p" id="S5.p4.1"><span class="ltx_text ltx_font_bold" id="S5.p4.1.1">Data</span>.
We use four reasoning datasets to construct our training and testing datasets:
GSM8K <cite class="ltx_cite ltx_citemacro_citep">(Cobbe et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib4" title="">2021</a>)</cite> consists of math problems, FOLIO <cite class="ltx_cite ltx_citemacro_citep">(Han et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib10" title="">2022</a>)</cite> consists of natural language inference problems, proScript <cite class="ltx_cite ltx_citemacro_citep">(Sakaguchi et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib18" title="">2021</a>)</cite> consists of graph reasoning problems, and ReClor <cite class="ltx_cite ltx_citemacro_citep">(Yu et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib22" title="">2020</a>)</cite> consists of commonsense reasoning problems.
These four tasks are sufficiently distinct <cite class="ltx_cite ltx_citemacro_citep">(Yang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#bib.bib20" title="">2024</a>)</cite>, so their ICL examples are irrelevant and contribute little to solving others’ problems.
We construct ICL examples by concatenating their ground-truth answers to the questions.</p>
</div>
<figure class="ltx_table ltx_align_floatright" id="S5.T1">
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle" id="S5.T1.1">
<tbody class="ltx_tbody">
<tr class="ltx_tr" id="S5.T1.1.1.1">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_tt" id="S5.T1.1.1.1.1">Mode</th>
<td class="ltx_td ltx_nopad_r ltx_align_center ltx_border_tt" id="S5.T1.1.1.1.2">Accuracy</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.2.2">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_t" id="S5.T1.1.2.2.1">0-shot</th>
<td class="ltx_td ltx_nopad_r ltx_align_center ltx_border_t" id="S5.T1.1.2.2.2">0.250</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.3.3">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row" id="S5.T1.1.3.3.1">6-shot</th>
<td class="ltx_td ltx_nopad_r ltx_align_center" id="S5.T1.1.3.3.2">0.578</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.4.4">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb ltx_border_t" id="S5.T1.1.4.4.1">
<table class="ltx_tabular ltx_align_middle" id="S5.T1.1.4.4.1.1">
<tr class="ltx_tr" id="S5.T1.1.4.4.1.1.1">
<td class="ltx_td ltx_nopad_r ltx_align_left" id="S5.T1.1.4.4.1.1.1.1">Compressor</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.4.4.1.1.2">
<td class="ltx_td ltx_nopad_r ltx_align_left" id="S5.T1.1.4.4.1.1.2.1">-Retriever</td>
</tr>
</table>
</th>
<td class="ltx_td ltx_nopad_r ltx_align_center ltx_border_bb ltx_border_t" id="S5.T1.1.4.4.2">0.429</td>
</tr>
</tbody>
</table>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table">Table 1: </span>Accuracy of ICL reasoning tasks with base and compressor-retriever architecture.</figcaption>
</figure>
<div class="ltx_para ltx_noindent" id="S5.p5">
<p class="ltx_p" id="S5.p5.1"><span class="ltx_text ltx_font_bold" id="S5.p5.1.1">Setting</span>.
We use <span class="ltx_text ltx_font_typewriter" id="S5.p5.1.2">LLaMA3.1-8B-instruct</span> as the base model for the experiments. We choose the instruct version so that the model has a reasonable zero-shot capability, which could serve as a “lower bound” of the accuracy—If the model retrieves the right examples, its accuracy should be in between the zero-shot and the full-example cases.</p>
</div>
<div class="ltx_para ltx_noindent" id="S5.p6">
<p class="ltx_p" id="S5.p6.2">Each sample in our dataset consists of 6 ICL examples: 2 from the same dataset as the target question, and 4 randomly sampled from the rest of the datasets.
For the training set, we have target sampled from one of GSM8K, proScript, and ReClor, and irrelevant samples from the other two;
for the test set, we have target sampled from only FOLIO, and irrelevant samples from one of GSM8K, proScript, and ReClor.
<span class="ltx_text ltx_font_bold" id="S5.p6.2.1">Note that we only have FOLIO target problems in the test set and have deliberately excluded FOLIO examples from the training set</span>.
We believe that such compression and retrieval capabilities should be domain-agnostic, therefore, we restrict the training set to only contain “out-of-distribution” data (from the perspective of solving FOLIO problems), so that the model does not get trained on solving the FOLIO problem directly.
The resulting training set contains 3375 training samples with an average token length of 600;
the test set contains 192 samples with an average length of 514.
Due to limited GPU resources, we use a fixed compression scheme where the context is compressed to level 1 with 50 embeddings and then level 2 with 1 embedding.
All experiments are done on a 4090 GPU with 24GB RAM.
We fine-tune <span class="ltx_text ltx_font_typewriter" id="S5.p6.2.2">LLaMA3.1-8B-instruct</span> on our training set with LoRA <math alttext="r=8" class="ltx_Math" display="inline" id="S5.p6.1.m1.1"><semantics id="S5.p6.1.m1.1a"><mrow id="S5.p6.1.m1.1.1" xref="S5.p6.1.m1.1.1.cmml"><mi id="S5.p6.1.m1.1.1.2" xref="S5.p6.1.m1.1.1.2.cmml">r</mi><mo id="S5.p6.1.m1.1.1.1" xref="S5.p6.1.m1.1.1.1.cmml">=</mo><mn id="S5.p6.1.m1.1.1.3" xref="S5.p6.1.m1.1.1.3.cmml">8</mn></mrow><annotation-xml encoding="MathML-Content" id="S5.p6.1.m1.1b"><apply id="S5.p6.1.m1.1.1.cmml" xref="S5.p6.1.m1.1.1"><eq id="S5.p6.1.m1.1.1.1.cmml" xref="S5.p6.1.m1.1.1.1"></eq><ci id="S5.p6.1.m1.1.1.2.cmml" xref="S5.p6.1.m1.1.1.2">𝑟</ci><cn id="S5.p6.1.m1.1.1.3.cmml" type="integer" xref="S5.p6.1.m1.1.1.3">8</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.p6.1.m1.1c">r=8</annotation><annotation encoding="application/x-llamapun" id="S5.p6.1.m1.1d">italic_r = 8</annotation></semantics></math> on all linear layers. We train it for 3 epochs with <math alttext="lr=3e-4" class="ltx_Math" display="inline" id="S5.p6.2.m2.1"><semantics id="S5.p6.2.m2.1a"><mrow id="S5.p6.2.m2.1.1" xref="S5.p6.2.m2.1.1.cmml"><mrow id="S5.p6.2.m2.1.1.2" xref="S5.p6.2.m2.1.1.2.cmml"><mi id="S5.p6.2.m2.1.1.2.2" xref="S5.p6.2.m2.1.1.2.2.cmml">l</mi><mo id="S5.p6.2.m2.1.1.2.1" xref="S5.p6.2.m2.1.1.2.1.cmml">⁢</mo><mi id="S5.p6.2.m2.1.1.2.3" xref="S5.p6.2.m2.1.1.2.3.cmml">r</mi></mrow><mo id="S5.p6.2.m2.1.1.1" xref="S5.p6.2.m2.1.1.1.cmml">=</mo><mrow id="S5.p6.2.m2.1.1.3" xref="S5.p6.2.m2.1.1.3.cmml"><mrow id="S5.p6.2.m2.1.1.3.2" xref="S5.p6.2.m2.1.1.3.2.cmml"><mn id="S5.p6.2.m2.1.1.3.2.2" xref="S5.p6.2.m2.1.1.3.2.2.cmml">3</mn><mo id="S5.p6.2.m2.1.1.3.2.1" xref="S5.p6.2.m2.1.1.3.2.1.cmml">⁢</mo><mi id="S5.p6.2.m2.1.1.3.2.3" xref="S5.p6.2.m2.1.1.3.2.3.cmml">e</mi></mrow><mo id="S5.p6.2.m2.1.1.3.1" xref="S5.p6.2.m2.1.1.3.1.cmml">−</mo><mn id="S5.p6.2.m2.1.1.3.3" xref="S5.p6.2.m2.1.1.3.3.cmml">4</mn></mrow></mrow><annotation-xml encoding="MathML-Content" id="S5.p6.2.m2.1b"><apply id="S5.p6.2.m2.1.1.cmml" xref="S5.p6.2.m2.1.1"><eq id="S5.p6.2.m2.1.1.1.cmml" xref="S5.p6.2.m2.1.1.1"></eq><apply id="S5.p6.2.m2.1.1.2.cmml" xref="S5.p6.2.m2.1.1.2"><times id="S5.p6.2.m2.1.1.2.1.cmml" xref="S5.p6.2.m2.1.1.2.1"></times><ci id="S5.p6.2.m2.1.1.2.2.cmml" xref="S5.p6.2.m2.1.1.2.2">𝑙</ci><ci id="S5.p6.2.m2.1.1.2.3.cmml" xref="S5.p6.2.m2.1.1.2.3">𝑟</ci></apply><apply id="S5.p6.2.m2.1.1.3.cmml" xref="S5.p6.2.m2.1.1.3"><minus id="S5.p6.2.m2.1.1.3.1.cmml" xref="S5.p6.2.m2.1.1.3.1"></minus><apply id="S5.p6.2.m2.1.1.3.2.cmml" xref="S5.p6.2.m2.1.1.3.2"><times id="S5.p6.2.m2.1.1.3.2.1.cmml" xref="S5.p6.2.m2.1.1.3.2.1"></times><cn id="S5.p6.2.m2.1.1.3.2.2.cmml" type="integer" xref="S5.p6.2.m2.1.1.3.2.2">3</cn><ci id="S5.p6.2.m2.1.1.3.2.3.cmml" xref="S5.p6.2.m2.1.1.3.2.3">𝑒</ci></apply><cn id="S5.p6.2.m2.1.1.3.3.cmml" type="integer" xref="S5.p6.2.m2.1.1.3.3">4</cn></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.p6.2.m2.1c">lr=3e-4</annotation><annotation encoding="application/x-llamapun" id="S5.p6.2.m2.1d">italic_l italic_r = 3 italic_e - 4</annotation></semantics></math>, batch size 32 with a mini-batch size of 1.</p>
</div>
<div class="ltx_para ltx_noindent" id="S5.p7">
<p class="ltx_p" id="S5.p7.1"><span class="ltx_text ltx_font_bold" id="S5.p7.1.1">Results</span>.
We show results in Table <a class="ltx_ref" href="https://arxiv.org/html/2409.01495v1#S5.T1" title="Table 1 ‣ 5 Experiments ‣ The Compressor-Retriever Architecture for Language Model OS"><span class="ltx_text ltx_ref_tag">1</span></a>.
The experiment shows that our method achieves 75% of the 6-shot ICL performance, indicating that the model has successfully picked the correct examples.
To further validate this aspect, we track the top-level attentions and compare the top indices with those of the relevant examples, the match rate is 64%, meaning for 64% of the test cases the model finds all the correct examples.
Still, the score can be significantly improved by scaling the experiments.
We leave this part in future development.</p>
</div>
</section>
<section class="ltx_section" id="S6">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">6 </span>Conclusion</h2>
<div class="ltx_para ltx_noindent" id="S6.p1">
<p class="ltx_p" id="S6.p1.1">In this preliminary work, we propose the compressor-retriever, an architecture that manages the life cycle of context in a principled manner.
This architecture does not introduce standalone modules and can be trained end-to-end similar to the standard fine-tuning process.
Experiments show promising potentials of this architecture, which lays the foundation for developing the LM OS.</p>
</div>
</section>
<section class="ltx_bibliography" id="bib">
<h2 class="ltx_title ltx_title_bibliography">References</h2>
<ul class="ltx_biblist">
<li class="ltx_bibitem" id="bib.bib1">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Ali et al. (2024)</span>
<span class="ltx_bibblock">
Muhammad Asif Ali, Zhengping Li, Shu Yang, Keyuan Cheng, Yang Cao, Tianhao Huang, Lijie Hu, Lu Yu, and Di Wang.

</span>
<span class="ltx_bibblock">PROMPT-SAW: Leveraging Relation-Aware Graphs for Textual Prompt Compression, March 2024.

</span>
<span class="ltx_bibblock">URL <a class="ltx_ref ltx_url ltx_font_typewriter" href="http://arxiv.org/abs/2404.00489" title="">http://arxiv.org/abs/2404.00489</a>.

</span>
<span class="ltx_bibblock">arXiv:2404.00489 [cs].

</span>
</li>
<li class="ltx_bibitem" id="bib.bib2">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Bulatov et al. (2022)</span>
<span class="ltx_bibblock">
Aydar Bulatov, Yury Kuratov, and Mikhail Burtsev.

</span>
<span class="ltx_bibblock">Recurrent memory transformer.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib2.1.1">Advances in Neural Information Processing Systems</em>, 35:11079–11091, 2022.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib3">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Chevalier et al. (2023)</span>
<span class="ltx_bibblock">
Alexis Chevalier, Alexander Wettig, Anirudh Ajith, and Danqi Chen.

</span>
<span class="ltx_bibblock">Adapting Language Models to Compress Contexts, May 2023.

</span>
<span class="ltx_bibblock">URL <a class="ltx_ref ltx_url ltx_font_typewriter" href="http://arxiv.org/abs/2305.14788" title="">http://arxiv.org/abs/2305.14788</a>.

</span>
<span class="ltx_bibblock">arXiv:2305.14788 [cs].

</span>
</li>
<li class="ltx_bibitem" id="bib.bib4">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Cobbe et al. (2021)</span>
<span class="ltx_bibblock">
Karl Cobbe, Vineet Kosaraju, Mohammad Bavarian, Mark Chen, Heewoo Jun, Lukasz Kaiser, Matthias Plappert, Jerry Tworek, Jacob Hilton, Reiichiro Nakano, et al.

</span>
<span class="ltx_bibblock">Training verifiers to solve math word problems.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib4.1.1">arXiv preprint arXiv:2110.14168</em>, 2021.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib5">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Dai et al. (2019)</span>
<span class="ltx_bibblock">
Zihang Dai, Zhilin Yang, Yiming Yang, Jaime Carbonell, Quoc Le, and Ruslan Salakhutdinov.

</span>
<span class="ltx_bibblock">Transformer-XL: Attentive Language Models beyond a Fixed-Length Context.

</span>
<span class="ltx_bibblock">In Anna Korhonen, David Traum, and Lluís Màrquez, editors, <em class="ltx_emph ltx_font_italic" id="bib.bib5.1.1">Proceedings of the 57th Annual Meeting of the Association for Computational Linguistics</em>, pages 2978–2988, Florence, Italy, July 2019. Association for Computational Linguistics.

</span>
<span class="ltx_bibblock">doi: <span class="ltx_ref ltx_nolink ltx_Url ltx_ref_self">10.18653/v1/P19-1285</span>.

</span>
<span class="ltx_bibblock">URL <a class="ltx_ref ltx_url ltx_font_typewriter" href="https://aclanthology.org/P19-1285" title="">https://aclanthology.org/P19-1285</a>.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib6">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">DeepSeek-AI et al. (2024)</span>
<span class="ltx_bibblock">
DeepSeek-AI, Aixin Liu, Bei Feng, Bin Wang, Bingxuan Wang, Bo Liu, Chenggang Zhao, Chengqi Dengr, Chong Ruan, Damai Dai, Daya Guo, Dejian Yang, Deli Chen, Dongjie Ji, Erhang Li, Fangyun Lin, Fuli Luo, Guangbo Hao, Guanting Chen, Guowei Li, H. Zhang, Hanwei Xu, Hao Yang, Haowei Zhang, Honghui Ding, Huajian Xin, Huazuo Gao, Hui Li, Hui Qu, J. L. Cai, Jian Liang, Jianzhong Guo, Jiaqi Ni, Jiashi Li, Jin Chen, Jingyang Yuan, Junjie Qiu, Junxiao Song, Kai Dong, Kaige Gao, Kang Guan, Lean Wang, Lecong Zhang, Lei Xu, Leyi Xia, Liang Zhao, Liyue Zhang, Meng Li, Miaojun Wang, Mingchuan Zhang, Minghua Zhang, Minghui Tang, Mingming Li, Ning Tian, Panpan Huang, Peiyi Wang, Peng Zhang, Qihao Zhu, Qinyu Chen, Qiushi Du, R. J. Chen, R. L. Jin, Ruiqi Ge, Ruizhe Pan, Runxin Xu, Ruyi Chen, S. S. Li, Shanghao Lu, Shangyan Zhou, Shanhuang Chen, Shaoqing Wu, Shengfeng Ye, Shirong Ma, Shiyu Wang, Shuang Zhou, Shuiping Yu, Shunfeng Zhou, Size Zheng, T. Wang, Tian Pei, Tian Yuan, Tianyu Sun, W. L. Xiao, Wangding Zeng, Wei An, Wen
Liu, Wenfeng Liang, Wenjun Gao, Wentao Zhang, X. Q. Li, Xiangyue Jin, Xianzu Wang, Xiao Bi, Xiaodong Liu, Xiaohan Wang, Xiaojin Shen, Xiaokang Chen, Xiaosha Chen, Xiaotao Nie, Xiaowen Sun, Xiaoxiang Wang, Xin Liu, Xin Xie, Xingkai Yu, Xinnan Song, Xinyi Zhou, Xinyu Yang, Xuan Lu, Xuecheng Su, Y. Wu, Y. K. Li, Y. X. Wei, Y. X. Zhu, Yanhong Xu, Yanping Huang, Yao Li, Yao Zhao, Yaofeng Sun, Yaohui Li, Yaohui Wang, Yi Zheng, Yichao Zhang, Yiliang Xiong, Yilong Zhao, Ying He, Ying Tang, Yishi Piao, Yixin Dong, Yixuan Tan, Yiyuan Liu, Yongji Wang, Yongqiang Guo, Yuchen Zhu, Yuduan Wang, Yuheng Zou, Yukun Zha, Yunxian Ma, Yuting Yan, Yuxiang You, Yuxuan Liu, Z. Z. Ren, Zehui Ren, Zhangli Sha, Zhe Fu, Zhen Huang, Zhen Zhang, Zhenda Xie, Zhewen Hao, Zhihong Shao, Zhiniu Wen, Zhipeng Xu, Zhongyu Zhang, Zhuoshu Li, Zihan Wang, Zihui Gu, Zilin Li, and Ziwei Xie.

</span>
<span class="ltx_bibblock">DeepSeek-V2: A Strong, Economical, and Efficient Mixture-of-Experts Language Model, June 2024.

</span>
<span class="ltx_bibblock">URL <a class="ltx_ref ltx_url ltx_font_typewriter" href="http://arxiv.org/abs/2405.04434" title="">http://arxiv.org/abs/2405.04434</a>.

</span>
<span class="ltx_bibblock">arXiv:2405.04434 [cs].

</span>
</li>
<li class="ltx_bibitem" id="bib.bib7">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Dubey et al. (2024)</span>
<span class="ltx_bibblock">
Abhimanyu Dubey, Abhinav Jauhri, Abhinav Pandey, Abhishek Kadian, Ahmad Al-Dahle, Aiesha Letman, Akhil Mathur, Alan Schelten, Amy Yang, Angela Fan, et al.

</span>
<span class="ltx_bibblock">The llama 3 herd of models.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib7.1.1">arXiv preprint arXiv:2407.21783</em>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib8">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Gao et al. (2020)</span>
<span class="ltx_bibblock">
Leo Gao, Stella Biderman, Sid Black, Laurence Golding, Travis Hoppe, Charles Foster, Jason Phang, Horace He, Anish Thite, Noa Nabeshima, Shawn Presser, and Connor Leahy.

</span>
<span class="ltx_bibblock">The Pile: An 800gb dataset of diverse text for language modeling.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib8.1.1">arXiv preprint arXiv:2101.00027</em>, 2020.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib9">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Ge et al. (2023)</span>
<span class="ltx_bibblock">
Tao Ge, Jing Hu, Xun Wang, Si-Qing Chen, and Furu Wei.

</span>
<span class="ltx_bibblock">In-context Autoencoder for Context Compression in a Large Language Model, July 2023.

</span>
<span class="ltx_bibblock">URL <a class="ltx_ref ltx_url ltx_font_typewriter" href="http://arxiv.org/abs/2307.06945" title="">http://arxiv.org/abs/2307.06945</a>.

</span>
<span class="ltx_bibblock">arXiv:2307.06945 [cs].

</span>
</li>
<li class="ltx_bibitem" id="bib.bib10">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Han et al. (2022)</span>
<span class="ltx_bibblock">
Simeng Han, Hailey Schoelkopf, Yilun Zhao, Zhenting Qi, Martin Riddell, Luke Benson, Lucy Sun, Ekaterina Zubova, Yujie Qiao, Matthew Burtell, David Peng, Jonathan Fan, Yixin Liu, Brian Wong, Malcolm Sailor, Ansong Ni, Linyong Nan, Jungo Kasai, Tao Yu, Rui Zhang, Shafiq Joty, Alexander R. Fabbri, Wojciech Kryscinski, Xi Victoria Lin, Caiming Xiong, and Dragomir Radev.

</span>
<span class="ltx_bibblock">Folio: Natural language reasoning with first-order logic.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib10.1.1">arXiv preprint arXiv:2209.00840</em>, 2022.

</span>
<span class="ltx_bibblock">URL <a class="ltx_ref ltx_url ltx_font_typewriter" href="https://arxiv.org/abs/2209.00840" title="">https://arxiv.org/abs/2209.00840</a>.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib11">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Hao et al. (2024)</span>
<span class="ltx_bibblock">
Shibo Hao, Tianyang Liu, Zhen Wang, and Zhiting Hu.

</span>
<span class="ltx_bibblock">Toolkengpt: Augmenting frozen language models with massive tools via tool embeddings.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib11.1.1">Advances in neural information processing systems</em>, 36, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib12">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">He et al. (2024)</span>
<span class="ltx_bibblock">
Hongliang He, Wenlin Yao, Kaixin Ma, Wenhao Yu, Yong Dai, Hongming Zhang, Zhenzhong Lan, and Dong Yu.

</span>
<span class="ltx_bibblock">Webvoyager: Building an end-to-end web agent with large multimodal models.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib12.1.1">arXiv preprint arXiv:2401.13919</em>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib13">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Kapoor et al. (2024)</span>
<span class="ltx_bibblock">
Raghav Kapoor, Yash Parag Butala, Melisa Russak, Jing Yu Koh, Kiran Kamble, Waseem Alshikh, and Ruslan Salakhutdinov.

</span>
<span class="ltx_bibblock">Omniact: A dataset and benchmark for enabling multimodal generalist autonomous agents for desktop and web.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib13.1.1">arXiv preprint arXiv:2402.17553</em>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib14">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Li et al. (2023)</span>
<span class="ltx_bibblock">
Junnan Li, Dongxu Li, Silvio Savarese, and Steven Hoi.

</span>
<span class="ltx_bibblock">Blip-2: Bootstrapping language-image pre-training with frozen image encoders and large language models.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib14.1.1">International conference on machine learning</em>, pages 19730–19742. PMLR, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib15">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Liu et al. (2024)</span>
<span class="ltx_bibblock">
Haotian Liu, Chunyuan Li, Qingyang Wu, and Yong Jae Lee.

</span>
<span class="ltx_bibblock">Visual instruction tuning.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib15.1.1">Advances in neural information processing systems</em>, 36, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib16">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Pan et al. (2024)</span>
<span class="ltx_bibblock">
Zhuoshi Pan, Qianhui Wu, Huiqiang Jiang, Menglin Xia, Xufang Luo, Jue Zhang, Qingwei Lin, Victor Rühle, Yuqing Yang, Chin-Yew Lin, H. Vicky Zhao, Lili Qiu, and Dongmei Zhang.

</span>
<span class="ltx_bibblock">LLMLingua-2: Data Distillation for Efficient and Faithful Task-Agnostic Prompt Compression, March 2024.

</span>
<span class="ltx_bibblock">URL <a class="ltx_ref ltx_url ltx_font_typewriter" href="http://arxiv.org/abs/2403.12968" title="">http://arxiv.org/abs/2403.12968</a>.

</span>
<span class="ltx_bibblock">arXiv:2403.12968 [cs].

</span>
</li>
<li class="ltx_bibitem" id="bib.bib17">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Penedo et al. (2024)</span>
<span class="ltx_bibblock">
Guilherme Penedo, Hynek Kydlíček, Loubna Ben allal, Anton Lozhkov, Margaret Mitchell, Colin Raffel, Leandro Von Werra, and Thomas Wolf.

</span>
<span class="ltx_bibblock">The fineweb datasets: Decanting the web for the finest text data at scale, 2024.

</span>
<span class="ltx_bibblock">URL <a class="ltx_ref ltx_url ltx_font_typewriter" href="https://arxiv.org/abs/2406.17557" title="">https://arxiv.org/abs/2406.17557</a>.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib18">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Sakaguchi et al. (2021)</span>
<span class="ltx_bibblock">
Keisuke Sakaguchi, Chandra Bhagavatula, Ronan Le Bras, Niket Tandon, Peter Clark, and Yejin Choi.

</span>
<span class="ltx_bibblock">proscript: Partially ordered scripts generation via pre-trained language models.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib18.1.1">arXiv preprint arXiv:2104.08251</em>, 2021.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib19">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Schick et al. (2024)</span>
<span class="ltx_bibblock">
Timo Schick, Jane Dwivedi-Yu, Roberto Dessì, Roberta Raileanu, Maria Lomeli, Eric Hambro, Luke Zettlemoyer, Nicola Cancedda, and Thomas Scialom.

</span>
<span class="ltx_bibblock">Toolformer: Language models can teach themselves to use tools.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib19.1.1">Advances in Neural Information Processing Systems</em>, 36, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib20">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Yang et al. (2024)</span>
<span class="ltx_bibblock">
Yuan Yang, Siheng Xiong, Ali Payani, Ehsan Shareghi, and Faramarz Fekri.

</span>
<span class="ltx_bibblock">Can llms reason in the wild with programs?

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib20.1.1">arXiv preprint arXiv:2406.13764</em>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib21">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Yao et al. (2022)</span>
<span class="ltx_bibblock">
Shunyu Yao, Jeffrey Zhao, Dian Yu, Nan Du, Izhak Shafran, Karthik Narasimhan, and Yuan Cao.

</span>
<span class="ltx_bibblock">React: Synergizing reasoning and acting in language models.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib21.1.1">arXiv preprint arXiv:2210.03629</em>, 2022.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib22">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Yu et al. (2020)</span>
<span class="ltx_bibblock">
Weihao Yu, Zihang Jiang, Yanfei Dong, and Jiashi Feng.

</span>
<span class="ltx_bibblock">Reclor: A reading comprehension dataset requiring logical reasoning.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib22.1.1">arXiv preprint arXiv:2002.04326</em>, 2020.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib23">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Zhao et al. (2024)</span>
<span class="ltx_bibblock">
Penghao Zhao, Hailin Zhang, Qinhan Yu, Zhengren Wang, Yunteng Geng, Fangcheng Fu, Ling Yang, Wentao Zhang, and Bin Cui.

</span>
<span class="ltx_bibblock">Retrieval-augmented generation for ai-generated content: A survey.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib23.1.1">arXiv preprint arXiv:2402.19473</em>, 2024.

</span>
</li>
</ul>
</section>
</article>
</div>
<footer class="ltx_page_footer">
<div class="ltx_page_logo">Generated  on Mon Sep  2 23:25:23 2024 by <a class="ltx_LaTeXML_logo" href="http://dlmf.nist.gov/LaTeXML/"><span style="letter-spacing:-0.2em; margin-right:0.1em;">L<span class="ltx_font_smallcaps" style="position:relative; bottom:2.2pt;">a</span>T<span class="ltx_font_smallcaps" style="font-size:120%;position:relative; bottom:-0.2ex;">e</span></span><span style="font-size:90%; position:relative; bottom:-0.2ex;">XML</span><img alt="Mascot Sammy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAOCAYAAAD5YeaVAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wKExQZLWTEaOUAAAAddEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIFRoZSBHSU1Q72QlbgAAAdpJREFUKM9tkL+L2nAARz9fPZNCKFapUn8kyI0e4iRHSR1Kb8ng0lJw6FYHFwv2LwhOpcWxTjeUunYqOmqd6hEoRDhtDWdA8ApRYsSUCDHNt5ul13vz4w0vWCgUnnEc975arX6ORqN3VqtVZbfbTQC4uEHANM3jSqXymFI6yWazP2KxWAXAL9zCUa1Wy2tXVxheKA9YNoR8Pt+aTqe4FVVVvz05O6MBhqUIBGk8Hn8HAOVy+T+XLJfLS4ZhTiRJgqIoVBRFIoric47jPnmeB1mW/9rr9ZpSSn3Lsmir1fJZlqWlUonKsvwWwD8ymc/nXwVBeLjf7xEKhdBut9Hr9WgmkyGEkJwsy5eHG5vN5g0AKIoCAEgkEkin0wQAfN9/cXPdheu6P33fBwB4ngcAcByHJpPJl+fn54mD3Gg0NrquXxeLRQAAwzAYj8cwTZPwPH9/sVg8PXweDAauqqr2cDjEer1GJBLBZDJBs9mE4zjwfZ85lAGg2+06hmGgXq+j3+/DsixYlgVN03a9Xu8jgCNCyIegIAgx13Vfd7vdu+FweG8YRkjXdWy329+dTgeSJD3ieZ7RNO0VAXAPwDEAO5VKndi2fWrb9jWl9Esul6PZbDY9Go1OZ7PZ9z/lyuD3OozU2wAAAABJRU5ErkJggg=="/></a>
</div></footer>
</div>
</body>
</html>
