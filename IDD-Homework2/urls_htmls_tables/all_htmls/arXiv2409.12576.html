<!DOCTYPE html>
<html lang="en" prefix="dcterms: http://purl.org/dc/terms/">
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<title>StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation</title>
<!--Generated on Thu Sep 19 08:51:13 2024 by LaTeXML (version 0.8.8) http://dlmf.nist.gov/LaTeXML/.-->
<!--Document created on  %\date{September␣9,␣1985}¯%␣Here␣you␣can␣change␣the␣date␣presented␣in␣the␣paper␣title .-->
<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
<link href="/static/browse/0.3.4/css/ar5iv.0.7.9.min.css" rel="stylesheet" type="text/css"/>
<link href="/static/browse/0.3.4/css/ar5iv-fonts.0.7.9.min.css" rel="stylesheet" type="text/css"/>
<link href="/static/browse/0.3.4/css/latexml_styles.css" rel="stylesheet" type="text/css"/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.3/html2canvas.min.js"></script>
<script src="/static/browse/0.3.4/js/addons_new.js"></script>
<script src="/static/browse/0.3.4/js/feedbackOverlay.js"></script>
<base href="/html/2409.12576v1/"/></head>
<body>
<nav class="ltx_page_navbar">
<nav class="ltx_TOC">
<ol class="ltx_toclist">
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S1" title="In StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">1 </span>Introduction</span></a></li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S2" title="In StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">2 </span>Related Work</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S2.SS1" title="In 2 Related Work ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">2.1 </span>Subject-Driven Image Generation</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S2.SS2" title="In 2 Related Work ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">2.2 </span>Image Story Generation</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S3" title="In StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">3 </span>Preliminaries</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S3.SS1" title="In 3 Preliminaries ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">3.1 </span>Stable diffusion</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S3.SS2" title="In 3 Preliminaries ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">3.2 </span>IP-Adapter</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S4" title="In StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4 </span>Method</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S4.SS1" title="In 4 Method ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.1 </span>Overview</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S4.SS2" title="In 4 Method ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.2 </span>Reference Information Extraction</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S4.SS3" title="In 4 Method ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.3 </span>Reference Information Refinement by Positional-aware Perceiver Resampler</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S4.SS4" title="In 4 Method ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.4 </span>Decoupled Cross-attention</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S4.SS5" title="In 4 Method ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.5 </span>Pose Decoupling from Character Images</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S4.SS6" title="In 4 Method ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.6 </span>Training with LoRA</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S4.SS7" title="In 4 Method ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.7 </span>Loss Constraints on Cross-attention Maps with Masks</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S4.SS8" title="In 4 Method ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.8 </span>Overall Loss</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5" title="In StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5 </span>Experiments</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection">
<a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.SS1" title="In 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.1 </span>Setup</span></a>
<ol class="ltx_toclist ltx_toclist_subsection">
<li class="ltx_tocentry ltx_tocentry_subsubsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.SS1.SSS1" title="In 5.1 Setup ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.1.1 </span>Datasets</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsubsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.SS1.SSS2" title="In 5.1 Setup ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.1.2 </span>Training Details</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsubsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.SS1.SSS3" title="In 5.1 Setup ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.1.3 </span>Evaluation Metrics</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_subsection">
<a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.SS2" title="In 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.2 </span>Results</span></a>
<ol class="ltx_toclist ltx_toclist_subsection">
<li class="ltx_tocentry ltx_tocentry_subsubsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.SS2.SSS1" title="In 5.2 Results ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.2.1 </span>Quantitative Evaluation</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsubsection"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.SS2.SSS2" title="In 5.2 Results ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.2.2 </span>Visualization</span></a></li>
</ol>
</li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S6" title="In StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">6 </span>Conclusion</span></a></li>
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S7" title="In StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">7 </span>Limitations</span></a></li>
</ol></nav>
</nav>
<div class="ltx_page_main">
<div class="ltx_page_content">
<article class="ltx_document ltx_authors_1line">
<h1 class="ltx_title ltx_title_document">StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation</h1>
<div class="ltx_authors">
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname">Zhengguang Zhou
</span><span class="ltx_author_notes">
<span class="ltx_contact ltx_role_affiliation">
</span></span></span>
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname"> Jing Li
</span><span class="ltx_author_notes">
<span class="ltx_contact ltx_role_affiliation">
</span></span></span>
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname"> Huaxia Li
</span><span class="ltx_author_notes">Project Leader
<span class="ltx_contact ltx_role_affiliation">
</span></span></span>
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname"> Nemo Chen
</span><span class="ltx_author_notes">
<span class="ltx_contact ltx_role_affiliation">
</span></span></span>
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname"> Xu Tang
<br class="ltx_break"/>Xiaohongshu Inc.
<br class="ltx_break"/>
</span><span class="ltx_author_notes">
<span class="ltx_contact ltx_role_affiliation">
</span></span></span>
</div>
<div class="ltx_abstract">
<h6 class="ltx_title ltx_title_abstract">Abstract</h6>
<p class="ltx_p" id="id1.1">Tuning-free personalized image generation methods have achieved significant success in maintaining facial consistency, <math alttext="i.e." class="ltx_Math" display="inline" id="id1.1.m1.3"><semantics id="id1.1.m1.3a"><mrow id="id1.1.m1.3.3.1"><mrow id="id1.1.m1.3.3.1.1.2" xref="id1.1.m1.3.3.1.1.1.cmml"><mi id="id1.1.m1.1.1" xref="id1.1.m1.1.1.cmml">i</mi><mo id="id1.1.m1.3.3.1.1.2.1" lspace="0em" rspace="0.167em" xref="id1.1.m1.3.3.1.1.1a.cmml">.</mo><mi id="id1.1.m1.2.2" xref="id1.1.m1.2.2.cmml">e</mi></mrow><mo id="id1.1.m1.3.3.1.2" lspace="0em">.</mo></mrow><annotation-xml encoding="MathML-Content" id="id1.1.m1.3b"><apply id="id1.1.m1.3.3.1.1.1.cmml" xref="id1.1.m1.3.3.1.1.2"><csymbol cd="ambiguous" id="id1.1.m1.3.3.1.1.1a.cmml" xref="id1.1.m1.3.3.1.1.2.1">formulae-sequence</csymbol><ci id="id1.1.m1.1.1.cmml" xref="id1.1.m1.1.1">𝑖</ci><ci id="id1.1.m1.2.2.cmml" xref="id1.1.m1.2.2">𝑒</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="id1.1.m1.3c">i.e.</annotation><annotation encoding="application/x-llamapun" id="id1.1.m1.3d">italic_i . italic_e .</annotation></semantics></math>, identities, even with multiple characters. However, the lack of holistic consistency in scenes with multiple characters hampers these methods’ ability to create a cohesive narrative. In this paper, we introduce StoryMaker, a personalization solution that preserves not only facial consistency but also clothing, hairstyles, and body consistency, thus facilitating the creation of a story through a series of images. StoryMaker incorporates conditions based on face identities and cropped character images, which include clothing, hairstyles, and bodies. Specifically, we integrate the facial identity information with the cropped character images using the Positional-aware Perceiver Resampler (PPR) to obtain distinct character features. To prevent intermingling of multiple characters and the background, we separately constrain the cross-attention impact regions of different characters and the background using MSE loss with segmentation masks. Additionally, we train the generation network conditioned on poses to promote decoupling from poses. A LoRA is also employed to enhance fidelity and quality. Experiments underscore the effectiveness of our approach. StoryMaker supports numerous applications and is compatible with other societal plug-ins. Our source codes and model weights are available at <a class="ltx_ref ltx_href" href="https://github.com/RedAIGC/StoryMaker" title="">https://github.com/RedAIGC/StoryMaker</a>.</p>
</div>
<figure class="ltx_figure" id="S0.F1"><img alt="Refer to caption" class="ltx_graphics ltx_centering ltx_img_square" height="798" id="S0.F1.g1" src="extracted/5865094/figures/day1.png" width="878"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 1: </span>Visualization of images generated by our StoryMaker. The first three rows depict a story about a day in the life of an "office worker," while the last two rows tell a story inspired by the movie "Before Sunrise."</figcaption>
</figure>
<section class="ltx_section" id="S1">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">1 </span>Introduction</h2>
<div class="ltx_para ltx_noindent" id="S1.p1">
<p class="ltx_p" id="S1.p1.1">Diffusion-based image generation methods, such as DALL-E <cite class="ltx_cite ltx_citemacro_citep">(Ramesh et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib1" title="">2021</a>)</cite>, Imagen <cite class="ltx_cite ltx_citemacro_citep">(Saharia et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib2" title="">2022</a>)</cite>, and Stable Diffusion <cite class="ltx_cite ltx_citemacro_citep">(Rombach et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib3" title="">2021</a>)</cite>, have recently made significant advancements. However, personalizing generated content using texts alone remains challenging. To address this, test-time fine-tuning methods <cite class="ltx_cite ltx_citemacro_citep">(Avrahami et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib4" title="">2023</a>; Gal et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib5" title="">2022</a>; Kumari et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib6" title="">2023</a>; Ruiz et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib7" title="">2023</a>)</cite> have been proposed to produce images with specific subjects. Nevertheless, their generalization ability is constrained by the limited number of images and the high cost of fine-tuning. Consequently, tuning-free methods <cite class="ltx_cite ltx_citemacro_citep">(Li et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib8" title="">2024a</a>; Ma et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib9" title="">2024</a>; Wei et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib10" title="">2023</a>; Xiao et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib11" title="">2023</a>; Wei et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib12" title="">2024</a>; Kim et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib13" title="">2024</a>; Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib14" title="">2023a</a>; Wang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib15" title="">2024a</a>; Han et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib16" title="">2024</a>)</cite> trained on large-scale datasets have been introduced. These methods employ a visual encoder to integrate visual information into the generator without the need for lengthy fine-tuning. While <cite class="ltx_cite ltx_citemacro_cite">Xiao et al. (<a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib11" title="">2023</a>); Wei et al. (<a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib12" title="">2024</a>); Kim et al. (<a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib13" title="">2024</a>)</cite> preserve facial identities, they fail to maintain the holistic consistency including consistent clothing, hairstyles, and bodies, thereby limiting their applications.</p>
</div>
<div class="ltx_para ltx_noindent" id="S1.p2">
<p class="ltx_p" id="S1.p2.1">In this paper, we introduce StoryMaker, which pursues the holistic consistency, not only preserving facial identities but also clothing, hairstyles, and bodies. StoryMaker allows variation in backgrounds, character poses, and styles through text prompts, enabling the generation of a series of images with consistent characters, thereby creating a narrative. StoryMaker also facilitates applications such as clothing swapping and image variation and is compatible with plug-ins like LoRA for stylization.</p>
</div>
<div class="ltx_para ltx_noindent" id="S1.p3">
<p class="ltx_p" id="S1.p3.1">To preserve clothing, hairstyles, and bodies in addition to faces, StoryMaker conditions the generation on face identities and cropped character images, which include clothing, hairstyles, and bodies. After extracting information from the reference image, we integrate face identities and cropped character images using the Positional-aware Perceiver Resampler (PPR) to derive character features.
</p>
</div>
<div class="ltx_para ltx_noindent" id="S1.p4">
<p class="ltx_p" id="S1.p4.1">As it is more difficult to retain clothing, hair styles and bodies, other than only face identities, StoryMaker regularizes the cross-attention impact region among different characters as well as the background. Unlike MM-Diff <cite class="ltx_cite ltx_citemacro_citep">(Wei et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib12" title="">2024</a>)</cite>, which only separates different foregrounds, we include a learnable background embedding to encourage differentiation from the background. An ID loss is introduced to further regularize identities. To decouple generation from the poses of cropped character images, enhancing diversity and utility, we train our model on predicted poses with ControlNet <cite class="ltx_cite ltx_citemacro_citep">(Zhang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib17" title="">2023</a>)</cite>. During inference, ControlNet can be omitted, allowing poses to be guided directly by text prompts. Alternatively, referred poses can be provided to ControlNet. A LoRA is employed to improve fidelity and quality. By combining these elements, StoryMaker generates image series with consistent faces, clothing, hairstyles, and bodies, thereby constructing a coherent story.</p>
</div>
<div class="ltx_para ltx_noindent" id="S1.p5">
<p class="ltx_p" id="S1.p5.1">In summary, the main contributions of this paper are: i) We address the task of generating a series of images with consistent faces, clothing, hairstyles, and bodies, while allowing variations in backgrounds, poses, and styles via text prompts, enabling narrative creation. ii) To tackle this complex task, we propose StoryMaker, which first extracts information from reference images and refines it using the Positional-aware Perceiver Resampler. To prevent different characters and the background from interleaving each other, we regularize the cross-attention impact region using MSE loss with segmentation masks and train the backbone network conditioned on poses by ControlNet to facilitate decoupling. We also train a LoRA to enhance fidelity and quality. iii) Experiments demonstrate that our proposed StoryMaker achieves excellent performance and has diverse applications in real-world scenarios.</p>
</div>
</section>
<section class="ltx_section" id="S2">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">2 </span>Related Work</h2>
<section class="ltx_subsection" id="S2.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">2.1 </span>Subject-Driven Image Generation</h3>
<div class="ltx_para ltx_noindent" id="S2.SS1.p1">
<p class="ltx_p" id="S2.SS1.p1.1">Subject-driven text-to-image generation has achieved remarkable progress. Current methods in this domain can be categorized based on whether they necessitate test-time fine-tuning for input images. Early approaches <cite class="ltx_cite ltx_citemacro_citep">(Ruiz et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib7" title="">2023</a>; Gal et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib5" title="">2022</a>, <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib18" title="">2023</a>)</cite> require test-time optimization of specific text tokens to represent target concepts using a limited set of subject images. These fine-tuning methods are time-consuming due to the slow optimization process before inference. Recent methods aim to eliminate the need for fine-tuning by integrating additional modules while keeping the primary pre-trained text-to-image models frozen. Subject-Diffusion <cite class="ltx_cite ltx_citemacro_citep">(Ma et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib9" title="">2024</a>)</cite> substitutes text tokens describing subjects with the corresponding image embeddings and trains an adapter module to incorporate fine-grained image features. ELITE <cite class="ltx_cite ltx_citemacro_citep">(Wei et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib10" title="">2023</a>)</cite> and FastComposer <cite class="ltx_cite ltx_citemacro_citep">(Xiao et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib11" title="">2023</a>)</cite> also map images to text embeddings by training an additional network. Blip-Diffusion <cite class="ltx_cite ltx_citemacro_citep">(Li et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib19" title="">2024b</a>)</cite> employs the pre-trained multi-modal encoder BLIP-2 <cite class="ltx_cite ltx_citemacro_citep">(Li et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib20" title="">2023</a>)</cite> to infuse image information. IP-Adapter <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite> separates image and text features in cross-attention, allowing for independent image feature integration. MoA (Mixture-of-Attention) <cite class="ltx_cite ltx_citemacro_citep">(Ostashev et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib22" title="">2024</a>)</cite> enhances image quality by segregating subject and context. The SSR-Encoder <cite class="ltx_cite ltx_citemacro_citep">(Zhang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib23" title="">2024a</a>)</cite> is a recent development that integrates segment information into text features through cross-attention, facilitating selective feature extraction.</p>
</div>
<div class="ltx_para ltx_noindent" id="S2.SS1.p2">
<p class="ltx_p" id="S2.SS1.p2.1">Identity-preserving human image generation is a prominent area in subject-driven image generation, given its broad real-world applications. Solutions such as FaceStudio <cite class="ltx_cite ltx_citemacro_citep">(Yan et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib24" title="">2023</a>)</cite>, IP-Adapter-FaceID <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite>, FlashFace <cite class="ltx_cite ltx_citemacro_citep">(Zhang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib25" title="">2024b</a>)</cite>, and PhotoMaker <cite class="ltx_cite ltx_citemacro_citep">(Li et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib8" title="">2024a</a>)</cite> utilize ID embeddings derived from Arcface <cite class="ltx_cite ltx_citemacro_citep">(Deng et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib26" title="">2019</a>)</cite> as a condition, which is crucial for maintaining facial fidelity. The leading approach, InstantID <cite class="ltx_cite ltx_citemacro_citep">(Wang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib15" title="">2024a</a>)</cite>, introduces IdentityNet, which uses five facial keypoints to control face structure, achieving optimal face similarity. Beyond single-ID customization, some methods <cite class="ltx_cite ltx_citemacro_citep">(Wei et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib12" title="">2024</a>; He et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib27" title="">2024a</a>; Jang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib28" title="">2024</a>; Kumari et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib6" title="">2023</a>; Avrahami et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib4" title="">2023</a>)</cite> focus on multi-ID image generation. Some studies <cite class="ltx_cite ltx_citemacro_citep">(Kim et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib13" title="">2024</a>; Kong et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib29" title="">2024</a>)</cite> use predefined layouts to guide multi-ID image generation, while limits the scalability in real-world scenarios. In contrast, MM-diff <cite class="ltx_cite ltx_citemacro_citep">(Wei et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib12" title="">2024</a>)</cite> imposes constrains on the cross-attention maps with different subjects during the training phase, which guarantees the generation of multi-ID images without any predefined input. Recently, UniPortrait <cite class="ltx_cite ltx_citemacro_citep">(He et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib27" title="">2024a</a>)</cite> employs an ID routing module to unify multi-ID customization, avoiding identity blending. Our proposed StoryMaker not only preserves faces in image generation, but also ensures consistency in clothing, hairstyle, and bodies. For multi-character generation, we introduce the Positional-aware Perceiver Resampler and attention loss to address multi-character blending.</p>
</div>
</section>
<section class="ltx_subsection" id="S2.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">2.2 </span>Image Story Generation</h3>
<div class="ltx_para ltx_noindent" id="S2.SS2.p1">
<p class="ltx_p" id="S2.SS2.p1.1">Maintaining consistent content across a series of generated images has numerous real-world applications, such as story visualization and comic creation. StoryDiffusion <cite class="ltx_cite ltx_citemacro_citep">(Zhou et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib30" title="">2024</a>)</cite> employs a consistent self-attention mechanism that adapts information from other images in the batch to ensure character consistency in storytelling sequences.
Unlike StoryDiffusion, which adapts from full images, ConsiStory <cite class="ltx_cite ltx_citemacro_citep">(Tewel et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib31" title="">2024</a>)</cite> uses a subject-driven shared attention block that only adapts information from masked subjects, with correspondence-based feature injection enhancing subject consistency between images.
DreamStory <cite class="ltx_cite ltx_citemacro_citep">(He et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib32" title="">2024b</a>)</cite> leverages a Large Language Model (LLM) for better understanding and guidance in generation. Subjects are generated first, followed by a Multi-Subject Consistent Diffusion model, ensuring subject consistency across images by adapting information from other images in self-attention and from texts in cross-attention, similar to ConsiStory.
OneActor <cite class="ltx_cite ltx_citemacro_citep">(Wang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib33" title="">2024b</a>)</cite> introduces a cluster-conditioned generation paradigm, achieving controlled, consistent subject generation by tuning an adapter to inject modified prompt embeddings into the fixed U-Net.
Our method focuses on generating images with consistent subjects given references, while these methods work without references. Approaches like StoryDiffusion, ConsiStory, and DreamStory are training-free, yet backgrounds can easily be involved with inaccurate masks.</p>
</div>
<figure class="ltx_figure" id="S2.F2"><img alt="Refer to caption" class="ltx_graphics ltx_centering ltx_img_landscape" height="360" id="S2.F2.g1" src="extracted/5865094/figures/pipe2.png" width="929"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 2: </span>he model architecture of our proposed StoryMaker. The facial image and character image are embedded using the face encoder and image encoder, respectively, and refined through our proposed Positional-aware Perceiver Resampler module. Decoupled cross-attention with LoRAs is employed to inject these embeddings into the diffusion model. At the bottom, we illustrate the attention loss on cross-attention maps with the segmentation mask. The core of the PPR module is also depicted on the right.</figcaption>
</figure>
</section>
</section>
<section class="ltx_section" id="S3">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">3 </span>Preliminaries</h2>
<div class="ltx_para ltx_noindent" id="S3.p1">
<p class="ltx_p" id="S3.p1.1">We build our model on the state-of-the-art text-to-image model, namely Stable Diffusion XL <cite class="ltx_cite ltx_citemacro_citep">(Podell et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib34" title="">2023</a>)</cite>. In this section, we first introduce preliminaries about diffusion models and IP-adapter <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite>, which form the foundation of our method.</p>
</div>
<section class="ltx_subsection" id="S3.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">3.1 </span>Stable diffusion</h3>
<div class="ltx_para ltx_noindent" id="S3.SS1.p1">
<p class="ltx_p" id="S3.SS1.p1.13">The innovation of Stable Diffusion resides in executing the diffusion process within a low-dimensional latent space to enhance computational efficiency. This approach incorporates three primary components: a variational autoencoder (VAE) <cite class="ltx_cite ltx_citemacro_citep">(Kingma, <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib35" title="">2013</a>)</cite> for compressing input images into the latent space, a text encoder to transform textual prompts into embeddings, and a U-Net <cite class="ltx_cite ltx_citemacro_citep">(Ronneberger et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib36" title="">2015</a>)</cite> for the denoising procedure. For a given input image <math alttext="x" class="ltx_Math" display="inline" id="S3.SS1.p1.1.m1.1"><semantics id="S3.SS1.p1.1.m1.1a"><mi id="S3.SS1.p1.1.m1.1.1" xref="S3.SS1.p1.1.m1.1.1.cmml">x</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.1.m1.1b"><ci id="S3.SS1.p1.1.m1.1.1.cmml" xref="S3.SS1.p1.1.m1.1.1">𝑥</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.1.m1.1c">x</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.1.m1.1d">italic_x</annotation></semantics></math> of dimensions <math alttext="H\times W\times 3" class="ltx_Math" display="inline" id="S3.SS1.p1.2.m2.1"><semantics id="S3.SS1.p1.2.m2.1a"><mrow id="S3.SS1.p1.2.m2.1.1" xref="S3.SS1.p1.2.m2.1.1.cmml"><mi id="S3.SS1.p1.2.m2.1.1.2" xref="S3.SS1.p1.2.m2.1.1.2.cmml">H</mi><mo id="S3.SS1.p1.2.m2.1.1.1" lspace="0.222em" rspace="0.222em" xref="S3.SS1.p1.2.m2.1.1.1.cmml">×</mo><mi id="S3.SS1.p1.2.m2.1.1.3" xref="S3.SS1.p1.2.m2.1.1.3.cmml">W</mi><mo id="S3.SS1.p1.2.m2.1.1.1a" lspace="0.222em" rspace="0.222em" xref="S3.SS1.p1.2.m2.1.1.1.cmml">×</mo><mn id="S3.SS1.p1.2.m2.1.1.4" xref="S3.SS1.p1.2.m2.1.1.4.cmml">3</mn></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.2.m2.1b"><apply id="S3.SS1.p1.2.m2.1.1.cmml" xref="S3.SS1.p1.2.m2.1.1"><times id="S3.SS1.p1.2.m2.1.1.1.cmml" xref="S3.SS1.p1.2.m2.1.1.1"></times><ci id="S3.SS1.p1.2.m2.1.1.2.cmml" xref="S3.SS1.p1.2.m2.1.1.2">𝐻</ci><ci id="S3.SS1.p1.2.m2.1.1.3.cmml" xref="S3.SS1.p1.2.m2.1.1.3">𝑊</ci><cn id="S3.SS1.p1.2.m2.1.1.4.cmml" type="integer" xref="S3.SS1.p1.2.m2.1.1.4">3</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.2.m2.1c">H\times W\times 3</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.2.m2.1d">italic_H × italic_W × 3</annotation></semantics></math>, the VAE encoder <math alttext="\varepsilon" class="ltx_Math" display="inline" id="S3.SS1.p1.3.m3.1"><semantics id="S3.SS1.p1.3.m3.1a"><mi id="S3.SS1.p1.3.m3.1.1" xref="S3.SS1.p1.3.m3.1.1.cmml">ε</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.3.m3.1b"><ci id="S3.SS1.p1.3.m3.1.1.cmml" xref="S3.SS1.p1.3.m3.1.1">𝜀</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.3.m3.1c">\varepsilon</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.3.m3.1d">italic_ε</annotation></semantics></math> transforms it to a latent representation <math alttext="z_{0}=\varepsilon(x)" class="ltx_Math" display="inline" id="S3.SS1.p1.4.m4.1"><semantics id="S3.SS1.p1.4.m4.1a"><mrow id="S3.SS1.p1.4.m4.1.2" xref="S3.SS1.p1.4.m4.1.2.cmml"><msub id="S3.SS1.p1.4.m4.1.2.2" xref="S3.SS1.p1.4.m4.1.2.2.cmml"><mi id="S3.SS1.p1.4.m4.1.2.2.2" xref="S3.SS1.p1.4.m4.1.2.2.2.cmml">z</mi><mn id="S3.SS1.p1.4.m4.1.2.2.3" xref="S3.SS1.p1.4.m4.1.2.2.3.cmml">0</mn></msub><mo id="S3.SS1.p1.4.m4.1.2.1" xref="S3.SS1.p1.4.m4.1.2.1.cmml">=</mo><mrow id="S3.SS1.p1.4.m4.1.2.3" xref="S3.SS1.p1.4.m4.1.2.3.cmml"><mi id="S3.SS1.p1.4.m4.1.2.3.2" xref="S3.SS1.p1.4.m4.1.2.3.2.cmml">ε</mi><mo id="S3.SS1.p1.4.m4.1.2.3.1" xref="S3.SS1.p1.4.m4.1.2.3.1.cmml">⁢</mo><mrow id="S3.SS1.p1.4.m4.1.2.3.3.2" xref="S3.SS1.p1.4.m4.1.2.3.cmml"><mo id="S3.SS1.p1.4.m4.1.2.3.3.2.1" stretchy="false" xref="S3.SS1.p1.4.m4.1.2.3.cmml">(</mo><mi id="S3.SS1.p1.4.m4.1.1" xref="S3.SS1.p1.4.m4.1.1.cmml">x</mi><mo id="S3.SS1.p1.4.m4.1.2.3.3.2.2" stretchy="false" xref="S3.SS1.p1.4.m4.1.2.3.cmml">)</mo></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.4.m4.1b"><apply id="S3.SS1.p1.4.m4.1.2.cmml" xref="S3.SS1.p1.4.m4.1.2"><eq id="S3.SS1.p1.4.m4.1.2.1.cmml" xref="S3.SS1.p1.4.m4.1.2.1"></eq><apply id="S3.SS1.p1.4.m4.1.2.2.cmml" xref="S3.SS1.p1.4.m4.1.2.2"><csymbol cd="ambiguous" id="S3.SS1.p1.4.m4.1.2.2.1.cmml" xref="S3.SS1.p1.4.m4.1.2.2">subscript</csymbol><ci id="S3.SS1.p1.4.m4.1.2.2.2.cmml" xref="S3.SS1.p1.4.m4.1.2.2.2">𝑧</ci><cn id="S3.SS1.p1.4.m4.1.2.2.3.cmml" type="integer" xref="S3.SS1.p1.4.m4.1.2.2.3">0</cn></apply><apply id="S3.SS1.p1.4.m4.1.2.3.cmml" xref="S3.SS1.p1.4.m4.1.2.3"><times id="S3.SS1.p1.4.m4.1.2.3.1.cmml" xref="S3.SS1.p1.4.m4.1.2.3.1"></times><ci id="S3.SS1.p1.4.m4.1.2.3.2.cmml" xref="S3.SS1.p1.4.m4.1.2.3.2">𝜀</ci><ci id="S3.SS1.p1.4.m4.1.1.cmml" xref="S3.SS1.p1.4.m4.1.1">𝑥</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.4.m4.1c">z_{0}=\varepsilon(x)</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.4.m4.1d">italic_z start_POSTSUBSCRIPT 0 end_POSTSUBSCRIPT = italic_ε ( italic_x )</annotation></semantics></math> of dimensions <math alttext="H/8\times W/8\times C" class="ltx_Math" display="inline" id="S3.SS1.p1.5.m5.1"><semantics id="S3.SS1.p1.5.m5.1a"><mrow id="S3.SS1.p1.5.m5.1.1" xref="S3.SS1.p1.5.m5.1.1.cmml"><mrow id="S3.SS1.p1.5.m5.1.1.2" xref="S3.SS1.p1.5.m5.1.1.2.cmml"><mrow id="S3.SS1.p1.5.m5.1.1.2.2" xref="S3.SS1.p1.5.m5.1.1.2.2.cmml"><mrow id="S3.SS1.p1.5.m5.1.1.2.2.2" xref="S3.SS1.p1.5.m5.1.1.2.2.2.cmml"><mi id="S3.SS1.p1.5.m5.1.1.2.2.2.2" xref="S3.SS1.p1.5.m5.1.1.2.2.2.2.cmml">H</mi><mo id="S3.SS1.p1.5.m5.1.1.2.2.2.1" xref="S3.SS1.p1.5.m5.1.1.2.2.2.1.cmml">/</mo><mn id="S3.SS1.p1.5.m5.1.1.2.2.2.3" xref="S3.SS1.p1.5.m5.1.1.2.2.2.3.cmml">8</mn></mrow><mo id="S3.SS1.p1.5.m5.1.1.2.2.1" lspace="0.222em" rspace="0.222em" xref="S3.SS1.p1.5.m5.1.1.2.2.1.cmml">×</mo><mi id="S3.SS1.p1.5.m5.1.1.2.2.3" xref="S3.SS1.p1.5.m5.1.1.2.2.3.cmml">W</mi></mrow><mo id="S3.SS1.p1.5.m5.1.1.2.1" xref="S3.SS1.p1.5.m5.1.1.2.1.cmml">/</mo><mn id="S3.SS1.p1.5.m5.1.1.2.3" xref="S3.SS1.p1.5.m5.1.1.2.3.cmml">8</mn></mrow><mo id="S3.SS1.p1.5.m5.1.1.1" lspace="0.222em" rspace="0.222em" xref="S3.SS1.p1.5.m5.1.1.1.cmml">×</mo><mi id="S3.SS1.p1.5.m5.1.1.3" xref="S3.SS1.p1.5.m5.1.1.3.cmml">C</mi></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.5.m5.1b"><apply id="S3.SS1.p1.5.m5.1.1.cmml" xref="S3.SS1.p1.5.m5.1.1"><times id="S3.SS1.p1.5.m5.1.1.1.cmml" xref="S3.SS1.p1.5.m5.1.1.1"></times><apply id="S3.SS1.p1.5.m5.1.1.2.cmml" xref="S3.SS1.p1.5.m5.1.1.2"><divide id="S3.SS1.p1.5.m5.1.1.2.1.cmml" xref="S3.SS1.p1.5.m5.1.1.2.1"></divide><apply id="S3.SS1.p1.5.m5.1.1.2.2.cmml" xref="S3.SS1.p1.5.m5.1.1.2.2"><times id="S3.SS1.p1.5.m5.1.1.2.2.1.cmml" xref="S3.SS1.p1.5.m5.1.1.2.2.1"></times><apply id="S3.SS1.p1.5.m5.1.1.2.2.2.cmml" xref="S3.SS1.p1.5.m5.1.1.2.2.2"><divide id="S3.SS1.p1.5.m5.1.1.2.2.2.1.cmml" xref="S3.SS1.p1.5.m5.1.1.2.2.2.1"></divide><ci id="S3.SS1.p1.5.m5.1.1.2.2.2.2.cmml" xref="S3.SS1.p1.5.m5.1.1.2.2.2.2">𝐻</ci><cn id="S3.SS1.p1.5.m5.1.1.2.2.2.3.cmml" type="integer" xref="S3.SS1.p1.5.m5.1.1.2.2.2.3">8</cn></apply><ci id="S3.SS1.p1.5.m5.1.1.2.2.3.cmml" xref="S3.SS1.p1.5.m5.1.1.2.2.3">𝑊</ci></apply><cn id="S3.SS1.p1.5.m5.1.1.2.3.cmml" type="integer" xref="S3.SS1.p1.5.m5.1.1.2.3">8</cn></apply><ci id="S3.SS1.p1.5.m5.1.1.3.cmml" xref="S3.SS1.p1.5.m5.1.1.3">𝐶</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.5.m5.1c">H/8\times W/8\times C</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.5.m5.1d">italic_H / 8 × italic_W / 8 × italic_C</annotation></semantics></math>, where <math alttext="8" class="ltx_Math" display="inline" id="S3.SS1.p1.6.m6.1"><semantics id="S3.SS1.p1.6.m6.1a"><mn id="S3.SS1.p1.6.m6.1.1" xref="S3.SS1.p1.6.m6.1.1.cmml">8</mn><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.6.m6.1b"><cn id="S3.SS1.p1.6.m6.1.1.cmml" type="integer" xref="S3.SS1.p1.6.m6.1.1">8</cn></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.6.m6.1c">8</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.6.m6.1d">8</annotation></semantics></math> is the downsampling factor and <math alttext="C" class="ltx_Math" display="inline" id="S3.SS1.p1.7.m7.1"><semantics id="S3.SS1.p1.7.m7.1a"><mi id="S3.SS1.p1.7.m7.1.1" xref="S3.SS1.p1.7.m7.1.1.cmml">C</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.7.m7.1b"><ci id="S3.SS1.p1.7.m7.1.1.cmml" xref="S3.SS1.p1.7.m7.1.1">𝐶</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.7.m7.1c">C</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.7.m7.1d">italic_C</annotation></semantics></math> is the latent dimension. The denoising process employs a U-Net <math alttext="\epsilon_{\theta}" class="ltx_Math" display="inline" id="S3.SS1.p1.8.m8.1"><semantics id="S3.SS1.p1.8.m8.1a"><msub id="S3.SS1.p1.8.m8.1.1" xref="S3.SS1.p1.8.m8.1.1.cmml"><mi id="S3.SS1.p1.8.m8.1.1.2" xref="S3.SS1.p1.8.m8.1.1.2.cmml">ϵ</mi><mi id="S3.SS1.p1.8.m8.1.1.3" xref="S3.SS1.p1.8.m8.1.1.3.cmml">θ</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.8.m8.1b"><apply id="S3.SS1.p1.8.m8.1.1.cmml" xref="S3.SS1.p1.8.m8.1.1"><csymbol cd="ambiguous" id="S3.SS1.p1.8.m8.1.1.1.cmml" xref="S3.SS1.p1.8.m8.1.1">subscript</csymbol><ci id="S3.SS1.p1.8.m8.1.1.2.cmml" xref="S3.SS1.p1.8.m8.1.1.2">italic-ϵ</ci><ci id="S3.SS1.p1.8.m8.1.1.3.cmml" xref="S3.SS1.p1.8.m8.1.1.3">𝜃</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.8.m8.1c">\epsilon_{\theta}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.8.m8.1d">italic_ϵ start_POSTSUBSCRIPT italic_θ end_POSTSUBSCRIPT</annotation></semantics></math> to denoise the normally-distributed noise <math alttext="\epsilon" class="ltx_Math" display="inline" id="S3.SS1.p1.9.m9.1"><semantics id="S3.SS1.p1.9.m9.1a"><mi id="S3.SS1.p1.9.m9.1.1" xref="S3.SS1.p1.9.m9.1.1.cmml">ϵ</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.9.m9.1b"><ci id="S3.SS1.p1.9.m9.1.1.cmml" xref="S3.SS1.p1.9.m9.1.1">italic-ϵ</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.9.m9.1c">\epsilon</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.9.m9.1d">italic_ϵ</annotation></semantics></math> added to the noisy latent <math alttext="z_{t}" class="ltx_Math" display="inline" id="S3.SS1.p1.10.m10.1"><semantics id="S3.SS1.p1.10.m10.1a"><msub id="S3.SS1.p1.10.m10.1.1" xref="S3.SS1.p1.10.m10.1.1.cmml"><mi id="S3.SS1.p1.10.m10.1.1.2" xref="S3.SS1.p1.10.m10.1.1.2.cmml">z</mi><mi id="S3.SS1.p1.10.m10.1.1.3" xref="S3.SS1.p1.10.m10.1.1.3.cmml">t</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.10.m10.1b"><apply id="S3.SS1.p1.10.m10.1.1.cmml" xref="S3.SS1.p1.10.m10.1.1"><csymbol cd="ambiguous" id="S3.SS1.p1.10.m10.1.1.1.cmml" xref="S3.SS1.p1.10.m10.1.1">subscript</csymbol><ci id="S3.SS1.p1.10.m10.1.1.2.cmml" xref="S3.SS1.p1.10.m10.1.1.2">𝑧</ci><ci id="S3.SS1.p1.10.m10.1.1.3.cmml" xref="S3.SS1.p1.10.m10.1.1.3">𝑡</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.10.m10.1c">z_{t}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.10.m10.1d">italic_z start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT</annotation></semantics></math> at timestep <math alttext="t" class="ltx_Math" display="inline" id="S3.SS1.p1.11.m11.1"><semantics id="S3.SS1.p1.11.m11.1a"><mi id="S3.SS1.p1.11.m11.1.1" xref="S3.SS1.p1.11.m11.1.1.cmml">t</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.11.m11.1b"><ci id="S3.SS1.p1.11.m11.1.1.cmml" xref="S3.SS1.p1.11.m11.1.1">𝑡</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.11.m11.1c">t</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.11.m11.1d">italic_t</annotation></semantics></math>, conditioned on <math alttext="c" class="ltx_Math" display="inline" id="S3.SS1.p1.12.m12.1"><semantics id="S3.SS1.p1.12.m12.1a"><mi id="S3.SS1.p1.12.m12.1.1" xref="S3.SS1.p1.12.m12.1.1.cmml">c</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.12.m12.1b"><ci id="S3.SS1.p1.12.m12.1.1.cmml" xref="S3.SS1.p1.12.m12.1.1">𝑐</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.12.m12.1c">c</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.12.m12.1d">italic_c</annotation></semantics></math>. Here, <math alttext="c" class="ltx_Math" display="inline" id="S3.SS1.p1.13.m13.1"><semantics id="S3.SS1.p1.13.m13.1a"><mi id="S3.SS1.p1.13.m13.1.1" xref="S3.SS1.p1.13.m13.1.1.cmml">c</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.13.m13.1b"><ci id="S3.SS1.p1.13.m13.1.1.cmml" xref="S3.SS1.p1.13.m13.1.1">𝑐</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.13.m13.1c">c</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.13.m13.1d">italic_c</annotation></semantics></math> denotes the text embeddings generated by the pre-trained CLIP text encoder. The overall training objective is defined as:</p>
<table class="ltx_equation ltx_centering ltx_eqn_table" id="S3.E1">
<tbody><tr class="ltx_equation ltx_centering ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathcal{L}_{SD}=\mathbb{E}_{\varepsilon(x),c,\epsilon\sim\mathcal{N}(0,1),t}%
\left[\left\|\epsilon-\epsilon_{\theta}(z_{t},t,c)\right\|_{2}^{2}\right]" class="ltx_Math" display="block" id="S3.E1.m1.10"><semantics id="S3.E1.m1.10a"><mrow id="S3.E1.m1.10.10" xref="S3.E1.m1.10.10.cmml"><msub id="S3.E1.m1.10.10.3" xref="S3.E1.m1.10.10.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S3.E1.m1.10.10.3.2" xref="S3.E1.m1.10.10.3.2.cmml">ℒ</mi><mrow id="S3.E1.m1.10.10.3.3" xref="S3.E1.m1.10.10.3.3.cmml"><mi id="S3.E1.m1.10.10.3.3.2" xref="S3.E1.m1.10.10.3.3.2.cmml">S</mi><mo id="S3.E1.m1.10.10.3.3.1" xref="S3.E1.m1.10.10.3.3.1.cmml">⁢</mo><mi id="S3.E1.m1.10.10.3.3.3" xref="S3.E1.m1.10.10.3.3.3.cmml">D</mi></mrow></msub><mo id="S3.E1.m1.10.10.2" xref="S3.E1.m1.10.10.2.cmml">=</mo><mrow id="S3.E1.m1.10.10.1" xref="S3.E1.m1.10.10.1.cmml"><msub id="S3.E1.m1.10.10.1.3" xref="S3.E1.m1.10.10.1.3.cmml"><mi id="S3.E1.m1.10.10.1.3.2" xref="S3.E1.m1.10.10.1.3.2.cmml">𝔼</mi><mrow id="S3.E1.m1.7.7.7.7" xref="S3.E1.m1.7.7.7.8.cmml"><mrow id="S3.E1.m1.7.7.7.7.1" xref="S3.E1.m1.7.7.7.7.1.cmml"><mrow id="S3.E1.m1.7.7.7.7.1.1.1" xref="S3.E1.m1.7.7.7.7.1.1.2.cmml"><mrow id="S3.E1.m1.7.7.7.7.1.1.1.1" xref="S3.E1.m1.7.7.7.7.1.1.1.1.cmml"><mi id="S3.E1.m1.7.7.7.7.1.1.1.1.2" xref="S3.E1.m1.7.7.7.7.1.1.1.1.2.cmml">ε</mi><mo id="S3.E1.m1.7.7.7.7.1.1.1.1.1" xref="S3.E1.m1.7.7.7.7.1.1.1.1.1.cmml">⁢</mo><mrow id="S3.E1.m1.7.7.7.7.1.1.1.1.3.2" xref="S3.E1.m1.7.7.7.7.1.1.1.1.cmml"><mo id="S3.E1.m1.7.7.7.7.1.1.1.1.3.2.1" stretchy="false" xref="S3.E1.m1.7.7.7.7.1.1.1.1.cmml">(</mo><mi id="S3.E1.m1.1.1.1.1" xref="S3.E1.m1.1.1.1.1.cmml">x</mi><mo id="S3.E1.m1.7.7.7.7.1.1.1.1.3.2.2" stretchy="false" xref="S3.E1.m1.7.7.7.7.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S3.E1.m1.7.7.7.7.1.1.1.2" xref="S3.E1.m1.7.7.7.7.1.1.2.cmml">,</mo><mi id="S3.E1.m1.4.4.4.4" xref="S3.E1.m1.4.4.4.4.cmml">c</mi><mo id="S3.E1.m1.7.7.7.7.1.1.1.3" xref="S3.E1.m1.7.7.7.7.1.1.2.cmml">,</mo><mi id="S3.E1.m1.5.5.5.5" xref="S3.E1.m1.5.5.5.5.cmml">ϵ</mi></mrow><mo id="S3.E1.m1.7.7.7.7.1.2" xref="S3.E1.m1.7.7.7.7.1.2.cmml">∼</mo><mrow id="S3.E1.m1.7.7.7.7.1.3" xref="S3.E1.m1.7.7.7.7.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S3.E1.m1.7.7.7.7.1.3.2" xref="S3.E1.m1.7.7.7.7.1.3.2.cmml">𝒩</mi><mo id="S3.E1.m1.7.7.7.7.1.3.1" xref="S3.E1.m1.7.7.7.7.1.3.1.cmml">⁢</mo><mrow id="S3.E1.m1.7.7.7.7.1.3.3.2" xref="S3.E1.m1.7.7.7.7.1.3.3.1.cmml"><mo id="S3.E1.m1.7.7.7.7.1.3.3.2.1" stretchy="false" xref="S3.E1.m1.7.7.7.7.1.3.3.1.cmml">(</mo><mn id="S3.E1.m1.2.2.2.2" xref="S3.E1.m1.2.2.2.2.cmml">0</mn><mo id="S3.E1.m1.7.7.7.7.1.3.3.2.2" xref="S3.E1.m1.7.7.7.7.1.3.3.1.cmml">,</mo><mn id="S3.E1.m1.3.3.3.3" xref="S3.E1.m1.3.3.3.3.cmml">1</mn><mo id="S3.E1.m1.7.7.7.7.1.3.3.2.3" stretchy="false" xref="S3.E1.m1.7.7.7.7.1.3.3.1.cmml">)</mo></mrow></mrow></mrow><mo id="S3.E1.m1.7.7.7.7.2" xref="S3.E1.m1.7.7.7.8a.cmml">,</mo><mi id="S3.E1.m1.6.6.6.6" xref="S3.E1.m1.6.6.6.6.cmml">t</mi></mrow></msub><mo id="S3.E1.m1.10.10.1.2" xref="S3.E1.m1.10.10.1.2.cmml">⁢</mo><mrow id="S3.E1.m1.10.10.1.1.1" xref="S3.E1.m1.10.10.1.1.2.cmml"><mo id="S3.E1.m1.10.10.1.1.1.2" xref="S3.E1.m1.10.10.1.1.2.1.cmml">[</mo><msubsup id="S3.E1.m1.10.10.1.1.1.1" xref="S3.E1.m1.10.10.1.1.1.1.cmml"><mrow id="S3.E1.m1.10.10.1.1.1.1.1.1.1" xref="S3.E1.m1.10.10.1.1.1.1.1.1.2.cmml"><mo id="S3.E1.m1.10.10.1.1.1.1.1.1.1.2" xref="S3.E1.m1.10.10.1.1.1.1.1.1.2.1.cmml">‖</mo><mrow id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.cmml"><mi id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.3" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.3.cmml">ϵ</mi><mo id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.2" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.2.cmml">−</mo><mrow id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.cmml"><msub id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3.cmml"><mi id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3.2" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3.2.cmml">ϵ</mi><mi id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3.3" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3.3.cmml">θ</mi></msub><mo id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.2" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.2.cmml">⁢</mo><mrow id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.2.cmml"><mo id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.2" stretchy="false" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.2.cmml">(</mo><msub id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1.cmml"><mi id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1.2" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml">z</mi><mi id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1.3" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1.3.cmml">t</mi></msub><mo id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.3" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.2.cmml">,</mo><mi id="S3.E1.m1.8.8" xref="S3.E1.m1.8.8.cmml">t</mi><mo id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.4" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.2.cmml">,</mo><mi id="S3.E1.m1.9.9" xref="S3.E1.m1.9.9.cmml">c</mi><mo id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.5" stretchy="false" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.2.cmml">)</mo></mrow></mrow></mrow><mo id="S3.E1.m1.10.10.1.1.1.1.1.1.1.3" xref="S3.E1.m1.10.10.1.1.1.1.1.1.2.1.cmml">‖</mo></mrow><mn id="S3.E1.m1.10.10.1.1.1.1.1.3" xref="S3.E1.m1.10.10.1.1.1.1.1.3.cmml">2</mn><mn id="S3.E1.m1.10.10.1.1.1.1.3" xref="S3.E1.m1.10.10.1.1.1.1.3.cmml">2</mn></msubsup><mo id="S3.E1.m1.10.10.1.1.1.3" xref="S3.E1.m1.10.10.1.1.2.1.cmml">]</mo></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.E1.m1.10b"><apply id="S3.E1.m1.10.10.cmml" xref="S3.E1.m1.10.10"><eq id="S3.E1.m1.10.10.2.cmml" xref="S3.E1.m1.10.10.2"></eq><apply id="S3.E1.m1.10.10.3.cmml" xref="S3.E1.m1.10.10.3"><csymbol cd="ambiguous" id="S3.E1.m1.10.10.3.1.cmml" xref="S3.E1.m1.10.10.3">subscript</csymbol><ci id="S3.E1.m1.10.10.3.2.cmml" xref="S3.E1.m1.10.10.3.2">ℒ</ci><apply id="S3.E1.m1.10.10.3.3.cmml" xref="S3.E1.m1.10.10.3.3"><times id="S3.E1.m1.10.10.3.3.1.cmml" xref="S3.E1.m1.10.10.3.3.1"></times><ci id="S3.E1.m1.10.10.3.3.2.cmml" xref="S3.E1.m1.10.10.3.3.2">𝑆</ci><ci id="S3.E1.m1.10.10.3.3.3.cmml" xref="S3.E1.m1.10.10.3.3.3">𝐷</ci></apply></apply><apply id="S3.E1.m1.10.10.1.cmml" xref="S3.E1.m1.10.10.1"><times id="S3.E1.m1.10.10.1.2.cmml" xref="S3.E1.m1.10.10.1.2"></times><apply id="S3.E1.m1.10.10.1.3.cmml" xref="S3.E1.m1.10.10.1.3"><csymbol cd="ambiguous" id="S3.E1.m1.10.10.1.3.1.cmml" xref="S3.E1.m1.10.10.1.3">subscript</csymbol><ci id="S3.E1.m1.10.10.1.3.2.cmml" xref="S3.E1.m1.10.10.1.3.2">𝔼</ci><apply id="S3.E1.m1.7.7.7.8.cmml" xref="S3.E1.m1.7.7.7.7"><csymbol cd="ambiguous" id="S3.E1.m1.7.7.7.8a.cmml" xref="S3.E1.m1.7.7.7.7.2">formulae-sequence</csymbol><apply id="S3.E1.m1.7.7.7.7.1.cmml" xref="S3.E1.m1.7.7.7.7.1"><csymbol cd="latexml" id="S3.E1.m1.7.7.7.7.1.2.cmml" xref="S3.E1.m1.7.7.7.7.1.2">similar-to</csymbol><list id="S3.E1.m1.7.7.7.7.1.1.2.cmml" xref="S3.E1.m1.7.7.7.7.1.1.1"><apply id="S3.E1.m1.7.7.7.7.1.1.1.1.cmml" xref="S3.E1.m1.7.7.7.7.1.1.1.1"><times id="S3.E1.m1.7.7.7.7.1.1.1.1.1.cmml" xref="S3.E1.m1.7.7.7.7.1.1.1.1.1"></times><ci id="S3.E1.m1.7.7.7.7.1.1.1.1.2.cmml" xref="S3.E1.m1.7.7.7.7.1.1.1.1.2">𝜀</ci><ci id="S3.E1.m1.1.1.1.1.cmml" xref="S3.E1.m1.1.1.1.1">𝑥</ci></apply><ci id="S3.E1.m1.4.4.4.4.cmml" xref="S3.E1.m1.4.4.4.4">𝑐</ci><ci id="S3.E1.m1.5.5.5.5.cmml" xref="S3.E1.m1.5.5.5.5">italic-ϵ</ci></list><apply id="S3.E1.m1.7.7.7.7.1.3.cmml" xref="S3.E1.m1.7.7.7.7.1.3"><times id="S3.E1.m1.7.7.7.7.1.3.1.cmml" xref="S3.E1.m1.7.7.7.7.1.3.1"></times><ci id="S3.E1.m1.7.7.7.7.1.3.2.cmml" xref="S3.E1.m1.7.7.7.7.1.3.2">𝒩</ci><interval closure="open" id="S3.E1.m1.7.7.7.7.1.3.3.1.cmml" xref="S3.E1.m1.7.7.7.7.1.3.3.2"><cn id="S3.E1.m1.2.2.2.2.cmml" type="integer" xref="S3.E1.m1.2.2.2.2">0</cn><cn id="S3.E1.m1.3.3.3.3.cmml" type="integer" xref="S3.E1.m1.3.3.3.3">1</cn></interval></apply></apply><ci id="S3.E1.m1.6.6.6.6.cmml" xref="S3.E1.m1.6.6.6.6">𝑡</ci></apply></apply><apply id="S3.E1.m1.10.10.1.1.2.cmml" xref="S3.E1.m1.10.10.1.1.1"><csymbol cd="latexml" id="S3.E1.m1.10.10.1.1.2.1.cmml" xref="S3.E1.m1.10.10.1.1.1.2">delimited-[]</csymbol><apply id="S3.E1.m1.10.10.1.1.1.1.cmml" xref="S3.E1.m1.10.10.1.1.1.1"><csymbol cd="ambiguous" id="S3.E1.m1.10.10.1.1.1.1.2.cmml" xref="S3.E1.m1.10.10.1.1.1.1">superscript</csymbol><apply id="S3.E1.m1.10.10.1.1.1.1.1.cmml" xref="S3.E1.m1.10.10.1.1.1.1"><csymbol cd="ambiguous" id="S3.E1.m1.10.10.1.1.1.1.1.2.cmml" xref="S3.E1.m1.10.10.1.1.1.1">subscript</csymbol><apply id="S3.E1.m1.10.10.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1"><csymbol cd="latexml" id="S3.E1.m1.10.10.1.1.1.1.1.1.2.1.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.2">norm</csymbol><apply id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1"><minus id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.2"></minus><ci id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.3.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.3">italic-ϵ</ci><apply id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1"><times id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.2"></times><apply id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3"><csymbol cd="ambiguous" id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3.1.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3">subscript</csymbol><ci id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3.2.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3.2">italic-ϵ</ci><ci id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3.3.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.3.3">𝜃</ci></apply><vector id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1"><apply id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1">subscript</csymbol><ci id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1.2">𝑧</ci><ci id="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1.3.cmml" xref="S3.E1.m1.10.10.1.1.1.1.1.1.1.1.1.1.1.1.3">𝑡</ci></apply><ci id="S3.E1.m1.8.8.cmml" xref="S3.E1.m1.8.8">𝑡</ci><ci id="S3.E1.m1.9.9.cmml" xref="S3.E1.m1.9.9">𝑐</ci></vector></apply></apply></apply><cn id="S3.E1.m1.10.10.1.1.1.1.1.3.cmml" type="integer" xref="S3.E1.m1.10.10.1.1.1.1.1.3">2</cn></apply><cn id="S3.E1.m1.10.10.1.1.1.1.3.cmml" type="integer" xref="S3.E1.m1.10.10.1.1.1.1.3">2</cn></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.E1.m1.10c">\mathcal{L}_{SD}=\mathbb{E}_{\varepsilon(x),c,\epsilon\sim\mathcal{N}(0,1),t}%
\left[\left\|\epsilon-\epsilon_{\theta}(z_{t},t,c)\right\|_{2}^{2}\right]</annotation><annotation encoding="application/x-llamapun" id="S3.E1.m1.10d">caligraphic_L start_POSTSUBSCRIPT italic_S italic_D end_POSTSUBSCRIPT = blackboard_E start_POSTSUBSCRIPT italic_ε ( italic_x ) , italic_c , italic_ϵ ∼ caligraphic_N ( 0 , 1 ) , italic_t end_POSTSUBSCRIPT [ ∥ italic_ϵ - italic_ϵ start_POSTSUBSCRIPT italic_θ end_POSTSUBSCRIPT ( italic_z start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT , italic_t , italic_c ) ∥ start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT 2 end_POSTSUPERSCRIPT ]</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(1)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S3.SS1.p1.17">During inference, a random noise <math alttext="z_{t}" class="ltx_Math" display="inline" id="S3.SS1.p1.14.m1.1"><semantics id="S3.SS1.p1.14.m1.1a"><msub id="S3.SS1.p1.14.m1.1.1" xref="S3.SS1.p1.14.m1.1.1.cmml"><mi id="S3.SS1.p1.14.m1.1.1.2" xref="S3.SS1.p1.14.m1.1.1.2.cmml">z</mi><mi id="S3.SS1.p1.14.m1.1.1.3" xref="S3.SS1.p1.14.m1.1.1.3.cmml">t</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.14.m1.1b"><apply id="S3.SS1.p1.14.m1.1.1.cmml" xref="S3.SS1.p1.14.m1.1.1"><csymbol cd="ambiguous" id="S3.SS1.p1.14.m1.1.1.1.cmml" xref="S3.SS1.p1.14.m1.1.1">subscript</csymbol><ci id="S3.SS1.p1.14.m1.1.1.2.cmml" xref="S3.SS1.p1.14.m1.1.1.2">𝑧</ci><ci id="S3.SS1.p1.14.m1.1.1.3.cmml" xref="S3.SS1.p1.14.m1.1.1.3">𝑡</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.14.m1.1c">z_{t}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.14.m1.1d">italic_z start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT</annotation></semantics></math> is drawn from Gaussian noise and iteratively denoised by the U-Net to yeild the initial latent representation <math alttext="\hat{z_{0}}" class="ltx_Math" display="inline" id="S3.SS1.p1.15.m2.1"><semantics id="S3.SS1.p1.15.m2.1a"><mover accent="true" id="S3.SS1.p1.15.m2.1.1" xref="S3.SS1.p1.15.m2.1.1.cmml"><msub id="S3.SS1.p1.15.m2.1.1.2" xref="S3.SS1.p1.15.m2.1.1.2.cmml"><mi id="S3.SS1.p1.15.m2.1.1.2.2" xref="S3.SS1.p1.15.m2.1.1.2.2.cmml">z</mi><mn id="S3.SS1.p1.15.m2.1.1.2.3" xref="S3.SS1.p1.15.m2.1.1.2.3.cmml">0</mn></msub><mo id="S3.SS1.p1.15.m2.1.1.1" xref="S3.SS1.p1.15.m2.1.1.1.cmml">^</mo></mover><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.15.m2.1b"><apply id="S3.SS1.p1.15.m2.1.1.cmml" xref="S3.SS1.p1.15.m2.1.1"><ci id="S3.SS1.p1.15.m2.1.1.1.cmml" xref="S3.SS1.p1.15.m2.1.1.1">^</ci><apply id="S3.SS1.p1.15.m2.1.1.2.cmml" xref="S3.SS1.p1.15.m2.1.1.2"><csymbol cd="ambiguous" id="S3.SS1.p1.15.m2.1.1.2.1.cmml" xref="S3.SS1.p1.15.m2.1.1.2">subscript</csymbol><ci id="S3.SS1.p1.15.m2.1.1.2.2.cmml" xref="S3.SS1.p1.15.m2.1.1.2.2">𝑧</ci><cn id="S3.SS1.p1.15.m2.1.1.2.3.cmml" type="integer" xref="S3.SS1.p1.15.m2.1.1.2.3">0</cn></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.15.m2.1c">\hat{z_{0}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.15.m2.1d">over^ start_ARG italic_z start_POSTSUBSCRIPT 0 end_POSTSUBSCRIPT end_ARG</annotation></semantics></math>. Subsequently, the VAE
decoder <math alttext="D" class="ltx_Math" display="inline" id="S3.SS1.p1.16.m3.1"><semantics id="S3.SS1.p1.16.m3.1a"><mi id="S3.SS1.p1.16.m3.1.1" xref="S3.SS1.p1.16.m3.1.1.cmml">D</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.16.m3.1b"><ci id="S3.SS1.p1.16.m3.1.1.cmml" xref="S3.SS1.p1.16.m3.1.1">𝐷</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.16.m3.1c">D</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.16.m3.1d">italic_D</annotation></semantics></math> converts the initial latent into the pixel space as <math alttext="\hat{x}=D(\hat{z_{0}})" class="ltx_Math" display="inline" id="S3.SS1.p1.17.m4.1"><semantics id="S3.SS1.p1.17.m4.1a"><mrow id="S3.SS1.p1.17.m4.1.2" xref="S3.SS1.p1.17.m4.1.2.cmml"><mover accent="true" id="S3.SS1.p1.17.m4.1.2.2" xref="S3.SS1.p1.17.m4.1.2.2.cmml"><mi id="S3.SS1.p1.17.m4.1.2.2.2" xref="S3.SS1.p1.17.m4.1.2.2.2.cmml">x</mi><mo id="S3.SS1.p1.17.m4.1.2.2.1" xref="S3.SS1.p1.17.m4.1.2.2.1.cmml">^</mo></mover><mo id="S3.SS1.p1.17.m4.1.2.1" xref="S3.SS1.p1.17.m4.1.2.1.cmml">=</mo><mrow id="S3.SS1.p1.17.m4.1.2.3" xref="S3.SS1.p1.17.m4.1.2.3.cmml"><mi id="S3.SS1.p1.17.m4.1.2.3.2" xref="S3.SS1.p1.17.m4.1.2.3.2.cmml">D</mi><mo id="S3.SS1.p1.17.m4.1.2.3.1" xref="S3.SS1.p1.17.m4.1.2.3.1.cmml">⁢</mo><mrow id="S3.SS1.p1.17.m4.1.2.3.3.2" xref="S3.SS1.p1.17.m4.1.1.cmml"><mo id="S3.SS1.p1.17.m4.1.2.3.3.2.1" stretchy="false" xref="S3.SS1.p1.17.m4.1.1.cmml">(</mo><mover accent="true" id="S3.SS1.p1.17.m4.1.1" xref="S3.SS1.p1.17.m4.1.1.cmml"><msub id="S3.SS1.p1.17.m4.1.1.2" xref="S3.SS1.p1.17.m4.1.1.2.cmml"><mi id="S3.SS1.p1.17.m4.1.1.2.2" xref="S3.SS1.p1.17.m4.1.1.2.2.cmml">z</mi><mn id="S3.SS1.p1.17.m4.1.1.2.3" xref="S3.SS1.p1.17.m4.1.1.2.3.cmml">0</mn></msub><mo id="S3.SS1.p1.17.m4.1.1.1" xref="S3.SS1.p1.17.m4.1.1.1.cmml">^</mo></mover><mo id="S3.SS1.p1.17.m4.1.2.3.3.2.2" stretchy="false" xref="S3.SS1.p1.17.m4.1.1.cmml">)</mo></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.17.m4.1b"><apply id="S3.SS1.p1.17.m4.1.2.cmml" xref="S3.SS1.p1.17.m4.1.2"><eq id="S3.SS1.p1.17.m4.1.2.1.cmml" xref="S3.SS1.p1.17.m4.1.2.1"></eq><apply id="S3.SS1.p1.17.m4.1.2.2.cmml" xref="S3.SS1.p1.17.m4.1.2.2"><ci id="S3.SS1.p1.17.m4.1.2.2.1.cmml" xref="S3.SS1.p1.17.m4.1.2.2.1">^</ci><ci id="S3.SS1.p1.17.m4.1.2.2.2.cmml" xref="S3.SS1.p1.17.m4.1.2.2.2">𝑥</ci></apply><apply id="S3.SS1.p1.17.m4.1.2.3.cmml" xref="S3.SS1.p1.17.m4.1.2.3"><times id="S3.SS1.p1.17.m4.1.2.3.1.cmml" xref="S3.SS1.p1.17.m4.1.2.3.1"></times><ci id="S3.SS1.p1.17.m4.1.2.3.2.cmml" xref="S3.SS1.p1.17.m4.1.2.3.2">𝐷</ci><apply id="S3.SS1.p1.17.m4.1.1.cmml" xref="S3.SS1.p1.17.m4.1.2.3.3.2"><ci id="S3.SS1.p1.17.m4.1.1.1.cmml" xref="S3.SS1.p1.17.m4.1.1.1">^</ci><apply id="S3.SS1.p1.17.m4.1.1.2.cmml" xref="S3.SS1.p1.17.m4.1.1.2"><csymbol cd="ambiguous" id="S3.SS1.p1.17.m4.1.1.2.1.cmml" xref="S3.SS1.p1.17.m4.1.1.2">subscript</csymbol><ci id="S3.SS1.p1.17.m4.1.1.2.2.cmml" xref="S3.SS1.p1.17.m4.1.1.2.2">𝑧</ci><cn id="S3.SS1.p1.17.m4.1.1.2.3.cmml" type="integer" xref="S3.SS1.p1.17.m4.1.1.2.3">0</cn></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.17.m4.1c">\hat{x}=D(\hat{z_{0}})</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.17.m4.1d">over^ start_ARG italic_x end_ARG = italic_D ( over^ start_ARG italic_z start_POSTSUBSCRIPT 0 end_POSTSUBSCRIPT end_ARG )</annotation></semantics></math>.</p>
</div>
</section>
<section class="ltx_subsection" id="S3.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">3.2 </span>IP-Adapter</h3>
<div class="ltx_para ltx_noindent" id="S3.SS2.p1">
<p class="ltx_p" id="S3.SS2.p1.3">IP-Adapter <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite> introduces an image prompt adapter that allows the diffusion model to generate images conditioned on an image prompt. The method comprises two components: an image encoder to extract features from the reference image, and an adapter module with decoupled cross-attention layers to integrate these image features into the pre-trained text-to-image model. Specifically, in the original cross-attention layer of the diffusion model, given the query features <math alttext="Z" class="ltx_Math" display="inline" id="S3.SS2.p1.1.m1.1"><semantics id="S3.SS2.p1.1.m1.1a"><mi id="S3.SS2.p1.1.m1.1.1" xref="S3.SS2.p1.1.m1.1.1.cmml">Z</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.1.m1.1b"><ci id="S3.SS2.p1.1.m1.1.1.cmml" xref="S3.SS2.p1.1.m1.1.1">𝑍</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.1.m1.1c">Z</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.1.m1.1d">italic_Z</annotation></semantics></math> and text features <math alttext="c_{t}" class="ltx_Math" display="inline" id="S3.SS2.p1.2.m2.1"><semantics id="S3.SS2.p1.2.m2.1a"><msub id="S3.SS2.p1.2.m2.1.1" xref="S3.SS2.p1.2.m2.1.1.cmml"><mi id="S3.SS2.p1.2.m2.1.1.2" xref="S3.SS2.p1.2.m2.1.1.2.cmml">c</mi><mi id="S3.SS2.p1.2.m2.1.1.3" xref="S3.SS2.p1.2.m2.1.1.3.cmml">t</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.2.m2.1b"><apply id="S3.SS2.p1.2.m2.1.1.cmml" xref="S3.SS2.p1.2.m2.1.1"><csymbol cd="ambiguous" id="S3.SS2.p1.2.m2.1.1.1.cmml" xref="S3.SS2.p1.2.m2.1.1">subscript</csymbol><ci id="S3.SS2.p1.2.m2.1.1.2.cmml" xref="S3.SS2.p1.2.m2.1.1.2">𝑐</ci><ci id="S3.SS2.p1.2.m2.1.1.3.cmml" xref="S3.SS2.p1.2.m2.1.1.3">𝑡</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.2.m2.1c">c_{t}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.2.m2.1d">italic_c start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT</annotation></semantics></math>, the output of cross-attention <math alttext="Z_{t}" class="ltx_Math" display="inline" id="S3.SS2.p1.3.m3.1"><semantics id="S3.SS2.p1.3.m3.1a"><msub id="S3.SS2.p1.3.m3.1.1" xref="S3.SS2.p1.3.m3.1.1.cmml"><mi id="S3.SS2.p1.3.m3.1.1.2" xref="S3.SS2.p1.3.m3.1.1.2.cmml">Z</mi><mi id="S3.SS2.p1.3.m3.1.1.3" xref="S3.SS2.p1.3.m3.1.1.3.cmml">t</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.3.m3.1b"><apply id="S3.SS2.p1.3.m3.1.1.cmml" xref="S3.SS2.p1.3.m3.1.1"><csymbol cd="ambiguous" id="S3.SS2.p1.3.m3.1.1.1.cmml" xref="S3.SS2.p1.3.m3.1.1">subscript</csymbol><ci id="S3.SS2.p1.3.m3.1.1.2.cmml" xref="S3.SS2.p1.3.m3.1.1.2">𝑍</ci><ci id="S3.SS2.p1.3.m3.1.1.3.cmml" xref="S3.SS2.p1.3.m3.1.1.3">𝑡</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.3.m3.1c">Z_{t}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.3.m3.1d">italic_Z start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT</annotation></semantics></math> is defined by the following equation:</p>
<table class="ltx_equation ltx_eqn_table" id="S3.E2">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="Z_{t}=Attention(Q,K_{t},V_{t})=Softmax(\frac{QK_{t}^{T}}{\sqrt{d}})V_{t}," class="ltx_Math" display="block" id="S3.E2.m1.3"><semantics id="S3.E2.m1.3a"><mrow id="S3.E2.m1.3.3.1" xref="S3.E2.m1.3.3.1.1.cmml"><mrow id="S3.E2.m1.3.3.1.1" xref="S3.E2.m1.3.3.1.1.cmml"><msub id="S3.E2.m1.3.3.1.1.4" xref="S3.E2.m1.3.3.1.1.4.cmml"><mi id="S3.E2.m1.3.3.1.1.4.2" xref="S3.E2.m1.3.3.1.1.4.2.cmml">Z</mi><mi id="S3.E2.m1.3.3.1.1.4.3" xref="S3.E2.m1.3.3.1.1.4.3.cmml">t</mi></msub><mo id="S3.E2.m1.3.3.1.1.5" xref="S3.E2.m1.3.3.1.1.5.cmml">=</mo><mrow id="S3.E2.m1.3.3.1.1.2" xref="S3.E2.m1.3.3.1.1.2.cmml"><mi id="S3.E2.m1.3.3.1.1.2.4" xref="S3.E2.m1.3.3.1.1.2.4.cmml">A</mi><mo id="S3.E2.m1.3.3.1.1.2.3" xref="S3.E2.m1.3.3.1.1.2.3.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.2.5" xref="S3.E2.m1.3.3.1.1.2.5.cmml">t</mi><mo id="S3.E2.m1.3.3.1.1.2.3a" xref="S3.E2.m1.3.3.1.1.2.3.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.2.6" xref="S3.E2.m1.3.3.1.1.2.6.cmml">t</mi><mo id="S3.E2.m1.3.3.1.1.2.3b" xref="S3.E2.m1.3.3.1.1.2.3.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.2.7" xref="S3.E2.m1.3.3.1.1.2.7.cmml">e</mi><mo id="S3.E2.m1.3.3.1.1.2.3c" xref="S3.E2.m1.3.3.1.1.2.3.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.2.8" xref="S3.E2.m1.3.3.1.1.2.8.cmml">n</mi><mo id="S3.E2.m1.3.3.1.1.2.3d" xref="S3.E2.m1.3.3.1.1.2.3.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.2.9" xref="S3.E2.m1.3.3.1.1.2.9.cmml">t</mi><mo id="S3.E2.m1.3.3.1.1.2.3e" xref="S3.E2.m1.3.3.1.1.2.3.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.2.10" xref="S3.E2.m1.3.3.1.1.2.10.cmml">i</mi><mo id="S3.E2.m1.3.3.1.1.2.3f" xref="S3.E2.m1.3.3.1.1.2.3.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.2.11" xref="S3.E2.m1.3.3.1.1.2.11.cmml">o</mi><mo id="S3.E2.m1.3.3.1.1.2.3g" xref="S3.E2.m1.3.3.1.1.2.3.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.2.12" xref="S3.E2.m1.3.3.1.1.2.12.cmml">n</mi><mo id="S3.E2.m1.3.3.1.1.2.3h" xref="S3.E2.m1.3.3.1.1.2.3.cmml">⁢</mo><mrow id="S3.E2.m1.3.3.1.1.2.2.2" xref="S3.E2.m1.3.3.1.1.2.2.3.cmml"><mo id="S3.E2.m1.3.3.1.1.2.2.2.3" stretchy="false" xref="S3.E2.m1.3.3.1.1.2.2.3.cmml">(</mo><mi id="S3.E2.m1.1.1" xref="S3.E2.m1.1.1.cmml">Q</mi><mo id="S3.E2.m1.3.3.1.1.2.2.2.4" xref="S3.E2.m1.3.3.1.1.2.2.3.cmml">,</mo><msub id="S3.E2.m1.3.3.1.1.1.1.1.1" xref="S3.E2.m1.3.3.1.1.1.1.1.1.cmml"><mi id="S3.E2.m1.3.3.1.1.1.1.1.1.2" xref="S3.E2.m1.3.3.1.1.1.1.1.1.2.cmml">K</mi><mi id="S3.E2.m1.3.3.1.1.1.1.1.1.3" xref="S3.E2.m1.3.3.1.1.1.1.1.1.3.cmml">t</mi></msub><mo id="S3.E2.m1.3.3.1.1.2.2.2.5" xref="S3.E2.m1.3.3.1.1.2.2.3.cmml">,</mo><msub id="S3.E2.m1.3.3.1.1.2.2.2.2" xref="S3.E2.m1.3.3.1.1.2.2.2.2.cmml"><mi id="S3.E2.m1.3.3.1.1.2.2.2.2.2" xref="S3.E2.m1.3.3.1.1.2.2.2.2.2.cmml">V</mi><mi id="S3.E2.m1.3.3.1.1.2.2.2.2.3" xref="S3.E2.m1.3.3.1.1.2.2.2.2.3.cmml">t</mi></msub><mo id="S3.E2.m1.3.3.1.1.2.2.2.6" stretchy="false" xref="S3.E2.m1.3.3.1.1.2.2.3.cmml">)</mo></mrow></mrow><mo id="S3.E2.m1.3.3.1.1.6" xref="S3.E2.m1.3.3.1.1.6.cmml">=</mo><mrow id="S3.E2.m1.3.3.1.1.7" xref="S3.E2.m1.3.3.1.1.7.cmml"><mi id="S3.E2.m1.3.3.1.1.7.2" xref="S3.E2.m1.3.3.1.1.7.2.cmml">S</mi><mo id="S3.E2.m1.3.3.1.1.7.1" xref="S3.E2.m1.3.3.1.1.7.1.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.7.3" xref="S3.E2.m1.3.3.1.1.7.3.cmml">o</mi><mo id="S3.E2.m1.3.3.1.1.7.1a" xref="S3.E2.m1.3.3.1.1.7.1.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.7.4" xref="S3.E2.m1.3.3.1.1.7.4.cmml">f</mi><mo id="S3.E2.m1.3.3.1.1.7.1b" xref="S3.E2.m1.3.3.1.1.7.1.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.7.5" xref="S3.E2.m1.3.3.1.1.7.5.cmml">t</mi><mo id="S3.E2.m1.3.3.1.1.7.1c" xref="S3.E2.m1.3.3.1.1.7.1.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.7.6" xref="S3.E2.m1.3.3.1.1.7.6.cmml">m</mi><mo id="S3.E2.m1.3.3.1.1.7.1d" xref="S3.E2.m1.3.3.1.1.7.1.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.7.7" xref="S3.E2.m1.3.3.1.1.7.7.cmml">a</mi><mo id="S3.E2.m1.3.3.1.1.7.1e" xref="S3.E2.m1.3.3.1.1.7.1.cmml">⁢</mo><mi id="S3.E2.m1.3.3.1.1.7.8" xref="S3.E2.m1.3.3.1.1.7.8.cmml">x</mi><mo id="S3.E2.m1.3.3.1.1.7.1f" xref="S3.E2.m1.3.3.1.1.7.1.cmml">⁢</mo><mrow id="S3.E2.m1.3.3.1.1.7.9.2" xref="S3.E2.m1.2.2.cmml"><mo id="S3.E2.m1.3.3.1.1.7.9.2.1" stretchy="false" xref="S3.E2.m1.2.2.cmml">(</mo><mfrac id="S3.E2.m1.2.2" xref="S3.E2.m1.2.2.cmml"><mrow id="S3.E2.m1.2.2.2" xref="S3.E2.m1.2.2.2.cmml"><mi id="S3.E2.m1.2.2.2.2" xref="S3.E2.m1.2.2.2.2.cmml">Q</mi><mo id="S3.E2.m1.2.2.2.1" xref="S3.E2.m1.2.2.2.1.cmml">⁢</mo><msubsup id="S3.E2.m1.2.2.2.3" xref="S3.E2.m1.2.2.2.3.cmml"><mi id="S3.E2.m1.2.2.2.3.2.2" xref="S3.E2.m1.2.2.2.3.2.2.cmml">K</mi><mi id="S3.E2.m1.2.2.2.3.2.3" xref="S3.E2.m1.2.2.2.3.2.3.cmml">t</mi><mi id="S3.E2.m1.2.2.2.3.3" xref="S3.E2.m1.2.2.2.3.3.cmml">T</mi></msubsup></mrow><msqrt id="S3.E2.m1.2.2.3" xref="S3.E2.m1.2.2.3.cmml"><mi id="S3.E2.m1.2.2.3.2" xref="S3.E2.m1.2.2.3.2.cmml">d</mi></msqrt></mfrac><mo id="S3.E2.m1.3.3.1.1.7.9.2.2" stretchy="false" xref="S3.E2.m1.2.2.cmml">)</mo></mrow><mo id="S3.E2.m1.3.3.1.1.7.1g" xref="S3.E2.m1.3.3.1.1.7.1.cmml">⁢</mo><msub id="S3.E2.m1.3.3.1.1.7.10" xref="S3.E2.m1.3.3.1.1.7.10.cmml"><mi id="S3.E2.m1.3.3.1.1.7.10.2" xref="S3.E2.m1.3.3.1.1.7.10.2.cmml">V</mi><mi id="S3.E2.m1.3.3.1.1.7.10.3" xref="S3.E2.m1.3.3.1.1.7.10.3.cmml">t</mi></msub></mrow></mrow><mo id="S3.E2.m1.3.3.1.2" xref="S3.E2.m1.3.3.1.1.cmml">,</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.E2.m1.3b"><apply id="S3.E2.m1.3.3.1.1.cmml" xref="S3.E2.m1.3.3.1"><and id="S3.E2.m1.3.3.1.1a.cmml" xref="S3.E2.m1.3.3.1"></and><apply id="S3.E2.m1.3.3.1.1b.cmml" xref="S3.E2.m1.3.3.1"><eq id="S3.E2.m1.3.3.1.1.5.cmml" xref="S3.E2.m1.3.3.1.1.5"></eq><apply id="S3.E2.m1.3.3.1.1.4.cmml" xref="S3.E2.m1.3.3.1.1.4"><csymbol cd="ambiguous" id="S3.E2.m1.3.3.1.1.4.1.cmml" xref="S3.E2.m1.3.3.1.1.4">subscript</csymbol><ci id="S3.E2.m1.3.3.1.1.4.2.cmml" xref="S3.E2.m1.3.3.1.1.4.2">𝑍</ci><ci id="S3.E2.m1.3.3.1.1.4.3.cmml" xref="S3.E2.m1.3.3.1.1.4.3">𝑡</ci></apply><apply id="S3.E2.m1.3.3.1.1.2.cmml" xref="S3.E2.m1.3.3.1.1.2"><times id="S3.E2.m1.3.3.1.1.2.3.cmml" xref="S3.E2.m1.3.3.1.1.2.3"></times><ci id="S3.E2.m1.3.3.1.1.2.4.cmml" xref="S3.E2.m1.3.3.1.1.2.4">𝐴</ci><ci id="S3.E2.m1.3.3.1.1.2.5.cmml" xref="S3.E2.m1.3.3.1.1.2.5">𝑡</ci><ci id="S3.E2.m1.3.3.1.1.2.6.cmml" xref="S3.E2.m1.3.3.1.1.2.6">𝑡</ci><ci id="S3.E2.m1.3.3.1.1.2.7.cmml" xref="S3.E2.m1.3.3.1.1.2.7">𝑒</ci><ci id="S3.E2.m1.3.3.1.1.2.8.cmml" xref="S3.E2.m1.3.3.1.1.2.8">𝑛</ci><ci id="S3.E2.m1.3.3.1.1.2.9.cmml" xref="S3.E2.m1.3.3.1.1.2.9">𝑡</ci><ci id="S3.E2.m1.3.3.1.1.2.10.cmml" xref="S3.E2.m1.3.3.1.1.2.10">𝑖</ci><ci id="S3.E2.m1.3.3.1.1.2.11.cmml" xref="S3.E2.m1.3.3.1.1.2.11">𝑜</ci><ci id="S3.E2.m1.3.3.1.1.2.12.cmml" xref="S3.E2.m1.3.3.1.1.2.12">𝑛</ci><vector id="S3.E2.m1.3.3.1.1.2.2.3.cmml" xref="S3.E2.m1.3.3.1.1.2.2.2"><ci id="S3.E2.m1.1.1.cmml" xref="S3.E2.m1.1.1">𝑄</ci><apply id="S3.E2.m1.3.3.1.1.1.1.1.1.cmml" xref="S3.E2.m1.3.3.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.E2.m1.3.3.1.1.1.1.1.1.1.cmml" xref="S3.E2.m1.3.3.1.1.1.1.1.1">subscript</csymbol><ci id="S3.E2.m1.3.3.1.1.1.1.1.1.2.cmml" xref="S3.E2.m1.3.3.1.1.1.1.1.1.2">𝐾</ci><ci id="S3.E2.m1.3.3.1.1.1.1.1.1.3.cmml" xref="S3.E2.m1.3.3.1.1.1.1.1.1.3">𝑡</ci></apply><apply id="S3.E2.m1.3.3.1.1.2.2.2.2.cmml" xref="S3.E2.m1.3.3.1.1.2.2.2.2"><csymbol cd="ambiguous" id="S3.E2.m1.3.3.1.1.2.2.2.2.1.cmml" xref="S3.E2.m1.3.3.1.1.2.2.2.2">subscript</csymbol><ci id="S3.E2.m1.3.3.1.1.2.2.2.2.2.cmml" xref="S3.E2.m1.3.3.1.1.2.2.2.2.2">𝑉</ci><ci id="S3.E2.m1.3.3.1.1.2.2.2.2.3.cmml" xref="S3.E2.m1.3.3.1.1.2.2.2.2.3">𝑡</ci></apply></vector></apply></apply><apply id="S3.E2.m1.3.3.1.1c.cmml" xref="S3.E2.m1.3.3.1"><eq id="S3.E2.m1.3.3.1.1.6.cmml" xref="S3.E2.m1.3.3.1.1.6"></eq><share href="https://arxiv.org/html/2409.12576v1#S3.E2.m1.3.3.1.1.2.cmml" id="S3.E2.m1.3.3.1.1d.cmml" xref="S3.E2.m1.3.3.1"></share><apply id="S3.E2.m1.3.3.1.1.7.cmml" xref="S3.E2.m1.3.3.1.1.7"><times id="S3.E2.m1.3.3.1.1.7.1.cmml" xref="S3.E2.m1.3.3.1.1.7.1"></times><ci id="S3.E2.m1.3.3.1.1.7.2.cmml" xref="S3.E2.m1.3.3.1.1.7.2">𝑆</ci><ci id="S3.E2.m1.3.3.1.1.7.3.cmml" xref="S3.E2.m1.3.3.1.1.7.3">𝑜</ci><ci id="S3.E2.m1.3.3.1.1.7.4.cmml" xref="S3.E2.m1.3.3.1.1.7.4">𝑓</ci><ci id="S3.E2.m1.3.3.1.1.7.5.cmml" xref="S3.E2.m1.3.3.1.1.7.5">𝑡</ci><ci id="S3.E2.m1.3.3.1.1.7.6.cmml" xref="S3.E2.m1.3.3.1.1.7.6">𝑚</ci><ci id="S3.E2.m1.3.3.1.1.7.7.cmml" xref="S3.E2.m1.3.3.1.1.7.7">𝑎</ci><ci id="S3.E2.m1.3.3.1.1.7.8.cmml" xref="S3.E2.m1.3.3.1.1.7.8">𝑥</ci><apply id="S3.E2.m1.2.2.cmml" xref="S3.E2.m1.3.3.1.1.7.9.2"><divide id="S3.E2.m1.2.2.1.cmml" xref="S3.E2.m1.3.3.1.1.7.9.2"></divide><apply id="S3.E2.m1.2.2.2.cmml" xref="S3.E2.m1.2.2.2"><times id="S3.E2.m1.2.2.2.1.cmml" xref="S3.E2.m1.2.2.2.1"></times><ci id="S3.E2.m1.2.2.2.2.cmml" xref="S3.E2.m1.2.2.2.2">𝑄</ci><apply id="S3.E2.m1.2.2.2.3.cmml" xref="S3.E2.m1.2.2.2.3"><csymbol cd="ambiguous" id="S3.E2.m1.2.2.2.3.1.cmml" xref="S3.E2.m1.2.2.2.3">superscript</csymbol><apply id="S3.E2.m1.2.2.2.3.2.cmml" xref="S3.E2.m1.2.2.2.3"><csymbol cd="ambiguous" id="S3.E2.m1.2.2.2.3.2.1.cmml" xref="S3.E2.m1.2.2.2.3">subscript</csymbol><ci id="S3.E2.m1.2.2.2.3.2.2.cmml" xref="S3.E2.m1.2.2.2.3.2.2">𝐾</ci><ci id="S3.E2.m1.2.2.2.3.2.3.cmml" xref="S3.E2.m1.2.2.2.3.2.3">𝑡</ci></apply><ci id="S3.E2.m1.2.2.2.3.3.cmml" xref="S3.E2.m1.2.2.2.3.3">𝑇</ci></apply></apply><apply id="S3.E2.m1.2.2.3.cmml" xref="S3.E2.m1.2.2.3"><root id="S3.E2.m1.2.2.3a.cmml" xref="S3.E2.m1.2.2.3"></root><ci id="S3.E2.m1.2.2.3.2.cmml" xref="S3.E2.m1.2.2.3.2">𝑑</ci></apply></apply><apply id="S3.E2.m1.3.3.1.1.7.10.cmml" xref="S3.E2.m1.3.3.1.1.7.10"><csymbol cd="ambiguous" id="S3.E2.m1.3.3.1.1.7.10.1.cmml" xref="S3.E2.m1.3.3.1.1.7.10">subscript</csymbol><ci id="S3.E2.m1.3.3.1.1.7.10.2.cmml" xref="S3.E2.m1.3.3.1.1.7.10.2">𝑉</ci><ci id="S3.E2.m1.3.3.1.1.7.10.3.cmml" xref="S3.E2.m1.3.3.1.1.7.10.3">𝑡</ci></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.E2.m1.3c">Z_{t}=Attention(Q,K_{t},V_{t})=Softmax(\frac{QK_{t}^{T}}{\sqrt{d}})V_{t},</annotation><annotation encoding="application/x-llamapun" id="S3.E2.m1.3d">italic_Z start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT = italic_A italic_t italic_t italic_e italic_n italic_t italic_i italic_o italic_n ( italic_Q , italic_K start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT , italic_V start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT ) = italic_S italic_o italic_f italic_t italic_m italic_a italic_x ( divide start_ARG italic_Q italic_K start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_T end_POSTSUPERSCRIPT end_ARG start_ARG square-root start_ARG italic_d end_ARG end_ARG ) italic_V start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(2)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S3.SS2.p1.7">where <math alttext="Q=ZW_{q}" class="ltx_Math" display="inline" id="S3.SS2.p1.4.m1.1"><semantics id="S3.SS2.p1.4.m1.1a"><mrow id="S3.SS2.p1.4.m1.1.1" xref="S3.SS2.p1.4.m1.1.1.cmml"><mi id="S3.SS2.p1.4.m1.1.1.2" xref="S3.SS2.p1.4.m1.1.1.2.cmml">Q</mi><mo id="S3.SS2.p1.4.m1.1.1.1" xref="S3.SS2.p1.4.m1.1.1.1.cmml">=</mo><mrow id="S3.SS2.p1.4.m1.1.1.3" xref="S3.SS2.p1.4.m1.1.1.3.cmml"><mi id="S3.SS2.p1.4.m1.1.1.3.2" xref="S3.SS2.p1.4.m1.1.1.3.2.cmml">Z</mi><mo id="S3.SS2.p1.4.m1.1.1.3.1" xref="S3.SS2.p1.4.m1.1.1.3.1.cmml">⁢</mo><msub id="S3.SS2.p1.4.m1.1.1.3.3" xref="S3.SS2.p1.4.m1.1.1.3.3.cmml"><mi id="S3.SS2.p1.4.m1.1.1.3.3.2" xref="S3.SS2.p1.4.m1.1.1.3.3.2.cmml">W</mi><mi id="S3.SS2.p1.4.m1.1.1.3.3.3" xref="S3.SS2.p1.4.m1.1.1.3.3.3.cmml">q</mi></msub></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.4.m1.1b"><apply id="S3.SS2.p1.4.m1.1.1.cmml" xref="S3.SS2.p1.4.m1.1.1"><eq id="S3.SS2.p1.4.m1.1.1.1.cmml" xref="S3.SS2.p1.4.m1.1.1.1"></eq><ci id="S3.SS2.p1.4.m1.1.1.2.cmml" xref="S3.SS2.p1.4.m1.1.1.2">𝑄</ci><apply id="S3.SS2.p1.4.m1.1.1.3.cmml" xref="S3.SS2.p1.4.m1.1.1.3"><times id="S3.SS2.p1.4.m1.1.1.3.1.cmml" xref="S3.SS2.p1.4.m1.1.1.3.1"></times><ci id="S3.SS2.p1.4.m1.1.1.3.2.cmml" xref="S3.SS2.p1.4.m1.1.1.3.2">𝑍</ci><apply id="S3.SS2.p1.4.m1.1.1.3.3.cmml" xref="S3.SS2.p1.4.m1.1.1.3.3"><csymbol cd="ambiguous" id="S3.SS2.p1.4.m1.1.1.3.3.1.cmml" xref="S3.SS2.p1.4.m1.1.1.3.3">subscript</csymbol><ci id="S3.SS2.p1.4.m1.1.1.3.3.2.cmml" xref="S3.SS2.p1.4.m1.1.1.3.3.2">𝑊</ci><ci id="S3.SS2.p1.4.m1.1.1.3.3.3.cmml" xref="S3.SS2.p1.4.m1.1.1.3.3.3">𝑞</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.4.m1.1c">Q=ZW_{q}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.4.m1.1d">italic_Q = italic_Z italic_W start_POSTSUBSCRIPT italic_q end_POSTSUBSCRIPT</annotation></semantics></math>, <math alttext="K=c_{t}W_{k}^{t}" class="ltx_Math" display="inline" id="S3.SS2.p1.5.m2.1"><semantics id="S3.SS2.p1.5.m2.1a"><mrow id="S3.SS2.p1.5.m2.1.1" xref="S3.SS2.p1.5.m2.1.1.cmml"><mi id="S3.SS2.p1.5.m2.1.1.2" xref="S3.SS2.p1.5.m2.1.1.2.cmml">K</mi><mo id="S3.SS2.p1.5.m2.1.1.1" xref="S3.SS2.p1.5.m2.1.1.1.cmml">=</mo><mrow id="S3.SS2.p1.5.m2.1.1.3" xref="S3.SS2.p1.5.m2.1.1.3.cmml"><msub id="S3.SS2.p1.5.m2.1.1.3.2" xref="S3.SS2.p1.5.m2.1.1.3.2.cmml"><mi id="S3.SS2.p1.5.m2.1.1.3.2.2" xref="S3.SS2.p1.5.m2.1.1.3.2.2.cmml">c</mi><mi id="S3.SS2.p1.5.m2.1.1.3.2.3" xref="S3.SS2.p1.5.m2.1.1.3.2.3.cmml">t</mi></msub><mo id="S3.SS2.p1.5.m2.1.1.3.1" xref="S3.SS2.p1.5.m2.1.1.3.1.cmml">⁢</mo><msubsup id="S3.SS2.p1.5.m2.1.1.3.3" xref="S3.SS2.p1.5.m2.1.1.3.3.cmml"><mi id="S3.SS2.p1.5.m2.1.1.3.3.2.2" xref="S3.SS2.p1.5.m2.1.1.3.3.2.2.cmml">W</mi><mi id="S3.SS2.p1.5.m2.1.1.3.3.2.3" xref="S3.SS2.p1.5.m2.1.1.3.3.2.3.cmml">k</mi><mi id="S3.SS2.p1.5.m2.1.1.3.3.3" xref="S3.SS2.p1.5.m2.1.1.3.3.3.cmml">t</mi></msubsup></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.5.m2.1b"><apply id="S3.SS2.p1.5.m2.1.1.cmml" xref="S3.SS2.p1.5.m2.1.1"><eq id="S3.SS2.p1.5.m2.1.1.1.cmml" xref="S3.SS2.p1.5.m2.1.1.1"></eq><ci id="S3.SS2.p1.5.m2.1.1.2.cmml" xref="S3.SS2.p1.5.m2.1.1.2">𝐾</ci><apply id="S3.SS2.p1.5.m2.1.1.3.cmml" xref="S3.SS2.p1.5.m2.1.1.3"><times id="S3.SS2.p1.5.m2.1.1.3.1.cmml" xref="S3.SS2.p1.5.m2.1.1.3.1"></times><apply id="S3.SS2.p1.5.m2.1.1.3.2.cmml" xref="S3.SS2.p1.5.m2.1.1.3.2"><csymbol cd="ambiguous" id="S3.SS2.p1.5.m2.1.1.3.2.1.cmml" xref="S3.SS2.p1.5.m2.1.1.3.2">subscript</csymbol><ci id="S3.SS2.p1.5.m2.1.1.3.2.2.cmml" xref="S3.SS2.p1.5.m2.1.1.3.2.2">𝑐</ci><ci id="S3.SS2.p1.5.m2.1.1.3.2.3.cmml" xref="S3.SS2.p1.5.m2.1.1.3.2.3">𝑡</ci></apply><apply id="S3.SS2.p1.5.m2.1.1.3.3.cmml" xref="S3.SS2.p1.5.m2.1.1.3.3"><csymbol cd="ambiguous" id="S3.SS2.p1.5.m2.1.1.3.3.1.cmml" xref="S3.SS2.p1.5.m2.1.1.3.3">superscript</csymbol><apply id="S3.SS2.p1.5.m2.1.1.3.3.2.cmml" xref="S3.SS2.p1.5.m2.1.1.3.3"><csymbol cd="ambiguous" id="S3.SS2.p1.5.m2.1.1.3.3.2.1.cmml" xref="S3.SS2.p1.5.m2.1.1.3.3">subscript</csymbol><ci id="S3.SS2.p1.5.m2.1.1.3.3.2.2.cmml" xref="S3.SS2.p1.5.m2.1.1.3.3.2.2">𝑊</ci><ci id="S3.SS2.p1.5.m2.1.1.3.3.2.3.cmml" xref="S3.SS2.p1.5.m2.1.1.3.3.2.3">𝑘</ci></apply><ci id="S3.SS2.p1.5.m2.1.1.3.3.3.cmml" xref="S3.SS2.p1.5.m2.1.1.3.3.3">𝑡</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.5.m2.1c">K=c_{t}W_{k}^{t}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.5.m2.1d">italic_K = italic_c start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT italic_W start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT</annotation></semantics></math>, <math alttext="V=c_{t}W_{v}^{t}" class="ltx_Math" display="inline" id="S3.SS2.p1.6.m3.1"><semantics id="S3.SS2.p1.6.m3.1a"><mrow id="S3.SS2.p1.6.m3.1.1" xref="S3.SS2.p1.6.m3.1.1.cmml"><mi id="S3.SS2.p1.6.m3.1.1.2" xref="S3.SS2.p1.6.m3.1.1.2.cmml">V</mi><mo id="S3.SS2.p1.6.m3.1.1.1" xref="S3.SS2.p1.6.m3.1.1.1.cmml">=</mo><mrow id="S3.SS2.p1.6.m3.1.1.3" xref="S3.SS2.p1.6.m3.1.1.3.cmml"><msub id="S3.SS2.p1.6.m3.1.1.3.2" xref="S3.SS2.p1.6.m3.1.1.3.2.cmml"><mi id="S3.SS2.p1.6.m3.1.1.3.2.2" xref="S3.SS2.p1.6.m3.1.1.3.2.2.cmml">c</mi><mi id="S3.SS2.p1.6.m3.1.1.3.2.3" xref="S3.SS2.p1.6.m3.1.1.3.2.3.cmml">t</mi></msub><mo id="S3.SS2.p1.6.m3.1.1.3.1" xref="S3.SS2.p1.6.m3.1.1.3.1.cmml">⁢</mo><msubsup id="S3.SS2.p1.6.m3.1.1.3.3" xref="S3.SS2.p1.6.m3.1.1.3.3.cmml"><mi id="S3.SS2.p1.6.m3.1.1.3.3.2.2" xref="S3.SS2.p1.6.m3.1.1.3.3.2.2.cmml">W</mi><mi id="S3.SS2.p1.6.m3.1.1.3.3.2.3" xref="S3.SS2.p1.6.m3.1.1.3.3.2.3.cmml">v</mi><mi id="S3.SS2.p1.6.m3.1.1.3.3.3" xref="S3.SS2.p1.6.m3.1.1.3.3.3.cmml">t</mi></msubsup></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.6.m3.1b"><apply id="S3.SS2.p1.6.m3.1.1.cmml" xref="S3.SS2.p1.6.m3.1.1"><eq id="S3.SS2.p1.6.m3.1.1.1.cmml" xref="S3.SS2.p1.6.m3.1.1.1"></eq><ci id="S3.SS2.p1.6.m3.1.1.2.cmml" xref="S3.SS2.p1.6.m3.1.1.2">𝑉</ci><apply id="S3.SS2.p1.6.m3.1.1.3.cmml" xref="S3.SS2.p1.6.m3.1.1.3"><times id="S3.SS2.p1.6.m3.1.1.3.1.cmml" xref="S3.SS2.p1.6.m3.1.1.3.1"></times><apply id="S3.SS2.p1.6.m3.1.1.3.2.cmml" xref="S3.SS2.p1.6.m3.1.1.3.2"><csymbol cd="ambiguous" id="S3.SS2.p1.6.m3.1.1.3.2.1.cmml" xref="S3.SS2.p1.6.m3.1.1.3.2">subscript</csymbol><ci id="S3.SS2.p1.6.m3.1.1.3.2.2.cmml" xref="S3.SS2.p1.6.m3.1.1.3.2.2">𝑐</ci><ci id="S3.SS2.p1.6.m3.1.1.3.2.3.cmml" xref="S3.SS2.p1.6.m3.1.1.3.2.3">𝑡</ci></apply><apply id="S3.SS2.p1.6.m3.1.1.3.3.cmml" xref="S3.SS2.p1.6.m3.1.1.3.3"><csymbol cd="ambiguous" id="S3.SS2.p1.6.m3.1.1.3.3.1.cmml" xref="S3.SS2.p1.6.m3.1.1.3.3">superscript</csymbol><apply id="S3.SS2.p1.6.m3.1.1.3.3.2.cmml" xref="S3.SS2.p1.6.m3.1.1.3.3"><csymbol cd="ambiguous" id="S3.SS2.p1.6.m3.1.1.3.3.2.1.cmml" xref="S3.SS2.p1.6.m3.1.1.3.3">subscript</csymbol><ci id="S3.SS2.p1.6.m3.1.1.3.3.2.2.cmml" xref="S3.SS2.p1.6.m3.1.1.3.3.2.2">𝑊</ci><ci id="S3.SS2.p1.6.m3.1.1.3.3.2.3.cmml" xref="S3.SS2.p1.6.m3.1.1.3.3.2.3">𝑣</ci></apply><ci id="S3.SS2.p1.6.m3.1.1.3.3.3.cmml" xref="S3.SS2.p1.6.m3.1.1.3.3.3">𝑡</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.6.m3.1c">V=c_{t}W_{v}^{t}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.6.m3.1d">italic_V = italic_c start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT italic_W start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT</annotation></semantics></math> are the query, key, and value matrices for the attention operation, respectively, and <math alttext="d" class="ltx_Math" display="inline" id="S3.SS2.p1.7.m4.1"><semantics id="S3.SS2.p1.7.m4.1a"><mi id="S3.SS2.p1.7.m4.1.1" xref="S3.SS2.p1.7.m4.1.1.cmml">d</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.7.m4.1b"><ci id="S3.SS2.p1.7.m4.1.1.cmml" xref="S3.SS2.p1.7.m4.1.1">𝑑</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.7.m4.1c">d</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.7.m4.1d">italic_d</annotation></semantics></math> denotes the channel dimension of the feature. The newly introduced decoupled cross-attention is calculated as follows:</p>
<table class="ltx_equation ltx_centering ltx_eqn_table" id="S3.E3">
<tbody><tr class="ltx_equation ltx_centering ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="Z_{new}=Attention(Q,K_{t},V_{t})+\gamma\cdot Attention(Q,K_{i},V_{i})," class="ltx_Math" display="block" id="S3.E3.m1.3"><semantics id="S3.E3.m1.3a"><mrow id="S3.E3.m1.3.3.1" xref="S3.E3.m1.3.3.1.1.cmml"><mrow id="S3.E3.m1.3.3.1.1" xref="S3.E3.m1.3.3.1.1.cmml"><msub id="S3.E3.m1.3.3.1.1.6" xref="S3.E3.m1.3.3.1.1.6.cmml"><mi id="S3.E3.m1.3.3.1.1.6.2" xref="S3.E3.m1.3.3.1.1.6.2.cmml">Z</mi><mrow id="S3.E3.m1.3.3.1.1.6.3" xref="S3.E3.m1.3.3.1.1.6.3.cmml"><mi id="S3.E3.m1.3.3.1.1.6.3.2" xref="S3.E3.m1.3.3.1.1.6.3.2.cmml">n</mi><mo id="S3.E3.m1.3.3.1.1.6.3.1" xref="S3.E3.m1.3.3.1.1.6.3.1.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.6.3.3" xref="S3.E3.m1.3.3.1.1.6.3.3.cmml">e</mi><mo id="S3.E3.m1.3.3.1.1.6.3.1a" xref="S3.E3.m1.3.3.1.1.6.3.1.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.6.3.4" xref="S3.E3.m1.3.3.1.1.6.3.4.cmml">w</mi></mrow></msub><mo id="S3.E3.m1.3.3.1.1.5" xref="S3.E3.m1.3.3.1.1.5.cmml">=</mo><mrow id="S3.E3.m1.3.3.1.1.4" xref="S3.E3.m1.3.3.1.1.4.cmml"><mrow id="S3.E3.m1.3.3.1.1.2.2" xref="S3.E3.m1.3.3.1.1.2.2.cmml"><mi id="S3.E3.m1.3.3.1.1.2.2.4" xref="S3.E3.m1.3.3.1.1.2.2.4.cmml">A</mi><mo id="S3.E3.m1.3.3.1.1.2.2.3" xref="S3.E3.m1.3.3.1.1.2.2.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.2.2.5" xref="S3.E3.m1.3.3.1.1.2.2.5.cmml">t</mi><mo id="S3.E3.m1.3.3.1.1.2.2.3a" xref="S3.E3.m1.3.3.1.1.2.2.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.2.2.6" xref="S3.E3.m1.3.3.1.1.2.2.6.cmml">t</mi><mo id="S3.E3.m1.3.3.1.1.2.2.3b" xref="S3.E3.m1.3.3.1.1.2.2.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.2.2.7" xref="S3.E3.m1.3.3.1.1.2.2.7.cmml">e</mi><mo id="S3.E3.m1.3.3.1.1.2.2.3c" xref="S3.E3.m1.3.3.1.1.2.2.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.2.2.8" xref="S3.E3.m1.3.3.1.1.2.2.8.cmml">n</mi><mo id="S3.E3.m1.3.3.1.1.2.2.3d" xref="S3.E3.m1.3.3.1.1.2.2.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.2.2.9" xref="S3.E3.m1.3.3.1.1.2.2.9.cmml">t</mi><mo id="S3.E3.m1.3.3.1.1.2.2.3e" xref="S3.E3.m1.3.3.1.1.2.2.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.2.2.10" xref="S3.E3.m1.3.3.1.1.2.2.10.cmml">i</mi><mo id="S3.E3.m1.3.3.1.1.2.2.3f" xref="S3.E3.m1.3.3.1.1.2.2.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.2.2.11" xref="S3.E3.m1.3.3.1.1.2.2.11.cmml">o</mi><mo id="S3.E3.m1.3.3.1.1.2.2.3g" xref="S3.E3.m1.3.3.1.1.2.2.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.2.2.12" xref="S3.E3.m1.3.3.1.1.2.2.12.cmml">n</mi><mo id="S3.E3.m1.3.3.1.1.2.2.3h" xref="S3.E3.m1.3.3.1.1.2.2.3.cmml">⁢</mo><mrow id="S3.E3.m1.3.3.1.1.2.2.2.2" xref="S3.E3.m1.3.3.1.1.2.2.2.3.cmml"><mo id="S3.E3.m1.3.3.1.1.2.2.2.2.3" stretchy="false" xref="S3.E3.m1.3.3.1.1.2.2.2.3.cmml">(</mo><mi id="S3.E3.m1.1.1" xref="S3.E3.m1.1.1.cmml">Q</mi><mo id="S3.E3.m1.3.3.1.1.2.2.2.2.4" xref="S3.E3.m1.3.3.1.1.2.2.2.3.cmml">,</mo><msub id="S3.E3.m1.3.3.1.1.1.1.1.1.1" xref="S3.E3.m1.3.3.1.1.1.1.1.1.1.cmml"><mi id="S3.E3.m1.3.3.1.1.1.1.1.1.1.2" xref="S3.E3.m1.3.3.1.1.1.1.1.1.1.2.cmml">K</mi><mi id="S3.E3.m1.3.3.1.1.1.1.1.1.1.3" xref="S3.E3.m1.3.3.1.1.1.1.1.1.1.3.cmml">t</mi></msub><mo id="S3.E3.m1.3.3.1.1.2.2.2.2.5" xref="S3.E3.m1.3.3.1.1.2.2.2.3.cmml">,</mo><msub id="S3.E3.m1.3.3.1.1.2.2.2.2.2" xref="S3.E3.m1.3.3.1.1.2.2.2.2.2.cmml"><mi id="S3.E3.m1.3.3.1.1.2.2.2.2.2.2" xref="S3.E3.m1.3.3.1.1.2.2.2.2.2.2.cmml">V</mi><mi id="S3.E3.m1.3.3.1.1.2.2.2.2.2.3" xref="S3.E3.m1.3.3.1.1.2.2.2.2.2.3.cmml">t</mi></msub><mo id="S3.E3.m1.3.3.1.1.2.2.2.2.6" stretchy="false" xref="S3.E3.m1.3.3.1.1.2.2.2.3.cmml">)</mo></mrow></mrow><mo id="S3.E3.m1.3.3.1.1.4.5" xref="S3.E3.m1.3.3.1.1.4.5.cmml">+</mo><mrow id="S3.E3.m1.3.3.1.1.4.4" xref="S3.E3.m1.3.3.1.1.4.4.cmml"><mrow id="S3.E3.m1.3.3.1.1.4.4.4" xref="S3.E3.m1.3.3.1.1.4.4.4.cmml"><mi id="S3.E3.m1.3.3.1.1.4.4.4.2" xref="S3.E3.m1.3.3.1.1.4.4.4.2.cmml">γ</mi><mo id="S3.E3.m1.3.3.1.1.4.4.4.1" lspace="0.222em" rspace="0.222em" xref="S3.E3.m1.3.3.1.1.4.4.4.1.cmml">⋅</mo><mi id="S3.E3.m1.3.3.1.1.4.4.4.3" xref="S3.E3.m1.3.3.1.1.4.4.4.3.cmml">A</mi></mrow><mo id="S3.E3.m1.3.3.1.1.4.4.3" xref="S3.E3.m1.3.3.1.1.4.4.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.4.4.5" xref="S3.E3.m1.3.3.1.1.4.4.5.cmml">t</mi><mo id="S3.E3.m1.3.3.1.1.4.4.3a" xref="S3.E3.m1.3.3.1.1.4.4.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.4.4.6" xref="S3.E3.m1.3.3.1.1.4.4.6.cmml">t</mi><mo id="S3.E3.m1.3.3.1.1.4.4.3b" xref="S3.E3.m1.3.3.1.1.4.4.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.4.4.7" xref="S3.E3.m1.3.3.1.1.4.4.7.cmml">e</mi><mo id="S3.E3.m1.3.3.1.1.4.4.3c" xref="S3.E3.m1.3.3.1.1.4.4.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.4.4.8" xref="S3.E3.m1.3.3.1.1.4.4.8.cmml">n</mi><mo id="S3.E3.m1.3.3.1.1.4.4.3d" xref="S3.E3.m1.3.3.1.1.4.4.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.4.4.9" xref="S3.E3.m1.3.3.1.1.4.4.9.cmml">t</mi><mo id="S3.E3.m1.3.3.1.1.4.4.3e" xref="S3.E3.m1.3.3.1.1.4.4.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.4.4.10" xref="S3.E3.m1.3.3.1.1.4.4.10.cmml">i</mi><mo id="S3.E3.m1.3.3.1.1.4.4.3f" xref="S3.E3.m1.3.3.1.1.4.4.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.4.4.11" xref="S3.E3.m1.3.3.1.1.4.4.11.cmml">o</mi><mo id="S3.E3.m1.3.3.1.1.4.4.3g" xref="S3.E3.m1.3.3.1.1.4.4.3.cmml">⁢</mo><mi id="S3.E3.m1.3.3.1.1.4.4.12" xref="S3.E3.m1.3.3.1.1.4.4.12.cmml">n</mi><mo id="S3.E3.m1.3.3.1.1.4.4.3h" xref="S3.E3.m1.3.3.1.1.4.4.3.cmml">⁢</mo><mrow id="S3.E3.m1.3.3.1.1.4.4.2.2" xref="S3.E3.m1.3.3.1.1.4.4.2.3.cmml"><mo id="S3.E3.m1.3.3.1.1.4.4.2.2.3" stretchy="false" xref="S3.E3.m1.3.3.1.1.4.4.2.3.cmml">(</mo><mi id="S3.E3.m1.2.2" xref="S3.E3.m1.2.2.cmml">Q</mi><mo id="S3.E3.m1.3.3.1.1.4.4.2.2.4" xref="S3.E3.m1.3.3.1.1.4.4.2.3.cmml">,</mo><msub id="S3.E3.m1.3.3.1.1.3.3.1.1.1" xref="S3.E3.m1.3.3.1.1.3.3.1.1.1.cmml"><mi id="S3.E3.m1.3.3.1.1.3.3.1.1.1.2" xref="S3.E3.m1.3.3.1.1.3.3.1.1.1.2.cmml">K</mi><mi id="S3.E3.m1.3.3.1.1.3.3.1.1.1.3" xref="S3.E3.m1.3.3.1.1.3.3.1.1.1.3.cmml">i</mi></msub><mo id="S3.E3.m1.3.3.1.1.4.4.2.2.5" xref="S3.E3.m1.3.3.1.1.4.4.2.3.cmml">,</mo><msub id="S3.E3.m1.3.3.1.1.4.4.2.2.2" xref="S3.E3.m1.3.3.1.1.4.4.2.2.2.cmml"><mi id="S3.E3.m1.3.3.1.1.4.4.2.2.2.2" xref="S3.E3.m1.3.3.1.1.4.4.2.2.2.2.cmml">V</mi><mi id="S3.E3.m1.3.3.1.1.4.4.2.2.2.3" xref="S3.E3.m1.3.3.1.1.4.4.2.2.2.3.cmml">i</mi></msub><mo id="S3.E3.m1.3.3.1.1.4.4.2.2.6" stretchy="false" xref="S3.E3.m1.3.3.1.1.4.4.2.3.cmml">)</mo></mrow></mrow></mrow></mrow><mo id="S3.E3.m1.3.3.1.2" xref="S3.E3.m1.3.3.1.1.cmml">,</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.E3.m1.3b"><apply id="S3.E3.m1.3.3.1.1.cmml" xref="S3.E3.m1.3.3.1"><eq id="S3.E3.m1.3.3.1.1.5.cmml" xref="S3.E3.m1.3.3.1.1.5"></eq><apply id="S3.E3.m1.3.3.1.1.6.cmml" xref="S3.E3.m1.3.3.1.1.6"><csymbol cd="ambiguous" id="S3.E3.m1.3.3.1.1.6.1.cmml" xref="S3.E3.m1.3.3.1.1.6">subscript</csymbol><ci id="S3.E3.m1.3.3.1.1.6.2.cmml" xref="S3.E3.m1.3.3.1.1.6.2">𝑍</ci><apply id="S3.E3.m1.3.3.1.1.6.3.cmml" xref="S3.E3.m1.3.3.1.1.6.3"><times id="S3.E3.m1.3.3.1.1.6.3.1.cmml" xref="S3.E3.m1.3.3.1.1.6.3.1"></times><ci id="S3.E3.m1.3.3.1.1.6.3.2.cmml" xref="S3.E3.m1.3.3.1.1.6.3.2">𝑛</ci><ci id="S3.E3.m1.3.3.1.1.6.3.3.cmml" xref="S3.E3.m1.3.3.1.1.6.3.3">𝑒</ci><ci id="S3.E3.m1.3.3.1.1.6.3.4.cmml" xref="S3.E3.m1.3.3.1.1.6.3.4">𝑤</ci></apply></apply><apply id="S3.E3.m1.3.3.1.1.4.cmml" xref="S3.E3.m1.3.3.1.1.4"><plus id="S3.E3.m1.3.3.1.1.4.5.cmml" xref="S3.E3.m1.3.3.1.1.4.5"></plus><apply id="S3.E3.m1.3.3.1.1.2.2.cmml" xref="S3.E3.m1.3.3.1.1.2.2"><times id="S3.E3.m1.3.3.1.1.2.2.3.cmml" xref="S3.E3.m1.3.3.1.1.2.2.3"></times><ci id="S3.E3.m1.3.3.1.1.2.2.4.cmml" xref="S3.E3.m1.3.3.1.1.2.2.4">𝐴</ci><ci id="S3.E3.m1.3.3.1.1.2.2.5.cmml" xref="S3.E3.m1.3.3.1.1.2.2.5">𝑡</ci><ci id="S3.E3.m1.3.3.1.1.2.2.6.cmml" xref="S3.E3.m1.3.3.1.1.2.2.6">𝑡</ci><ci id="S3.E3.m1.3.3.1.1.2.2.7.cmml" xref="S3.E3.m1.3.3.1.1.2.2.7">𝑒</ci><ci id="S3.E3.m1.3.3.1.1.2.2.8.cmml" xref="S3.E3.m1.3.3.1.1.2.2.8">𝑛</ci><ci id="S3.E3.m1.3.3.1.1.2.2.9.cmml" xref="S3.E3.m1.3.3.1.1.2.2.9">𝑡</ci><ci id="S3.E3.m1.3.3.1.1.2.2.10.cmml" xref="S3.E3.m1.3.3.1.1.2.2.10">𝑖</ci><ci id="S3.E3.m1.3.3.1.1.2.2.11.cmml" xref="S3.E3.m1.3.3.1.1.2.2.11">𝑜</ci><ci id="S3.E3.m1.3.3.1.1.2.2.12.cmml" xref="S3.E3.m1.3.3.1.1.2.2.12">𝑛</ci><vector id="S3.E3.m1.3.3.1.1.2.2.2.3.cmml" xref="S3.E3.m1.3.3.1.1.2.2.2.2"><ci id="S3.E3.m1.1.1.cmml" xref="S3.E3.m1.1.1">𝑄</ci><apply id="S3.E3.m1.3.3.1.1.1.1.1.1.1.cmml" xref="S3.E3.m1.3.3.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.E3.m1.3.3.1.1.1.1.1.1.1.1.cmml" xref="S3.E3.m1.3.3.1.1.1.1.1.1.1">subscript</csymbol><ci id="S3.E3.m1.3.3.1.1.1.1.1.1.1.2.cmml" xref="S3.E3.m1.3.3.1.1.1.1.1.1.1.2">𝐾</ci><ci id="S3.E3.m1.3.3.1.1.1.1.1.1.1.3.cmml" xref="S3.E3.m1.3.3.1.1.1.1.1.1.1.3">𝑡</ci></apply><apply id="S3.E3.m1.3.3.1.1.2.2.2.2.2.cmml" xref="S3.E3.m1.3.3.1.1.2.2.2.2.2"><csymbol cd="ambiguous" id="S3.E3.m1.3.3.1.1.2.2.2.2.2.1.cmml" xref="S3.E3.m1.3.3.1.1.2.2.2.2.2">subscript</csymbol><ci id="S3.E3.m1.3.3.1.1.2.2.2.2.2.2.cmml" xref="S3.E3.m1.3.3.1.1.2.2.2.2.2.2">𝑉</ci><ci id="S3.E3.m1.3.3.1.1.2.2.2.2.2.3.cmml" xref="S3.E3.m1.3.3.1.1.2.2.2.2.2.3">𝑡</ci></apply></vector></apply><apply id="S3.E3.m1.3.3.1.1.4.4.cmml" xref="S3.E3.m1.3.3.1.1.4.4"><times id="S3.E3.m1.3.3.1.1.4.4.3.cmml" xref="S3.E3.m1.3.3.1.1.4.4.3"></times><apply id="S3.E3.m1.3.3.1.1.4.4.4.cmml" xref="S3.E3.m1.3.3.1.1.4.4.4"><ci id="S3.E3.m1.3.3.1.1.4.4.4.1.cmml" xref="S3.E3.m1.3.3.1.1.4.4.4.1">⋅</ci><ci id="S3.E3.m1.3.3.1.1.4.4.4.2.cmml" xref="S3.E3.m1.3.3.1.1.4.4.4.2">𝛾</ci><ci id="S3.E3.m1.3.3.1.1.4.4.4.3.cmml" xref="S3.E3.m1.3.3.1.1.4.4.4.3">𝐴</ci></apply><ci id="S3.E3.m1.3.3.1.1.4.4.5.cmml" xref="S3.E3.m1.3.3.1.1.4.4.5">𝑡</ci><ci id="S3.E3.m1.3.3.1.1.4.4.6.cmml" xref="S3.E3.m1.3.3.1.1.4.4.6">𝑡</ci><ci id="S3.E3.m1.3.3.1.1.4.4.7.cmml" xref="S3.E3.m1.3.3.1.1.4.4.7">𝑒</ci><ci id="S3.E3.m1.3.3.1.1.4.4.8.cmml" xref="S3.E3.m1.3.3.1.1.4.4.8">𝑛</ci><ci id="S3.E3.m1.3.3.1.1.4.4.9.cmml" xref="S3.E3.m1.3.3.1.1.4.4.9">𝑡</ci><ci id="S3.E3.m1.3.3.1.1.4.4.10.cmml" xref="S3.E3.m1.3.3.1.1.4.4.10">𝑖</ci><ci id="S3.E3.m1.3.3.1.1.4.4.11.cmml" xref="S3.E3.m1.3.3.1.1.4.4.11">𝑜</ci><ci id="S3.E3.m1.3.3.1.1.4.4.12.cmml" xref="S3.E3.m1.3.3.1.1.4.4.12">𝑛</ci><vector id="S3.E3.m1.3.3.1.1.4.4.2.3.cmml" xref="S3.E3.m1.3.3.1.1.4.4.2.2"><ci id="S3.E3.m1.2.2.cmml" xref="S3.E3.m1.2.2">𝑄</ci><apply id="S3.E3.m1.3.3.1.1.3.3.1.1.1.cmml" xref="S3.E3.m1.3.3.1.1.3.3.1.1.1"><csymbol cd="ambiguous" id="S3.E3.m1.3.3.1.1.3.3.1.1.1.1.cmml" xref="S3.E3.m1.3.3.1.1.3.3.1.1.1">subscript</csymbol><ci id="S3.E3.m1.3.3.1.1.3.3.1.1.1.2.cmml" xref="S3.E3.m1.3.3.1.1.3.3.1.1.1.2">𝐾</ci><ci id="S3.E3.m1.3.3.1.1.3.3.1.1.1.3.cmml" xref="S3.E3.m1.3.3.1.1.3.3.1.1.1.3">𝑖</ci></apply><apply id="S3.E3.m1.3.3.1.1.4.4.2.2.2.cmml" xref="S3.E3.m1.3.3.1.1.4.4.2.2.2"><csymbol cd="ambiguous" id="S3.E3.m1.3.3.1.1.4.4.2.2.2.1.cmml" xref="S3.E3.m1.3.3.1.1.4.4.2.2.2">subscript</csymbol><ci id="S3.E3.m1.3.3.1.1.4.4.2.2.2.2.cmml" xref="S3.E3.m1.3.3.1.1.4.4.2.2.2.2">𝑉</ci><ci id="S3.E3.m1.3.3.1.1.4.4.2.2.2.3.cmml" xref="S3.E3.m1.3.3.1.1.4.4.2.2.2.3">𝑖</ci></apply></vector></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.E3.m1.3c">Z_{new}=Attention(Q,K_{t},V_{t})+\gamma\cdot Attention(Q,K_{i},V_{i}),</annotation><annotation encoding="application/x-llamapun" id="S3.E3.m1.3d">italic_Z start_POSTSUBSCRIPT italic_n italic_e italic_w end_POSTSUBSCRIPT = italic_A italic_t italic_t italic_e italic_n italic_t italic_i italic_o italic_n ( italic_Q , italic_K start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT , italic_V start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT ) + italic_γ ⋅ italic_A italic_t italic_t italic_e italic_n italic_t italic_i italic_o italic_n ( italic_Q , italic_K start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT , italic_V start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ) ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(3)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S3.SS2.p1.11">where <math alttext="c_{i}" class="ltx_Math" display="inline" id="S3.SS2.p1.8.m1.1"><semantics id="S3.SS2.p1.8.m1.1a"><msub id="S3.SS2.p1.8.m1.1.1" xref="S3.SS2.p1.8.m1.1.1.cmml"><mi id="S3.SS2.p1.8.m1.1.1.2" xref="S3.SS2.p1.8.m1.1.1.2.cmml">c</mi><mi id="S3.SS2.p1.8.m1.1.1.3" xref="S3.SS2.p1.8.m1.1.1.3.cmml">i</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.8.m1.1b"><apply id="S3.SS2.p1.8.m1.1.1.cmml" xref="S3.SS2.p1.8.m1.1.1"><csymbol cd="ambiguous" id="S3.SS2.p1.8.m1.1.1.1.cmml" xref="S3.SS2.p1.8.m1.1.1">subscript</csymbol><ci id="S3.SS2.p1.8.m1.1.1.2.cmml" xref="S3.SS2.p1.8.m1.1.1.2">𝑐</ci><ci id="S3.SS2.p1.8.m1.1.1.3.cmml" xref="S3.SS2.p1.8.m1.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.8.m1.1c">c_{i}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.8.m1.1d">italic_c start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math> is the image prompt embed and <math alttext="K_{i}=c_{i}W_{k}^{i},V_{i}=c_{i}W_{v}^{i}" class="ltx_Math" display="inline" id="S3.SS2.p1.9.m2.2"><semantics id="S3.SS2.p1.9.m2.2a"><mrow id="S3.SS2.p1.9.m2.2.2.2" xref="S3.SS2.p1.9.m2.2.2.3.cmml"><mrow id="S3.SS2.p1.9.m2.1.1.1.1" xref="S3.SS2.p1.9.m2.1.1.1.1.cmml"><msub id="S3.SS2.p1.9.m2.1.1.1.1.2" xref="S3.SS2.p1.9.m2.1.1.1.1.2.cmml"><mi id="S3.SS2.p1.9.m2.1.1.1.1.2.2" xref="S3.SS2.p1.9.m2.1.1.1.1.2.2.cmml">K</mi><mi id="S3.SS2.p1.9.m2.1.1.1.1.2.3" xref="S3.SS2.p1.9.m2.1.1.1.1.2.3.cmml">i</mi></msub><mo id="S3.SS2.p1.9.m2.1.1.1.1.1" xref="S3.SS2.p1.9.m2.1.1.1.1.1.cmml">=</mo><mrow id="S3.SS2.p1.9.m2.1.1.1.1.3" xref="S3.SS2.p1.9.m2.1.1.1.1.3.cmml"><msub id="S3.SS2.p1.9.m2.1.1.1.1.3.2" xref="S3.SS2.p1.9.m2.1.1.1.1.3.2.cmml"><mi id="S3.SS2.p1.9.m2.1.1.1.1.3.2.2" xref="S3.SS2.p1.9.m2.1.1.1.1.3.2.2.cmml">c</mi><mi id="S3.SS2.p1.9.m2.1.1.1.1.3.2.3" xref="S3.SS2.p1.9.m2.1.1.1.1.3.2.3.cmml">i</mi></msub><mo id="S3.SS2.p1.9.m2.1.1.1.1.3.1" xref="S3.SS2.p1.9.m2.1.1.1.1.3.1.cmml">⁢</mo><msubsup id="S3.SS2.p1.9.m2.1.1.1.1.3.3" xref="S3.SS2.p1.9.m2.1.1.1.1.3.3.cmml"><mi id="S3.SS2.p1.9.m2.1.1.1.1.3.3.2.2" xref="S3.SS2.p1.9.m2.1.1.1.1.3.3.2.2.cmml">W</mi><mi id="S3.SS2.p1.9.m2.1.1.1.1.3.3.2.3" xref="S3.SS2.p1.9.m2.1.1.1.1.3.3.2.3.cmml">k</mi><mi id="S3.SS2.p1.9.m2.1.1.1.1.3.3.3" xref="S3.SS2.p1.9.m2.1.1.1.1.3.3.3.cmml">i</mi></msubsup></mrow></mrow><mo id="S3.SS2.p1.9.m2.2.2.2.3" xref="S3.SS2.p1.9.m2.2.2.3a.cmml">,</mo><mrow id="S3.SS2.p1.9.m2.2.2.2.2" xref="S3.SS2.p1.9.m2.2.2.2.2.cmml"><msub id="S3.SS2.p1.9.m2.2.2.2.2.2" xref="S3.SS2.p1.9.m2.2.2.2.2.2.cmml"><mi id="S3.SS2.p1.9.m2.2.2.2.2.2.2" xref="S3.SS2.p1.9.m2.2.2.2.2.2.2.cmml">V</mi><mi id="S3.SS2.p1.9.m2.2.2.2.2.2.3" xref="S3.SS2.p1.9.m2.2.2.2.2.2.3.cmml">i</mi></msub><mo id="S3.SS2.p1.9.m2.2.2.2.2.1" xref="S3.SS2.p1.9.m2.2.2.2.2.1.cmml">=</mo><mrow id="S3.SS2.p1.9.m2.2.2.2.2.3" xref="S3.SS2.p1.9.m2.2.2.2.2.3.cmml"><msub id="S3.SS2.p1.9.m2.2.2.2.2.3.2" xref="S3.SS2.p1.9.m2.2.2.2.2.3.2.cmml"><mi id="S3.SS2.p1.9.m2.2.2.2.2.3.2.2" xref="S3.SS2.p1.9.m2.2.2.2.2.3.2.2.cmml">c</mi><mi id="S3.SS2.p1.9.m2.2.2.2.2.3.2.3" xref="S3.SS2.p1.9.m2.2.2.2.2.3.2.3.cmml">i</mi></msub><mo id="S3.SS2.p1.9.m2.2.2.2.2.3.1" xref="S3.SS2.p1.9.m2.2.2.2.2.3.1.cmml">⁢</mo><msubsup id="S3.SS2.p1.9.m2.2.2.2.2.3.3" xref="S3.SS2.p1.9.m2.2.2.2.2.3.3.cmml"><mi id="S3.SS2.p1.9.m2.2.2.2.2.3.3.2.2" xref="S3.SS2.p1.9.m2.2.2.2.2.3.3.2.2.cmml">W</mi><mi id="S3.SS2.p1.9.m2.2.2.2.2.3.3.2.3" xref="S3.SS2.p1.9.m2.2.2.2.2.3.3.2.3.cmml">v</mi><mi id="S3.SS2.p1.9.m2.2.2.2.2.3.3.3" xref="S3.SS2.p1.9.m2.2.2.2.2.3.3.3.cmml">i</mi></msubsup></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.9.m2.2b"><apply id="S3.SS2.p1.9.m2.2.2.3.cmml" xref="S3.SS2.p1.9.m2.2.2.2"><csymbol cd="ambiguous" id="S3.SS2.p1.9.m2.2.2.3a.cmml" xref="S3.SS2.p1.9.m2.2.2.2.3">formulae-sequence</csymbol><apply id="S3.SS2.p1.9.m2.1.1.1.1.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1"><eq id="S3.SS2.p1.9.m2.1.1.1.1.1.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.1"></eq><apply id="S3.SS2.p1.9.m2.1.1.1.1.2.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.2"><csymbol cd="ambiguous" id="S3.SS2.p1.9.m2.1.1.1.1.2.1.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.2">subscript</csymbol><ci id="S3.SS2.p1.9.m2.1.1.1.1.2.2.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.2.2">𝐾</ci><ci id="S3.SS2.p1.9.m2.1.1.1.1.2.3.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.2.3">𝑖</ci></apply><apply id="S3.SS2.p1.9.m2.1.1.1.1.3.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3"><times id="S3.SS2.p1.9.m2.1.1.1.1.3.1.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3.1"></times><apply id="S3.SS2.p1.9.m2.1.1.1.1.3.2.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3.2"><csymbol cd="ambiguous" id="S3.SS2.p1.9.m2.1.1.1.1.3.2.1.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3.2">subscript</csymbol><ci id="S3.SS2.p1.9.m2.1.1.1.1.3.2.2.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3.2.2">𝑐</ci><ci id="S3.SS2.p1.9.m2.1.1.1.1.3.2.3.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3.2.3">𝑖</ci></apply><apply id="S3.SS2.p1.9.m2.1.1.1.1.3.3.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S3.SS2.p1.9.m2.1.1.1.1.3.3.1.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3.3">superscript</csymbol><apply id="S3.SS2.p1.9.m2.1.1.1.1.3.3.2.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S3.SS2.p1.9.m2.1.1.1.1.3.3.2.1.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3.3">subscript</csymbol><ci id="S3.SS2.p1.9.m2.1.1.1.1.3.3.2.2.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3.3.2.2">𝑊</ci><ci id="S3.SS2.p1.9.m2.1.1.1.1.3.3.2.3.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3.3.2.3">𝑘</ci></apply><ci id="S3.SS2.p1.9.m2.1.1.1.1.3.3.3.cmml" xref="S3.SS2.p1.9.m2.1.1.1.1.3.3.3">𝑖</ci></apply></apply></apply><apply id="S3.SS2.p1.9.m2.2.2.2.2.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2"><eq id="S3.SS2.p1.9.m2.2.2.2.2.1.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.1"></eq><apply id="S3.SS2.p1.9.m2.2.2.2.2.2.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.2"><csymbol cd="ambiguous" id="S3.SS2.p1.9.m2.2.2.2.2.2.1.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.2">subscript</csymbol><ci id="S3.SS2.p1.9.m2.2.2.2.2.2.2.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.2.2">𝑉</ci><ci id="S3.SS2.p1.9.m2.2.2.2.2.2.3.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.2.3">𝑖</ci></apply><apply id="S3.SS2.p1.9.m2.2.2.2.2.3.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3"><times id="S3.SS2.p1.9.m2.2.2.2.2.3.1.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3.1"></times><apply id="S3.SS2.p1.9.m2.2.2.2.2.3.2.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3.2"><csymbol cd="ambiguous" id="S3.SS2.p1.9.m2.2.2.2.2.3.2.1.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3.2">subscript</csymbol><ci id="S3.SS2.p1.9.m2.2.2.2.2.3.2.2.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3.2.2">𝑐</ci><ci id="S3.SS2.p1.9.m2.2.2.2.2.3.2.3.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3.2.3">𝑖</ci></apply><apply id="S3.SS2.p1.9.m2.2.2.2.2.3.3.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3.3"><csymbol cd="ambiguous" id="S3.SS2.p1.9.m2.2.2.2.2.3.3.1.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3.3">superscript</csymbol><apply id="S3.SS2.p1.9.m2.2.2.2.2.3.3.2.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3.3"><csymbol cd="ambiguous" id="S3.SS2.p1.9.m2.2.2.2.2.3.3.2.1.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3.3">subscript</csymbol><ci id="S3.SS2.p1.9.m2.2.2.2.2.3.3.2.2.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3.3.2.2">𝑊</ci><ci id="S3.SS2.p1.9.m2.2.2.2.2.3.3.2.3.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3.3.2.3">𝑣</ci></apply><ci id="S3.SS2.p1.9.m2.2.2.2.2.3.3.3.cmml" xref="S3.SS2.p1.9.m2.2.2.2.2.3.3.3">𝑖</ci></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.9.m2.2c">K_{i}=c_{i}W_{k}^{i},V_{i}=c_{i}W_{v}^{i}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.9.m2.2d">italic_K start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT = italic_c start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT italic_W start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_i end_POSTSUPERSCRIPT , italic_V start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT = italic_c start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT italic_W start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_i end_POSTSUPERSCRIPT</annotation></semantics></math> constitute the added attention operation for the image cross-attention. Here only <math alttext="W_{k}^{i}" class="ltx_Math" display="inline" id="S3.SS2.p1.10.m3.1"><semantics id="S3.SS2.p1.10.m3.1a"><msubsup id="S3.SS2.p1.10.m3.1.1" xref="S3.SS2.p1.10.m3.1.1.cmml"><mi id="S3.SS2.p1.10.m3.1.1.2.2" xref="S3.SS2.p1.10.m3.1.1.2.2.cmml">W</mi><mi id="S3.SS2.p1.10.m3.1.1.2.3" xref="S3.SS2.p1.10.m3.1.1.2.3.cmml">k</mi><mi id="S3.SS2.p1.10.m3.1.1.3" xref="S3.SS2.p1.10.m3.1.1.3.cmml">i</mi></msubsup><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.10.m3.1b"><apply id="S3.SS2.p1.10.m3.1.1.cmml" xref="S3.SS2.p1.10.m3.1.1"><csymbol cd="ambiguous" id="S3.SS2.p1.10.m3.1.1.1.cmml" xref="S3.SS2.p1.10.m3.1.1">superscript</csymbol><apply id="S3.SS2.p1.10.m3.1.1.2.cmml" xref="S3.SS2.p1.10.m3.1.1"><csymbol cd="ambiguous" id="S3.SS2.p1.10.m3.1.1.2.1.cmml" xref="S3.SS2.p1.10.m3.1.1">subscript</csymbol><ci id="S3.SS2.p1.10.m3.1.1.2.2.cmml" xref="S3.SS2.p1.10.m3.1.1.2.2">𝑊</ci><ci id="S3.SS2.p1.10.m3.1.1.2.3.cmml" xref="S3.SS2.p1.10.m3.1.1.2.3">𝑘</ci></apply><ci id="S3.SS2.p1.10.m3.1.1.3.cmml" xref="S3.SS2.p1.10.m3.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.10.m3.1c">W_{k}^{i}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.10.m3.1d">italic_W start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_i end_POSTSUPERSCRIPT</annotation></semantics></math> and <math alttext="W_{v}^{i}" class="ltx_Math" display="inline" id="S3.SS2.p1.11.m4.1"><semantics id="S3.SS2.p1.11.m4.1a"><msubsup id="S3.SS2.p1.11.m4.1.1" xref="S3.SS2.p1.11.m4.1.1.cmml"><mi id="S3.SS2.p1.11.m4.1.1.2.2" xref="S3.SS2.p1.11.m4.1.1.2.2.cmml">W</mi><mi id="S3.SS2.p1.11.m4.1.1.2.3" xref="S3.SS2.p1.11.m4.1.1.2.3.cmml">v</mi><mi id="S3.SS2.p1.11.m4.1.1.3" xref="S3.SS2.p1.11.m4.1.1.3.cmml">i</mi></msubsup><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.11.m4.1b"><apply id="S3.SS2.p1.11.m4.1.1.cmml" xref="S3.SS2.p1.11.m4.1.1"><csymbol cd="ambiguous" id="S3.SS2.p1.11.m4.1.1.1.cmml" xref="S3.SS2.p1.11.m4.1.1">superscript</csymbol><apply id="S3.SS2.p1.11.m4.1.1.2.cmml" xref="S3.SS2.p1.11.m4.1.1"><csymbol cd="ambiguous" id="S3.SS2.p1.11.m4.1.1.2.1.cmml" xref="S3.SS2.p1.11.m4.1.1">subscript</csymbol><ci id="S3.SS2.p1.11.m4.1.1.2.2.cmml" xref="S3.SS2.p1.11.m4.1.1.2.2">𝑊</ci><ci id="S3.SS2.p1.11.m4.1.1.2.3.cmml" xref="S3.SS2.p1.11.m4.1.1.2.3">𝑣</ci></apply><ci id="S3.SS2.p1.11.m4.1.1.3.cmml" xref="S3.SS2.p1.11.m4.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.11.m4.1c">W_{v}^{i}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.11.m4.1d">italic_W start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_i end_POSTSUPERSCRIPT</annotation></semantics></math> are the trainable weights.</p>
</div>
</section>
</section>
<section class="ltx_section" id="S4">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">4 </span>Method</h2>
<section class="ltx_subsection" id="S4.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.1 </span>Overview</h3>
<div class="ltx_para ltx_noindent" id="S4.SS1.p1">
<p class="ltx_p" id="S4.SS1.p1.1">Given a reference image containing one or two characters, StoryMaker seeks to generate a series of new images featuring the same characters, maintaining not only identical faces, <math alttext="i.e." class="ltx_Math" display="inline" id="S4.SS1.p1.1.m1.3"><semantics id="S4.SS1.p1.1.m1.3a"><mrow id="S4.SS1.p1.1.m1.3.3.1"><mrow id="S4.SS1.p1.1.m1.3.3.1.1.2" xref="S4.SS1.p1.1.m1.3.3.1.1.1.cmml"><mi id="S4.SS1.p1.1.m1.1.1" xref="S4.SS1.p1.1.m1.1.1.cmml">i</mi><mo id="S4.SS1.p1.1.m1.3.3.1.1.2.1" lspace="0em" rspace="0.167em" xref="S4.SS1.p1.1.m1.3.3.1.1.1a.cmml">.</mo><mi id="S4.SS1.p1.1.m1.2.2" xref="S4.SS1.p1.1.m1.2.2.cmml">e</mi></mrow><mo id="S4.SS1.p1.1.m1.3.3.1.2" lspace="0em">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.SS1.p1.1.m1.3b"><apply id="S4.SS1.p1.1.m1.3.3.1.1.1.cmml" xref="S4.SS1.p1.1.m1.3.3.1.1.2"><csymbol cd="ambiguous" id="S4.SS1.p1.1.m1.3.3.1.1.1a.cmml" xref="S4.SS1.p1.1.m1.3.3.1.1.2.1">formulae-sequence</csymbol><ci id="S4.SS1.p1.1.m1.1.1.cmml" xref="S4.SS1.p1.1.m1.1.1">𝑖</ci><ci id="S4.SS1.p1.1.m1.2.2.cmml" xref="S4.SS1.p1.1.m1.2.2">𝑒</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p1.1.m1.3c">i.e.</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p1.1.m1.3d">italic_i . italic_e .</annotation></semantics></math>, identities, but also their clothing, hairstyles, and bodies. A narrative can then be created by altering the background, the characters’ poses, and the style according to the text prompts.</p>
</div>
<div class="ltx_para ltx_noindent" id="S4.SS1.p2">
<p class="ltx_p" id="S4.SS1.p2.1">Specifically, we first extract the facial information, <math alttext="i.e." class="ltx_Math" display="inline" id="S4.SS1.p2.1.m1.3"><semantics id="S4.SS1.p2.1.m1.3a"><mrow id="S4.SS1.p2.1.m1.3.3.1"><mrow id="S4.SS1.p2.1.m1.3.3.1.1.2" xref="S4.SS1.p2.1.m1.3.3.1.1.1.cmml"><mi id="S4.SS1.p2.1.m1.1.1" xref="S4.SS1.p2.1.m1.1.1.cmml">i</mi><mo id="S4.SS1.p2.1.m1.3.3.1.1.2.1" lspace="0em" rspace="0.167em" xref="S4.SS1.p2.1.m1.3.3.1.1.1a.cmml">.</mo><mi id="S4.SS1.p2.1.m1.2.2" xref="S4.SS1.p2.1.m1.2.2.cmml">e</mi></mrow><mo id="S4.SS1.p2.1.m1.3.3.1.2" lspace="0em">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.SS1.p2.1.m1.3b"><apply id="S4.SS1.p2.1.m1.3.3.1.1.1.cmml" xref="S4.SS1.p2.1.m1.3.3.1.1.2"><csymbol cd="ambiguous" id="S4.SS1.p2.1.m1.3.3.1.1.1a.cmml" xref="S4.SS1.p2.1.m1.3.3.1.1.2.1">formulae-sequence</csymbol><ci id="S4.SS1.p2.1.m1.1.1.cmml" xref="S4.SS1.p2.1.m1.1.1">𝑖</ci><ci id="S4.SS1.p2.1.m1.2.2.cmml" xref="S4.SS1.p2.1.m1.2.2">𝑒</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p2.1.m1.3c">i.e.</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p2.1.m1.3d">italic_i . italic_e .</annotation></semantics></math>, identities, of the characters using the face encoder, and the details of their clothing, hairstyles, and bodies via the character image encoder. We then refine this information using the proposed Positional-aware Perceiver Resampler. To control the backbone generation network, we inject the refined information into the decoupled cross-attention module proposed by IP-Adapter <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite>. To prevent multiple characters and the background from interleaving, we constrain the impact region of the cross-attention for different characters and background separately. ID loss is additionally utilized to maintain the characters’ identities. Furthermore, to decouple pose information from the reference image, we train the network conditioned on detected poses by ControlNet <cite class="ltx_cite ltx_citemacro_citep">(Zhang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib17" title="">2023</a>)</cite>. For enhanced fidelity and quality, we also train the U-Net with LoRA <cite class="ltx_cite ltx_citemacro_citep">(Hu et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib37" title="">2021</a>)</cite>. Once trained, we can either discard the entire ControlNet and control the characters’ poses through text prompts or guide image generation with new poses during inference. The complete pipeline of our proposed method is illustrated in Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S2.F2" title="Figure 2 ‣ 2.2 Image Story Generation ‣ 2 Related Work ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">2</span></a>.</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.2 </span>Reference Information Extraction</h3>
<div class="ltx_para ltx_noindent" id="S4.SS2.p1">
<p class="ltx_p" id="S4.SS2.p1.2">Since the facial features extracted by the face recognition model effectively capture semantic details and enhance fidelity, similar to InstantID <cite class="ltx_cite ltx_citemacro_citep">(Wang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib15" title="">2024a</a>)</cite> and IP-Adapter-FaceID <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite>, we utilize Arcface <cite class="ltx_cite ltx_citemacro_citep">(Deng et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib26" title="">2019</a>)</cite> to detect faces and obtain aligned facial embeddings from the reference image. To maintain consistency in hairstyles, clothing, and bodies, we first segment the reference image to crop the characters. Following recent works such as IP-Adapter <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite> and MM-Diff <cite class="ltx_cite ltx_citemacro_citep">(Wei et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib12" title="">2024</a>)</cite>, we use the pretrained CLIP vision encoder, known for its rich content and style, to extract features of the hairstyles, clothing, and bodies of the characters. During training, the face encoder, <math alttext="i.e." class="ltx_Math" display="inline" id="S4.SS2.p1.1.m1.3"><semantics id="S4.SS2.p1.1.m1.3a"><mrow id="S4.SS2.p1.1.m1.3.3.1"><mrow id="S4.SS2.p1.1.m1.3.3.1.1.2" xref="S4.SS2.p1.1.m1.3.3.1.1.1.cmml"><mi id="S4.SS2.p1.1.m1.1.1" xref="S4.SS2.p1.1.m1.1.1.cmml">i</mi><mo id="S4.SS2.p1.1.m1.3.3.1.1.2.1" lspace="0em" rspace="0.167em" xref="S4.SS2.p1.1.m1.3.3.1.1.1a.cmml">.</mo><mi id="S4.SS2.p1.1.m1.2.2" xref="S4.SS2.p1.1.m1.2.2.cmml">e</mi></mrow><mo id="S4.SS2.p1.1.m1.3.3.1.2" lspace="0em">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.SS2.p1.1.m1.3b"><apply id="S4.SS2.p1.1.m1.3.3.1.1.1.cmml" xref="S4.SS2.p1.1.m1.3.3.1.1.2"><csymbol cd="ambiguous" id="S4.SS2.p1.1.m1.3.3.1.1.1a.cmml" xref="S4.SS2.p1.1.m1.3.3.1.1.2.1">formulae-sequence</csymbol><ci id="S4.SS2.p1.1.m1.1.1.cmml" xref="S4.SS2.p1.1.m1.1.1">𝑖</ci><ci id="S4.SS2.p1.1.m1.2.2.cmml" xref="S4.SS2.p1.1.m1.2.2">𝑒</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p1.1.m1.3c">i.e.</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p1.1.m1.3d">italic_i . italic_e .</annotation></semantics></math>, Arcface model, and the image encoder, <math alttext="i.e." class="ltx_Math" display="inline" id="S4.SS2.p1.2.m2.3"><semantics id="S4.SS2.p1.2.m2.3a"><mrow id="S4.SS2.p1.2.m2.3.3.1"><mrow id="S4.SS2.p1.2.m2.3.3.1.1.2" xref="S4.SS2.p1.2.m2.3.3.1.1.1.cmml"><mi id="S4.SS2.p1.2.m2.1.1" xref="S4.SS2.p1.2.m2.1.1.cmml">i</mi><mo id="S4.SS2.p1.2.m2.3.3.1.1.2.1" lspace="0em" rspace="0.167em" xref="S4.SS2.p1.2.m2.3.3.1.1.1a.cmml">.</mo><mi id="S4.SS2.p1.2.m2.2.2" xref="S4.SS2.p1.2.m2.2.2.cmml">e</mi></mrow><mo id="S4.SS2.p1.2.m2.3.3.1.2" lspace="0em">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.SS2.p1.2.m2.3b"><apply id="S4.SS2.p1.2.m2.3.3.1.1.1.cmml" xref="S4.SS2.p1.2.m2.3.3.1.1.2"><csymbol cd="ambiguous" id="S4.SS2.p1.2.m2.3.3.1.1.1a.cmml" xref="S4.SS2.p1.2.m2.3.3.1.1.2.1">formulae-sequence</csymbol><ci id="S4.SS2.p1.2.m2.1.1.cmml" xref="S4.SS2.p1.2.m2.1.1">𝑖</ci><ci id="S4.SS2.p1.2.m2.2.2.cmml" xref="S4.SS2.p1.2.m2.2.2">𝑒</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p1.2.m2.3c">i.e.</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p1.2.m2.3d">italic_i . italic_e .</annotation></semantics></math>, CLIP vision encoder, are kept frozen.</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS3">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.3 </span>Reference Information Refinement by Positional-aware Perceiver Resampler</h3>
<div class="ltx_para ltx_noindent" id="S4.SS3.p1">
<p class="ltx_p" id="S4.SS3.p1.9">Following InstantID <cite class="ltx_cite ltx_citemacro_citep">(Wang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib15" title="">2024a</a>)</cite> and IP-adapter <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite>, we utilize two independent resampler modules to transform the facial features, <math alttext="i.e." class="ltx_Math" display="inline" id="S4.SS3.p1.1.m1.3"><semantics id="S4.SS3.p1.1.m1.3a"><mrow id="S4.SS3.p1.1.m1.3.3.1"><mrow id="S4.SS3.p1.1.m1.3.3.1.1.2" xref="S4.SS3.p1.1.m1.3.3.1.1.1.cmml"><mi id="S4.SS3.p1.1.m1.1.1" xref="S4.SS3.p1.1.m1.1.1.cmml">i</mi><mo id="S4.SS3.p1.1.m1.3.3.1.1.2.1" lspace="0em" rspace="0.167em" xref="S4.SS3.p1.1.m1.3.3.1.1.1a.cmml">.</mo><mi id="S4.SS3.p1.1.m1.2.2" xref="S4.SS3.p1.1.m1.2.2.cmml">e</mi></mrow><mo id="S4.SS3.p1.1.m1.3.3.1.2" lspace="0em">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.1.m1.3b"><apply id="S4.SS3.p1.1.m1.3.3.1.1.1.cmml" xref="S4.SS3.p1.1.m1.3.3.1.1.2"><csymbol cd="ambiguous" id="S4.SS3.p1.1.m1.3.3.1.1.1a.cmml" xref="S4.SS3.p1.1.m1.3.3.1.1.2.1">formulae-sequence</csymbol><ci id="S4.SS3.p1.1.m1.1.1.cmml" xref="S4.SS3.p1.1.m1.1.1">𝑖</ci><ci id="S4.SS3.p1.1.m1.2.2.cmml" xref="S4.SS3.p1.1.m1.2.2">𝑒</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.1.m1.3c">i.e.</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.1.m1.3d">italic_i . italic_e .</annotation></semantics></math>, <math alttext="F_{face}" class="ltx_Math" display="inline" id="S4.SS3.p1.2.m2.1"><semantics id="S4.SS3.p1.2.m2.1a"><msub id="S4.SS3.p1.2.m2.1.1" xref="S4.SS3.p1.2.m2.1.1.cmml"><mi id="S4.SS3.p1.2.m2.1.1.2" xref="S4.SS3.p1.2.m2.1.1.2.cmml">F</mi><mrow id="S4.SS3.p1.2.m2.1.1.3" xref="S4.SS3.p1.2.m2.1.1.3.cmml"><mi id="S4.SS3.p1.2.m2.1.1.3.2" xref="S4.SS3.p1.2.m2.1.1.3.2.cmml">f</mi><mo id="S4.SS3.p1.2.m2.1.1.3.1" xref="S4.SS3.p1.2.m2.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.2.m2.1.1.3.3" xref="S4.SS3.p1.2.m2.1.1.3.3.cmml">a</mi><mo id="S4.SS3.p1.2.m2.1.1.3.1a" xref="S4.SS3.p1.2.m2.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.2.m2.1.1.3.4" xref="S4.SS3.p1.2.m2.1.1.3.4.cmml">c</mi><mo id="S4.SS3.p1.2.m2.1.1.3.1b" xref="S4.SS3.p1.2.m2.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.2.m2.1.1.3.5" xref="S4.SS3.p1.2.m2.1.1.3.5.cmml">e</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.2.m2.1b"><apply id="S4.SS3.p1.2.m2.1.1.cmml" xref="S4.SS3.p1.2.m2.1.1"><csymbol cd="ambiguous" id="S4.SS3.p1.2.m2.1.1.1.cmml" xref="S4.SS3.p1.2.m2.1.1">subscript</csymbol><ci id="S4.SS3.p1.2.m2.1.1.2.cmml" xref="S4.SS3.p1.2.m2.1.1.2">𝐹</ci><apply id="S4.SS3.p1.2.m2.1.1.3.cmml" xref="S4.SS3.p1.2.m2.1.1.3"><times id="S4.SS3.p1.2.m2.1.1.3.1.cmml" xref="S4.SS3.p1.2.m2.1.1.3.1"></times><ci id="S4.SS3.p1.2.m2.1.1.3.2.cmml" xref="S4.SS3.p1.2.m2.1.1.3.2">𝑓</ci><ci id="S4.SS3.p1.2.m2.1.1.3.3.cmml" xref="S4.SS3.p1.2.m2.1.1.3.3">𝑎</ci><ci id="S4.SS3.p1.2.m2.1.1.3.4.cmml" xref="S4.SS3.p1.2.m2.1.1.3.4">𝑐</ci><ci id="S4.SS3.p1.2.m2.1.1.3.5.cmml" xref="S4.SS3.p1.2.m2.1.1.3.5">𝑒</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.2.m2.1c">F_{face}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.2.m2.1d">italic_F start_POSTSUBSCRIPT italic_f italic_a italic_c italic_e end_POSTSUBSCRIPT</annotation></semantics></math>, and the character features, <math alttext="i.e." class="ltx_Math" display="inline" id="S4.SS3.p1.3.m3.3"><semantics id="S4.SS3.p1.3.m3.3a"><mrow id="S4.SS3.p1.3.m3.3.3.1"><mrow id="S4.SS3.p1.3.m3.3.3.1.1.2" xref="S4.SS3.p1.3.m3.3.3.1.1.1.cmml"><mi id="S4.SS3.p1.3.m3.1.1" xref="S4.SS3.p1.3.m3.1.1.cmml">i</mi><mo id="S4.SS3.p1.3.m3.3.3.1.1.2.1" lspace="0em" rspace="0.167em" xref="S4.SS3.p1.3.m3.3.3.1.1.1a.cmml">.</mo><mi id="S4.SS3.p1.3.m3.2.2" xref="S4.SS3.p1.3.m3.2.2.cmml">e</mi></mrow><mo id="S4.SS3.p1.3.m3.3.3.1.2" lspace="0em">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.3.m3.3b"><apply id="S4.SS3.p1.3.m3.3.3.1.1.1.cmml" xref="S4.SS3.p1.3.m3.3.3.1.1.2"><csymbol cd="ambiguous" id="S4.SS3.p1.3.m3.3.3.1.1.1a.cmml" xref="S4.SS3.p1.3.m3.3.3.1.1.2.1">formulae-sequence</csymbol><ci id="S4.SS3.p1.3.m3.1.1.cmml" xref="S4.SS3.p1.3.m3.1.1">𝑖</ci><ci id="S4.SS3.p1.3.m3.2.2.cmml" xref="S4.SS3.p1.3.m3.2.2">𝑒</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.3.m3.3c">i.e.</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.3.m3.3d">italic_i . italic_e .</annotation></semantics></math>, <math alttext="F_{character}" class="ltx_Math" display="inline" id="S4.SS3.p1.4.m4.1"><semantics id="S4.SS3.p1.4.m4.1a"><msub id="S4.SS3.p1.4.m4.1.1" xref="S4.SS3.p1.4.m4.1.1.cmml"><mi id="S4.SS3.p1.4.m4.1.1.2" xref="S4.SS3.p1.4.m4.1.1.2.cmml">F</mi><mrow id="S4.SS3.p1.4.m4.1.1.3" xref="S4.SS3.p1.4.m4.1.1.3.cmml"><mi id="S4.SS3.p1.4.m4.1.1.3.2" xref="S4.SS3.p1.4.m4.1.1.3.2.cmml">c</mi><mo id="S4.SS3.p1.4.m4.1.1.3.1" xref="S4.SS3.p1.4.m4.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.4.m4.1.1.3.3" xref="S4.SS3.p1.4.m4.1.1.3.3.cmml">h</mi><mo id="S4.SS3.p1.4.m4.1.1.3.1a" xref="S4.SS3.p1.4.m4.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.4.m4.1.1.3.4" xref="S4.SS3.p1.4.m4.1.1.3.4.cmml">a</mi><mo id="S4.SS3.p1.4.m4.1.1.3.1b" xref="S4.SS3.p1.4.m4.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.4.m4.1.1.3.5" xref="S4.SS3.p1.4.m4.1.1.3.5.cmml">r</mi><mo id="S4.SS3.p1.4.m4.1.1.3.1c" xref="S4.SS3.p1.4.m4.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.4.m4.1.1.3.6" xref="S4.SS3.p1.4.m4.1.1.3.6.cmml">a</mi><mo id="S4.SS3.p1.4.m4.1.1.3.1d" xref="S4.SS3.p1.4.m4.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.4.m4.1.1.3.7" xref="S4.SS3.p1.4.m4.1.1.3.7.cmml">c</mi><mo id="S4.SS3.p1.4.m4.1.1.3.1e" xref="S4.SS3.p1.4.m4.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.4.m4.1.1.3.8" xref="S4.SS3.p1.4.m4.1.1.3.8.cmml">t</mi><mo id="S4.SS3.p1.4.m4.1.1.3.1f" xref="S4.SS3.p1.4.m4.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.4.m4.1.1.3.9" xref="S4.SS3.p1.4.m4.1.1.3.9.cmml">e</mi><mo id="S4.SS3.p1.4.m4.1.1.3.1g" xref="S4.SS3.p1.4.m4.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.4.m4.1.1.3.10" xref="S4.SS3.p1.4.m4.1.1.3.10.cmml">r</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.4.m4.1b"><apply id="S4.SS3.p1.4.m4.1.1.cmml" xref="S4.SS3.p1.4.m4.1.1"><csymbol cd="ambiguous" id="S4.SS3.p1.4.m4.1.1.1.cmml" xref="S4.SS3.p1.4.m4.1.1">subscript</csymbol><ci id="S4.SS3.p1.4.m4.1.1.2.cmml" xref="S4.SS3.p1.4.m4.1.1.2">𝐹</ci><apply id="S4.SS3.p1.4.m4.1.1.3.cmml" xref="S4.SS3.p1.4.m4.1.1.3"><times id="S4.SS3.p1.4.m4.1.1.3.1.cmml" xref="S4.SS3.p1.4.m4.1.1.3.1"></times><ci id="S4.SS3.p1.4.m4.1.1.3.2.cmml" xref="S4.SS3.p1.4.m4.1.1.3.2">𝑐</ci><ci id="S4.SS3.p1.4.m4.1.1.3.3.cmml" xref="S4.SS3.p1.4.m4.1.1.3.3">ℎ</ci><ci id="S4.SS3.p1.4.m4.1.1.3.4.cmml" xref="S4.SS3.p1.4.m4.1.1.3.4">𝑎</ci><ci id="S4.SS3.p1.4.m4.1.1.3.5.cmml" xref="S4.SS3.p1.4.m4.1.1.3.5">𝑟</ci><ci id="S4.SS3.p1.4.m4.1.1.3.6.cmml" xref="S4.SS3.p1.4.m4.1.1.3.6">𝑎</ci><ci id="S4.SS3.p1.4.m4.1.1.3.7.cmml" xref="S4.SS3.p1.4.m4.1.1.3.7">𝑐</ci><ci id="S4.SS3.p1.4.m4.1.1.3.8.cmml" xref="S4.SS3.p1.4.m4.1.1.3.8">𝑡</ci><ci id="S4.SS3.p1.4.m4.1.1.3.9.cmml" xref="S4.SS3.p1.4.m4.1.1.3.9">𝑒</ci><ci id="S4.SS3.p1.4.m4.1.1.3.10.cmml" xref="S4.SS3.p1.4.m4.1.1.3.10">𝑟</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.4.m4.1c">F_{character}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.4.m4.1d">italic_F start_POSTSUBSCRIPT italic_c italic_h italic_a italic_r italic_a italic_c italic_t italic_e italic_r end_POSTSUBSCRIPT</annotation></semantics></math>, into facial embeddings and character embeddings, respectively. These embeddings are concatenated and augmented with positional embeddings, i.e., <math alttext="E_{pos}" class="ltx_Math" display="inline" id="S4.SS3.p1.5.m5.1"><semantics id="S4.SS3.p1.5.m5.1a"><msub id="S4.SS3.p1.5.m5.1.1" xref="S4.SS3.p1.5.m5.1.1.cmml"><mi id="S4.SS3.p1.5.m5.1.1.2" xref="S4.SS3.p1.5.m5.1.1.2.cmml">E</mi><mrow id="S4.SS3.p1.5.m5.1.1.3" xref="S4.SS3.p1.5.m5.1.1.3.cmml"><mi id="S4.SS3.p1.5.m5.1.1.3.2" xref="S4.SS3.p1.5.m5.1.1.3.2.cmml">p</mi><mo id="S4.SS3.p1.5.m5.1.1.3.1" xref="S4.SS3.p1.5.m5.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.5.m5.1.1.3.3" xref="S4.SS3.p1.5.m5.1.1.3.3.cmml">o</mi><mo id="S4.SS3.p1.5.m5.1.1.3.1a" xref="S4.SS3.p1.5.m5.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.5.m5.1.1.3.4" xref="S4.SS3.p1.5.m5.1.1.3.4.cmml">s</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.5.m5.1b"><apply id="S4.SS3.p1.5.m5.1.1.cmml" xref="S4.SS3.p1.5.m5.1.1"><csymbol cd="ambiguous" id="S4.SS3.p1.5.m5.1.1.1.cmml" xref="S4.SS3.p1.5.m5.1.1">subscript</csymbol><ci id="S4.SS3.p1.5.m5.1.1.2.cmml" xref="S4.SS3.p1.5.m5.1.1.2">𝐸</ci><apply id="S4.SS3.p1.5.m5.1.1.3.cmml" xref="S4.SS3.p1.5.m5.1.1.3"><times id="S4.SS3.p1.5.m5.1.1.3.1.cmml" xref="S4.SS3.p1.5.m5.1.1.3.1"></times><ci id="S4.SS3.p1.5.m5.1.1.3.2.cmml" xref="S4.SS3.p1.5.m5.1.1.3.2">𝑝</ci><ci id="S4.SS3.p1.5.m5.1.1.3.3.cmml" xref="S4.SS3.p1.5.m5.1.1.3.3">𝑜</ci><ci id="S4.SS3.p1.5.m5.1.1.3.4.cmml" xref="S4.SS3.p1.5.m5.1.1.3.4">𝑠</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.5.m5.1c">E_{pos}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.5.m5.1d">italic_E start_POSTSUBSCRIPT italic_p italic_o italic_s end_POSTSUBSCRIPT</annotation></semantics></math>, which serve to distinguish different characters. To differentiate the foreground from the background, we introduce a learnable background embedding, <math alttext="i.e." class="ltx_Math" display="inline" id="S4.SS3.p1.6.m6.3"><semantics id="S4.SS3.p1.6.m6.3a"><mrow id="S4.SS3.p1.6.m6.3.3.1"><mrow id="S4.SS3.p1.6.m6.3.3.1.1.2" xref="S4.SS3.p1.6.m6.3.3.1.1.1.cmml"><mi id="S4.SS3.p1.6.m6.1.1" xref="S4.SS3.p1.6.m6.1.1.cmml">i</mi><mo id="S4.SS3.p1.6.m6.3.3.1.1.2.1" lspace="0em" rspace="0.167em" xref="S4.SS3.p1.6.m6.3.3.1.1.1a.cmml">.</mo><mi id="S4.SS3.p1.6.m6.2.2" xref="S4.SS3.p1.6.m6.2.2.cmml">e</mi></mrow><mo id="S4.SS3.p1.6.m6.3.3.1.2" lspace="0em">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.6.m6.3b"><apply id="S4.SS3.p1.6.m6.3.3.1.1.1.cmml" xref="S4.SS3.p1.6.m6.3.3.1.1.2"><csymbol cd="ambiguous" id="S4.SS3.p1.6.m6.3.3.1.1.1a.cmml" xref="S4.SS3.p1.6.m6.3.3.1.1.2.1">formulae-sequence</csymbol><ci id="S4.SS3.p1.6.m6.1.1.cmml" xref="S4.SS3.p1.6.m6.1.1">𝑖</ci><ci id="S4.SS3.p1.6.m6.2.2.cmml" xref="S4.SS3.p1.6.m6.2.2">𝑒</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.6.m6.3c">i.e.</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.6.m6.3d">italic_i . italic_e .</annotation></semantics></math>, <math alttext="E_{bg}" class="ltx_Math" display="inline" id="S4.SS3.p1.7.m7.1"><semantics id="S4.SS3.p1.7.m7.1a"><msub id="S4.SS3.p1.7.m7.1.1" xref="S4.SS3.p1.7.m7.1.1.cmml"><mi id="S4.SS3.p1.7.m7.1.1.2" xref="S4.SS3.p1.7.m7.1.1.2.cmml">E</mi><mrow id="S4.SS3.p1.7.m7.1.1.3" xref="S4.SS3.p1.7.m7.1.1.3.cmml"><mi id="S4.SS3.p1.7.m7.1.1.3.2" xref="S4.SS3.p1.7.m7.1.1.3.2.cmml">b</mi><mo id="S4.SS3.p1.7.m7.1.1.3.1" xref="S4.SS3.p1.7.m7.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.7.m7.1.1.3.3" xref="S4.SS3.p1.7.m7.1.1.3.3.cmml">g</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.7.m7.1b"><apply id="S4.SS3.p1.7.m7.1.1.cmml" xref="S4.SS3.p1.7.m7.1.1"><csymbol cd="ambiguous" id="S4.SS3.p1.7.m7.1.1.1.cmml" xref="S4.SS3.p1.7.m7.1.1">subscript</csymbol><ci id="S4.SS3.p1.7.m7.1.1.2.cmml" xref="S4.SS3.p1.7.m7.1.1.2">𝐸</ci><apply id="S4.SS3.p1.7.m7.1.1.3.cmml" xref="S4.SS3.p1.7.m7.1.1.3"><times id="S4.SS3.p1.7.m7.1.1.3.1.cmml" xref="S4.SS3.p1.7.m7.1.1.3.1"></times><ci id="S4.SS3.p1.7.m7.1.1.3.2.cmml" xref="S4.SS3.p1.7.m7.1.1.3.2">𝑏</ci><ci id="S4.SS3.p1.7.m7.1.1.3.3.cmml" xref="S4.SS3.p1.7.m7.1.1.3.3">𝑔</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.7.m7.1c">E_{bg}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.7.m7.1d">italic_E start_POSTSUBSCRIPT italic_b italic_g end_POSTSUBSCRIPT</annotation></semantics></math> and concatenate it into the final embedding. Denoting the two independent resampler modules as <math alttext="R_{1}" class="ltx_Math" display="inline" id="S4.SS3.p1.8.m8.1"><semantics id="S4.SS3.p1.8.m8.1a"><msub id="S4.SS3.p1.8.m8.1.1" xref="S4.SS3.p1.8.m8.1.1.cmml"><mi id="S4.SS3.p1.8.m8.1.1.2" xref="S4.SS3.p1.8.m8.1.1.2.cmml">R</mi><mn id="S4.SS3.p1.8.m8.1.1.3" xref="S4.SS3.p1.8.m8.1.1.3.cmml">1</mn></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.8.m8.1b"><apply id="S4.SS3.p1.8.m8.1.1.cmml" xref="S4.SS3.p1.8.m8.1.1"><csymbol cd="ambiguous" id="S4.SS3.p1.8.m8.1.1.1.cmml" xref="S4.SS3.p1.8.m8.1.1">subscript</csymbol><ci id="S4.SS3.p1.8.m8.1.1.2.cmml" xref="S4.SS3.p1.8.m8.1.1.2">𝑅</ci><cn id="S4.SS3.p1.8.m8.1.1.3.cmml" type="integer" xref="S4.SS3.p1.8.m8.1.1.3">1</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.8.m8.1c">R_{1}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.8.m8.1d">italic_R start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT</annotation></semantics></math> and <math alttext="R_{2}" class="ltx_Math" display="inline" id="S4.SS3.p1.9.m9.1"><semantics id="S4.SS3.p1.9.m9.1a"><msub id="S4.SS3.p1.9.m9.1.1" xref="S4.SS3.p1.9.m9.1.1.cmml"><mi id="S4.SS3.p1.9.m9.1.1.2" xref="S4.SS3.p1.9.m9.1.1.2.cmml">R</mi><mn id="S4.SS3.p1.9.m9.1.1.3" xref="S4.SS3.p1.9.m9.1.1.3.cmml">2</mn></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.9.m9.1b"><apply id="S4.SS3.p1.9.m9.1.1.cmml" xref="S4.SS3.p1.9.m9.1.1"><csymbol cd="ambiguous" id="S4.SS3.p1.9.m9.1.1.1.cmml" xref="S4.SS3.p1.9.m9.1.1">subscript</csymbol><ci id="S4.SS3.p1.9.m9.1.1.2.cmml" xref="S4.SS3.p1.9.m9.1.1.2">𝑅</ci><cn id="S4.SS3.p1.9.m9.1.1.3.cmml" type="integer" xref="S4.SS3.p1.9.m9.1.1.3">2</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.9.m9.1c">R_{2}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.9.m9.1d">italic_R start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT</annotation></semantics></math>, the Positional-aware Perceiver Resampler is formulated as follows:</p>
<table class="ltx_equationgroup ltx_eqn_align ltx_eqn_table" id="S7.EGx1">
<tbody id="S4.E4"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math alttext="\displaystyle E_{1}" class="ltx_Math" display="inline" id="S4.E4.m1.1"><semantics id="S4.E4.m1.1a"><msub id="S4.E4.m1.1.1" xref="S4.E4.m1.1.1.cmml"><mi id="S4.E4.m1.1.1.2" xref="S4.E4.m1.1.1.2.cmml">E</mi><mn id="S4.E4.m1.1.1.3" xref="S4.E4.m1.1.1.3.cmml">1</mn></msub><annotation-xml encoding="MathML-Content" id="S4.E4.m1.1b"><apply id="S4.E4.m1.1.1.cmml" xref="S4.E4.m1.1.1"><csymbol cd="ambiguous" id="S4.E4.m1.1.1.1.cmml" xref="S4.E4.m1.1.1">subscript</csymbol><ci id="S4.E4.m1.1.1.2.cmml" xref="S4.E4.m1.1.1.2">𝐸</ci><cn id="S4.E4.m1.1.1.3.cmml" type="integer" xref="S4.E4.m1.1.1.3">1</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E4.m1.1c">\displaystyle E_{1}</annotation><annotation encoding="application/x-llamapun" id="S4.E4.m1.1d">italic_E start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT</annotation></semantics></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle=R_{1}(F_{face})" class="ltx_Math" display="inline" id="S4.E4.m2.1"><semantics id="S4.E4.m2.1a"><mrow id="S4.E4.m2.1.1" xref="S4.E4.m2.1.1.cmml"><mi id="S4.E4.m2.1.1.3" xref="S4.E4.m2.1.1.3.cmml"></mi><mo id="S4.E4.m2.1.1.2" xref="S4.E4.m2.1.1.2.cmml">=</mo><mrow id="S4.E4.m2.1.1.1" xref="S4.E4.m2.1.1.1.cmml"><msub id="S4.E4.m2.1.1.1.3" xref="S4.E4.m2.1.1.1.3.cmml"><mi id="S4.E4.m2.1.1.1.3.2" xref="S4.E4.m2.1.1.1.3.2.cmml">R</mi><mn id="S4.E4.m2.1.1.1.3.3" xref="S4.E4.m2.1.1.1.3.3.cmml">1</mn></msub><mo id="S4.E4.m2.1.1.1.2" xref="S4.E4.m2.1.1.1.2.cmml">⁢</mo><mrow id="S4.E4.m2.1.1.1.1.1" xref="S4.E4.m2.1.1.1.1.1.1.cmml"><mo id="S4.E4.m2.1.1.1.1.1.2" stretchy="false" xref="S4.E4.m2.1.1.1.1.1.1.cmml">(</mo><msub id="S4.E4.m2.1.1.1.1.1.1" xref="S4.E4.m2.1.1.1.1.1.1.cmml"><mi id="S4.E4.m2.1.1.1.1.1.1.2" xref="S4.E4.m2.1.1.1.1.1.1.2.cmml">F</mi><mrow id="S4.E4.m2.1.1.1.1.1.1.3" xref="S4.E4.m2.1.1.1.1.1.1.3.cmml"><mi id="S4.E4.m2.1.1.1.1.1.1.3.2" xref="S4.E4.m2.1.1.1.1.1.1.3.2.cmml">f</mi><mo id="S4.E4.m2.1.1.1.1.1.1.3.1" xref="S4.E4.m2.1.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.E4.m2.1.1.1.1.1.1.3.3" xref="S4.E4.m2.1.1.1.1.1.1.3.3.cmml">a</mi><mo id="S4.E4.m2.1.1.1.1.1.1.3.1a" xref="S4.E4.m2.1.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.E4.m2.1.1.1.1.1.1.3.4" xref="S4.E4.m2.1.1.1.1.1.1.3.4.cmml">c</mi><mo id="S4.E4.m2.1.1.1.1.1.1.3.1b" xref="S4.E4.m2.1.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.E4.m2.1.1.1.1.1.1.3.5" xref="S4.E4.m2.1.1.1.1.1.1.3.5.cmml">e</mi></mrow></msub><mo id="S4.E4.m2.1.1.1.1.1.3" stretchy="false" xref="S4.E4.m2.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E4.m2.1b"><apply id="S4.E4.m2.1.1.cmml" xref="S4.E4.m2.1.1"><eq id="S4.E4.m2.1.1.2.cmml" xref="S4.E4.m2.1.1.2"></eq><csymbol cd="latexml" id="S4.E4.m2.1.1.3.cmml" xref="S4.E4.m2.1.1.3">absent</csymbol><apply id="S4.E4.m2.1.1.1.cmml" xref="S4.E4.m2.1.1.1"><times id="S4.E4.m2.1.1.1.2.cmml" xref="S4.E4.m2.1.1.1.2"></times><apply id="S4.E4.m2.1.1.1.3.cmml" xref="S4.E4.m2.1.1.1.3"><csymbol cd="ambiguous" id="S4.E4.m2.1.1.1.3.1.cmml" xref="S4.E4.m2.1.1.1.3">subscript</csymbol><ci id="S4.E4.m2.1.1.1.3.2.cmml" xref="S4.E4.m2.1.1.1.3.2">𝑅</ci><cn id="S4.E4.m2.1.1.1.3.3.cmml" type="integer" xref="S4.E4.m2.1.1.1.3.3">1</cn></apply><apply id="S4.E4.m2.1.1.1.1.1.1.cmml" xref="S4.E4.m2.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.E4.m2.1.1.1.1.1.1.1.cmml" xref="S4.E4.m2.1.1.1.1.1">subscript</csymbol><ci id="S4.E4.m2.1.1.1.1.1.1.2.cmml" xref="S4.E4.m2.1.1.1.1.1.1.2">𝐹</ci><apply id="S4.E4.m2.1.1.1.1.1.1.3.cmml" xref="S4.E4.m2.1.1.1.1.1.1.3"><times id="S4.E4.m2.1.1.1.1.1.1.3.1.cmml" xref="S4.E4.m2.1.1.1.1.1.1.3.1"></times><ci id="S4.E4.m2.1.1.1.1.1.1.3.2.cmml" xref="S4.E4.m2.1.1.1.1.1.1.3.2">𝑓</ci><ci id="S4.E4.m2.1.1.1.1.1.1.3.3.cmml" xref="S4.E4.m2.1.1.1.1.1.1.3.3">𝑎</ci><ci id="S4.E4.m2.1.1.1.1.1.1.3.4.cmml" xref="S4.E4.m2.1.1.1.1.1.1.3.4">𝑐</ci><ci id="S4.E4.m2.1.1.1.1.1.1.3.5.cmml" xref="S4.E4.m2.1.1.1.1.1.1.3.5">𝑒</ci></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E4.m2.1c">\displaystyle=R_{1}(F_{face})</annotation><annotation encoding="application/x-llamapun" id="S4.E4.m2.1d">= italic_R start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT ( italic_F start_POSTSUBSCRIPT italic_f italic_a italic_c italic_e end_POSTSUBSCRIPT )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(4)</span></td>
</tr></tbody>
<tbody id="S4.E5"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math alttext="\displaystyle E_{2}" class="ltx_Math" display="inline" id="S4.E5.m1.1"><semantics id="S4.E5.m1.1a"><msub id="S4.E5.m1.1.1" xref="S4.E5.m1.1.1.cmml"><mi id="S4.E5.m1.1.1.2" xref="S4.E5.m1.1.1.2.cmml">E</mi><mn id="S4.E5.m1.1.1.3" xref="S4.E5.m1.1.1.3.cmml">2</mn></msub><annotation-xml encoding="MathML-Content" id="S4.E5.m1.1b"><apply id="S4.E5.m1.1.1.cmml" xref="S4.E5.m1.1.1"><csymbol cd="ambiguous" id="S4.E5.m1.1.1.1.cmml" xref="S4.E5.m1.1.1">subscript</csymbol><ci id="S4.E5.m1.1.1.2.cmml" xref="S4.E5.m1.1.1.2">𝐸</ci><cn id="S4.E5.m1.1.1.3.cmml" type="integer" xref="S4.E5.m1.1.1.3">2</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E5.m1.1c">\displaystyle E_{2}</annotation><annotation encoding="application/x-llamapun" id="S4.E5.m1.1d">italic_E start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT</annotation></semantics></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle=R_{2}(F_{character})" class="ltx_Math" display="inline" id="S4.E5.m2.1"><semantics id="S4.E5.m2.1a"><mrow id="S4.E5.m2.1.1" xref="S4.E5.m2.1.1.cmml"><mi id="S4.E5.m2.1.1.3" xref="S4.E5.m2.1.1.3.cmml"></mi><mo id="S4.E5.m2.1.1.2" xref="S4.E5.m2.1.1.2.cmml">=</mo><mrow id="S4.E5.m2.1.1.1" xref="S4.E5.m2.1.1.1.cmml"><msub id="S4.E5.m2.1.1.1.3" xref="S4.E5.m2.1.1.1.3.cmml"><mi id="S4.E5.m2.1.1.1.3.2" xref="S4.E5.m2.1.1.1.3.2.cmml">R</mi><mn id="S4.E5.m2.1.1.1.3.3" xref="S4.E5.m2.1.1.1.3.3.cmml">2</mn></msub><mo id="S4.E5.m2.1.1.1.2" xref="S4.E5.m2.1.1.1.2.cmml">⁢</mo><mrow id="S4.E5.m2.1.1.1.1.1" xref="S4.E5.m2.1.1.1.1.1.1.cmml"><mo id="S4.E5.m2.1.1.1.1.1.2" stretchy="false" xref="S4.E5.m2.1.1.1.1.1.1.cmml">(</mo><msub id="S4.E5.m2.1.1.1.1.1.1" xref="S4.E5.m2.1.1.1.1.1.1.cmml"><mi id="S4.E5.m2.1.1.1.1.1.1.2" xref="S4.E5.m2.1.1.1.1.1.1.2.cmml">F</mi><mrow id="S4.E5.m2.1.1.1.1.1.1.3" xref="S4.E5.m2.1.1.1.1.1.1.3.cmml"><mi id="S4.E5.m2.1.1.1.1.1.1.3.2" xref="S4.E5.m2.1.1.1.1.1.1.3.2.cmml">c</mi><mo id="S4.E5.m2.1.1.1.1.1.1.3.1" xref="S4.E5.m2.1.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.E5.m2.1.1.1.1.1.1.3.3" xref="S4.E5.m2.1.1.1.1.1.1.3.3.cmml">h</mi><mo id="S4.E5.m2.1.1.1.1.1.1.3.1a" xref="S4.E5.m2.1.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.E5.m2.1.1.1.1.1.1.3.4" xref="S4.E5.m2.1.1.1.1.1.1.3.4.cmml">a</mi><mo id="S4.E5.m2.1.1.1.1.1.1.3.1b" xref="S4.E5.m2.1.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.E5.m2.1.1.1.1.1.1.3.5" xref="S4.E5.m2.1.1.1.1.1.1.3.5.cmml">r</mi><mo id="S4.E5.m2.1.1.1.1.1.1.3.1c" xref="S4.E5.m2.1.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.E5.m2.1.1.1.1.1.1.3.6" xref="S4.E5.m2.1.1.1.1.1.1.3.6.cmml">a</mi><mo id="S4.E5.m2.1.1.1.1.1.1.3.1d" xref="S4.E5.m2.1.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.E5.m2.1.1.1.1.1.1.3.7" xref="S4.E5.m2.1.1.1.1.1.1.3.7.cmml">c</mi><mo id="S4.E5.m2.1.1.1.1.1.1.3.1e" xref="S4.E5.m2.1.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.E5.m2.1.1.1.1.1.1.3.8" xref="S4.E5.m2.1.1.1.1.1.1.3.8.cmml">t</mi><mo id="S4.E5.m2.1.1.1.1.1.1.3.1f" xref="S4.E5.m2.1.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.E5.m2.1.1.1.1.1.1.3.9" xref="S4.E5.m2.1.1.1.1.1.1.3.9.cmml">e</mi><mo id="S4.E5.m2.1.1.1.1.1.1.3.1g" xref="S4.E5.m2.1.1.1.1.1.1.3.1.cmml">⁢</mo><mi id="S4.E5.m2.1.1.1.1.1.1.3.10" xref="S4.E5.m2.1.1.1.1.1.1.3.10.cmml">r</mi></mrow></msub><mo id="S4.E5.m2.1.1.1.1.1.3" stretchy="false" xref="S4.E5.m2.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E5.m2.1b"><apply id="S4.E5.m2.1.1.cmml" xref="S4.E5.m2.1.1"><eq id="S4.E5.m2.1.1.2.cmml" xref="S4.E5.m2.1.1.2"></eq><csymbol cd="latexml" id="S4.E5.m2.1.1.3.cmml" xref="S4.E5.m2.1.1.3">absent</csymbol><apply id="S4.E5.m2.1.1.1.cmml" xref="S4.E5.m2.1.1.1"><times id="S4.E5.m2.1.1.1.2.cmml" xref="S4.E5.m2.1.1.1.2"></times><apply id="S4.E5.m2.1.1.1.3.cmml" xref="S4.E5.m2.1.1.1.3"><csymbol cd="ambiguous" id="S4.E5.m2.1.1.1.3.1.cmml" xref="S4.E5.m2.1.1.1.3">subscript</csymbol><ci id="S4.E5.m2.1.1.1.3.2.cmml" xref="S4.E5.m2.1.1.1.3.2">𝑅</ci><cn id="S4.E5.m2.1.1.1.3.3.cmml" type="integer" xref="S4.E5.m2.1.1.1.3.3">2</cn></apply><apply id="S4.E5.m2.1.1.1.1.1.1.cmml" xref="S4.E5.m2.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.E5.m2.1.1.1.1.1.1.1.cmml" xref="S4.E5.m2.1.1.1.1.1">subscript</csymbol><ci id="S4.E5.m2.1.1.1.1.1.1.2.cmml" xref="S4.E5.m2.1.1.1.1.1.1.2">𝐹</ci><apply id="S4.E5.m2.1.1.1.1.1.1.3.cmml" xref="S4.E5.m2.1.1.1.1.1.1.3"><times id="S4.E5.m2.1.1.1.1.1.1.3.1.cmml" xref="S4.E5.m2.1.1.1.1.1.1.3.1"></times><ci id="S4.E5.m2.1.1.1.1.1.1.3.2.cmml" xref="S4.E5.m2.1.1.1.1.1.1.3.2">𝑐</ci><ci id="S4.E5.m2.1.1.1.1.1.1.3.3.cmml" xref="S4.E5.m2.1.1.1.1.1.1.3.3">ℎ</ci><ci id="S4.E5.m2.1.1.1.1.1.1.3.4.cmml" xref="S4.E5.m2.1.1.1.1.1.1.3.4">𝑎</ci><ci id="S4.E5.m2.1.1.1.1.1.1.3.5.cmml" xref="S4.E5.m2.1.1.1.1.1.1.3.5">𝑟</ci><ci id="S4.E5.m2.1.1.1.1.1.1.3.6.cmml" xref="S4.E5.m2.1.1.1.1.1.1.3.6">𝑎</ci><ci id="S4.E5.m2.1.1.1.1.1.1.3.7.cmml" xref="S4.E5.m2.1.1.1.1.1.1.3.7">𝑐</ci><ci id="S4.E5.m2.1.1.1.1.1.1.3.8.cmml" xref="S4.E5.m2.1.1.1.1.1.1.3.8">𝑡</ci><ci id="S4.E5.m2.1.1.1.1.1.1.3.9.cmml" xref="S4.E5.m2.1.1.1.1.1.1.3.9">𝑒</ci><ci id="S4.E5.m2.1.1.1.1.1.1.3.10.cmml" xref="S4.E5.m2.1.1.1.1.1.1.3.10">𝑟</ci></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E5.m2.1c">\displaystyle=R_{2}(F_{character})</annotation><annotation encoding="application/x-llamapun" id="S4.E5.m2.1d">= italic_R start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT ( italic_F start_POSTSUBSCRIPT italic_c italic_h italic_a italic_r italic_a italic_c italic_t italic_e italic_r end_POSTSUBSCRIPT )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(5)</span></td>
</tr></tbody>
<tbody id="S4.E6"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math alttext="\displaystyle E_{i}" class="ltx_Math" display="inline" id="S4.E6.m1.1"><semantics id="S4.E6.m1.1a"><msub id="S4.E6.m1.1.1" xref="S4.E6.m1.1.1.cmml"><mi id="S4.E6.m1.1.1.2" xref="S4.E6.m1.1.1.2.cmml">E</mi><mi id="S4.E6.m1.1.1.3" xref="S4.E6.m1.1.1.3.cmml">i</mi></msub><annotation-xml encoding="MathML-Content" id="S4.E6.m1.1b"><apply id="S4.E6.m1.1.1.cmml" xref="S4.E6.m1.1.1"><csymbol cd="ambiguous" id="S4.E6.m1.1.1.1.cmml" xref="S4.E6.m1.1.1">subscript</csymbol><ci id="S4.E6.m1.1.1.2.cmml" xref="S4.E6.m1.1.1.2">𝐸</ci><ci id="S4.E6.m1.1.1.3.cmml" xref="S4.E6.m1.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E6.m1.1c">\displaystyle E_{i}</annotation><annotation encoding="application/x-llamapun" id="S4.E6.m1.1d">italic_E start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle=MLP(Cat(E_{1},E_{2})+E_{pos})" class="ltx_Math" display="inline" id="S4.E6.m2.1"><semantics id="S4.E6.m2.1a"><mrow id="S4.E6.m2.1.1" xref="S4.E6.m2.1.1.cmml"><mi id="S4.E6.m2.1.1.3" xref="S4.E6.m2.1.1.3.cmml"></mi><mo id="S4.E6.m2.1.1.2" xref="S4.E6.m2.1.1.2.cmml">=</mo><mrow id="S4.E6.m2.1.1.1" xref="S4.E6.m2.1.1.1.cmml"><mi id="S4.E6.m2.1.1.1.3" xref="S4.E6.m2.1.1.1.3.cmml">M</mi><mo id="S4.E6.m2.1.1.1.2" xref="S4.E6.m2.1.1.1.2.cmml">⁢</mo><mi id="S4.E6.m2.1.1.1.4" xref="S4.E6.m2.1.1.1.4.cmml">L</mi><mo id="S4.E6.m2.1.1.1.2a" xref="S4.E6.m2.1.1.1.2.cmml">⁢</mo><mi id="S4.E6.m2.1.1.1.5" xref="S4.E6.m2.1.1.1.5.cmml">P</mi><mo id="S4.E6.m2.1.1.1.2b" xref="S4.E6.m2.1.1.1.2.cmml">⁢</mo><mrow id="S4.E6.m2.1.1.1.1.1" xref="S4.E6.m2.1.1.1.1.1.1.cmml"><mo id="S4.E6.m2.1.1.1.1.1.2" stretchy="false" xref="S4.E6.m2.1.1.1.1.1.1.cmml">(</mo><mrow id="S4.E6.m2.1.1.1.1.1.1" xref="S4.E6.m2.1.1.1.1.1.1.cmml"><mrow id="S4.E6.m2.1.1.1.1.1.1.2" xref="S4.E6.m2.1.1.1.1.1.1.2.cmml"><mi id="S4.E6.m2.1.1.1.1.1.1.2.4" xref="S4.E6.m2.1.1.1.1.1.1.2.4.cmml">C</mi><mo id="S4.E6.m2.1.1.1.1.1.1.2.3" xref="S4.E6.m2.1.1.1.1.1.1.2.3.cmml">⁢</mo><mi id="S4.E6.m2.1.1.1.1.1.1.2.5" xref="S4.E6.m2.1.1.1.1.1.1.2.5.cmml">a</mi><mo id="S4.E6.m2.1.1.1.1.1.1.2.3a" xref="S4.E6.m2.1.1.1.1.1.1.2.3.cmml">⁢</mo><mi id="S4.E6.m2.1.1.1.1.1.1.2.6" xref="S4.E6.m2.1.1.1.1.1.1.2.6.cmml">t</mi><mo id="S4.E6.m2.1.1.1.1.1.1.2.3b" xref="S4.E6.m2.1.1.1.1.1.1.2.3.cmml">⁢</mo><mrow id="S4.E6.m2.1.1.1.1.1.1.2.2.2" xref="S4.E6.m2.1.1.1.1.1.1.2.2.3.cmml"><mo id="S4.E6.m2.1.1.1.1.1.1.2.2.2.3" stretchy="false" xref="S4.E6.m2.1.1.1.1.1.1.2.2.3.cmml">(</mo><msub id="S4.E6.m2.1.1.1.1.1.1.1.1.1.1" xref="S4.E6.m2.1.1.1.1.1.1.1.1.1.1.cmml"><mi id="S4.E6.m2.1.1.1.1.1.1.1.1.1.1.2" xref="S4.E6.m2.1.1.1.1.1.1.1.1.1.1.2.cmml">E</mi><mn id="S4.E6.m2.1.1.1.1.1.1.1.1.1.1.3" xref="S4.E6.m2.1.1.1.1.1.1.1.1.1.1.3.cmml">1</mn></msub><mo id="S4.E6.m2.1.1.1.1.1.1.2.2.2.4" xref="S4.E6.m2.1.1.1.1.1.1.2.2.3.cmml">,</mo><msub id="S4.E6.m2.1.1.1.1.1.1.2.2.2.2" xref="S4.E6.m2.1.1.1.1.1.1.2.2.2.2.cmml"><mi id="S4.E6.m2.1.1.1.1.1.1.2.2.2.2.2" xref="S4.E6.m2.1.1.1.1.1.1.2.2.2.2.2.cmml">E</mi><mn id="S4.E6.m2.1.1.1.1.1.1.2.2.2.2.3" xref="S4.E6.m2.1.1.1.1.1.1.2.2.2.2.3.cmml">2</mn></msub><mo id="S4.E6.m2.1.1.1.1.1.1.2.2.2.5" stretchy="false" xref="S4.E6.m2.1.1.1.1.1.1.2.2.3.cmml">)</mo></mrow></mrow><mo id="S4.E6.m2.1.1.1.1.1.1.3" xref="S4.E6.m2.1.1.1.1.1.1.3.cmml">+</mo><msub id="S4.E6.m2.1.1.1.1.1.1.4" xref="S4.E6.m2.1.1.1.1.1.1.4.cmml"><mi id="S4.E6.m2.1.1.1.1.1.1.4.2" xref="S4.E6.m2.1.1.1.1.1.1.4.2.cmml">E</mi><mrow id="S4.E6.m2.1.1.1.1.1.1.4.3" xref="S4.E6.m2.1.1.1.1.1.1.4.3.cmml"><mi id="S4.E6.m2.1.1.1.1.1.1.4.3.2" xref="S4.E6.m2.1.1.1.1.1.1.4.3.2.cmml">p</mi><mo id="S4.E6.m2.1.1.1.1.1.1.4.3.1" xref="S4.E6.m2.1.1.1.1.1.1.4.3.1.cmml">⁢</mo><mi id="S4.E6.m2.1.1.1.1.1.1.4.3.3" xref="S4.E6.m2.1.1.1.1.1.1.4.3.3.cmml">o</mi><mo id="S4.E6.m2.1.1.1.1.1.1.4.3.1a" xref="S4.E6.m2.1.1.1.1.1.1.4.3.1.cmml">⁢</mo><mi id="S4.E6.m2.1.1.1.1.1.1.4.3.4" xref="S4.E6.m2.1.1.1.1.1.1.4.3.4.cmml">s</mi></mrow></msub></mrow><mo id="S4.E6.m2.1.1.1.1.1.3" stretchy="false" xref="S4.E6.m2.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E6.m2.1b"><apply id="S4.E6.m2.1.1.cmml" xref="S4.E6.m2.1.1"><eq id="S4.E6.m2.1.1.2.cmml" xref="S4.E6.m2.1.1.2"></eq><csymbol cd="latexml" id="S4.E6.m2.1.1.3.cmml" xref="S4.E6.m2.1.1.3">absent</csymbol><apply id="S4.E6.m2.1.1.1.cmml" xref="S4.E6.m2.1.1.1"><times id="S4.E6.m2.1.1.1.2.cmml" xref="S4.E6.m2.1.1.1.2"></times><ci id="S4.E6.m2.1.1.1.3.cmml" xref="S4.E6.m2.1.1.1.3">𝑀</ci><ci id="S4.E6.m2.1.1.1.4.cmml" xref="S4.E6.m2.1.1.1.4">𝐿</ci><ci id="S4.E6.m2.1.1.1.5.cmml" xref="S4.E6.m2.1.1.1.5">𝑃</ci><apply id="S4.E6.m2.1.1.1.1.1.1.cmml" xref="S4.E6.m2.1.1.1.1.1"><plus id="S4.E6.m2.1.1.1.1.1.1.3.cmml" xref="S4.E6.m2.1.1.1.1.1.1.3"></plus><apply id="S4.E6.m2.1.1.1.1.1.1.2.cmml" xref="S4.E6.m2.1.1.1.1.1.1.2"><times id="S4.E6.m2.1.1.1.1.1.1.2.3.cmml" xref="S4.E6.m2.1.1.1.1.1.1.2.3"></times><ci id="S4.E6.m2.1.1.1.1.1.1.2.4.cmml" xref="S4.E6.m2.1.1.1.1.1.1.2.4">𝐶</ci><ci id="S4.E6.m2.1.1.1.1.1.1.2.5.cmml" xref="S4.E6.m2.1.1.1.1.1.1.2.5">𝑎</ci><ci id="S4.E6.m2.1.1.1.1.1.1.2.6.cmml" xref="S4.E6.m2.1.1.1.1.1.1.2.6">𝑡</ci><interval closure="open" id="S4.E6.m2.1.1.1.1.1.1.2.2.3.cmml" xref="S4.E6.m2.1.1.1.1.1.1.2.2.2"><apply id="S4.E6.m2.1.1.1.1.1.1.1.1.1.1.cmml" xref="S4.E6.m2.1.1.1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.E6.m2.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S4.E6.m2.1.1.1.1.1.1.1.1.1.1">subscript</csymbol><ci id="S4.E6.m2.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S4.E6.m2.1.1.1.1.1.1.1.1.1.1.2">𝐸</ci><cn id="S4.E6.m2.1.1.1.1.1.1.1.1.1.1.3.cmml" type="integer" xref="S4.E6.m2.1.1.1.1.1.1.1.1.1.1.3">1</cn></apply><apply id="S4.E6.m2.1.1.1.1.1.1.2.2.2.2.cmml" xref="S4.E6.m2.1.1.1.1.1.1.2.2.2.2"><csymbol cd="ambiguous" id="S4.E6.m2.1.1.1.1.1.1.2.2.2.2.1.cmml" xref="S4.E6.m2.1.1.1.1.1.1.2.2.2.2">subscript</csymbol><ci id="S4.E6.m2.1.1.1.1.1.1.2.2.2.2.2.cmml" xref="S4.E6.m2.1.1.1.1.1.1.2.2.2.2.2">𝐸</ci><cn id="S4.E6.m2.1.1.1.1.1.1.2.2.2.2.3.cmml" type="integer" xref="S4.E6.m2.1.1.1.1.1.1.2.2.2.2.3">2</cn></apply></interval></apply><apply id="S4.E6.m2.1.1.1.1.1.1.4.cmml" xref="S4.E6.m2.1.1.1.1.1.1.4"><csymbol cd="ambiguous" id="S4.E6.m2.1.1.1.1.1.1.4.1.cmml" xref="S4.E6.m2.1.1.1.1.1.1.4">subscript</csymbol><ci id="S4.E6.m2.1.1.1.1.1.1.4.2.cmml" xref="S4.E6.m2.1.1.1.1.1.1.4.2">𝐸</ci><apply id="S4.E6.m2.1.1.1.1.1.1.4.3.cmml" xref="S4.E6.m2.1.1.1.1.1.1.4.3"><times id="S4.E6.m2.1.1.1.1.1.1.4.3.1.cmml" xref="S4.E6.m2.1.1.1.1.1.1.4.3.1"></times><ci id="S4.E6.m2.1.1.1.1.1.1.4.3.2.cmml" xref="S4.E6.m2.1.1.1.1.1.1.4.3.2">𝑝</ci><ci id="S4.E6.m2.1.1.1.1.1.1.4.3.3.cmml" xref="S4.E6.m2.1.1.1.1.1.1.4.3.3">𝑜</ci><ci id="S4.E6.m2.1.1.1.1.1.1.4.3.4.cmml" xref="S4.E6.m2.1.1.1.1.1.1.4.3.4">𝑠</ci></apply></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E6.m2.1c">\displaystyle=MLP(Cat(E_{1},E_{2})+E_{pos})</annotation><annotation encoding="application/x-llamapun" id="S4.E6.m2.1d">= italic_M italic_L italic_P ( italic_C italic_a italic_t ( italic_E start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , italic_E start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT ) + italic_E start_POSTSUBSCRIPT italic_p italic_o italic_s end_POSTSUBSCRIPT )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(6)</span></td>
</tr></tbody>
<tbody id="S4.E7"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math alttext="\displaystyle c_{i}" class="ltx_Math" display="inline" id="S4.E7.m1.1"><semantics id="S4.E7.m1.1a"><msub id="S4.E7.m1.1.1" xref="S4.E7.m1.1.1.cmml"><mi id="S4.E7.m1.1.1.2" xref="S4.E7.m1.1.1.2.cmml">c</mi><mi id="S4.E7.m1.1.1.3" xref="S4.E7.m1.1.1.3.cmml">i</mi></msub><annotation-xml encoding="MathML-Content" id="S4.E7.m1.1b"><apply id="S4.E7.m1.1.1.cmml" xref="S4.E7.m1.1.1"><csymbol cd="ambiguous" id="S4.E7.m1.1.1.1.cmml" xref="S4.E7.m1.1.1">subscript</csymbol><ci id="S4.E7.m1.1.1.2.cmml" xref="S4.E7.m1.1.1.2">𝑐</ci><ci id="S4.E7.m1.1.1.3.cmml" xref="S4.E7.m1.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E7.m1.1c">\displaystyle c_{i}</annotation><annotation encoding="application/x-llamapun" id="S4.E7.m1.1d">italic_c start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle=Cat(E_{bg},Reshape(E_{i},(N\ast{L},D))" class="ltx_math_unparsed" display="inline" id="S4.E7.m2.1"><semantics id="S4.E7.m2.1a"><mrow id="S4.E7.m2.1b"><mo id="S4.E7.m2.1.2">=</mo><mi id="S4.E7.m2.1.3">C</mi><mi id="S4.E7.m2.1.4">a</mi><mi id="S4.E7.m2.1.5">t</mi><mrow id="S4.E7.m2.1.6"><mo id="S4.E7.m2.1.6.1" stretchy="false">(</mo><msub id="S4.E7.m2.1.6.2"><mi id="S4.E7.m2.1.6.2.2">E</mi><mrow id="S4.E7.m2.1.6.2.3"><mi id="S4.E7.m2.1.6.2.3.2">b</mi><mo id="S4.E7.m2.1.6.2.3.1">⁢</mo><mi id="S4.E7.m2.1.6.2.3.3">g</mi></mrow></msub><mo id="S4.E7.m2.1.6.3">,</mo><mi id="S4.E7.m2.1.6.4">R</mi><mi id="S4.E7.m2.1.6.5">e</mi><mi id="S4.E7.m2.1.6.6">s</mi><mi id="S4.E7.m2.1.6.7">h</mi><mi id="S4.E7.m2.1.6.8">a</mi><mi id="S4.E7.m2.1.6.9">p</mi><mi id="S4.E7.m2.1.6.10">e</mi><mrow id="S4.E7.m2.1.6.11"><mo id="S4.E7.m2.1.6.11.1" stretchy="false">(</mo><msub id="S4.E7.m2.1.6.11.2"><mi id="S4.E7.m2.1.6.11.2.2">E</mi><mi id="S4.E7.m2.1.6.11.2.3">i</mi></msub><mo id="S4.E7.m2.1.6.11.3">,</mo><mrow id="S4.E7.m2.1.6.11.4"><mo id="S4.E7.m2.1.6.11.4.1" stretchy="false">(</mo><mi id="S4.E7.m2.1.6.11.4.2">N</mi><mo id="S4.E7.m2.1.6.11.4.3" lspace="0.222em" rspace="0.222em">∗</mo><mi id="S4.E7.m2.1.6.11.4.4">L</mi><mo id="S4.E7.m2.1.6.11.4.5">,</mo><mi id="S4.E7.m2.1.1">D</mi><mo id="S4.E7.m2.1.6.11.4.6" stretchy="false">)</mo></mrow><mo id="S4.E7.m2.1.6.11.5" stretchy="false">)</mo></mrow></mrow></mrow><annotation encoding="application/x-tex" id="S4.E7.m2.1c">\displaystyle=Cat(E_{bg},Reshape(E_{i},(N\ast{L},D))</annotation><annotation encoding="application/x-llamapun" id="S4.E7.m2.1d">= italic_C italic_a italic_t ( italic_E start_POSTSUBSCRIPT italic_b italic_g end_POSTSUBSCRIPT , italic_R italic_e italic_s italic_h italic_a italic_p italic_e ( italic_E start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT , ( italic_N ∗ italic_L , italic_D ) )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(7)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS3.p1.16">where <math alttext="L" class="ltx_Math" display="inline" id="S4.SS3.p1.10.m1.1"><semantics id="S4.SS3.p1.10.m1.1a"><mi id="S4.SS3.p1.10.m1.1.1" xref="S4.SS3.p1.10.m1.1.1.cmml">L</mi><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.10.m1.1b"><ci id="S4.SS3.p1.10.m1.1.1.cmml" xref="S4.SS3.p1.10.m1.1.1">𝐿</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.10.m1.1c">L</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.10.m1.1d">italic_L</annotation></semantics></math> represent the number of tokens and the dimension of the character embeddings, respectively, and <math alttext="N" class="ltx_Math" display="inline" id="S4.SS3.p1.11.m2.1"><semantics id="S4.SS3.p1.11.m2.1a"><mi id="S4.SS3.p1.11.m2.1.1" xref="S4.SS3.p1.11.m2.1.1.cmml">N</mi><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.11.m2.1b"><ci id="S4.SS3.p1.11.m2.1.1.cmml" xref="S4.SS3.p1.11.m2.1.1">𝑁</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.11.m2.1c">N</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.11.m2.1d">italic_N</annotation></semantics></math> denotes the number of characters in the reference image. The image prompt embed for image cross-attention is <math alttext="c_{i}" class="ltx_Math" display="inline" id="S4.SS3.p1.12.m3.1"><semantics id="S4.SS3.p1.12.m3.1a"><msub id="S4.SS3.p1.12.m3.1.1" xref="S4.SS3.p1.12.m3.1.1.cmml"><mi id="S4.SS3.p1.12.m3.1.1.2" xref="S4.SS3.p1.12.m3.1.1.2.cmml">c</mi><mi id="S4.SS3.p1.12.m3.1.1.3" xref="S4.SS3.p1.12.m3.1.1.3.cmml">i</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.12.m3.1b"><apply id="S4.SS3.p1.12.m3.1.1.cmml" xref="S4.SS3.p1.12.m3.1.1"><csymbol cd="ambiguous" id="S4.SS3.p1.12.m3.1.1.1.cmml" xref="S4.SS3.p1.12.m3.1.1">subscript</csymbol><ci id="S4.SS3.p1.12.m3.1.1.2.cmml" xref="S4.SS3.p1.12.m3.1.1.2">𝑐</ci><ci id="S4.SS3.p1.12.m3.1.1.3.cmml" xref="S4.SS3.p1.12.m3.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.12.m3.1c">c_{i}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.12.m3.1d">italic_c start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math>. We denote the <math alttext="L" class="ltx_Math" display="inline" id="S4.SS3.p1.13.m4.1"><semantics id="S4.SS3.p1.13.m4.1a"><mi id="S4.SS3.p1.13.m4.1.1" xref="S4.SS3.p1.13.m4.1.1.cmml">L</mi><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.13.m4.1b"><ci id="S4.SS3.p1.13.m4.1.1.cmml" xref="S4.SS3.p1.13.m4.1.1">𝐿</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.13.m4.1c">L</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.13.m4.1d">italic_L</annotation></semantics></math> tokens of the background embedding as <math alttext="E_{bg}" class="ltx_Math" display="inline" id="S4.SS3.p1.14.m5.1"><semantics id="S4.SS3.p1.14.m5.1a"><msub id="S4.SS3.p1.14.m5.1.1" xref="S4.SS3.p1.14.m5.1.1.cmml"><mi id="S4.SS3.p1.14.m5.1.1.2" xref="S4.SS3.p1.14.m5.1.1.2.cmml">E</mi><mrow id="S4.SS3.p1.14.m5.1.1.3" xref="S4.SS3.p1.14.m5.1.1.3.cmml"><mi id="S4.SS3.p1.14.m5.1.1.3.2" xref="S4.SS3.p1.14.m5.1.1.3.2.cmml">b</mi><mo id="S4.SS3.p1.14.m5.1.1.3.1" xref="S4.SS3.p1.14.m5.1.1.3.1.cmml">⁢</mo><mi id="S4.SS3.p1.14.m5.1.1.3.3" xref="S4.SS3.p1.14.m5.1.1.3.3.cmml">g</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.14.m5.1b"><apply id="S4.SS3.p1.14.m5.1.1.cmml" xref="S4.SS3.p1.14.m5.1.1"><csymbol cd="ambiguous" id="S4.SS3.p1.14.m5.1.1.1.cmml" xref="S4.SS3.p1.14.m5.1.1">subscript</csymbol><ci id="S4.SS3.p1.14.m5.1.1.2.cmml" xref="S4.SS3.p1.14.m5.1.1.2">𝐸</ci><apply id="S4.SS3.p1.14.m5.1.1.3.cmml" xref="S4.SS3.p1.14.m5.1.1.3"><times id="S4.SS3.p1.14.m5.1.1.3.1.cmml" xref="S4.SS3.p1.14.m5.1.1.3.1"></times><ci id="S4.SS3.p1.14.m5.1.1.3.2.cmml" xref="S4.SS3.p1.14.m5.1.1.3.2">𝑏</ci><ci id="S4.SS3.p1.14.m5.1.1.3.3.cmml" xref="S4.SS3.p1.14.m5.1.1.3.3">𝑔</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.14.m5.1c">E_{bg}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.14.m5.1d">italic_E start_POSTSUBSCRIPT italic_b italic_g end_POSTSUBSCRIPT</annotation></semantics></math>, resulting in the dimension of <math alttext="c_{i}" class="ltx_Math" display="inline" id="S4.SS3.p1.15.m6.1"><semantics id="S4.SS3.p1.15.m6.1a"><msub id="S4.SS3.p1.15.m6.1.1" xref="S4.SS3.p1.15.m6.1.1.cmml"><mi id="S4.SS3.p1.15.m6.1.1.2" xref="S4.SS3.p1.15.m6.1.1.2.cmml">c</mi><mi id="S4.SS3.p1.15.m6.1.1.3" xref="S4.SS3.p1.15.m6.1.1.3.cmml">i</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.15.m6.1b"><apply id="S4.SS3.p1.15.m6.1.1.cmml" xref="S4.SS3.p1.15.m6.1.1"><csymbol cd="ambiguous" id="S4.SS3.p1.15.m6.1.1.1.cmml" xref="S4.SS3.p1.15.m6.1.1">subscript</csymbol><ci id="S4.SS3.p1.15.m6.1.1.2.cmml" xref="S4.SS3.p1.15.m6.1.1.2">𝑐</ci><ci id="S4.SS3.p1.15.m6.1.1.3.cmml" xref="S4.SS3.p1.15.m6.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.15.m6.1c">c_{i}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.15.m6.1d">italic_c start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math> is <math alttext="((N+1)\cdot L)\times D" class="ltx_Math" display="inline" id="S4.SS3.p1.16.m7.1"><semantics id="S4.SS3.p1.16.m7.1a"><mrow id="S4.SS3.p1.16.m7.1.1" xref="S4.SS3.p1.16.m7.1.1.cmml"><mrow id="S4.SS3.p1.16.m7.1.1.1.1" xref="S4.SS3.p1.16.m7.1.1.1.1.1.cmml"><mo id="S4.SS3.p1.16.m7.1.1.1.1.2" stretchy="false" xref="S4.SS3.p1.16.m7.1.1.1.1.1.cmml">(</mo><mrow id="S4.SS3.p1.16.m7.1.1.1.1.1" xref="S4.SS3.p1.16.m7.1.1.1.1.1.cmml"><mrow id="S4.SS3.p1.16.m7.1.1.1.1.1.1.1" xref="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.cmml"><mo id="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.2" stretchy="false" xref="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.cmml">(</mo><mrow id="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1" xref="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.cmml"><mi id="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.2" xref="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.2.cmml">N</mi><mo id="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.1" xref="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.1.cmml">+</mo><mn id="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.3" xref="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.3.cmml">1</mn></mrow><mo id="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.3" rspace="0.055em" stretchy="false" xref="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.cmml">)</mo></mrow><mo id="S4.SS3.p1.16.m7.1.1.1.1.1.2" rspace="0.222em" xref="S4.SS3.p1.16.m7.1.1.1.1.1.2.cmml">⋅</mo><mi id="S4.SS3.p1.16.m7.1.1.1.1.1.3" xref="S4.SS3.p1.16.m7.1.1.1.1.1.3.cmml">L</mi></mrow><mo id="S4.SS3.p1.16.m7.1.1.1.1.3" rspace="0.055em" stretchy="false" xref="S4.SS3.p1.16.m7.1.1.1.1.1.cmml">)</mo></mrow><mo id="S4.SS3.p1.16.m7.1.1.2" rspace="0.222em" xref="S4.SS3.p1.16.m7.1.1.2.cmml">×</mo><mi id="S4.SS3.p1.16.m7.1.1.3" xref="S4.SS3.p1.16.m7.1.1.3.cmml">D</mi></mrow><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.16.m7.1b"><apply id="S4.SS3.p1.16.m7.1.1.cmml" xref="S4.SS3.p1.16.m7.1.1"><times id="S4.SS3.p1.16.m7.1.1.2.cmml" xref="S4.SS3.p1.16.m7.1.1.2"></times><apply id="S4.SS3.p1.16.m7.1.1.1.1.1.cmml" xref="S4.SS3.p1.16.m7.1.1.1.1"><ci id="S4.SS3.p1.16.m7.1.1.1.1.1.2.cmml" xref="S4.SS3.p1.16.m7.1.1.1.1.1.2">⋅</ci><apply id="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.cmml" xref="S4.SS3.p1.16.m7.1.1.1.1.1.1.1"><plus id="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.1.cmml" xref="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.1"></plus><ci id="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.2.cmml" xref="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.2">𝑁</ci><cn id="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.3.cmml" type="integer" xref="S4.SS3.p1.16.m7.1.1.1.1.1.1.1.1.3">1</cn></apply><ci id="S4.SS3.p1.16.m7.1.1.1.1.1.3.cmml" xref="S4.SS3.p1.16.m7.1.1.1.1.1.3">𝐿</ci></apply><ci id="S4.SS3.p1.16.m7.1.1.3.cmml" xref="S4.SS3.p1.16.m7.1.1.3">𝐷</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.16.m7.1c">((N+1)\cdot L)\times D</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.16.m7.1d">( ( italic_N + 1 ) ⋅ italic_L ) × italic_D</annotation></semantics></math>.</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS4">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.4 </span>Decoupled Cross-attention</h3>
<div class="ltx_para ltx_noindent" id="S4.SS4.p1">
<p class="ltx_p" id="S4.SS4.p1.1">After extracting the reference information, we utilize the decoupled cross-attention to embed it into the text-to-image model, following IP-Adapter <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite>.</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS5">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.5 </span>Pose Decoupling from Character Images</h3>
<div class="ltx_para ltx_noindent" id="S4.SS5.p1">
<p class="ltx_p" id="S4.SS5.p1.1">Pose diversity is essential for storytelling. Training conditioned solely on character images can lead to the network overfitting to the poses of the reference images, resulting in generated characters with identical poses. To facilitate decoupling poses from character images, we condition the training on poses using Pose-ControlNet <cite class="ltx_cite ltx_citemacro_citep">(Zhang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib17" title="">2023</a>)</cite>. During inference, we can either discard ControlNet and employ text prompts to control the poses of generated characters or guide generation with a newly provided pose.</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS6">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.6 </span>Training with LoRA</h3>
<div class="ltx_para ltx_noindent" id="S4.SS6.p1">
<p class="ltx_p" id="S4.SS6.p1.5">Furthermore, to enhance ID consistency, fidelity, and quality akin to IP-Adapter-FaceID, LoRA layers <cite class="ltx_cite ltx_citemacro_citep">(Hu et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib37" title="">2021</a>)</cite> are integrated into each attention layer of the diffusion model. Specifically, in each cross-attention layer, <math alttext="Q" class="ltx_Math" display="inline" id="S4.SS6.p1.1.m1.1"><semantics id="S4.SS6.p1.1.m1.1a"><mi id="S4.SS6.p1.1.m1.1.1" xref="S4.SS6.p1.1.m1.1.1.cmml">Q</mi><annotation-xml encoding="MathML-Content" id="S4.SS6.p1.1.m1.1b"><ci id="S4.SS6.p1.1.m1.1.1.cmml" xref="S4.SS6.p1.1.m1.1.1">𝑄</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS6.p1.1.m1.1c">Q</annotation><annotation encoding="application/x-llamapun" id="S4.SS6.p1.1.m1.1d">italic_Q</annotation></semantics></math>,<math alttext="K_{t}" class="ltx_Math" display="inline" id="S4.SS6.p1.2.m2.1"><semantics id="S4.SS6.p1.2.m2.1a"><msub id="S4.SS6.p1.2.m2.1.1" xref="S4.SS6.p1.2.m2.1.1.cmml"><mi id="S4.SS6.p1.2.m2.1.1.2" xref="S4.SS6.p1.2.m2.1.1.2.cmml">K</mi><mi id="S4.SS6.p1.2.m2.1.1.3" xref="S4.SS6.p1.2.m2.1.1.3.cmml">t</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS6.p1.2.m2.1b"><apply id="S4.SS6.p1.2.m2.1.1.cmml" xref="S4.SS6.p1.2.m2.1.1"><csymbol cd="ambiguous" id="S4.SS6.p1.2.m2.1.1.1.cmml" xref="S4.SS6.p1.2.m2.1.1">subscript</csymbol><ci id="S4.SS6.p1.2.m2.1.1.2.cmml" xref="S4.SS6.p1.2.m2.1.1.2">𝐾</ci><ci id="S4.SS6.p1.2.m2.1.1.3.cmml" xref="S4.SS6.p1.2.m2.1.1.3">𝑡</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS6.p1.2.m2.1c">K_{t}</annotation><annotation encoding="application/x-llamapun" id="S4.SS6.p1.2.m2.1d">italic_K start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT</annotation></semantics></math>,<math alttext="V_{t}" class="ltx_Math" display="inline" id="S4.SS6.p1.3.m3.1"><semantics id="S4.SS6.p1.3.m3.1a"><msub id="S4.SS6.p1.3.m3.1.1" xref="S4.SS6.p1.3.m3.1.1.cmml"><mi id="S4.SS6.p1.3.m3.1.1.2" xref="S4.SS6.p1.3.m3.1.1.2.cmml">V</mi><mi id="S4.SS6.p1.3.m3.1.1.3" xref="S4.SS6.p1.3.m3.1.1.3.cmml">t</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS6.p1.3.m3.1b"><apply id="S4.SS6.p1.3.m3.1.1.cmml" xref="S4.SS6.p1.3.m3.1.1"><csymbol cd="ambiguous" id="S4.SS6.p1.3.m3.1.1.1.cmml" xref="S4.SS6.p1.3.m3.1.1">subscript</csymbol><ci id="S4.SS6.p1.3.m3.1.1.2.cmml" xref="S4.SS6.p1.3.m3.1.1.2">𝑉</ci><ci id="S4.SS6.p1.3.m3.1.1.3.cmml" xref="S4.SS6.p1.3.m3.1.1.3">𝑡</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS6.p1.3.m3.1c">V_{t}</annotation><annotation encoding="application/x-llamapun" id="S4.SS6.p1.3.m3.1d">italic_V start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT</annotation></semantics></math>,<math alttext="K_{i}" class="ltx_Math" display="inline" id="S4.SS6.p1.4.m4.1"><semantics id="S4.SS6.p1.4.m4.1a"><msub id="S4.SS6.p1.4.m4.1.1" xref="S4.SS6.p1.4.m4.1.1.cmml"><mi id="S4.SS6.p1.4.m4.1.1.2" xref="S4.SS6.p1.4.m4.1.1.2.cmml">K</mi><mi id="S4.SS6.p1.4.m4.1.1.3" xref="S4.SS6.p1.4.m4.1.1.3.cmml">i</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS6.p1.4.m4.1b"><apply id="S4.SS6.p1.4.m4.1.1.cmml" xref="S4.SS6.p1.4.m4.1.1"><csymbol cd="ambiguous" id="S4.SS6.p1.4.m4.1.1.1.cmml" xref="S4.SS6.p1.4.m4.1.1">subscript</csymbol><ci id="S4.SS6.p1.4.m4.1.1.2.cmml" xref="S4.SS6.p1.4.m4.1.1.2">𝐾</ci><ci id="S4.SS6.p1.4.m4.1.1.3.cmml" xref="S4.SS6.p1.4.m4.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS6.p1.4.m4.1c">K_{i}</annotation><annotation encoding="application/x-llamapun" id="S4.SS6.p1.4.m4.1d">italic_K start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math> and <math alttext="V_{i}" class="ltx_Math" display="inline" id="S4.SS6.p1.5.m5.1"><semantics id="S4.SS6.p1.5.m5.1a"><msub id="S4.SS6.p1.5.m5.1.1" xref="S4.SS6.p1.5.m5.1.1.cmml"><mi id="S4.SS6.p1.5.m5.1.1.2" xref="S4.SS6.p1.5.m5.1.1.2.cmml">V</mi><mi id="S4.SS6.p1.5.m5.1.1.3" xref="S4.SS6.p1.5.m5.1.1.3.cmml">i</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS6.p1.5.m5.1b"><apply id="S4.SS6.p1.5.m5.1.1.cmml" xref="S4.SS6.p1.5.m5.1.1"><csymbol cd="ambiguous" id="S4.SS6.p1.5.m5.1.1.1.cmml" xref="S4.SS6.p1.5.m5.1.1">subscript</csymbol><ci id="S4.SS6.p1.5.m5.1.1.2.cmml" xref="S4.SS6.p1.5.m5.1.1.2">𝑉</ci><ci id="S4.SS6.p1.5.m5.1.1.3.cmml" xref="S4.SS6.p1.5.m5.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS6.p1.5.m5.1c">V_{i}</annotation><annotation encoding="application/x-llamapun" id="S4.SS6.p1.5.m5.1d">italic_V start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math> are modified as follows:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E8">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\begin{cases}Q&amp;=Z(W_{q}+\Delta{W_{q}}),\\
K_{t}&amp;=c_{t}(W_{k}^{t}+\Delta{W_{k}^{t}}),\\
V_{t}&amp;=c_{t}(W_{v}^{t}+\Delta{W_{v}^{t}}),\\
K_{i}&amp;=c_{i}(W_{k}^{i}+\Delta{W_{k}^{i}}),\\
V_{i}&amp;=c_{i}(W_{v}^{i}+\Delta{W_{v}^{i}})\\
\end{cases}" class="ltx_Math" display="block" id="S4.E8.m1.10"><semantics id="S4.E8.m1.10a"><mrow id="S4.E8.m1.10.10" xref="S4.E8.m1.10.11.1.cmml"><mo id="S4.E8.m1.10.10.11" xref="S4.E8.m1.10.11.1.1.cmml">{</mo><mtable columnspacing="5pt" displaystyle="true" id="S4.E8.m1.10.10.10" rowspacing="0pt" xref="S4.E8.m1.10.11.1.cmml"><mtr id="S4.E8.m1.10.10.10a" xref="S4.E8.m1.10.11.1.cmml"><mtd class="ltx_align_left" columnalign="left" id="S4.E8.m1.10.10.10b" xref="S4.E8.m1.10.11.1.cmml"><mi id="S4.E8.m1.1.1.1.1.1.1" xref="S4.E8.m1.1.1.1.1.1.1.cmml">Q</mi></mtd><mtd class="ltx_align_left" columnalign="left" id="S4.E8.m1.10.10.10c" xref="S4.E8.m1.10.11.1.cmml"><mrow id="S4.E8.m1.2.2.2.2.2.1.1" xref="S4.E8.m1.2.2.2.2.2.1.1.1.cmml"><mrow id="S4.E8.m1.2.2.2.2.2.1.1.1" xref="S4.E8.m1.2.2.2.2.2.1.1.1.cmml"><mi id="S4.E8.m1.2.2.2.2.2.1.1.1.3" xref="S4.E8.m1.2.2.2.2.2.1.1.1.3.cmml"></mi><mo id="S4.E8.m1.2.2.2.2.2.1.1.1.2" xref="S4.E8.m1.2.2.2.2.2.1.1.1.2.cmml">=</mo><mrow id="S4.E8.m1.2.2.2.2.2.1.1.1.1" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.cmml"><mi id="S4.E8.m1.2.2.2.2.2.1.1.1.1.3" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.3.cmml">Z</mi><mo id="S4.E8.m1.2.2.2.2.2.1.1.1.1.2" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.2.cmml">⁢</mo><mrow id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.cmml"><mo id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.2" stretchy="false" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.cmml">(</mo><mrow id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.cmml"><msub id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2.cmml"><mi id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2.2" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2.2.cmml">W</mi><mi id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2.3" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2.3.cmml">q</mi></msub><mo id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.1" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.1.cmml">+</mo><mrow id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.cmml"><mi id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.2" mathvariant="normal" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.2.cmml">Δ</mi><mo id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.1" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.1.cmml">⁢</mo><msub id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3.cmml"><mi id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3.2" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3.2.cmml">W</mi><mi id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3.3" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3.3.cmml">q</mi></msub></mrow></mrow><mo id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.3" stretchy="false" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow><mo id="S4.E8.m1.2.2.2.2.2.1.1.2" xref="S4.E8.m1.2.2.2.2.2.1.1.1.cmml">,</mo></mrow></mtd></mtr><mtr id="S4.E8.m1.10.10.10d" xref="S4.E8.m1.10.11.1.cmml"><mtd class="ltx_align_left" columnalign="left" id="S4.E8.m1.10.10.10e" xref="S4.E8.m1.10.11.1.cmml"><msub id="S4.E8.m1.3.3.3.3.1.1" xref="S4.E8.m1.3.3.3.3.1.1.cmml"><mi id="S4.E8.m1.3.3.3.3.1.1.2" xref="S4.E8.m1.3.3.3.3.1.1.2.cmml">K</mi><mi id="S4.E8.m1.3.3.3.3.1.1.3" xref="S4.E8.m1.3.3.3.3.1.1.3.cmml">t</mi></msub></mtd><mtd class="ltx_align_left" columnalign="left" id="S4.E8.m1.10.10.10f" xref="S4.E8.m1.10.11.1.cmml"><mrow id="S4.E8.m1.4.4.4.4.2.1.1" xref="S4.E8.m1.4.4.4.4.2.1.1.1.cmml"><mrow id="S4.E8.m1.4.4.4.4.2.1.1.1" xref="S4.E8.m1.4.4.4.4.2.1.1.1.cmml"><mi id="S4.E8.m1.4.4.4.4.2.1.1.1.3" xref="S4.E8.m1.4.4.4.4.2.1.1.1.3.cmml"></mi><mo id="S4.E8.m1.4.4.4.4.2.1.1.1.2" xref="S4.E8.m1.4.4.4.4.2.1.1.1.2.cmml">=</mo><mrow id="S4.E8.m1.4.4.4.4.2.1.1.1.1" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.cmml"><msub id="S4.E8.m1.4.4.4.4.2.1.1.1.1.3" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.3.cmml"><mi id="S4.E8.m1.4.4.4.4.2.1.1.1.1.3.2" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.3.2.cmml">c</mi><mi id="S4.E8.m1.4.4.4.4.2.1.1.1.1.3.3" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.3.3.cmml">t</mi></msub><mo id="S4.E8.m1.4.4.4.4.2.1.1.1.1.2" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.2.cmml">⁢</mo><mrow id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.cmml"><mo id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.2" stretchy="false" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.cmml">(</mo><mrow id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.cmml"><msubsup id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.cmml"><mi id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.2.2" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.2.2.cmml">W</mi><mi id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.2.3" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.2.3.cmml">k</mi><mi id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.3" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.3.cmml">t</mi></msubsup><mo id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.1" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.1.cmml">+</mo><mrow id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.cmml"><mi id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.2" mathvariant="normal" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.2.cmml">Δ</mi><mo id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.1" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.1.cmml">⁢</mo><msubsup id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.cmml"><mi id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.2.2" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.2.2.cmml">W</mi><mi id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.2.3" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.2.3.cmml">k</mi><mi id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.3" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.3.cmml">t</mi></msubsup></mrow></mrow><mo id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.3" stretchy="false" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow><mo id="S4.E8.m1.4.4.4.4.2.1.1.2" xref="S4.E8.m1.4.4.4.4.2.1.1.1.cmml">,</mo></mrow></mtd></mtr><mtr id="S4.E8.m1.10.10.10g" xref="S4.E8.m1.10.11.1.cmml"><mtd class="ltx_align_left" columnalign="left" id="S4.E8.m1.10.10.10h" xref="S4.E8.m1.10.11.1.cmml"><msub id="S4.E8.m1.5.5.5.5.1.1" xref="S4.E8.m1.5.5.5.5.1.1.cmml"><mi id="S4.E8.m1.5.5.5.5.1.1.2" xref="S4.E8.m1.5.5.5.5.1.1.2.cmml">V</mi><mi id="S4.E8.m1.5.5.5.5.1.1.3" xref="S4.E8.m1.5.5.5.5.1.1.3.cmml">t</mi></msub></mtd><mtd class="ltx_align_left" columnalign="left" id="S4.E8.m1.10.10.10i" xref="S4.E8.m1.10.11.1.cmml"><mrow id="S4.E8.m1.6.6.6.6.2.1.1" xref="S4.E8.m1.6.6.6.6.2.1.1.1.cmml"><mrow id="S4.E8.m1.6.6.6.6.2.1.1.1" xref="S4.E8.m1.6.6.6.6.2.1.1.1.cmml"><mi id="S4.E8.m1.6.6.6.6.2.1.1.1.3" xref="S4.E8.m1.6.6.6.6.2.1.1.1.3.cmml"></mi><mo id="S4.E8.m1.6.6.6.6.2.1.1.1.2" xref="S4.E8.m1.6.6.6.6.2.1.1.1.2.cmml">=</mo><mrow id="S4.E8.m1.6.6.6.6.2.1.1.1.1" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.cmml"><msub id="S4.E8.m1.6.6.6.6.2.1.1.1.1.3" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.3.cmml"><mi id="S4.E8.m1.6.6.6.6.2.1.1.1.1.3.2" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.3.2.cmml">c</mi><mi id="S4.E8.m1.6.6.6.6.2.1.1.1.1.3.3" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.3.3.cmml">t</mi></msub><mo id="S4.E8.m1.6.6.6.6.2.1.1.1.1.2" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.2.cmml">⁢</mo><mrow id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.cmml"><mo id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.2" stretchy="false" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.cmml">(</mo><mrow id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.cmml"><msubsup id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.cmml"><mi id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.2.2" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.2.2.cmml">W</mi><mi id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.2.3" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.2.3.cmml">v</mi><mi id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.3" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.3.cmml">t</mi></msubsup><mo id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.1" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.1.cmml">+</mo><mrow id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.cmml"><mi id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.2" mathvariant="normal" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.2.cmml">Δ</mi><mo id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.1" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.1.cmml">⁢</mo><msubsup id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.cmml"><mi id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.2.2" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.2.2.cmml">W</mi><mi id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.2.3" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.2.3.cmml">v</mi><mi id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.3" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.3.cmml">t</mi></msubsup></mrow></mrow><mo id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.3" stretchy="false" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow><mo id="S4.E8.m1.6.6.6.6.2.1.1.2" xref="S4.E8.m1.6.6.6.6.2.1.1.1.cmml">,</mo></mrow></mtd></mtr><mtr id="S4.E8.m1.10.10.10j" xref="S4.E8.m1.10.11.1.cmml"><mtd class="ltx_align_left" columnalign="left" id="S4.E8.m1.10.10.10k" xref="S4.E8.m1.10.11.1.cmml"><msub id="S4.E8.m1.7.7.7.7.1.1" xref="S4.E8.m1.7.7.7.7.1.1.cmml"><mi id="S4.E8.m1.7.7.7.7.1.1.2" xref="S4.E8.m1.7.7.7.7.1.1.2.cmml">K</mi><mi id="S4.E8.m1.7.7.7.7.1.1.3" xref="S4.E8.m1.7.7.7.7.1.1.3.cmml">i</mi></msub></mtd><mtd class="ltx_align_left" columnalign="left" id="S4.E8.m1.10.10.10l" xref="S4.E8.m1.10.11.1.cmml"><mrow id="S4.E8.m1.8.8.8.8.2.1.1" xref="S4.E8.m1.8.8.8.8.2.1.1.1.cmml"><mrow id="S4.E8.m1.8.8.8.8.2.1.1.1" xref="S4.E8.m1.8.8.8.8.2.1.1.1.cmml"><mi id="S4.E8.m1.8.8.8.8.2.1.1.1.3" xref="S4.E8.m1.8.8.8.8.2.1.1.1.3.cmml"></mi><mo id="S4.E8.m1.8.8.8.8.2.1.1.1.2" xref="S4.E8.m1.8.8.8.8.2.1.1.1.2.cmml">=</mo><mrow id="S4.E8.m1.8.8.8.8.2.1.1.1.1" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.cmml"><msub id="S4.E8.m1.8.8.8.8.2.1.1.1.1.3" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.3.cmml"><mi id="S4.E8.m1.8.8.8.8.2.1.1.1.1.3.2" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.3.2.cmml">c</mi><mi id="S4.E8.m1.8.8.8.8.2.1.1.1.1.3.3" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.3.3.cmml">i</mi></msub><mo id="S4.E8.m1.8.8.8.8.2.1.1.1.1.2" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.2.cmml">⁢</mo><mrow id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.cmml"><mo id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.2" stretchy="false" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.cmml">(</mo><mrow id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.cmml"><msubsup id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.cmml"><mi id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.2.2" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.2.2.cmml">W</mi><mi id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.2.3" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.2.3.cmml">k</mi><mi id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.3" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.3.cmml">i</mi></msubsup><mo id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.1" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.1.cmml">+</mo><mrow id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.cmml"><mi id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.2" mathvariant="normal" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.2.cmml">Δ</mi><mo id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.1" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.1.cmml">⁢</mo><msubsup id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.cmml"><mi id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.2.2" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.2.2.cmml">W</mi><mi id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.2.3" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.2.3.cmml">k</mi><mi id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.3" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.3.cmml">i</mi></msubsup></mrow></mrow><mo id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.3" stretchy="false" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow><mo id="S4.E8.m1.8.8.8.8.2.1.1.2" xref="S4.E8.m1.8.8.8.8.2.1.1.1.cmml">,</mo></mrow></mtd></mtr><mtr id="S4.E8.m1.10.10.10m" xref="S4.E8.m1.10.11.1.cmml"><mtd class="ltx_align_left" columnalign="left" id="S4.E8.m1.10.10.10n" xref="S4.E8.m1.10.11.1.cmml"><msub id="S4.E8.m1.9.9.9.9.1.1" xref="S4.E8.m1.9.9.9.9.1.1.cmml"><mi id="S4.E8.m1.9.9.9.9.1.1.2" xref="S4.E8.m1.9.9.9.9.1.1.2.cmml">V</mi><mi id="S4.E8.m1.9.9.9.9.1.1.3" xref="S4.E8.m1.9.9.9.9.1.1.3.cmml">i</mi></msub></mtd><mtd class="ltx_align_left" columnalign="left" id="S4.E8.m1.10.10.10o" xref="S4.E8.m1.10.11.1.cmml"><mrow id="S4.E8.m1.10.10.10.10.2.1" xref="S4.E8.m1.10.10.10.10.2.1.cmml"><mi id="S4.E8.m1.10.10.10.10.2.1.3" xref="S4.E8.m1.10.10.10.10.2.1.3.cmml"></mi><mo id="S4.E8.m1.10.10.10.10.2.1.2" xref="S4.E8.m1.10.10.10.10.2.1.2.cmml">=</mo><mrow id="S4.E8.m1.10.10.10.10.2.1.1" xref="S4.E8.m1.10.10.10.10.2.1.1.cmml"><msub id="S4.E8.m1.10.10.10.10.2.1.1.3" xref="S4.E8.m1.10.10.10.10.2.1.1.3.cmml"><mi id="S4.E8.m1.10.10.10.10.2.1.1.3.2" xref="S4.E8.m1.10.10.10.10.2.1.1.3.2.cmml">c</mi><mi id="S4.E8.m1.10.10.10.10.2.1.1.3.3" xref="S4.E8.m1.10.10.10.10.2.1.1.3.3.cmml">i</mi></msub><mo id="S4.E8.m1.10.10.10.10.2.1.1.2" xref="S4.E8.m1.10.10.10.10.2.1.1.2.cmml">⁢</mo><mrow id="S4.E8.m1.10.10.10.10.2.1.1.1.1" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.cmml"><mo id="S4.E8.m1.10.10.10.10.2.1.1.1.1.2" stretchy="false" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.cmml">(</mo><mrow id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.cmml"><msubsup id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.cmml"><mi id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.2.2" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.2.2.cmml">W</mi><mi id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.2.3" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.2.3.cmml">v</mi><mi id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.3" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.3.cmml">i</mi></msubsup><mo id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.1" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.1.cmml">+</mo><mrow id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.cmml"><mi id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.2" mathvariant="normal" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.2.cmml">Δ</mi><mo id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.1" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.1.cmml">⁢</mo><msubsup id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.cmml"><mi id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.2.2" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.2.2.cmml">W</mi><mi id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.2.3" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.2.3.cmml">v</mi><mi id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.3" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.3.cmml">i</mi></msubsup></mrow></mrow><mo id="S4.E8.m1.10.10.10.10.2.1.1.1.1.3" stretchy="false" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow></mtd></mtr></mtable></mrow><annotation-xml encoding="MathML-Content" id="S4.E8.m1.10b"><apply id="S4.E8.m1.10.11.1.cmml" xref="S4.E8.m1.10.10"><csymbol cd="latexml" id="S4.E8.m1.10.11.1.1.cmml" xref="S4.E8.m1.10.10.11">cases</csymbol><ci id="S4.E8.m1.1.1.1.1.1.1.cmml" xref="S4.E8.m1.1.1.1.1.1.1">𝑄</ci><apply id="S4.E8.m1.2.2.2.2.2.1.1.1.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1"><eq id="S4.E8.m1.2.2.2.2.2.1.1.1.2.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.2"></eq><csymbol cd="latexml" id="S4.E8.m1.2.2.2.2.2.1.1.1.3.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.3">absent</csymbol><apply id="S4.E8.m1.2.2.2.2.2.1.1.1.1.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1"><times id="S4.E8.m1.2.2.2.2.2.1.1.1.1.2.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.2"></times><ci id="S4.E8.m1.2.2.2.2.2.1.1.1.1.3.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.3">𝑍</ci><apply id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1"><plus id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.1.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.1"></plus><apply id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2.1.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2">subscript</csymbol><ci id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2.2.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2.2">𝑊</ci><ci id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2.3.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.2.3">𝑞</ci></apply><apply id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3"><times id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.1.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.1"></times><ci id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.2.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.2">Δ</ci><apply id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3.1.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3">subscript</csymbol><ci id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3.2.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3.2">𝑊</ci><ci id="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3.3.cmml" xref="S4.E8.m1.2.2.2.2.2.1.1.1.1.1.1.1.3.3.3">𝑞</ci></apply></apply></apply></apply></apply><apply id="S4.E8.m1.3.3.3.3.1.1.cmml" xref="S4.E8.m1.3.3.3.3.1.1"><csymbol cd="ambiguous" id="S4.E8.m1.3.3.3.3.1.1.1.cmml" xref="S4.E8.m1.3.3.3.3.1.1">subscript</csymbol><ci id="S4.E8.m1.3.3.3.3.1.1.2.cmml" xref="S4.E8.m1.3.3.3.3.1.1.2">𝐾</ci><ci id="S4.E8.m1.3.3.3.3.1.1.3.cmml" xref="S4.E8.m1.3.3.3.3.1.1.3">𝑡</ci></apply><apply id="S4.E8.m1.4.4.4.4.2.1.1.1.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1"><eq id="S4.E8.m1.4.4.4.4.2.1.1.1.2.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.2"></eq><csymbol cd="latexml" id="S4.E8.m1.4.4.4.4.2.1.1.1.3.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.3">absent</csymbol><apply id="S4.E8.m1.4.4.4.4.2.1.1.1.1.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1"><times id="S4.E8.m1.4.4.4.4.2.1.1.1.1.2.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.2"></times><apply id="S4.E8.m1.4.4.4.4.2.1.1.1.1.3.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.3"><csymbol cd="ambiguous" id="S4.E8.m1.4.4.4.4.2.1.1.1.1.3.1.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.3">subscript</csymbol><ci id="S4.E8.m1.4.4.4.4.2.1.1.1.1.3.2.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.3.2">𝑐</ci><ci id="S4.E8.m1.4.4.4.4.2.1.1.1.1.3.3.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.3.3">𝑡</ci></apply><apply id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1"><plus id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.1.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.1"></plus><apply id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.1.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2">superscript</csymbol><apply id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.2.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.2.1.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2">subscript</csymbol><ci id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.2.2.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.2.2">𝑊</ci><ci id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.2.3.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.2.3">𝑘</ci></apply><ci id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.3.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.2.3">𝑡</ci></apply><apply id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3"><times id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.1.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.1"></times><ci id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.2.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.2">Δ</ci><apply id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.1.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3">superscript</csymbol><apply id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.2.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.2.1.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3">subscript</csymbol><ci id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.2.2.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.2.2">𝑊</ci><ci id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.2.3.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.2.3">𝑘</ci></apply><ci id="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.3.cmml" xref="S4.E8.m1.4.4.4.4.2.1.1.1.1.1.1.1.3.3.3">𝑡</ci></apply></apply></apply></apply></apply><apply id="S4.E8.m1.5.5.5.5.1.1.cmml" xref="S4.E8.m1.5.5.5.5.1.1"><csymbol cd="ambiguous" id="S4.E8.m1.5.5.5.5.1.1.1.cmml" xref="S4.E8.m1.5.5.5.5.1.1">subscript</csymbol><ci id="S4.E8.m1.5.5.5.5.1.1.2.cmml" xref="S4.E8.m1.5.5.5.5.1.1.2">𝑉</ci><ci id="S4.E8.m1.5.5.5.5.1.1.3.cmml" xref="S4.E8.m1.5.5.5.5.1.1.3">𝑡</ci></apply><apply id="S4.E8.m1.6.6.6.6.2.1.1.1.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1"><eq id="S4.E8.m1.6.6.6.6.2.1.1.1.2.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.2"></eq><csymbol cd="latexml" id="S4.E8.m1.6.6.6.6.2.1.1.1.3.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.3">absent</csymbol><apply id="S4.E8.m1.6.6.6.6.2.1.1.1.1.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1"><times id="S4.E8.m1.6.6.6.6.2.1.1.1.1.2.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.2"></times><apply id="S4.E8.m1.6.6.6.6.2.1.1.1.1.3.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.3"><csymbol cd="ambiguous" id="S4.E8.m1.6.6.6.6.2.1.1.1.1.3.1.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.3">subscript</csymbol><ci id="S4.E8.m1.6.6.6.6.2.1.1.1.1.3.2.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.3.2">𝑐</ci><ci id="S4.E8.m1.6.6.6.6.2.1.1.1.1.3.3.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.3.3">𝑡</ci></apply><apply id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1"><plus id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.1.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.1"></plus><apply id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.1.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2">superscript</csymbol><apply id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.2.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.2.1.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2">subscript</csymbol><ci id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.2.2.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.2.2">𝑊</ci><ci id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.2.3.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.2.3">𝑣</ci></apply><ci id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.3.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.2.3">𝑡</ci></apply><apply id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3"><times id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.1.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.1"></times><ci id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.2.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.2">Δ</ci><apply id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.1.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3">superscript</csymbol><apply id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.2.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.2.1.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3">subscript</csymbol><ci id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.2.2.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.2.2">𝑊</ci><ci id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.2.3.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.2.3">𝑣</ci></apply><ci id="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.3.cmml" xref="S4.E8.m1.6.6.6.6.2.1.1.1.1.1.1.1.3.3.3">𝑡</ci></apply></apply></apply></apply></apply><apply id="S4.E8.m1.7.7.7.7.1.1.cmml" xref="S4.E8.m1.7.7.7.7.1.1"><csymbol cd="ambiguous" id="S4.E8.m1.7.7.7.7.1.1.1.cmml" xref="S4.E8.m1.7.7.7.7.1.1">subscript</csymbol><ci id="S4.E8.m1.7.7.7.7.1.1.2.cmml" xref="S4.E8.m1.7.7.7.7.1.1.2">𝐾</ci><ci id="S4.E8.m1.7.7.7.7.1.1.3.cmml" xref="S4.E8.m1.7.7.7.7.1.1.3">𝑖</ci></apply><apply id="S4.E8.m1.8.8.8.8.2.1.1.1.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1"><eq id="S4.E8.m1.8.8.8.8.2.1.1.1.2.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.2"></eq><csymbol cd="latexml" id="S4.E8.m1.8.8.8.8.2.1.1.1.3.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.3">absent</csymbol><apply id="S4.E8.m1.8.8.8.8.2.1.1.1.1.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1"><times id="S4.E8.m1.8.8.8.8.2.1.1.1.1.2.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.2"></times><apply id="S4.E8.m1.8.8.8.8.2.1.1.1.1.3.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.3"><csymbol cd="ambiguous" id="S4.E8.m1.8.8.8.8.2.1.1.1.1.3.1.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.3">subscript</csymbol><ci id="S4.E8.m1.8.8.8.8.2.1.1.1.1.3.2.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.3.2">𝑐</ci><ci id="S4.E8.m1.8.8.8.8.2.1.1.1.1.3.3.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.3.3">𝑖</ci></apply><apply id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1"><plus id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.1.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.1"></plus><apply id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.1.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2">superscript</csymbol><apply id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.2.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.2.1.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2">subscript</csymbol><ci id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.2.2.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.2.2">𝑊</ci><ci id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.2.3.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.2.3">𝑘</ci></apply><ci id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.3.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.2.3">𝑖</ci></apply><apply id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3"><times id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.1.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.1"></times><ci id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.2.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.2">Δ</ci><apply id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.1.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3">superscript</csymbol><apply id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.2.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.2.1.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3">subscript</csymbol><ci id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.2.2.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.2.2">𝑊</ci><ci id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.2.3.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.2.3">𝑘</ci></apply><ci id="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.3.cmml" xref="S4.E8.m1.8.8.8.8.2.1.1.1.1.1.1.1.3.3.3">𝑖</ci></apply></apply></apply></apply></apply><apply id="S4.E8.m1.9.9.9.9.1.1.cmml" xref="S4.E8.m1.9.9.9.9.1.1"><csymbol cd="ambiguous" id="S4.E8.m1.9.9.9.9.1.1.1.cmml" xref="S4.E8.m1.9.9.9.9.1.1">subscript</csymbol><ci id="S4.E8.m1.9.9.9.9.1.1.2.cmml" xref="S4.E8.m1.9.9.9.9.1.1.2">𝑉</ci><ci id="S4.E8.m1.9.9.9.9.1.1.3.cmml" xref="S4.E8.m1.9.9.9.9.1.1.3">𝑖</ci></apply><apply id="S4.E8.m1.10.10.10.10.2.1.cmml" xref="S4.E8.m1.10.10.10.10.2.1"><eq id="S4.E8.m1.10.10.10.10.2.1.2.cmml" xref="S4.E8.m1.10.10.10.10.2.1.2"></eq><csymbol cd="latexml" id="S4.E8.m1.10.10.10.10.2.1.3.cmml" xref="S4.E8.m1.10.10.10.10.2.1.3">absent</csymbol><apply id="S4.E8.m1.10.10.10.10.2.1.1.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1"><times id="S4.E8.m1.10.10.10.10.2.1.1.2.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.2"></times><apply id="S4.E8.m1.10.10.10.10.2.1.1.3.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.3"><csymbol cd="ambiguous" id="S4.E8.m1.10.10.10.10.2.1.1.3.1.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.3">subscript</csymbol><ci id="S4.E8.m1.10.10.10.10.2.1.1.3.2.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.3.2">𝑐</ci><ci id="S4.E8.m1.10.10.10.10.2.1.1.3.3.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.3.3">𝑖</ci></apply><apply id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1"><plus id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.1.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.1"></plus><apply id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.1.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2">superscript</csymbol><apply id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.2.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.2.1.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2">subscript</csymbol><ci id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.2.2.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.2.2">𝑊</ci><ci id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.2.3.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.2.3">𝑣</ci></apply><ci id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.3.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.2.3">𝑖</ci></apply><apply id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3"><times id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.1.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.1"></times><ci id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.2.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.2">Δ</ci><apply id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.1.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3">superscript</csymbol><apply id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.2.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.2.1.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3">subscript</csymbol><ci id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.2.2.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.2.2">𝑊</ci><ci id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.2.3.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.2.3">𝑣</ci></apply><ci id="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.3.cmml" xref="S4.E8.m1.10.10.10.10.2.1.1.1.1.1.3.3.3">𝑖</ci></apply></apply></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E8.m1.10c">\begin{cases}Q&amp;=Z(W_{q}+\Delta{W_{q}}),\\
K_{t}&amp;=c_{t}(W_{k}^{t}+\Delta{W_{k}^{t}}),\\
V_{t}&amp;=c_{t}(W_{v}^{t}+\Delta{W_{v}^{t}}),\\
K_{i}&amp;=c_{i}(W_{k}^{i}+\Delta{W_{k}^{i}}),\\
V_{i}&amp;=c_{i}(W_{v}^{i}+\Delta{W_{v}^{i}})\\
\end{cases}</annotation><annotation encoding="application/x-llamapun" id="S4.E8.m1.10d">{ start_ROW start_CELL italic_Q end_CELL start_CELL = italic_Z ( italic_W start_POSTSUBSCRIPT italic_q end_POSTSUBSCRIPT + roman_Δ italic_W start_POSTSUBSCRIPT italic_q end_POSTSUBSCRIPT ) , end_CELL end_ROW start_ROW start_CELL italic_K start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT end_CELL start_CELL = italic_c start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT ( italic_W start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT + roman_Δ italic_W start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT ) , end_CELL end_ROW start_ROW start_CELL italic_V start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT end_CELL start_CELL = italic_c start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT ( italic_W start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT + roman_Δ italic_W start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT ) , end_CELL end_ROW start_ROW start_CELL italic_K start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT end_CELL start_CELL = italic_c start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ( italic_W start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_i end_POSTSUPERSCRIPT + roman_Δ italic_W start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_i end_POSTSUPERSCRIPT ) , end_CELL end_ROW start_ROW start_CELL italic_V start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT end_CELL start_CELL = italic_c start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ( italic_W start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_i end_POSTSUPERSCRIPT + roman_Δ italic_W start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_i end_POSTSUPERSCRIPT ) end_CELL end_ROW</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(8)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS6.p1.6">We freeze the U-Net model, and only the <math alttext="\Delta{W}" class="ltx_Math" display="inline" id="S4.SS6.p1.6.m1.1"><semantics id="S4.SS6.p1.6.m1.1a"><mrow id="S4.SS6.p1.6.m1.1.1" xref="S4.SS6.p1.6.m1.1.1.cmml"><mi id="S4.SS6.p1.6.m1.1.1.2" mathvariant="normal" xref="S4.SS6.p1.6.m1.1.1.2.cmml">Δ</mi><mo id="S4.SS6.p1.6.m1.1.1.1" xref="S4.SS6.p1.6.m1.1.1.1.cmml">⁢</mo><mi id="S4.SS6.p1.6.m1.1.1.3" xref="S4.SS6.p1.6.m1.1.1.3.cmml">W</mi></mrow><annotation-xml encoding="MathML-Content" id="S4.SS6.p1.6.m1.1b"><apply id="S4.SS6.p1.6.m1.1.1.cmml" xref="S4.SS6.p1.6.m1.1.1"><times id="S4.SS6.p1.6.m1.1.1.1.cmml" xref="S4.SS6.p1.6.m1.1.1.1"></times><ci id="S4.SS6.p1.6.m1.1.1.2.cmml" xref="S4.SS6.p1.6.m1.1.1.2">Δ</ci><ci id="S4.SS6.p1.6.m1.1.1.3.cmml" xref="S4.SS6.p1.6.m1.1.1.3">𝑊</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS6.p1.6.m1.1c">\Delta{W}</annotation><annotation encoding="application/x-llamapun" id="S4.SS6.p1.6.m1.1d">roman_Δ italic_W</annotation></semantics></math> is trainable.</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS7">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.7 </span>Loss Constraints on Cross-attention Maps with Masks</h3>
<div class="ltx_para ltx_noindent" id="S4.SS7.p1">
<p class="ltx_p" id="S4.SS7.p1.7">To prevent multiple characters and the background from interleaving, we regularize the influence region of cross-attention using the embeddings of different characters and the background. Unlike MM-Diff <cite class="ltx_cite ltx_citemacro_citep">(Wei et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib12" title="">2024</a>)</cite>, which does not consider the background, we introduce a learnable background embedding to address it. We constrain the influence region by calculating the MSE loss between the softmax values of cross-attention and the segmentation masks predicted by a pre-trained network. This design, <math alttext="i.e." class="ltx_Math" display="inline" id="S4.SS7.p1.1.m1.3"><semantics id="S4.SS7.p1.1.m1.3a"><mrow id="S4.SS7.p1.1.m1.3.3.1"><mrow id="S4.SS7.p1.1.m1.3.3.1.1.2" xref="S4.SS7.p1.1.m1.3.3.1.1.1.cmml"><mi id="S4.SS7.p1.1.m1.1.1" xref="S4.SS7.p1.1.m1.1.1.cmml">i</mi><mo id="S4.SS7.p1.1.m1.3.3.1.1.2.1" lspace="0em" rspace="0.167em" xref="S4.SS7.p1.1.m1.3.3.1.1.1a.cmml">.</mo><mi id="S4.SS7.p1.1.m1.2.2" xref="S4.SS7.p1.1.m1.2.2.cmml">e</mi></mrow><mo id="S4.SS7.p1.1.m1.3.3.1.2" lspace="0em">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.SS7.p1.1.m1.3b"><apply id="S4.SS7.p1.1.m1.3.3.1.1.1.cmml" xref="S4.SS7.p1.1.m1.3.3.1.1.2"><csymbol cd="ambiguous" id="S4.SS7.p1.1.m1.3.3.1.1.1a.cmml" xref="S4.SS7.p1.1.m1.3.3.1.1.2.1">formulae-sequence</csymbol><ci id="S4.SS7.p1.1.m1.1.1.cmml" xref="S4.SS7.p1.1.m1.1.1">𝑖</ci><ci id="S4.SS7.p1.1.m1.2.2.cmml" xref="S4.SS7.p1.1.m1.2.2">𝑒</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS7.p1.1.m1.3c">i.e.</annotation><annotation encoding="application/x-llamapun" id="S4.SS7.p1.1.m1.3d">italic_i . italic_e .</annotation></semantics></math>, introducing a learnable background embedding, encourages a better separation not only within the foreground characters but also between foreground and background. As seen in Equation<a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S4.E7" title="In 4.3 Reference Information Refinement by Positional-aware Perceiver Resampler ‣ 4 Method ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">7</span></a>, the first <math alttext="L" class="ltx_Math" display="inline" id="S4.SS7.p1.2.m2.1"><semantics id="S4.SS7.p1.2.m2.1a"><mi id="S4.SS7.p1.2.m2.1.1" xref="S4.SS7.p1.2.m2.1.1.cmml">L</mi><annotation-xml encoding="MathML-Content" id="S4.SS7.p1.2.m2.1b"><ci id="S4.SS7.p1.2.m2.1.1.cmml" xref="S4.SS7.p1.2.m2.1.1">𝐿</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS7.p1.2.m2.1c">L</annotation><annotation encoding="application/x-llamapun" id="S4.SS7.p1.2.m2.1d">italic_L</annotation></semantics></math> tokens of image prompt <math alttext="c_{i}" class="ltx_Math" display="inline" id="S4.SS7.p1.3.m3.1"><semantics id="S4.SS7.p1.3.m3.1a"><msub id="S4.SS7.p1.3.m3.1.1" xref="S4.SS7.p1.3.m3.1.1.cmml"><mi id="S4.SS7.p1.3.m3.1.1.2" xref="S4.SS7.p1.3.m3.1.1.2.cmml">c</mi><mi id="S4.SS7.p1.3.m3.1.1.3" xref="S4.SS7.p1.3.m3.1.1.3.cmml">i</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS7.p1.3.m3.1b"><apply id="S4.SS7.p1.3.m3.1.1.cmml" xref="S4.SS7.p1.3.m3.1.1"><csymbol cd="ambiguous" id="S4.SS7.p1.3.m3.1.1.1.cmml" xref="S4.SS7.p1.3.m3.1.1">subscript</csymbol><ci id="S4.SS7.p1.3.m3.1.1.2.cmml" xref="S4.SS7.p1.3.m3.1.1.2">𝑐</ci><ci id="S4.SS7.p1.3.m3.1.1.3.cmml" xref="S4.SS7.p1.3.m3.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS7.p1.3.m3.1c">c_{i}</annotation><annotation encoding="application/x-llamapun" id="S4.SS7.p1.3.m3.1d">italic_c start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math> represent the background, with each subsequent set of <math alttext="L" class="ltx_Math" display="inline" id="S4.SS7.p1.4.m4.1"><semantics id="S4.SS7.p1.4.m4.1a"><mi id="S4.SS7.p1.4.m4.1.1" xref="S4.SS7.p1.4.m4.1.1.cmml">L</mi><annotation-xml encoding="MathML-Content" id="S4.SS7.p1.4.m4.1b"><ci id="S4.SS7.p1.4.m4.1.1.cmml" xref="S4.SS7.p1.4.m4.1.1">𝐿</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS7.p1.4.m4.1c">L</annotation><annotation encoding="application/x-llamapun" id="S4.SS7.p1.4.m4.1d">italic_L</annotation></semantics></math> tokens representing each character. In each layer of image cross-attention, we obtain the cross-attention map <math alttext="A" class="ltx_Math" display="inline" id="S4.SS7.p1.5.m5.1"><semantics id="S4.SS7.p1.5.m5.1a"><mi id="S4.SS7.p1.5.m5.1.1" xref="S4.SS7.p1.5.m5.1.1.cmml">A</mi><annotation-xml encoding="MathML-Content" id="S4.SS7.p1.5.m5.1b"><ci id="S4.SS7.p1.5.m5.1.1.cmml" xref="S4.SS7.p1.5.m5.1.1">𝐴</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS7.p1.5.m5.1c">A</annotation><annotation encoding="application/x-llamapun" id="S4.SS7.p1.5.m5.1d">italic_A</annotation></semantics></math> of size <math alttext="h\times w" class="ltx_Math" display="inline" id="S4.SS7.p1.6.m6.1"><semantics id="S4.SS7.p1.6.m6.1a"><mrow id="S4.SS7.p1.6.m6.1.1" xref="S4.SS7.p1.6.m6.1.1.cmml"><mi id="S4.SS7.p1.6.m6.1.1.2" xref="S4.SS7.p1.6.m6.1.1.2.cmml">h</mi><mo id="S4.SS7.p1.6.m6.1.1.1" lspace="0.222em" rspace="0.222em" xref="S4.SS7.p1.6.m6.1.1.1.cmml">×</mo><mi id="S4.SS7.p1.6.m6.1.1.3" xref="S4.SS7.p1.6.m6.1.1.3.cmml">w</mi></mrow><annotation-xml encoding="MathML-Content" id="S4.SS7.p1.6.m6.1b"><apply id="S4.SS7.p1.6.m6.1.1.cmml" xref="S4.SS7.p1.6.m6.1.1"><times id="S4.SS7.p1.6.m6.1.1.1.cmml" xref="S4.SS7.p1.6.m6.1.1.1"></times><ci id="S4.SS7.p1.6.m6.1.1.2.cmml" xref="S4.SS7.p1.6.m6.1.1.2">ℎ</ci><ci id="S4.SS7.p1.6.m6.1.1.3.cmml" xref="S4.SS7.p1.6.m6.1.1.3">𝑤</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS7.p1.6.m6.1c">h\times w</annotation><annotation encoding="application/x-llamapun" id="S4.SS7.p1.6.m6.1d">italic_h × italic_w</annotation></semantics></math> for each character by summing all its <math alttext="L" class="ltx_Math" display="inline" id="S4.SS7.p1.7.m7.1"><semantics id="S4.SS7.p1.7.m7.1a"><mi id="S4.SS7.p1.7.m7.1.1" xref="S4.SS7.p1.7.m7.1.1.cmml">L</mi><annotation-xml encoding="MathML-Content" id="S4.SS7.p1.7.m7.1b"><ci id="S4.SS7.p1.7.m7.1.1.cmml" xref="S4.SS7.p1.7.m7.1.1">𝐿</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS7.p1.7.m7.1c">L</annotation><annotation encoding="application/x-llamapun" id="S4.SS7.p1.7.m7.1d">italic_L</annotation></semantics></math> tokens as:</p>
<table class="ltx_equationgroup ltx_eqn_align ltx_eqn_table" id="S7.EGx2">
<tbody id="S4.E9"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math alttext="\displaystyle P" class="ltx_Math" display="inline" id="S4.E9.m1.1"><semantics id="S4.E9.m1.1a"><mi id="S4.E9.m1.1.1" xref="S4.E9.m1.1.1.cmml">P</mi><annotation-xml encoding="MathML-Content" id="S4.E9.m1.1b"><ci id="S4.E9.m1.1.1.cmml" xref="S4.E9.m1.1.1">𝑃</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.E9.m1.1c">\displaystyle P</annotation><annotation encoding="application/x-llamapun" id="S4.E9.m1.1d">italic_P</annotation></semantics></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle=Softmax(QK^{T}/\sqrt{d})," class="ltx_Math" display="inline" id="S4.E9.m2.1"><semantics id="S4.E9.m2.1a"><mrow id="S4.E9.m2.1.1.1" xref="S4.E9.m2.1.1.1.1.cmml"><mrow id="S4.E9.m2.1.1.1.1" xref="S4.E9.m2.1.1.1.1.cmml"><mi id="S4.E9.m2.1.1.1.1.3" xref="S4.E9.m2.1.1.1.1.3.cmml"></mi><mo id="S4.E9.m2.1.1.1.1.2" xref="S4.E9.m2.1.1.1.1.2.cmml">=</mo><mrow id="S4.E9.m2.1.1.1.1.1" xref="S4.E9.m2.1.1.1.1.1.cmml"><mi id="S4.E9.m2.1.1.1.1.1.3" xref="S4.E9.m2.1.1.1.1.1.3.cmml">S</mi><mo id="S4.E9.m2.1.1.1.1.1.2" xref="S4.E9.m2.1.1.1.1.1.2.cmml">⁢</mo><mi id="S4.E9.m2.1.1.1.1.1.4" xref="S4.E9.m2.1.1.1.1.1.4.cmml">o</mi><mo id="S4.E9.m2.1.1.1.1.1.2a" xref="S4.E9.m2.1.1.1.1.1.2.cmml">⁢</mo><mi id="S4.E9.m2.1.1.1.1.1.5" xref="S4.E9.m2.1.1.1.1.1.5.cmml">f</mi><mo id="S4.E9.m2.1.1.1.1.1.2b" xref="S4.E9.m2.1.1.1.1.1.2.cmml">⁢</mo><mi id="S4.E9.m2.1.1.1.1.1.6" xref="S4.E9.m2.1.1.1.1.1.6.cmml">t</mi><mo id="S4.E9.m2.1.1.1.1.1.2c" xref="S4.E9.m2.1.1.1.1.1.2.cmml">⁢</mo><mi id="S4.E9.m2.1.1.1.1.1.7" xref="S4.E9.m2.1.1.1.1.1.7.cmml">m</mi><mo id="S4.E9.m2.1.1.1.1.1.2d" xref="S4.E9.m2.1.1.1.1.1.2.cmml">⁢</mo><mi id="S4.E9.m2.1.1.1.1.1.8" xref="S4.E9.m2.1.1.1.1.1.8.cmml">a</mi><mo id="S4.E9.m2.1.1.1.1.1.2e" xref="S4.E9.m2.1.1.1.1.1.2.cmml">⁢</mo><mi id="S4.E9.m2.1.1.1.1.1.9" xref="S4.E9.m2.1.1.1.1.1.9.cmml">x</mi><mo id="S4.E9.m2.1.1.1.1.1.2f" xref="S4.E9.m2.1.1.1.1.1.2.cmml">⁢</mo><mrow id="S4.E9.m2.1.1.1.1.1.1.1" xref="S4.E9.m2.1.1.1.1.1.1.1.1.cmml"><mo id="S4.E9.m2.1.1.1.1.1.1.1.2" stretchy="false" xref="S4.E9.m2.1.1.1.1.1.1.1.1.cmml">(</mo><mrow id="S4.E9.m2.1.1.1.1.1.1.1.1" xref="S4.E9.m2.1.1.1.1.1.1.1.1.cmml"><mrow id="S4.E9.m2.1.1.1.1.1.1.1.1.2" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2.cmml"><mi id="S4.E9.m2.1.1.1.1.1.1.1.1.2.2" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2.2.cmml">Q</mi><mo id="S4.E9.m2.1.1.1.1.1.1.1.1.2.1" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2.1.cmml">⁢</mo><msup id="S4.E9.m2.1.1.1.1.1.1.1.1.2.3" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2.3.cmml"><mi id="S4.E9.m2.1.1.1.1.1.1.1.1.2.3.2" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2.3.2.cmml">K</mi><mi id="S4.E9.m2.1.1.1.1.1.1.1.1.2.3.3" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2.3.3.cmml">T</mi></msup></mrow><mo id="S4.E9.m2.1.1.1.1.1.1.1.1.1" xref="S4.E9.m2.1.1.1.1.1.1.1.1.1.cmml">/</mo><msqrt id="S4.E9.m2.1.1.1.1.1.1.1.1.3" xref="S4.E9.m2.1.1.1.1.1.1.1.1.3.cmml"><mi id="S4.E9.m2.1.1.1.1.1.1.1.1.3.2" xref="S4.E9.m2.1.1.1.1.1.1.1.1.3.2.cmml">d</mi></msqrt></mrow><mo id="S4.E9.m2.1.1.1.1.1.1.1.3" stretchy="false" xref="S4.E9.m2.1.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow><mo id="S4.E9.m2.1.1.1.2" xref="S4.E9.m2.1.1.1.1.cmml">,</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.E9.m2.1b"><apply id="S4.E9.m2.1.1.1.1.cmml" xref="S4.E9.m2.1.1.1"><eq id="S4.E9.m2.1.1.1.1.2.cmml" xref="S4.E9.m2.1.1.1.1.2"></eq><csymbol cd="latexml" id="S4.E9.m2.1.1.1.1.3.cmml" xref="S4.E9.m2.1.1.1.1.3">absent</csymbol><apply id="S4.E9.m2.1.1.1.1.1.cmml" xref="S4.E9.m2.1.1.1.1.1"><times id="S4.E9.m2.1.1.1.1.1.2.cmml" xref="S4.E9.m2.1.1.1.1.1.2"></times><ci id="S4.E9.m2.1.1.1.1.1.3.cmml" xref="S4.E9.m2.1.1.1.1.1.3">𝑆</ci><ci id="S4.E9.m2.1.1.1.1.1.4.cmml" xref="S4.E9.m2.1.1.1.1.1.4">𝑜</ci><ci id="S4.E9.m2.1.1.1.1.1.5.cmml" xref="S4.E9.m2.1.1.1.1.1.5">𝑓</ci><ci id="S4.E9.m2.1.1.1.1.1.6.cmml" xref="S4.E9.m2.1.1.1.1.1.6">𝑡</ci><ci id="S4.E9.m2.1.1.1.1.1.7.cmml" xref="S4.E9.m2.1.1.1.1.1.7">𝑚</ci><ci id="S4.E9.m2.1.1.1.1.1.8.cmml" xref="S4.E9.m2.1.1.1.1.1.8">𝑎</ci><ci id="S4.E9.m2.1.1.1.1.1.9.cmml" xref="S4.E9.m2.1.1.1.1.1.9">𝑥</ci><apply id="S4.E9.m2.1.1.1.1.1.1.1.1.cmml" xref="S4.E9.m2.1.1.1.1.1.1.1"><divide id="S4.E9.m2.1.1.1.1.1.1.1.1.1.cmml" xref="S4.E9.m2.1.1.1.1.1.1.1.1.1"></divide><apply id="S4.E9.m2.1.1.1.1.1.1.1.1.2.cmml" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2"><times id="S4.E9.m2.1.1.1.1.1.1.1.1.2.1.cmml" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2.1"></times><ci id="S4.E9.m2.1.1.1.1.1.1.1.1.2.2.cmml" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2.2">𝑄</ci><apply id="S4.E9.m2.1.1.1.1.1.1.1.1.2.3.cmml" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2.3"><csymbol cd="ambiguous" id="S4.E9.m2.1.1.1.1.1.1.1.1.2.3.1.cmml" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2.3">superscript</csymbol><ci id="S4.E9.m2.1.1.1.1.1.1.1.1.2.3.2.cmml" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2.3.2">𝐾</ci><ci id="S4.E9.m2.1.1.1.1.1.1.1.1.2.3.3.cmml" xref="S4.E9.m2.1.1.1.1.1.1.1.1.2.3.3">𝑇</ci></apply></apply><apply id="S4.E9.m2.1.1.1.1.1.1.1.1.3.cmml" xref="S4.E9.m2.1.1.1.1.1.1.1.1.3"><root id="S4.E9.m2.1.1.1.1.1.1.1.1.3a.cmml" xref="S4.E9.m2.1.1.1.1.1.1.1.1.3"></root><ci id="S4.E9.m2.1.1.1.1.1.1.1.1.3.2.cmml" xref="S4.E9.m2.1.1.1.1.1.1.1.1.3.2">𝑑</ci></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E9.m2.1c">\displaystyle=Softmax(QK^{T}/\sqrt{d}),</annotation><annotation encoding="application/x-llamapun" id="S4.E9.m2.1d">= italic_S italic_o italic_f italic_t italic_m italic_a italic_x ( italic_Q italic_K start_POSTSUPERSCRIPT italic_T end_POSTSUPERSCRIPT / square-root start_ARG italic_d end_ARG ) ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(9)</span></td>
</tr></tbody>
<tbody id="S4.E10"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math alttext="\displaystyle A" class="ltx_Math" display="inline" id="S4.E10.m1.1"><semantics id="S4.E10.m1.1a"><mi id="S4.E10.m1.1.1" xref="S4.E10.m1.1.1.cmml">A</mi><annotation-xml encoding="MathML-Content" id="S4.E10.m1.1b"><ci id="S4.E10.m1.1.1.cmml" xref="S4.E10.m1.1.1">𝐴</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.E10.m1.1c">\displaystyle A</annotation><annotation encoding="application/x-llamapun" id="S4.E10.m1.1d">italic_A</annotation></semantics></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle=\displaystyle\sum_{k=1}^{L}P_{k}" class="ltx_Math" display="inline" id="S4.E10.m2.1"><semantics id="S4.E10.m2.1a"><mrow id="S4.E10.m2.1.1" xref="S4.E10.m2.1.1.cmml"><mi id="S4.E10.m2.1.1.2" xref="S4.E10.m2.1.1.2.cmml"></mi><mo id="S4.E10.m2.1.1.1" xref="S4.E10.m2.1.1.1.cmml">=</mo><mrow id="S4.E10.m2.1.1.3" xref="S4.E10.m2.1.1.3.cmml"><mstyle displaystyle="true" id="S4.E10.m2.1.1.3.1" xref="S4.E10.m2.1.1.3.1.cmml"><munderover id="S4.E10.m2.1.1.3.1a" xref="S4.E10.m2.1.1.3.1.cmml"><mo id="S4.E10.m2.1.1.3.1.2.2" movablelimits="false" xref="S4.E10.m2.1.1.3.1.2.2.cmml">∑</mo><mrow id="S4.E10.m2.1.1.3.1.2.3" xref="S4.E10.m2.1.1.3.1.2.3.cmml"><mi id="S4.E10.m2.1.1.3.1.2.3.2" xref="S4.E10.m2.1.1.3.1.2.3.2.cmml">k</mi><mo id="S4.E10.m2.1.1.3.1.2.3.1" xref="S4.E10.m2.1.1.3.1.2.3.1.cmml">=</mo><mn id="S4.E10.m2.1.1.3.1.2.3.3" xref="S4.E10.m2.1.1.3.1.2.3.3.cmml">1</mn></mrow><mi id="S4.E10.m2.1.1.3.1.3" xref="S4.E10.m2.1.1.3.1.3.cmml">L</mi></munderover></mstyle><msub id="S4.E10.m2.1.1.3.2" xref="S4.E10.m2.1.1.3.2.cmml"><mi id="S4.E10.m2.1.1.3.2.2" xref="S4.E10.m2.1.1.3.2.2.cmml">P</mi><mi id="S4.E10.m2.1.1.3.2.3" xref="S4.E10.m2.1.1.3.2.3.cmml">k</mi></msub></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E10.m2.1b"><apply id="S4.E10.m2.1.1.cmml" xref="S4.E10.m2.1.1"><eq id="S4.E10.m2.1.1.1.cmml" xref="S4.E10.m2.1.1.1"></eq><csymbol cd="latexml" id="S4.E10.m2.1.1.2.cmml" xref="S4.E10.m2.1.1.2">absent</csymbol><apply id="S4.E10.m2.1.1.3.cmml" xref="S4.E10.m2.1.1.3"><apply id="S4.E10.m2.1.1.3.1.cmml" xref="S4.E10.m2.1.1.3.1"><csymbol cd="ambiguous" id="S4.E10.m2.1.1.3.1.1.cmml" xref="S4.E10.m2.1.1.3.1">superscript</csymbol><apply id="S4.E10.m2.1.1.3.1.2.cmml" xref="S4.E10.m2.1.1.3.1"><csymbol cd="ambiguous" id="S4.E10.m2.1.1.3.1.2.1.cmml" xref="S4.E10.m2.1.1.3.1">subscript</csymbol><sum id="S4.E10.m2.1.1.3.1.2.2.cmml" xref="S4.E10.m2.1.1.3.1.2.2"></sum><apply id="S4.E10.m2.1.1.3.1.2.3.cmml" xref="S4.E10.m2.1.1.3.1.2.3"><eq id="S4.E10.m2.1.1.3.1.2.3.1.cmml" xref="S4.E10.m2.1.1.3.1.2.3.1"></eq><ci id="S4.E10.m2.1.1.3.1.2.3.2.cmml" xref="S4.E10.m2.1.1.3.1.2.3.2">𝑘</ci><cn id="S4.E10.m2.1.1.3.1.2.3.3.cmml" type="integer" xref="S4.E10.m2.1.1.3.1.2.3.3">1</cn></apply></apply><ci id="S4.E10.m2.1.1.3.1.3.cmml" xref="S4.E10.m2.1.1.3.1.3">𝐿</ci></apply><apply id="S4.E10.m2.1.1.3.2.cmml" xref="S4.E10.m2.1.1.3.2"><csymbol cd="ambiguous" id="S4.E10.m2.1.1.3.2.1.cmml" xref="S4.E10.m2.1.1.3.2">subscript</csymbol><ci id="S4.E10.m2.1.1.3.2.2.cmml" xref="S4.E10.m2.1.1.3.2.2">𝑃</ci><ci id="S4.E10.m2.1.1.3.2.3.cmml" xref="S4.E10.m2.1.1.3.2.3">𝑘</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E10.m2.1c">\displaystyle=\displaystyle\sum_{k=1}^{L}P_{k}</annotation><annotation encoding="application/x-llamapun" id="S4.E10.m2.1d">= ∑ start_POSTSUBSCRIPT italic_k = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_L end_POSTSUPERSCRIPT italic_P start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(10)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS7.p1.8">Our proposed attention loss <math alttext="\mathcal{L}_{attn}" class="ltx_Math" display="inline" id="S4.SS7.p1.8.m1.1"><semantics id="S4.SS7.p1.8.m1.1a"><msub id="S4.SS7.p1.8.m1.1.1" xref="S4.SS7.p1.8.m1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.SS7.p1.8.m1.1.1.2" xref="S4.SS7.p1.8.m1.1.1.2.cmml">ℒ</mi><mrow id="S4.SS7.p1.8.m1.1.1.3" xref="S4.SS7.p1.8.m1.1.1.3.cmml"><mi id="S4.SS7.p1.8.m1.1.1.3.2" xref="S4.SS7.p1.8.m1.1.1.3.2.cmml">a</mi><mo id="S4.SS7.p1.8.m1.1.1.3.1" xref="S4.SS7.p1.8.m1.1.1.3.1.cmml">⁢</mo><mi id="S4.SS7.p1.8.m1.1.1.3.3" xref="S4.SS7.p1.8.m1.1.1.3.3.cmml">t</mi><mo id="S4.SS7.p1.8.m1.1.1.3.1a" xref="S4.SS7.p1.8.m1.1.1.3.1.cmml">⁢</mo><mi id="S4.SS7.p1.8.m1.1.1.3.4" xref="S4.SS7.p1.8.m1.1.1.3.4.cmml">t</mi><mo id="S4.SS7.p1.8.m1.1.1.3.1b" xref="S4.SS7.p1.8.m1.1.1.3.1.cmml">⁢</mo><mi id="S4.SS7.p1.8.m1.1.1.3.5" xref="S4.SS7.p1.8.m1.1.1.3.5.cmml">n</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S4.SS7.p1.8.m1.1b"><apply id="S4.SS7.p1.8.m1.1.1.cmml" xref="S4.SS7.p1.8.m1.1.1"><csymbol cd="ambiguous" id="S4.SS7.p1.8.m1.1.1.1.cmml" xref="S4.SS7.p1.8.m1.1.1">subscript</csymbol><ci id="S4.SS7.p1.8.m1.1.1.2.cmml" xref="S4.SS7.p1.8.m1.1.1.2">ℒ</ci><apply id="S4.SS7.p1.8.m1.1.1.3.cmml" xref="S4.SS7.p1.8.m1.1.1.3"><times id="S4.SS7.p1.8.m1.1.1.3.1.cmml" xref="S4.SS7.p1.8.m1.1.1.3.1"></times><ci id="S4.SS7.p1.8.m1.1.1.3.2.cmml" xref="S4.SS7.p1.8.m1.1.1.3.2">𝑎</ci><ci id="S4.SS7.p1.8.m1.1.1.3.3.cmml" xref="S4.SS7.p1.8.m1.1.1.3.3">𝑡</ci><ci id="S4.SS7.p1.8.m1.1.1.3.4.cmml" xref="S4.SS7.p1.8.m1.1.1.3.4">𝑡</ci><ci id="S4.SS7.p1.8.m1.1.1.3.5.cmml" xref="S4.SS7.p1.8.m1.1.1.3.5">𝑛</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS7.p1.8.m1.1c">\mathcal{L}_{attn}</annotation><annotation encoding="application/x-llamapun" id="S4.SS7.p1.8.m1.1d">caligraphic_L start_POSTSUBSCRIPT italic_a italic_t italic_t italic_n end_POSTSUBSCRIPT</annotation></semantics></math> can be formulated as follows:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E11">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathcal{L}_{attn}=\frac{1}{N+1}\displaystyle\sum_{k=1}^{N+1}\left\|A_{k}-M_{k%
}\right\|_{2}^{2}," class="ltx_Math" display="block" id="S4.E11.m1.1"><semantics id="S4.E11.m1.1a"><mrow id="S4.E11.m1.1.1.1" xref="S4.E11.m1.1.1.1.1.cmml"><mrow id="S4.E11.m1.1.1.1.1" xref="S4.E11.m1.1.1.1.1.cmml"><msub id="S4.E11.m1.1.1.1.1.3" xref="S4.E11.m1.1.1.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E11.m1.1.1.1.1.3.2" xref="S4.E11.m1.1.1.1.1.3.2.cmml">ℒ</mi><mrow id="S4.E11.m1.1.1.1.1.3.3" xref="S4.E11.m1.1.1.1.1.3.3.cmml"><mi id="S4.E11.m1.1.1.1.1.3.3.2" xref="S4.E11.m1.1.1.1.1.3.3.2.cmml">a</mi><mo id="S4.E11.m1.1.1.1.1.3.3.1" xref="S4.E11.m1.1.1.1.1.3.3.1.cmml">⁢</mo><mi id="S4.E11.m1.1.1.1.1.3.3.3" xref="S4.E11.m1.1.1.1.1.3.3.3.cmml">t</mi><mo id="S4.E11.m1.1.1.1.1.3.3.1a" xref="S4.E11.m1.1.1.1.1.3.3.1.cmml">⁢</mo><mi id="S4.E11.m1.1.1.1.1.3.3.4" xref="S4.E11.m1.1.1.1.1.3.3.4.cmml">t</mi><mo id="S4.E11.m1.1.1.1.1.3.3.1b" xref="S4.E11.m1.1.1.1.1.3.3.1.cmml">⁢</mo><mi id="S4.E11.m1.1.1.1.1.3.3.5" xref="S4.E11.m1.1.1.1.1.3.3.5.cmml">n</mi></mrow></msub><mo id="S4.E11.m1.1.1.1.1.2" xref="S4.E11.m1.1.1.1.1.2.cmml">=</mo><mrow id="S4.E11.m1.1.1.1.1.1" xref="S4.E11.m1.1.1.1.1.1.cmml"><mfrac id="S4.E11.m1.1.1.1.1.1.3" xref="S4.E11.m1.1.1.1.1.1.3.cmml"><mn id="S4.E11.m1.1.1.1.1.1.3.2" xref="S4.E11.m1.1.1.1.1.1.3.2.cmml">1</mn><mrow id="S4.E11.m1.1.1.1.1.1.3.3" xref="S4.E11.m1.1.1.1.1.1.3.3.cmml"><mi id="S4.E11.m1.1.1.1.1.1.3.3.2" xref="S4.E11.m1.1.1.1.1.1.3.3.2.cmml">N</mi><mo id="S4.E11.m1.1.1.1.1.1.3.3.1" xref="S4.E11.m1.1.1.1.1.1.3.3.1.cmml">+</mo><mn id="S4.E11.m1.1.1.1.1.1.3.3.3" xref="S4.E11.m1.1.1.1.1.1.3.3.3.cmml">1</mn></mrow></mfrac><mo id="S4.E11.m1.1.1.1.1.1.2" xref="S4.E11.m1.1.1.1.1.1.2.cmml">⁢</mo><mrow id="S4.E11.m1.1.1.1.1.1.1" xref="S4.E11.m1.1.1.1.1.1.1.cmml"><munderover id="S4.E11.m1.1.1.1.1.1.1.2" xref="S4.E11.m1.1.1.1.1.1.1.2.cmml"><mo id="S4.E11.m1.1.1.1.1.1.1.2.2.2" movablelimits="false" rspace="0em" xref="S4.E11.m1.1.1.1.1.1.1.2.2.2.cmml">∑</mo><mrow id="S4.E11.m1.1.1.1.1.1.1.2.2.3" xref="S4.E11.m1.1.1.1.1.1.1.2.2.3.cmml"><mi id="S4.E11.m1.1.1.1.1.1.1.2.2.3.2" xref="S4.E11.m1.1.1.1.1.1.1.2.2.3.2.cmml">k</mi><mo id="S4.E11.m1.1.1.1.1.1.1.2.2.3.1" xref="S4.E11.m1.1.1.1.1.1.1.2.2.3.1.cmml">=</mo><mn id="S4.E11.m1.1.1.1.1.1.1.2.2.3.3" xref="S4.E11.m1.1.1.1.1.1.1.2.2.3.3.cmml">1</mn></mrow><mrow id="S4.E11.m1.1.1.1.1.1.1.2.3" xref="S4.E11.m1.1.1.1.1.1.1.2.3.cmml"><mi id="S4.E11.m1.1.1.1.1.1.1.2.3.2" xref="S4.E11.m1.1.1.1.1.1.1.2.3.2.cmml">N</mi><mo id="S4.E11.m1.1.1.1.1.1.1.2.3.1" xref="S4.E11.m1.1.1.1.1.1.1.2.3.1.cmml">+</mo><mn id="S4.E11.m1.1.1.1.1.1.1.2.3.3" xref="S4.E11.m1.1.1.1.1.1.1.2.3.3.cmml">1</mn></mrow></munderover><msubsup id="S4.E11.m1.1.1.1.1.1.1.1" xref="S4.E11.m1.1.1.1.1.1.1.1.cmml"><mrow id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.2.cmml"><mo id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.2" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.2.1.cmml">‖</mo><mrow id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.cmml"><msub id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2.cmml"><mi id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2.2" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2.2.cmml">A</mi><mi id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2.3" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2.3.cmml">k</mi></msub><mo id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.1" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.1.cmml">−</mo><msub id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3.cmml"><mi id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3.2" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3.2.cmml">M</mi><mi id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3.3" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3.3.cmml">k</mi></msub></mrow><mo id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.3" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.2.1.cmml">‖</mo></mrow><mn id="S4.E11.m1.1.1.1.1.1.1.1.1.3" xref="S4.E11.m1.1.1.1.1.1.1.1.1.3.cmml">2</mn><mn id="S4.E11.m1.1.1.1.1.1.1.1.3" xref="S4.E11.m1.1.1.1.1.1.1.1.3.cmml">2</mn></msubsup></mrow></mrow></mrow><mo id="S4.E11.m1.1.1.1.2" xref="S4.E11.m1.1.1.1.1.cmml">,</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.E11.m1.1b"><apply id="S4.E11.m1.1.1.1.1.cmml" xref="S4.E11.m1.1.1.1"><eq id="S4.E11.m1.1.1.1.1.2.cmml" xref="S4.E11.m1.1.1.1.1.2"></eq><apply id="S4.E11.m1.1.1.1.1.3.cmml" xref="S4.E11.m1.1.1.1.1.3"><csymbol cd="ambiguous" id="S4.E11.m1.1.1.1.1.3.1.cmml" xref="S4.E11.m1.1.1.1.1.3">subscript</csymbol><ci id="S4.E11.m1.1.1.1.1.3.2.cmml" xref="S4.E11.m1.1.1.1.1.3.2">ℒ</ci><apply id="S4.E11.m1.1.1.1.1.3.3.cmml" xref="S4.E11.m1.1.1.1.1.3.3"><times id="S4.E11.m1.1.1.1.1.3.3.1.cmml" xref="S4.E11.m1.1.1.1.1.3.3.1"></times><ci id="S4.E11.m1.1.1.1.1.3.3.2.cmml" xref="S4.E11.m1.1.1.1.1.3.3.2">𝑎</ci><ci id="S4.E11.m1.1.1.1.1.3.3.3.cmml" xref="S4.E11.m1.1.1.1.1.3.3.3">𝑡</ci><ci id="S4.E11.m1.1.1.1.1.3.3.4.cmml" xref="S4.E11.m1.1.1.1.1.3.3.4">𝑡</ci><ci id="S4.E11.m1.1.1.1.1.3.3.5.cmml" xref="S4.E11.m1.1.1.1.1.3.3.5">𝑛</ci></apply></apply><apply id="S4.E11.m1.1.1.1.1.1.cmml" xref="S4.E11.m1.1.1.1.1.1"><times id="S4.E11.m1.1.1.1.1.1.2.cmml" xref="S4.E11.m1.1.1.1.1.1.2"></times><apply id="S4.E11.m1.1.1.1.1.1.3.cmml" xref="S4.E11.m1.1.1.1.1.1.3"><divide id="S4.E11.m1.1.1.1.1.1.3.1.cmml" xref="S4.E11.m1.1.1.1.1.1.3"></divide><cn id="S4.E11.m1.1.1.1.1.1.3.2.cmml" type="integer" xref="S4.E11.m1.1.1.1.1.1.3.2">1</cn><apply id="S4.E11.m1.1.1.1.1.1.3.3.cmml" xref="S4.E11.m1.1.1.1.1.1.3.3"><plus id="S4.E11.m1.1.1.1.1.1.3.3.1.cmml" xref="S4.E11.m1.1.1.1.1.1.3.3.1"></plus><ci id="S4.E11.m1.1.1.1.1.1.3.3.2.cmml" xref="S4.E11.m1.1.1.1.1.1.3.3.2">𝑁</ci><cn id="S4.E11.m1.1.1.1.1.1.3.3.3.cmml" type="integer" xref="S4.E11.m1.1.1.1.1.1.3.3.3">1</cn></apply></apply><apply id="S4.E11.m1.1.1.1.1.1.1.cmml" xref="S4.E11.m1.1.1.1.1.1.1"><apply id="S4.E11.m1.1.1.1.1.1.1.2.cmml" xref="S4.E11.m1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E11.m1.1.1.1.1.1.1.2.1.cmml" xref="S4.E11.m1.1.1.1.1.1.1.2">superscript</csymbol><apply id="S4.E11.m1.1.1.1.1.1.1.2.2.cmml" xref="S4.E11.m1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E11.m1.1.1.1.1.1.1.2.2.1.cmml" xref="S4.E11.m1.1.1.1.1.1.1.2">subscript</csymbol><sum id="S4.E11.m1.1.1.1.1.1.1.2.2.2.cmml" xref="S4.E11.m1.1.1.1.1.1.1.2.2.2"></sum><apply id="S4.E11.m1.1.1.1.1.1.1.2.2.3.cmml" xref="S4.E11.m1.1.1.1.1.1.1.2.2.3"><eq id="S4.E11.m1.1.1.1.1.1.1.2.2.3.1.cmml" xref="S4.E11.m1.1.1.1.1.1.1.2.2.3.1"></eq><ci id="S4.E11.m1.1.1.1.1.1.1.2.2.3.2.cmml" xref="S4.E11.m1.1.1.1.1.1.1.2.2.3.2">𝑘</ci><cn id="S4.E11.m1.1.1.1.1.1.1.2.2.3.3.cmml" type="integer" xref="S4.E11.m1.1.1.1.1.1.1.2.2.3.3">1</cn></apply></apply><apply id="S4.E11.m1.1.1.1.1.1.1.2.3.cmml" xref="S4.E11.m1.1.1.1.1.1.1.2.3"><plus id="S4.E11.m1.1.1.1.1.1.1.2.3.1.cmml" xref="S4.E11.m1.1.1.1.1.1.1.2.3.1"></plus><ci id="S4.E11.m1.1.1.1.1.1.1.2.3.2.cmml" xref="S4.E11.m1.1.1.1.1.1.1.2.3.2">𝑁</ci><cn id="S4.E11.m1.1.1.1.1.1.1.2.3.3.cmml" type="integer" xref="S4.E11.m1.1.1.1.1.1.1.2.3.3">1</cn></apply></apply><apply id="S4.E11.m1.1.1.1.1.1.1.1.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.E11.m1.1.1.1.1.1.1.1.2.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1">superscript</csymbol><apply id="S4.E11.m1.1.1.1.1.1.1.1.1.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.E11.m1.1.1.1.1.1.1.1.1.2.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1">subscript</csymbol><apply id="S4.E11.m1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1"><csymbol cd="latexml" id="S4.E11.m1.1.1.1.1.1.1.1.1.1.2.1.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.2">norm</csymbol><apply id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1"><minus id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.1"></minus><apply id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2.1.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2">subscript</csymbol><ci id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2.2.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2.2">𝐴</ci><ci id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2.3.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.2.3">𝑘</ci></apply><apply id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3"><csymbol cd="ambiguous" id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3.1.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3">subscript</csymbol><ci id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3.2.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3.2">𝑀</ci><ci id="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3.3.cmml" xref="S4.E11.m1.1.1.1.1.1.1.1.1.1.1.1.3.3">𝑘</ci></apply></apply></apply><cn id="S4.E11.m1.1.1.1.1.1.1.1.1.3.cmml" type="integer" xref="S4.E11.m1.1.1.1.1.1.1.1.1.3">2</cn></apply><cn id="S4.E11.m1.1.1.1.1.1.1.1.3.cmml" type="integer" xref="S4.E11.m1.1.1.1.1.1.1.1.3">2</cn></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E11.m1.1c">\mathcal{L}_{attn}=\frac{1}{N+1}\displaystyle\sum_{k=1}^{N+1}\left\|A_{k}-M_{k%
}\right\|_{2}^{2},</annotation><annotation encoding="application/x-llamapun" id="S4.E11.m1.1d">caligraphic_L start_POSTSUBSCRIPT italic_a italic_t italic_t italic_n end_POSTSUBSCRIPT = divide start_ARG 1 end_ARG start_ARG italic_N + 1 end_ARG ∑ start_POSTSUBSCRIPT italic_k = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_N + 1 end_POSTSUPERSCRIPT ∥ italic_A start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT - italic_M start_POSTSUBSCRIPT italic_k end_POSTSUBSCRIPT ∥ start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT 2 end_POSTSUPERSCRIPT ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(11)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS7.p1.9">where <math alttext="N" class="ltx_Math" display="inline" id="S4.SS7.p1.9.m1.1"><semantics id="S4.SS7.p1.9.m1.1a"><mi id="S4.SS7.p1.9.m1.1.1" xref="S4.SS7.p1.9.m1.1.1.cmml">N</mi><annotation-xml encoding="MathML-Content" id="S4.SS7.p1.9.m1.1b"><ci id="S4.SS7.p1.9.m1.1.1.cmml" xref="S4.SS7.p1.9.m1.1.1">𝑁</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS7.p1.9.m1.1c">N</annotation><annotation encoding="application/x-llamapun" id="S4.SS7.p1.9.m1.1d">italic_N</annotation></semantics></math> is number of characters in the reference image, and "+1" represents the background.</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS8">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.8 </span>Overall Loss</h3>
<div class="ltx_para ltx_noindent" id="S4.SS8.p1">
<p class="ltx_p" id="S4.SS8.p1.2">In training, we average <math alttext="\mathcal{L}_{attn}" class="ltx_Math" display="inline" id="S4.SS8.p1.1.m1.1"><semantics id="S4.SS8.p1.1.m1.1a"><msub id="S4.SS8.p1.1.m1.1.1" xref="S4.SS8.p1.1.m1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.SS8.p1.1.m1.1.1.2" xref="S4.SS8.p1.1.m1.1.1.2.cmml">ℒ</mi><mrow id="S4.SS8.p1.1.m1.1.1.3" xref="S4.SS8.p1.1.m1.1.1.3.cmml"><mi id="S4.SS8.p1.1.m1.1.1.3.2" xref="S4.SS8.p1.1.m1.1.1.3.2.cmml">a</mi><mo id="S4.SS8.p1.1.m1.1.1.3.1" xref="S4.SS8.p1.1.m1.1.1.3.1.cmml">⁢</mo><mi id="S4.SS8.p1.1.m1.1.1.3.3" xref="S4.SS8.p1.1.m1.1.1.3.3.cmml">t</mi><mo id="S4.SS8.p1.1.m1.1.1.3.1a" xref="S4.SS8.p1.1.m1.1.1.3.1.cmml">⁢</mo><mi id="S4.SS8.p1.1.m1.1.1.3.4" xref="S4.SS8.p1.1.m1.1.1.3.4.cmml">t</mi><mo id="S4.SS8.p1.1.m1.1.1.3.1b" xref="S4.SS8.p1.1.m1.1.1.3.1.cmml">⁢</mo><mi id="S4.SS8.p1.1.m1.1.1.3.5" xref="S4.SS8.p1.1.m1.1.1.3.5.cmml">n</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S4.SS8.p1.1.m1.1b"><apply id="S4.SS8.p1.1.m1.1.1.cmml" xref="S4.SS8.p1.1.m1.1.1"><csymbol cd="ambiguous" id="S4.SS8.p1.1.m1.1.1.1.cmml" xref="S4.SS8.p1.1.m1.1.1">subscript</csymbol><ci id="S4.SS8.p1.1.m1.1.1.2.cmml" xref="S4.SS8.p1.1.m1.1.1.2">ℒ</ci><apply id="S4.SS8.p1.1.m1.1.1.3.cmml" xref="S4.SS8.p1.1.m1.1.1.3"><times id="S4.SS8.p1.1.m1.1.1.3.1.cmml" xref="S4.SS8.p1.1.m1.1.1.3.1"></times><ci id="S4.SS8.p1.1.m1.1.1.3.2.cmml" xref="S4.SS8.p1.1.m1.1.1.3.2">𝑎</ci><ci id="S4.SS8.p1.1.m1.1.1.3.3.cmml" xref="S4.SS8.p1.1.m1.1.1.3.3">𝑡</ci><ci id="S4.SS8.p1.1.m1.1.1.3.4.cmml" xref="S4.SS8.p1.1.m1.1.1.3.4">𝑡</ci><ci id="S4.SS8.p1.1.m1.1.1.3.5.cmml" xref="S4.SS8.p1.1.m1.1.1.3.5">𝑛</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS8.p1.1.m1.1c">\mathcal{L}_{attn}</annotation><annotation encoding="application/x-llamapun" id="S4.SS8.p1.1.m1.1d">caligraphic_L start_POSTSUBSCRIPT italic_a italic_t italic_t italic_n end_POSTSUBSCRIPT</annotation></semantics></math> across all <math alttext="M" class="ltx_Math" display="inline" id="S4.SS8.p1.2.m2.1"><semantics id="S4.SS8.p1.2.m2.1a"><mi id="S4.SS8.p1.2.m2.1.1" xref="S4.SS8.p1.2.m2.1.1.cmml">M</mi><annotation-xml encoding="MathML-Content" id="S4.SS8.p1.2.m2.1b"><ci id="S4.SS8.p1.2.m2.1.1.cmml" xref="S4.SS8.p1.2.m2.1.1">𝑀</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS8.p1.2.m2.1c">M</annotation><annotation encoding="application/x-llamapun" id="S4.SS8.p1.2.m2.1d">italic_M</annotation></semantics></math> layers and combine it with the diffusion loss as follows:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E12">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathcal{L}=\mathcal{L}_{SD}+\frac{\lambda}{M}\sum_{l=1}^{M}\mathcal{L}_{attn}" class="ltx_Math" display="block" id="S4.E12.m1.1"><semantics id="S4.E12.m1.1a"><mrow id="S4.E12.m1.1.1" xref="S4.E12.m1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E12.m1.1.1.2" xref="S4.E12.m1.1.1.2.cmml">ℒ</mi><mo id="S4.E12.m1.1.1.1" xref="S4.E12.m1.1.1.1.cmml">=</mo><mrow id="S4.E12.m1.1.1.3" xref="S4.E12.m1.1.1.3.cmml"><msub id="S4.E12.m1.1.1.3.2" xref="S4.E12.m1.1.1.3.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E12.m1.1.1.3.2.2" xref="S4.E12.m1.1.1.3.2.2.cmml">ℒ</mi><mrow id="S4.E12.m1.1.1.3.2.3" xref="S4.E12.m1.1.1.3.2.3.cmml"><mi id="S4.E12.m1.1.1.3.2.3.2" xref="S4.E12.m1.1.1.3.2.3.2.cmml">S</mi><mo id="S4.E12.m1.1.1.3.2.3.1" xref="S4.E12.m1.1.1.3.2.3.1.cmml">⁢</mo><mi id="S4.E12.m1.1.1.3.2.3.3" xref="S4.E12.m1.1.1.3.2.3.3.cmml">D</mi></mrow></msub><mo id="S4.E12.m1.1.1.3.1" xref="S4.E12.m1.1.1.3.1.cmml">+</mo><mrow id="S4.E12.m1.1.1.3.3" xref="S4.E12.m1.1.1.3.3.cmml"><mfrac id="S4.E12.m1.1.1.3.3.2" xref="S4.E12.m1.1.1.3.3.2.cmml"><mi id="S4.E12.m1.1.1.3.3.2.2" xref="S4.E12.m1.1.1.3.3.2.2.cmml">λ</mi><mi id="S4.E12.m1.1.1.3.3.2.3" xref="S4.E12.m1.1.1.3.3.2.3.cmml">M</mi></mfrac><mo id="S4.E12.m1.1.1.3.3.1" xref="S4.E12.m1.1.1.3.3.1.cmml">⁢</mo><mrow id="S4.E12.m1.1.1.3.3.3" xref="S4.E12.m1.1.1.3.3.3.cmml"><munderover id="S4.E12.m1.1.1.3.3.3.1" xref="S4.E12.m1.1.1.3.3.3.1.cmml"><mo id="S4.E12.m1.1.1.3.3.3.1.2.2" movablelimits="false" xref="S4.E12.m1.1.1.3.3.3.1.2.2.cmml">∑</mo><mrow id="S4.E12.m1.1.1.3.3.3.1.2.3" xref="S4.E12.m1.1.1.3.3.3.1.2.3.cmml"><mi id="S4.E12.m1.1.1.3.3.3.1.2.3.2" xref="S4.E12.m1.1.1.3.3.3.1.2.3.2.cmml">l</mi><mo id="S4.E12.m1.1.1.3.3.3.1.2.3.1" xref="S4.E12.m1.1.1.3.3.3.1.2.3.1.cmml">=</mo><mn id="S4.E12.m1.1.1.3.3.3.1.2.3.3" xref="S4.E12.m1.1.1.3.3.3.1.2.3.3.cmml">1</mn></mrow><mi id="S4.E12.m1.1.1.3.3.3.1.3" xref="S4.E12.m1.1.1.3.3.3.1.3.cmml">M</mi></munderover><msub id="S4.E12.m1.1.1.3.3.3.2" xref="S4.E12.m1.1.1.3.3.3.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E12.m1.1.1.3.3.3.2.2" xref="S4.E12.m1.1.1.3.3.3.2.2.cmml">ℒ</mi><mrow id="S4.E12.m1.1.1.3.3.3.2.3" xref="S4.E12.m1.1.1.3.3.3.2.3.cmml"><mi id="S4.E12.m1.1.1.3.3.3.2.3.2" xref="S4.E12.m1.1.1.3.3.3.2.3.2.cmml">a</mi><mo id="S4.E12.m1.1.1.3.3.3.2.3.1" xref="S4.E12.m1.1.1.3.3.3.2.3.1.cmml">⁢</mo><mi id="S4.E12.m1.1.1.3.3.3.2.3.3" xref="S4.E12.m1.1.1.3.3.3.2.3.3.cmml">t</mi><mo id="S4.E12.m1.1.1.3.3.3.2.3.1a" xref="S4.E12.m1.1.1.3.3.3.2.3.1.cmml">⁢</mo><mi id="S4.E12.m1.1.1.3.3.3.2.3.4" xref="S4.E12.m1.1.1.3.3.3.2.3.4.cmml">t</mi><mo id="S4.E12.m1.1.1.3.3.3.2.3.1b" xref="S4.E12.m1.1.1.3.3.3.2.3.1.cmml">⁢</mo><mi id="S4.E12.m1.1.1.3.3.3.2.3.5" xref="S4.E12.m1.1.1.3.3.3.2.3.5.cmml">n</mi></mrow></msub></mrow></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E12.m1.1b"><apply id="S4.E12.m1.1.1.cmml" xref="S4.E12.m1.1.1"><eq id="S4.E12.m1.1.1.1.cmml" xref="S4.E12.m1.1.1.1"></eq><ci id="S4.E12.m1.1.1.2.cmml" xref="S4.E12.m1.1.1.2">ℒ</ci><apply id="S4.E12.m1.1.1.3.cmml" xref="S4.E12.m1.1.1.3"><plus id="S4.E12.m1.1.1.3.1.cmml" xref="S4.E12.m1.1.1.3.1"></plus><apply id="S4.E12.m1.1.1.3.2.cmml" xref="S4.E12.m1.1.1.3.2"><csymbol cd="ambiguous" id="S4.E12.m1.1.1.3.2.1.cmml" xref="S4.E12.m1.1.1.3.2">subscript</csymbol><ci id="S4.E12.m1.1.1.3.2.2.cmml" xref="S4.E12.m1.1.1.3.2.2">ℒ</ci><apply id="S4.E12.m1.1.1.3.2.3.cmml" xref="S4.E12.m1.1.1.3.2.3"><times id="S4.E12.m1.1.1.3.2.3.1.cmml" xref="S4.E12.m1.1.1.3.2.3.1"></times><ci id="S4.E12.m1.1.1.3.2.3.2.cmml" xref="S4.E12.m1.1.1.3.2.3.2">𝑆</ci><ci id="S4.E12.m1.1.1.3.2.3.3.cmml" xref="S4.E12.m1.1.1.3.2.3.3">𝐷</ci></apply></apply><apply id="S4.E12.m1.1.1.3.3.cmml" xref="S4.E12.m1.1.1.3.3"><times id="S4.E12.m1.1.1.3.3.1.cmml" xref="S4.E12.m1.1.1.3.3.1"></times><apply id="S4.E12.m1.1.1.3.3.2.cmml" xref="S4.E12.m1.1.1.3.3.2"><divide id="S4.E12.m1.1.1.3.3.2.1.cmml" xref="S4.E12.m1.1.1.3.3.2"></divide><ci id="S4.E12.m1.1.1.3.3.2.2.cmml" xref="S4.E12.m1.1.1.3.3.2.2">𝜆</ci><ci id="S4.E12.m1.1.1.3.3.2.3.cmml" xref="S4.E12.m1.1.1.3.3.2.3">𝑀</ci></apply><apply id="S4.E12.m1.1.1.3.3.3.cmml" xref="S4.E12.m1.1.1.3.3.3"><apply id="S4.E12.m1.1.1.3.3.3.1.cmml" xref="S4.E12.m1.1.1.3.3.3.1"><csymbol cd="ambiguous" id="S4.E12.m1.1.1.3.3.3.1.1.cmml" xref="S4.E12.m1.1.1.3.3.3.1">superscript</csymbol><apply id="S4.E12.m1.1.1.3.3.3.1.2.cmml" xref="S4.E12.m1.1.1.3.3.3.1"><csymbol cd="ambiguous" id="S4.E12.m1.1.1.3.3.3.1.2.1.cmml" xref="S4.E12.m1.1.1.3.3.3.1">subscript</csymbol><sum id="S4.E12.m1.1.1.3.3.3.1.2.2.cmml" xref="S4.E12.m1.1.1.3.3.3.1.2.2"></sum><apply id="S4.E12.m1.1.1.3.3.3.1.2.3.cmml" xref="S4.E12.m1.1.1.3.3.3.1.2.3"><eq id="S4.E12.m1.1.1.3.3.3.1.2.3.1.cmml" xref="S4.E12.m1.1.1.3.3.3.1.2.3.1"></eq><ci id="S4.E12.m1.1.1.3.3.3.1.2.3.2.cmml" xref="S4.E12.m1.1.1.3.3.3.1.2.3.2">𝑙</ci><cn id="S4.E12.m1.1.1.3.3.3.1.2.3.3.cmml" type="integer" xref="S4.E12.m1.1.1.3.3.3.1.2.3.3">1</cn></apply></apply><ci id="S4.E12.m1.1.1.3.3.3.1.3.cmml" xref="S4.E12.m1.1.1.3.3.3.1.3">𝑀</ci></apply><apply id="S4.E12.m1.1.1.3.3.3.2.cmml" xref="S4.E12.m1.1.1.3.3.3.2"><csymbol cd="ambiguous" id="S4.E12.m1.1.1.3.3.3.2.1.cmml" xref="S4.E12.m1.1.1.3.3.3.2">subscript</csymbol><ci id="S4.E12.m1.1.1.3.3.3.2.2.cmml" xref="S4.E12.m1.1.1.3.3.3.2.2">ℒ</ci><apply id="S4.E12.m1.1.1.3.3.3.2.3.cmml" xref="S4.E12.m1.1.1.3.3.3.2.3"><times id="S4.E12.m1.1.1.3.3.3.2.3.1.cmml" xref="S4.E12.m1.1.1.3.3.3.2.3.1"></times><ci id="S4.E12.m1.1.1.3.3.3.2.3.2.cmml" xref="S4.E12.m1.1.1.3.3.3.2.3.2">𝑎</ci><ci id="S4.E12.m1.1.1.3.3.3.2.3.3.cmml" xref="S4.E12.m1.1.1.3.3.3.2.3.3">𝑡</ci><ci id="S4.E12.m1.1.1.3.3.3.2.3.4.cmml" xref="S4.E12.m1.1.1.3.3.3.2.3.4">𝑡</ci><ci id="S4.E12.m1.1.1.3.3.3.2.3.5.cmml" xref="S4.E12.m1.1.1.3.3.3.2.3.5">𝑛</ci></apply></apply></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E12.m1.1c">\mathcal{L}=\mathcal{L}_{SD}+\frac{\lambda}{M}\sum_{l=1}^{M}\mathcal{L}_{attn}</annotation><annotation encoding="application/x-llamapun" id="S4.E12.m1.1d">caligraphic_L = caligraphic_L start_POSTSUBSCRIPT italic_S italic_D end_POSTSUBSCRIPT + divide start_ARG italic_λ end_ARG start_ARG italic_M end_ARG ∑ start_POSTSUBSCRIPT italic_l = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_M end_POSTSUPERSCRIPT caligraphic_L start_POSTSUBSCRIPT italic_a italic_t italic_t italic_n end_POSTSUBSCRIPT</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(12)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS8.p1.4">where <math alttext="\mathcal{L}" class="ltx_Math" display="inline" id="S4.SS8.p1.3.m1.1"><semantics id="S4.SS8.p1.3.m1.1a"><mi class="ltx_font_mathcaligraphic" id="S4.SS8.p1.3.m1.1.1" xref="S4.SS8.p1.3.m1.1.1.cmml">ℒ</mi><annotation-xml encoding="MathML-Content" id="S4.SS8.p1.3.m1.1b"><ci id="S4.SS8.p1.3.m1.1.1.cmml" xref="S4.SS8.p1.3.m1.1.1">ℒ</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS8.p1.3.m1.1c">\mathcal{L}</annotation><annotation encoding="application/x-llamapun" id="S4.SS8.p1.3.m1.1d">caligraphic_L</annotation></semantics></math> is our final training objective and <math alttext="\lambda" class="ltx_Math" display="inline" id="S4.SS8.p1.4.m2.1"><semantics id="S4.SS8.p1.4.m2.1a"><mi id="S4.SS8.p1.4.m2.1.1" xref="S4.SS8.p1.4.m2.1.1.cmml">λ</mi><annotation-xml encoding="MathML-Content" id="S4.SS8.p1.4.m2.1b"><ci id="S4.SS8.p1.4.m2.1.1.cmml" xref="S4.SS8.p1.4.m2.1.1">𝜆</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS8.p1.4.m2.1c">\lambda</annotation><annotation encoding="application/x-llamapun" id="S4.SS8.p1.4.m2.1d">italic_λ</annotation></semantics></math> is a weighting scalar.</p>
</div>
<figure class="ltx_table" id="S4.T1">
<figcaption class="ltx_caption"><span class="ltx_tag ltx_tag_table">Table 1: </span>Quantitative comparisons on character-conditioned generation.The best results are in <span class="ltx_text ltx_font_bold" id="S4.T1.5.1">bold</span>.</figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle" id="S4.T1.3">
<thead class="ltx_thead">
<tr class="ltx_tr" id="S4.T1.3.3">
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_t" id="S4.T1.3.3.4">Method</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_t" id="S4.T1.3.3.5">Multi-person</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_t" id="S4.T1.3.3.6">Clothing, etc.</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_t" id="S4.T1.1.1.1">Face Sim. <math alttext="\uparrow(\%)" class="ltx_math_unparsed" display="inline" id="S4.T1.1.1.1.m1.1"><semantics id="S4.T1.1.1.1.m1.1a"><mrow id="S4.T1.1.1.1.m1.1b"><mo id="S4.T1.1.1.1.m1.1.1" stretchy="false">↑</mo><mrow id="S4.T1.1.1.1.m1.1.2"><mo id="S4.T1.1.1.1.m1.1.2.1" stretchy="false">(</mo><mo id="S4.T1.1.1.1.m1.1.2.2">%</mo><mo id="S4.T1.1.1.1.m1.1.2.3" stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex" id="S4.T1.1.1.1.m1.1c">\uparrow(\%)</annotation><annotation encoding="application/x-llamapun" id="S4.T1.1.1.1.m1.1d">↑ ( % )</annotation></semantics></math>
</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_t" id="S4.T1.2.2.2">CLIP-T <math alttext="\uparrow(\%)" class="ltx_math_unparsed" display="inline" id="S4.T1.2.2.2.m1.1"><semantics id="S4.T1.2.2.2.m1.1a"><mrow id="S4.T1.2.2.2.m1.1b"><mo id="S4.T1.2.2.2.m1.1.1" stretchy="false">↑</mo><mrow id="S4.T1.2.2.2.m1.1.2"><mo id="S4.T1.2.2.2.m1.1.2.1" stretchy="false">(</mo><mo id="S4.T1.2.2.2.m1.1.2.2">%</mo><mo id="S4.T1.2.2.2.m1.1.2.3" stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex" id="S4.T1.2.2.2.m1.1c">\uparrow(\%)</annotation><annotation encoding="application/x-llamapun" id="S4.T1.2.2.2.m1.1d">↑ ( % )</annotation></semantics></math>
</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_t" id="S4.T1.3.3.3">CLIP-I <math alttext="\uparrow(\%)" class="ltx_math_unparsed" display="inline" id="S4.T1.3.3.3.m1.1"><semantics id="S4.T1.3.3.3.m1.1a"><mrow id="S4.T1.3.3.3.m1.1b"><mo id="S4.T1.3.3.3.m1.1.1" stretchy="false">↑</mo><mrow id="S4.T1.3.3.3.m1.1.2"><mo id="S4.T1.3.3.3.m1.1.2.1" stretchy="false">(</mo><mo id="S4.T1.3.3.3.m1.1.2.2">%</mo><mo id="S4.T1.3.3.3.m1.1.2.3" stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex" id="S4.T1.3.3.3.m1.1c">\uparrow(\%)</annotation><annotation encoding="application/x-llamapun" id="S4.T1.3.3.3.m1.1d">↑ ( % )</annotation></semantics></math>
</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr" id="S4.T1.3.4.1">
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.4.1.1">MM-Diff <cite class="ltx_cite ltx_citemacro_citep">(Wei et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib12" title="">2024</a>)</cite>
</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.4.1.2">✔</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.4.1.3">✗</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.4.1.4">60.70</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.4.1.5">19.81</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.4.1.6"><span class="ltx_text ltx_framed ltx_framed_underline" id="S4.T1.3.4.1.6.1">78.46</span></td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.5.2">
<td class="ltx_td ltx_align_center" id="S4.T1.3.5.2.1">PhotoMaker-V2 <cite class="ltx_cite ltx_citemacro_citep">(Li et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib8" title="">2024a</a>)</cite>
</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.5.2.2">✗</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.5.2.3">✗</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.5.2.4">61.83</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.5.2.5"><span class="ltx_text ltx_font_bold" id="S4.T1.3.5.2.5.1">23.71</span></td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.5.2.6">75.31</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.6.3">
<td class="ltx_td ltx_align_center" id="S4.T1.3.6.3.1">IP-adapter-FaceID <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite>
</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.6.3.2">✗</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.6.3.3">✗</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.6.3.4">66.66</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.6.3.5">22.97</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.6.3.6">68.72</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.7.4">
<td class="ltx_td ltx_align_center" id="S4.T1.3.7.4.1">InstantID <cite class="ltx_cite ltx_citemacro_citep">(Wang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib15" title="">2024a</a>)</cite>
</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.7.4.2">✗</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.7.4.3">✗</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.7.4.4"><span class="ltx_text ltx_font_bold" id="S4.T1.3.7.4.4.1">73.90</span></td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.7.4.5"><span class="ltx_text ltx_framed ltx_framed_underline" id="S4.T1.3.7.4.5.1">23.39</span></td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.7.4.6">72.50</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.8.5">
<td class="ltx_td ltx_align_center ltx_border_b" id="S4.T1.3.8.5.1"><span class="ltx_text ltx_font_bold" id="S4.T1.3.8.5.1.1">StoryMaker(Ours)</span></td>
<td class="ltx_td ltx_align_center ltx_border_b" id="S4.T1.3.8.5.2">✔</td>
<td class="ltx_td ltx_align_center ltx_border_b" id="S4.T1.3.8.5.3">✔</td>
<td class="ltx_td ltx_align_center ltx_border_b" id="S4.T1.3.8.5.4"><span class="ltx_text ltx_framed ltx_framed_underline" id="S4.T1.3.8.5.4.1">67.36</span></td>
<td class="ltx_td ltx_align_center ltx_border_b" id="S4.T1.3.8.5.5">21.75</td>
<td class="ltx_td ltx_align_center ltx_border_b" id="S4.T1.3.8.5.6"><span class="ltx_text ltx_font_bold" id="S4.T1.3.8.5.6.1">79.51</span></td>
</tr>
</tbody>
</table>
</figure>
</section>
</section>
<section class="ltx_section" id="S5">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">5 </span>Experiments</h2>
<section class="ltx_subsection" id="S5.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.1 </span>Setup</h3>
<section class="ltx_subsubsection" id="S5.SS1.SSS1">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.1.1 </span>Datasets</h4>
<div class="ltx_para ltx_noindent" id="S5.SS1.SSS1.p1">
<p class="ltx_p" id="S5.SS1.SSS1.p1.1">We collect an internal character dataset consisting of a total of 500K images, including 300K single-character images and 200K two-character images. Image captions are automatically generated using CogVLM <cite class="ltx_cite ltx_citemacro_citep">(Wang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib38" title="">2023</a>)</cite>. We employ the buffalo_l <cite class="ltx_cite ltx_citemacro_citep">(Deng et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib26" title="">2019</a>)</cite> model to detect and obtain the ID-embedding of each face. Character segmentation masks are acquired using our internal instance segmentation model.</p>
</div>
<figure class="ltx_figure" id="S5.F3"><img alt="Refer to caption" class="ltx_graphics ltx_centering ltx_img_square" height="620" id="S5.F3.g1" src="extracted/5865094/figures/compare.png" width="752"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 3: </span>Visual comparison on single character condition generation.</figcaption>
</figure>
</section>
<section class="ltx_subsubsection" id="S5.SS1.SSS2">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.1.2 </span>Training Details</h4>
<div class="ltx_para ltx_noindent" id="S5.SS1.SSS2.p1">
<p class="ltx_p" id="S5.SS1.SSS2.p1.2">We train our model based on Stable Diffusion XL <cite class="ltx_cite ltx_citemacro_citep">(Rombach et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib39" title="">2022</a>)</cite>. Similar to IP-Adapter-FaceID <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite>, we utilize buffalo_l <cite class="ltx_cite ltx_citemacro_citep">(Deng et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib26" title="">2019</a>)</cite> as the face recognition model and OpenCLIP ViT-H/14 <cite class="ltx_cite ltx_citemacro_citep">(Ilharco et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib40" title="">2021</a>)</cite> as the image encoder. The rank of trainable LoRA weights is set to 128. During training, we freeze the original weights of the base model and train only the PPR module and LoRA weights. Additionally, we initialize the weights of the resample module for the face and character from IP-Adapter-FaceID and IP-Adapter, respectively. Our model is trained for 8k steps on 8 NVIDIA A100 GPUs with a batch size of 8 per GPU. We use AdamW with a learning rate of 1e-4 for the first 4k steps and 5e-5 for the last 4k steps. We set <math alttext="\lambda" class="ltx_Math" display="inline" id="S5.SS1.SSS2.p1.1.m1.1"><semantics id="S5.SS1.SSS2.p1.1.m1.1a"><mi id="S5.SS1.SSS2.p1.1.m1.1.1" xref="S5.SS1.SSS2.p1.1.m1.1.1.cmml">λ</mi><annotation-xml encoding="MathML-Content" id="S5.SS1.SSS2.p1.1.m1.1b"><ci id="S5.SS1.SSS2.p1.1.m1.1.1.cmml" xref="S5.SS1.SSS2.p1.1.m1.1.1">𝜆</ci></annotation-xml><annotation encoding="application/x-tex" id="S5.SS1.SSS2.p1.1.m1.1c">\lambda</annotation><annotation encoding="application/x-llamapun" id="S5.SS1.SSS2.p1.1.m1.1d">italic_λ</annotation></semantics></math> to 0.1. Training images are resized to a 1024<math alttext="\times" class="ltx_Math" display="inline" id="S5.SS1.SSS2.p1.2.m2.1"><semantics id="S5.SS1.SSS2.p1.2.m2.1a"><mo id="S5.SS1.SSS2.p1.2.m2.1.1" xref="S5.SS1.SSS2.p1.2.m2.1.1.cmml">×</mo><annotation-xml encoding="MathML-Content" id="S5.SS1.SSS2.p1.2.m2.1b"><times id="S5.SS1.SSS2.p1.2.m2.1.1.cmml" xref="S5.SS1.SSS2.p1.2.m2.1.1"></times></annotation-xml><annotation encoding="application/x-tex" id="S5.SS1.SSS2.p1.2.m2.1c">\times</annotation><annotation encoding="application/x-llamapun" id="S5.SS1.SSS2.p1.2.m2.1d">×</annotation></semantics></math>1024 resolution. The text caption is randomly dropped by 10% during training, and the cropped character image is randomly dropped by 5%. During inference, we use the UniPC <cite class="ltx_cite ltx_citemacro_citep">(Zhao et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib41" title="">2024</a>)</cite> sampler with 25 steps and set the classifier-free guidance to 7.5.</p>
</div>
</section>
<section class="ltx_subsubsection" id="S5.SS1.SSS3">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.1.3 </span>Evaluation Metrics</h4>
<div class="ltx_para ltx_noindent" id="S5.SS1.SSS3.p1">
<p class="ltx_p" id="S5.SS1.SSS3.p1.1">To compare with other methods, we evaluate our methods in a single-character setting. We collect a dataset of 40 characters and adopt 20 unique text prompts from FastComposer <cite class="ltx_cite ltx_citemacro_citep">(Xiao et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib11" title="">2023</a>)</cite> and generate 4 images for each prompt. Following FastComposer <cite class="ltx_cite ltx_citemacro_citep">(Xiao et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib11" title="">2023</a>)</cite> and MM-Diff <cite class="ltx_cite ltx_citemacro_citep">(Wei et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib12" title="">2024</a>)</cite>, we use CLIP image similarity (CLIP-I) to compare the generated images with reference images. For identity preservation, we employ buffalo_l <cite class="ltx_cite ltx_citemacro_citep">(Deng et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib26" title="">2019</a>)</cite> model to detect and calculate the cosine similarity (Face Sim.) between two face images. Additionally, we assess the image-text similarity using the CLIP-score (CLIP-T).</p>
</div>
</section>
</section>
<section class="ltx_subsection" id="S5.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.2 </span>Results</h3>
<section class="ltx_subsubsection" id="S5.SS2.SSS1">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.2.1 </span>Quantitative Evaluation</h4>
<div class="ltx_para ltx_noindent" id="S5.SS2.SSS1.p1">
<p class="ltx_p" id="S5.SS2.SSS1.p1.1">As shown in Table <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S4.T1" title="Table 1 ‣ 4.8 Overall Loss ‣ 4 Method ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">1</span></a>, we compare our StoryMaker with four tuning-free character generation models, including MM-Diff <cite class="ltx_cite ltx_citemacro_citep">(Wei et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib12" title="">2024</a>)</cite>, PhotoMaker-V2 <cite class="ltx_cite ltx_citemacro_citep">(Li et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib8" title="">2024a</a>)</cite>, InstantID <cite class="ltx_cite ltx_citemacro_citep">(Wang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib15" title="">2024a</a>)</cite>, and IP-Adapter-FaceID <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite>. Our proposed StoryMaker achieves the highest CLIP-I score among previous methods due to the consistency of the entire portrait, including face, hairstyle, and clothing, though it has a relatively lower CLIP-T, slightly compromising text prompt adherence. For face similarity, our method outperforms others except for InstantID. We attribute InstantID’s superior performance to the extensive training data and the IdentityNet controlling module. It should be noted that among all evaluated methods, only MM-Diff and our method can preserve the ID of multiple persons. Moreover, StoryMaker is the only approach that maintains consistency not only in faces but also in clothing, hairstyles, and bodies.</p>
</div>
<figure class="ltx_figure" id="S5.F4"><img alt="Refer to caption" class="ltx_graphics ltx_centering ltx_img_landscape" height="448" id="S5.F4.g1" src="extracted/5865094/figures/two.png" width="954"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 4: </span>Visualization of two-character image generation. The first two columns display two different reference character images. The middle four columns illustrate StoryMaker’s ability for realistic synthesis. The last four columns demonstrate results of stylized synthesis, where the character embedding is set to zero.</figcaption>
</figure>
</section>
<section class="ltx_subsubsection" id="S5.SS2.SSS2">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.2.2 </span>Visualization</h4>
<div class="ltx_para ltx_noindent" id="S5.SS2.SSS2.p1">
<p class="ltx_p" id="S5.SS2.SSS2.p1.1"><span class="ltx_text ltx_font_bold" id="S5.SS2.SSS2.p1.1.1">Single-Character Image Generation.</span> As shown in Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.F3" title="Figure 3 ‣ 5.1.1 Datasets ‣ 5.1 Setup ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">3</span></a>, compared to IP-Adapter-FaceID, InstantID, MM-Diff, and PhotoMaker-V2, which are designed for identity preservation, the proposed StoryMaker not only maintains face fidelity but also clothing consistency. While IP-Adapter-Plus performs well on clothing consistency, it falls short in text prompts following and face fidelity.</p>
</div>
<div class="ltx_para ltx_noindent" id="S5.SS2.SSS2.p2">
<p class="ltx_p" id="S5.SS2.SSS2.p2.1"><span class="ltx_text ltx_font_bold" id="S5.SS2.SSS2.p2.1.1">Multiple-characters Image Generation.</span> We further demonstrate the performance of multiple-character image generation. As shown in Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.F4" title="Figure 4 ‣ 5.2.1 Quantitative Evaluation ‣ 5.2 Results ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">4</span></a>, with a text prompt, our method can generate different poses of two characters while maintaining consistency in faces, clothing, and hairstyles. Additionally, due to the use of two independent resampler modules, we can set the character embedding (<math alttext="E_{2}" class="ltx_Math" display="inline" id="S5.SS2.SSS2.p2.1.m1.1"><semantics id="S5.SS2.SSS2.p2.1.m1.1a"><msub id="S5.SS2.SSS2.p2.1.m1.1.1" xref="S5.SS2.SSS2.p2.1.m1.1.1.cmml"><mi id="S5.SS2.SSS2.p2.1.m1.1.1.2" xref="S5.SS2.SSS2.p2.1.m1.1.1.2.cmml">E</mi><mn id="S5.SS2.SSS2.p2.1.m1.1.1.3" xref="S5.SS2.SSS2.p2.1.m1.1.1.3.cmml">2</mn></msub><annotation-xml encoding="MathML-Content" id="S5.SS2.SSS2.p2.1.m1.1b"><apply id="S5.SS2.SSS2.p2.1.m1.1.1.cmml" xref="S5.SS2.SSS2.p2.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS2.SSS2.p2.1.m1.1.1.1.cmml" xref="S5.SS2.SSS2.p2.1.m1.1.1">subscript</csymbol><ci id="S5.SS2.SSS2.p2.1.m1.1.1.2.cmml" xref="S5.SS2.SSS2.p2.1.m1.1.1.2">𝐸</ci><cn id="S5.SS2.SSS2.p2.1.m1.1.1.3.cmml" type="integer" xref="S5.SS2.SSS2.p2.1.m1.1.1.3">2</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS2.SSS2.p2.1.m1.1c">E_{2}</annotation><annotation encoding="application/x-llamapun" id="S5.SS2.SSS2.p2.1.m1.1d">italic_E start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT</annotation></semantics></math> in Equation <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S4.E7" title="In 4.3 Reference Information Refinement by Positional-aware Perceiver Resampler ‣ 4 Method ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">7</span></a>) to all zero, while maintaining only ID-preserving and generating stylized synthesis in the last four columns in Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.F4" title="Figure 4 ‣ 5.2.1 Quantitative Evaluation ‣ 5.2 Results ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">4</span></a>.</p>
</div>
<div class="ltx_para ltx_noindent" id="S5.SS2.SSS2.p3">
<p class="ltx_p" id="S5.SS2.SSS2.p3.1"><span class="ltx_text ltx_font_bold" id="S5.SS2.SSS2.p3.1.1">Personalized Story Diffusion.</span> Given reference character images, our proposed StoryMaker can generate consistent character images based on arbitrary prompts, enabling the creation of a story using a series of prompts. As illustrated in the top three rows of Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S0.F1" title="Figure 1 ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">1</span></a>, our method generates a series of images of a single person according to a short story composed of five text prompts describing "A day in the life of an office worker." The poses of the generated characters vary without being controlled by given pose maps. In the bottom two images of Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S0.F1" title="Figure 1 ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">1</span></a>, we present a story featuring the movie "Before Sunrise," generated with two characters. To achieve optimal results, we control the generation using specified poses.</p>
</div>
<div class="ltx_para ltx_noindent" id="S5.SS2.SSS2.p4">
<p class="ltx_p" id="S5.SS2.SSS2.p4.1"><span class="ltx_text ltx_font_bold" id="S5.SS2.SSS2.p4.1.1">Applications.</span> The excellent performance of our method in aligning IDs, clothing, maintaining prompt consistency, and enhancing the diversity and quality of generated images provides a strong foundation for diverse downstream applications. As shown in Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.F5" title="Figure 5 ‣ 5.2.2 Visualization ‣ 5.2 Results ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">5</span></a>(a), a man or woman could become a boy or girl while maintaining clothing consistency. Additionally, StoryMaker demonstrates a surprising ability for clothing swapping (Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.F5" title="Figure 5 ‣ 5.2.2 Visualization ‣ 5.2 Results ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">5</span></a>(b)), achieved by replacing the character image with a clothing image, indicating that the character embedding contains clothing information. Moreover, similar to IP-Adapter <cite class="ltx_cite ltx_citemacro_citep">(Ye et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib21" title="">2023b</a>)</cite> and InstantID <cite class="ltx_cite ltx_citemacro_citep">(Wang et al., <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#bib.bib15" title="">2024a</a>)</cite>, StoryMaker functions as a plug-and-play module, capable of integrating with LoRA or ControlNet to generate diverse images while maintaining character consistency, as shown in Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.F5" title="Figure 5 ‣ 5.2.2 Visualization ‣ 5.2 Results ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">5</span></a>(c,e). Due to the character-preserving capability, human image variations can be realized, as illustrated in Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.F5" title="Figure 5 ‣ 5.2.2 Visualization ‣ 5.2 Results ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">5</span></a>(d). Furthermore, we explore character interpolation between two characters, showcasing StoryMaker’s ability to blend features from multiple characters, as demonstrated in Figure <a class="ltx_ref" href="https://arxiv.org/html/2409.12576v1#S5.F5" title="Figure 5 ‣ 5.2.2 Visualization ‣ 5.2 Results ‣ 5 Experiments ‣ StoryMaker: Towards Holistic Consistent Characters in Text-to-image Generation"><span class="ltx_text ltx_ref_tag">5</span></a>(f).</p>
</div>
<figure class="ltx_figure" id="S5.F5"><img alt="Refer to caption" class="ltx_graphics ltx_centering ltx_img_landscape" height="696" id="S5.F5.g1" src="extracted/5865094/figures/diverse.png" width="930"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 5: </span>Diverse applications of StoryMaker.</figcaption>
</figure>
</section>
</section>
</section>
<section class="ltx_section" id="S6">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">6 </span>Conclusion</h2>
<div class="ltx_para ltx_noindent" id="S6.p1">
<p class="ltx_p" id="S6.p1.1">In this paper, we introduce StoryMaker, a novel approach for personalized image generation that excels maintaining consistency not only in facial identities but also in clothing, hairstyles, and bodies across multiple characters scenes. Our method enhances narrative creation by allowing background, pose, and style variations via text prompts, enabling diverse and coherent storytelling.
StoryMaker leverages the Positional-aware Perceiver Resampler to obtain distinct character embeddings by fusing the features extracted from the face image and the cropped character image. To prevent intermingling of multiple characters and the background, we separately constrain the cross-attention impact regions of different characters and the background using MSE loss with segmentation masks. By incorporating pose decoupling through ControlNet and fidelity enhancements with LoRA, StoryMaker consistently generates high-quality images with matched identities and visual consistency.
Our extensive experiments demonstrate StoryMaker’s superior performance in maintaining character identity and consistency, especially in multi-character scenarios, outperforming existing tuning-free models. The model’s versatility is further highlighted through various applications such as clothing swapping, character interpolation, and integration with other generative plug-ins.
We believe StoryMaker significantly contributes to personalized image generation and opens possibilities for wide applications in digital storytelling, comics, and beyond, where individuality and narrative coherence are essential.
</p>
</div>
</section>
<section class="ltx_section" id="S7">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">7 </span>Limitations</h2>
<div class="ltx_para ltx_noindent" id="S7.p1">
<p class="ltx_p" id="S7.p1.1">In the absence of an explicit pose guide, the posture of generated characters often exhibits anomalies and lacks harmony. Moreover, generating three or more characters simultaneously presents significant challenges. The fidelity and detail of the generated clothing remain unsatisfactory.</p>
</div>
</section>
<section class="ltx_bibliography" id="bib">
<h2 class="ltx_title ltx_title_bibliography">References</h2>
<ul class="ltx_biblist">
<li class="ltx_bibitem" id="bib.bib1">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Ramesh et al. [2021]</span>
<span class="ltx_bibblock">
Aditya Ramesh, Mikhail Pavlov, Gabriel Goh, Scott Gray, Chelsea Voss, Alec Radford, Mark Chen, and Ilya Sutskever.

</span>
<span class="ltx_bibblock">Zero-shot text-to-image generation, 2021.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib2">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Saharia et al. [2022]</span>
<span class="ltx_bibblock">
Chitwan Saharia, William Chan, Saurabh Saxena, Lala Li, Jay Whang, Emily Denton, Kamyar Ghasemipour, Raphael Gontijo Lopes, Burcu Karagol Ayan, Tim Salimans, Jonathan Ho, David Fleet, and Mohammad Norouzi.

</span>
<span class="ltx_bibblock">Photorealistic text-to-image diffusion models with deep language understanding.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib2.1.1">arXiv preprint arXiv:2205.11487</em>, 2022.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib3">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Rombach et al. [2021]</span>
<span class="ltx_bibblock">
Robin Rombach, Andreas Blattmann, Dominik Lorenz, Patrick Esser, and Björn Ommer.

</span>
<span class="ltx_bibblock">High-resolution image synthesis with latent diffusion models.

</span>
<span class="ltx_bibblock">arXiv:2112.10752, 2021.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib4">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Avrahami et al. [2023]</span>
<span class="ltx_bibblock">
Omri Avrahami, Kfir Aberman, Ohad Fried, Daniel Cohen-Or, and Dani Lischinski.

</span>
<span class="ltx_bibblock">Break-a-scene: Extracting multiple concepts from a single image.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib4.1.1">SIGGRAPH Asia 2023 Conference Papers</em>, pages 1–12, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib5">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Gal et al. [2022]</span>
<span class="ltx_bibblock">
Rinon Gal, Yuval Alaluf, Yuval Atzmon, Or Patashnik, Amit H Bermano, Gal Chechik, and Daniel Cohen-Or.

</span>
<span class="ltx_bibblock">An image is worth one word: Personalizing text-to-image generation using textual inversion.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib5.1.1">arXiv preprint arXiv:2208.01618</em>, 2022.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib6">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Kumari et al. [2023]</span>
<span class="ltx_bibblock">
Nupur Kumari, Bingliang Zhang, Richard Zhang, Eli Shechtman, and Jun-Yan Zhu.

</span>
<span class="ltx_bibblock">Multi-concept customization of text-to-image diffusion.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib6.1.1">Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition</em>, pages 1931–1941, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib7">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Ruiz et al. [2023]</span>
<span class="ltx_bibblock">
Nataniel Ruiz, Yuanzhen Li, Varun Jampani, Yael Pritch, Michael Rubinstein, and Kfir Aberman.

</span>
<span class="ltx_bibblock">Dreambooth: Fine tuning text-to-image diffusion models for subject-driven generation.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib7.1.1">Proceedings of the IEEE/CVF conference on computer vision and pattern recognition</em>, pages 22500–22510, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib8">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Li et al. [2024a]</span>
<span class="ltx_bibblock">
Zhen Li, Mingdeng Cao, Xintao Wang, Zhongang Qi, Ming-Ming Cheng, and Ying Shan.

</span>
<span class="ltx_bibblock">Photomaker: Customizing realistic human photos via stacked id embedding.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib8.1.1">Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition</em>, pages 8640–8650, 2024a.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib9">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Ma et al. [2024]</span>
<span class="ltx_bibblock">
Jian Ma, Junhao Liang, Chen Chen, and Haonan Lu.

</span>
<span class="ltx_bibblock">Subject-diffusion: Open domain personalized text-to-image generation without test-time fine-tuning.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib9.1.1">ACM SIGGRAPH 2024 Conference Papers</em>, pages 1–12, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib10">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Wei et al. [2023]</span>
<span class="ltx_bibblock">
Yuxiang Wei, Yabo Zhang, Zhilong Ji, Jinfeng Bai, Lei Zhang, and Wangmeng Zuo.

</span>
<span class="ltx_bibblock">Elite: Encoding visual concepts into textual embeddings for customized text-to-image generation.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib10.1.1">Proceedings of the IEEE/CVF International Conference on Computer Vision</em>, pages 15943–15953, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib11">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Xiao et al. [2023]</span>
<span class="ltx_bibblock">
Guangxuan Xiao, Tianwei Yin, William T Freeman, Frédo Durand, and Song Han.

</span>
<span class="ltx_bibblock">Fastcomposer: Tuning-free multi-subject image generation with localized attention.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib11.1.1">arXiv preprint arXiv:2305.10431</em>, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib12">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Wei et al. [2024]</span>
<span class="ltx_bibblock">
Zhichao Wei, Qingkun Su, Long Qin, and Weizhi Wang.

</span>
<span class="ltx_bibblock">Mm-diff: High-fidelity image personalization via multi-modal condition integration.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib12.1.1">arXiv preprint arXiv:2403.15059</em>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib13">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Kim et al. [2024]</span>
<span class="ltx_bibblock">
Chanran Kim, Jeongin Lee, Shichang Joung, Bongmo Kim, and Yeul-Min Baek.

</span>
<span class="ltx_bibblock">Instantfamily: Masked attention for zero-shot multi-id image generation.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib13.1.1">arXiv preprint arXiv:2404.19427</em>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib14">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Ye et al. [2023a]</span>
<span class="ltx_bibblock">
Hu Ye, Jun Zhang, Sibo Liu, Xiao Han, and Wei Yang.

</span>
<span class="ltx_bibblock">Ip-adapter: Text compatible image prompt adapter for text-to-image diffusion models.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib14.1.1">arXiv preprint arXiv:2308.06721</em>, 2023a.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib15">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Wang et al. [2024a]</span>
<span class="ltx_bibblock">
Qixun Wang, Xu Bai, Haofan Wang, Zekui Qin, and Anthony Chen.

</span>
<span class="ltx_bibblock">Instantid: Zero-shot identity-preserving generation in seconds.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib15.1.1">arXiv preprint arXiv:2401.07519</em>, 2024a.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib16">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Han et al. [2024]</span>
<span class="ltx_bibblock">
Yucheng Han, Rui Wang, Chi Zhang, Juntao Hu, Pei Cheng, Bin Fu, and Hanwang Zhang.

</span>
<span class="ltx_bibblock">Emma: Your text-to-image diffusion model can secretly accept multi-modal prompts.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib16.1.1">arXiv preprint arXiv:2406.09162</em>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib17">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Zhang et al. [2023]</span>
<span class="ltx_bibblock">
Lvmin Zhang, Anyi Rao, and Maneesh Agrawala.

</span>
<span class="ltx_bibblock">Adding conditional control to text-to-image diffusion models.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib17.1.1">Proceedings of the IEEE/CVF International Conference on Computer Vision</em>, pages 3836–3847, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib18">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Gal et al. [2023]</span>
<span class="ltx_bibblock">
Rinon Gal, Moab Arar, Yuval Atzmon, Amit H Bermano, Gal Chechik, and Daniel Cohen-Or.

</span>
<span class="ltx_bibblock">Encoder-based domain tuning for fast personalization of text-to-image models.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib18.1.1">ACM Transactions on Graphics (TOG)</em>, 42(4):1–13, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib19">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Li et al. [2024b]</span>
<span class="ltx_bibblock">
Dongxu Li, Junnan Li, and Steven Hoi.

</span>
<span class="ltx_bibblock">Blip-diffusion: Pre-trained subject representation for controllable text-to-image generation and editing.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib19.1.1">Advances in Neural Information Processing Systems</em>, 36, 2024b.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib20">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Li et al. [2023]</span>
<span class="ltx_bibblock">
Junnan Li, Dongxu Li, Silvio Savarese, and Steven Hoi.

</span>
<span class="ltx_bibblock">Blip-2: Bootstrapping language-image pre-training with frozen image encoders and large language models.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib20.1.1">International conference on machine learning</em>, pages 19730–19742. PMLR, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib21">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Ye et al. [2023b]</span>
<span class="ltx_bibblock">
Hu Ye, Jun Zhang, Sibo Liu, Xiao Han, and Wei Yang.

</span>
<span class="ltx_bibblock">Ip-adapter: Text compatible image prompt adapter for text-to-image diffusion models.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib21.1.1">arXiv preprint arxiv:2308.06721</em>, 2023b.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib22">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Ostashev et al. [2024]</span>
<span class="ltx_bibblock">
Daniil Ostashev, Yuwei Fang, Sergey Tulyakov, Kfir Aberman, et al.

</span>
<span class="ltx_bibblock">Moa: Mixture-of-attention for subject-context disentanglement in personalized image generation.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib22.1.1">arXiv preprint arXiv:2404.11565</em>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib23">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Zhang et al. [2024a]</span>
<span class="ltx_bibblock">
Yuxuan Zhang, Yiren Song, Jiaming Liu, Rui Wang, Jinpeng Yu, Hao Tang, Huaxia Li, Xu Tang, Yao Hu, Han Pan, et al.

</span>
<span class="ltx_bibblock">Ssr-encoder: Encoding selective subject representation for subject-driven generation.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib23.1.1">Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition</em>, pages 8069–8078, 2024a.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib24">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Yan et al. [2023]</span>
<span class="ltx_bibblock">
Yuxuan Yan, Chi Zhang, Rui Wang, Yichao Zhou, Gege Zhang, Pei Cheng, Gang Yu, and Bin Fu.

</span>
<span class="ltx_bibblock">Facestudio: Put your face everywhere in seconds.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib24.1.1">arXiv preprint arXiv:2312.02663</em>, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib25">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Zhang et al. [2024b]</span>
<span class="ltx_bibblock">
Shilong Zhang, Lianghua Huang, Xi Chen, Yifei Zhang, Zhi-Fan Wu, Yutong Feng, Wei Wang, Yujun Shen, Yu Liu, and Ping Luo.

</span>
<span class="ltx_bibblock">Flashface: Human image personalization with high-fidelity identity preservation.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib25.1.1">arXiv preprint arXiv:2403.17008</em>, 2024b.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib26">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Deng et al. [2019]</span>
<span class="ltx_bibblock">
Jiankang Deng, Jia Guo, Niannan Xue, and Stefanos Zafeiriou.

</span>
<span class="ltx_bibblock">Arcface: Additive angular margin loss for deep face recognition.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib26.1.1">Proceedings of the IEEE/CVF conference on computer vision and pattern recognition</em>, pages 4690–4699, 2019.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib27">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">He et al. [2024a]</span>
<span class="ltx_bibblock">
Junjie He, Yifeng Geng, and Liefeng Bo.

</span>
<span class="ltx_bibblock">Uniportrait: A unified framework for identity-preserving single-and multi-human image personalization.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib27.1.1">arXiv preprint arXiv:2408.05939</em>, 2024a.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib28">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Jang et al. [2024]</span>
<span class="ltx_bibblock">
Sangwon Jang, Jaehyeong Jo, Kimin Lee, and Sung Ju Hwang.

</span>
<span class="ltx_bibblock">Identity decoupling for multi-subject personalization of text-to-image models.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib28.1.1">arXiv preprint arXiv:2404.04243</em>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib29">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Kong et al. [2024]</span>
<span class="ltx_bibblock">
Zhe Kong, Yong Zhang, Tianyu Yang, Tao Wang, Kaihao Zhang, Bizhu Wu, Guanying Chen, Wei Liu, and Wenhan Luo.

</span>
<span class="ltx_bibblock">Omg: Occlusion-friendly personalized multi-concept generation in diffusion models.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib29.1.1">arXiv preprint arXiv:2403.10983</em>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib30">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Zhou et al. [2024]</span>
<span class="ltx_bibblock">
Yupeng Zhou, Daquan Zhou, Ming-Ming Cheng, Jiashi Feng, and Qibin Hou.

</span>
<span class="ltx_bibblock">Storydiffusion: Consistent self-attention for long-range image and video generation.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib30.1.1">arXiv preprint arXiv:2405.01434</em>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib31">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Tewel et al. [2024]</span>
<span class="ltx_bibblock">
Yoad Tewel, Omri Kaduri, Rinon Gal, Yoni Kasten, Lior Wolf, Gal Chechik, and Yuval Atzmon.

</span>
<span class="ltx_bibblock">Training-free consistent text-to-image generation.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib31.1.1">ACM Transactions on Graphics (TOG)</em>, 43(4):1–18, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib32">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">He et al. [2024b]</span>
<span class="ltx_bibblock">
Huiguo He, Huan Yang, Zixi Tuo, Yuan Zhou, Qiuyue Wang, Yuhang Zhang, Zeyu Liu, Wenhao Huang, Hongyang Chao, and Jian Yin.

</span>
<span class="ltx_bibblock">Dreamstory: Open-domain story visualization by llm-guided multi-subject consistent diffusion.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib32.1.1">arXiv preprint arXiv:2407.12899</em>, 2024b.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib33">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Wang et al. [2024b]</span>
<span class="ltx_bibblock">
Jiahao Wang, Caixia Yan, Haonan Lin, and Weizhan Zhang.

</span>
<span class="ltx_bibblock">Oneactor: Consistent character generation via cluster-conditioned guidance.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib33.1.1">arXiv preprint arXiv:2404.10267</em>, 2024b.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib34">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Podell et al. [2023]</span>
<span class="ltx_bibblock">
Dustin Podell, Zion English, Kyle Lacey, Andreas Blattmann, Tim Dockhorn, Jonas Müller, Joe Penna, and Robin Rombach.

</span>
<span class="ltx_bibblock">Sdxl: Improving latent diffusion models for high-resolution image synthesis.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib34.1.1">arXiv preprint arXiv:2307.01952</em>, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib35">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Kingma [2013]</span>
<span class="ltx_bibblock">
DP Kingma.

</span>
<span class="ltx_bibblock">Auto-encoding variational bayes.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib35.1.1">arXiv preprint arXiv:1312.6114</em>, 2013.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib36">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Ronneberger et al. [2015]</span>
<span class="ltx_bibblock">
Olaf Ronneberger, Philipp Fischer, and Thomas Brox.

</span>
<span class="ltx_bibblock">U-net: Convolutional networks for biomedical image segmentation.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib36.1.1">Medical image computing and computer-assisted intervention–MICCAI 2015: 18th international conference, Munich, Germany, October 5-9, 2015, proceedings, part III 18</em>, pages 234–241. Springer, 2015.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib37">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Hu et al. [2021]</span>
<span class="ltx_bibblock">
Edward J Hu, Yelong Shen, Phillip Wallis, Zeyuan Allen-Zhu, Yuanzhi Li, Shean Wang, Lu Wang, and Weizhu Chen.

</span>
<span class="ltx_bibblock">Lora: Low-rank adaptation of large language models.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib37.1.1">arXiv preprint arXiv:2106.09685</em>, 2021.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib38">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Wang et al. [2023]</span>
<span class="ltx_bibblock">
Weihan Wang, Qingsong Lv, Wenmeng Yu, Wenyi Hong, Ji Qi, Yan Wang, Junhui Ji, Zhuoyi Yang, Lei Zhao, Xixuan Song, et al.

</span>
<span class="ltx_bibblock">Cogvlm: Visual expert for pretrained language models.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib38.1.1">arXiv preprint arXiv:2311.03079</em>, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib39">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Rombach et al. [2022]</span>
<span class="ltx_bibblock">
Robin Rombach, Andreas Blattmann, Dominik Lorenz, Patrick Esser, and Björn Ommer.

</span>
<span class="ltx_bibblock">High-resolution image synthesis with latent diffusion models.

</span>
<span class="ltx_bibblock">In <em class="ltx_emph ltx_font_italic" id="bib.bib39.1.1">Proceedings of the IEEE/CVF conference on computer vision and pattern recognition</em>, pages 10684–10695, 2022.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib40">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Ilharco et al. [2021]</span>
<span class="ltx_bibblock">
Gabriel Ilharco, Mitchell Wortsman, Ross Wightman, Cade Gordon, Nicholas Carlini, Rohan Taori, Achal Dave, Vaishaal Shankar, Hongseok Namkoong, John Miller, Hannaneh Hajishirzi, Ali Farhadi, and Ludwig Schmidt.

</span>
<span class="ltx_bibblock">Openclip, July 2021.

</span>
<span class="ltx_bibblock">URL <a class="ltx_ref ltx_url ltx_font_typewriter" href="https://doi.org/10.5281/zenodo.5143773" title="">https://doi.org/10.5281/zenodo.5143773</a>.

</span>
<span class="ltx_bibblock">If you use this software, please cite it as below.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib41">
<span class="ltx_tag ltx_role_refnum ltx_tag_bibitem">Zhao et al. [2024]</span>
<span class="ltx_bibblock">
Wenliang Zhao, Lujia Bai, Yongming Rao, Jie Zhou, and Jiwen Lu.

</span>
<span class="ltx_bibblock">Unipc: A unified predictor-corrector framework for fast sampling of diffusion models.

</span>
<span class="ltx_bibblock"><em class="ltx_emph ltx_font_italic" id="bib.bib41.1.1">Advances in Neural Information Processing Systems</em>, 36, 2024.

</span>
</li>
</ul>
</section><div about="" class="ltx_rdf" content="David S. Hippocampus, Elias D. Striatum" property="dcterms:creator"></div>
<div about="" class="ltx_rdf" content="First keyword, Second keyword, More" property="dcterms:subject"></div>
<div about="" class="ltx_rdf" content="q-bio.NC, q-bio.QM" property="dcterms:subject"></div>
<div about="" class="ltx_rdf" content="A template for the arxiv style" property="dcterms:title"></div>
</article>
</div>
<footer class="ltx_page_footer">
<div class="ltx_page_logo">Generated  on Thu Sep 19 08:51:13 2024 by <a class="ltx_LaTeXML_logo" href="http://dlmf.nist.gov/LaTeXML/"><span style="letter-spacing:-0.2em; margin-right:0.1em;">L<span class="ltx_font_smallcaps" style="position:relative; bottom:2.2pt;">a</span>T<span class="ltx_font_smallcaps" style="font-size:120%;position:relative; bottom:-0.2ex;">e</span></span><span style="font-size:90%; position:relative; bottom:-0.2ex;">XML</span><img alt="Mascot Sammy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAOCAYAAAD5YeaVAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wKExQZLWTEaOUAAAAddEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIFRoZSBHSU1Q72QlbgAAAdpJREFUKM9tkL+L2nAARz9fPZNCKFapUn8kyI0e4iRHSR1Kb8ng0lJw6FYHFwv2LwhOpcWxTjeUunYqOmqd6hEoRDhtDWdA8ApRYsSUCDHNt5ul13vz4w0vWCgUnnEc975arX6ORqN3VqtVZbfbTQC4uEHANM3jSqXymFI6yWazP2KxWAXAL9zCUa1Wy2tXVxheKA9YNoR8Pt+aTqe4FVVVvz05O6MBhqUIBGk8Hn8HAOVy+T+XLJfLS4ZhTiRJgqIoVBRFIoric47jPnmeB1mW/9rr9ZpSSn3Lsmir1fJZlqWlUonKsvwWwD8ymc/nXwVBeLjf7xEKhdBut9Hr9WgmkyGEkJwsy5eHG5vN5g0AKIoCAEgkEkin0wQAfN9/cXPdheu6P33fBwB4ngcAcByHJpPJl+fn54mD3Gg0NrquXxeLRQAAwzAYj8cwTZPwPH9/sVg8PXweDAauqqr2cDjEer1GJBLBZDJBs9mE4zjwfZ85lAGg2+06hmGgXq+j3+/DsixYlgVN03a9Xu8jgCNCyIegIAgx13Vfd7vdu+FweG8YRkjXdWy329+dTgeSJD3ieZ7RNO0VAXAPwDEAO5VKndi2fWrb9jWl9Esul6PZbDY9Go1OZ7PZ9z/lyuD3OozU2wAAAABJRU5ErkJggg=="/></a>
</div></footer>
</div>
</body>
</html>
