<!DOCTYPE html>
<html lang="en">
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<title>Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search</title>
<!--Generated on Wed Jul 31 09:52:21 2024 by LaTeXML (version 0.8.8) http://dlmf.nist.gov/LaTeXML/.-->
<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
<link href="/static/browse/0.3.4/css/ar5iv.0.7.9.min.css" rel="stylesheet" type="text/css"/>
<link href="/static/browse/0.3.4/css/ar5iv-fonts.0.7.9.min.css" rel="stylesheet" type="text/css"/>
<link href="/static/browse/0.3.4/css/latexml_styles.css" rel="stylesheet" type="text/css"/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.3/html2canvas.min.js"></script>
<script src="/static/browse/0.3.4/js/addons_new.js"></script>
<script src="/static/browse/0.3.4/js/feedbackOverlay.js"></script>
<base href="/html/2407.21488v1/"/></head>
<body>
<nav class="ltx_page_navbar">
<nav class="ltx_TOC">
<ol class="ltx_toclist">
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S1" title="In Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">1 </span>Introduction</span></a></li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S2" title="In Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">2 </span>Preliminary</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S2.SS1" title="In 2 Preliminary ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">2.1 </span>Residual Quantization</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S2.SS2" title="In 2 Preliminary ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">2.2 </span>Generative Retrieval</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S3" title="In Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">3 </span>Task Definition</span></a></li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S4" title="In Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4 </span>Problem of GR based on RQ</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S4.SS1" title="In 4 Problem of GR based on RQ ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.1 </span>Hourglass Phenomenon</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S4.SS2" title="In 4 Problem of GR based on RQ ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.2 </span>Analysis of Residual Quantization</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S4.SS3" title="In 4 Problem of GR based on RQ ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.3 </span>Impact on the GR</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S5" title="In Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5 </span>Methods and Experiments</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S5.SS1" title="In 5 Methods and Experiments ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.1 </span>Heuristic Method</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S5.SS2" title="In 5 Methods and Experiments ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.2 </span>Variable Length Code</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S5.SS3" title="In 5 Methods and Experiments ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.3 </span>Experiments</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S5.SS4" title="In 5 Methods and Experiments ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.4 </span>Valid Rate</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S5.SS5" title="In 5 Methods and Experiments ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.5 </span>The effect of RQ’s parameter</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S5.SS6" title="In 5 Methods and Experiments ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.6 </span>The effect of remove top@K</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S6" title="In Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">6 </span>Conclusion</span></a></li>
<li class="ltx_tocentry ltx_tocentry_appendix"><a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#A1" title="In Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">A </span>Distribution of RQ-Semantic ID</span></a></li>
</ol></nav>
</nav>
<div class="ltx_page_main">
<div class="ltx_page_content">
<article class="ltx_document">
<h1 class="ltx_title ltx_title_document">Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search</h1>
<div class="ltx_authors">
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname">First Author 
<br class="ltx_break"/>Affiliation / Address line 1 
<br class="ltx_break"/>Affiliation / Address line 2 
<br class="ltx_break"/>Affiliation / Address line 3 
<br class="ltx_break"/><span class="ltx_text ltx_font_typewriter" id="id1.1.id1">email@domain</span>
<br class="ltx_break"/><span class="ltx_ERROR undefined" id="id2.2.id2">\And</span>Second Author 
<br class="ltx_break"/>Affiliation / Address line 1 
<br class="ltx_break"/>Affiliation / Address line 2 
<br class="ltx_break"/>Affiliation / Address line 3 
<br class="ltx_break"/><span class="ltx_text ltx_font_typewriter" id="id3.3.id3">email@domain</span>
<br class="ltx_break"/>
</span></span>
</div>
<div class="ltx_abstract">
<h6 class="ltx_title ltx_title_abstract">Abstract</h6>
<p class="ltx_p" id="id4.id1">In recent years, generative retrieval has emerged as a transformative paradigm in search and recommendation systems, leveraging code-based identifier representations to enhance efficiency and generalization. Notably, methods like TIGER, which employ residual quantization-based Semantic Identifiers (RQ-SID), have shown significant promise in e-commerce scenarios by effectively managing SKU IDs. However, a critical issue, termed the "Hourglass" phenomenon, arises in RQ-based SIDs, where intermediate codebook tokens become overly concentrated, hindering the full utilization of generative retrieval methods. This paper addresses this problem by identifying data sparsity and long-tailed distribution as the primary causes. Through comprehensive experiments and ablation studies, we analyze the impact of these factors on codebook utilization and data distribution. Our findings reveal that the "Hourglass" phenomenon significantly affects the performance of RQ-based SIDs in generative retrieval. We propose solutions to mitigate this issue, thereby enhancing the effectiveness of generative retrieval in real-world e-commerce applications.</p>
</div>
<div class="ltx_para ltx_noindent" id="p1">
<div class="ltx_block ltx_align_bottom" id="p1.1">
<p class="ltx_p" id="p1.1.1"><span class="ltx_text ltx_font_bold" id="p1.1.1.1">Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search</span></p>
<br class="ltx_break ltx_centering"/>
<p class="ltx_p ltx_align_center" id="p1.1.2" style="width:433.6pt;"><span class="ltx_text ltx_inline-block" id="p1.1.2.1" style="width:0.0pt;">
<span class="ltx_tabular ltx_align_top" id="p1.1.2.1.1">
<span class="ltx_tbody">
<span class="ltx_tr" id="p1.1.2.1.1.1.1">
<span class="ltx_td ltx_align_center" id="p1.1.2.1.1.1.1.1"><span class="ltx_text ltx_font_bold" id="p1.1.2.1.1.1.1.1.1">Anonymous ACL submission</span></span></span>
</span>
</span></span></p>
<br class="ltx_break ltx_centering"/>
</div>
</div>
<section class="ltx_section" id="S1">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">1 </span>Introduction</h2>
<div class="ltx_para" id="S1.p1">
<p class="ltx_p" id="S1.p1.1">In recent years, generative retrieval has emerged as an innovative retrieval paradigm, achieving significant breakthroughs in search and recommendation scenarios such as recommendation recall, search question answering, and e-commerce search. This paradigm first represents target texts or items as identifiers (e.g., numbers, subwords, n-grams, token IDs, URLs, codes) and then, given input information (such as queries or user information), utilizes large models to output the final items end-to-end. This approach not only enhances retrieval efficiency but also improves the model’s generalization capability.</p>
</div>
<div class="ltx_para" id="S1.p2">
<p class="ltx_p" id="S1.p2.1">In generative retrieval, numeric-based identifier representation methods are widely adopted in the industry due to their simplicity, efficiency, and strong generalization, especially in long behavior sequence recommendations. These methods significantly reduce sequence lengths and accelerate the inference process. Notable methods include DSI<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">DSI</span></cite>, NCI<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">NCI</span></cite>, TIGER<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">tiger</span></cite>, GDR<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">yuan2024generative</span></cite>, and GenRet<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">sun2024learning</span></cite>. Among them, the TIGER method generates SIDs through residual quantization (RQ), effectively capturing semantic information and hierarchical structure, making it particularly suitable for SKU-dominated e-commerce scenarios. This method better reflects the hierarchical relationships and semantic features of complex e-commerce data, thereby enhancing recommendation performance.</p>
</div>
<figure class="ltx_figure" id="S1.F1"><img alt="Refer to caption" class="ltx_graphics ltx_centering" id="S1.F1.g1" src="latex/figs/IntroFig.pdf"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 1: </span>The Hourglass Phenomenon of Semantic IDs</figcaption>
</figure>
<div class="ltx_para" id="S1.p3">
<p class="ltx_p" id="S1.p3.1">It is important to highlight that the performance upper bound of RQ based methods is contingent upon the generation of SIDs. However, we have identified a pronounced "hourglass" phenomenon in SIDs produced via RQ (as illustrated in the Figure <a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S1.F1" title="Figure 1 ‣ 1 Introduction ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_tag">1</span></a>). Specifically, the codebook tokens in the intermediate layers are excessively concentrated, resulting in a one-to-many and many-to-one structure. This leads to path sparsity (where the matching paths for SKUs constitute a minimal fraction of the total path space) and a long-tail distribution of intermediate layer tokens (with a majority of SIDs concentrated in a few head tokens). This hourglass effect is particularly exacerbated in long-tail data, thereby constraining the representational capacity of Generative Retrieval (GR) methods. The underlying cause of this issue stems from the intrinsic nature of progressively quantizing high-dimensional vector residuals.</p>
</div>
<div class="ltx_para" id="S1.p4">
<p class="ltx_p" id="S1.p4.1">To our knowledge, no previous studies have conducted an in-depth analysis of this phenomenon or proposed improvements. To address this gap, we performed multiple visualization experiments using various parameter combinations (e.g., code table size and number of layers) to explore the generalizability of the Hourglass phenomenon.</p>
</div>
<div class="ltx_para" id="S1.p5">
<p class="ltx_p" id="S1.p5.1">Furthermore, we analyzed the process of generating Semantic IDs (SID) from residuals, demonstrating that sparsity and long-tail distributions are inevitable. To assess the general impact of SID on downstream generative retrieval (GR) tasks, we trained models of different scales (0.8B, 7B) and types (Qwen<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">bai2020sparterm</span></cite>, Baichuan 2<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">yang2023baichuan</span></cite>, LLaMA 2<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">touvron2023llama</span></cite>) based on RQ-SID. Through a series of experiments, including altering the distribution of Semantic IDs by interacting with the first and second layers and swapping tokens between the first and second layers, we not only confirmed the existence of the Hourglass effect but also elucidated its specific impact on model performance. This provides a robust foundation for future model optimization.</p>
</div>
<div class="ltx_para" id="S1.p6">
<p class="ltx_p" id="S1.p6.1">To alleviate the hourglass effect, we propose two simple yet effective methods: a heuristic approach and a variable-length coding strategy. The first method involves directly removing the second layer, thereby eliminating the impact of the long tail. Although this approach is straightforward, it may lead to insufficient spatial capacity. The second method employs an adaptive token distribution adjustment to remove the top tokens in the second layer, transforming the semantic ID into a variable-length structure. This strategy ensures that the overall distribution remains unchanged while mitigating the hourglass effect by selectively removing tokens from the second layer. Extensive experiments results indicate that although both methods are simple, they can alleviate the impact of the hourglass effect to varying degrees. Among them, the second method, which is based on adaptive token distribution adjustment, proves to be the most effective.</p>
</div>
<div class="ltx_para" id="S1.p7">
<p class="ltx_p" id="S1.p7.1">The contributions of this paper can be summarized as follows:</p>
<ul class="ltx_itemize" id="S1.I1">
<li class="ltx_item" id="S1.I1.i1" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="S1.I1.i1.p1">
<p class="ltx_p" id="S1.I1.i1.p1.1">To our knowledge, this is the first study to systematically investigate the deficiencies of residual quantization-based semantic identifiers (RQ-SID) in generative retrieval (GR), specifically identifying the "hourglass" phenomenon where intermediate layer codebook tokens are overly concentrated.</p>
</div>
</li>
<li class="ltx_item" id="S1.I1.i2" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="S1.I1.i2.p1">
<p class="ltx_p" id="S1.I1.i2.p1.1">We conduct thorough experiments and ablation studies that reveal data sparsity and long-tail distributions as the primary causes of the "hourglass" effect, limiting the representation and performance capabilities of GR models.</p>
</div>
</li>
<li class="ltx_item" id="S1.I1.i3" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="S1.I1.i3.p1">
<p class="ltx_p" id="S1.I1.i3.p1.1">We propose a series of innovative methods to alleviate the "hourglass" effect, which significantly enhance model performance by improving codebook utilization and addressing token long-tail distributions.</p>
</div>
</li>
</ul>
</div>
</section>
<section class="ltx_section" id="S2">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">2 </span>Preliminary</h2>
<section class="ltx_subsection" id="S2.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">2.1 </span>Residual Quantization</h3>
<div class="ltx_para" id="S2.SS1.p1">
<p class="ltx_p" id="S2.SS1.p1.1">Residual-quantized is a multi-level vector quantizer that applies quantization on residuals to generate a tuple of codewords (i.e., Semantic IDs). Residual-quantized variational AutoEncoder (RQ-VAE) <cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">tiger</span></cite> is jointly trained by updating the quantization codebook and the encoder-decoder reconstruction parameters.</p>
</div>
<div class="ltx_para" id="S2.SS1.p2">
<p class="ltx_p" id="S2.SS1.p2.11">Support that there is a vector <math alttext="\textbf{x}\in\mathcal{R}^{D}" class="ltx_Math" display="inline" id="S2.SS1.p2.1.m1.1"><semantics id="S2.SS1.p2.1.m1.1a"><mrow id="S2.SS1.p2.1.m1.1.1" xref="S2.SS1.p2.1.m1.1.1.cmml"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p2.1.m1.1.1.2" xref="S2.SS1.p2.1.m1.1.1.2a.cmml">x</mtext><mo id="S2.SS1.p2.1.m1.1.1.1" xref="S2.SS1.p2.1.m1.1.1.1.cmml">∈</mo><msup id="S2.SS1.p2.1.m1.1.1.3" xref="S2.SS1.p2.1.m1.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S2.SS1.p2.1.m1.1.1.3.2" xref="S2.SS1.p2.1.m1.1.1.3.2.cmml">ℛ</mi><mi id="S2.SS1.p2.1.m1.1.1.3.3" xref="S2.SS1.p2.1.m1.1.1.3.3.cmml">D</mi></msup></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.1.m1.1b"><apply id="S2.SS1.p2.1.m1.1.1.cmml" xref="S2.SS1.p2.1.m1.1.1"><in id="S2.SS1.p2.1.m1.1.1.1.cmml" xref="S2.SS1.p2.1.m1.1.1.1"></in><ci id="S2.SS1.p2.1.m1.1.1.2a.cmml" xref="S2.SS1.p2.1.m1.1.1.2"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p2.1.m1.1.1.2.cmml" xref="S2.SS1.p2.1.m1.1.1.2">x</mtext></ci><apply id="S2.SS1.p2.1.m1.1.1.3.cmml" xref="S2.SS1.p2.1.m1.1.1.3"><csymbol cd="ambiguous" id="S2.SS1.p2.1.m1.1.1.3.1.cmml" xref="S2.SS1.p2.1.m1.1.1.3">superscript</csymbol><ci id="S2.SS1.p2.1.m1.1.1.3.2.cmml" xref="S2.SS1.p2.1.m1.1.1.3.2">ℛ</ci><ci id="S2.SS1.p2.1.m1.1.1.3.3.cmml" xref="S2.SS1.p2.1.m1.1.1.3.3">𝐷</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.1.m1.1c">\textbf{x}\in\mathcal{R}^{D}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.1.m1.1d">x ∈ caligraphic_R start_POSTSUPERSCRIPT italic_D end_POSTSUPERSCRIPT</annotation></semantics></math>, we aim to quantize it using <math alttext="L" class="ltx_Math" display="inline" id="S2.SS1.p2.2.m2.1"><semantics id="S2.SS1.p2.2.m2.1a"><mi id="S2.SS1.p2.2.m2.1.1" xref="S2.SS1.p2.2.m2.1.1.cmml">L</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.2.m2.1b"><ci id="S2.SS1.p2.2.m2.1.1.cmml" xref="S2.SS1.p2.2.m2.1.1">𝐿</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.2.m2.1c">L</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.2.m2.1d">italic_L</annotation></semantics></math> codebooks (<math alttext="L" class="ltx_Math" display="inline" id="S2.SS1.p2.3.m3.1"><semantics id="S2.SS1.p2.3.m3.1a"><mi id="S2.SS1.p2.3.m3.1.1" xref="S2.SS1.p2.3.m3.1.1.cmml">L</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.3.m3.1b"><ci id="S2.SS1.p2.3.m3.1.1.cmml" xref="S2.SS1.p2.3.m3.1.1">𝐿</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.3.m3.1c">L</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.3.m3.1d">italic_L</annotation></semantics></math> layer) of <math alttext="M" class="ltx_Math" display="inline" id="S2.SS1.p2.4.m4.1"><semantics id="S2.SS1.p2.4.m4.1a"><mi id="S2.SS1.p2.4.m4.1.1" xref="S2.SS1.p2.4.m4.1.1.cmml">M</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.4.m4.1b"><ci id="S2.SS1.p2.4.m4.1.1.cmml" xref="S2.SS1.p2.4.m4.1.1">𝑀</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.4.m4.1c">M</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.4.m4.1d">italic_M</annotation></semantics></math> elements each, where codebook could be denoted as <math alttext="\textbf{C}\in\mathcal{R}^{L\times M\times D}" class="ltx_Math" display="inline" id="S2.SS1.p2.5.m5.1"><semantics id="S2.SS1.p2.5.m5.1a"><mrow id="S2.SS1.p2.5.m5.1.1" xref="S2.SS1.p2.5.m5.1.1.cmml"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p2.5.m5.1.1.2" xref="S2.SS1.p2.5.m5.1.1.2a.cmml">C</mtext><mo id="S2.SS1.p2.5.m5.1.1.1" xref="S2.SS1.p2.5.m5.1.1.1.cmml">∈</mo><msup id="S2.SS1.p2.5.m5.1.1.3" xref="S2.SS1.p2.5.m5.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S2.SS1.p2.5.m5.1.1.3.2" xref="S2.SS1.p2.5.m5.1.1.3.2.cmml">ℛ</mi><mrow id="S2.SS1.p2.5.m5.1.1.3.3" xref="S2.SS1.p2.5.m5.1.1.3.3.cmml"><mi id="S2.SS1.p2.5.m5.1.1.3.3.2" xref="S2.SS1.p2.5.m5.1.1.3.3.2.cmml">L</mi><mo id="S2.SS1.p2.5.m5.1.1.3.3.1" lspace="0.222em" rspace="0.222em" xref="S2.SS1.p2.5.m5.1.1.3.3.1.cmml">×</mo><mi id="S2.SS1.p2.5.m5.1.1.3.3.3" xref="S2.SS1.p2.5.m5.1.1.3.3.3.cmml">M</mi><mo id="S2.SS1.p2.5.m5.1.1.3.3.1a" lspace="0.222em" rspace="0.222em" xref="S2.SS1.p2.5.m5.1.1.3.3.1.cmml">×</mo><mi id="S2.SS1.p2.5.m5.1.1.3.3.4" xref="S2.SS1.p2.5.m5.1.1.3.3.4.cmml">D</mi></mrow></msup></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.5.m5.1b"><apply id="S2.SS1.p2.5.m5.1.1.cmml" xref="S2.SS1.p2.5.m5.1.1"><in id="S2.SS1.p2.5.m5.1.1.1.cmml" xref="S2.SS1.p2.5.m5.1.1.1"></in><ci id="S2.SS1.p2.5.m5.1.1.2a.cmml" xref="S2.SS1.p2.5.m5.1.1.2"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p2.5.m5.1.1.2.cmml" xref="S2.SS1.p2.5.m5.1.1.2">C</mtext></ci><apply id="S2.SS1.p2.5.m5.1.1.3.cmml" xref="S2.SS1.p2.5.m5.1.1.3"><csymbol cd="ambiguous" id="S2.SS1.p2.5.m5.1.1.3.1.cmml" xref="S2.SS1.p2.5.m5.1.1.3">superscript</csymbol><ci id="S2.SS1.p2.5.m5.1.1.3.2.cmml" xref="S2.SS1.p2.5.m5.1.1.3.2">ℛ</ci><apply id="S2.SS1.p2.5.m5.1.1.3.3.cmml" xref="S2.SS1.p2.5.m5.1.1.3.3"><times id="S2.SS1.p2.5.m5.1.1.3.3.1.cmml" xref="S2.SS1.p2.5.m5.1.1.3.3.1"></times><ci id="S2.SS1.p2.5.m5.1.1.3.3.2.cmml" xref="S2.SS1.p2.5.m5.1.1.3.3.2">𝐿</ci><ci id="S2.SS1.p2.5.m5.1.1.3.3.3.cmml" xref="S2.SS1.p2.5.m5.1.1.3.3.3">𝑀</ci><ci id="S2.SS1.p2.5.m5.1.1.3.3.4.cmml" xref="S2.SS1.p2.5.m5.1.1.3.3.4">𝐷</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.5.m5.1c">\textbf{C}\in\mathcal{R}^{L\times M\times D}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.5.m5.1d">C ∈ caligraphic_R start_POSTSUPERSCRIPT italic_L × italic_M × italic_D end_POSTSUPERSCRIPT</annotation></semantics></math>, <math alttext="D" class="ltx_Math" display="inline" id="S2.SS1.p2.6.m6.1"><semantics id="S2.SS1.p2.6.m6.1a"><mi id="S2.SS1.p2.6.m6.1.1" xref="S2.SS1.p2.6.m6.1.1.cmml">D</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.6.m6.1b"><ci id="S2.SS1.p2.6.m6.1.1.cmml" xref="S2.SS1.p2.6.m6.1.1">𝐷</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.6.m6.1c">D</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.6.m6.1d">italic_D</annotation></semantics></math> is the dimension of vector.
At the 1-th layer (<math alttext="l" class="ltx_Math" display="inline" id="S2.SS1.p2.7.m7.1"><semantics id="S2.SS1.p2.7.m7.1a"><mi id="S2.SS1.p2.7.m7.1.1" xref="S2.SS1.p2.7.m7.1.1.cmml">l</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.7.m7.1b"><ci id="S2.SS1.p2.7.m7.1.1.cmml" xref="S2.SS1.p2.7.m7.1.1">𝑙</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.7.m7.1c">l</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.7.m7.1d">italic_l</annotation></semantics></math> = 1), the initial residual is simply defined as <math alttext="\textbf{r}_{1}=\textbf{x}" class="ltx_Math" display="inline" id="S2.SS1.p2.8.m8.1"><semantics id="S2.SS1.p2.8.m8.1a"><mrow id="S2.SS1.p2.8.m8.1.1" xref="S2.SS1.p2.8.m8.1.1.cmml"><msub id="S2.SS1.p2.8.m8.1.1.2" xref="S2.SS1.p2.8.m8.1.1.2.cmml"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p2.8.m8.1.1.2.2" xref="S2.SS1.p2.8.m8.1.1.2.2a.cmml">r</mtext><mn id="S2.SS1.p2.8.m8.1.1.2.3" xref="S2.SS1.p2.8.m8.1.1.2.3.cmml">1</mn></msub><mo id="S2.SS1.p2.8.m8.1.1.1" xref="S2.SS1.p2.8.m8.1.1.1.cmml">=</mo><mtext class="ltx_mathvariant_bold" id="S2.SS1.p2.8.m8.1.1.3" xref="S2.SS1.p2.8.m8.1.1.3a.cmml">x</mtext></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.8.m8.1b"><apply id="S2.SS1.p2.8.m8.1.1.cmml" xref="S2.SS1.p2.8.m8.1.1"><eq id="S2.SS1.p2.8.m8.1.1.1.cmml" xref="S2.SS1.p2.8.m8.1.1.1"></eq><apply id="S2.SS1.p2.8.m8.1.1.2.cmml" xref="S2.SS1.p2.8.m8.1.1.2"><csymbol cd="ambiguous" id="S2.SS1.p2.8.m8.1.1.2.1.cmml" xref="S2.SS1.p2.8.m8.1.1.2">subscript</csymbol><ci id="S2.SS1.p2.8.m8.1.1.2.2a.cmml" xref="S2.SS1.p2.8.m8.1.1.2.2"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p2.8.m8.1.1.2.2.cmml" xref="S2.SS1.p2.8.m8.1.1.2.2">r</mtext></ci><cn id="S2.SS1.p2.8.m8.1.1.2.3.cmml" type="integer" xref="S2.SS1.p2.8.m8.1.1.2.3">1</cn></apply><ci id="S2.SS1.p2.8.m8.1.1.3a.cmml" xref="S2.SS1.p2.8.m8.1.1.3"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p2.8.m8.1.1.3.cmml" xref="S2.SS1.p2.8.m8.1.1.3">x</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.8.m8.1c">\textbf{r}_{1}=\textbf{x}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.8.m8.1d">r start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT = x</annotation></semantics></math>. Then, <math alttext="\textbf{r}_{1}" class="ltx_Math" display="inline" id="S2.SS1.p2.9.m9.1"><semantics id="S2.SS1.p2.9.m9.1a"><msub id="S2.SS1.p2.9.m9.1.1" xref="S2.SS1.p2.9.m9.1.1.cmml"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p2.9.m9.1.1.2" xref="S2.SS1.p2.9.m9.1.1.2a.cmml">r</mtext><mn id="S2.SS1.p2.9.m9.1.1.3" xref="S2.SS1.p2.9.m9.1.1.3.cmml">1</mn></msub><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.9.m9.1b"><apply id="S2.SS1.p2.9.m9.1.1.cmml" xref="S2.SS1.p2.9.m9.1.1"><csymbol cd="ambiguous" id="S2.SS1.p2.9.m9.1.1.1.cmml" xref="S2.SS1.p2.9.m9.1.1">subscript</csymbol><ci id="S2.SS1.p2.9.m9.1.1.2a.cmml" xref="S2.SS1.p2.9.m9.1.1.2"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p2.9.m9.1.1.2.cmml" xref="S2.SS1.p2.9.m9.1.1.2">r</mtext></ci><cn id="S2.SS1.p2.9.m9.1.1.3.cmml" type="integer" xref="S2.SS1.p2.9.m9.1.1.3">1</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.9.m9.1c">\textbf{r}_{1}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.9.m9.1d">r start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT</annotation></semantics></math> is quantized by mapping it to the nearest embedding from that level’s codebook <math alttext="\textbf{C}_{1}\in\mathcal{R}^{M\times D}" class="ltx_Math" display="inline" id="S2.SS1.p2.10.m10.1"><semantics id="S2.SS1.p2.10.m10.1a"><mrow id="S2.SS1.p2.10.m10.1.1" xref="S2.SS1.p2.10.m10.1.1.cmml"><msub id="S2.SS1.p2.10.m10.1.1.2" xref="S2.SS1.p2.10.m10.1.1.2.cmml"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p2.10.m10.1.1.2.2" xref="S2.SS1.p2.10.m10.1.1.2.2a.cmml">C</mtext><mn id="S2.SS1.p2.10.m10.1.1.2.3" xref="S2.SS1.p2.10.m10.1.1.2.3.cmml">1</mn></msub><mo id="S2.SS1.p2.10.m10.1.1.1" xref="S2.SS1.p2.10.m10.1.1.1.cmml">∈</mo><msup id="S2.SS1.p2.10.m10.1.1.3" xref="S2.SS1.p2.10.m10.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S2.SS1.p2.10.m10.1.1.3.2" xref="S2.SS1.p2.10.m10.1.1.3.2.cmml">ℛ</mi><mrow id="S2.SS1.p2.10.m10.1.1.3.3" xref="S2.SS1.p2.10.m10.1.1.3.3.cmml"><mi id="S2.SS1.p2.10.m10.1.1.3.3.2" xref="S2.SS1.p2.10.m10.1.1.3.3.2.cmml">M</mi><mo id="S2.SS1.p2.10.m10.1.1.3.3.1" lspace="0.222em" rspace="0.222em" xref="S2.SS1.p2.10.m10.1.1.3.3.1.cmml">×</mo><mi id="S2.SS1.p2.10.m10.1.1.3.3.3" xref="S2.SS1.p2.10.m10.1.1.3.3.3.cmml">D</mi></mrow></msup></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.10.m10.1b"><apply id="S2.SS1.p2.10.m10.1.1.cmml" xref="S2.SS1.p2.10.m10.1.1"><in id="S2.SS1.p2.10.m10.1.1.1.cmml" xref="S2.SS1.p2.10.m10.1.1.1"></in><apply id="S2.SS1.p2.10.m10.1.1.2.cmml" xref="S2.SS1.p2.10.m10.1.1.2"><csymbol cd="ambiguous" id="S2.SS1.p2.10.m10.1.1.2.1.cmml" xref="S2.SS1.p2.10.m10.1.1.2">subscript</csymbol><ci id="S2.SS1.p2.10.m10.1.1.2.2a.cmml" xref="S2.SS1.p2.10.m10.1.1.2.2"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p2.10.m10.1.1.2.2.cmml" xref="S2.SS1.p2.10.m10.1.1.2.2">C</mtext></ci><cn id="S2.SS1.p2.10.m10.1.1.2.3.cmml" type="integer" xref="S2.SS1.p2.10.m10.1.1.2.3">1</cn></apply><apply id="S2.SS1.p2.10.m10.1.1.3.cmml" xref="S2.SS1.p2.10.m10.1.1.3"><csymbol cd="ambiguous" id="S2.SS1.p2.10.m10.1.1.3.1.cmml" xref="S2.SS1.p2.10.m10.1.1.3">superscript</csymbol><ci id="S2.SS1.p2.10.m10.1.1.3.2.cmml" xref="S2.SS1.p2.10.m10.1.1.3.2">ℛ</ci><apply id="S2.SS1.p2.10.m10.1.1.3.3.cmml" xref="S2.SS1.p2.10.m10.1.1.3.3"><times id="S2.SS1.p2.10.m10.1.1.3.3.1.cmml" xref="S2.SS1.p2.10.m10.1.1.3.3.1"></times><ci id="S2.SS1.p2.10.m10.1.1.3.3.2.cmml" xref="S2.SS1.p2.10.m10.1.1.3.3.2">𝑀</ci><ci id="S2.SS1.p2.10.m10.1.1.3.3.3.cmml" xref="S2.SS1.p2.10.m10.1.1.3.3.3">𝐷</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.10.m10.1c">\textbf{C}_{1}\in\mathcal{R}^{M\times D}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.10.m10.1d">C start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT ∈ caligraphic_R start_POSTSUPERSCRIPT italic_M × italic_D end_POSTSUPERSCRIPT</annotation></semantics></math>. The index of the closest embedding at <math alttext="l" class="ltx_Math" display="inline" id="S2.SS1.p2.11.m11.1"><semantics id="S2.SS1.p2.11.m11.1a"><mi id="S2.SS1.p2.11.m11.1.1" xref="S2.SS1.p2.11.m11.1.1.cmml">l</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.11.m11.1b"><ci id="S2.SS1.p2.11.m11.1.1.cmml" xref="S2.SS1.p2.11.m11.1.1">𝑙</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.11.m11.1c">l</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.11.m11.1d">italic_l</annotation></semantics></math> = 1 could be computed as follows:</p>
<table class="ltx_equation ltx_eqn_table" id="S2.E1">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="c_{1}=\arg\min_{m\in M}\parallel\textbf{r}_{1}-\textbf{C}_{1,m}\parallel_{2}^{2}" class="ltx_Math" display="block" id="S2.E1.m1.3"><semantics id="S2.E1.m1.3a"><mrow id="S2.E1.m1.3.3" xref="S2.E1.m1.3.3.cmml"><msub id="S2.E1.m1.3.3.3" xref="S2.E1.m1.3.3.3.cmml"><mi id="S2.E1.m1.3.3.3.2" xref="S2.E1.m1.3.3.3.2.cmml">c</mi><mn id="S2.E1.m1.3.3.3.3" xref="S2.E1.m1.3.3.3.3.cmml">1</mn></msub><mo id="S2.E1.m1.3.3.2" xref="S2.E1.m1.3.3.2.cmml">=</mo><mrow id="S2.E1.m1.3.3.1" xref="S2.E1.m1.3.3.1.cmml"><mi id="S2.E1.m1.3.3.1.2" xref="S2.E1.m1.3.3.1.2.cmml">arg</mi><mo id="S2.E1.m1.3.3.1a" lspace="0.167em" xref="S2.E1.m1.3.3.1.cmml">⁡</mo><mrow id="S2.E1.m1.3.3.1.1" xref="S2.E1.m1.3.3.1.1.cmml"><munder id="S2.E1.m1.3.3.1.1.2" xref="S2.E1.m1.3.3.1.1.2.cmml"><mi id="S2.E1.m1.3.3.1.1.2.2" xref="S2.E1.m1.3.3.1.1.2.2.cmml">min</mi><mrow id="S2.E1.m1.3.3.1.1.2.3" xref="S2.E1.m1.3.3.1.1.2.3.cmml"><mi id="S2.E1.m1.3.3.1.1.2.3.2" xref="S2.E1.m1.3.3.1.1.2.3.2.cmml">m</mi><mo id="S2.E1.m1.3.3.1.1.2.3.1" xref="S2.E1.m1.3.3.1.1.2.3.1.cmml">∈</mo><mi id="S2.E1.m1.3.3.1.1.2.3.3" xref="S2.E1.m1.3.3.1.1.2.3.3.cmml">M</mi></mrow></munder><mo id="S2.E1.m1.3.3.1.1a" xref="S2.E1.m1.3.3.1.1.cmml">⁡</mo><msubsup id="S2.E1.m1.3.3.1.1.1" xref="S2.E1.m1.3.3.1.1.1.cmml"><mrow id="S2.E1.m1.3.3.1.1.1.1.1.1" xref="S2.E1.m1.3.3.1.1.1.1.1.2.cmml"><mo id="S2.E1.m1.3.3.1.1.1.1.1.1.2" stretchy="false" xref="S2.E1.m1.3.3.1.1.1.1.1.2.1.cmml">‖</mo><mrow id="S2.E1.m1.3.3.1.1.1.1.1.1.1" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.cmml"><msub id="S2.E1.m1.3.3.1.1.1.1.1.1.1.2" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.cmml"><mtext class="ltx_mathvariant_bold" id="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.2" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.2a.cmml">r</mtext><mn id="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.3" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.3.cmml">1</mn></msub><mo id="S2.E1.m1.3.3.1.1.1.1.1.1.1.1" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.1.cmml">−</mo><msub id="S2.E1.m1.3.3.1.1.1.1.1.1.1.3" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.3.cmml"><mtext class="ltx_mathvariant_bold" id="S2.E1.m1.3.3.1.1.1.1.1.1.1.3.2" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.3.2a.cmml">C</mtext><mrow id="S2.E1.m1.2.2.2.4" xref="S2.E1.m1.2.2.2.3.cmml"><mn id="S2.E1.m1.1.1.1.1" xref="S2.E1.m1.1.1.1.1.cmml">1</mn><mo id="S2.E1.m1.2.2.2.4.1" xref="S2.E1.m1.2.2.2.3.cmml">,</mo><mi id="S2.E1.m1.2.2.2.2" xref="S2.E1.m1.2.2.2.2.cmml">m</mi></mrow></msub></mrow><mo id="S2.E1.m1.3.3.1.1.1.1.1.1.3" stretchy="false" xref="S2.E1.m1.3.3.1.1.1.1.1.2.1.cmml">‖</mo></mrow><mn id="S2.E1.m1.3.3.1.1.1.1.3" xref="S2.E1.m1.3.3.1.1.1.1.3.cmml">2</mn><mn id="S2.E1.m1.3.3.1.1.1.3" xref="S2.E1.m1.3.3.1.1.1.3.cmml">2</mn></msubsup></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S2.E1.m1.3b"><apply id="S2.E1.m1.3.3.cmml" xref="S2.E1.m1.3.3"><eq id="S2.E1.m1.3.3.2.cmml" xref="S2.E1.m1.3.3.2"></eq><apply id="S2.E1.m1.3.3.3.cmml" xref="S2.E1.m1.3.3.3"><csymbol cd="ambiguous" id="S2.E1.m1.3.3.3.1.cmml" xref="S2.E1.m1.3.3.3">subscript</csymbol><ci id="S2.E1.m1.3.3.3.2.cmml" xref="S2.E1.m1.3.3.3.2">𝑐</ci><cn id="S2.E1.m1.3.3.3.3.cmml" type="integer" xref="S2.E1.m1.3.3.3.3">1</cn></apply><apply id="S2.E1.m1.3.3.1.cmml" xref="S2.E1.m1.3.3.1"><arg id="S2.E1.m1.3.3.1.2.cmml" xref="S2.E1.m1.3.3.1.2"></arg><apply id="S2.E1.m1.3.3.1.1.cmml" xref="S2.E1.m1.3.3.1.1"><apply id="S2.E1.m1.3.3.1.1.2.cmml" xref="S2.E1.m1.3.3.1.1.2"><csymbol cd="ambiguous" id="S2.E1.m1.3.3.1.1.2.1.cmml" xref="S2.E1.m1.3.3.1.1.2">subscript</csymbol><min id="S2.E1.m1.3.3.1.1.2.2.cmml" xref="S2.E1.m1.3.3.1.1.2.2"></min><apply id="S2.E1.m1.3.3.1.1.2.3.cmml" xref="S2.E1.m1.3.3.1.1.2.3"><in id="S2.E1.m1.3.3.1.1.2.3.1.cmml" xref="S2.E1.m1.3.3.1.1.2.3.1"></in><ci id="S2.E1.m1.3.3.1.1.2.3.2.cmml" xref="S2.E1.m1.3.3.1.1.2.3.2">𝑚</ci><ci id="S2.E1.m1.3.3.1.1.2.3.3.cmml" xref="S2.E1.m1.3.3.1.1.2.3.3">𝑀</ci></apply></apply><apply id="S2.E1.m1.3.3.1.1.1.cmml" xref="S2.E1.m1.3.3.1.1.1"><csymbol cd="ambiguous" id="S2.E1.m1.3.3.1.1.1.2.cmml" xref="S2.E1.m1.3.3.1.1.1">superscript</csymbol><apply id="S2.E1.m1.3.3.1.1.1.1.cmml" xref="S2.E1.m1.3.3.1.1.1"><csymbol cd="ambiguous" id="S2.E1.m1.3.3.1.1.1.1.2.cmml" xref="S2.E1.m1.3.3.1.1.1">subscript</csymbol><apply id="S2.E1.m1.3.3.1.1.1.1.1.2.cmml" xref="S2.E1.m1.3.3.1.1.1.1.1.1"><csymbol cd="latexml" id="S2.E1.m1.3.3.1.1.1.1.1.2.1.cmml" xref="S2.E1.m1.3.3.1.1.1.1.1.1.2">norm</csymbol><apply id="S2.E1.m1.3.3.1.1.1.1.1.1.1.cmml" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1"><minus id="S2.E1.m1.3.3.1.1.1.1.1.1.1.1.cmml" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.1"></minus><apply id="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.cmml" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.1.cmml" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.2">subscript</csymbol><ci id="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.2a.cmml" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.2"><mtext class="ltx_mathvariant_bold" id="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.2.cmml" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.2">r</mtext></ci><cn id="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.3.cmml" type="integer" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.2.3">1</cn></apply><apply id="S2.E1.m1.3.3.1.1.1.1.1.1.1.3.cmml" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.3"><csymbol cd="ambiguous" id="S2.E1.m1.3.3.1.1.1.1.1.1.1.3.1.cmml" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.3">subscript</csymbol><ci id="S2.E1.m1.3.3.1.1.1.1.1.1.1.3.2a.cmml" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.3.2"><mtext class="ltx_mathvariant_bold" id="S2.E1.m1.3.3.1.1.1.1.1.1.1.3.2.cmml" xref="S2.E1.m1.3.3.1.1.1.1.1.1.1.3.2">C</mtext></ci><list id="S2.E1.m1.2.2.2.3.cmml" xref="S2.E1.m1.2.2.2.4"><cn id="S2.E1.m1.1.1.1.1.cmml" type="integer" xref="S2.E1.m1.1.1.1.1">1</cn><ci id="S2.E1.m1.2.2.2.2.cmml" xref="S2.E1.m1.2.2.2.2">𝑚</ci></list></apply></apply></apply><cn id="S2.E1.m1.3.3.1.1.1.1.3.cmml" type="integer" xref="S2.E1.m1.3.3.1.1.1.1.3">2</cn></apply><cn id="S2.E1.m1.3.3.1.1.1.3.cmml" type="integer" xref="S2.E1.m1.3.3.1.1.1.3">2</cn></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.E1.m1.3c">c_{1}=\arg\min_{m\in M}\parallel\textbf{r}_{1}-\textbf{C}_{1,m}\parallel_{2}^{2}</annotation><annotation encoding="application/x-llamapun" id="S2.E1.m1.3d">italic_c start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT = roman_arg roman_min start_POSTSUBSCRIPT italic_m ∈ italic_M end_POSTSUBSCRIPT ∥ r start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT - C start_POSTSUBSCRIPT 1 , italic_m end_POSTSUBSCRIPT ∥ start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT 2 end_POSTSUPERSCRIPT</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(1)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S2.SS1.p2.12">where <math alttext="c_{1}" class="ltx_Math" display="inline" id="S2.SS1.p2.12.m1.1"><semantics id="S2.SS1.p2.12.m1.1a"><msub id="S2.SS1.p2.12.m1.1.1" xref="S2.SS1.p2.12.m1.1.1.cmml"><mi id="S2.SS1.p2.12.m1.1.1.2" xref="S2.SS1.p2.12.m1.1.1.2.cmml">c</mi><mn id="S2.SS1.p2.12.m1.1.1.3" xref="S2.SS1.p2.12.m1.1.1.3.cmml">1</mn></msub><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.12.m1.1b"><apply id="S2.SS1.p2.12.m1.1.1.cmml" xref="S2.SS1.p2.12.m1.1.1"><csymbol cd="ambiguous" id="S2.SS1.p2.12.m1.1.1.1.cmml" xref="S2.SS1.p2.12.m1.1.1">subscript</csymbol><ci id="S2.SS1.p2.12.m1.1.1.2.cmml" xref="S2.SS1.p2.12.m1.1.1.2">𝑐</ci><cn id="S2.SS1.p2.12.m1.1.1.3.cmml" type="integer" xref="S2.SS1.p2.12.m1.1.1.3">1</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.12.m1.1c">c_{1}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.12.m1.1d">italic_c start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT</annotation></semantics></math> represents the 1-th codeword(semantic ID).</p>
</div>
<div class="ltx_para" id="S2.SS1.p3">
<p class="ltx_p" id="S2.SS1.p3.1">For the other layer <math alttext="l&gt;1" class="ltx_Math" display="inline" id="S2.SS1.p3.1.m1.1"><semantics id="S2.SS1.p3.1.m1.1a"><mrow id="S2.SS1.p3.1.m1.1.1" xref="S2.SS1.p3.1.m1.1.1.cmml"><mi id="S2.SS1.p3.1.m1.1.1.2" xref="S2.SS1.p3.1.m1.1.1.2.cmml">l</mi><mo id="S2.SS1.p3.1.m1.1.1.1" xref="S2.SS1.p3.1.m1.1.1.1.cmml">&gt;</mo><mn id="S2.SS1.p3.1.m1.1.1.3" xref="S2.SS1.p3.1.m1.1.1.3.cmml">1</mn></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p3.1.m1.1b"><apply id="S2.SS1.p3.1.m1.1.1.cmml" xref="S2.SS1.p3.1.m1.1.1"><gt id="S2.SS1.p3.1.m1.1.1.1.cmml" xref="S2.SS1.p3.1.m1.1.1.1"></gt><ci id="S2.SS1.p3.1.m1.1.1.2.cmml" xref="S2.SS1.p3.1.m1.1.1.2">𝑙</ci><cn id="S2.SS1.p3.1.m1.1.1.3.cmml" type="integer" xref="S2.SS1.p3.1.m1.1.1.3">1</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p3.1.m1.1c">l&gt;1</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p3.1.m1.1d">italic_l &gt; 1</annotation></semantics></math>, the residual is defined as</p>
<table class="ltx_equation ltx_eqn_table" id="S2.E2">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\textbf{r}_{l}=\textbf{r}_{l-1}-\textbf{C}_{l,c_{l-1}}" class="ltx_Math" display="block" id="S2.E2.m1.2"><semantics id="S2.E2.m1.2a"><mrow id="S2.E2.m1.2.3" xref="S2.E2.m1.2.3.cmml"><msub id="S2.E2.m1.2.3.2" xref="S2.E2.m1.2.3.2.cmml"><mtext class="ltx_mathvariant_bold" id="S2.E2.m1.2.3.2.2" xref="S2.E2.m1.2.3.2.2a.cmml">r</mtext><mi id="S2.E2.m1.2.3.2.3" xref="S2.E2.m1.2.3.2.3.cmml">l</mi></msub><mo id="S2.E2.m1.2.3.1" xref="S2.E2.m1.2.3.1.cmml">=</mo><mrow id="S2.E2.m1.2.3.3" xref="S2.E2.m1.2.3.3.cmml"><msub id="S2.E2.m1.2.3.3.2" xref="S2.E2.m1.2.3.3.2.cmml"><mtext class="ltx_mathvariant_bold" id="S2.E2.m1.2.3.3.2.2" xref="S2.E2.m1.2.3.3.2.2a.cmml">r</mtext><mrow id="S2.E2.m1.2.3.3.2.3" xref="S2.E2.m1.2.3.3.2.3.cmml"><mi id="S2.E2.m1.2.3.3.2.3.2" xref="S2.E2.m1.2.3.3.2.3.2.cmml">l</mi><mo id="S2.E2.m1.2.3.3.2.3.1" xref="S2.E2.m1.2.3.3.2.3.1.cmml">−</mo><mn id="S2.E2.m1.2.3.3.2.3.3" xref="S2.E2.m1.2.3.3.2.3.3.cmml">1</mn></mrow></msub><mo id="S2.E2.m1.2.3.3.1" xref="S2.E2.m1.2.3.3.1.cmml">−</mo><msub id="S2.E2.m1.2.3.3.3" xref="S2.E2.m1.2.3.3.3.cmml"><mtext class="ltx_mathvariant_bold" id="S2.E2.m1.2.3.3.3.2" xref="S2.E2.m1.2.3.3.3.2a.cmml">C</mtext><mrow id="S2.E2.m1.2.2.2.2" xref="S2.E2.m1.2.2.2.3.cmml"><mi id="S2.E2.m1.1.1.1.1" xref="S2.E2.m1.1.1.1.1.cmml">l</mi><mo id="S2.E2.m1.2.2.2.2.2" xref="S2.E2.m1.2.2.2.3.cmml">,</mo><msub id="S2.E2.m1.2.2.2.2.1" xref="S2.E2.m1.2.2.2.2.1.cmml"><mi id="S2.E2.m1.2.2.2.2.1.2" xref="S2.E2.m1.2.2.2.2.1.2.cmml">c</mi><mrow id="S2.E2.m1.2.2.2.2.1.3" xref="S2.E2.m1.2.2.2.2.1.3.cmml"><mi id="S2.E2.m1.2.2.2.2.1.3.2" xref="S2.E2.m1.2.2.2.2.1.3.2.cmml">l</mi><mo id="S2.E2.m1.2.2.2.2.1.3.1" xref="S2.E2.m1.2.2.2.2.1.3.1.cmml">−</mo><mn id="S2.E2.m1.2.2.2.2.1.3.3" xref="S2.E2.m1.2.2.2.2.1.3.3.cmml">1</mn></mrow></msub></mrow></msub></mrow></mrow><annotation-xml encoding="MathML-Content" id="S2.E2.m1.2b"><apply id="S2.E2.m1.2.3.cmml" xref="S2.E2.m1.2.3"><eq id="S2.E2.m1.2.3.1.cmml" xref="S2.E2.m1.2.3.1"></eq><apply id="S2.E2.m1.2.3.2.cmml" xref="S2.E2.m1.2.3.2"><csymbol cd="ambiguous" id="S2.E2.m1.2.3.2.1.cmml" xref="S2.E2.m1.2.3.2">subscript</csymbol><ci id="S2.E2.m1.2.3.2.2a.cmml" xref="S2.E2.m1.2.3.2.2"><mtext class="ltx_mathvariant_bold" id="S2.E2.m1.2.3.2.2.cmml" xref="S2.E2.m1.2.3.2.2">r</mtext></ci><ci id="S2.E2.m1.2.3.2.3.cmml" xref="S2.E2.m1.2.3.2.3">𝑙</ci></apply><apply id="S2.E2.m1.2.3.3.cmml" xref="S2.E2.m1.2.3.3"><minus id="S2.E2.m1.2.3.3.1.cmml" xref="S2.E2.m1.2.3.3.1"></minus><apply id="S2.E2.m1.2.3.3.2.cmml" xref="S2.E2.m1.2.3.3.2"><csymbol cd="ambiguous" id="S2.E2.m1.2.3.3.2.1.cmml" xref="S2.E2.m1.2.3.3.2">subscript</csymbol><ci id="S2.E2.m1.2.3.3.2.2a.cmml" xref="S2.E2.m1.2.3.3.2.2"><mtext class="ltx_mathvariant_bold" id="S2.E2.m1.2.3.3.2.2.cmml" xref="S2.E2.m1.2.3.3.2.2">r</mtext></ci><apply id="S2.E2.m1.2.3.3.2.3.cmml" xref="S2.E2.m1.2.3.3.2.3"><minus id="S2.E2.m1.2.3.3.2.3.1.cmml" xref="S2.E2.m1.2.3.3.2.3.1"></minus><ci id="S2.E2.m1.2.3.3.2.3.2.cmml" xref="S2.E2.m1.2.3.3.2.3.2">𝑙</ci><cn id="S2.E2.m1.2.3.3.2.3.3.cmml" type="integer" xref="S2.E2.m1.2.3.3.2.3.3">1</cn></apply></apply><apply id="S2.E2.m1.2.3.3.3.cmml" xref="S2.E2.m1.2.3.3.3"><csymbol cd="ambiguous" id="S2.E2.m1.2.3.3.3.1.cmml" xref="S2.E2.m1.2.3.3.3">subscript</csymbol><ci id="S2.E2.m1.2.3.3.3.2a.cmml" xref="S2.E2.m1.2.3.3.3.2"><mtext class="ltx_mathvariant_bold" id="S2.E2.m1.2.3.3.3.2.cmml" xref="S2.E2.m1.2.3.3.3.2">C</mtext></ci><list id="S2.E2.m1.2.2.2.3.cmml" xref="S2.E2.m1.2.2.2.2"><ci id="S2.E2.m1.1.1.1.1.cmml" xref="S2.E2.m1.1.1.1.1">𝑙</ci><apply id="S2.E2.m1.2.2.2.2.1.cmml" xref="S2.E2.m1.2.2.2.2.1"><csymbol cd="ambiguous" id="S2.E2.m1.2.2.2.2.1.1.cmml" xref="S2.E2.m1.2.2.2.2.1">subscript</csymbol><ci id="S2.E2.m1.2.2.2.2.1.2.cmml" xref="S2.E2.m1.2.2.2.2.1.2">𝑐</ci><apply id="S2.E2.m1.2.2.2.2.1.3.cmml" xref="S2.E2.m1.2.2.2.2.1.3"><minus id="S2.E2.m1.2.2.2.2.1.3.1.cmml" xref="S2.E2.m1.2.2.2.2.1.3.1"></minus><ci id="S2.E2.m1.2.2.2.2.1.3.2.cmml" xref="S2.E2.m1.2.2.2.2.1.3.2">𝑙</ci><cn id="S2.E2.m1.2.2.2.2.1.3.3.cmml" type="integer" xref="S2.E2.m1.2.2.2.2.1.3.3">1</cn></apply></apply></list></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.E2.m1.2c">\textbf{r}_{l}=\textbf{r}_{l-1}-\textbf{C}_{l,c_{l-1}}</annotation><annotation encoding="application/x-llamapun" id="S2.E2.m1.2d">r start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT = r start_POSTSUBSCRIPT italic_l - 1 end_POSTSUBSCRIPT - C start_POSTSUBSCRIPT italic_l , italic_c start_POSTSUBSCRIPT italic_l - 1 end_POSTSUBSCRIPT end_POSTSUBSCRIPT</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(2)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S2.SS1.p3.7">Then, similar to the 1-th layer, the code for this level is computed
by finding the embedding in the codebook <math alttext="\textbf{C}_{l}\in\mathcal{R}^{M\times D}" class="ltx_Math" display="inline" id="S2.SS1.p3.2.m1.1"><semantics id="S2.SS1.p3.2.m1.1a"><mrow id="S2.SS1.p3.2.m1.1.1" xref="S2.SS1.p3.2.m1.1.1.cmml"><msub id="S2.SS1.p3.2.m1.1.1.2" xref="S2.SS1.p3.2.m1.1.1.2.cmml"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p3.2.m1.1.1.2.2" xref="S2.SS1.p3.2.m1.1.1.2.2a.cmml">C</mtext><mi id="S2.SS1.p3.2.m1.1.1.2.3" xref="S2.SS1.p3.2.m1.1.1.2.3.cmml">l</mi></msub><mo id="S2.SS1.p3.2.m1.1.1.1" xref="S2.SS1.p3.2.m1.1.1.1.cmml">∈</mo><msup id="S2.SS1.p3.2.m1.1.1.3" xref="S2.SS1.p3.2.m1.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S2.SS1.p3.2.m1.1.1.3.2" xref="S2.SS1.p3.2.m1.1.1.3.2.cmml">ℛ</mi><mrow id="S2.SS1.p3.2.m1.1.1.3.3" xref="S2.SS1.p3.2.m1.1.1.3.3.cmml"><mi id="S2.SS1.p3.2.m1.1.1.3.3.2" xref="S2.SS1.p3.2.m1.1.1.3.3.2.cmml">M</mi><mo id="S2.SS1.p3.2.m1.1.1.3.3.1" lspace="0.222em" rspace="0.222em" xref="S2.SS1.p3.2.m1.1.1.3.3.1.cmml">×</mo><mi id="S2.SS1.p3.2.m1.1.1.3.3.3" xref="S2.SS1.p3.2.m1.1.1.3.3.3.cmml">D</mi></mrow></msup></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p3.2.m1.1b"><apply id="S2.SS1.p3.2.m1.1.1.cmml" xref="S2.SS1.p3.2.m1.1.1"><in id="S2.SS1.p3.2.m1.1.1.1.cmml" xref="S2.SS1.p3.2.m1.1.1.1"></in><apply id="S2.SS1.p3.2.m1.1.1.2.cmml" xref="S2.SS1.p3.2.m1.1.1.2"><csymbol cd="ambiguous" id="S2.SS1.p3.2.m1.1.1.2.1.cmml" xref="S2.SS1.p3.2.m1.1.1.2">subscript</csymbol><ci id="S2.SS1.p3.2.m1.1.1.2.2a.cmml" xref="S2.SS1.p3.2.m1.1.1.2.2"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p3.2.m1.1.1.2.2.cmml" xref="S2.SS1.p3.2.m1.1.1.2.2">C</mtext></ci><ci id="S2.SS1.p3.2.m1.1.1.2.3.cmml" xref="S2.SS1.p3.2.m1.1.1.2.3">𝑙</ci></apply><apply id="S2.SS1.p3.2.m1.1.1.3.cmml" xref="S2.SS1.p3.2.m1.1.1.3"><csymbol cd="ambiguous" id="S2.SS1.p3.2.m1.1.1.3.1.cmml" xref="S2.SS1.p3.2.m1.1.1.3">superscript</csymbol><ci id="S2.SS1.p3.2.m1.1.1.3.2.cmml" xref="S2.SS1.p3.2.m1.1.1.3.2">ℛ</ci><apply id="S2.SS1.p3.2.m1.1.1.3.3.cmml" xref="S2.SS1.p3.2.m1.1.1.3.3"><times id="S2.SS1.p3.2.m1.1.1.3.3.1.cmml" xref="S2.SS1.p3.2.m1.1.1.3.3.1"></times><ci id="S2.SS1.p3.2.m1.1.1.3.3.2.cmml" xref="S2.SS1.p3.2.m1.1.1.3.3.2">𝑀</ci><ci id="S2.SS1.p3.2.m1.1.1.3.3.3.cmml" xref="S2.SS1.p3.2.m1.1.1.3.3.3">𝐷</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p3.2.m1.1c">\textbf{C}_{l}\in\mathcal{R}^{M\times D}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p3.2.m1.1d">C start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT ∈ caligraphic_R start_POSTSUPERSCRIPT italic_M × italic_D end_POSTSUPERSCRIPT</annotation></semantics></math> for the current layer which is nearest to <math alttext="\textbf{r}_{l}" class="ltx_Math" display="inline" id="S2.SS1.p3.3.m2.1"><semantics id="S2.SS1.p3.3.m2.1a"><msub id="S2.SS1.p3.3.m2.1.1" xref="S2.SS1.p3.3.m2.1.1.cmml"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p3.3.m2.1.1.2" xref="S2.SS1.p3.3.m2.1.1.2a.cmml">r</mtext><mi id="S2.SS1.p3.3.m2.1.1.3" xref="S2.SS1.p3.3.m2.1.1.3.cmml">l</mi></msub><annotation-xml encoding="MathML-Content" id="S2.SS1.p3.3.m2.1b"><apply id="S2.SS1.p3.3.m2.1.1.cmml" xref="S2.SS1.p3.3.m2.1.1"><csymbol cd="ambiguous" id="S2.SS1.p3.3.m2.1.1.1.cmml" xref="S2.SS1.p3.3.m2.1.1">subscript</csymbol><ci id="S2.SS1.p3.3.m2.1.1.2a.cmml" xref="S2.SS1.p3.3.m2.1.1.2"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p3.3.m2.1.1.2.cmml" xref="S2.SS1.p3.3.m2.1.1.2">r</mtext></ci><ci id="S2.SS1.p3.3.m2.1.1.3.cmml" xref="S2.SS1.p3.3.m2.1.1.3">𝑙</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p3.3.m2.1c">\textbf{r}_{l}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p3.3.m2.1d">r start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT</annotation></semantics></math>. This process is
repeated recursively <math alttext="L" class="ltx_Math" display="inline" id="S2.SS1.p3.4.m3.1"><semantics id="S2.SS1.p3.4.m3.1a"><mi id="S2.SS1.p3.4.m3.1.1" xref="S2.SS1.p3.4.m3.1.1.cmml">L</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p3.4.m3.1b"><ci id="S2.SS1.p3.4.m3.1.1.cmml" xref="S2.SS1.p3.4.m3.1.1">𝐿</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p3.4.m3.1c">L</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p3.4.m3.1d">italic_L</annotation></semantics></math> times to get a tuple of <math alttext="L" class="ltx_Math" display="inline" id="S2.SS1.p3.5.m4.1"><semantics id="S2.SS1.p3.5.m4.1a"><mi id="S2.SS1.p3.5.m4.1.1" xref="S2.SS1.p3.5.m4.1.1.cmml">L</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p3.5.m4.1b"><ci id="S2.SS1.p3.5.m4.1.1.cmml" xref="S2.SS1.p3.5.m4.1.1">𝐿</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p3.5.m4.1c">L</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p3.5.m4.1d">italic_L</annotation></semantics></math> codewords that represent the Semantic ID for the given <span class="ltx_text ltx_markedasmath ltx_font_bold" id="S2.SS1.p3.7.1">x</span>, denoted as (<math alttext="c_{1},c_{2},\dots,c_{L}" class="ltx_Math" display="inline" id="S2.SS1.p3.7.m6.4"><semantics id="S2.SS1.p3.7.m6.4a"><mrow id="S2.SS1.p3.7.m6.4.4.3" xref="S2.SS1.p3.7.m6.4.4.4.cmml"><msub id="S2.SS1.p3.7.m6.2.2.1.1" xref="S2.SS1.p3.7.m6.2.2.1.1.cmml"><mi id="S2.SS1.p3.7.m6.2.2.1.1.2" xref="S2.SS1.p3.7.m6.2.2.1.1.2.cmml">c</mi><mn id="S2.SS1.p3.7.m6.2.2.1.1.3" xref="S2.SS1.p3.7.m6.2.2.1.1.3.cmml">1</mn></msub><mo id="S2.SS1.p3.7.m6.4.4.3.4" xref="S2.SS1.p3.7.m6.4.4.4.cmml">,</mo><msub id="S2.SS1.p3.7.m6.3.3.2.2" xref="S2.SS1.p3.7.m6.3.3.2.2.cmml"><mi id="S2.SS1.p3.7.m6.3.3.2.2.2" xref="S2.SS1.p3.7.m6.3.3.2.2.2.cmml">c</mi><mn id="S2.SS1.p3.7.m6.3.3.2.2.3" xref="S2.SS1.p3.7.m6.3.3.2.2.3.cmml">2</mn></msub><mo id="S2.SS1.p3.7.m6.4.4.3.5" xref="S2.SS1.p3.7.m6.4.4.4.cmml">,</mo><mi id="S2.SS1.p3.7.m6.1.1" mathvariant="normal" xref="S2.SS1.p3.7.m6.1.1.cmml">…</mi><mo id="S2.SS1.p3.7.m6.4.4.3.6" xref="S2.SS1.p3.7.m6.4.4.4.cmml">,</mo><msub id="S2.SS1.p3.7.m6.4.4.3.3" xref="S2.SS1.p3.7.m6.4.4.3.3.cmml"><mi id="S2.SS1.p3.7.m6.4.4.3.3.2" xref="S2.SS1.p3.7.m6.4.4.3.3.2.cmml">c</mi><mi id="S2.SS1.p3.7.m6.4.4.3.3.3" xref="S2.SS1.p3.7.m6.4.4.3.3.3.cmml">L</mi></msub></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p3.7.m6.4b"><list id="S2.SS1.p3.7.m6.4.4.4.cmml" xref="S2.SS1.p3.7.m6.4.4.3"><apply id="S2.SS1.p3.7.m6.2.2.1.1.cmml" xref="S2.SS1.p3.7.m6.2.2.1.1"><csymbol cd="ambiguous" id="S2.SS1.p3.7.m6.2.2.1.1.1.cmml" xref="S2.SS1.p3.7.m6.2.2.1.1">subscript</csymbol><ci id="S2.SS1.p3.7.m6.2.2.1.1.2.cmml" xref="S2.SS1.p3.7.m6.2.2.1.1.2">𝑐</ci><cn id="S2.SS1.p3.7.m6.2.2.1.1.3.cmml" type="integer" xref="S2.SS1.p3.7.m6.2.2.1.1.3">1</cn></apply><apply id="S2.SS1.p3.7.m6.3.3.2.2.cmml" xref="S2.SS1.p3.7.m6.3.3.2.2"><csymbol cd="ambiguous" id="S2.SS1.p3.7.m6.3.3.2.2.1.cmml" xref="S2.SS1.p3.7.m6.3.3.2.2">subscript</csymbol><ci id="S2.SS1.p3.7.m6.3.3.2.2.2.cmml" xref="S2.SS1.p3.7.m6.3.3.2.2.2">𝑐</ci><cn id="S2.SS1.p3.7.m6.3.3.2.2.3.cmml" type="integer" xref="S2.SS1.p3.7.m6.3.3.2.2.3">2</cn></apply><ci id="S2.SS1.p3.7.m6.1.1.cmml" xref="S2.SS1.p3.7.m6.1.1">…</ci><apply id="S2.SS1.p3.7.m6.4.4.3.3.cmml" xref="S2.SS1.p3.7.m6.4.4.3.3"><csymbol cd="ambiguous" id="S2.SS1.p3.7.m6.4.4.3.3.1.cmml" xref="S2.SS1.p3.7.m6.4.4.3.3">subscript</csymbol><ci id="S2.SS1.p3.7.m6.4.4.3.3.2.cmml" xref="S2.SS1.p3.7.m6.4.4.3.3.2">𝑐</ci><ci id="S2.SS1.p3.7.m6.4.4.3.3.3.cmml" xref="S2.SS1.p3.7.m6.4.4.3.3.3">𝐿</ci></apply></list></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p3.7.m6.4c">c_{1},c_{2},\dots,c_{L}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p3.7.m6.4d">italic_c start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , italic_c start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT , … , italic_c start_POSTSUBSCRIPT italic_L end_POSTSUBSCRIPT</annotation></semantics></math>).</p>
</div>
<div class="ltx_para" id="S2.SS1.p4">
<p class="ltx_p" id="S2.SS1.p4.1">To reconstruct the raw vector, we sum the corresponding codebook elements as:</p>
<table class="ltx_equation ltx_eqn_table" id="S2.E3">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="{\hat{\textbf{x}}}=\sum_{l=0}^{L}\textbf{C}_{l,c_{l}}" class="ltx_Math" display="block" id="S2.E3.m1.2"><semantics id="S2.E3.m1.2a"><mrow id="S2.E3.m1.2.3" xref="S2.E3.m1.2.3.cmml"><mover accent="true" id="S2.E3.m1.2.3.2" xref="S2.E3.m1.2.3.2.cmml"><mtext class="ltx_mathvariant_bold" id="S2.E3.m1.2.3.2.2" xref="S2.E3.m1.2.3.2.2a.cmml">x</mtext><mo id="S2.E3.m1.2.3.2.1" xref="S2.E3.m1.2.3.2.1.cmml">^</mo></mover><mo id="S2.E3.m1.2.3.1" rspace="0.111em" xref="S2.E3.m1.2.3.1.cmml">=</mo><mrow id="S2.E3.m1.2.3.3" xref="S2.E3.m1.2.3.3.cmml"><munderover id="S2.E3.m1.2.3.3.1" xref="S2.E3.m1.2.3.3.1.cmml"><mo id="S2.E3.m1.2.3.3.1.2.2" movablelimits="false" xref="S2.E3.m1.2.3.3.1.2.2.cmml">∑</mo><mrow id="S2.E3.m1.2.3.3.1.2.3" xref="S2.E3.m1.2.3.3.1.2.3.cmml"><mi id="S2.E3.m1.2.3.3.1.2.3.2" xref="S2.E3.m1.2.3.3.1.2.3.2.cmml">l</mi><mo id="S2.E3.m1.2.3.3.1.2.3.1" xref="S2.E3.m1.2.3.3.1.2.3.1.cmml">=</mo><mn id="S2.E3.m1.2.3.3.1.2.3.3" xref="S2.E3.m1.2.3.3.1.2.3.3.cmml">0</mn></mrow><mi id="S2.E3.m1.2.3.3.1.3" xref="S2.E3.m1.2.3.3.1.3.cmml">L</mi></munderover><msub id="S2.E3.m1.2.3.3.2" xref="S2.E3.m1.2.3.3.2.cmml"><mtext class="ltx_mathvariant_bold" id="S2.E3.m1.2.3.3.2.2" xref="S2.E3.m1.2.3.3.2.2a.cmml">C</mtext><mrow id="S2.E3.m1.2.2.2.2" xref="S2.E3.m1.2.2.2.3.cmml"><mi id="S2.E3.m1.1.1.1.1" xref="S2.E3.m1.1.1.1.1.cmml">l</mi><mo id="S2.E3.m1.2.2.2.2.2" xref="S2.E3.m1.2.2.2.3.cmml">,</mo><msub id="S2.E3.m1.2.2.2.2.1" xref="S2.E3.m1.2.2.2.2.1.cmml"><mi id="S2.E3.m1.2.2.2.2.1.2" xref="S2.E3.m1.2.2.2.2.1.2.cmml">c</mi><mi id="S2.E3.m1.2.2.2.2.1.3" xref="S2.E3.m1.2.2.2.2.1.3.cmml">l</mi></msub></mrow></msub></mrow></mrow><annotation-xml encoding="MathML-Content" id="S2.E3.m1.2b"><apply id="S2.E3.m1.2.3.cmml" xref="S2.E3.m1.2.3"><eq id="S2.E3.m1.2.3.1.cmml" xref="S2.E3.m1.2.3.1"></eq><apply id="S2.E3.m1.2.3.2.cmml" xref="S2.E3.m1.2.3.2"><ci id="S2.E3.m1.2.3.2.1.cmml" xref="S2.E3.m1.2.3.2.1">^</ci><ci id="S2.E3.m1.2.3.2.2a.cmml" xref="S2.E3.m1.2.3.2.2"><mtext class="ltx_mathvariant_bold" id="S2.E3.m1.2.3.2.2.cmml" xref="S2.E3.m1.2.3.2.2">x</mtext></ci></apply><apply id="S2.E3.m1.2.3.3.cmml" xref="S2.E3.m1.2.3.3"><apply id="S2.E3.m1.2.3.3.1.cmml" xref="S2.E3.m1.2.3.3.1"><csymbol cd="ambiguous" id="S2.E3.m1.2.3.3.1.1.cmml" xref="S2.E3.m1.2.3.3.1">superscript</csymbol><apply id="S2.E3.m1.2.3.3.1.2.cmml" xref="S2.E3.m1.2.3.3.1"><csymbol cd="ambiguous" id="S2.E3.m1.2.3.3.1.2.1.cmml" xref="S2.E3.m1.2.3.3.1">subscript</csymbol><sum id="S2.E3.m1.2.3.3.1.2.2.cmml" xref="S2.E3.m1.2.3.3.1.2.2"></sum><apply id="S2.E3.m1.2.3.3.1.2.3.cmml" xref="S2.E3.m1.2.3.3.1.2.3"><eq id="S2.E3.m1.2.3.3.1.2.3.1.cmml" xref="S2.E3.m1.2.3.3.1.2.3.1"></eq><ci id="S2.E3.m1.2.3.3.1.2.3.2.cmml" xref="S2.E3.m1.2.3.3.1.2.3.2">𝑙</ci><cn id="S2.E3.m1.2.3.3.1.2.3.3.cmml" type="integer" xref="S2.E3.m1.2.3.3.1.2.3.3">0</cn></apply></apply><ci id="S2.E3.m1.2.3.3.1.3.cmml" xref="S2.E3.m1.2.3.3.1.3">𝐿</ci></apply><apply id="S2.E3.m1.2.3.3.2.cmml" xref="S2.E3.m1.2.3.3.2"><csymbol cd="ambiguous" id="S2.E3.m1.2.3.3.2.1.cmml" xref="S2.E3.m1.2.3.3.2">subscript</csymbol><ci id="S2.E3.m1.2.3.3.2.2a.cmml" xref="S2.E3.m1.2.3.3.2.2"><mtext class="ltx_mathvariant_bold" id="S2.E3.m1.2.3.3.2.2.cmml" xref="S2.E3.m1.2.3.3.2.2">C</mtext></ci><list id="S2.E3.m1.2.2.2.3.cmml" xref="S2.E3.m1.2.2.2.2"><ci id="S2.E3.m1.1.1.1.1.cmml" xref="S2.E3.m1.1.1.1.1">𝑙</ci><apply id="S2.E3.m1.2.2.2.2.1.cmml" xref="S2.E3.m1.2.2.2.2.1"><csymbol cd="ambiguous" id="S2.E3.m1.2.2.2.2.1.1.cmml" xref="S2.E3.m1.2.2.2.2.1">subscript</csymbol><ci id="S2.E3.m1.2.2.2.2.1.2.cmml" xref="S2.E3.m1.2.2.2.2.1.2">𝑐</ci><ci id="S2.E3.m1.2.2.2.2.1.3.cmml" xref="S2.E3.m1.2.2.2.2.1.3">𝑙</ci></apply></list></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.E3.m1.2c">{\hat{\textbf{x}}}=\sum_{l=0}^{L}\textbf{C}_{l,c_{l}}</annotation><annotation encoding="application/x-llamapun" id="S2.E3.m1.2d">over^ start_ARG x end_ARG = ∑ start_POSTSUBSCRIPT italic_l = 0 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_L end_POSTSUPERSCRIPT C start_POSTSUBSCRIPT italic_l , italic_c start_POSTSUBSCRIPT italic_l end_POSTSUBSCRIPT end_POSTSUBSCRIPT</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(3)</span></td>
</tr></tbody>
</table>
</div>
<div class="ltx_para" id="S2.SS1.p5">
<p class="ltx_p" id="S2.SS1.p5.2">This method could approximate the raw vector from a coarse-to-fine granularity by the norm of residuals decreasing, i.e., <math alttext="\|\hat{\textbf{x}}-{\textbf{x}}\|^{2}&lt;\epsilon" class="ltx_Math" display="inline" id="S2.SS1.p5.1.m1.1"><semantics id="S2.SS1.p5.1.m1.1a"><mrow id="S2.SS1.p5.1.m1.1.1" xref="S2.SS1.p5.1.m1.1.1.cmml"><msup id="S2.SS1.p5.1.m1.1.1.1" xref="S2.SS1.p5.1.m1.1.1.1.cmml"><mrow id="S2.SS1.p5.1.m1.1.1.1.1.1" xref="S2.SS1.p5.1.m1.1.1.1.1.2.cmml"><mo id="S2.SS1.p5.1.m1.1.1.1.1.1.2" stretchy="false" xref="S2.SS1.p5.1.m1.1.1.1.1.2.1.cmml">‖</mo><mrow id="S2.SS1.p5.1.m1.1.1.1.1.1.1" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.cmml"><mover accent="true" id="S2.SS1.p5.1.m1.1.1.1.1.1.1.2" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.2.cmml"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p5.1.m1.1.1.1.1.1.1.2.2" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.2.2a.cmml">x</mtext><mo id="S2.SS1.p5.1.m1.1.1.1.1.1.1.2.1" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.2.1.cmml">^</mo></mover><mo id="S2.SS1.p5.1.m1.1.1.1.1.1.1.1" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.1.cmml">−</mo><mtext class="ltx_mathvariant_bold" id="S2.SS1.p5.1.m1.1.1.1.1.1.1.3" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.3a.cmml">x</mtext></mrow><mo id="S2.SS1.p5.1.m1.1.1.1.1.1.3" stretchy="false" xref="S2.SS1.p5.1.m1.1.1.1.1.2.1.cmml">‖</mo></mrow><mn id="S2.SS1.p5.1.m1.1.1.1.3" xref="S2.SS1.p5.1.m1.1.1.1.3.cmml">2</mn></msup><mo id="S2.SS1.p5.1.m1.1.1.2" xref="S2.SS1.p5.1.m1.1.1.2.cmml">&lt;</mo><mi id="S2.SS1.p5.1.m1.1.1.3" xref="S2.SS1.p5.1.m1.1.1.3.cmml">ϵ</mi></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p5.1.m1.1b"><apply id="S2.SS1.p5.1.m1.1.1.cmml" xref="S2.SS1.p5.1.m1.1.1"><lt id="S2.SS1.p5.1.m1.1.1.2.cmml" xref="S2.SS1.p5.1.m1.1.1.2"></lt><apply id="S2.SS1.p5.1.m1.1.1.1.cmml" xref="S2.SS1.p5.1.m1.1.1.1"><csymbol cd="ambiguous" id="S2.SS1.p5.1.m1.1.1.1.2.cmml" xref="S2.SS1.p5.1.m1.1.1.1">superscript</csymbol><apply id="S2.SS1.p5.1.m1.1.1.1.1.2.cmml" xref="S2.SS1.p5.1.m1.1.1.1.1.1"><csymbol cd="latexml" id="S2.SS1.p5.1.m1.1.1.1.1.2.1.cmml" xref="S2.SS1.p5.1.m1.1.1.1.1.1.2">norm</csymbol><apply id="S2.SS1.p5.1.m1.1.1.1.1.1.1.cmml" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1"><minus id="S2.SS1.p5.1.m1.1.1.1.1.1.1.1.cmml" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.1"></minus><apply id="S2.SS1.p5.1.m1.1.1.1.1.1.1.2.cmml" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.2"><ci id="S2.SS1.p5.1.m1.1.1.1.1.1.1.2.1.cmml" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.2.1">^</ci><ci id="S2.SS1.p5.1.m1.1.1.1.1.1.1.2.2a.cmml" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.2.2"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p5.1.m1.1.1.1.1.1.1.2.2.cmml" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.2.2">x</mtext></ci></apply><ci id="S2.SS1.p5.1.m1.1.1.1.1.1.1.3a.cmml" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.3"><mtext class="ltx_mathvariant_bold" id="S2.SS1.p5.1.m1.1.1.1.1.1.1.3.cmml" xref="S2.SS1.p5.1.m1.1.1.1.1.1.1.3">x</mtext></ci></apply></apply><cn id="S2.SS1.p5.1.m1.1.1.1.3.cmml" type="integer" xref="S2.SS1.p5.1.m1.1.1.1.3">2</cn></apply><ci id="S2.SS1.p5.1.m1.1.1.3.cmml" xref="S2.SS1.p5.1.m1.1.1.3">italic-ϵ</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p5.1.m1.1c">\|\hat{\textbf{x}}-{\textbf{x}}\|^{2}&lt;\epsilon</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p5.1.m1.1d">∥ over^ start_ARG x end_ARG - x ∥ start_POSTSUPERSCRIPT 2 end_POSTSUPERSCRIPT &lt; italic_ϵ</annotation></semantics></math>, <math alttext="\epsilon\ll 0.001" class="ltx_Math" display="inline" id="S2.SS1.p5.2.m2.1"><semantics id="S2.SS1.p5.2.m2.1a"><mrow id="S2.SS1.p5.2.m2.1.1" xref="S2.SS1.p5.2.m2.1.1.cmml"><mi id="S2.SS1.p5.2.m2.1.1.2" xref="S2.SS1.p5.2.m2.1.1.2.cmml">ϵ</mi><mo id="S2.SS1.p5.2.m2.1.1.1" xref="S2.SS1.p5.2.m2.1.1.1.cmml">≪</mo><mn id="S2.SS1.p5.2.m2.1.1.3" xref="S2.SS1.p5.2.m2.1.1.3.cmml">0.001</mn></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p5.2.m2.1b"><apply id="S2.SS1.p5.2.m2.1.1.cmml" xref="S2.SS1.p5.2.m2.1.1"><csymbol cd="latexml" id="S2.SS1.p5.2.m2.1.1.1.cmml" xref="S2.SS1.p5.2.m2.1.1.1">much-less-than</csymbol><ci id="S2.SS1.p5.2.m2.1.1.2.cmml" xref="S2.SS1.p5.2.m2.1.1.2">italic-ϵ</ci><cn id="S2.SS1.p5.2.m2.1.1.3.cmml" type="float" xref="S2.SS1.p5.2.m2.1.1.3">0.001</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p5.2.m2.1c">\epsilon\ll 0.001</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p5.2.m2.1d">italic_ϵ ≪ 0.001</annotation></semantics></math>.</p>
</div>
</section>
<section class="ltx_subsection" id="S2.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">2.2 </span>Generative Retrieval</h3>
<div class="ltx_para" id="S2.SS2.p1">
<p class="ltx_p" id="S2.SS2.p1.1">Recently, a new paradigm, generative retrieval <cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">NCI</span>; <span class="ltx_ref ltx_missing_citation ltx_ref_self">DSI</span>; <span class="ltx_ref ltx_missing_citation ltx_ref_self">se-DSI-tang2023semantic</span>; <span class="ltx_ref ltx_missing_citation ltx_ref_self">xiaohongshu-semanticid-yuan2024generative</span>; <span class="ltx_ref ltx_missing_citation ltx_ref_self">seal-bevilacqua2022autoregressive</span>; <span class="ltx_ref ltx_missing_citation ltx_ref_self">rajput2024recommender</span>; <span class="ltx_ref ltx_missing_citation ltx_ref_self">ppo-zhou2023enhancing</span></cite>, has been proposed in the recommendation field, search field and question-answer field.
These models advocate generating identifiers of target passages/items directly through the autoregressive language models.
Existing work could be divided into two categories based on identifier types:</p>
</div>
</section>
</section>
<section class="ltx_section" id="S3">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">3 </span>Task Definition</h2>
<div class="ltx_para" id="S3.p1">
<p class="ltx_p" id="S3.p1.12">In personalized search scenarios, a core task is to provide the most relevant candidates that the user is likely to purchase based on their given query and historical interaction behaviors. In this paper, we re-frame this task as a Next Token Prediction (NTP) problem utilizing LLM and Semantic ID. Specifically, given user <math alttext="u" class="ltx_Math" display="inline" id="S3.p1.1.m1.1"><semantics id="S3.p1.1.m1.1a"><mi id="S3.p1.1.m1.1.1" xref="S3.p1.1.m1.1.1.cmml">u</mi><annotation-xml encoding="MathML-Content" id="S3.p1.1.m1.1b"><ci id="S3.p1.1.m1.1.1.cmml" xref="S3.p1.1.m1.1.1">𝑢</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.1.m1.1c">u</annotation><annotation encoding="application/x-llamapun" id="S3.p1.1.m1.1d">italic_u</annotation></semantics></math>, query <math alttext="q" class="ltx_Math" display="inline" id="S3.p1.2.m2.1"><semantics id="S3.p1.2.m2.1a"><mi id="S3.p1.2.m2.1.1" xref="S3.p1.2.m2.1.1.cmml">q</mi><annotation-xml encoding="MathML-Content" id="S3.p1.2.m2.1b"><ci id="S3.p1.2.m2.1.1.cmml" xref="S3.p1.2.m2.1.1">𝑞</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.2.m2.1c">q</annotation><annotation encoding="application/x-llamapun" id="S3.p1.2.m2.1d">italic_q</annotation></semantics></math>, and the user’s historical item sequence, we first convert the sequence into a Semantic ID sequence, denoted as <math alttext="Seq:=\left\{\underbrace{\left(c_{1,1},\cdot,c_{1,M}\right)}_{item_{1}};%
\underbrace{\left(c_{2,1},\cdot,c_{2,M}\right)}_{item_{2}};\ldots;\underbrace{%
\left(c_{n,1},\cdot,c_{n,M}\right)}_{item_{t}}\right\}" class="ltx_Math" display="inline" id="S3.p1.3.m3.25"><semantics id="S3.p1.3.m3.25a"><mrow id="S3.p1.3.m3.25.25" xref="S3.p1.3.m3.25.25.cmml"><mrow id="S3.p1.3.m3.25.25.5" xref="S3.p1.3.m3.25.25.5.cmml"><mi id="S3.p1.3.m3.25.25.5.2" xref="S3.p1.3.m3.25.25.5.2.cmml">S</mi><mo id="S3.p1.3.m3.25.25.5.1" xref="S3.p1.3.m3.25.25.5.1.cmml">⁢</mo><mi id="S3.p1.3.m3.25.25.5.3" xref="S3.p1.3.m3.25.25.5.3.cmml">e</mi><mo id="S3.p1.3.m3.25.25.5.1a" xref="S3.p1.3.m3.25.25.5.1.cmml">⁢</mo><mi id="S3.p1.3.m3.25.25.5.4" xref="S3.p1.3.m3.25.25.5.4.cmml">q</mi></mrow><mo id="S3.p1.3.m3.25.25.4" lspace="0.278em" rspace="0.278em" xref="S3.p1.3.m3.25.25.4.cmml">:=</mo><mrow id="S3.p1.3.m3.25.25.3.3" xref="S3.p1.3.m3.25.25.3.4.cmml"><mo id="S3.p1.3.m3.25.25.3.3.4" xref="S3.p1.3.m3.25.25.3.4.cmml">{</mo><munder id="S3.p1.3.m3.23.23.1.1.1" xref="S3.p1.3.m3.23.23.1.1.1.cmml"><munder accentunder="true" id="S3.p1.3.m3.7.7" xref="S3.p1.3.m3.7.7.cmml"><mrow id="S3.p1.3.m3.7.7.7.7" xref="S3.p1.3.m3.7.7.7.8.cmml"><mo id="S3.p1.3.m3.7.7.7.7.3" xref="S3.p1.3.m3.7.7.7.8.cmml">(</mo><msub id="S3.p1.3.m3.6.6.6.6.1" xref="S3.p1.3.m3.6.6.6.6.1.cmml"><mi id="S3.p1.3.m3.6.6.6.6.1.2" xref="S3.p1.3.m3.6.6.6.6.1.2.cmml">c</mi><mrow id="S3.p1.3.m3.2.2.2.2.2.4" xref="S3.p1.3.m3.2.2.2.2.2.3.cmml"><mn id="S3.p1.3.m3.1.1.1.1.1.1" xref="S3.p1.3.m3.1.1.1.1.1.1.cmml">1</mn><mo id="S3.p1.3.m3.2.2.2.2.2.4.1" xref="S3.p1.3.m3.2.2.2.2.2.3.cmml">,</mo><mn id="S3.p1.3.m3.2.2.2.2.2.2" xref="S3.p1.3.m3.2.2.2.2.2.2.cmml">1</mn></mrow></msub><mo id="S3.p1.3.m3.7.7.7.7.4" rspace="0em" xref="S3.p1.3.m3.7.7.7.8.cmml">,</mo><mo id="S3.p1.3.m3.5.5.5.5" lspace="0em" rspace="0em" xref="S3.p1.3.m3.5.5.5.5.cmml">⋅</mo><mo id="S3.p1.3.m3.7.7.7.7.5" xref="S3.p1.3.m3.7.7.7.8.cmml">,</mo><msub id="S3.p1.3.m3.7.7.7.7.2" xref="S3.p1.3.m3.7.7.7.7.2.cmml"><mi id="S3.p1.3.m3.7.7.7.7.2.2" xref="S3.p1.3.m3.7.7.7.7.2.2.cmml">c</mi><mrow id="S3.p1.3.m3.4.4.4.4.2.4" xref="S3.p1.3.m3.4.4.4.4.2.3.cmml"><mn id="S3.p1.3.m3.3.3.3.3.1.1" xref="S3.p1.3.m3.3.3.3.3.1.1.cmml">1</mn><mo id="S3.p1.3.m3.4.4.4.4.2.4.1" xref="S3.p1.3.m3.4.4.4.4.2.3.cmml">,</mo><mi id="S3.p1.3.m3.4.4.4.4.2.2" xref="S3.p1.3.m3.4.4.4.4.2.2.cmml">M</mi></mrow></msub><mo id="S3.p1.3.m3.7.7.7.7.6" xref="S3.p1.3.m3.7.7.7.8.cmml">)</mo></mrow><mo id="S3.p1.3.m3.7.7.8" xref="S3.p1.3.m3.7.7.8.cmml">⏟</mo></munder><mrow id="S3.p1.3.m3.23.23.1.1.1.2" xref="S3.p1.3.m3.23.23.1.1.1.2.cmml"><mi id="S3.p1.3.m3.23.23.1.1.1.2.2" xref="S3.p1.3.m3.23.23.1.1.1.2.2.cmml">i</mi><mo id="S3.p1.3.m3.23.23.1.1.1.2.1" xref="S3.p1.3.m3.23.23.1.1.1.2.1.cmml">⁢</mo><mi id="S3.p1.3.m3.23.23.1.1.1.2.3" xref="S3.p1.3.m3.23.23.1.1.1.2.3.cmml">t</mi><mo id="S3.p1.3.m3.23.23.1.1.1.2.1a" xref="S3.p1.3.m3.23.23.1.1.1.2.1.cmml">⁢</mo><mi id="S3.p1.3.m3.23.23.1.1.1.2.4" xref="S3.p1.3.m3.23.23.1.1.1.2.4.cmml">e</mi><mo id="S3.p1.3.m3.23.23.1.1.1.2.1b" xref="S3.p1.3.m3.23.23.1.1.1.2.1.cmml">⁢</mo><msub id="S3.p1.3.m3.23.23.1.1.1.2.5" xref="S3.p1.3.m3.23.23.1.1.1.2.5.cmml"><mi id="S3.p1.3.m3.23.23.1.1.1.2.5.2" xref="S3.p1.3.m3.23.23.1.1.1.2.5.2.cmml">m</mi><mn id="S3.p1.3.m3.23.23.1.1.1.2.5.3" xref="S3.p1.3.m3.23.23.1.1.1.2.5.3.cmml">1</mn></msub></mrow></munder><mo id="S3.p1.3.m3.25.25.3.3.5" xref="S3.p1.3.m3.25.25.3.4.cmml">;</mo><munder id="S3.p1.3.m3.24.24.2.2.2" xref="S3.p1.3.m3.24.24.2.2.2.cmml"><munder accentunder="true" id="S3.p1.3.m3.14.14" xref="S3.p1.3.m3.14.14.cmml"><mrow id="S3.p1.3.m3.14.14.7.7" xref="S3.p1.3.m3.14.14.7.8.cmml"><mo id="S3.p1.3.m3.14.14.7.7.3" xref="S3.p1.3.m3.14.14.7.8.cmml">(</mo><msub id="S3.p1.3.m3.13.13.6.6.1" xref="S3.p1.3.m3.13.13.6.6.1.cmml"><mi id="S3.p1.3.m3.13.13.6.6.1.2" xref="S3.p1.3.m3.13.13.6.6.1.2.cmml">c</mi><mrow id="S3.p1.3.m3.9.9.2.2.2.4" xref="S3.p1.3.m3.9.9.2.2.2.3.cmml"><mn id="S3.p1.3.m3.8.8.1.1.1.1" xref="S3.p1.3.m3.8.8.1.1.1.1.cmml">2</mn><mo id="S3.p1.3.m3.9.9.2.2.2.4.1" xref="S3.p1.3.m3.9.9.2.2.2.3.cmml">,</mo><mn id="S3.p1.3.m3.9.9.2.2.2.2" xref="S3.p1.3.m3.9.9.2.2.2.2.cmml">1</mn></mrow></msub><mo id="S3.p1.3.m3.14.14.7.7.4" rspace="0em" xref="S3.p1.3.m3.14.14.7.8.cmml">,</mo><mo id="S3.p1.3.m3.12.12.5.5" lspace="0em" rspace="0em" xref="S3.p1.3.m3.12.12.5.5.cmml">⋅</mo><mo id="S3.p1.3.m3.14.14.7.7.5" xref="S3.p1.3.m3.14.14.7.8.cmml">,</mo><msub id="S3.p1.3.m3.14.14.7.7.2" xref="S3.p1.3.m3.14.14.7.7.2.cmml"><mi id="S3.p1.3.m3.14.14.7.7.2.2" xref="S3.p1.3.m3.14.14.7.7.2.2.cmml">c</mi><mrow id="S3.p1.3.m3.11.11.4.4.2.4" xref="S3.p1.3.m3.11.11.4.4.2.3.cmml"><mn id="S3.p1.3.m3.10.10.3.3.1.1" xref="S3.p1.3.m3.10.10.3.3.1.1.cmml">2</mn><mo id="S3.p1.3.m3.11.11.4.4.2.4.1" xref="S3.p1.3.m3.11.11.4.4.2.3.cmml">,</mo><mi id="S3.p1.3.m3.11.11.4.4.2.2" xref="S3.p1.3.m3.11.11.4.4.2.2.cmml">M</mi></mrow></msub><mo id="S3.p1.3.m3.14.14.7.7.6" xref="S3.p1.3.m3.14.14.7.8.cmml">)</mo></mrow><mo id="S3.p1.3.m3.14.14.8" xref="S3.p1.3.m3.14.14.8.cmml">⏟</mo></munder><mrow id="S3.p1.3.m3.24.24.2.2.2.2" xref="S3.p1.3.m3.24.24.2.2.2.2.cmml"><mi id="S3.p1.3.m3.24.24.2.2.2.2.2" xref="S3.p1.3.m3.24.24.2.2.2.2.2.cmml">i</mi><mo id="S3.p1.3.m3.24.24.2.2.2.2.1" xref="S3.p1.3.m3.24.24.2.2.2.2.1.cmml">⁢</mo><mi id="S3.p1.3.m3.24.24.2.2.2.2.3" xref="S3.p1.3.m3.24.24.2.2.2.2.3.cmml">t</mi><mo id="S3.p1.3.m3.24.24.2.2.2.2.1a" xref="S3.p1.3.m3.24.24.2.2.2.2.1.cmml">⁢</mo><mi id="S3.p1.3.m3.24.24.2.2.2.2.4" xref="S3.p1.3.m3.24.24.2.2.2.2.4.cmml">e</mi><mo id="S3.p1.3.m3.24.24.2.2.2.2.1b" xref="S3.p1.3.m3.24.24.2.2.2.2.1.cmml">⁢</mo><msub id="S3.p1.3.m3.24.24.2.2.2.2.5" xref="S3.p1.3.m3.24.24.2.2.2.2.5.cmml"><mi id="S3.p1.3.m3.24.24.2.2.2.2.5.2" xref="S3.p1.3.m3.24.24.2.2.2.2.5.2.cmml">m</mi><mn id="S3.p1.3.m3.24.24.2.2.2.2.5.3" xref="S3.p1.3.m3.24.24.2.2.2.2.5.3.cmml">2</mn></msub></mrow></munder><mo id="S3.p1.3.m3.25.25.3.3.6" xref="S3.p1.3.m3.25.25.3.4.cmml">;</mo><mi id="S3.p1.3.m3.22.22" mathvariant="normal" xref="S3.p1.3.m3.22.22.cmml">…</mi><mo id="S3.p1.3.m3.25.25.3.3.7" xref="S3.p1.3.m3.25.25.3.4.cmml">;</mo><munder id="S3.p1.3.m3.25.25.3.3.3" xref="S3.p1.3.m3.25.25.3.3.3.cmml"><munder accentunder="true" id="S3.p1.3.m3.21.21" xref="S3.p1.3.m3.21.21.cmml"><mrow id="S3.p1.3.m3.21.21.7.7" xref="S3.p1.3.m3.21.21.7.8.cmml"><mo id="S3.p1.3.m3.21.21.7.7.3" xref="S3.p1.3.m3.21.21.7.8.cmml">(</mo><msub id="S3.p1.3.m3.20.20.6.6.1" xref="S3.p1.3.m3.20.20.6.6.1.cmml"><mi id="S3.p1.3.m3.20.20.6.6.1.2" xref="S3.p1.3.m3.20.20.6.6.1.2.cmml">c</mi><mrow id="S3.p1.3.m3.16.16.2.2.2.4" xref="S3.p1.3.m3.16.16.2.2.2.3.cmml"><mi id="S3.p1.3.m3.15.15.1.1.1.1" xref="S3.p1.3.m3.15.15.1.1.1.1.cmml">n</mi><mo id="S3.p1.3.m3.16.16.2.2.2.4.1" xref="S3.p1.3.m3.16.16.2.2.2.3.cmml">,</mo><mn id="S3.p1.3.m3.16.16.2.2.2.2" xref="S3.p1.3.m3.16.16.2.2.2.2.cmml">1</mn></mrow></msub><mo id="S3.p1.3.m3.21.21.7.7.4" rspace="0em" xref="S3.p1.3.m3.21.21.7.8.cmml">,</mo><mo id="S3.p1.3.m3.19.19.5.5" lspace="0em" rspace="0em" xref="S3.p1.3.m3.19.19.5.5.cmml">⋅</mo><mo id="S3.p1.3.m3.21.21.7.7.5" xref="S3.p1.3.m3.21.21.7.8.cmml">,</mo><msub id="S3.p1.3.m3.21.21.7.7.2" xref="S3.p1.3.m3.21.21.7.7.2.cmml"><mi id="S3.p1.3.m3.21.21.7.7.2.2" xref="S3.p1.3.m3.21.21.7.7.2.2.cmml">c</mi><mrow id="S3.p1.3.m3.18.18.4.4.2.4" xref="S3.p1.3.m3.18.18.4.4.2.3.cmml"><mi id="S3.p1.3.m3.17.17.3.3.1.1" xref="S3.p1.3.m3.17.17.3.3.1.1.cmml">n</mi><mo id="S3.p1.3.m3.18.18.4.4.2.4.1" xref="S3.p1.3.m3.18.18.4.4.2.3.cmml">,</mo><mi id="S3.p1.3.m3.18.18.4.4.2.2" xref="S3.p1.3.m3.18.18.4.4.2.2.cmml">M</mi></mrow></msub><mo id="S3.p1.3.m3.21.21.7.7.6" xref="S3.p1.3.m3.21.21.7.8.cmml">)</mo></mrow><mo id="S3.p1.3.m3.21.21.8" xref="S3.p1.3.m3.21.21.8.cmml">⏟</mo></munder><mrow id="S3.p1.3.m3.25.25.3.3.3.2" xref="S3.p1.3.m3.25.25.3.3.3.2.cmml"><mi id="S3.p1.3.m3.25.25.3.3.3.2.2" xref="S3.p1.3.m3.25.25.3.3.3.2.2.cmml">i</mi><mo id="S3.p1.3.m3.25.25.3.3.3.2.1" xref="S3.p1.3.m3.25.25.3.3.3.2.1.cmml">⁢</mo><mi id="S3.p1.3.m3.25.25.3.3.3.2.3" xref="S3.p1.3.m3.25.25.3.3.3.2.3.cmml">t</mi><mo id="S3.p1.3.m3.25.25.3.3.3.2.1a" xref="S3.p1.3.m3.25.25.3.3.3.2.1.cmml">⁢</mo><mi id="S3.p1.3.m3.25.25.3.3.3.2.4" xref="S3.p1.3.m3.25.25.3.3.3.2.4.cmml">e</mi><mo id="S3.p1.3.m3.25.25.3.3.3.2.1b" xref="S3.p1.3.m3.25.25.3.3.3.2.1.cmml">⁢</mo><msub id="S3.p1.3.m3.25.25.3.3.3.2.5" xref="S3.p1.3.m3.25.25.3.3.3.2.5.cmml"><mi id="S3.p1.3.m3.25.25.3.3.3.2.5.2" xref="S3.p1.3.m3.25.25.3.3.3.2.5.2.cmml">m</mi><mi id="S3.p1.3.m3.25.25.3.3.3.2.5.3" xref="S3.p1.3.m3.25.25.3.3.3.2.5.3.cmml">t</mi></msub></mrow></munder><mo id="S3.p1.3.m3.25.25.3.3.8" xref="S3.p1.3.m3.25.25.3.4.cmml">}</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.p1.3.m3.25b"><apply id="S3.p1.3.m3.25.25.cmml" xref="S3.p1.3.m3.25.25"><csymbol cd="latexml" id="S3.p1.3.m3.25.25.4.cmml" xref="S3.p1.3.m3.25.25.4">assign</csymbol><apply id="S3.p1.3.m3.25.25.5.cmml" xref="S3.p1.3.m3.25.25.5"><times id="S3.p1.3.m3.25.25.5.1.cmml" xref="S3.p1.3.m3.25.25.5.1"></times><ci id="S3.p1.3.m3.25.25.5.2.cmml" xref="S3.p1.3.m3.25.25.5.2">𝑆</ci><ci id="S3.p1.3.m3.25.25.5.3.cmml" xref="S3.p1.3.m3.25.25.5.3">𝑒</ci><ci id="S3.p1.3.m3.25.25.5.4.cmml" xref="S3.p1.3.m3.25.25.5.4">𝑞</ci></apply><list id="S3.p1.3.m3.25.25.3.4.cmml" xref="S3.p1.3.m3.25.25.3.3"><apply id="S3.p1.3.m3.23.23.1.1.1.cmml" xref="S3.p1.3.m3.23.23.1.1.1"><csymbol cd="ambiguous" id="S3.p1.3.m3.23.23.1.1.1.1.cmml" xref="S3.p1.3.m3.23.23.1.1.1">subscript</csymbol><apply id="S3.p1.3.m3.7.7.cmml" xref="S3.p1.3.m3.7.7"><ci id="S3.p1.3.m3.7.7.8.cmml" xref="S3.p1.3.m3.7.7.8">⏟</ci><vector id="S3.p1.3.m3.7.7.7.8.cmml" xref="S3.p1.3.m3.7.7.7.7"><apply id="S3.p1.3.m3.6.6.6.6.1.cmml" xref="S3.p1.3.m3.6.6.6.6.1"><csymbol cd="ambiguous" id="S3.p1.3.m3.6.6.6.6.1.1.cmml" xref="S3.p1.3.m3.6.6.6.6.1">subscript</csymbol><ci id="S3.p1.3.m3.6.6.6.6.1.2.cmml" xref="S3.p1.3.m3.6.6.6.6.1.2">𝑐</ci><list id="S3.p1.3.m3.2.2.2.2.2.3.cmml" xref="S3.p1.3.m3.2.2.2.2.2.4"><cn id="S3.p1.3.m3.1.1.1.1.1.1.cmml" type="integer" xref="S3.p1.3.m3.1.1.1.1.1.1">1</cn><cn id="S3.p1.3.m3.2.2.2.2.2.2.cmml" type="integer" xref="S3.p1.3.m3.2.2.2.2.2.2">1</cn></list></apply><ci id="S3.p1.3.m3.5.5.5.5.cmml" xref="S3.p1.3.m3.5.5.5.5">⋅</ci><apply id="S3.p1.3.m3.7.7.7.7.2.cmml" xref="S3.p1.3.m3.7.7.7.7.2"><csymbol cd="ambiguous" id="S3.p1.3.m3.7.7.7.7.2.1.cmml" xref="S3.p1.3.m3.7.7.7.7.2">subscript</csymbol><ci id="S3.p1.3.m3.7.7.7.7.2.2.cmml" xref="S3.p1.3.m3.7.7.7.7.2.2">𝑐</ci><list id="S3.p1.3.m3.4.4.4.4.2.3.cmml" xref="S3.p1.3.m3.4.4.4.4.2.4"><cn id="S3.p1.3.m3.3.3.3.3.1.1.cmml" type="integer" xref="S3.p1.3.m3.3.3.3.3.1.1">1</cn><ci id="S3.p1.3.m3.4.4.4.4.2.2.cmml" xref="S3.p1.3.m3.4.4.4.4.2.2">𝑀</ci></list></apply></vector></apply><apply id="S3.p1.3.m3.23.23.1.1.1.2.cmml" xref="S3.p1.3.m3.23.23.1.1.1.2"><times id="S3.p1.3.m3.23.23.1.1.1.2.1.cmml" xref="S3.p1.3.m3.23.23.1.1.1.2.1"></times><ci id="S3.p1.3.m3.23.23.1.1.1.2.2.cmml" xref="S3.p1.3.m3.23.23.1.1.1.2.2">𝑖</ci><ci id="S3.p1.3.m3.23.23.1.1.1.2.3.cmml" xref="S3.p1.3.m3.23.23.1.1.1.2.3">𝑡</ci><ci id="S3.p1.3.m3.23.23.1.1.1.2.4.cmml" xref="S3.p1.3.m3.23.23.1.1.1.2.4">𝑒</ci><apply id="S3.p1.3.m3.23.23.1.1.1.2.5.cmml" xref="S3.p1.3.m3.23.23.1.1.1.2.5"><csymbol cd="ambiguous" id="S3.p1.3.m3.23.23.1.1.1.2.5.1.cmml" xref="S3.p1.3.m3.23.23.1.1.1.2.5">subscript</csymbol><ci id="S3.p1.3.m3.23.23.1.1.1.2.5.2.cmml" xref="S3.p1.3.m3.23.23.1.1.1.2.5.2">𝑚</ci><cn id="S3.p1.3.m3.23.23.1.1.1.2.5.3.cmml" type="integer" xref="S3.p1.3.m3.23.23.1.1.1.2.5.3">1</cn></apply></apply></apply><apply id="S3.p1.3.m3.24.24.2.2.2.cmml" xref="S3.p1.3.m3.24.24.2.2.2"><csymbol cd="ambiguous" id="S3.p1.3.m3.24.24.2.2.2.1.cmml" xref="S3.p1.3.m3.24.24.2.2.2">subscript</csymbol><apply id="S3.p1.3.m3.14.14.cmml" xref="S3.p1.3.m3.14.14"><ci id="S3.p1.3.m3.14.14.8.cmml" xref="S3.p1.3.m3.14.14.8">⏟</ci><vector id="S3.p1.3.m3.14.14.7.8.cmml" xref="S3.p1.3.m3.14.14.7.7"><apply id="S3.p1.3.m3.13.13.6.6.1.cmml" xref="S3.p1.3.m3.13.13.6.6.1"><csymbol cd="ambiguous" id="S3.p1.3.m3.13.13.6.6.1.1.cmml" xref="S3.p1.3.m3.13.13.6.6.1">subscript</csymbol><ci id="S3.p1.3.m3.13.13.6.6.1.2.cmml" xref="S3.p1.3.m3.13.13.6.6.1.2">𝑐</ci><list id="S3.p1.3.m3.9.9.2.2.2.3.cmml" xref="S3.p1.3.m3.9.9.2.2.2.4"><cn id="S3.p1.3.m3.8.8.1.1.1.1.cmml" type="integer" xref="S3.p1.3.m3.8.8.1.1.1.1">2</cn><cn id="S3.p1.3.m3.9.9.2.2.2.2.cmml" type="integer" xref="S3.p1.3.m3.9.9.2.2.2.2">1</cn></list></apply><ci id="S3.p1.3.m3.12.12.5.5.cmml" xref="S3.p1.3.m3.12.12.5.5">⋅</ci><apply id="S3.p1.3.m3.14.14.7.7.2.cmml" xref="S3.p1.3.m3.14.14.7.7.2"><csymbol cd="ambiguous" id="S3.p1.3.m3.14.14.7.7.2.1.cmml" xref="S3.p1.3.m3.14.14.7.7.2">subscript</csymbol><ci id="S3.p1.3.m3.14.14.7.7.2.2.cmml" xref="S3.p1.3.m3.14.14.7.7.2.2">𝑐</ci><list id="S3.p1.3.m3.11.11.4.4.2.3.cmml" xref="S3.p1.3.m3.11.11.4.4.2.4"><cn id="S3.p1.3.m3.10.10.3.3.1.1.cmml" type="integer" xref="S3.p1.3.m3.10.10.3.3.1.1">2</cn><ci id="S3.p1.3.m3.11.11.4.4.2.2.cmml" xref="S3.p1.3.m3.11.11.4.4.2.2">𝑀</ci></list></apply></vector></apply><apply id="S3.p1.3.m3.24.24.2.2.2.2.cmml" xref="S3.p1.3.m3.24.24.2.2.2.2"><times id="S3.p1.3.m3.24.24.2.2.2.2.1.cmml" xref="S3.p1.3.m3.24.24.2.2.2.2.1"></times><ci id="S3.p1.3.m3.24.24.2.2.2.2.2.cmml" xref="S3.p1.3.m3.24.24.2.2.2.2.2">𝑖</ci><ci id="S3.p1.3.m3.24.24.2.2.2.2.3.cmml" xref="S3.p1.3.m3.24.24.2.2.2.2.3">𝑡</ci><ci id="S3.p1.3.m3.24.24.2.2.2.2.4.cmml" xref="S3.p1.3.m3.24.24.2.2.2.2.4">𝑒</ci><apply id="S3.p1.3.m3.24.24.2.2.2.2.5.cmml" xref="S3.p1.3.m3.24.24.2.2.2.2.5"><csymbol cd="ambiguous" id="S3.p1.3.m3.24.24.2.2.2.2.5.1.cmml" xref="S3.p1.3.m3.24.24.2.2.2.2.5">subscript</csymbol><ci id="S3.p1.3.m3.24.24.2.2.2.2.5.2.cmml" xref="S3.p1.3.m3.24.24.2.2.2.2.5.2">𝑚</ci><cn id="S3.p1.3.m3.24.24.2.2.2.2.5.3.cmml" type="integer" xref="S3.p1.3.m3.24.24.2.2.2.2.5.3">2</cn></apply></apply></apply><ci id="S3.p1.3.m3.22.22.cmml" xref="S3.p1.3.m3.22.22">…</ci><apply id="S3.p1.3.m3.25.25.3.3.3.cmml" xref="S3.p1.3.m3.25.25.3.3.3"><csymbol cd="ambiguous" id="S3.p1.3.m3.25.25.3.3.3.1.cmml" xref="S3.p1.3.m3.25.25.3.3.3">subscript</csymbol><apply id="S3.p1.3.m3.21.21.cmml" xref="S3.p1.3.m3.21.21"><ci id="S3.p1.3.m3.21.21.8.cmml" xref="S3.p1.3.m3.21.21.8">⏟</ci><vector id="S3.p1.3.m3.21.21.7.8.cmml" xref="S3.p1.3.m3.21.21.7.7"><apply id="S3.p1.3.m3.20.20.6.6.1.cmml" xref="S3.p1.3.m3.20.20.6.6.1"><csymbol cd="ambiguous" id="S3.p1.3.m3.20.20.6.6.1.1.cmml" xref="S3.p1.3.m3.20.20.6.6.1">subscript</csymbol><ci id="S3.p1.3.m3.20.20.6.6.1.2.cmml" xref="S3.p1.3.m3.20.20.6.6.1.2">𝑐</ci><list id="S3.p1.3.m3.16.16.2.2.2.3.cmml" xref="S3.p1.3.m3.16.16.2.2.2.4"><ci id="S3.p1.3.m3.15.15.1.1.1.1.cmml" xref="S3.p1.3.m3.15.15.1.1.1.1">𝑛</ci><cn id="S3.p1.3.m3.16.16.2.2.2.2.cmml" type="integer" xref="S3.p1.3.m3.16.16.2.2.2.2">1</cn></list></apply><ci id="S3.p1.3.m3.19.19.5.5.cmml" xref="S3.p1.3.m3.19.19.5.5">⋅</ci><apply id="S3.p1.3.m3.21.21.7.7.2.cmml" xref="S3.p1.3.m3.21.21.7.7.2"><csymbol cd="ambiguous" id="S3.p1.3.m3.21.21.7.7.2.1.cmml" xref="S3.p1.3.m3.21.21.7.7.2">subscript</csymbol><ci id="S3.p1.3.m3.21.21.7.7.2.2.cmml" xref="S3.p1.3.m3.21.21.7.7.2.2">𝑐</ci><list id="S3.p1.3.m3.18.18.4.4.2.3.cmml" xref="S3.p1.3.m3.18.18.4.4.2.4"><ci id="S3.p1.3.m3.17.17.3.3.1.1.cmml" xref="S3.p1.3.m3.17.17.3.3.1.1">𝑛</ci><ci id="S3.p1.3.m3.18.18.4.4.2.2.cmml" xref="S3.p1.3.m3.18.18.4.4.2.2">𝑀</ci></list></apply></vector></apply><apply id="S3.p1.3.m3.25.25.3.3.3.2.cmml" xref="S3.p1.3.m3.25.25.3.3.3.2"><times id="S3.p1.3.m3.25.25.3.3.3.2.1.cmml" xref="S3.p1.3.m3.25.25.3.3.3.2.1"></times><ci id="S3.p1.3.m3.25.25.3.3.3.2.2.cmml" xref="S3.p1.3.m3.25.25.3.3.3.2.2">𝑖</ci><ci id="S3.p1.3.m3.25.25.3.3.3.2.3.cmml" xref="S3.p1.3.m3.25.25.3.3.3.2.3">𝑡</ci><ci id="S3.p1.3.m3.25.25.3.3.3.2.4.cmml" xref="S3.p1.3.m3.25.25.3.3.3.2.4">𝑒</ci><apply id="S3.p1.3.m3.25.25.3.3.3.2.5.cmml" xref="S3.p1.3.m3.25.25.3.3.3.2.5"><csymbol cd="ambiguous" id="S3.p1.3.m3.25.25.3.3.3.2.5.1.cmml" xref="S3.p1.3.m3.25.25.3.3.3.2.5">subscript</csymbol><ci id="S3.p1.3.m3.25.25.3.3.3.2.5.2.cmml" xref="S3.p1.3.m3.25.25.3.3.3.2.5.2">𝑚</ci><ci id="S3.p1.3.m3.25.25.3.3.3.2.5.3.cmml" xref="S3.p1.3.m3.25.25.3.3.3.2.5.3">𝑡</ci></apply></apply></apply></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.3.m3.25c">Seq:=\left\{\underbrace{\left(c_{1,1},\cdot,c_{1,M}\right)}_{item_{1}};%
\underbrace{\left(c_{2,1},\cdot,c_{2,M}\right)}_{item_{2}};\ldots;\underbrace{%
\left(c_{n,1},\cdot,c_{n,M}\right)}_{item_{t}}\right\}</annotation><annotation encoding="application/x-llamapun" id="S3.p1.3.m3.25d">italic_S italic_e italic_q := { under⏟ start_ARG ( italic_c start_POSTSUBSCRIPT 1 , 1 end_POSTSUBSCRIPT , ⋅ , italic_c start_POSTSUBSCRIPT 1 , italic_M end_POSTSUBSCRIPT ) end_ARG start_POSTSUBSCRIPT italic_i italic_t italic_e italic_m start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT end_POSTSUBSCRIPT ; under⏟ start_ARG ( italic_c start_POSTSUBSCRIPT 2 , 1 end_POSTSUBSCRIPT , ⋅ , italic_c start_POSTSUBSCRIPT 2 , italic_M end_POSTSUBSCRIPT ) end_ARG start_POSTSUBSCRIPT italic_i italic_t italic_e italic_m start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT end_POSTSUBSCRIPT ; … ; under⏟ start_ARG ( italic_c start_POSTSUBSCRIPT italic_n , 1 end_POSTSUBSCRIPT , ⋅ , italic_c start_POSTSUBSCRIPT italic_n , italic_M end_POSTSUBSCRIPT ) end_ARG start_POSTSUBSCRIPT italic_i italic_t italic_e italic_m start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT end_POSTSUBSCRIPT }</annotation></semantics></math>
where (<math alttext="c_{i,1}" class="ltx_Math" display="inline" id="S3.p1.4.m4.2"><semantics id="S3.p1.4.m4.2a"><msub id="S3.p1.4.m4.2.3" xref="S3.p1.4.m4.2.3.cmml"><mi id="S3.p1.4.m4.2.3.2" xref="S3.p1.4.m4.2.3.2.cmml">c</mi><mrow id="S3.p1.4.m4.2.2.2.4" xref="S3.p1.4.m4.2.2.2.3.cmml"><mi id="S3.p1.4.m4.1.1.1.1" xref="S3.p1.4.m4.1.1.1.1.cmml">i</mi><mo id="S3.p1.4.m4.2.2.2.4.1" xref="S3.p1.4.m4.2.2.2.3.cmml">,</mo><mn id="S3.p1.4.m4.2.2.2.2" xref="S3.p1.4.m4.2.2.2.2.cmml">1</mn></mrow></msub><annotation-xml encoding="MathML-Content" id="S3.p1.4.m4.2b"><apply id="S3.p1.4.m4.2.3.cmml" xref="S3.p1.4.m4.2.3"><csymbol cd="ambiguous" id="S3.p1.4.m4.2.3.1.cmml" xref="S3.p1.4.m4.2.3">subscript</csymbol><ci id="S3.p1.4.m4.2.3.2.cmml" xref="S3.p1.4.m4.2.3.2">𝑐</ci><list id="S3.p1.4.m4.2.2.2.3.cmml" xref="S3.p1.4.m4.2.2.2.4"><ci id="S3.p1.4.m4.1.1.1.1.cmml" xref="S3.p1.4.m4.1.1.1.1">𝑖</ci><cn id="S3.p1.4.m4.2.2.2.2.cmml" type="integer" xref="S3.p1.4.m4.2.2.2.2">1</cn></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.4.m4.2c">c_{i,1}</annotation><annotation encoding="application/x-llamapun" id="S3.p1.4.m4.2d">italic_c start_POSTSUBSCRIPT italic_i , 1 end_POSTSUBSCRIPT</annotation></semantics></math>, <math alttext="\cdot" class="ltx_Math" display="inline" id="S3.p1.5.m5.1"><semantics id="S3.p1.5.m5.1a"><mo id="S3.p1.5.m5.1.1" xref="S3.p1.5.m5.1.1.cmml">⋅</mo><annotation-xml encoding="MathML-Content" id="S3.p1.5.m5.1b"><ci id="S3.p1.5.m5.1.1.cmml" xref="S3.p1.5.m5.1.1">⋅</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.5.m5.1c">\cdot</annotation><annotation encoding="application/x-llamapun" id="S3.p1.5.m5.1d">⋅</annotation></semantics></math>, <math alttext="c_{i,M}" class="ltx_Math" display="inline" id="S3.p1.6.m6.2"><semantics id="S3.p1.6.m6.2a"><msub id="S3.p1.6.m6.2.3" xref="S3.p1.6.m6.2.3.cmml"><mi id="S3.p1.6.m6.2.3.2" xref="S3.p1.6.m6.2.3.2.cmml">c</mi><mrow id="S3.p1.6.m6.2.2.2.4" xref="S3.p1.6.m6.2.2.2.3.cmml"><mi id="S3.p1.6.m6.1.1.1.1" xref="S3.p1.6.m6.1.1.1.1.cmml">i</mi><mo id="S3.p1.6.m6.2.2.2.4.1" xref="S3.p1.6.m6.2.2.2.3.cmml">,</mo><mi id="S3.p1.6.m6.2.2.2.2" xref="S3.p1.6.m6.2.2.2.2.cmml">M</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S3.p1.6.m6.2b"><apply id="S3.p1.6.m6.2.3.cmml" xref="S3.p1.6.m6.2.3"><csymbol cd="ambiguous" id="S3.p1.6.m6.2.3.1.cmml" xref="S3.p1.6.m6.2.3">subscript</csymbol><ci id="S3.p1.6.m6.2.3.2.cmml" xref="S3.p1.6.m6.2.3.2">𝑐</ci><list id="S3.p1.6.m6.2.2.2.3.cmml" xref="S3.p1.6.m6.2.2.2.4"><ci id="S3.p1.6.m6.1.1.1.1.cmml" xref="S3.p1.6.m6.1.1.1.1">𝑖</ci><ci id="S3.p1.6.m6.2.2.2.2.cmml" xref="S3.p1.6.m6.2.2.2.2">𝑀</ci></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.6.m6.2c">c_{i,M}</annotation><annotation encoding="application/x-llamapun" id="S3.p1.6.m6.2d">italic_c start_POSTSUBSCRIPT italic_i , italic_M end_POSTSUBSCRIPT</annotation></semantics></math>) denotes the <math alttext="M" class="ltx_Math" display="inline" id="S3.p1.7.m7.1"><semantics id="S3.p1.7.m7.1a"><mi id="S3.p1.7.m7.1.1" xref="S3.p1.7.m7.1.1.cmml">M</mi><annotation-xml encoding="MathML-Content" id="S3.p1.7.m7.1b"><ci id="S3.p1.7.m7.1.1.cmml" xref="S3.p1.7.m7.1.1">𝑀</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.7.m7.1c">M</annotation><annotation encoding="application/x-llamapun" id="S3.p1.7.m7.1d">italic_M</annotation></semantics></math>-length Semantic ID for <math alttext="item_{i}" class="ltx_Math" display="inline" id="S3.p1.8.m8.1"><semantics id="S3.p1.8.m8.1a"><mrow id="S3.p1.8.m8.1.1" xref="S3.p1.8.m8.1.1.cmml"><mi id="S3.p1.8.m8.1.1.2" xref="S3.p1.8.m8.1.1.2.cmml">i</mi><mo id="S3.p1.8.m8.1.1.1" xref="S3.p1.8.m8.1.1.1.cmml">⁢</mo><mi id="S3.p1.8.m8.1.1.3" xref="S3.p1.8.m8.1.1.3.cmml">t</mi><mo id="S3.p1.8.m8.1.1.1a" xref="S3.p1.8.m8.1.1.1.cmml">⁢</mo><mi id="S3.p1.8.m8.1.1.4" xref="S3.p1.8.m8.1.1.4.cmml">e</mi><mo id="S3.p1.8.m8.1.1.1b" xref="S3.p1.8.m8.1.1.1.cmml">⁢</mo><msub id="S3.p1.8.m8.1.1.5" xref="S3.p1.8.m8.1.1.5.cmml"><mi id="S3.p1.8.m8.1.1.5.2" xref="S3.p1.8.m8.1.1.5.2.cmml">m</mi><mi id="S3.p1.8.m8.1.1.5.3" xref="S3.p1.8.m8.1.1.5.3.cmml">i</mi></msub></mrow><annotation-xml encoding="MathML-Content" id="S3.p1.8.m8.1b"><apply id="S3.p1.8.m8.1.1.cmml" xref="S3.p1.8.m8.1.1"><times id="S3.p1.8.m8.1.1.1.cmml" xref="S3.p1.8.m8.1.1.1"></times><ci id="S3.p1.8.m8.1.1.2.cmml" xref="S3.p1.8.m8.1.1.2">𝑖</ci><ci id="S3.p1.8.m8.1.1.3.cmml" xref="S3.p1.8.m8.1.1.3">𝑡</ci><ci id="S3.p1.8.m8.1.1.4.cmml" xref="S3.p1.8.m8.1.1.4">𝑒</ci><apply id="S3.p1.8.m8.1.1.5.cmml" xref="S3.p1.8.m8.1.1.5"><csymbol cd="ambiguous" id="S3.p1.8.m8.1.1.5.1.cmml" xref="S3.p1.8.m8.1.1.5">subscript</csymbol><ci id="S3.p1.8.m8.1.1.5.2.cmml" xref="S3.p1.8.m8.1.1.5.2">𝑚</ci><ci id="S3.p1.8.m8.1.1.5.3.cmml" xref="S3.p1.8.m8.1.1.5.3">𝑖</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.8.m8.1c">item_{i}</annotation><annotation encoding="application/x-llamapun" id="S3.p1.8.m8.1d">italic_i italic_t italic_e italic_m start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math>. The LLM is then trained to predict the Semantic ID of <math alttext="item_{t+1}" class="ltx_Math" display="inline" id="S3.p1.9.m9.1"><semantics id="S3.p1.9.m9.1a"><mrow id="S3.p1.9.m9.1.1" xref="S3.p1.9.m9.1.1.cmml"><mi id="S3.p1.9.m9.1.1.2" xref="S3.p1.9.m9.1.1.2.cmml">i</mi><mo id="S3.p1.9.m9.1.1.1" xref="S3.p1.9.m9.1.1.1.cmml">⁢</mo><mi id="S3.p1.9.m9.1.1.3" xref="S3.p1.9.m9.1.1.3.cmml">t</mi><mo id="S3.p1.9.m9.1.1.1a" xref="S3.p1.9.m9.1.1.1.cmml">⁢</mo><mi id="S3.p1.9.m9.1.1.4" xref="S3.p1.9.m9.1.1.4.cmml">e</mi><mo id="S3.p1.9.m9.1.1.1b" xref="S3.p1.9.m9.1.1.1.cmml">⁢</mo><msub id="S3.p1.9.m9.1.1.5" xref="S3.p1.9.m9.1.1.5.cmml"><mi id="S3.p1.9.m9.1.1.5.2" xref="S3.p1.9.m9.1.1.5.2.cmml">m</mi><mrow id="S3.p1.9.m9.1.1.5.3" xref="S3.p1.9.m9.1.1.5.3.cmml"><mi id="S3.p1.9.m9.1.1.5.3.2" xref="S3.p1.9.m9.1.1.5.3.2.cmml">t</mi><mo id="S3.p1.9.m9.1.1.5.3.1" xref="S3.p1.9.m9.1.1.5.3.1.cmml">+</mo><mn id="S3.p1.9.m9.1.1.5.3.3" xref="S3.p1.9.m9.1.1.5.3.3.cmml">1</mn></mrow></msub></mrow><annotation-xml encoding="MathML-Content" id="S3.p1.9.m9.1b"><apply id="S3.p1.9.m9.1.1.cmml" xref="S3.p1.9.m9.1.1"><times id="S3.p1.9.m9.1.1.1.cmml" xref="S3.p1.9.m9.1.1.1"></times><ci id="S3.p1.9.m9.1.1.2.cmml" xref="S3.p1.9.m9.1.1.2">𝑖</ci><ci id="S3.p1.9.m9.1.1.3.cmml" xref="S3.p1.9.m9.1.1.3">𝑡</ci><ci id="S3.p1.9.m9.1.1.4.cmml" xref="S3.p1.9.m9.1.1.4">𝑒</ci><apply id="S3.p1.9.m9.1.1.5.cmml" xref="S3.p1.9.m9.1.1.5"><csymbol cd="ambiguous" id="S3.p1.9.m9.1.1.5.1.cmml" xref="S3.p1.9.m9.1.1.5">subscript</csymbol><ci id="S3.p1.9.m9.1.1.5.2.cmml" xref="S3.p1.9.m9.1.1.5.2">𝑚</ci><apply id="S3.p1.9.m9.1.1.5.3.cmml" xref="S3.p1.9.m9.1.1.5.3"><plus id="S3.p1.9.m9.1.1.5.3.1.cmml" xref="S3.p1.9.m9.1.1.5.3.1"></plus><ci id="S3.p1.9.m9.1.1.5.3.2.cmml" xref="S3.p1.9.m9.1.1.5.3.2">𝑡</ci><cn id="S3.p1.9.m9.1.1.5.3.3.cmml" type="integer" xref="S3.p1.9.m9.1.1.5.3.3">1</cn></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.9.m9.1c">item_{t+1}</annotation><annotation encoding="application/x-llamapun" id="S3.p1.9.m9.1d">italic_i italic_t italic_e italic_m start_POSTSUBSCRIPT italic_t + 1 end_POSTSUBSCRIPT</annotation></semantics></math>, represented as (<math alttext="c_{t+1,1}" class="ltx_Math" display="inline" id="S3.p1.10.m10.2"><semantics id="S3.p1.10.m10.2a"><msub id="S3.p1.10.m10.2.3" xref="S3.p1.10.m10.2.3.cmml"><mi id="S3.p1.10.m10.2.3.2" xref="S3.p1.10.m10.2.3.2.cmml">c</mi><mrow id="S3.p1.10.m10.2.2.2.2" xref="S3.p1.10.m10.2.2.2.3.cmml"><mrow id="S3.p1.10.m10.2.2.2.2.1" xref="S3.p1.10.m10.2.2.2.2.1.cmml"><mi id="S3.p1.10.m10.2.2.2.2.1.2" xref="S3.p1.10.m10.2.2.2.2.1.2.cmml">t</mi><mo id="S3.p1.10.m10.2.2.2.2.1.1" xref="S3.p1.10.m10.2.2.2.2.1.1.cmml">+</mo><mn id="S3.p1.10.m10.2.2.2.2.1.3" xref="S3.p1.10.m10.2.2.2.2.1.3.cmml">1</mn></mrow><mo id="S3.p1.10.m10.2.2.2.2.2" xref="S3.p1.10.m10.2.2.2.3.cmml">,</mo><mn id="S3.p1.10.m10.1.1.1.1" xref="S3.p1.10.m10.1.1.1.1.cmml">1</mn></mrow></msub><annotation-xml encoding="MathML-Content" id="S3.p1.10.m10.2b"><apply id="S3.p1.10.m10.2.3.cmml" xref="S3.p1.10.m10.2.3"><csymbol cd="ambiguous" id="S3.p1.10.m10.2.3.1.cmml" xref="S3.p1.10.m10.2.3">subscript</csymbol><ci id="S3.p1.10.m10.2.3.2.cmml" xref="S3.p1.10.m10.2.3.2">𝑐</ci><list id="S3.p1.10.m10.2.2.2.3.cmml" xref="S3.p1.10.m10.2.2.2.2"><apply id="S3.p1.10.m10.2.2.2.2.1.cmml" xref="S3.p1.10.m10.2.2.2.2.1"><plus id="S3.p1.10.m10.2.2.2.2.1.1.cmml" xref="S3.p1.10.m10.2.2.2.2.1.1"></plus><ci id="S3.p1.10.m10.2.2.2.2.1.2.cmml" xref="S3.p1.10.m10.2.2.2.2.1.2">𝑡</ci><cn id="S3.p1.10.m10.2.2.2.2.1.3.cmml" type="integer" xref="S3.p1.10.m10.2.2.2.2.1.3">1</cn></apply><cn id="S3.p1.10.m10.1.1.1.1.cmml" type="integer" xref="S3.p1.10.m10.1.1.1.1">1</cn></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.10.m10.2c">c_{t+1,1}</annotation><annotation encoding="application/x-llamapun" id="S3.p1.10.m10.2d">italic_c start_POSTSUBSCRIPT italic_t + 1 , 1 end_POSTSUBSCRIPT</annotation></semantics></math>, <math alttext="\cdot" class="ltx_Math" display="inline" id="S3.p1.11.m11.1"><semantics id="S3.p1.11.m11.1a"><mo id="S3.p1.11.m11.1.1" xref="S3.p1.11.m11.1.1.cmml">⋅</mo><annotation-xml encoding="MathML-Content" id="S3.p1.11.m11.1b"><ci id="S3.p1.11.m11.1.1.cmml" xref="S3.p1.11.m11.1.1">⋅</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.11.m11.1c">\cdot</annotation><annotation encoding="application/x-llamapun" id="S3.p1.11.m11.1d">⋅</annotation></semantics></math>, <math alttext="c_{t+1,M}" class="ltx_Math" display="inline" id="S3.p1.12.m12.2"><semantics id="S3.p1.12.m12.2a"><msub id="S3.p1.12.m12.2.3" xref="S3.p1.12.m12.2.3.cmml"><mi id="S3.p1.12.m12.2.3.2" xref="S3.p1.12.m12.2.3.2.cmml">c</mi><mrow id="S3.p1.12.m12.2.2.2.2" xref="S3.p1.12.m12.2.2.2.3.cmml"><mrow id="S3.p1.12.m12.2.2.2.2.1" xref="S3.p1.12.m12.2.2.2.2.1.cmml"><mi id="S3.p1.12.m12.2.2.2.2.1.2" xref="S3.p1.12.m12.2.2.2.2.1.2.cmml">t</mi><mo id="S3.p1.12.m12.2.2.2.2.1.1" xref="S3.p1.12.m12.2.2.2.2.1.1.cmml">+</mo><mn id="S3.p1.12.m12.2.2.2.2.1.3" xref="S3.p1.12.m12.2.2.2.2.1.3.cmml">1</mn></mrow><mo id="S3.p1.12.m12.2.2.2.2.2" xref="S3.p1.12.m12.2.2.2.3.cmml">,</mo><mi id="S3.p1.12.m12.1.1.1.1" xref="S3.p1.12.m12.1.1.1.1.cmml">M</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S3.p1.12.m12.2b"><apply id="S3.p1.12.m12.2.3.cmml" xref="S3.p1.12.m12.2.3"><csymbol cd="ambiguous" id="S3.p1.12.m12.2.3.1.cmml" xref="S3.p1.12.m12.2.3">subscript</csymbol><ci id="S3.p1.12.m12.2.3.2.cmml" xref="S3.p1.12.m12.2.3.2">𝑐</ci><list id="S3.p1.12.m12.2.2.2.3.cmml" xref="S3.p1.12.m12.2.2.2.2"><apply id="S3.p1.12.m12.2.2.2.2.1.cmml" xref="S3.p1.12.m12.2.2.2.2.1"><plus id="S3.p1.12.m12.2.2.2.2.1.1.cmml" xref="S3.p1.12.m12.2.2.2.2.1.1"></plus><ci id="S3.p1.12.m12.2.2.2.2.1.2.cmml" xref="S3.p1.12.m12.2.2.2.2.1.2">𝑡</ci><cn id="S3.p1.12.m12.2.2.2.2.1.3.cmml" type="integer" xref="S3.p1.12.m12.2.2.2.2.1.3">1</cn></apply><ci id="S3.p1.12.m12.1.1.1.1.cmml" xref="S3.p1.12.m12.1.1.1.1">𝑀</ci></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.12.m12.2c">c_{t+1,M}</annotation><annotation encoding="application/x-llamapun" id="S3.p1.12.m12.2d">italic_c start_POSTSUBSCRIPT italic_t + 1 , italic_M end_POSTSUBSCRIPT</annotation></semantics></math>).
The generation objective could be formulated as,</p>
<table class="ltx_equation ltx_eqn_table" id="S3.E4">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathcal{L}_{sft}=-\sum_{i}^{M}\log{p_{\theta}}(i|q,u,Seq,I_{&lt;i})" class="ltx_Math" display="block" id="S3.E4.m1.3"><semantics id="S3.E4.m1.3a"><mrow id="S3.E4.m1.3.3" xref="S3.E4.m1.3.3.cmml"><msub id="S3.E4.m1.3.3.3" xref="S3.E4.m1.3.3.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S3.E4.m1.3.3.3.2" xref="S3.E4.m1.3.3.3.2.cmml">ℒ</mi><mrow id="S3.E4.m1.3.3.3.3" xref="S3.E4.m1.3.3.3.3.cmml"><mi id="S3.E4.m1.3.3.3.3.2" xref="S3.E4.m1.3.3.3.3.2.cmml">s</mi><mo id="S3.E4.m1.3.3.3.3.1" xref="S3.E4.m1.3.3.3.3.1.cmml">⁢</mo><mi id="S3.E4.m1.3.3.3.3.3" xref="S3.E4.m1.3.3.3.3.3.cmml">f</mi><mo id="S3.E4.m1.3.3.3.3.1a" xref="S3.E4.m1.3.3.3.3.1.cmml">⁢</mo><mi id="S3.E4.m1.3.3.3.3.4" xref="S3.E4.m1.3.3.3.3.4.cmml">t</mi></mrow></msub><mo id="S3.E4.m1.3.3.2" xref="S3.E4.m1.3.3.2.cmml">=</mo><mrow id="S3.E4.m1.3.3.1" xref="S3.E4.m1.3.3.1.cmml"><mo id="S3.E4.m1.3.3.1a" xref="S3.E4.m1.3.3.1.cmml">−</mo><mrow id="S3.E4.m1.3.3.1.1" xref="S3.E4.m1.3.3.1.1.cmml"><munderover id="S3.E4.m1.3.3.1.1.2" xref="S3.E4.m1.3.3.1.1.2.cmml"><mo id="S3.E4.m1.3.3.1.1.2.2.2" movablelimits="false" xref="S3.E4.m1.3.3.1.1.2.2.2.cmml">∑</mo><mi id="S3.E4.m1.3.3.1.1.2.2.3" xref="S3.E4.m1.3.3.1.1.2.2.3.cmml">i</mi><mi id="S3.E4.m1.3.3.1.1.2.3" xref="S3.E4.m1.3.3.1.1.2.3.cmml">M</mi></munderover><mrow id="S3.E4.m1.3.3.1.1.1" xref="S3.E4.m1.3.3.1.1.1.cmml"><mrow id="S3.E4.m1.3.3.1.1.1.3" xref="S3.E4.m1.3.3.1.1.1.3.cmml"><mi id="S3.E4.m1.3.3.1.1.1.3.1" xref="S3.E4.m1.3.3.1.1.1.3.1.cmml">log</mi><mo id="S3.E4.m1.3.3.1.1.1.3a" lspace="0.167em" xref="S3.E4.m1.3.3.1.1.1.3.cmml">⁡</mo><msub id="S3.E4.m1.3.3.1.1.1.3.2" xref="S3.E4.m1.3.3.1.1.1.3.2.cmml"><mi id="S3.E4.m1.3.3.1.1.1.3.2.2" xref="S3.E4.m1.3.3.1.1.1.3.2.2.cmml">p</mi><mi id="S3.E4.m1.3.3.1.1.1.3.2.3" xref="S3.E4.m1.3.3.1.1.1.3.2.3.cmml">θ</mi></msub></mrow><mo id="S3.E4.m1.3.3.1.1.1.2" xref="S3.E4.m1.3.3.1.1.1.2.cmml">⁢</mo><mrow id="S3.E4.m1.3.3.1.1.1.1.1" xref="S3.E4.m1.3.3.1.1.1.1.1.1.cmml"><mo id="S3.E4.m1.3.3.1.1.1.1.1.2" stretchy="false" xref="S3.E4.m1.3.3.1.1.1.1.1.1.cmml">(</mo><mrow id="S3.E4.m1.3.3.1.1.1.1.1.1" xref="S3.E4.m1.3.3.1.1.1.1.1.1.cmml"><mi id="S3.E4.m1.3.3.1.1.1.1.1.1.4" xref="S3.E4.m1.3.3.1.1.1.1.1.1.4.cmml">i</mi><mo fence="false" id="S3.E4.m1.3.3.1.1.1.1.1.1.3" xref="S3.E4.m1.3.3.1.1.1.1.1.1.3.cmml">|</mo><mrow id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.3.cmml"><mi id="S3.E4.m1.1.1" xref="S3.E4.m1.1.1.cmml">q</mi><mo id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.3" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.3.cmml">,</mo><mi id="S3.E4.m1.2.2" xref="S3.E4.m1.2.2.cmml">u</mi><mo id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.4" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.3.cmml">,</mo><mrow id="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1" xref="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.cmml"><mi id="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.2" xref="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.2.cmml">S</mi><mo id="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.1" xref="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.1.cmml">⁢</mo><mi id="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.3" xref="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.3.cmml">e</mi><mo id="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.1a" xref="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.1.cmml">⁢</mo><mi id="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.4" xref="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.4.cmml">q</mi></mrow><mo id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.5" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.3.cmml">,</mo><msub id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.cmml"><mi id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.2" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.2.cmml">I</mi><mrow id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.cmml"><mi id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.2" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.2.cmml"></mi><mo id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.1" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.1.cmml">&lt;</mo><mi id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.3" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.3.cmml">i</mi></mrow></msub></mrow></mrow><mo id="S3.E4.m1.3.3.1.1.1.1.1.3" stretchy="false" xref="S3.E4.m1.3.3.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.E4.m1.3b"><apply id="S3.E4.m1.3.3.cmml" xref="S3.E4.m1.3.3"><eq id="S3.E4.m1.3.3.2.cmml" xref="S3.E4.m1.3.3.2"></eq><apply id="S3.E4.m1.3.3.3.cmml" xref="S3.E4.m1.3.3.3"><csymbol cd="ambiguous" id="S3.E4.m1.3.3.3.1.cmml" xref="S3.E4.m1.3.3.3">subscript</csymbol><ci id="S3.E4.m1.3.3.3.2.cmml" xref="S3.E4.m1.3.3.3.2">ℒ</ci><apply id="S3.E4.m1.3.3.3.3.cmml" xref="S3.E4.m1.3.3.3.3"><times id="S3.E4.m1.3.3.3.3.1.cmml" xref="S3.E4.m1.3.3.3.3.1"></times><ci id="S3.E4.m1.3.3.3.3.2.cmml" xref="S3.E4.m1.3.3.3.3.2">𝑠</ci><ci id="S3.E4.m1.3.3.3.3.3.cmml" xref="S3.E4.m1.3.3.3.3.3">𝑓</ci><ci id="S3.E4.m1.3.3.3.3.4.cmml" xref="S3.E4.m1.3.3.3.3.4">𝑡</ci></apply></apply><apply id="S3.E4.m1.3.3.1.cmml" xref="S3.E4.m1.3.3.1"><minus id="S3.E4.m1.3.3.1.2.cmml" xref="S3.E4.m1.3.3.1"></minus><apply id="S3.E4.m1.3.3.1.1.cmml" xref="S3.E4.m1.3.3.1.1"><apply id="S3.E4.m1.3.3.1.1.2.cmml" xref="S3.E4.m1.3.3.1.1.2"><csymbol cd="ambiguous" id="S3.E4.m1.3.3.1.1.2.1.cmml" xref="S3.E4.m1.3.3.1.1.2">superscript</csymbol><apply id="S3.E4.m1.3.3.1.1.2.2.cmml" xref="S3.E4.m1.3.3.1.1.2"><csymbol cd="ambiguous" id="S3.E4.m1.3.3.1.1.2.2.1.cmml" xref="S3.E4.m1.3.3.1.1.2">subscript</csymbol><sum id="S3.E4.m1.3.3.1.1.2.2.2.cmml" xref="S3.E4.m1.3.3.1.1.2.2.2"></sum><ci id="S3.E4.m1.3.3.1.1.2.2.3.cmml" xref="S3.E4.m1.3.3.1.1.2.2.3">𝑖</ci></apply><ci id="S3.E4.m1.3.3.1.1.2.3.cmml" xref="S3.E4.m1.3.3.1.1.2.3">𝑀</ci></apply><apply id="S3.E4.m1.3.3.1.1.1.cmml" xref="S3.E4.m1.3.3.1.1.1"><times id="S3.E4.m1.3.3.1.1.1.2.cmml" xref="S3.E4.m1.3.3.1.1.1.2"></times><apply id="S3.E4.m1.3.3.1.1.1.3.cmml" xref="S3.E4.m1.3.3.1.1.1.3"><log id="S3.E4.m1.3.3.1.1.1.3.1.cmml" xref="S3.E4.m1.3.3.1.1.1.3.1"></log><apply id="S3.E4.m1.3.3.1.1.1.3.2.cmml" xref="S3.E4.m1.3.3.1.1.1.3.2"><csymbol cd="ambiguous" id="S3.E4.m1.3.3.1.1.1.3.2.1.cmml" xref="S3.E4.m1.3.3.1.1.1.3.2">subscript</csymbol><ci id="S3.E4.m1.3.3.1.1.1.3.2.2.cmml" xref="S3.E4.m1.3.3.1.1.1.3.2.2">𝑝</ci><ci id="S3.E4.m1.3.3.1.1.1.3.2.3.cmml" xref="S3.E4.m1.3.3.1.1.1.3.2.3">𝜃</ci></apply></apply><apply id="S3.E4.m1.3.3.1.1.1.1.1.1.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1"><csymbol cd="latexml" id="S3.E4.m1.3.3.1.1.1.1.1.1.3.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.3">conditional</csymbol><ci id="S3.E4.m1.3.3.1.1.1.1.1.1.4.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.4">𝑖</ci><list id="S3.E4.m1.3.3.1.1.1.1.1.1.2.3.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2"><ci id="S3.E4.m1.1.1.cmml" xref="S3.E4.m1.1.1">𝑞</ci><ci id="S3.E4.m1.2.2.cmml" xref="S3.E4.m1.2.2">𝑢</ci><apply id="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1"><times id="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.1.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.1"></times><ci id="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.2.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.2">𝑆</ci><ci id="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.3.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.3">𝑒</ci><ci id="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.4.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.1.1.1.4">𝑞</ci></apply><apply id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2"><csymbol cd="ambiguous" id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.1.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2">subscript</csymbol><ci id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.2.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.2">𝐼</ci><apply id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3"><lt id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.1.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.1"></lt><csymbol cd="latexml" id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.2.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.2">absent</csymbol><ci id="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.3.cmml" xref="S3.E4.m1.3.3.1.1.1.1.1.1.2.2.2.3.3">𝑖</ci></apply></apply></list></apply></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.E4.m1.3c">\mathcal{L}_{sft}=-\sum_{i}^{M}\log{p_{\theta}}(i|q,u,Seq,I_{&lt;i})</annotation><annotation encoding="application/x-llamapun" id="S3.E4.m1.3d">caligraphic_L start_POSTSUBSCRIPT italic_s italic_f italic_t end_POSTSUBSCRIPT = - ∑ start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_M end_POSTSUPERSCRIPT roman_log italic_p start_POSTSUBSCRIPT italic_θ end_POSTSUBSCRIPT ( italic_i | italic_q , italic_u , italic_S italic_e italic_q , italic_I start_POSTSUBSCRIPT &lt; italic_i end_POSTSUBSCRIPT )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(4)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S3.p1.14">where <math alttext="I_{&lt;i}=\{c_{t+1,1},\cdots,c_{t+1,i}\}" class="ltx_Math" display="inline" id="S3.p1.13.m1.7"><semantics id="S3.p1.13.m1.7a"><mrow id="S3.p1.13.m1.7.7" xref="S3.p1.13.m1.7.7.cmml"><msub id="S3.p1.13.m1.7.7.4" xref="S3.p1.13.m1.7.7.4.cmml"><mi id="S3.p1.13.m1.7.7.4.2" xref="S3.p1.13.m1.7.7.4.2.cmml">I</mi><mrow id="S3.p1.13.m1.7.7.4.3" xref="S3.p1.13.m1.7.7.4.3.cmml"><mi id="S3.p1.13.m1.7.7.4.3.2" xref="S3.p1.13.m1.7.7.4.3.2.cmml"></mi><mo id="S3.p1.13.m1.7.7.4.3.1" xref="S3.p1.13.m1.7.7.4.3.1.cmml">&lt;</mo><mi id="S3.p1.13.m1.7.7.4.3.3" xref="S3.p1.13.m1.7.7.4.3.3.cmml">i</mi></mrow></msub><mo id="S3.p1.13.m1.7.7.3" xref="S3.p1.13.m1.7.7.3.cmml">=</mo><mrow id="S3.p1.13.m1.7.7.2.2" xref="S3.p1.13.m1.7.7.2.3.cmml"><mo id="S3.p1.13.m1.7.7.2.2.3" stretchy="false" xref="S3.p1.13.m1.7.7.2.3.cmml">{</mo><msub id="S3.p1.13.m1.6.6.1.1.1" xref="S3.p1.13.m1.6.6.1.1.1.cmml"><mi id="S3.p1.13.m1.6.6.1.1.1.2" xref="S3.p1.13.m1.6.6.1.1.1.2.cmml">c</mi><mrow id="S3.p1.13.m1.2.2.2.2" xref="S3.p1.13.m1.2.2.2.3.cmml"><mrow id="S3.p1.13.m1.2.2.2.2.1" xref="S3.p1.13.m1.2.2.2.2.1.cmml"><mi id="S3.p1.13.m1.2.2.2.2.1.2" xref="S3.p1.13.m1.2.2.2.2.1.2.cmml">t</mi><mo id="S3.p1.13.m1.2.2.2.2.1.1" xref="S3.p1.13.m1.2.2.2.2.1.1.cmml">+</mo><mn id="S3.p1.13.m1.2.2.2.2.1.3" xref="S3.p1.13.m1.2.2.2.2.1.3.cmml">1</mn></mrow><mo id="S3.p1.13.m1.2.2.2.2.2" xref="S3.p1.13.m1.2.2.2.3.cmml">,</mo><mn id="S3.p1.13.m1.1.1.1.1" xref="S3.p1.13.m1.1.1.1.1.cmml">1</mn></mrow></msub><mo id="S3.p1.13.m1.7.7.2.2.4" xref="S3.p1.13.m1.7.7.2.3.cmml">,</mo><mi id="S3.p1.13.m1.5.5" mathvariant="normal" xref="S3.p1.13.m1.5.5.cmml">⋯</mi><mo id="S3.p1.13.m1.7.7.2.2.5" xref="S3.p1.13.m1.7.7.2.3.cmml">,</mo><msub id="S3.p1.13.m1.7.7.2.2.2" xref="S3.p1.13.m1.7.7.2.2.2.cmml"><mi id="S3.p1.13.m1.7.7.2.2.2.2" xref="S3.p1.13.m1.7.7.2.2.2.2.cmml">c</mi><mrow id="S3.p1.13.m1.4.4.2.2" xref="S3.p1.13.m1.4.4.2.3.cmml"><mrow id="S3.p1.13.m1.4.4.2.2.1" xref="S3.p1.13.m1.4.4.2.2.1.cmml"><mi id="S3.p1.13.m1.4.4.2.2.1.2" xref="S3.p1.13.m1.4.4.2.2.1.2.cmml">t</mi><mo id="S3.p1.13.m1.4.4.2.2.1.1" xref="S3.p1.13.m1.4.4.2.2.1.1.cmml">+</mo><mn id="S3.p1.13.m1.4.4.2.2.1.3" xref="S3.p1.13.m1.4.4.2.2.1.3.cmml">1</mn></mrow><mo id="S3.p1.13.m1.4.4.2.2.2" xref="S3.p1.13.m1.4.4.2.3.cmml">,</mo><mi id="S3.p1.13.m1.3.3.1.1" xref="S3.p1.13.m1.3.3.1.1.cmml">i</mi></mrow></msub><mo id="S3.p1.13.m1.7.7.2.2.6" stretchy="false" xref="S3.p1.13.m1.7.7.2.3.cmml">}</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.p1.13.m1.7b"><apply id="S3.p1.13.m1.7.7.cmml" xref="S3.p1.13.m1.7.7"><eq id="S3.p1.13.m1.7.7.3.cmml" xref="S3.p1.13.m1.7.7.3"></eq><apply id="S3.p1.13.m1.7.7.4.cmml" xref="S3.p1.13.m1.7.7.4"><csymbol cd="ambiguous" id="S3.p1.13.m1.7.7.4.1.cmml" xref="S3.p1.13.m1.7.7.4">subscript</csymbol><ci id="S3.p1.13.m1.7.7.4.2.cmml" xref="S3.p1.13.m1.7.7.4.2">𝐼</ci><apply id="S3.p1.13.m1.7.7.4.3.cmml" xref="S3.p1.13.m1.7.7.4.3"><lt id="S3.p1.13.m1.7.7.4.3.1.cmml" xref="S3.p1.13.m1.7.7.4.3.1"></lt><csymbol cd="latexml" id="S3.p1.13.m1.7.7.4.3.2.cmml" xref="S3.p1.13.m1.7.7.4.3.2">absent</csymbol><ci id="S3.p1.13.m1.7.7.4.3.3.cmml" xref="S3.p1.13.m1.7.7.4.3.3">𝑖</ci></apply></apply><set id="S3.p1.13.m1.7.7.2.3.cmml" xref="S3.p1.13.m1.7.7.2.2"><apply id="S3.p1.13.m1.6.6.1.1.1.cmml" xref="S3.p1.13.m1.6.6.1.1.1"><csymbol cd="ambiguous" id="S3.p1.13.m1.6.6.1.1.1.1.cmml" xref="S3.p1.13.m1.6.6.1.1.1">subscript</csymbol><ci id="S3.p1.13.m1.6.6.1.1.1.2.cmml" xref="S3.p1.13.m1.6.6.1.1.1.2">𝑐</ci><list id="S3.p1.13.m1.2.2.2.3.cmml" xref="S3.p1.13.m1.2.2.2.2"><apply id="S3.p1.13.m1.2.2.2.2.1.cmml" xref="S3.p1.13.m1.2.2.2.2.1"><plus id="S3.p1.13.m1.2.2.2.2.1.1.cmml" xref="S3.p1.13.m1.2.2.2.2.1.1"></plus><ci id="S3.p1.13.m1.2.2.2.2.1.2.cmml" xref="S3.p1.13.m1.2.2.2.2.1.2">𝑡</ci><cn id="S3.p1.13.m1.2.2.2.2.1.3.cmml" type="integer" xref="S3.p1.13.m1.2.2.2.2.1.3">1</cn></apply><cn id="S3.p1.13.m1.1.1.1.1.cmml" type="integer" xref="S3.p1.13.m1.1.1.1.1">1</cn></list></apply><ci id="S3.p1.13.m1.5.5.cmml" xref="S3.p1.13.m1.5.5">⋯</ci><apply id="S3.p1.13.m1.7.7.2.2.2.cmml" xref="S3.p1.13.m1.7.7.2.2.2"><csymbol cd="ambiguous" id="S3.p1.13.m1.7.7.2.2.2.1.cmml" xref="S3.p1.13.m1.7.7.2.2.2">subscript</csymbol><ci id="S3.p1.13.m1.7.7.2.2.2.2.cmml" xref="S3.p1.13.m1.7.7.2.2.2.2">𝑐</ci><list id="S3.p1.13.m1.4.4.2.3.cmml" xref="S3.p1.13.m1.4.4.2.2"><apply id="S3.p1.13.m1.4.4.2.2.1.cmml" xref="S3.p1.13.m1.4.4.2.2.1"><plus id="S3.p1.13.m1.4.4.2.2.1.1.cmml" xref="S3.p1.13.m1.4.4.2.2.1.1"></plus><ci id="S3.p1.13.m1.4.4.2.2.1.2.cmml" xref="S3.p1.13.m1.4.4.2.2.1.2">𝑡</ci><cn id="S3.p1.13.m1.4.4.2.2.1.3.cmml" type="integer" xref="S3.p1.13.m1.4.4.2.2.1.3">1</cn></apply><ci id="S3.p1.13.m1.3.3.1.1.cmml" xref="S3.p1.13.m1.3.3.1.1">𝑖</ci></list></apply></set></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.13.m1.7c">I_{&lt;i}=\{c_{t+1,1},\cdots,c_{t+1,i}\}</annotation><annotation encoding="application/x-llamapun" id="S3.p1.13.m1.7d">italic_I start_POSTSUBSCRIPT &lt; italic_i end_POSTSUBSCRIPT = { italic_c start_POSTSUBSCRIPT italic_t + 1 , 1 end_POSTSUBSCRIPT , ⋯ , italic_c start_POSTSUBSCRIPT italic_t + 1 , italic_i end_POSTSUBSCRIPT }</annotation></semantics></math>, <math alttext="p_{\theta}" class="ltx_Math" display="inline" id="S3.p1.14.m2.1"><semantics id="S3.p1.14.m2.1a"><msub id="S3.p1.14.m2.1.1" xref="S3.p1.14.m2.1.1.cmml"><mi id="S3.p1.14.m2.1.1.2" xref="S3.p1.14.m2.1.1.2.cmml">p</mi><mi id="S3.p1.14.m2.1.1.3" xref="S3.p1.14.m2.1.1.3.cmml">θ</mi></msub><annotation-xml encoding="MathML-Content" id="S3.p1.14.m2.1b"><apply id="S3.p1.14.m2.1.1.cmml" xref="S3.p1.14.m2.1.1"><csymbol cd="ambiguous" id="S3.p1.14.m2.1.1.1.cmml" xref="S3.p1.14.m2.1.1">subscript</csymbol><ci id="S3.p1.14.m2.1.1.2.cmml" xref="S3.p1.14.m2.1.1.2">𝑝</ci><ci id="S3.p1.14.m2.1.1.3.cmml" xref="S3.p1.14.m2.1.1.3">𝜃</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.p1.14.m2.1c">p_{\theta}</annotation><annotation encoding="application/x-llamapun" id="S3.p1.14.m2.1d">italic_p start_POSTSUBSCRIPT italic_θ end_POSTSUBSCRIPT</annotation></semantics></math> is the SFT model.</p>
</div>
</section>
<section class="ltx_section" id="S4">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">4 </span>Problem of GR based on RQ</h2>
<section class="ltx_subsection" id="S4.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.1 </span>Hourglass Phenomenon</h3>
<figure class="ltx_figure" id="S4.F2"><img alt="Refer to caption" class="ltx_graphics ltx_centering" id="S4.F2.g1" src="latex/figs/SemanticIDFig.pdf"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 2: </span>Distribution and Connections of Semantic IDs</figcaption>
</figure>
<figure class="ltx_figure" id="S4.F3"><img alt="Refer to caption" class="ltx_graphics ltx_centering" id="S4.F3.g1" src="latex/figs/LongTail_Metrics.pdf"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 3: </span>Illustrating the Hourglass Phenomenon in Semantic IDs with Different Statistical Metrics</figcaption>
</figure>
<div class="ltx_para" id="S4.SS1.p1">
<p class="ltx_p" id="S4.SS1.p1.1">To generate the semantic IDs used in Section 3, we first leverage the query-item data from billions of search logs within the company to train dual-tower models such as DSSM and BERT <cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">adaptive</span>; <span class="ltx_ref ltx_missing_citation ltx_ref_self">mixpq</span>; <span class="ltx_ref ltx_missing_citation ltx_ref_self">qiu2022pre</span>; <span class="ltx_ref ltx_missing_citation ltx_ref_self">WangLZZWXLY23</span></cite>. Subsequently, we obtain the embeddings for hundreds of millions of items using the item tower. Finally, we employ RQ to generate semantic IDs for all items.</p>
</div>
<div class="ltx_para" id="S4.SS1.p2">
<p class="ltx_p" id="S4.SS1.p2.1">Upon the successful generation of semantic IDs, we proceed to aggregate and compute the three-layer distribution maps for all items. As illustrated in Figure <a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S4.F2" title="Figure 2 ‣ 4.1 Hourglass Phenomenon ‣ 4 Problem of GR based on RQ ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_tag">2</span></a>, it is evident that the second layer of the Semantic ID architecture is concentrated with a substantial number of routing nodes. The overall distribution of the three-layer code exhibits an hourglass phenomenon.</p>
</div>
<div class="ltx_para" id="S4.SS1.p3">
<p class="ltx_p" id="S4.SS1.p3.1">To investigate the generalizability of this phenomenon, we conducted multiple visualization experiments under various parameter combinations (e.g., code table size and number of layers). As shown in Figure <a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#A1.F6" title="Figure 6 ‣ Appendix A Distribution of RQ-Semantic ID ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_tag">6</span></a> in the appendix, the results indicate that the hourglass effect is highly pronounced, and the path distribution among the tokens across the three layers of the code table is relatively sparse.</p>
</div>
<div class="ltx_para" id="S4.SS1.p4">
<p class="ltx_p" id="S4.SS1.p4.1">Additionally, based on the aforementioned experiments, we conducted statistical analyses of the token distribution in the second layer using three metrics: entropy<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">shannon1948mathematical</span></cite>, Gini coefficient<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">yitzhaki1979relative</span></cite>, and standard deviation<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">pal2019introduction</span></cite>, as shown in the Figure <a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S4.F3" title="Figure 3 ‣ 4.1 Hourglass Phenomenon ‣ 4 Problem of GR based on RQ ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_tag">3</span></a>. The results indicate that the token distribution in the second layer exhibits low entropy, high Gini coefficient, and large standard deviation, suggesting that the distribution is highly skewed and exhibits a long-tail effects.</p>
</div>
<div class="ltx_para" id="S4.SS1.p5">
<p class="ltx_p" id="S4.SS1.p5.1">Overall, this Hourglass phenomenon is statistically evidenced in the code table by path sparsity and a long-tail distribution of tokens. Path sparsity, resulting from the Semantic ID structure, leads to low code table utilization. The long-tail distribution indicates that in the intermediate layer, a predominant number of routes converge on a single token.</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.2 </span>Analysis of Residual Quantization</h3>
<div class="ltx_para" id="S4.SS2.p1">
<p class="ltx_p" id="S4.SS2.p1.1">Based on the hourglass phenomenon demonstrated in the aforementioned experiments, along with the corresponding path sparsity and long-tail distribution of tokens, it is imperative to conduct an in-depth analysis to understand the underlying causes of this phenomenon.</p>
</div>
<div class="ltx_para" id="S4.SS2.p2">
<p class="ltx_p" id="S4.SS2.p2.3">Without loss of generality, we consider two distributions of raw embedding: un-uniform and uniform, denoted as <math alttext="\textbf{X}=\left\{\textbf{x}|\textbf{x}\in\textbf{X}\right\}\in\mathcal{R}^{N%
\times M}" class="ltx_Math" display="inline" id="S4.SS2.p2.1.m1.2"><semantics id="S4.SS2.p2.1.m1.2a"><mrow id="S4.SS2.p2.1.m1.2.2" xref="S4.SS2.p2.1.m1.2.2.cmml"><mtext class="ltx_mathvariant_bold" id="S4.SS2.p2.1.m1.2.2.3" xref="S4.SS2.p2.1.m1.2.2.3a.cmml">X</mtext><mo id="S4.SS2.p2.1.m1.2.2.4" xref="S4.SS2.p2.1.m1.2.2.4.cmml">=</mo><mrow id="S4.SS2.p2.1.m1.2.2.1.1" xref="S4.SS2.p2.1.m1.2.2.1.2.cmml"><mo id="S4.SS2.p2.1.m1.2.2.1.1.2" xref="S4.SS2.p2.1.m1.2.2.1.2.1.cmml">{</mo><mtext class="ltx_mathvariant_bold" id="S4.SS2.p2.1.m1.1.1" xref="S4.SS2.p2.1.m1.1.1a.cmml">x</mtext><mo id="S4.SS2.p2.1.m1.2.2.1.1.3" lspace="0em" rspace="0em" xref="S4.SS2.p2.1.m1.2.2.1.2.1.cmml">|</mo><mrow id="S4.SS2.p2.1.m1.2.2.1.1.1" xref="S4.SS2.p2.1.m1.2.2.1.1.1.cmml"><mtext class="ltx_mathvariant_bold" id="S4.SS2.p2.1.m1.2.2.1.1.1.2" xref="S4.SS2.p2.1.m1.2.2.1.1.1.2a.cmml">x</mtext><mo id="S4.SS2.p2.1.m1.2.2.1.1.1.1" xref="S4.SS2.p2.1.m1.2.2.1.1.1.1.cmml">∈</mo><mtext class="ltx_mathvariant_bold" id="S4.SS2.p2.1.m1.2.2.1.1.1.3" xref="S4.SS2.p2.1.m1.2.2.1.1.1.3a.cmml">X</mtext></mrow><mo id="S4.SS2.p2.1.m1.2.2.1.1.4" xref="S4.SS2.p2.1.m1.2.2.1.2.1.cmml">}</mo></mrow><mo id="S4.SS2.p2.1.m1.2.2.5" xref="S4.SS2.p2.1.m1.2.2.5.cmml">∈</mo><msup id="S4.SS2.p2.1.m1.2.2.6" xref="S4.SS2.p2.1.m1.2.2.6.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.SS2.p2.1.m1.2.2.6.2" xref="S4.SS2.p2.1.m1.2.2.6.2.cmml">ℛ</mi><mrow id="S4.SS2.p2.1.m1.2.2.6.3" xref="S4.SS2.p2.1.m1.2.2.6.3.cmml"><mi id="S4.SS2.p2.1.m1.2.2.6.3.2" xref="S4.SS2.p2.1.m1.2.2.6.3.2.cmml">N</mi><mo id="S4.SS2.p2.1.m1.2.2.6.3.1" lspace="0.222em" rspace="0.222em" xref="S4.SS2.p2.1.m1.2.2.6.3.1.cmml">×</mo><mi id="S4.SS2.p2.1.m1.2.2.6.3.3" xref="S4.SS2.p2.1.m1.2.2.6.3.3.cmml">M</mi></mrow></msup></mrow><annotation-xml encoding="MathML-Content" id="S4.SS2.p2.1.m1.2b"><apply id="S4.SS2.p2.1.m1.2.2.cmml" xref="S4.SS2.p2.1.m1.2.2"><and id="S4.SS2.p2.1.m1.2.2a.cmml" xref="S4.SS2.p2.1.m1.2.2"></and><apply id="S4.SS2.p2.1.m1.2.2b.cmml" xref="S4.SS2.p2.1.m1.2.2"><eq id="S4.SS2.p2.1.m1.2.2.4.cmml" xref="S4.SS2.p2.1.m1.2.2.4"></eq><ci id="S4.SS2.p2.1.m1.2.2.3a.cmml" xref="S4.SS2.p2.1.m1.2.2.3"><mtext class="ltx_mathvariant_bold" id="S4.SS2.p2.1.m1.2.2.3.cmml" xref="S4.SS2.p2.1.m1.2.2.3">X</mtext></ci><apply id="S4.SS2.p2.1.m1.2.2.1.2.cmml" xref="S4.SS2.p2.1.m1.2.2.1.1"><csymbol cd="latexml" id="S4.SS2.p2.1.m1.2.2.1.2.1.cmml" xref="S4.SS2.p2.1.m1.2.2.1.1.2">conditional-set</csymbol><ci id="S4.SS2.p2.1.m1.1.1a.cmml" xref="S4.SS2.p2.1.m1.1.1"><mtext class="ltx_mathvariant_bold" id="S4.SS2.p2.1.m1.1.1.cmml" xref="S4.SS2.p2.1.m1.1.1">x</mtext></ci><apply id="S4.SS2.p2.1.m1.2.2.1.1.1.cmml" xref="S4.SS2.p2.1.m1.2.2.1.1.1"><in id="S4.SS2.p2.1.m1.2.2.1.1.1.1.cmml" xref="S4.SS2.p2.1.m1.2.2.1.1.1.1"></in><ci id="S4.SS2.p2.1.m1.2.2.1.1.1.2a.cmml" xref="S4.SS2.p2.1.m1.2.2.1.1.1.2"><mtext class="ltx_mathvariant_bold" id="S4.SS2.p2.1.m1.2.2.1.1.1.2.cmml" xref="S4.SS2.p2.1.m1.2.2.1.1.1.2">x</mtext></ci><ci id="S4.SS2.p2.1.m1.2.2.1.1.1.3a.cmml" xref="S4.SS2.p2.1.m1.2.2.1.1.1.3"><mtext class="ltx_mathvariant_bold" id="S4.SS2.p2.1.m1.2.2.1.1.1.3.cmml" xref="S4.SS2.p2.1.m1.2.2.1.1.1.3">X</mtext></ci></apply></apply></apply><apply id="S4.SS2.p2.1.m1.2.2c.cmml" xref="S4.SS2.p2.1.m1.2.2"><in id="S4.SS2.p2.1.m1.2.2.5.cmml" xref="S4.SS2.p2.1.m1.2.2.5"></in><share href="https://arxiv.org/html/2407.21488v1#S4.SS2.p2.1.m1.2.2.1.cmml" id="S4.SS2.p2.1.m1.2.2d.cmml" xref="S4.SS2.p2.1.m1.2.2"></share><apply id="S4.SS2.p2.1.m1.2.2.6.cmml" xref="S4.SS2.p2.1.m1.2.2.6"><csymbol cd="ambiguous" id="S4.SS2.p2.1.m1.2.2.6.1.cmml" xref="S4.SS2.p2.1.m1.2.2.6">superscript</csymbol><ci id="S4.SS2.p2.1.m1.2.2.6.2.cmml" xref="S4.SS2.p2.1.m1.2.2.6.2">ℛ</ci><apply id="S4.SS2.p2.1.m1.2.2.6.3.cmml" xref="S4.SS2.p2.1.m1.2.2.6.3"><times id="S4.SS2.p2.1.m1.2.2.6.3.1.cmml" xref="S4.SS2.p2.1.m1.2.2.6.3.1"></times><ci id="S4.SS2.p2.1.m1.2.2.6.3.2.cmml" xref="S4.SS2.p2.1.m1.2.2.6.3.2">𝑁</ci><ci id="S4.SS2.p2.1.m1.2.2.6.3.3.cmml" xref="S4.SS2.p2.1.m1.2.2.6.3.3">𝑀</ci></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p2.1.m1.2c">\textbf{X}=\left\{\textbf{x}|\textbf{x}\in\textbf{X}\right\}\in\mathcal{R}^{N%
\times M}</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p2.1.m1.2d">X = { x | x ∈ X } ∈ caligraphic_R start_POSTSUPERSCRIPT italic_N × italic_M end_POSTSUPERSCRIPT</annotation></semantics></math>, <math alttext="N" class="ltx_Math" display="inline" id="S4.SS2.p2.2.m2.1"><semantics id="S4.SS2.p2.2.m2.1a"><mi id="S4.SS2.p2.2.m2.1.1" xref="S4.SS2.p2.2.m2.1.1.cmml">N</mi><annotation-xml encoding="MathML-Content" id="S4.SS2.p2.2.m2.1b"><ci id="S4.SS2.p2.2.m2.1.1.cmml" xref="S4.SS2.p2.2.m2.1.1">𝑁</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p2.2.m2.1c">N</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p2.2.m2.1d">italic_N</annotation></semantics></math> is the size of the dataset.
Now, we use the RQ to produce the semantic ID for <span class="ltx_text ltx_markedasmath ltx_font_bold" id="S4.SS2.p2.3.1">X</span>.</p>
</div>
<figure class="ltx_figure" id="S4.F4"><img alt="Refer to caption" class="ltx_graphics ltx_centering" id="S4.F4.g1" src="latex/figs/rq-4x12.pdf"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 4: </span>Hierarchical Residual Reduction and Dimensional Analysis Across Layers</figcaption>
</figure>
<figure class="ltx_table" id="S4.T1">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table">Table 1: </span>The performance of generative retrieval on E-commerce datasets with RQ3x12, i.e., <math alttext="L=3,M=2^{12}" class="ltx_Math" display="inline" id="S4.T1.2.m1.2"><semantics id="S4.T1.2.m1.2b"><mrow id="S4.T1.2.m1.2.2.2" xref="S4.T1.2.m1.2.2.3.cmml"><mrow id="S4.T1.2.m1.1.1.1.1" xref="S4.T1.2.m1.1.1.1.1.cmml"><mi id="S4.T1.2.m1.1.1.1.1.2" xref="S4.T1.2.m1.1.1.1.1.2.cmml">L</mi><mo id="S4.T1.2.m1.1.1.1.1.1" xref="S4.T1.2.m1.1.1.1.1.1.cmml">=</mo><mn id="S4.T1.2.m1.1.1.1.1.3" xref="S4.T1.2.m1.1.1.1.1.3.cmml">3</mn></mrow><mo id="S4.T1.2.m1.2.2.2.3" xref="S4.T1.2.m1.2.2.3a.cmml">,</mo><mrow id="S4.T1.2.m1.2.2.2.2" xref="S4.T1.2.m1.2.2.2.2.cmml"><mi id="S4.T1.2.m1.2.2.2.2.2" xref="S4.T1.2.m1.2.2.2.2.2.cmml">M</mi><mo id="S4.T1.2.m1.2.2.2.2.1" xref="S4.T1.2.m1.2.2.2.2.1.cmml">=</mo><msup id="S4.T1.2.m1.2.2.2.2.3" xref="S4.T1.2.m1.2.2.2.2.3.cmml"><mn id="S4.T1.2.m1.2.2.2.2.3.2" xref="S4.T1.2.m1.2.2.2.2.3.2.cmml">2</mn><mn id="S4.T1.2.m1.2.2.2.2.3.3" xref="S4.T1.2.m1.2.2.2.2.3.3.cmml">12</mn></msup></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.T1.2.m1.2c"><apply id="S4.T1.2.m1.2.2.3.cmml" xref="S4.T1.2.m1.2.2.2"><csymbol cd="ambiguous" id="S4.T1.2.m1.2.2.3a.cmml" xref="S4.T1.2.m1.2.2.2.3">formulae-sequence</csymbol><apply id="S4.T1.2.m1.1.1.1.1.cmml" xref="S4.T1.2.m1.1.1.1.1"><eq id="S4.T1.2.m1.1.1.1.1.1.cmml" xref="S4.T1.2.m1.1.1.1.1.1"></eq><ci id="S4.T1.2.m1.1.1.1.1.2.cmml" xref="S4.T1.2.m1.1.1.1.1.2">𝐿</ci><cn id="S4.T1.2.m1.1.1.1.1.3.cmml" type="integer" xref="S4.T1.2.m1.1.1.1.1.3">3</cn></apply><apply id="S4.T1.2.m1.2.2.2.2.cmml" xref="S4.T1.2.m1.2.2.2.2"><eq id="S4.T1.2.m1.2.2.2.2.1.cmml" xref="S4.T1.2.m1.2.2.2.2.1"></eq><ci id="S4.T1.2.m1.2.2.2.2.2.cmml" xref="S4.T1.2.m1.2.2.2.2.2">𝑀</ci><apply id="S4.T1.2.m1.2.2.2.2.3.cmml" xref="S4.T1.2.m1.2.2.2.2.3"><csymbol cd="ambiguous" id="S4.T1.2.m1.2.2.2.2.3.1.cmml" xref="S4.T1.2.m1.2.2.2.2.3">superscript</csymbol><cn id="S4.T1.2.m1.2.2.2.2.3.2.cmml" type="integer" xref="S4.T1.2.m1.2.2.2.2.3.2">2</cn><cn id="S4.T1.2.m1.2.2.2.2.3.3.cmml" type="integer" xref="S4.T1.2.m1.2.2.2.2.3.3">12</cn></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.T1.2.m1.2d">L=3,M=2^{12}</annotation><annotation encoding="application/x-llamapun" id="S4.T1.2.m1.2e">italic_L = 3 , italic_M = 2 start_POSTSUPERSCRIPT 12 end_POSTSUPERSCRIPT</annotation></semantics></math>. The head/tail token denotes the head/tail semantic ID in the second layer, respectively. </figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle" id="S4.T1.3">
<tbody class="ltx_tbody">
<tr class="ltx_tr" id="S4.T1.3.1.1">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r ltx_border_tt" id="S4.T1.3.1.1.1">Method</th>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S4.T1.3.1.1.2">Recall@1</td>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S4.T1.3.1.1.3">Recall@3</td>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S4.T1.3.1.1.4">Recall@5</td>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S4.T1.3.1.1.5">Recall@7</td>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S4.T1.3.1.1.6">Recall@10</td>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S4.T1.3.1.1.7">Recall@50</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.2.2">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S4.T1.3.2.2.1">LLaMA2-0.8B</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.2.2.2">0.2480</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.2.2.3">0.4080</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.2.2.4">0.4990</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.2.2.5">0.590</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.2.2.6">0.7080</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.2.2.7">0.7480</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.3.3">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r" id="S4.T1.3.3.3.1"><span class="ltx_text ltx_font_italic" id="S4.T1.3.3.3.1.1">Head Token</span></th>
<td class="ltx_td ltx_align_center" id="S4.T1.3.3.3.2">0.3617</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.3.3.3">0.5745</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.3.3.4">0.6894</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.3.3.5">0.7745</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.3.3.6">0.8894</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.3.3.7">0.9191</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.4.4">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r" id="S4.T1.3.4.4.1"><span class="ltx_text ltx_font_italic" id="S4.T1.3.4.4.1.1">Tail Token</span></th>
<td class="ltx_td ltx_align_center" id="S4.T1.3.4.4.2">0.2131</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.4.4.3">0.3569</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.4.4.4">0.4405</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.4.4.5">0.5333</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.4.4.6">0.6523</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.4.4.7">0.6954</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.5.5">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S4.T1.3.5.5.1">Qwen1.5-7B</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.5.5.2">0.2770</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.5.5.3">0.4720</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.5.5.4">0.5700</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.5.5.5">0.6600</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.5.5.6">0.7700</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.5.5.7">0.7930</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.6.6">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r" id="S4.T1.3.6.6.1"><span class="ltx_text ltx_font_italic" id="S4.T1.3.6.6.1.1">Head Token</span></th>
<td class="ltx_td ltx_align_center" id="S4.T1.3.6.6.2">0.3450</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.6.6.3">0.5970</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.6.6.4">0.7040</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.6.6.5">0.8020</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.6.6.6">0.8960</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.6.6.7">0.9120</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.7.7">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r" id="S4.T1.3.7.7.1"><span class="ltx_text ltx_font_italic" id="S4.T1.3.7.7.1.1">Tail Token</span></th>
<td class="ltx_td ltx_align_center" id="S4.T1.3.7.7.2">0.2470</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.7.7.3">0.4160</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.7.7.4">0.5100</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.7.7.5">0.5950</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.7.7.6">0.7190</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.7.7.7">0.7470</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.8.8">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S4.T1.3.8.8.1">Baichuan2-7B</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.8.8.2">0.2730</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.8.8.3">0.4900</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.8.8.4">0.5900</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.8.8.5">0.6760</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.8.8.6">0.7670</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.8.8.7">0.8040</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.9.9">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r" id="S4.T1.3.9.9.1"><span class="ltx_text ltx_font_italic" id="S4.T1.3.9.9.1.1">Head Token</span></th>
<td class="ltx_td ltx_align_center" id="S4.T1.3.9.9.2">0.3440</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.9.9.3">0.6000</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.9.9.4">0.7200</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.9.9.5">0.8140</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.9.9.6">0.9020</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.9.9.7">0. 9210</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.10.10">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r" id="S4.T1.3.10.10.1"><span class="ltx_text ltx_font_italic" id="S4.T1.3.10.10.1.1">Tail Token</span></th>
<td class="ltx_td ltx_align_center" id="S4.T1.3.10.10.2">0.2480</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.10.10.3">0.4360</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.10.10.4">0.5250</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.10.10.5">0.6110</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.10.10.6">0.7180</td>
<td class="ltx_td ltx_align_center" id="S4.T1.3.10.10.7">0.7540</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.11.11">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S4.T1.3.11.11.1">Exchange Layer 1-2</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.11.11.2">0.2390</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.11.11.3">0.4190</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.11.11.4">0.5100</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.11.11.5">0.6070</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.11.11.6">0.7150</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T1.3.11.11.7">0.7540</td>
</tr>
<tr class="ltx_tr" id="S4.T1.3.12.12">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_bb ltx_border_r" id="S4.T1.3.12.12.1">+ Given Layer 1</th>
<td class="ltx_td ltx_align_center ltx_border_bb" id="S4.T1.3.12.12.2">0.6600</td>
<td class="ltx_td ltx_align_center ltx_border_bb" id="S4.T1.3.12.12.3">0.8240</td>
<td class="ltx_td ltx_align_center ltx_border_bb" id="S4.T1.3.12.12.4">0.8650</td>
<td class="ltx_td ltx_align_center ltx_border_bb" id="S4.T1.3.12.12.5">0.8910</td>
<td class="ltx_td ltx_align_center ltx_border_bb" id="S4.T1.3.12.12.6">0.9160</td>
<td class="ltx_td ltx_align_center ltx_border_bb" id="S4.T1.3.12.12.7">0.9190</td>
</tr>
</tbody>
</table>
</figure>
<div class="ltx_para" id="S4.SS2.p3">
<p class="ltx_p" id="S4.SS2.p3.5">In the first layer, all candidate’s points are divided into <math alttext="M" class="ltx_Math" display="inline" id="S4.SS2.p3.1.m1.1"><semantics id="S4.SS2.p3.1.m1.1a"><mi id="S4.SS2.p3.1.m1.1.1" xref="S4.SS2.p3.1.m1.1.1.cmml">M</mi><annotation-xml encoding="MathML-Content" id="S4.SS2.p3.1.m1.1b"><ci id="S4.SS2.p3.1.m1.1.1.cmml" xref="S4.SS2.p3.1.m1.1.1">𝑀</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p3.1.m1.1c">M</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p3.1.m1.1d">italic_M</annotation></semantics></math> different cluster buckets. Each cluster bucket contains <math alttext="n_{m}" class="ltx_Math" display="inline" id="S4.SS2.p3.2.m2.1"><semantics id="S4.SS2.p3.2.m2.1a"><msub id="S4.SS2.p3.2.m2.1.1" xref="S4.SS2.p3.2.m2.1.1.cmml"><mi id="S4.SS2.p3.2.m2.1.1.2" xref="S4.SS2.p3.2.m2.1.1.2.cmml">n</mi><mi id="S4.SS2.p3.2.m2.1.1.3" xref="S4.SS2.p3.2.m2.1.1.3.cmml">m</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS2.p3.2.m2.1b"><apply id="S4.SS2.p3.2.m2.1.1.cmml" xref="S4.SS2.p3.2.m2.1.1"><csymbol cd="ambiguous" id="S4.SS2.p3.2.m2.1.1.1.cmml" xref="S4.SS2.p3.2.m2.1.1">subscript</csymbol><ci id="S4.SS2.p3.2.m2.1.1.2.cmml" xref="S4.SS2.p3.2.m2.1.1.2">𝑛</ci><ci id="S4.SS2.p3.2.m2.1.1.3.cmml" xref="S4.SS2.p3.2.m2.1.1.3">𝑚</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p3.2.m2.1c">n_{m}</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p3.2.m2.1d">italic_n start_POSTSUBSCRIPT italic_m end_POSTSUBSCRIPT</annotation></semantics></math> data points and has a radius of <math alttext="e_{m}" class="ltx_Math" display="inline" id="S4.SS2.p3.3.m3.1"><semantics id="S4.SS2.p3.3.m3.1a"><msub id="S4.SS2.p3.3.m3.1.1" xref="S4.SS2.p3.3.m3.1.1.cmml"><mi id="S4.SS2.p3.3.m3.1.1.2" xref="S4.SS2.p3.3.m3.1.1.2.cmml">e</mi><mi id="S4.SS2.p3.3.m3.1.1.3" xref="S4.SS2.p3.3.m3.1.1.3.cmml">m</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS2.p3.3.m3.1b"><apply id="S4.SS2.p3.3.m3.1.1.cmml" xref="S4.SS2.p3.3.m3.1.1"><csymbol cd="ambiguous" id="S4.SS2.p3.3.m3.1.1.1.cmml" xref="S4.SS2.p3.3.m3.1.1">subscript</csymbol><ci id="S4.SS2.p3.3.m3.1.1.2.cmml" xref="S4.SS2.p3.3.m3.1.1.2">𝑒</ci><ci id="S4.SS2.p3.3.m3.1.1.3.cmml" xref="S4.SS2.p3.3.m3.1.1.3">𝑚</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p3.3.m3.1c">e_{m}</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p3.3.m3.1d">italic_e start_POSTSUBSCRIPT italic_m end_POSTSUBSCRIPT</annotation></semantics></math>.
For the uniform distribution, <math alttext="n_{m}=N/M" class="ltx_Math" display="inline" id="S4.SS2.p3.4.m4.1"><semantics id="S4.SS2.p3.4.m4.1a"><mrow id="S4.SS2.p3.4.m4.1.1" xref="S4.SS2.p3.4.m4.1.1.cmml"><msub id="S4.SS2.p3.4.m4.1.1.2" xref="S4.SS2.p3.4.m4.1.1.2.cmml"><mi id="S4.SS2.p3.4.m4.1.1.2.2" xref="S4.SS2.p3.4.m4.1.1.2.2.cmml">n</mi><mi id="S4.SS2.p3.4.m4.1.1.2.3" xref="S4.SS2.p3.4.m4.1.1.2.3.cmml">m</mi></msub><mo id="S4.SS2.p3.4.m4.1.1.1" xref="S4.SS2.p3.4.m4.1.1.1.cmml">=</mo><mrow id="S4.SS2.p3.4.m4.1.1.3" xref="S4.SS2.p3.4.m4.1.1.3.cmml"><mi id="S4.SS2.p3.4.m4.1.1.3.2" xref="S4.SS2.p3.4.m4.1.1.3.2.cmml">N</mi><mo id="S4.SS2.p3.4.m4.1.1.3.1" xref="S4.SS2.p3.4.m4.1.1.3.1.cmml">/</mo><mi id="S4.SS2.p3.4.m4.1.1.3.3" xref="S4.SS2.p3.4.m4.1.1.3.3.cmml">M</mi></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.SS2.p3.4.m4.1b"><apply id="S4.SS2.p3.4.m4.1.1.cmml" xref="S4.SS2.p3.4.m4.1.1"><eq id="S4.SS2.p3.4.m4.1.1.1.cmml" xref="S4.SS2.p3.4.m4.1.1.1"></eq><apply id="S4.SS2.p3.4.m4.1.1.2.cmml" xref="S4.SS2.p3.4.m4.1.1.2"><csymbol cd="ambiguous" id="S4.SS2.p3.4.m4.1.1.2.1.cmml" xref="S4.SS2.p3.4.m4.1.1.2">subscript</csymbol><ci id="S4.SS2.p3.4.m4.1.1.2.2.cmml" xref="S4.SS2.p3.4.m4.1.1.2.2">𝑛</ci><ci id="S4.SS2.p3.4.m4.1.1.2.3.cmml" xref="S4.SS2.p3.4.m4.1.1.2.3">𝑚</ci></apply><apply id="S4.SS2.p3.4.m4.1.1.3.cmml" xref="S4.SS2.p3.4.m4.1.1.3"><divide id="S4.SS2.p3.4.m4.1.1.3.1.cmml" xref="S4.SS2.p3.4.m4.1.1.3.1"></divide><ci id="S4.SS2.p3.4.m4.1.1.3.2.cmml" xref="S4.SS2.p3.4.m4.1.1.3.2">𝑁</ci><ci id="S4.SS2.p3.4.m4.1.1.3.3.cmml" xref="S4.SS2.p3.4.m4.1.1.3.3">𝑀</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p3.4.m4.1c">n_{m}=N/M</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p3.4.m4.1d">italic_n start_POSTSUBSCRIPT italic_m end_POSTSUBSCRIPT = italic_N / italic_M</annotation></semantics></math>, and <math alttext="e_{1}=e_{2}=\dots=e_{m}" class="ltx_Math" display="inline" id="S4.SS2.p3.5.m5.1"><semantics id="S4.SS2.p3.5.m5.1a"><mrow id="S4.SS2.p3.5.m5.1.1" xref="S4.SS2.p3.5.m5.1.1.cmml"><msub id="S4.SS2.p3.5.m5.1.1.2" xref="S4.SS2.p3.5.m5.1.1.2.cmml"><mi id="S4.SS2.p3.5.m5.1.1.2.2" xref="S4.SS2.p3.5.m5.1.1.2.2.cmml">e</mi><mn id="S4.SS2.p3.5.m5.1.1.2.3" xref="S4.SS2.p3.5.m5.1.1.2.3.cmml">1</mn></msub><mo id="S4.SS2.p3.5.m5.1.1.3" xref="S4.SS2.p3.5.m5.1.1.3.cmml">=</mo><msub id="S4.SS2.p3.5.m5.1.1.4" xref="S4.SS2.p3.5.m5.1.1.4.cmml"><mi id="S4.SS2.p3.5.m5.1.1.4.2" xref="S4.SS2.p3.5.m5.1.1.4.2.cmml">e</mi><mn id="S4.SS2.p3.5.m5.1.1.4.3" xref="S4.SS2.p3.5.m5.1.1.4.3.cmml">2</mn></msub><mo id="S4.SS2.p3.5.m5.1.1.5" xref="S4.SS2.p3.5.m5.1.1.5.cmml">=</mo><mi id="S4.SS2.p3.5.m5.1.1.6" mathvariant="normal" xref="S4.SS2.p3.5.m5.1.1.6.cmml">…</mi><mo id="S4.SS2.p3.5.m5.1.1.7" xref="S4.SS2.p3.5.m5.1.1.7.cmml">=</mo><msub id="S4.SS2.p3.5.m5.1.1.8" xref="S4.SS2.p3.5.m5.1.1.8.cmml"><mi id="S4.SS2.p3.5.m5.1.1.8.2" xref="S4.SS2.p3.5.m5.1.1.8.2.cmml">e</mi><mi id="S4.SS2.p3.5.m5.1.1.8.3" xref="S4.SS2.p3.5.m5.1.1.8.3.cmml">m</mi></msub></mrow><annotation-xml encoding="MathML-Content" id="S4.SS2.p3.5.m5.1b"><apply id="S4.SS2.p3.5.m5.1.1.cmml" xref="S4.SS2.p3.5.m5.1.1"><and id="S4.SS2.p3.5.m5.1.1a.cmml" xref="S4.SS2.p3.5.m5.1.1"></and><apply id="S4.SS2.p3.5.m5.1.1b.cmml" xref="S4.SS2.p3.5.m5.1.1"><eq id="S4.SS2.p3.5.m5.1.1.3.cmml" xref="S4.SS2.p3.5.m5.1.1.3"></eq><apply id="S4.SS2.p3.5.m5.1.1.2.cmml" xref="S4.SS2.p3.5.m5.1.1.2"><csymbol cd="ambiguous" id="S4.SS2.p3.5.m5.1.1.2.1.cmml" xref="S4.SS2.p3.5.m5.1.1.2">subscript</csymbol><ci id="S4.SS2.p3.5.m5.1.1.2.2.cmml" xref="S4.SS2.p3.5.m5.1.1.2.2">𝑒</ci><cn id="S4.SS2.p3.5.m5.1.1.2.3.cmml" type="integer" xref="S4.SS2.p3.5.m5.1.1.2.3">1</cn></apply><apply id="S4.SS2.p3.5.m5.1.1.4.cmml" xref="S4.SS2.p3.5.m5.1.1.4"><csymbol cd="ambiguous" id="S4.SS2.p3.5.m5.1.1.4.1.cmml" xref="S4.SS2.p3.5.m5.1.1.4">subscript</csymbol><ci id="S4.SS2.p3.5.m5.1.1.4.2.cmml" xref="S4.SS2.p3.5.m5.1.1.4.2">𝑒</ci><cn id="S4.SS2.p3.5.m5.1.1.4.3.cmml" type="integer" xref="S4.SS2.p3.5.m5.1.1.4.3">2</cn></apply></apply><apply id="S4.SS2.p3.5.m5.1.1c.cmml" xref="S4.SS2.p3.5.m5.1.1"><eq id="S4.SS2.p3.5.m5.1.1.5.cmml" xref="S4.SS2.p3.5.m5.1.1.5"></eq><share href="https://arxiv.org/html/2407.21488v1#S4.SS2.p3.5.m5.1.1.4.cmml" id="S4.SS2.p3.5.m5.1.1d.cmml" xref="S4.SS2.p3.5.m5.1.1"></share><ci id="S4.SS2.p3.5.m5.1.1.6.cmml" xref="S4.SS2.p3.5.m5.1.1.6">…</ci></apply><apply id="S4.SS2.p3.5.m5.1.1e.cmml" xref="S4.SS2.p3.5.m5.1.1"><eq id="S4.SS2.p3.5.m5.1.1.7.cmml" xref="S4.SS2.p3.5.m5.1.1.7"></eq><share href="https://arxiv.org/html/2407.21488v1#S4.SS2.p3.5.m5.1.1.6.cmml" id="S4.SS2.p3.5.m5.1.1f.cmml" xref="S4.SS2.p3.5.m5.1.1"></share><apply id="S4.SS2.p3.5.m5.1.1.8.cmml" xref="S4.SS2.p3.5.m5.1.1.8"><csymbol cd="ambiguous" id="S4.SS2.p3.5.m5.1.1.8.1.cmml" xref="S4.SS2.p3.5.m5.1.1.8">subscript</csymbol><ci id="S4.SS2.p3.5.m5.1.1.8.2.cmml" xref="S4.SS2.p3.5.m5.1.1.8.2">𝑒</ci><ci id="S4.SS2.p3.5.m5.1.1.8.3.cmml" xref="S4.SS2.p3.5.m5.1.1.8.3">𝑚</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p3.5.m5.1c">e_{1}=e_{2}=\dots=e_{m}</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p3.5.m5.1d">italic_e start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT = italic_e start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT = … = italic_e start_POSTSUBSCRIPT italic_m end_POSTSUBSCRIPT</annotation></semantics></math>.
Therefore, the in-degree of all tokens in this layer are equal, i.e., uniform distribution.</p>
</div>
<div class="ltx_para" id="S4.SS2.p4">
<p class="ltx_p" id="S4.SS2.p4.3">In the second layer, all input embedding is <math alttext="\textbf{X}^{1}" class="ltx_Math" display="inline" id="S4.SS2.p4.1.m1.1"><semantics id="S4.SS2.p4.1.m1.1a"><msup id="S4.SS2.p4.1.m1.1.1" xref="S4.SS2.p4.1.m1.1.1.cmml"><mtext class="ltx_mathvariant_bold" id="S4.SS2.p4.1.m1.1.1.2" xref="S4.SS2.p4.1.m1.1.1.2a.cmml">X</mtext><mn id="S4.SS2.p4.1.m1.1.1.3" xref="S4.SS2.p4.1.m1.1.1.3.cmml">1</mn></msup><annotation-xml encoding="MathML-Content" id="S4.SS2.p4.1.m1.1b"><apply id="S4.SS2.p4.1.m1.1.1.cmml" xref="S4.SS2.p4.1.m1.1.1"><csymbol cd="ambiguous" id="S4.SS2.p4.1.m1.1.1.1.cmml" xref="S4.SS2.p4.1.m1.1.1">superscript</csymbol><ci id="S4.SS2.p4.1.m1.1.1.2a.cmml" xref="S4.SS2.p4.1.m1.1.1.2"><mtext class="ltx_mathvariant_bold" id="S4.SS2.p4.1.m1.1.1.2.cmml" xref="S4.SS2.p4.1.m1.1.1.2">X</mtext></ci><cn id="S4.SS2.p4.1.m1.1.1.3.cmml" type="integer" xref="S4.SS2.p4.1.m1.1.1.3">1</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p4.1.m1.1c">\textbf{X}^{1}</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p4.1.m1.1d">X start_POSTSUPERSCRIPT 1 end_POSTSUPERSCRIPT</annotation></semantics></math>, the residual of the first layer. Due to the difference in the magnitude of residual values, the input distribution in this layer is non-uniform. There are a smaller number of points with smaller magnitudes (points near the cluster centers in each bucket from the previous layer), which is equal to <math alttext="n_{m}*M*\rho=N*\rho" class="ltx_Math" display="inline" id="S4.SS2.p4.2.m2.1"><semantics id="S4.SS2.p4.2.m2.1a"><mrow id="S4.SS2.p4.2.m2.1.1" xref="S4.SS2.p4.2.m2.1.1.cmml"><mrow id="S4.SS2.p4.2.m2.1.1.2" xref="S4.SS2.p4.2.m2.1.1.2.cmml"><msub id="S4.SS2.p4.2.m2.1.1.2.2" xref="S4.SS2.p4.2.m2.1.1.2.2.cmml"><mi id="S4.SS2.p4.2.m2.1.1.2.2.2" xref="S4.SS2.p4.2.m2.1.1.2.2.2.cmml">n</mi><mi id="S4.SS2.p4.2.m2.1.1.2.2.3" xref="S4.SS2.p4.2.m2.1.1.2.2.3.cmml">m</mi></msub><mo id="S4.SS2.p4.2.m2.1.1.2.1" lspace="0.222em" rspace="0.222em" xref="S4.SS2.p4.2.m2.1.1.2.1.cmml">∗</mo><mi id="S4.SS2.p4.2.m2.1.1.2.3" xref="S4.SS2.p4.2.m2.1.1.2.3.cmml">M</mi><mo id="S4.SS2.p4.2.m2.1.1.2.1a" lspace="0.222em" rspace="0.222em" xref="S4.SS2.p4.2.m2.1.1.2.1.cmml">∗</mo><mi id="S4.SS2.p4.2.m2.1.1.2.4" xref="S4.SS2.p4.2.m2.1.1.2.4.cmml">ρ</mi></mrow><mo id="S4.SS2.p4.2.m2.1.1.1" xref="S4.SS2.p4.2.m2.1.1.1.cmml">=</mo><mrow id="S4.SS2.p4.2.m2.1.1.3" xref="S4.SS2.p4.2.m2.1.1.3.cmml"><mi id="S4.SS2.p4.2.m2.1.1.3.2" xref="S4.SS2.p4.2.m2.1.1.3.2.cmml">N</mi><mo id="S4.SS2.p4.2.m2.1.1.3.1" lspace="0.222em" rspace="0.222em" xref="S4.SS2.p4.2.m2.1.1.3.1.cmml">∗</mo><mi id="S4.SS2.p4.2.m2.1.1.3.3" xref="S4.SS2.p4.2.m2.1.1.3.3.cmml">ρ</mi></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.SS2.p4.2.m2.1b"><apply id="S4.SS2.p4.2.m2.1.1.cmml" xref="S4.SS2.p4.2.m2.1.1"><eq id="S4.SS2.p4.2.m2.1.1.1.cmml" xref="S4.SS2.p4.2.m2.1.1.1"></eq><apply id="S4.SS2.p4.2.m2.1.1.2.cmml" xref="S4.SS2.p4.2.m2.1.1.2"><times id="S4.SS2.p4.2.m2.1.1.2.1.cmml" xref="S4.SS2.p4.2.m2.1.1.2.1"></times><apply id="S4.SS2.p4.2.m2.1.1.2.2.cmml" xref="S4.SS2.p4.2.m2.1.1.2.2"><csymbol cd="ambiguous" id="S4.SS2.p4.2.m2.1.1.2.2.1.cmml" xref="S4.SS2.p4.2.m2.1.1.2.2">subscript</csymbol><ci id="S4.SS2.p4.2.m2.1.1.2.2.2.cmml" xref="S4.SS2.p4.2.m2.1.1.2.2.2">𝑛</ci><ci id="S4.SS2.p4.2.m2.1.1.2.2.3.cmml" xref="S4.SS2.p4.2.m2.1.1.2.2.3">𝑚</ci></apply><ci id="S4.SS2.p4.2.m2.1.1.2.3.cmml" xref="S4.SS2.p4.2.m2.1.1.2.3">𝑀</ci><ci id="S4.SS2.p4.2.m2.1.1.2.4.cmml" xref="S4.SS2.p4.2.m2.1.1.2.4">𝜌</ci></apply><apply id="S4.SS2.p4.2.m2.1.1.3.cmml" xref="S4.SS2.p4.2.m2.1.1.3"><times id="S4.SS2.p4.2.m2.1.1.3.1.cmml" xref="S4.SS2.p4.2.m2.1.1.3.1"></times><ci id="S4.SS2.p4.2.m2.1.1.3.2.cmml" xref="S4.SS2.p4.2.m2.1.1.3.2">𝑁</ci><ci id="S4.SS2.p4.2.m2.1.1.3.3.cmml" xref="S4.SS2.p4.2.m2.1.1.3.3">𝜌</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p4.2.m2.1c">n_{m}*M*\rho=N*\rho</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p4.2.m2.1d">italic_n start_POSTSUBSCRIPT italic_m end_POSTSUBSCRIPT ∗ italic_M ∗ italic_ρ = italic_N ∗ italic_ρ</annotation></semantics></math>, <math alttext="\rho" class="ltx_Math" display="inline" id="S4.SS2.p4.3.m3.1"><semantics id="S4.SS2.p4.3.m3.1a"><mi id="S4.SS2.p4.3.m3.1.1" xref="S4.SS2.p4.3.m3.1.1.cmml">ρ</mi><annotation-xml encoding="MathML-Content" id="S4.SS2.p4.3.m3.1b"><ci id="S4.SS2.p4.3.m3.1.1.cmml" xref="S4.SS2.p4.3.m3.1.1">𝜌</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p4.3.m3.1c">\rho</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p4.3.m3.1d">italic_ρ</annotation></semantics></math> is the ratio. At the same time, there are many points with larger magnitudes, which are considered as outliers. To reduce the clustering loss, the clustering process in this layer focuses on these outliers. As a result, the points with smaller magnitudes will occupy fewer cluster centers, while the outliers will either occupy individual cluster centers or multiple cluster centers. Therefore, this layer’s semantic IDs will form large routing nodes, exhibiting a long-tail phenomenon, which is also demonstrated in the second layer of Figure <a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S4.F4" title="Figure 4 ‣ 4.2 Analysis of Residual Quantization ‣ 4 Problem of GR based on RQ ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_tag">4</span></a>.</p>
</div>
<div class="ltx_para" id="S4.SS2.p5">
<p class="ltx_p" id="S4.SS2.p5.1">In the third layer, all input point magnitudes become consistent again and relatively uniform. Therefore, the code distribution in this layer is similar to the first layer, with a uniform distribution. As a result, it can be directly observed that the large routing nodes from the second layer diverge into multiple smaller nodes in the third layer, creating a one-to-many situation, as shown in the third layer of Figure <a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S4.F4" title="Figure 4 ‣ 4.2 Analysis of Residual Quantization ‣ 4 Problem of GR based on RQ ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_tag">4</span></a>. At the same time, if the residuals in the second layer tend towards zero, there will still be some clustering in the third layer. However, since all magnitudes are very small at this point, the impact of the clustering effect is limited.</p>
</div>
<div class="ltx_para" id="S4.SS2.p6">
<p class="ltx_p" id="S4.SS2.p6.1">As we continue to iterate through the layers, this phenomenon of non-uniform distribution and long-tail clustering followed by uniform distribution will alternate. However, as the number of layers increases, the residuals become smaller (refer to layer 4 of Figure <a class="ltx_ref" href="https://arxiv.org/html/2407.21488v1#S4.F4" title="Figure 4 ‣ 4.2 Analysis of Residual Quantization ‣ 4 Problem of GR based on RQ ‣ Breaking the Hourglass Phenomenon of Semantic ID in Residual Quantization: Enhancing the Upper Bound of Generative Search"><span class="ltx_text ltx_ref_tag">4</span></a>) and the clustering effect weakens, so it can be ignored. Ultimately, this leads to the formation of a hourglass-like structure, where the input data is first compressed into a smaller number of clusters, then expands back out into a larger number of clusters, and finally converges to a uniform distribution. Upon the completion of SID construction, the influence of the RQ quantization method, coupled with the dominance of head tokens in the intermediate layer, naturally leads to the sparsity of paths.</p>
</div>
<div class="ltx_para" id="S4.SS2.p7">
<p class="ltx_p" id="S4.SS2.p7.1">This hourglass-like structure is a characteristic feature of the RQ-VAE architecture. For the un-uniform distribution, such as long-tail distribution， the residual distribution becomes even more uneven, resulting in a more severe phenomenon.</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS3">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.3 </span>Impact on the GR</h3>
<figure class="ltx_table" id="S4.T2">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table">Table 2: </span>The performance of generative retrieval on E-commerce based on RQ3x12.</figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle" id="S4.T2.1">
<tbody class="ltx_tbody">
<tr class="ltx_tr" id="S4.T2.1.1.1">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r ltx_border_tt" id="S4.T2.1.1.1.1">Method</th>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S4.T2.1.1.1.2">Recall@1</td>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S4.T2.1.1.1.3">Recall@3</td>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S4.T2.1.1.1.4">Recall@5</td>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S4.T2.1.1.1.5">Recall@7</td>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S4.T2.1.1.1.6">Recall@10</td>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S4.T2.1.1.1.7">Recall@50</td>
</tr>
<tr class="ltx_tr" id="S4.T2.1.2.2">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S4.T2.1.2.2.1">LLaMA2-0.8B</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.2.2.2">0.2480</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.2.2.3">0.4080</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.2.2.4">0.4990</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.2.2.5">0.590</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.2.2.6">0.7080</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.2.2.7">0.7480</td>
</tr>
<tr class="ltx_tr" id="S4.T2.1.3.3">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S4.T2.1.3.3.1">Focal-loss<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">lin2017focal</span></cite>
</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.3.3.2">0.2330</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.3.3.3">0.4190</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.3.3.4">0.4950</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.3.3.5">0.6130</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.3.3.6">0.7220</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.3.3.7">0.7650</td>
</tr>
<tr class="ltx_tr" id="S4.T2.1.4.4">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r" id="S4.T2.1.4.4.1">Mile Loss<cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">su2024mile</span></cite>
</th>
<td class="ltx_td ltx_align_center" id="S4.T2.1.4.4.2">0.2370</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.4.4.3">0.4130</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.4.4.4">0.5010</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.4.4.5">0.6010</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.4.4.6">0.7180</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.4.4.7">0.7510</td>
</tr>
<tr class="ltx_tr" id="S4.T2.1.5.5">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S4.T2.1.5.5.1">Remove 2-th layer</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.5.5.2">0.3090</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.5.5.3">0.4310</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.5.5.4">0.4970</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.5.5.5">0.5640</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.5.5.6">0.6580</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S4.T2.1.5.5.7">0.7020</td>
</tr>
<tr class="ltx_tr" id="S4.T2.1.6.6">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r" id="S4.T2.1.6.6.1">Remove 2-th layer top@20</th>
<td class="ltx_td ltx_align_center" id="S4.T2.1.6.6.2">0.2500</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.6.6.3">0.4270</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.6.6.4">0.5130</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.6.6.5">0.6120</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.6.6.6">0.7250</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.6.6.7">0.7580</td>
</tr>
<tr class="ltx_tr" id="S4.T2.1.7.7">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r" id="S4.T2.1.7.7.1">Remove 2-th layer top@200</th>
<td class="ltx_td ltx_align_center" id="S4.T2.1.7.7.2">0.3190</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.7.7.3">0.4740</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.7.7.4">0.5600</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.7.7.5">0.6550</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.7.7.6">0.7450</td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.7.7.7">0.7760</td>
</tr>
<tr class="ltx_tr" id="S4.T2.1.8.8">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_r" id="S4.T2.1.8.8.1">Remove 2-th layer top@400</th>
<td class="ltx_td ltx_align_center" id="S4.T2.1.8.8.2"><span class="ltx_text ltx_font_bold" id="S4.T2.1.8.8.2.1">0.3340</span></td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.8.8.3"><span class="ltx_text ltx_framed ltx_framed_underline" id="S4.T2.1.8.8.3.1">0.5070</span></td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.8.8.4"><span class="ltx_text ltx_font_bold" id="S4.T2.1.8.8.4.1">0.5950</span></td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.8.8.5"><span class="ltx_text ltx_font_bold" id="S4.T2.1.8.8.5.1">0.6800</span></td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.8.8.6"><span class="ltx_text ltx_font_bold" id="S4.T2.1.8.8.6.1">0.7760</span></td>
<td class="ltx_td ltx_align_center" id="S4.T2.1.8.8.7"><span class="ltx_text ltx_framed ltx_framed_underline" id="S4.T2.1.8.8.7.1">0.7990</span></td>
</tr>
<tr class="ltx_tr" id="S4.T2.1.9.9">
<th class="ltx_td ltx_align_center ltx_th ltx_th_row ltx_border_bb ltx_border_r" id="S4.T2.1.9.9.1">Remove 2-th layer top@600</th>
<td class="ltx_td ltx_align_center ltx_border_bb" id="S4.T2.1.9.9.2"><span class="ltx_text ltx_framed ltx_framed_underline" id="S4.T2.1.9.9.2.1">0.3320</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb" id="S4.T2.1.9.9.3"><span class="ltx_text ltx_font_bold" id="S4.T2.1.9.9.3.1">0.5080</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb" id="S4.T2.1.9.9.4"><span class="ltx_text ltx_framed ltx_framed_underline" id="S4.T2.1.9.9.4.1">0.5850</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb" id="S4.T2.1.9.9.5"><span class="ltx_text ltx_framed ltx_framed_underline" id="S4.T2.1.9.9.5.1">0.6720</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb" id="S4.T2.1.9.9.6"><span class="ltx_text ltx_framed ltx_framed_underline" id="S4.T2.1.9.9.6.1">0.7700</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb" id="S4.T2.1.9.9.7"><span class="ltx_text ltx_font_bold" id="S4.T2.1.9.9.7.1">0.8010</span></td>
</tr>
</tbody>
</table>
</figure>
<div class="ltx_para" id="S4.SS3.p1">
<p class="ltx_p" id="S4.SS3.p1.1">In the previous section, we analyzed the evident long-tail distribution in the second layer of Semantic ID, indicating one-to-many and many-to-one situations. This phenomenon significantly impacts the generation of downstream tasks such as Generative Retrieval (GR).</p>
</div>
<div class="ltx_para" id="S4.SS3.p2">
<p class="ltx_p" id="S4.SS3.p2.1">To demonstrate this impacts, we conducted various experiments. First, we altered the distribution of Semantic ID by interacting with the first and second layers. On this basis, we only predicted the tokens of the second and third layers while keeping the tokens of the first layer fixed.</p>
</div>
<div class="ltx_para" id="S4.SS3.p3">
<p class="ltx_p" id="S4.SS3.p3.1">During the evaluation process, we divided the test set into two groups based on the distribution of second-layer tokens: the head token test set and the tail token test set. As shown in the table, the performance of the head token test set significantly improved, whereas the performance of the tail token test set was notably poorer. This performance disparity can be attributed to the previously analyzed path sparsity and long-tail distribution of tokens, leading to biased results. This phenomenon has been observed across models of different scales, such as BaiChuan2 and Qwen, highlighting the widespread impact of long-tail token distribution and path sparsity on model performance.</p>
</div>
<div class="ltx_para" id="S4.SS3.p4">
<p class="ltx_p" id="S4.SS3.p4.1">To further investigate the impact of the hourglass phenomenon on model performance, we conducted a critical experiment where we swapped the tokens of the first and second layers and used the first token of the swapped sequence as input. This approach aimed to mitigate the effects of the long-tail distribution. The results demonstrated a significant improvement in performance. This finding clearly indicates that the hourglass phenomenon has a substantial negative impact on model performance. Through this method, we not only confirmed the existence of the hourglass effect but also elucidated its specific impact on model performance, thereby providing a robust basis for future model optimization.
</p>
</div>
</section>
</section>
<section class="ltx_section" id="S5">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">5 </span>Methods and Experiments</h2>
<div class="ltx_para" id="S5.p1">
<p class="ltx_p" id="S5.p1.1">To alleviate the hourglass effect, we propose two simple yet effective methods.</p>
</div>
<section class="ltx_subsection" id="S5.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.1 </span>Heuristic Method</h3>
<div class="ltx_para" id="S5.SS1.p1">
<p class="ltx_p" id="S5.SS1.p1.2">One heuristic approach is to directly remove the second layer, eliminating the impact of the long tail. However, this can lead to insufficient spatial capacity, as the number of possible configurations in the second layer (<math alttext="M^{L}" class="ltx_Math" display="inline" id="S5.SS1.p1.1.m1.1"><semantics id="S5.SS1.p1.1.m1.1a"><msup id="S5.SS1.p1.1.m1.1.1" xref="S5.SS1.p1.1.m1.1.1.cmml"><mi id="S5.SS1.p1.1.m1.1.1.2" xref="S5.SS1.p1.1.m1.1.1.2.cmml">M</mi><mi id="S5.SS1.p1.1.m1.1.1.3" xref="S5.SS1.p1.1.m1.1.1.3.cmml">L</mi></msup><annotation-xml encoding="MathML-Content" id="S5.SS1.p1.1.m1.1b"><apply id="S5.SS1.p1.1.m1.1.1.cmml" xref="S5.SS1.p1.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS1.p1.1.m1.1.1.1.cmml" xref="S5.SS1.p1.1.m1.1.1">superscript</csymbol><ci id="S5.SS1.p1.1.m1.1.1.2.cmml" xref="S5.SS1.p1.1.m1.1.1.2">𝑀</ci><ci id="S5.SS1.p1.1.m1.1.1.3.cmml" xref="S5.SS1.p1.1.m1.1.1.3">𝐿</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS1.p1.1.m1.1c">M^{L}</annotation><annotation encoding="application/x-llamapun" id="S5.SS1.p1.1.m1.1d">italic_M start_POSTSUPERSCRIPT italic_L end_POSTSUPERSCRIPT</annotation></semantics></math>) is greater than that in the first layer (<math alttext="M^{L-1}" class="ltx_Math" display="inline" id="S5.SS1.p1.2.m2.1"><semantics id="S5.SS1.p1.2.m2.1a"><msup id="S5.SS1.p1.2.m2.1.1" xref="S5.SS1.p1.2.m2.1.1.cmml"><mi id="S5.SS1.p1.2.m2.1.1.2" xref="S5.SS1.p1.2.m2.1.1.2.cmml">M</mi><mrow id="S5.SS1.p1.2.m2.1.1.3" xref="S5.SS1.p1.2.m2.1.1.3.cmml"><mi id="S5.SS1.p1.2.m2.1.1.3.2" xref="S5.SS1.p1.2.m2.1.1.3.2.cmml">L</mi><mo id="S5.SS1.p1.2.m2.1.1.3.1" xref="S5.SS1.p1.2.m2.1.1.3.1.cmml">−</mo><mn id="S5.SS1.p1.2.m2.1.1.3.3" xref="S5.SS1.p1.2.m2.1.1.3.3.cmml">1</mn></mrow></msup><annotation-xml encoding="MathML-Content" id="S5.SS1.p1.2.m2.1b"><apply id="S5.SS1.p1.2.m2.1.1.cmml" xref="S5.SS1.p1.2.m2.1.1"><csymbol cd="ambiguous" id="S5.SS1.p1.2.m2.1.1.1.cmml" xref="S5.SS1.p1.2.m2.1.1">superscript</csymbol><ci id="S5.SS1.p1.2.m2.1.1.2.cmml" xref="S5.SS1.p1.2.m2.1.1.2">𝑀</ci><apply id="S5.SS1.p1.2.m2.1.1.3.cmml" xref="S5.SS1.p1.2.m2.1.1.3"><minus id="S5.SS1.p1.2.m2.1.1.3.1.cmml" xref="S5.SS1.p1.2.m2.1.1.3.1"></minus><ci id="S5.SS1.p1.2.m2.1.1.3.2.cmml" xref="S5.SS1.p1.2.m2.1.1.3.2">𝐿</ci><cn id="S5.SS1.p1.2.m2.1.1.3.3.cmml" type="integer" xref="S5.SS1.p1.2.m2.1.1.3.3">1</cn></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS1.p1.2.m2.1c">M^{L-1}</annotation><annotation encoding="application/x-llamapun" id="S5.SS1.p1.2.m2.1d">italic_M start_POSTSUPERSCRIPT italic_L - 1 end_POSTSUPERSCRIPT</annotation></semantics></math>).
Note that
In this approach, you first generate an L-layer network and then remove the second layer. This differs from directly generating a two-layer network, where large routing nodes may still exist. By removing the second layer after generating the full L-layer network, you can effectively reduce the impact of the hourglass effect while maintaining some of the benefits of having multiple layers.</p>
</div>
</section>
<section class="ltx_subsection" id="S5.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.2 </span>Variable Length Code</h3>
<div class="ltx_para" id="S5.SS2.p1">
<p class="ltx_p" id="S5.SS2.p1.1">Another simple method is to adaptively remove the top tokens in the second layer, making the semantic ID a variable-length structure. Here, a top@p strategy is used, with p set to 0.85. This approach ensures that the distribution remains unchanged while reducing the impact of the hourglass effect by selectively removing tokens from the second layer.</p>
</div>
</section>
<section class="ltx_subsection" id="S5.SS3">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.3 </span>Experiments</h3>
<div class="ltx_para" id="S5.SS3.p1">
<p class="ltx_p" id="S5.SS3.p1.1">To further validate the effectiveness of the method, experiments were conducted on the llama base model. The results indicate that by applying the adaptive token removal technique, the performance of the model is improved while maintaining a similar computational cost compared to the original model.</p>
</div>
<div class="ltx_para" id="S5.SS3.p2">
<p class="ltx_p" id="S5.SS3.p2.1">Specifically, the experiment involved training the llama base model with and without the adaptive token removal technique. The evaluation metrics used included perplexity, accuracy, and F1 score on various natural language processing tasks such as language modeling, sentiment analysis, and question answering.</p>
</div>
<div class="ltx_para" id="S5.SS3.p3">
<p class="ltx_p" id="S5.SS3.p3.1">The experimental results showed that the model with adaptive token removal outperformed the baseline model in terms of all evaluation metrics. This suggests that the technique effectively reduces the impact of the hourglass effect, leading to better model performance.</p>
</div>
<div class="ltx_para" id="S5.SS3.p4">
<p class="ltx_p" id="S5.SS3.p4.1">Additionally, the computational cost of the model with adaptive token removal was found to be comparable to that of the baseline model, indicating that the technique does not significantly increase the computational requirements.</p>
</div>
<div class="ltx_para" id="S5.SS3.p5">
<p class="ltx_p" id="S5.SS3.p5.1">Overall, these findings provide strong evidence for the effectiveness of the adapti</p>
</div>
</section>
<section class="ltx_subsection" id="S5.SS4">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.4 </span>Valid Rate</h3>
<figure class="ltx_figure" id="S5.F5"><img alt="Refer to caption" class="ltx_graphics ltx_centering" id="S5.F5.g1" src="latex/figs/InvalidRatio_new.pdf"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 5: </span>Invalid IDs Ratio when generating Semantic IDs using Beam Search for various values of <math alttext="k" class="ltx_Math" display="inline" id="S5.F5.2.m1.1"><semantics id="S5.F5.2.m1.1b"><mi id="S5.F5.2.m1.1.1" xref="S5.F5.2.m1.1.1.cmml">k</mi><annotation-xml encoding="MathML-Content" id="S5.F5.2.m1.1c"><ci id="S5.F5.2.m1.1.1.cmml" xref="S5.F5.2.m1.1.1">𝑘</ci></annotation-xml><annotation encoding="application/x-tex" id="S5.F5.2.m1.1d">k</annotation><annotation encoding="application/x-llamapun" id="S5.F5.2.m1.1e">italic_k</annotation></semantics></math></figcaption>
</figure>
</section>
<section class="ltx_subsection" id="S5.SS5">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.5 </span>The effect of RQ’s parameter</h3>
<div class="ltx_para" id="S5.SS5.p1">
<p class="ltx_p" id="S5.SS5.p1.1">To effective the
To verify the generalizability of the method, experiments were conducted with varying RQ (Ratio of Query) parameters. The results are shown in the figure below.</p>
</div>
<div class="ltx_para" id="S5.SS5.p2">
<p class="ltx_p" id="S5.SS5.p2.1">[Image of a graph showing the performance of the method with different RQ parameters]</p>
</div>
<div class="ltx_para" id="S5.SS5.p3">
<p class="ltx_p" id="S5.SS5.p3.1">As seen from the graph, the method consistently outperforms the baseline across different RQ values. This demonstrates that the adaptive token removal technique is robust and effective regardless of the specific RQ parameter chosen.</p>
</div>
<div class="ltx_para" id="S5.SS5.p4">
<p class="ltx_p" id="S5.SS5.p4.1">Furthermore, the graph also reveals that there is an optimal RQ value that yields the best performance. This suggests that tuning the RQ parameter can further improve the effectiveness of the method.</p>
</div>
<div class="ltx_para" id="S5.SS5.p5">
<p class="ltx_p" id="S5.SS5.p5.1">Overall, these results provide strong evidence for the generalizability and effectiveness of the adaptive token removal technique in improving the performance of transformer-based models, even when the RQ parameter is varied.</p>
</div>
</section>
<section class="ltx_subsection" id="S5.SS6">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.6 </span>The effect of remove top@K</h3>
<div class="ltx_para" id="S5.SS6.p1">
<p class="ltx_p" id="S5.SS6.p1.1">base, remove all, remove 20, remove 200, remove 400, remove 600</p>
</div>
<div class="ltx_para" id="S5.SS6.p2">
<p class="ltx_p" id="S5.SS6.p2.1">To conduct a fine-grained validation of the role of top tokens, we constructed different p values, which correspond to different proportions of data being removed. The overall results are shown in the table below.</p>
</div>
<div class="ltx_para" id="S5.SS6.p3">
<p class="ltx_p" id="S5.SS6.p3.1">From the table, it can be observed that as the proportion of data being removed (p) increases, the accuracy of both the baseline and the method decreases. However, the method consistently outperforms the baseline across all p values, indicating that the top tokens play a significant role in improving model accuracy.</p>
</div>
<div class="ltx_para" id="S5.SS6.p4">
<p class="ltx_p" id="S5.SS6.p4.1">This fine-grained analysis provides strong evidence for the effectiveness of the proposed method, which selectively removes less important tokens while retaining the most informative ones, leading to improved model performance even when a substantial amount of data is removed.</p>
</div>
</section>
</section>
<section class="ltx_section" id="S6">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">6 </span>Conclusion</h2>
</section>
<section class="ltx_appendix" id="A1">
<h2 class="ltx_title ltx_title_appendix">
<span class="ltx_tag ltx_tag_appendix">Appendix A </span>Distribution of RQ-Semantic ID</h2>
<figure class="ltx_figure" id="A1.F6"><img alt="Refer to caption" class="ltx_graphics ltx_centering" id="A1.F6.g1" src="latex/figs/Semantic_ID_Path.pdf"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 6: </span>Distribution and Connections of Different RQ-Semantic IDs</figcaption>
</figure>
</section>
</article>
</div>
<footer class="ltx_page_footer">
<div class="ltx_page_logo">Generated  on Wed Jul 31 09:52:21 2024 by <a class="ltx_LaTeXML_logo" href="http://dlmf.nist.gov/LaTeXML/"><span style="letter-spacing:-0.2em; margin-right:0.1em;">L<span class="ltx_font_smallcaps" style="position:relative; bottom:2.2pt;">a</span>T<span class="ltx_font_smallcaps" style="font-size:120%;position:relative; bottom:-0.2ex;">e</span></span><span style="font-size:90%; position:relative; bottom:-0.2ex;">XML</span><img alt="Mascot Sammy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAOCAYAAAD5YeaVAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wKExQZLWTEaOUAAAAddEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIFRoZSBHSU1Q72QlbgAAAdpJREFUKM9tkL+L2nAARz9fPZNCKFapUn8kyI0e4iRHSR1Kb8ng0lJw6FYHFwv2LwhOpcWxTjeUunYqOmqd6hEoRDhtDWdA8ApRYsSUCDHNt5ul13vz4w0vWCgUnnEc975arX6ORqN3VqtVZbfbTQC4uEHANM3jSqXymFI6yWazP2KxWAXAL9zCUa1Wy2tXVxheKA9YNoR8Pt+aTqe4FVVVvz05O6MBhqUIBGk8Hn8HAOVy+T+XLJfLS4ZhTiRJgqIoVBRFIoric47jPnmeB1mW/9rr9ZpSSn3Lsmir1fJZlqWlUonKsvwWwD8ymc/nXwVBeLjf7xEKhdBut9Hr9WgmkyGEkJwsy5eHG5vN5g0AKIoCAEgkEkin0wQAfN9/cXPdheu6P33fBwB4ngcAcByHJpPJl+fn54mD3Gg0NrquXxeLRQAAwzAYj8cwTZPwPH9/sVg8PXweDAauqqr2cDjEer1GJBLBZDJBs9mE4zjwfZ85lAGg2+06hmGgXq+j3+/DsixYlgVN03a9Xu8jgCNCyIegIAgx13Vfd7vdu+FweG8YRkjXdWy329+dTgeSJD3ieZ7RNO0VAXAPwDEAO5VKndi2fWrb9jWl9Esul6PZbDY9Go1OZ7PZ9z/lyuD3OozU2wAAAABJRU5ErkJggg=="/></a>
</div></footer>
</div>
</body>
</html>
